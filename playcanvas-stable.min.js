/**
 * @license
 * PlayCanvas Engine v2.11.6 revision bffa43e (RELEASE)
 * Copyright 2011-2025 PlayCanvas Ltd. All rights reserved.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
var e,t,n;function i(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}e=this,t=function(e){var t,n,r,s,a,o,l,u,c,h,f,d,p,m,_,v,g,y,S,x,b,T,E,w,A,C,P,I,L,D,M,R,O,k,N,F,B,U,z,V,G="undefined"!=typeof document?document.currentScript:null;function H(e,t,n){e.prototype[t]||Object.defineProperty(e.prototype,t,{value:n,configurable:true,enumerable:false,writable:true});}if(H(Array,"fill",function(e){if(this==null)throw TypeError("this is null or not defined");for(var t=Object(this),n=t.length>>>0,i=arguments[1],r=0|i,s=r<0?Math.max(n+r,0):Math.min(r,n),a=arguments[2],o=void 0===a?n:0|a,l=o<0?Math.max(n+o,0):Math.min(o,n);s<l;)t[s]=e,s++;return t}),H(Array,"find",function(e){if(this==null)throw TypeError('"this" is null or not defined');var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw TypeError("predicate must be a function");for(var i=arguments[1],r=0;r<n;){var s=t[r];if(e.call(i,s,r,t))return s;r++;}}),H(Array,"findIndex",function(e){if(this==null)throw TypeError('"this" is null or not defined');var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw TypeError("predicate must be a function");for(var i=arguments[1],r=0;r<n;){var s=t[r];if(e.call(i,s,r,t))return r;r++;}return -1}),Math.log2=Math.log2||function(e){return Math.log(e)*Math.LOG2E},Math.sign||(Math.sign=function(e){return (e>0)-(e<0)||+e}),void 0===Number.isFinite&&(Number.isFinite=function(e){return "number"==typeof e&&isFinite(e)}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){if(null==e)throw TypeError("Cannot convert undefined or null to object");for(var n=Object(e),i=1;i<arguments.length;i++){var r=arguments[i];if(null!=r)for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(n[s]=r[s]);}return n},writable:true,configurable:true}),Object.fromEntries=Object.fromEntries||function(e){if(!e||!e[Symbol.iterator])throw Error("Object.fromEntries() requires a single iterable argument");for(var t={},n=0;n<e.length;n++)t[e[n][0]]=e[n][1];return t},Object.entries=Object.entries||function(e){for(var t=Object.keys(e),n=t.length,i=Array(n);n--;)i[n]=[t[n],e[t[n]]];return i},Object.values=Object.values||function(e){return Object.keys(e).map(function(t){return e[t]})},"undefined"!=typeof navigator&&"undefined"!=typeof document){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var W=function(){var e=document.createEvent("CustomEvent");e.initCustomEvent("pointerlockchange",true,false,null),document.dispatchEvent(e);},j=function(){var e=document.createEvent("CustomEvent");e.initCustomEvent("pointerlockerror",true,false,null),document.dispatchEvent(e);};document.addEventListener("webkitpointerlockchange",W,false),document.addEventListener("webkitpointerlocklost",W,false),document.addEventListener("mozpointerlockchange",W,false),document.addEventListener("mozpointerlocklost",W,false),document.addEventListener("webkitpointerlockerror",j,false),document.addEventListener("mozpointerlockerror",j,false),Element.prototype.mozRequestPointerLock?Element.prototype.requestPointerLock=function(){this.mozRequestPointerLock();}:Element.prototype.requestPointerLock=Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock,!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this,navigator.pointer.lock(this,W,j);}),document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock,document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock());});}function X(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}H(String,"endsWith",function(e,t){return (void 0===t||t>this.length)&&(t=this.length),this.substring(t-e.length,t)===e}),H(String,"includes",function(e,t){return "number"!=typeof t&&(t=0),!(t+e.length>this.length)&&-1!==this.indexOf(e,t)}),H(String,"startsWith",function(e,t){var n=t>0?0|t:0;return this.substring(n,n+e.length)===e}),H(String,"trimEnd",function(){return this.replace(RegExp(/[\x09\x0A\x0B\x0C\x0D\x20\xA0\u1680\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028\u2029\uFEFF]+/.source+"$","g"),"")});for(var Y,q=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array],K=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return X(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return X(e,void 0)}}(e))){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(q);!(Y=K()).done;){var Z=Y.value;H(Z,"fill",Array.prototype.fill),H(Z,"join",Array.prototype.join);}var Q="GpuTimings",J="2.11.6",$="bffa43e";function ee(e,t){for(var n in t){var i=t[n];Array.isArray(i)?e[n]=ee([],i):i&&(void 0===i?"undefined":i&&"undefined"!=typeof Symbol&&i.constructor===Symbol?"symbol":typeof i)=="object"?e[n]=ee({},i):e[n]=i;}return e}var et={create:function(){return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return ("x"===e?t:3&t|8).toString(16)})}},en={delimiter:"/",join:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=t[0],r=0;r<t.length-1;r++){var s=t[r],a=t[r+1];if(a[0]===en.delimiter){i=a;continue}s&&a&&s[s.length-1]!==en.delimiter&&a[0]!==en.delimiter?i+=en.delimiter+a:i+=a;}return i},normalize:function(e){for(var t=e.startsWith(en.delimiter),n=e.endsWith(en.delimiter),i=e.split("/"),r="",s=[],a=0;a<i.length;a++)if(""!==i[a]&&"."!==i[a]){if(".."===i[a]&&s.length>0){s=s.slice(0,s.length-2);continue}a>0&&s.push(en.delimiter),s.push(i[a]);}return r=s.join(""),t||r[0]!==en.delimiter||(r=r.slice(1)),n&&r[r.length-1]!==en.delimiter&&(r+=en.delimiter),r},split:function(e){var t=e.lastIndexOf(en.delimiter);return -1!==t?[e.substring(0,t),e.substring(t+1)]:["",e]},getBasename:function(e){return en.split(e)[1]},getDirectory:function(e){return en.split(e)[0]},getExtension:function(e){var t=e.split("?")[0].split(".").pop();return t!==e?"."+t:""},isRelativePath:function(e){return "/"!==e.charAt(0)&&null===e.match(/:\/\//)},extractPath:function(e){var t="",n=e.split("/"),i=0;if(n.length>1)if(en.isRelativePath(e))if("."===n[0])for(i=0;i<n.length-1;++i)t+=0===i?n[i]:"/"+n[i];else if(".."===n[0])for(i=0;i<n.length-1;++i)t+=0===i?n[i]:"/"+n[i];else for(i=0,t=".";i<n.length-1;++i)t+="/"+n[i];else for(i=0;i<n.length-1;++i)t+=0===i?n[i]:"/"+n[i];return t}},ei="undefined"!=typeof navigator?navigator.userAgent:"",er="undefined"!=typeof window?"browser":"undefined"!=typeof global?"node":"worker",es=/android/i.test(ei)?"android":/ip(?:[ao]d|hone)/i.test(ei)?"ios":/windows/i.test(ei)?"windows":/mac os/i.test(ei)?"osx":/linux/i.test(ei)?"linux":/cros/i.test(ei)?"cros":null,ea="browser"!==er?null:/Chrome\/|Chromium\/|Edg.*\//.test(ei)?"chrome":/Safari\//.test(ei)?"safari":/Firefox\//.test(ei)?"firefox":"other",eo=/xbox/i.test(ei),el="browser"===er&&("ontouchstart"in window||"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0),eu="browser"===er&&(!!navigator.getGamepads||!!navigator.webkitGetGamepads),ec="undefined"!=typeof Worker,eh=function(){var e=false;try{var t=Object.defineProperty({},"passive",{get:function(){return e=!0,!1}});window.addEventListener("testpassive",null,t),window.removeEventListener("testpassive",null,t);}catch(e){}return e}(),ef={name:es,environment:er,global:null!=(u=null!=(l=null!=(o="undefined"!=typeof globalThis&&globalThis)?o:"browser"===er&&window)?l:"node"===er&&global)?u:"worker"===er&&self,browser:"browser"===er,worker:"worker"===er,desktop:["windows","osx","linux","cros"].includes(es),mobile:["android","ios"].includes(es),ios:"ios"===es,android:"android"===es,xbox:eo,gamepads:eu,touch:el,workers:ec,passiveEvents:eh,browserName:ea},ed="abcdefghijklmnopqrstuvwxyz",ep="ABCDEFGHIJKLMNOPQRSTUVWXYZ";function em(e,t){ void 0===t&&(t=0);var n=e.length;if(t<0||t>=n)return null;var i=e.charCodeAt(t);if(n>1&&i>=55296&&i<=56319){var r=e.charCodeAt(t+1);if(r>=56320&&r<=57343)return {code:(i-55296)*1024+r-56320+65536,long:true}}return {code:i,long:false}}function e_(e,t,n){if(!e)return  false;var i=em(e);if(i){var r=i.code;return r>=t&&r<=n}return  false}var ev={ASCII_LOWERCASE:ed,ASCII_UPPERCASE:ep,ASCII_LETTERS:ed+ep,format:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0;r<n.length;r++)e=e.replace("{"+r+"}",n[r]);return e},getCodePoint:function(e,t){var n=em(e,t);return n&&n.code},getCodePoints:function(e){if("string"!=typeof e)throw TypeError("Not a string");for(var t,n=0,i=[];t=em(e,n);)i.push(t.code),n+=t.long?2:1;return i},getSymbols:function(e){if("string"!=typeof e)throw TypeError("Not a string");for(var t,n=0,i=e.length,r=[],s=0;n<i;){if(s+=function(e,t){if(t===e.length-1)return 1;if(e_(e[t],55296,56319)){var n=e.substring(t,t+2),i=e.substring(t+2,t+4);return e_(i,127995,127999)||e_(n,127462,127487)&&e_(i,127462,127487)?4:e_(i,65024,65039)?3:2}return e_(e[t+1],65024,65039)?2:1}(e,n+s),e_(t=e[n+s],8400,8447)&&(t=e[n+s++]),e_(t,65024,65039)&&(t=e[n+s++]),t&&8205===t.charCodeAt(0)){t=e[n+s++];continue}var a=e.substring(n,n+s);r.push(a),n+=s,s=0;}return r},fromCodePoint:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.map(function(e){return e>65535?String.fromCharCode(((e-=65536)>>10)+55296,e%1024+56320):String.fromCharCode(e)}).join("")}},eg=function(){function e(e,t,n,i,r){ void 0===r&&(r=false),this._removed=false,this.handler=e,this.name=t,this.callback=n,this.scope=i,this._once=r;}var t,n=e.prototype;return n.off=function(){this._removed||this.handler.offByHandle(this);},n.on=function(e,t,n){return void 0===n&&(n=this),this.handler._addCallback(e,t,n,false)},n.once=function(e,t,n){return void 0===n&&(n=this),this.handler._addCallback(e,t,n,true)},n.toJSON=function(e){},t=[{key:"removed",get:function(){return this._removed},set:function(e){e&&(this._removed=true);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function ey(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function eS(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return ey(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ey(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var ex=function(){function e(){this._callbacks=new Map,this._callbackActive=new Map;}var t=e.prototype;return t.initEventHandler=function(){this._callbacks=new Map,this._callbackActive=new Map;},t._addCallback=function(e,t,n,i){if(this._callbacks.has(e)||this._callbacks.set(e,[]),this._callbackActive.has(e)){var r=this._callbackActive.get(e);r&&r===this._callbacks.get(e)&&this._callbackActive.set(e,r.slice());}var s=new eg(this,e,t,n,i);return this._callbacks.get(e).push(s),s},t.on=function(e,t,n){return void 0===n&&(n=this),this._addCallback(e,t,n,false)},t.once=function(e,t,n){return void 0===n&&(n=this),this._addCallback(e,t,n,true)},t.off=function(e,t,n){if(e)this._callbackActive.has(e)&&this._callbackActive.get(e)===this._callbacks.get(e)&&this._callbackActive.set(e,this._callbackActive.get(e).slice());else for(var i,r=eS(this._callbackActive);!(i=r()).done;){var s=i.value,a=s[0],o=s[1];this._callbacks.has(a)&&this._callbacks.get(a)===o&&this._callbackActive.set(a,o.slice());}if(e)if(t){var l=this._callbacks.get(e);if(!l)return this;for(var u=0;u<l.length;u++)l[u].callback===t&&(!n||l[u].scope===n)&&(l[u].removed=true,l.splice(u,1),u--);0===l.length&&this._callbacks.delete(e);}else {var c=this._callbacks.get(e);if(c){for(var h=0;h<c.length;h++)c[h].removed=true;this._callbacks.delete(e);}}else {for(var f,d=eS(this._callbacks.values());!(f=d()).done;)for(var p=f.value,m=0;m<p.length;m++)p[m].removed=true;this._callbacks.clear();}return this},t.offByHandle=function(e){var t=e.name;e.removed=true,this._callbackActive.has(t)&&this._callbackActive.get(t)===this._callbacks.get(t)&&this._callbackActive.set(t,this._callbackActive.get(t).slice());var n=this._callbacks.get(t);if(!n)return this;var i=n.indexOf(e);return -1!==i&&(n.splice(i,1),0===n.length&&this._callbacks.delete(t)),this},t.fire=function(e,t,n,i,r,s,a,o,l){if(!e)return this;var u,c=this._callbacks.get(e);if(!c)return this;this._callbackActive.has(e)?this._callbackActive.get(e)!==c&&(u=c.slice()):this._callbackActive.set(e,c);for(var h=0;(u||this._callbackActive.get(e))&&h<(u||this._callbackActive.get(e)).length;h++){var f=(u||this._callbackActive.get(e))[h];if(f.callback&&(f.callback.call(f.scope,t,n,i,r,s,a,o,l),f._once)){var d=this._callbacks.get(e),p=d?d.indexOf(f):-1;if(-1!==p){this._callbackActive.get(e)===d&&this._callbackActive.set(e,this._callbackActive.get(e).slice());var m=this._callbacks.get(e);if(!m)continue;m[p].removed=true,m.splice(p,1),0===m.length&&this._callbacks.delete(e);}}}return u||this._callbackActive.delete(e),this},t.hasEvent=function(e){var t;return !!(null==(t=this._callbacks.get(e))?void 0:t.length)},e}(),eb=function(){function e(){this._list=[],this._index={};}var t=e.prototype;return t.push=function(e,t){if(this._index[e])throw Error("Key already in index "+e);var n=this._list.push(t)-1;this._index[e]=n;},t.has=function(e){return void 0!==this._index[e]},t.get=function(e){var t=this._index[e];return void 0!==t?this._list[t]:null},t.remove=function(e){var t=this._index[e];if(void 0!==t){for(e in this._list.splice(t,1),delete this._index[e],this._index){var n=this._index[e];n>t&&(this._index[e]=n-1);}return  true}return  false},t.list=function(){return this._list},t.clear=function(){for(var e in this._list.length=0,this._index)delete this._index[e];},e}();function eT(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}var eE=function(){function e(){}return e.loadScript=function(e,t){var n=document.createElement("script");n.setAttribute("src",e),n.onload=function(){t(null);},n.onerror=function(){t("Failed to load script='"+e+"'");},document.body.appendChild(n);},e.loadWasm=function(t,n,i){var r=e.wasmSupported()&&n.glueUrl&&n.wasmUrl?n.glueUrl:n.fallbackUrl;r?e.loadScript(r,function(e){if(e)i(e,null);else {var r=window[t];window[t]=void 0,r({locateFile:function(){return n.wasmUrl},onAbort:function(){i("wasm module aborted.");}}).then(function(e){i(null,e);});}}):i("No supported wasm modules found.",null);},e.getModule=function(t){return e.modules.hasOwnProperty(t)||(e.modules[t]={config:null,initializing:false,instance:null,callbacks:[]}),e.modules[t]},e.initialize=function(t,n){if(!n.initializing){var i=n.config;(i.glueUrl||i.wasmUrl||i.fallbackUrl)&&(n.initializing=true,e.loadWasm(t,i,function(e,t){e?i.errorHandler&&i.errorHandler(e):(n.instance=t,n.callbacks.forEach(function(e){e(t);}));}));}},e}();eE.modules={},t=function(){try{var e;if(("undefined"==typeof WebAssembly?"undefined":(e=WebAssembly)&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)=="object"&&"function"==typeof WebAssembly.instantiate){var t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(eT(t,WebAssembly.Module))return eT(new WebAssembly.Instance(t),WebAssembly.Instance)}}catch(e){}return  false},r=n={},eE.wasmSupported=function(){return r===n&&(r=t()),r};var ew=function(){function e(){}return e.setConfig=function(e,t){var n=eE.getModule(e);n.config=t,n.callbacks.length>0&&eE.initialize(e,n);},e.getConfig=function(e){var t,n;return null==(n=eE.modules)||null==(t=n[e])?void 0:t.config},e.getInstance=function(e,t){var n=eE.getModule(e);n.instance?t(n.instance):(n.callbacks.push(t),n.config&&eE.initialize(e,n));},e}(),eA=function(){function e(e){this.offset=0,this.arraybuffer=e,this.dataView=new DataView(e);}var t,n=e.prototype;return n.reset=function(e){ void 0===e&&(e=0),this.offset=e;},n.skip=function(e){this.offset+=e;},n.align=function(e){this.offset=this.offset+e-1&~(e-1);},n._inc=function(e){return this.offset+=e,this.offset-e},n.readChar=function(){return String.fromCharCode(this.dataView.getUint8(this.offset++))},n.readChars=function(e){for(var t="",n=0;n<e;++n)t+=this.readChar();return t},n.readU8=function(){return this.dataView.getUint8(this.offset++)},n.readU16=function(){return this.dataView.getUint16(this._inc(2),true)},n.readU32=function(){return this.dataView.getUint32(this._inc(4),true)},n.readU64=function(){return this.readU32()+0x100000000*this.readU32()},n.readU32be=function(){return this.dataView.getUint32(this._inc(4),false)},n.readArray=function(e){for(var t=0;t<e.length;++t)e[t]=this.readU8();},n.readLine=function(){for(var e=this.dataView,t="";!(this.offset>=e.byteLength);){var n=String.fromCharCode(this.readU8());if("\n"===n)break;t+=n;}return t},t=[{key:"remainingBytes",get:function(){return this.dataView.byteLength-this.offset}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),eC=function(){function e(e){this.items=[],this.length=0,this.loopIndex=-1,this._sortBy=e.sortBy,this._sortHandler=this._doSort.bind(this);}var t=e.prototype;return t._binarySearch=function(e){for(var t,n,i=0,r=this.items.length-1,s=e[this._sortBy];i<=r;)t=Math.floor((i+r)/2),(n=this.items[t][this._sortBy])<=s?i=t+1:n>s&&(r=t-1);return i},t._doSort=function(e,t){var n=this._sortBy;return e[n]-t[n]},t.insert=function(e){var t=this._binarySearch(e);this.items.splice(t,0,e),this.length++,this.loopIndex>=t&&this.loopIndex++;},t.append=function(e){this.items.push(e),this.length++;},t.remove=function(e){var t=this.items.indexOf(e);!(t<0)&&(this.items.splice(t,1),this.length--,this.loopIndex>=t&&this.loopIndex--);},t.sort=function(){var e=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),null!==e&&(this.loopIndex=this.items.indexOf(e));},e}();function eP(e,t){return (eP=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var eI=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this)._index={},n._list=[],n._parent=t,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&eP(t,e);var n,r=t.prototype;return r.add=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=false,r=this._processArguments(t,true);if(!r.length)return i;for(var s=0;s<r.length;s++)this._index[r[s]]||(i=true,this._index[r[s]]=true,this._list.push(r[s]),this.fire("add",r[s],this._parent));return i&&this.fire("change",this._parent),i},r.remove=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=false;if(!this._list.length)return i;var r=this._processArguments(t,true);if(!r.length)return i;for(var s=0;s<r.length;s++)this._index[r[s]]&&(i=true,delete this._index[r[s]],this._list.splice(this._list.indexOf(r[s]),1),this.fire("remove",r[s],this._parent));return i&&this.fire("change",this._parent),i},r.clear=function(){if(this._list.length){var e=this._list.slice(0);this._list=[],this._index={};for(var t=0;t<e.length;t++)this.fire("remove",e[t],this._parent);this.fire("change",this._parent);}},r.has=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return !!this._list.length&&this._has(this._processArguments(t))},r._has=function(e){if(!this._list.length||!e.length)return  false;for(var t=0;t<e.length;t++)if(1===e[t].length){if(this._index[e[t][0]])return  true}else {for(var n=true,i=0;i<e[t].length;i++)if(!this._index[e[t][i]]){n=false;break}if(n)return  true}return  false},r.list=function(){return this._list.slice(0)},r._processArguments=function(e,t){var n,r,s=[],a=[];if(!e||!e.length)return s;for(var o=0;o<e.length;o++)if(n=e[o],null!=(r=Array)&&"undefined"!=typeof Symbol&&r[Symbol.hasInstance]?!!r[Symbol.hasInstance](n):i(n,r)){t||(a=[]);for(var l=0;l<e[o].length;l++)"string"==typeof e[o][l]&&(t?s.push(e[o][l]):a.push(e[o][l]));!t&&a.length&&s.push(a);}else "string"==typeof e[o]&&(t?s.push(e[o]):s.push([e[o]]));return s},n=[{key:"size",get:function(){return this._list.length}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);eI.EVENT_ADD="add",eI.EVENT_REMOVE="remove",eI.EVENT_CHANGE="change";var eL="undefined"!=typeof window&&window.performance&&window.performance.now?performance.now.bind(performance):Date.now;function eD(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}var eM=/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/,eR=function(){function e(e){var t=e.match(eM);this.scheme=t[2],this.authority=t[4],this.path=t[5],this.query=t[7],this.fragment=t[9];}var t=e.prototype;return t.toString=function(){var e="";return this.scheme&&(e+=""+this.scheme+":"),this.authority&&(e+="//"+this.authority),e+=this.path,this.query&&(e+="?"+this.query),this.fragment&&(e+="#"+this.fragment),e},t.getQuery=function(){var e={};if(this.query)for(var t,n=decodeURIComponent(this.query).split("&"),i=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return eD(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return eD(e,void 0)}}(e))){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(n);!(t=i()).done;){var r=t.value.split("=");e[r[0]]=r[1];}return e},t.setQuery=function(e){var t="";for(var n in e)e.hasOwnProperty(n)&&(""!==t&&(t+="&"),t+=encodeURIComponent(n)+"="+encodeURIComponent(e[n]));this.query=t;},e}(),eO=function(){function e(){}return e.set=function(e,t){},e.get=function(t){return e._traceChannels.has(t)},e}();eO._traceChannels=new Set,eO.stack=false;var ek={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(e,t,n){return e>=n?n:e<=t?t:e},intToBytes24:function(e){return [e>>16&255,e>>8&255,255&e]},intToBytes32:function(e){return [e>>24&255,e>>16&255,e>>8&255,255&e]},bytesToInt24:function(e,t,n){return e.length&&(n=e[2],t=e[1],e=e[0]),e<<16|t<<8|n},bytesToInt32:function(e,t,n,i){return e.length&&(i=e[3],n=e[2],t=e[1],e=e[0]),(e<<24|t<<16|n<<8|i)>>>0},lerp:function(e,t,n){return e+(t-e)*ek.clamp(n,0,1)},lerpAngle:function(e,t,n){return t-e>180&&(t-=360),t-e<-180&&(t+=360),ek.lerp(e,t,ek.clamp(n,0,1))},powerOfTwo:function(e){return 0!==e&&!(e&e-1)},nextPowerOfTwo:function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},nearestPowerOfTwo:function(e){return Math.pow(2,Math.round(Math.log2(e)))},random:function(e,t){return Math.random()*(t-e)+e},smoothstep:function(e,t,n){return n<=e?0:n>=t?1:(n=(n-e)/(t-e))*n*(3-2*n)},smootherstep:function(e,t,n){return n<=e?0:n>=t?1:(n=(n-e)/(t-e))*n*n*(n*(6*n-15)+10)},roundUp:function(e,t){return 0===t?e:Math.ceil(e/t)*t},between:function(e,t,n,i){var r=Math.min(t,n),s=Math.max(t,n);return i?e>=r&&e<=s:e>r&&e<s}},eN=function(){function e(e,t,n,i){ void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1);var r,s=e.length;3===s||4===s?(this.r=e[0],this.g=e[1],this.b=e[2],this.a=null!=(r=e[3])?r:1):(this.r=e,this.g=t,this.b=n,this.a=i);}var t=e.prototype;return t.clone=function(){return new this.constructor(this.r,this.g,this.b,this.a)},t.copy=function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this},t.equals=function(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a},t.set=function(e,t,n,i){return void 0===i&&(i=1),this.r=e,this.g=t,this.b=n,this.a=i,this},t.lerp=function(e,t,n){return this.r=e.r+n*(t.r-e.r),this.g=e.g+n*(t.g-e.g),this.b=e.b+n*(t.b-e.b),this.a=e.a+n*(t.a-e.a),this},t.linear=function(e){return void 0===e&&(e=this),this.r=Math.pow(e.r,2.2),this.g=Math.pow(e.g,2.2),this.b=Math.pow(e.b,2.2),this.a=e.a,this},t.gamma=function(e){return void 0===e&&(e=this),this.r=Math.pow(e.r,1/2.2),this.g=Math.pow(e.g,1/2.2),this.b=Math.pow(e.b,1/2.2),this.a=e.a,this},t.mulScalar=function(e){return this.r*=e,this.g*=e,this.b*=e,this},t.fromString=function(e){var t,n=parseInt(e.replace("#","0x"),16);return e.length>7?t=ek.intToBytes32(n):(t=ek.intToBytes24(n))[3]=255,this.set(t[0]/255,t[1]/255,t[2]/255,t[3]/255),this},t.fromArray=function(e,t){var n,i,r,s;return void 0===t&&(t=0),this.r=null!=(n=e[t])?n:this.r,this.g=null!=(i=e[t+1])?i:this.g,this.b=null!=(r=e[t+2])?r:this.b,this.a=null!=(s=e[t+3])?s:this.a,this},t.toString=function(e,t){var n=this.r,i=this.g,r=this.b,s=this.a;if(t||n>1||i>1||r>1)return n.toFixed(3)+", "+i.toFixed(3)+", "+r.toFixed(3)+", "+s.toFixed(3);var a="#"+(0x1000000+(Math.round(255*n)<<16)+(Math.round(255*i)<<8)+Math.round(255*r)).toString(16).slice(1);if(true===e){var o=Math.round(255*s).toString(16);this.a<16/255?a+="0"+o:a+=o;}return a},t.toArray=function(e,t,n){return void 0===e&&(e=[]),void 0===t&&(t=0),void 0===n&&(n=true),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,n&&(e[t+3]=this.a),e},e}();eN.BLACK=Object.freeze(new eN(0,0,0,1)),eN.BLUE=Object.freeze(new eN(0,0,1,1)),eN.CYAN=Object.freeze(new eN(0,1,1,1)),eN.GRAY=Object.freeze(new eN(.5,.5,.5,1)),eN.GREEN=Object.freeze(new eN(0,1,0,1)),eN.MAGENTA=Object.freeze(new eN(1,0,1,1)),eN.RED=Object.freeze(new eN(1,0,0,1)),eN.WHITE=Object.freeze(new eN(1,1,1,1)),eN.YELLOW=Object.freeze(new eN(1,1,0,1));var eF=function(){function e(e,t){ void 0===t&&(t=0),this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._curve=e,this._reset(t);}var t=e.prototype;return t.evaluate=function(e,t){ void 0===t&&(t=false),(t||e<this._left||e>=this._right)&&this._reset(e);var n,i=this._curve.type;if(5===i)n=this._p0;else {var r=0===this._recip?0:(e-this._left)*this._recip;n=0===i?ek.lerp(this._p0,this._p1,r):1===i?ek.lerp(this._p0,this._p1,r*r*(3-2*r)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,r);}return n},t._reset=function(e){var t=this._curve.keys,n=t.length;if(n)if(e<t[0][0])this._left=-1/0,this._right=t[0][0],this._recip=0,this._p0=this._p1=t[0][1],this._m0=this._m1=0;else if(e>=t[n-1][0])this._left=t[n-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=t[n-1][1],this._m0=this._m1=0;else {for(var i=0;e>=t[i+1][0];)i++;this._left=t[i][0],this._right=t[i+1][0];var r=1/(this._right-this._left);this._recip=isFinite(r)?r:0,this._p0=t[i][1],this._p1=t[i+1][1],4===this._curve.type&&this._calcTangents(t,i);}else this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0;},t._calcTangents=function(e,t){var n,i,r=e[t],s=e[t+1];if(n=0===t?[e[0][0]+(e[0][0]-e[1][0]),e[0][1]+(e[0][1]-e[1][1])]:e[t-1],i=t===e.length-2?[e[t+1][0]+(e[t+1][0]-e[t][0]),e[t+1][1]+(e[t+1][1]-e[t][1])]:e[t+2],4===this._curve.type){var a=2*(s[0]-r[0])/(s[0]-n[0]),o=2*(s[0]-r[0])/(i[0]-r[0]);this._m0=this._curve.tension*(isFinite(a)?a:0)*(s[1]-n[1]),this._m1=this._curve.tension*(isFinite(o)?o:0)*(i[1]-r[1]);}else {var l=(s[0]-r[0])/(r[0]-n[0]),u=(s[0]-r[0])/(i[0]-s[0]),c=r[1]+(n[1]-r[1])*(isFinite(l)?l:0),h=s[1]+(i[1]-s[1])*(isFinite(u)?u:0),f=this._curve.tension;this._m0=f*(s[1]-c),this._m1=f*(h-r[1]);}},t._evaluateHermite=function(e,t,n,i,r){var s=r*r,a=r+r,o=1-r,l=o*o;return (1+a)*l*e+r*l*n+s*(3-a)*t+s*(r-1)*i},e}(),eB=function(){function e(e){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new eF(this),e)for(var t=0;t<e.length-1;t+=2)this.keys.push([e[t],e[t+1]]);this.sort();}var t,n=e.prototype;return n.add=function(e,t){for(var n=this.keys,i=n.length,r=0;r<i&&!(n[r][0]>e);r++);var s=[e,t];return this.keys.splice(r,0,s),s},n.get=function(e){return this.keys[e]},n.sort=function(){this.keys.sort(function(e,t){return e[0]-t[0]});},n.value=function(e){return this._eval.evaluate(e,true)},n.closest=function(e){for(var t=this.keys,n=t.length,i=2,r=null,s=0;s<n;s++){var a=Math.abs(e-t[s][0]);if(i>=a)i=a,r=t[s];else break}return r},n.clone=function(){var e=new this.constructor;return e.keys=this.keys.map(function(e){return [].concat(e)}),e.type=this.type,e.tension=this.tension,e},n.quantize=function(e){var t=new Float32Array(e=Math.max(e,2)),n=1/(e-1);t[0]=this._eval.evaluate(0,true);for(var i=1;i<e;i++)t[i]=this._eval.evaluate(n*i);return t},n.quantizeClamped=function(e,t,n){for(var i=this.quantize(e),r=0;r<i.length;++r)i[r]=Math.min(n,Math.max(t,i[r]));return i},t=[{key:"length",get:function(){return this.keys.length}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),eU=function(){function e(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];if(this.curves=[],this._type=1,t.length>1)for(var i=0;i<t.length;i++)this.curves.push(new eB(t[i]));else if(0===t.length)this.curves.push(new eB);else {var r=t[0];if("number"==typeof r)for(var s=0;s<r;s++)this.curves.push(new eB);else for(var a=0;a<r.length;a++)this.curves.push(new eB(r[a]));}}var t,n=e.prototype;return n.get=function(e){return this.curves[e]},n.value=function(e,t){ void 0===t&&(t=[]);var n=this.curves.length;t.length=n;for(var i=0;i<n;i++)t[i]=this.curves[i].value(e);return t},n.clone=function(){var e=new this.constructor;e.curves=[];for(var t=0;t<this.curves.length;t++)e.curves.push(this.curves[t].clone());return e._type=this._type,e},n.quantize=function(e){e=Math.max(e,2);for(var t=this.curves.length,n=new Float32Array(e*t),i=1/(e-1),r=0;r<t;r++)for(var s=new eF(this.curves[r]),a=0;a<e;a++)n[a*t+r]=s.evaluate(i*a);return n},n.quantizeClamped=function(e,t,n){for(var i=this.quantize(e),r=0;r<i.length;++r)i[r]=Math.min(n,Math.max(t,i[r]));return i},t=[{key:"length",get:function(){return this.curves.length}},{key:"type",get:function(){return this._type},set:function(e){this._type=e;for(var t=0;t<this.curves.length;t++)this.curves[t].type=e;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),ez=new Float32Array(1),eV=new Int32Array(ez.buffer),eG=function(){function e(){}return e.float2Half=function(e){ez[0]=e;var t=eV[0],n=t>>16&32768,i=t>>12&2047,r=t>>23&255;return r<103?n:r>142?(n|=31744,n|=+(255!==r)&&8388607&t):r<113?(i|=2048,n|=(i>>114-r)+(i>>113-r&1)):(n|=r-112<<10|i>>1,n+=1&i)},e.float2RGBA8=function(e,t){ez[0]=e;var n=eV[0];t.r=(n>>24&255)/255,t.g=(n>>16&255)/255,t.b=(n>>8&255)/255,t.a=(255&n)/255;},e}(),eH=function(){function e(){}return e.concentric=function(e,t){var n=[];n.push(0,0);for(var i=2*Math.PI/e/t,r=1;r<=e;r++)for(var s=r/e,a=Math.max(1,Math.floor(2*Math.PI*s/i)),o=2*Math.PI/a,l=0;l<a;l++){var u=l*o,c=s*Math.cos(u),h=s*Math.sin(u);n.push(c,h);}return n},e}(),eW=function(){function e(e,t,n){ void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),3===e.length?(this.x=e[0],this.y=e[1],this.z=e[2]):(this.x=e,this.y=t,this.z=n);}var t=e.prototype;return t.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},t.add2=function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},t.addScalar=function(e){return this.x+=e,this.y+=e,this.z+=e,this},t.addScaled=function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this},t.clone=function(){return new this.constructor(this.x,this.y,this.z)},t.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},t.cross=function(e,t){var n=e.x,i=e.y,r=e.z,s=t.x,a=t.y,o=t.z;return this.x=i*o-a*r,this.y=r*s-o*n,this.z=n*a-s*i,this},t.distance=function(e){var t=this.x-e.x,n=this.y-e.y,i=this.z-e.z;return Math.sqrt(t*t+n*n+i*i)},t.div=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},t.div2=function(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this},t.divScalar=function(e){return this.x/=e,this.y/=e,this.z/=e,this},t.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},t.equals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},t.equalsApprox=function(e,t){return void 0===t&&(t=1e-6),Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t},t.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},t.lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z},t.lerp=function(e,t,n){return this.x=e.x+n*(t.x-e.x),this.y=e.y+n*(t.y-e.y),this.z=e.z+n*(t.z-e.z),this},t.mul=function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this},t.mul2=function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},t.mulScalar=function(e){return this.x*=e,this.y*=e,this.z*=e,this},t.normalize=function(e){ void 0===e&&(e=this);var t=e.x*e.x+e.y*e.y+e.z*e.z;if(t>0){var n=1/Math.sqrt(t);this.x=e.x*n,this.y=e.y*n,this.z=e.z*n;}return this},t.floor=function(e){return void 0===e&&(e=this),this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this},t.ceil=function(e){return void 0===e&&(e=this),this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this},t.round=function(e){return void 0===e&&(e=this),this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this},t.min=function(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),this},t.max=function(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),this},t.project=function(e){var t=(this.x*e.x+this.y*e.y+this.z*e.z)/(e.x*e.x+e.y*e.y+e.z*e.z);return this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this},t.set=function(e,t,n){return this.x=e,this.y=t,this.z=n,this},t.sub=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},t.sub2=function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},t.subScalar=function(e){return this.x-=e,this.y-=e,this.z-=e,this},t.fromArray=function(e,t){var n,i,r;return void 0===t&&(t=0),this.x=null!=(n=e[t])?n:this.x,this.y=null!=(i=e[t+1])?i:this.y,this.z=null!=(r=e[t+2])?r:this.z,this},t.toString=function(){return "["+this.x+", "+this.y+", "+this.z+"]"},t.toArray=function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e},e}();eW.ZERO=Object.freeze(new eW(0,0,0)),eW.HALF=Object.freeze(new eW(.5,.5,.5)),eW.ONE=Object.freeze(new eW(1,1,1)),eW.UP=Object.freeze(new eW(0,1,0)),eW.DOWN=Object.freeze(new eW(0,-1,0)),eW.RIGHT=Object.freeze(new eW(1,0,0)),eW.LEFT=Object.freeze(new eW(-1,0,0)),eW.FORWARD=Object.freeze(new eW(0,0,-1)),eW.BACK=Object.freeze(new eW(0,0,1));var ej=function(){function e(){this.data=new Float32Array(9),this.data[0]=this.data[4]=this.data[8]=1;}var t=e.prototype;return t.clone=function(){return new this.constructor().copy(this)},t.copy=function(e){var t=e.data,n=this.data;return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],this},t.set=function(e){var t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this},t.getX=function(e){return void 0===e&&(e=new eW),e.set(this.data[0],this.data[1],this.data[2])},t.getY=function(e){return void 0===e&&(e=new eW),e.set(this.data[3],this.data[4],this.data[5])},t.getZ=function(e){return void 0===e&&(e=new eW),e.set(this.data[6],this.data[7],this.data[8])},t.equals=function(e){var t=this.data,n=e.data;return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]&&t[3]===n[3]&&t[4]===n[4]&&t[5]===n[5]&&t[6]===n[6]&&t[7]===n[7]&&t[8]===n[8]},t.isIdentity=function(){var e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&1===e[4]&&0===e[5]&&0===e[6]&&0===e[7]&&1===e[8]},t.setIdentity=function(){var e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this},t.toString=function(){return "["+this.data.join(", ")+"]"},t.transpose=function(e){ void 0===e&&(e=this);var t,n=e.data,i=this.data;return n===i?(t=n[1],i[1]=n[3],i[3]=t,t=n[2],i[2]=n[6],i[6]=t,t=n[5],i[5]=n[7],i[7]=t):(i[0]=n[0],i[1]=n[3],i[2]=n[6],i[3]=n[1],i[4]=n[4],i[5]=n[7],i[6]=n[2],i[7]=n[5],i[8]=n[8]),this},t.setFromMat4=function(e){var t=e.data,n=this.data;return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[4],n[4]=t[5],n[5]=t[6],n[6]=t[8],n[7]=t[9],n[8]=t[10],this},t.setFromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,s=t+t,a=n+n,o=i+i,l=t*s,u=t*a,c=t*o,h=n*a,f=n*o,d=i*o,p=r*s,m=r*a,_=r*o,v=this.data;return v[0]=1-(h+d),v[1]=u+_,v[2]=c-m,v[3]=u-_,v[4]=1-(l+d),v[5]=f+p,v[6]=c+m,v[7]=f-p,v[8]=1-(l+h),this},t.invertMat4=function(e){var t=e.data,n=t[0],i=t[1],r=t[2],s=t[4],a=t[5],o=t[6],l=t[8],u=t[9],c=t[10],h=c*a-o*u,f=-c*s+o*l,d=u*s-a*l,p=n*h+i*f+r*d;if(0===p)this.setIdentity();else {var m=1/p,_=this.data;_[0]=h*m,_[1]=(-c*i+r*u)*m,_[2]=(o*i-r*a)*m,_[3]=f*m,_[4]=(c*n-r*l)*m,_[5]=(-o*n+r*s)*m,_[6]=d*m,_[7]=(-u*n+i*l)*m,_[8]=(a*n-i*s)*m;}return this},t.transformVector=function(e,t){ void 0===t&&(t=new eW);var n=this.data,i=e.x,r=e.y,s=e.z;return t.x=i*n[0]+r*n[3]+s*n[6],t.y=i*n[1]+r*n[4]+s*n[7],t.z=i*n[2]+r*n[5]+s*n[8],t},e}();ej.IDENTITY=Object.freeze(new ej),ej.ZERO=Object.freeze(new ej().set([0,0,0,0,0,0,0,0,0]));var eX=function(){function e(e,t){ void 0===e&&(e=0),void 0===t&&(t=0),2===e.length?(this.x=e[0],this.y=e[1]):(this.x=e,this.y=t);}var t=e.prototype;return t.add=function(e){return this.x+=e.x,this.y+=e.y,this},t.add2=function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},t.addScalar=function(e){return this.x+=e,this.y+=e,this},t.addScaled=function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this},t.clone=function(){return new this.constructor(this.x,this.y)},t.copy=function(e){return this.x=e.x,this.y=e.y,this},t.cross=function(e){return this.x*e.y-this.y*e.x},t.distance=function(e){var t=this.x-e.x,n=this.y-e.y;return Math.sqrt(t*t+n*n)},t.div=function(e){return this.x/=e.x,this.y/=e.y,this},t.div2=function(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this},t.divScalar=function(e){return this.x/=e,this.y/=e,this},t.dot=function(e){return this.x*e.x+this.y*e.y},t.equals=function(e){return this.x===e.x&&this.y===e.y},t.equalsApprox=function(e,t){return void 0===t&&(t=1e-6),Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t},t.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t.lengthSq=function(){return this.x*this.x+this.y*this.y},t.lerp=function(e,t,n){return this.x=e.x+n*(t.x-e.x),this.y=e.y+n*(t.y-e.y),this},t.mul=function(e){return this.x*=e.x,this.y*=e.y,this},t.mul2=function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this},t.mulScalar=function(e){return this.x*=e,this.y*=e,this},t.normalize=function(e){ void 0===e&&(e=this);var t=e.x*e.x+e.y*e.y;if(t>0){var n=1/Math.sqrt(t);this.x=e.x*n,this.y=e.y*n;}return this},t.rotate=function(e){var t=Math.atan2(this.x,this.y)+e*ek.DEG_TO_RAD,n=Math.sqrt(this.x*this.x+this.y*this.y);return this.x=Math.sin(t)*n,this.y=Math.cos(t)*n,this},t.angle=function(){return Math.atan2(this.x,this.y)*ek.RAD_TO_DEG},t.angleTo=function(e){return Math.atan2(this.x*e.y+this.y*e.x,this.x*e.x+this.y*e.y)*ek.RAD_TO_DEG},t.floor=function(e){return void 0===e&&(e=this),this.x=Math.floor(e.x),this.y=Math.floor(e.y),this},t.ceil=function(e){return void 0===e&&(e=this),this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this},t.round=function(e){return void 0===e&&(e=this),this.x=Math.round(e.x),this.y=Math.round(e.y),this},t.min=function(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),this},t.max=function(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),this},t.set=function(e,t){return this.x=e,this.y=t,this},t.sub=function(e){return this.x-=e.x,this.y-=e.y,this},t.sub2=function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},t.subScalar=function(e){return this.x-=e,this.y-=e,this},t.fromArray=function(e,t){var n,i;return void 0===t&&(t=0),this.x=null!=(n=e[t])?n:this.x,this.y=null!=(i=e[t+1])?i:this.y,this},t.toString=function(){return "["+this.x+", "+this.y+"]"},t.toArray=function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e},e.angleRad=function(e,t){return Math.atan2(e.x*t.y-e.y*t.x,e.x*t.x+e.y*t.y)},e}();eX.ZERO=Object.freeze(new eX(0,0)),eX.HALF=Object.freeze(new eX(.5,.5)),eX.ONE=Object.freeze(new eX(1,1)),eX.UP=Object.freeze(new eX(0,1)),eX.DOWN=Object.freeze(new eX(0,-1)),eX.RIGHT=Object.freeze(new eX(1,0)),eX.LEFT=Object.freeze(new eX(-1,0));var eY=function(){function e(e,t,n,i){ void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=n,this.w=i);}var t=e.prototype;return t.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},t.add2=function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},t.addScalar=function(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this},t.addScaled=function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this},t.clone=function(){return new this.constructor(this.x,this.y,this.z,this.w)},t.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},t.div=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this},t.div2=function(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this.w=e.w/t.w,this},t.divScalar=function(e){return this.x/=e,this.y/=e,this.z/=e,this.w/=e,this},t.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},t.equals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},t.equalsApprox=function(e,t){return void 0===t&&(t=1e-6),Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t},t.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},t.lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},t.lerp=function(e,t,n){return this.x=e.x+n*(t.x-e.x),this.y=e.y+n*(t.y-e.y),this.z=e.z+n*(t.z-e.z),this.w=e.w+n*(t.w-e.w),this},t.mul=function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},t.mul2=function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this.w=e.w*t.w,this},t.mulScalar=function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},t.normalize=function(e){ void 0===e&&(e=this);var t=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;if(t>0){var n=1/Math.sqrt(t);this.x=e.x*n,this.y=e.y*n,this.z=e.z*n,this.w=e.w*n;}return this},t.floor=function(e){return void 0===e&&(e=this),this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this.w=Math.floor(e.w),this},t.ceil=function(e){return void 0===e&&(e=this),this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this.w=Math.ceil(e.w),this},t.round=function(e){return void 0===e&&(e=this),this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this.w=Math.round(e.w),this},t.min=function(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this},t.max=function(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this},t.set=function(e,t,n,i){return this.x=e,this.y=t,this.z=n,this.w=i,this},t.sub=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},t.sub2=function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},t.subScalar=function(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this},t.fromArray=function(e,t){var n,i,r,s;return void 0===t&&(t=0),this.x=null!=(n=e[t])?n:this.x,this.y=null!=(i=e[t+1])?i:this.y,this.z=null!=(r=e[t+2])?r:this.z,this.w=null!=(s=e[t+3])?s:this.w,this},t.toString=function(){return "["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"},t.toArray=function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e},e}();eY.ZERO=Object.freeze(new eY(0,0,0,0)),eY.HALF=Object.freeze(new eY(.5,.5,.5,.5)),eY.ONE=Object.freeze(new eY(1,1,1,1));var eq=new eX,eK=new eW,eZ=new eW,eQ=new eW,eJ=new eW,e$=function(){function e(){this.data=new Float32Array(16),this.data[0]=this.data[5]=this.data[10]=this.data[15]=1;}var t,n=e.prototype;return n.add2=function(e,t){var n=e.data,i=t.data,r=this.data;return r[0]=n[0]+i[0],r[1]=n[1]+i[1],r[2]=n[2]+i[2],r[3]=n[3]+i[3],r[4]=n[4]+i[4],r[5]=n[5]+i[5],r[6]=n[6]+i[6],r[7]=n[7]+i[7],r[8]=n[8]+i[8],r[9]=n[9]+i[9],r[10]=n[10]+i[10],r[11]=n[11]+i[11],r[12]=n[12]+i[12],r[13]=n[13]+i[13],r[14]=n[14]+i[14],r[15]=n[15]+i[15],this},n.add=function(e){return this.add2(this,e)},n.clone=function(){return new this.constructor().copy(this)},n.copy=function(e){var t=e.data,n=this.data;return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],this},n.equals=function(e){var t=this.data,n=e.data;return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]&&t[3]===n[3]&&t[4]===n[4]&&t[5]===n[5]&&t[6]===n[6]&&t[7]===n[7]&&t[8]===n[8]&&t[9]===n[9]&&t[10]===n[10]&&t[11]===n[11]&&t[12]===n[12]&&t[13]===n[13]&&t[14]===n[14]&&t[15]===n[15]},n.isIdentity=function(){var e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]},n.mul2=function(e,t){var n,i,r,s,a=e.data,o=t.data,l=this.data,u=a[0],c=a[1],h=a[2],f=a[3],d=a[4],p=a[5],m=a[6],_=a[7],v=a[8],g=a[9],y=a[10],S=a[11],x=a[12],b=a[13],T=a[14],E=a[15];return n=o[0],i=o[1],r=o[2],s=o[3],l[0]=u*n+d*i+v*r+x*s,l[1]=c*n+p*i+g*r+b*s,l[2]=h*n+m*i+y*r+T*s,l[3]=f*n+_*i+S*r+E*s,n=o[4],i=o[5],r=o[6],s=o[7],l[4]=u*n+d*i+v*r+x*s,l[5]=c*n+p*i+g*r+b*s,l[6]=h*n+m*i+y*r+T*s,l[7]=f*n+_*i+S*r+E*s,n=o[8],i=o[9],r=o[10],s=o[11],l[8]=u*n+d*i+v*r+x*s,l[9]=c*n+p*i+g*r+b*s,l[10]=h*n+m*i+y*r+T*s,l[11]=f*n+_*i+S*r+E*s,n=o[12],i=o[13],r=o[14],s=o[15],l[12]=u*n+d*i+v*r+x*s,l[13]=c*n+p*i+g*r+b*s,l[14]=h*n+m*i+y*r+T*s,l[15]=f*n+_*i+S*r+E*s,this},n.mulAffine2=function(e,t){var n,i,r,s=e.data,a=t.data,o=this.data,l=s[0],u=s[1],c=s[2],h=s[4],f=s[5],d=s[6],p=s[8],m=s[9],_=s[10],v=s[12],g=s[13],y=s[14];return n=a[0],i=a[1],r=a[2],o[0]=l*n+h*i+p*r,o[1]=u*n+f*i+m*r,o[2]=c*n+d*i+_*r,o[3]=0,n=a[4],i=a[5],r=a[6],o[4]=l*n+h*i+p*r,o[5]=u*n+f*i+m*r,o[6]=c*n+d*i+_*r,o[7]=0,n=a[8],i=a[9],r=a[10],o[8]=l*n+h*i+p*r,o[9]=u*n+f*i+m*r,o[10]=c*n+d*i+_*r,o[11]=0,n=a[12],i=a[13],r=a[14],o[12]=l*n+h*i+p*r+v,o[13]=u*n+f*i+m*r+g,o[14]=c*n+d*i+_*r+y,o[15]=1,this},n.mul=function(e){return this.mul2(this,e)},n.transformPoint=function(e,t){ void 0===t&&(t=new eW);var n=this.data,i=e.x,r=e.y,s=e.z;return t.x=i*n[0]+r*n[4]+s*n[8]+n[12],t.y=i*n[1]+r*n[5]+s*n[9]+n[13],t.z=i*n[2]+r*n[6]+s*n[10]+n[14],t},n.transformVector=function(e,t){ void 0===t&&(t=new eW);var n=this.data,i=e.x,r=e.y,s=e.z;return t.x=i*n[0]+r*n[4]+s*n[8],t.y=i*n[1]+r*n[5]+s*n[9],t.z=i*n[2]+r*n[6]+s*n[10],t},n.transformVec4=function(e,t){ void 0===t&&(t=new eY);var n=this.data,i=e.x,r=e.y,s=e.z,a=e.w;return t.x=i*n[0]+r*n[4]+s*n[8]+a*n[12],t.y=i*n[1]+r*n[5]+s*n[9]+a*n[13],t.z=i*n[2]+r*n[6]+s*n[10]+a*n[14],t.w=i*n[3]+r*n[7]+s*n[11]+a*n[15],t},n.setLookAt=function(e,t,n){eQ.sub2(e,t).normalize(),eZ.copy(n).normalize(),eK.cross(eZ,eQ).normalize(),eZ.cross(eQ,eK);var i=this.data;return i[0]=eK.x,i[1]=eK.y,i[2]=eK.z,i[3]=0,i[4]=eZ.x,i[5]=eZ.y,i[6]=eZ.z,i[7]=0,i[8]=eQ.x,i[9]=eQ.y,i[10]=eQ.z,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,this},n.setFrustum=function(e,t,n,i,r,s){var a=2*r,o=t-e,l=i-n,u=s-r,c=this.data;return c[0]=a/o,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=a/l,c[6]=0,c[7]=0,c[8]=(t+e)/o,c[9]=(i+n)/l,c[10]=(-s-r)/u,c[11]=-1,c[12]=0,c[13]=0,c[14]=-a*s/u,c[15]=0,this},n.setPerspective=function(t,n,i,r,s){return e._getPerspectiveHalfSize(eq,t,n,i,s),this.setFrustum(-eq.x,eq.x,-eq.y,eq.y,i,r)},n.setOrtho=function(e,t,n,i,r,s){var a=this.data;return a[0]=2/(t-e),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(i-n),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/(s-r),a[11]=0,a[12]=-(t+e)/(t-e),a[13]=-(i+n)/(i-n),a[14]=-(s+r)/(s-r),a[15]=1,this},n.setFromAxisAngle=function(e,t){t*=ek.DEG_TO_RAD;var n=e.x,i=e.y,r=e.z,s=Math.cos(t),a=Math.sin(t),o=1-s,l=o*n,u=o*i,c=this.data;return c[0]=l*n+s,c[1]=l*i+a*r,c[2]=l*r-a*i,c[3]=0,c[4]=l*i-a*r,c[5]=u*i+s,c[6]=u*r+a*n,c[7]=0,c[8]=l*r+a*i,c[9]=u*r-n*a,c[10]=o*r*r+s,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this},n.setTranslate=function(e,t,n){var i=this.data;return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=e,i[13]=t,i[14]=n,i[15]=1,this},n.setScale=function(e,t,n){var i=this.data;return i[0]=e,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=t,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=n,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this},n.setViewport=function(e,t,n,i){var r=this.data;return r[0]=.5*n,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=.5*i,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=.5,r[11]=0,r[12]=e+.5*n,r[13]=t+.5*i,r[14]=.5,r[15]=1,this},n.setReflection=function(e,t){var n=e.x,i=e.y,r=e.z,s=this.data;return s[0]=1-2*n*n,s[1]=-2*n*i,s[2]=-2*n*r,s[3]=0,s[4]=-2*n*i,s[5]=1-2*i*i,s[6]=-2*i*r,s[7]=0,s[8]=-2*n*r,s[9]=-2*i*r,s[10]=1-2*r*r,s[11]=0,s[12]=-2*n*t,s[13]=-2*i*t,s[14]=-2*r*t,s[15]=1,this},n.invert=function(e){ void 0===e&&(e=this);var t=e.data,n=t[0],i=t[1],r=t[2],s=t[3],a=t[4],o=t[5],l=t[6],u=t[7],c=t[8],h=t[9],f=t[10],d=t[11],p=t[12],m=t[13],_=t[14],v=t[15],g=n*o-i*a,y=n*l-r*a,S=n*u-s*a,x=i*l-r*o,b=i*u-s*o,T=r*u-s*l,E=c*m-h*p,w=c*_-f*p,A=c*v-d*p,C=h*_-f*m,P=h*v-d*m,I=f*v-d*_,L=g*I-y*P+S*C+x*A-b*w+T*E;if(0===L)this.setIdentity();else {var D=1/L,M=this.data;M[0]=(o*I-l*P+u*C)*D,M[1]=(-i*I+r*P-s*C)*D,M[2]=(m*T-_*b+v*x)*D,M[3]=(-h*T+f*b-d*x)*D,M[4]=(-a*I+l*A-u*w)*D,M[5]=(n*I-r*A+s*w)*D,M[6]=(-p*T+_*S-v*y)*D,M[7]=(c*T-f*S+d*y)*D,M[8]=(a*P-o*A+u*E)*D,M[9]=(-n*P+i*A-s*E)*D,M[10]=(p*b-m*S+v*g)*D,M[11]=(-c*b+h*S-d*g)*D,M[12]=(-a*C+o*w-l*E)*D,M[13]=(n*C-i*w+r*E)*D,M[14]=(-p*x+m*y-_*g)*D,M[15]=(c*x-h*y+f*g)*D;}return this},n.set=function(e){var t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this},n.setIdentity=function(){var e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},n.setTRS=function(e,t,n){var i=t.x,r=t.y,s=t.z,a=t.w,o=n.x,l=n.y,u=n.z,c=i+i,h=r+r,f=s+s,d=i*c,p=i*h,m=i*f,_=r*h,v=r*f,g=s*f,y=a*c,S=a*h,x=a*f,b=this.data;return b[0]=(1-(_+g))*o,b[1]=(p+x)*o,b[2]=(m-S)*o,b[3]=0,b[4]=(p-x)*l,b[5]=(1-(d+g))*l,b[6]=(v+y)*l,b[7]=0,b[8]=(m+S)*u,b[9]=(v-y)*u,b[10]=(1-(d+_))*u,b[11]=0,b[12]=e.x,b[13]=e.y,b[14]=e.z,b[15]=1,this},n.transpose=function(e){ void 0===e&&(e=this);var t,n=e.data,i=this.data;return n===i?(t=n[1],i[1]=n[4],i[4]=t,t=n[2],i[2]=n[8],i[8]=t,t=n[3],i[3]=n[12],i[12]=t,t=n[6],i[6]=n[9],i[9]=t,t=n[7],i[7]=n[13],i[13]=t,t=n[11],i[11]=n[14],i[14]=t):(i[0]=n[0],i[1]=n[4],i[2]=n[8],i[3]=n[12],i[4]=n[1],i[5]=n[5],i[6]=n[9],i[7]=n[13],i[8]=n[2],i[9]=n[6],i[10]=n[10],i[11]=n[14],i[12]=n[3],i[13]=n[7],i[14]=n[11],i[15]=n[15]),this},n.getTranslation=function(e){return void 0===e&&(e=new eW),e.set(this.data[12],this.data[13],this.data[14])},n.getX=function(e){return void 0===e&&(e=new eW),e.set(this.data[0],this.data[1],this.data[2])},n.getY=function(e){return void 0===e&&(e=new eW),e.set(this.data[4],this.data[5],this.data[6])},n.getZ=function(e){return void 0===e&&(e=new eW),e.set(this.data[8],this.data[9],this.data[10])},n.getScale=function(e){return void 0===e&&(e=new eW),this.getX(eK),this.getY(eZ),this.getZ(eQ),e.set(eK.length(),eZ.length(),eQ.length()),e},n.setFromEulerAngles=function(e,t,n){e*=ek.DEG_TO_RAD,t*=ek.DEG_TO_RAD,n*=ek.DEG_TO_RAD;var i=Math.sin(-e),r=Math.cos(-e),s=Math.sin(-t),a=Math.cos(-t),o=Math.sin(-n),l=Math.cos(-n),u=this.data;return u[0]=a*l,u[1]=-a*o,u[2]=s,u[3]=0,u[4]=r*o+l*i*s,u[5]=r*l-i*s*o,u[6]=-a*i,u[7]=0,u[8]=i*o-r*l*s,u[9]=l*i+r*s*o,u[10]=r*a,u[11]=0,u[12]=0,u[13]=0,u[14]=0,u[15]=1,this},n.getEulerAngles=function(e){ void 0===e&&(e=new eW),this.getScale(eJ);var t,n,i=eJ.x,r=eJ.y,s=eJ.z;if(0===i||0===r||0===s)return e.set(0,0,0);var a=this.data,o=Math.asin(-a[2]/i),l=.5*Math.PI;return o<l?o>-l?(t=Math.atan2(a[6]/r,a[10]/s),n=Math.atan2(a[1]/i,a[0]/i)):(n=0,t=-Math.atan2(a[4]/r,a[5]/r)):(n=0,t=Math.atan2(a[4]/r,a[5]/r)),e.set(t,o,n).mulScalar(ek.RAD_TO_DEG)},n.toString=function(){return "["+this.data.join(", ")+"]"},e._getPerspectiveHalfSize=function(e,t,n,i,r){r?(e.x=i*Math.tan(t*Math.PI/360),e.y=e.x/n):(e.y=i*Math.tan(t*Math.PI/360),e.x=e.y*n);},t=[{key:"scaleSign",get:function(){return this.getX(eK),this.getY(eZ),this.getZ(eQ),eK.cross(eK,eZ),0>eK.dot(eQ)?-1:1}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();e$.IDENTITY=Object.freeze(new e$),e$.ZERO=Object.freeze(new e$().set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));var e0=function(){function e(e,t,n,i){ void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=n,this.w=i);}var t=e.prototype;return t.clone=function(){return new this.constructor(this.x,this.y,this.z,this.w)},t.conjugate=function(e){return void 0===e&&(e=this),this.x=-1*e.x,this.y=-1*e.y,this.z=-1*e.z,this.w=e.w,this},t.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},t.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},t.equals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},t.equalsApprox=function(e,t){return void 0===t&&(t=1e-6),Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t},t.getAxisAngle=function(e){var t=2*Math.acos(this.w),n=Math.sin(t/2);return 0!==n?(e.x=this.x/n,e.y=this.y/n,e.z=this.z/n,(e.x<0||e.y<0||e.z<0)&&(e.x*=-1,e.y*=-1,e.z*=-1,t*=-1)):(e.x=1,e.y=0,e.z=0),t*ek.RAD_TO_DEG},t.getEulerAngles=function(e){ void 0===e&&(e=new eW);var t,n,i,r=this.x,s=this.y,a=this.z,o=this.w,l=2*(o*s-r*a);return l<=-0.99999?(t=2*Math.atan2(r,o),n=-Math.PI/2,i=0):l>=.99999?(t=2*Math.atan2(r,o),n=Math.PI/2,i=0):(t=Math.atan2(2*(o*r+s*a),1-2*(r*r+s*s)),n=Math.asin(l),i=Math.atan2(2*(o*a+r*s),1-2*(s*s+a*a))),e.set(t,n,i).mulScalar(ek.RAD_TO_DEG)},t.invert=function(e){return void 0===e&&(e=this),this.conjugate(e).normalize()},t.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},t.lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},t.lerp=function(e,t,n){var i=(1-n)*(0>e.dot(t)?-1:1);return this.x=e.x*i+t.x*n,this.y=e.y*i+t.y*n,this.z=e.z*i+t.z*n,this.w=e.w*i+t.w*n,this.normalize()},t.mul=function(e){var t=this.x,n=this.y,i=this.z,r=this.w,s=e.x,a=e.y,o=e.z,l=e.w;return this.x=r*s+t*l+n*o-i*a,this.y=r*a+n*l+i*s-t*o,this.z=r*o+i*l+t*a-n*s,this.w=r*l-t*s-n*a-i*o,this},t.mulScalar=function(e,t){return void 0===t&&(t=this),this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this.w=t.w*e,this},t.mul2=function(e,t){var n=e.x,i=e.y,r=e.z,s=e.w,a=t.x,o=t.y,l=t.z,u=t.w;return this.x=s*a+n*u+i*l-r*o,this.y=s*o+i*u+r*a-n*l,this.z=s*l+r*u+n*o-i*a,this.w=s*u-n*a-i*o-r*l,this},t.normalize=function(e){ void 0===e&&(e=this);var t=e.length();return 0===t?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this.w=e.w*t),this},t.set=function(e,t,n,i){return this.x=e,this.y=t,this.z=n,this.w=i,this},t.setFromAxisAngle=function(e,t){var n=Math.sin(t*=.5*ek.DEG_TO_RAD),i=Math.cos(t);return this.x=n*e.x,this.y=n*e.y,this.z=n*e.z,this.w=i,this},t.setFromEulerAngles=function(e,t,n){if(r=e,null!=eW&&"undefined"!=typeof Symbol&&eW[Symbol.hasInstance]?!!eW[Symbol.hasInstance](r):i(r,eW)){var r,s=e;e=s.x,t=s.y,n=s.z;}var a=.5*ek.DEG_TO_RAD,o=Math.sin(e*=a),l=Math.cos(e),u=Math.sin(t*=a),c=Math.cos(t),h=Math.sin(n*=a),f=Math.cos(n);return this.x=o*c*f-l*u*h,this.y=l*u*f+o*c*h,this.z=l*c*h-o*u*f,this.w=l*c*f+o*u*h,this},t.setFromMat4=function(e){var t,n=e.data,i=n[0],r=n[1],s=n[2],a=n[4],o=n[5],l=n[6],u=n[8],c=n[9],h=n[10];return 0==(t=i*i+r*r+s*s)||(i*=t=1/Math.sqrt(t),r*=t,s*=t,0==(t=a*a+o*o+l*l)||(a*=t=1/Math.sqrt(t),o*=t,l*=t,0==(t=u*u+c*c+h*h)))?this.set(0,0,0,1):(u*=t=1/Math.sqrt(t),c*=t,(h*=t)<0?i>o?this.set(1+i-o-h,r+a,u+s,l-c):this.set(r+a,1-i+o-h,l+c,u-s):i<-o?this.set(u+s,l+c,1-i-o+h,r-a):this.set(l-c,u-s,r-a,1+i+o+h),this.mulScalar(1/this.length()))},t.setFromDirections=function(e,t){var n=1+e.dot(t);return n<Number.EPSILON?(Math.abs(e.x)>Math.abs(e.y)?(this.x=-e.z,this.y=0,this.z=e.x):(this.x=0,this.y=-e.z,this.z=e.y),this.w=0):(this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this.w=n),this.normalize()},t.slerp=function(e,t,n){var i=e.x,r=e.y,s=e.z,a=e.w,o=t.x,l=t.y,u=t.z,c=t.w,h=a*c+i*o+r*l+s*u;if(h<0&&(c=-c,o=-o,l=-l,u=-u,h=-h),Math.abs(h)>=1)return this.w=a,this.x=i,this.y=r,this.z=s,this;var f=Math.acos(h),d=Math.sqrt(1-h*h);if(.001>Math.abs(d))return this.w=.5*a+.5*c,this.x=.5*i+.5*o,this.y=.5*r+.5*l,this.z=.5*s+.5*u,this;var p=Math.sin((1-n)*f)/d,m=Math.sin(n*f)/d;return this.w=a*p+c*m,this.x=i*p+o*m,this.y=r*p+l*m,this.z=s*p+u*m,this},t.transformVector=function(e,t){ void 0===t&&(t=new eW);var n=e.x,i=e.y,r=e.z,s=this.x,a=this.y,o=this.z,l=this.w,u=l*n+a*r-o*i,c=l*i+o*n-s*r,h=l*r+s*i-a*n,f=-s*n-a*i-o*r;return t.x=u*l+-(f*s)+-(c*o)- -(h*a),t.y=c*l+-(f*a)+-(h*s)- -(u*o),t.z=h*l+-(f*o)+-(u*a)- -(c*s),t},t.fromArray=function(e,t){var n,i,r,s;return void 0===t&&(t=0),this.x=null!=(n=e[t])?n:this.x,this.y=null!=(i=e[t+1])?i:this.y,this.z=null!=(r=e[t+2])?r:this.z,this.w=null!=(s=e[t+3])?s:this.w,this},t.toString=function(){return "["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"},t.toArray=function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e},e}();e0.IDENTITY=Object.freeze(new e0(0,0,0,1)),e0.ZERO=Object.freeze(new e0(0,0,0,0));var e1=new eW,e2=new eW,e3=new eW,e4=new eW,e5=new eW,e8=function(){function e(e,t){this.center=new eW,this.halfExtents=new eW(.5,.5,.5),this._min=new eW,this._max=new eW,e&&this.center.copy(e),t&&this.halfExtents.copy(t);}var t=e.prototype;return t.add=function(e){var t=this.center,n=t.x,i=t.y,r=t.z,s=this.halfExtents,a=s.x,o=s.y,l=s.z,u=n-a,c=n+a,h=i-o,f=i+o,d=r-l,p=r+l,m=e.center,_=m.x,v=m.y,g=m.z,y=e.halfExtents,S=y.x,x=y.y,b=y.z,T=_-S,E=_+S,w=v-x,A=v+x,C=g-b,P=g+b;T<u&&(u=T),E>c&&(c=E),w<h&&(h=w),A>f&&(f=A),C<d&&(d=C),P>p&&(p=P),t.x=(u+c)*.5,t.y=(h+f)*.5,t.z=(d+p)*.5,s.x=(c-u)*.5,s.y=(f-h)*.5,s.z=(p-d)*.5;},t.copy=function(e){this.center.copy(e.center),this.halfExtents.copy(e.halfExtents);},t.clone=function(){return new e(this.center,this.halfExtents)},t.intersects=function(e){var t=this.getMax(),n=this.getMin(),i=e.getMax(),r=e.getMin();return n.x<=i.x&&t.x>=r.x&&n.y<=i.y&&t.y>=r.y&&n.z<=i.z&&t.z>=r.z},t._intersectsRay=function(e,t){var n=e1.copy(this.getMin()).sub(e.origin),i=e2.copy(this.getMax()).sub(e.origin),r=e.direction;0===r.x?(n.x=n.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(n.x/=r.x,i.x/=r.x),0===r.y?(n.y=n.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(n.y/=r.y,i.y/=r.y),0===r.z?(n.z=n.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(n.z/=r.z,i.z/=r.z);var s=e3.set(Math.min(n.x,i.x),Math.min(n.y,i.y),Math.min(n.z,i.z)),a=e4.set(Math.max(n.x,i.x),Math.max(n.y,i.y),Math.max(n.z,i.z)),o=Math.min(Math.min(a.x,a.y),a.z),l=Math.max(Math.max(s.x,s.y),s.z),u=o>=l&&l>=0;return u&&t.copy(e.direction).mulScalar(l).add(e.origin),u},t._fastIntersectsRay=function(e){var t=e.direction;return e1.sub2(e.origin,this.center),e4.set(Math.abs(e1.x),Math.abs(e1.y),Math.abs(e1.z)),e3.mul2(e1,t),(!(e4.x>this.halfExtents.x)||!(e3.x>=0))&&(!(e4.y>this.halfExtents.y)||!(e3.y>=0))&&(!(e4.z>this.halfExtents.z)||!(e3.z>=0))&&(e5.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)),e2.cross(t,e1),e2.set(Math.abs(e2.x),Math.abs(e2.y),Math.abs(e2.z)),!(e2.x>this.halfExtents.y*e5.z+this.halfExtents.z*e5.y)&&!(e2.y>this.halfExtents.x*e5.z+this.halfExtents.z*e5.x)&&!(e2.z>this.halfExtents.x*e5.y+this.halfExtents.y*e5.x))},t.intersectsRay=function(e,t){return t?this._intersectsRay(e,t):this._fastIntersectsRay(e)},t.setMinMax=function(e,t){this.center.add2(t,e).mulScalar(.5),this.halfExtents.sub2(t,e).mulScalar(.5);},t.getMin=function(){return this._min.copy(this.center).sub(this.halfExtents)},t.getMax=function(){return this._max.copy(this.center).add(this.halfExtents)},t.containsPoint=function(e){var t=this.getMin(),n=this.getMax();return !(e.x<t.x)&&!(e.x>n.x)&&!(e.y<t.y)&&!(e.y>n.y)&&!(e.z<t.z)&&!(e.z>n.z)},t.setFromTransformedAabb=function(e,t,n){ void 0===n&&(n=false);var i=e.center,r=e.halfExtents,s=t.data,a=s[0],o=s[4],l=s[8],u=s[1],c=s[5],h=s[9],f=s[2],d=s[6],p=s[10];if(n){var m=a*a+o*o+l*l;if(m>0){var _=1/Math.sqrt(m);a*=_,o*=_,l*=_;}if((m=u*u+c*c+h*h)>0){var v=1/Math.sqrt(m);u*=v,c*=v,h*=v;}if((m=f*f+d*d+p*p)>0){var g=1/Math.sqrt(m);f*=g,d*=g,p*=g;}}this.center.set(s[12]+a*i.x+o*i.y+l*i.z,s[13]+u*i.x+c*i.y+h*i.z,s[14]+f*i.x+d*i.y+p*i.z),this.halfExtents.set(Math.abs(a)*r.x+Math.abs(o)*r.y+Math.abs(l)*r.z,Math.abs(u)*r.x+Math.abs(c)*r.y+Math.abs(h)*r.z,Math.abs(f)*r.x+Math.abs(d)*r.y+Math.abs(p)*r.z);},t.compute=function(t,n){e.computeMinMax(t,e1,e2,n),this.setMinMax(e1,e2);},t.intersectsBoundingSphere=function(e){return this._distanceToBoundingSphereSq(e)<=e.radius*e.radius},t._distanceToBoundingSphereSq=function(e){for(var t=this.getMin(),n=this.getMax(),i=0,r=["x","y","z"],s=0;s<3;++s){var a=0,o=e.center[r[s]],l=t[r[s]],u=n[r[s]],c=0;o<l&&(a+=(c=l-o)*c),o>u&&(a+=(c=o-u)*c),i+=a;}return i},t._expand=function(e,t){e1.add2(this.getMin(),e),e2.add2(this.getMax(),t),this.setMinMax(e1,e2);},e.computeMinMax=function(e,t,n,i){if(void 0===i&&(i=e.length/3),i>0){for(var r=e[0],s=e[1],a=e[2],o=r,l=s,u=a,c=3*i,h=3;h<c;h+=3){var f=e[h],d=e[h+1],p=e[h+2];f<r&&(r=f),d<s&&(s=d),p<a&&(a=p),f>o&&(o=f),d>l&&(l=d),p>u&&(u=p);}t.set(r,s,a),n.set(o,l,u);}},e}(),e6=new eW,e9=new eW,e7=function(){function e(e,t){ void 0===e&&(e=new eW),void 0===t&&(t=.5),this.center=e,this.radius=t;}var t=e.prototype;return t.containsPoint=function(e){var t=e6.sub2(e,this.center).lengthSq(),n=this.radius;return t<n*n},t.intersectsRay=function(e,t){var n=e6.copy(e.origin).sub(this.center),i=n.dot(e9.copy(e.direction).normalize()),r=n.dot(n)-this.radius*this.radius;if(r>0&&i>0)return  false;var s=i*i-r;if(s<0)return  false;var a=Math.abs(-i-Math.sqrt(s));return t&&t.copy(e.direction).mulScalar(a).add(e.origin),true},t.intersectsBoundingSphere=function(e){e6.sub2(e.center,this.center);var t=e.radius+this.radius;return e6.lengthSq()<=t*t},e}(),te=function(){function e(e,t){ void 0===e&&(e=eW.UP),void 0===t&&(t=0),this.normal=new eW,this.normal.copy(e),this.distance=t;}var t=e.prototype;return t.clone=function(){return new this.constructor().copy(this)},t.copy=function(e){return this.normal.copy(e.normal),this.distance=e.distance,this},t.intersectsLine=function(e,t,n){var i=this.distance,r=this.normal.dot(e)+i,s=r/(r-(this.normal.dot(t)+i)),a=s>=0&&s<=1;return a&&n&&n.lerp(e,t,s),a},t.intersectsRay=function(e,t){var n=this.normal.dot(e.direction);if(0===n)return  false;var i=-(this.normal.dot(e.origin)+this.distance)/n;return i>=0&&t&&t.copy(e.direction).mulScalar(i).add(e.origin),i>=0},t.normalize=function(){var e=1/this.normal.length();return this.normal.mulScalar(e),this.distance*=e,this},t.set=function(e,t,n,i){return this.normal.set(e,t,n),this.distance=i,this},t.setFromPointNormal=function(e,t){return this.normal.copy(t),this.distance=-this.normal.dot(e),this},e}(),tt=function(){function e(){this.planes=[];for(var e=0;e<6;e++)this.planes[e]=new te;}var t=e.prototype;return t.clone=function(){return new this.constructor().copy(this)},t.copy=function(e){for(var t=0;t<6;t++)this.planes[t].copy(e.planes[t]);return this},t.setFromMat4=function(e){var t=e.data,n=t[0],i=t[1],r=t[2],s=t[3],a=t[4],o=t[5],l=t[6],u=t[7],c=t[8],h=t[9],f=t[10],d=t[11],p=t[12],m=t[13],_=t[14],v=t[15],g=this.planes;g[0].set(s-n,u-a,d-c,v-p).normalize(),g[1].set(s+n,u+a,d+c,v+p).normalize(),g[2].set(s+i,u+o,d+h,v+m).normalize(),g[3].set(s-i,u-o,d-h,v-m).normalize(),g[4].set(s-r,u-l,d-f,v-_).normalize(),g[5].set(s+r,u+l,d+f,v+_).normalize();},t.containsPoint=function(e){for(var t=0;t<6;t++){var n=this.planes[t],i=n.normal,r=n.distance;if(i.dot(e)+r<=0)return  false}return  true},t.containsSphere=function(e){for(var t=e.center,n=e.radius,i=0,r=0;r<6;r++){var s=this.planes[r],a=s.normal,o=s.distance,l=a.dot(t)+o;if(l<=-n)return 0;l>n&&i++;}return 6===i?2:1},e}(),tn=function(){function e(e,t){this.origin=new eW,this.direction=eW.FORWARD.clone(),e&&this.origin.copy(e),t&&this.direction.copy(t);}var t=e.prototype;return t.set=function(e,t){return this.origin.copy(e),this.direction.copy(t),this},t.copy=function(e){return this.set(e.origin,e.direction)},t.clone=function(){return new this.constructor(this.origin,this.direction)},e}(),ti=new tn,tr=new eW,ts=new e7,ta=new e$,to=function(){function e(e,t){ void 0===e&&(e=new e$),this.halfExtents=new eW(.5,.5,.5),t&&this.halfExtents.copy(t),this._modelTransform=e.clone().invert(),this._worldTransform=e.clone(),this._aabb=new e8(new eW,this.halfExtents);}var t,n=e.prototype;return n.intersectsRay=function(e,t){if(this._modelTransform.transformPoint(e.origin,ti.origin),this._modelTransform.transformVector(e.direction,ti.direction),t){var n=this._aabb._intersectsRay(ti,t);return ta.copy(this._modelTransform).invert().transformPoint(t,t),n}return this._aabb._fastIntersectsRay(ti)},n.containsPoint=function(e){return this._modelTransform.transformPoint(e,tr),this._aabb.containsPoint(tr)},n.intersectsBoundingSphere=function(e){return this._modelTransform.transformPoint(e.center,ts.center),ts.radius=e.radius,!!this._aabb.intersectsBoundingSphere(ts)},t=[{key:"worldTransform",get:function(){return this._worldTransform},set:function(e){this._worldTransform.copy(e),this._modelTransform.copy(e).invert();}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),tl=new eW,tu=new eW,tc=new eW,th=new eW,tf=new eW,td=function(){function e(e,t,n){ void 0===e&&(e=eW.ZERO),void 0===t&&(t=eW.ZERO),void 0===n&&(n=eW.ZERO),this.v0=new eW,this.v1=new eW,this.v2=new eW,this.set(e,t,n);}var t=e.prototype;return t.set=function(e,t,n){return this.v0.copy(e),this.v1.copy(t),this.v2.copy(n),this},t.intersectsRay=function(e,t){tl.sub2(this.v1,this.v0),tu.sub2(this.v2,this.v0),tc.cross(e.direction,tu);var n=tl.dot(tc);if(n>-1e-6&&n<1e-6)return  false;var r=1/n;th.sub2(e.origin,this.v0);var s=r*th.dot(tc);if(s<0||s>1)return  false;tf.cross(th,tl);var a=r*e.direction.dot(tf);if(a<0||s+a>1)return  false;var o=r*tu.dot(tf);return !!(o>1e-6)&&((null!=eW&&"undefined"!=typeof Symbol&&eW[Symbol.hasInstance]?!!eW[Symbol.hasInstance](t):i(t,eW))&&t.copy(e.direction).mulScalar(o).add(e.origin),true)},t.toString=function(){return "["+this.v0.toString()+", "+this.v1.toString()+", "+this.v2.toString()+"]"},e}();function tp(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}var tm=new Map([[0,{name:"A8",size:1,ldr:true}],[52,{name:"R8",size:1,ldr:true}],[1,{name:"L8",size:1,ldr:true}],[2,{name:"LA8",size:2,ldr:true}],[53,{name:"RG8",size:2,ldr:true}],[3,{name:"RGB565",size:2,ldr:true}],[4,{name:"RGBA5551",size:2,ldr:true}],[5,{name:"RGBA4",size:2,ldr:true}],[6,{name:"RGB8",size:4,ldr:true}],[7,{name:"RGBA8",size:4,ldr:true,srgbFormat:20}],[50,{name:"R16F",size:2}],[51,{name:"RG16F",size:4}],[11,{name:"RGB16F",size:8}],[12,{name:"RGBA16F",size:8}],[13,{name:"RGB32F",size:16}],[14,{name:"RGBA32F",size:16}],[15,{name:"R32F",size:4}],[16,{name:"DEPTH",size:4}],[69,{name:"DEPTH16",size:2}],[17,{name:"DEPTHSTENCIL",size:4}],[18,{name:"111110F",size:4}],[19,{name:"SRGB8",size:4,ldr:true,srgb:true}],[20,{name:"SRGBA8",size:4,ldr:true,srgb:true}],[31,{name:"BGRA8",size:4,ldr:true}],[64,{name:"SBGRA8",size:4,ldr:true,srgb:true}],[8,{name:"DXT1",blockSize:8,ldr:true,srgbFormat:54}],[9,{name:"DXT3",blockSize:16,ldr:true,srgbFormat:55}],[10,{name:"DXT5",blockSize:16,ldr:true,srgbFormat:56}],[21,{name:"ETC1",blockSize:8,ldr:true}],[22,{name:"ETC2_RGB",blockSize:8,ldr:true,srgbFormat:61}],[23,{name:"ETC2_RGBA",blockSize:16,ldr:true,srgbFormat:62}],[24,{name:"PVRTC_2BPP_RGB_1",ldr:true,blockSize:8}],[25,{name:"PVRTC_2BPP_RGBA_1",ldr:true,blockSize:8}],[26,{name:"PVRTC_4BPP_RGB_1",ldr:true,blockSize:8}],[27,{name:"PVRTC_4BPP_RGBA_1",ldr:true,blockSize:8}],[28,{name:"ASTC_4x4",blockSize:16,ldr:true,srgbFormat:63}],[29,{name:"ATC_RGB",blockSize:8,ldr:true}],[30,{name:"ATC_RGBA",blockSize:16,ldr:true}],[65,{name:"BC6H_RGBF",blockSize:16}],[66,{name:"BC6H_RGBUF",blockSize:16}],[67,{name:"BC7_RGBA",blockSize:16,ldr:true,srgbFormat:68}],[54,{name:"DXT1_SRGB",blockSize:8,ldr:true,srgb:true}],[55,{name:"DXT3_SRGBA",blockSize:16,ldr:true,srgb:true}],[56,{name:"DXT5_SRGBA",blockSize:16,ldr:true,srgb:true}],[61,{name:"ETC2_SRGB",blockSize:8,ldr:true,srgb:true}],[62,{name:"ETC2_SRGBA",blockSize:16,ldr:true,srgb:true}],[63,{name:"ASTC_4x4_SRGB",blockSize:16,ldr:true,srgb:true}],[68,{name:"BC7_SRGBA",blockSize:16,ldr:true,srgb:true}],[32,{name:"R8I",size:1,isInt:true}],[33,{name:"R8U",size:1,isInt:true}],[34,{name:"R16I",size:2,isInt:true}],[35,{name:"R16U",size:2,isInt:true}],[36,{name:"R32I",size:4,isInt:true}],[37,{name:"R32U",size:4,isInt:true}],[38,{name:"RG8I",size:2,isInt:true}],[39,{name:"RG8U",size:2,isInt:true}],[40,{name:"RG16I",size:4,isInt:true}],[41,{name:"RG16U",size:4,isInt:true}],[42,{name:"RG32I",size:8,isInt:true}],[43,{name:"RG32U",size:8,isInt:true}],[44,{name:"RGBA8I",size:4,isInt:true}],[45,{name:"RGBA8U",size:4,isInt:true}],[46,{name:"RGBA16I",size:8,isInt:true}],[47,{name:"RGBA16U",size:8,isInt:true}],[48,{name:"RGBA32I",size:16,isInt:true}],[49,{name:"RGBA32U",size:16,isInt:true}]]),t_=function(e){var t;return (null==(t=tm.get(e))?void 0:t.blockSize)!==void 0},tv=function(e){var t;return (null==(t=tm.get(e))?void 0:t.srgb)===true},tg=function(e){var t;return (null==(t=tm.get(e))?void 0:t.isInt)===true},ty=function(e){var t;return (null==(t=tm.get(e))?void 0:t.srgbFormat)||e},tS=function(e){for(var t,n=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return tp(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return tp(e,void 0)}}(e))){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(tm);!(t=n()).done;){var i=t.value,r=i[0];if(i[1].srgbFormat===e)return r}return e},tx=function(e){var t=tm.get(e);return !!((null==t?void 0:t.ldr)&&!(null==t?void 0:t.srgb))},tb=function(e){switch(e){case 15:case 13:case 14:return Float32Array;case 36:case 42:case 48:return Int32Array;case 37:case 43:case 49:return Uint32Array;case 34:case 40:case 46:return Int16Array;case 53:case 35:case 41:case 47:case 3:case 4:case 5:case 50:case 51:case 11:case 12:return Uint16Array;case 32:case 38:case 44:return Int8Array;default:return Uint8Array}},tT="POSITION",tE="NORMAL",tw="TANGENT",tA="BLENDWEIGHT",tC="BLENDINDICES",tP="COLOR",tI="TEXCOORD",tL="TEXCOORD0",tD="TEXCOORD1",tM="TEXCOORD2",tR="TEXCOORD3",tO="TEXCOORD4",tk="TEXCOORD5",tN="TEXCOORD6",tF="TEXCOORD7",tB="ATTR0",tU="ATTR1",tz="ATTR2",tV="ATTR3",tG="ATTR4",tH="ATTR5",tW="ATTR6",tj="ATTR7",tX="ATTR8",tY="ATTR9",tq="ATTR10",tK="ATTR11",tZ="ATTR12",tQ="ATTR13",tJ="ATTR14",t$="ATTR15",t0="default",t1="rgbm",t2="rgbe",t3="rgbp",t4="swizzleGGGR",t5="2d-array",t8="cube",t6="cube-array",t9="none",t7="cube",ne="equirect",nt="octahedral",nn="glsl",ni="wgsl",nr=["bool","int","float","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","mat2","mat3","mat4","sampler2D","samplerCube","","sampler2DShadow","samplerCubeShadow","sampler3D","","","","","sampler2DArray","uint","uvec2","uvec3","uvec4","","","","","","","","","","","","","isampler2D","usampler2D","isamplerCube","usamplerCube","isampler3D","usampler3D","isampler2DArray","usampler2DArray"],ns=[["bool"],["i32"],["f32"],["vec2f","vec2<f32>"],["vec3f","vec3<f32>"],["vec4f","vec4<f32>"],["vec2i","vec2<i32>"],["vec3i","vec3<i32>"],["vec4i","vec4<i32>"],["vec2<bool>"],["vec3<bool>"],["vec4<bool>"],["mat2x2f","mat2x2<f32>"],["mat3x3f","mat3x3<f32>"],["mat4x4f","mat4x4<f32>"],["texture_2d<f32>"],["texture_cube<f32>"],["array<f32>"],["texture_depth_2d"],["texture_depth_cube"],["texture_3d<f32>"],["array<vec2<f32>>"],["array<vec3<f32>>"],["array<vec4<f32>>"],["array<mat4x4<f32>>"],["texture_2d_array<f32>"],["u32"],["vec2u","vec2<u32>"],["vec3u","vec3<u32>"],["vec4u","vec4<u32>"],["array<i32>"],["array<u32>"],["array<bool>"],["array<vec2i>","array<vec2<i32>>"],["array<vec2u>","array<vec2<u32>>"],["array<vec2b>","array<vec2<bool>>"],["array<vec3i>","array<vec3<i32>>"],["array<vec3u>","array<vec3<u32>>"],["array<vec3b>","array<vec3<bool>>"],["array<vec4i>","array<vec4<i32>>"],["array<vec4u>","array<vec4<u32>>"],["array<vec4b>","array<vec4<bool>>"],["texture_2d<i32>"],["texture_2d<u32>"],["texture_cube<i32>"],["texture_cube<u32>"],["texture_3d<i32>"],["texture_3d<u32>"],["texture_2d_array<i32>"],["texture_2d_array<u32>"]],na=new Map;ns.forEach(function(e,t){e.forEach(function(e){return na.set(e,t)});});var no=new Uint8Array([4,4,6,6,6,6,4,4,4,4,4,4,6,6,6,4,4,6,4,4,4,6,6,6,6,4,5,5,5,5,4,5,4,4,5,4,4,5,4,4,5,4,4,5,4,5,4,5,4,5]),nl="webgl2",nu="webgpu",nc="null",nh="ldr_srgb",nf=["view","mesh","mesh_ub"],nd="default",np="_unused_float_uniform",nm=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Uint16Array],n_=[1,1,2,2,4,4,4,2],nv=[Uint8Array,Uint16Array,Uint32Array],ng=[1,2,4],ny=new Map([["float","f32"],["vec2","vec2f"],["vec3","vec3f"],["vec4","vec4f"],["int","i32"],["ivec2","vec2i"],["ivec3","vec3i"],["ivec4","vec4i"],["uint","u32"],["uvec2","vec2u"],["uvec3","vec3u"],["uvec4","vec4u"]]),nS={};function nx(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:true,configurable:true}}),t&&nT(e,t);}function nb(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function nT(e,t){return (nT=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}nS[tT]=0,nS[tE]=1,nS[tA]=2,nS[tC]=3,nS[tP]=4,nS[tL]=5,nS[tD]=6,nS[tM]=7,nS[tR]=8,nS[tO]=9,nS[tk]=10,nS[tN]=11,nS[tF]=12,nS[tw]=13,nS[tB]=0,nS[tU]=1,nS[tz]=2,nS[tV]=3,nS[tG]=4,nS[tH]=5,nS[tW]=6,nS[tj]=7,nS[tX]=8,nS[tY]=9,nS[tq]=10,nS[tK]=11,nS[tZ]=12,nS[tQ]=13,nS[tJ]=14,nS[t$]=15;var nE=0,nw=function(e,t){this.slot=-1,this.scopeId=null,this.name=e,this.visibility=t;},nA=function(e){function t(){return e.apply(this,arguments)||this}return nx(t,e),t}(nw),nC=function(e){function t(t,n,i){var r;return void 0===i&&(i=false),(r=e.call(this,t,n)||this).format="",r.readOnly=i,r}return nx(t,e),t}(nw),nP=function(e){function t(t,n,i,r,s,a){var o;return void 0===i&&(i="2d"),void 0===r&&(r=0),void 0===s&&(s=true),void 0===a&&(a=null),(o=e.call(this,t,n)||this).textureDimension=i,o.sampleType=r,o.hasSampler=s,o.samplerName=null!=a?a:""+t+"_sampler",o}return nx(t,e),t}(nw),nI=function(e){function t(t,n,i,r,s){var a;return void 0===n&&(n=7),void 0===i&&(i="2d"),void 0===r&&(r=true),void 0===s&&(s=false),(a=e.call(this,t,4)||this).format=n,a.textureDimension=i,a.write=r,a.read=s,a}return nx(t,e),t}(nw),nL=function(){function e(e,t){var n=this;this.uniformBufferFormats=[],this.textureFormats=[],this.storageTextureFormats=[],this.storageBufferFormats=[],this.id=nE++;var i=0;t.forEach(function(e){e.slot=i++,nb(e,nP)&&e.hasSampler&&i++,nb(e,nA)?n.uniformBufferFormats.push(e):nb(e,nP)?n.textureFormats.push(e):nb(e,nI)?n.storageTextureFormats.push(e):nb(e,nC)&&n.storageBufferFormats.push(e);}),this.device=e;var r=e.scope;this.bufferFormatsMap=new Map,this.uniformBufferFormats.forEach(function(e,t){return n.bufferFormatsMap.set(e.name,t)}),this.textureFormatsMap=new Map,this.textureFormats.forEach(function(e,t){n.textureFormatsMap.set(e.name,t),e.scopeId=r.resolve(e.name);}),this.storageTextureFormatsMap=new Map,this.storageTextureFormats.forEach(function(e,t){n.storageTextureFormatsMap.set(e.name,t),e.scopeId=r.resolve(e.name);}),this.storageBufferFormatsMap=new Map,this.storageBufferFormats.forEach(function(e,t){n.storageBufferFormatsMap.set(e.name,t),e.scopeId=r.resolve(e.name);}),this.impl=e.createBindGroupFormatImpl(this);}var t=e.prototype;return t.destroy=function(){this.impl.destroy();},t.getTexture=function(e){var t=this.textureFormatsMap.get(e);return void 0!==t?this.textureFormats[t]:null},t.getStorageTexture=function(e){var t=this.storageTextureFormatsMap.get(e);return void 0!==t?this.storageTextureFormats[t]:null},t.loseContext=function(){},e}(),nD=function(){function e(){this._cache=new Map;}var t=e.prototype;return t.get=function(e,t){var n=this;return this._cache.has(e)||(this._cache.set(e,t()),e.on("destroy",function(){n.remove(e);}),e.on("devicelost",function(){var t,i;null==(i=n._cache.get(e))||null==(t=i.loseContext)||t.call(i,e);})),this._cache.get(e)},t.remove=function(e){var t,n;null==(n=this._cache.get(e))||null==(t=n.destroy)||t.call(n,e),this._cache.delete(e);},e}(),nM=function(){function e(){}return e.calcLevelDimension=function(e,t){return Math.max(e>>t,1)},e.calcMipLevelsCount=function(e,t,n){return void 0===n&&(n=1),1+Math.floor(Math.log2(Math.max(e,t,n)))},e.calcLevelGpuSize=function(e,t,n,i){var r,s,a,o=tm.get(i),l=null!=(s=null==(r=tm.get(i))?void 0:r.size)?s:0;if(l>0)return e*t*n*l;var u=null!=(a=o.blockSize)?a:0,c=Math.floor((e+3)/4),h=Math.floor((t+3)/4),f=Math.floor((n+3)/4);return (24===i||25===i)&&(c=Math.max(Math.floor(c/2),1)),c*h*f*u},e.calcGpuSize=function(t,n,i,r,s,a){for(var o=0;o+=e.calcLevelGpuSize(t,n,i,r),s&&(1!==t||1!==n||1!==i);)t=Math.max(t>>1,1),n=Math.max(n>>1,1),i=Math.max(i>>1,1);return o*(a?6:1)},e}(),nR=0,nO=function(){function e(e,t){ void 0===t&&(t={}),this._gpuSize=0,this.id=nR++,this._invalid=false,this._lockedLevel=-1,this._lockedMode=0,this.renderVersionDirty=0,this._storage=false,this._numLevels=0,this.device=e,this.name=null!=(n=t.name)?n:"",this._width=Math.floor(null!=(i=t.width)?i:4),this._height=Math.floor(null!=(r=t.height)?r:4),this._format=null!=(s=t.format)?s:7,this._compressed=t_(this._format),this._integerFormat=tg(this._format),this._integerFormat&&(t.minFilter=0,t.magFilter=0),this._volume=null!=(a=t.volume)&&a,this._depth=Math.floor(null!=(o=t.depth)?o:1),this._arrayLength=Math.floor(null!=(l=t.arrayLength)?l:0),this._storage=null!=(u=t.storage)&&u,this._cubemap=null!=(c=t.cubemap)&&c,this._flipY=null!=(h=t.flipY)&&h,this._premultiplyAlpha=null!=(f=t.premultiplyAlpha)&&f,this._mipmaps=null==(d=t.mipmaps)||d,this._numLevelsRequested=t.numLevels,void 0!==t.numLevels&&(this._numLevels=t.numLevels),this._updateNumLevel(),this._minFilter=null!=(p=t.minFilter)?p:5,this._magFilter=null!=(m=t.magFilter)?m:1,this._anisotropy=null!=(_=t.anisotropy)?_:1,this._addressU=null!=(v=t.addressU)?v:0,this._addressV=null!=(g=t.addressV)?g:0,this._addressW=null!=(y=t.addressW)?y:0,this._compareOnRead=null!=(S=t.compareOnRead)&&S,this._compareFunc=null!=(x=t.compareFunc)?x:1,this._type=null!=(b=t.type)?b:t0,this.projection=t9,this._cubemap?this.projection=t7:t.projection&&t.projection!==t7&&(this.projection=t.projection),this._levels=t.levels;var n,i,r,s,a,o,l,u,c,h,f,d,p,m,_,v,g,y,S,x,b,T=!!t.levels;this._levels||this._clearLevels(),this.recreateImpl(T),e.textures.push(this);}var t,n=e.prototype;return n.destroy=function(){var e=this.device;if(e){var t=e.textures.indexOf(this);-1!==t&&e.textures.splice(t,1),e.scope.removeValue(this),this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this._gpuSize),this._levels=null,this.device=null;}},n.recreateImpl=function(e){ void 0===e&&(e=true);var t,n=this.device;null==(t=this.impl)||t.destroy(n),this.impl=null,this.impl=n.createTextureImpl(this),this.dirtyAll(),e&&this.upload();},n._clearLevels=function(){this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null];},n.resize=function(e,t,n){ void 0===n&&(n=1);var i=this.device;this.adjustVramSizeTracking(i._vram,-this._gpuSize),this.impl.destroy(i),this._clearLevels(),this._width=Math.floor(e),this._height=Math.floor(t),this._depth=Math.floor(n),this._updateNumLevel(),this.impl=i.createTextureImpl(this),this.dirtyAll();},n.loseContext=function(){this.impl.loseContext(),this.dirtyAll();},n.adjustVramSizeTracking=function(e,t){e.tex+=t;},n.propertyChanged=function(e){this.impl.propertyChanged(e),this.renderVersionDirty=this.device.renderVersion;},n._updateNumLevel=function(){var e=this.mipmaps?nM.calcMipLevelsCount(this.width,this.height):1,t=this._numLevelsRequested;this._numLevels=Math.min(null!=t?t:e,e),this._mipmaps=this._numLevels>1;},n.dirtyAll=function(){this._levelsUpdated=this._cubemap?[[true,true,true,true,true,true]]:[true],this._needsUpload=true,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=false,this.propertyChanged(255);},n.lock=function(e){ void 0===e&&(e={}),null!=(t=e).level||(t.level=0),null!=(n=e).face||(n.face=0),null!=(i=e).mode||(i.mode=2),this._lockedMode=e.mode,this._lockedLevel=e.level;var t,n,i,r=this.cubemap?this._levels[e.face]:this._levels;if(null===r[e.level]){var s=Math.max(1,this._width>>e.level),a=Math.max(1,this._height>>e.level),o=Math.max(1,this._depth>>e.level),l=new ArrayBuffer(nM.calcLevelGpuSize(s,a,o,this._format));r[e.level]=new(tb(this._format))(l);}return r[e.level]},n.setSource=function(e,t){ void 0===t&&(t=0);var n,r,s,a=false;if(this._cubemap){if(e[0]){r=e[0].width||0,s=e[0].height||0;for(var o=0;o<6;o++){var l=e[o];if(!l||l.width!==r||l.height!==s||!this.device._isBrowserInterface(l)){a=true;break}}}else a=true;if(!a)for(var u=0;u<6;u++)this._levels[t][u]!==e[u]&&(this._levelsUpdated[t][u]=true);}else this.device._isBrowserInterface(e)||(a=true),a||((e!==this._levels[t]&&(this._levelsUpdated[t]=true),null!=(n=HTMLVideoElement)&&"undefined"!=typeof Symbol&&n[Symbol.hasInstance]?!!n[Symbol.hasInstance](e):i(e,n))?(r=e.videoWidth,s=e.videoHeight):(r=e.width,s=e.height));if(a)if(this._width=4,this._height=4,this._cubemap)for(var c=0;c<6;c++)this._levels[t][c]=null,this._levelsUpdated[t][c]=true;else this._levels[t]=null,this._levelsUpdated[t]=true;else 0===t&&(this._width=r,this._height=s),this._levels[t]=e;this._invalid===a&&a||(this._invalid=a,this.upload());},n.getSource=function(e){return void 0===e&&(e=0),this._levels[e]},n.unlock=function(){this._lockedMode,2===this._lockedMode&&this.upload(),this._lockedLevel=-1,this._lockedMode=0;},n.upload=function(){this._needsUpload=true,this._needsMipmapsUpload=this._mipmaps,null==this.impl.uploadImmediate||this.impl.uploadImmediate.call(this.impl,this.device,this);},n.read=function(e,t,n,i,r){return void 0===r&&(r={}),null==this.impl.read?void 0:this.impl.read.call(this.impl,e,t,n,i,r)},n.write=function(e,t,n,i,r){return null==this.impl.write?void 0:this.impl.write.call(this.impl,e,t,n,i,r)},t=[{key:"lockedMode",get:function(){return this._lockedMode}},{key:"minFilter",get:function(){return this._minFilter},set:function(e){this._minFilter!==e&&(tg(this._format)||(this._minFilter=e,this.propertyChanged(1)));}},{key:"magFilter",get:function(){return this._magFilter},set:function(e){this._magFilter!==e&&(tg(this._format)||(this._magFilter=e,this.propertyChanged(2)));}},{key:"addressU",get:function(){return this._addressU},set:function(e){this._addressU!==e&&(this._addressU=e,this.propertyChanged(4));}},{key:"addressV",get:function(){return this._addressV},set:function(e){this._addressV!==e&&(this._addressV=e,this.propertyChanged(8));}},{key:"addressW",get:function(){return this._addressW},set:function(e){this._volume&&e!==this._addressW&&(this._addressW=e,this.propertyChanged(16));}},{key:"compareOnRead",get:function(){return this._compareOnRead},set:function(e){this._compareOnRead!==e&&(this._compareOnRead=e,this.propertyChanged(32));}},{key:"compareFunc",get:function(){return this._compareFunc},set:function(e){this._compareFunc!==e&&(this._compareFunc=e,this.propertyChanged(64));}},{key:"anisotropy",get:function(){return this._anisotropy},set:function(e){this._anisotropy!==e&&(this._anisotropy=e,this.propertyChanged(128));}},{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){this._mipmaps!==e&&(this.device.isWebGPU||tg(this._format)||(this._mipmaps=e),e&&(this._needsMipmapsUpload=true));}},{key:"numLevels",get:function(){return this._numLevels}},{key:"storage",get:function(){return this._storage}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"format",get:function(){return this._format}},{key:"cubemap",get:function(){return this._cubemap}},{key:"gpuSize",get:function(){var e=this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length);return nM.calcGpuSize(this._width,this._height,this._depth,this._format,e,this._cubemap)}},{key:"array",get:function(){return this._arrayLength>0}},{key:"arrayLength",get:function(){return this._arrayLength}},{key:"volume",get:function(){return this._volume}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this.device._shadersDirty=true);}},{key:"srgb",get:function(){return tv(this.format)},set:function(e){if(e!==tv(this.format))if(e){var t=ty(this.format);this._format!==t&&(this._format=t,this.recreateImpl(),this.device._shadersDirty=true);}else {var n=tS(this.format);this._format!==n&&(this._format=n,this.recreateImpl(),this.device._shadersDirty=true);}}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._needsUpload=true);}},{key:"premultiplyAlpha",get:function(){return this._premultiplyAlpha},set:function(e){this._premultiplyAlpha!==e&&(this._premultiplyAlpha=e,this._needsUpload=true);}},{key:"pot",get:function(){return ek.powerOfTwo(this._width)&&ek.powerOfTwo(this._height)}},{key:"encoding",get:function(){switch(this.type){case t1:return "rgbm";case t2:return "rgbe";case t3:return "rgbp"}return tx(this.format)?"srgb":"linear"}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),nk={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255],pink:[255,128,255,255]},nN=function(){function e(){this.map=new Map;}return e.prototype.destroy=function(){this.map.forEach(function(e){e.destroy();});},e}(),nF=new nD,nB=function(e,t){var n=nF.get(e,function(){return new nN});if(!n.map.has(t)){var i=new nO(e,{name:"built-in-texture-"+t,width:1,height:1,format:7}),r=i.lock(),s=nk[t];r.set(s),i.unlock(),n.map.set(t,i);}return n.map.get(t)},nU=0,nz=function(){this.offsets=[];},nV=function(){function e(e,t,n){this.renderVersionUpdated=-1,this.uniformBufferOffsets=[],this.id=nU++,this.device=e,this.format=t,this.dirty=true,this.impl=e.createBindGroupImpl(this),this.textures=[],this.storageTextures=[],this.storageBuffers=[],this.uniformBuffers=[],this.defaultUniformBuffer=n,n&&this.setUniformBuffer(nd,n);}var t=e.prototype;return t.destroy=function(){this.impl.destroy(),this.impl=null,this.format=null,this.defaultUniformBuffer=null;},t.setUniformBuffer=function(e,t){var n=this.format.bufferFormatsMap.get(e);this.uniformBuffers[n]!==t&&(this.uniformBuffers[n]=t,this.dirty=true);},t.setStorageBuffer=function(e,t){var n=this.format.storageBufferFormatsMap.get(e);this.storageBuffers[n]!==t&&(this.storageBuffers[n]=t,this.dirty=true);},t.setTexture=function(e,t){var n=this.format.textureFormatsMap.get(e);this.textures[n]!==t?(this.textures[n]=t,this.dirty=true):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=true);},t.setStorageTexture=function(e,t){var n=this.format.storageTextureFormatsMap.get(e);this.storageTextures[n]!==t?(this.storageTextures[n]=t,this.dirty=true):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=true);},t.updateUniformBuffers=function(){for(var e=0;e<this.uniformBuffers.length;e++)this.uniformBuffers[e].update();},t.update=function(){for(var e=this.format,t=e.textureFormats,n=e.storageTextureFormats,i=e.storageBufferFormats,r=0;r<t.length;r++){var s=t[r],a=s.scopeId.value;!a&&("uSceneDepthMap"===s.name&&(a=nB(this.device,"white")),"uSceneColorMap"===s.name&&(a=nB(this.device,"pink")),a||(a=nB(this.device,"pink"))),this.setTexture(s.name,a);}for(var o=0;o<n.length;o++){var l=n[o],u=l.scopeId.value;this.setStorageTexture(l.name,u);}for(var c=0;c<i.length;c++){var h=i[c],f=h.scopeId.value;this.setStorageBuffer(h.name,f);}this.uniformBufferOffsets.length=this.uniformBuffers.length;for(var d=0;d<this.uniformBuffers.length;d++){var p=this.uniformBuffers[d];this.uniformBufferOffsets[d]=p.offset,this.renderVersionUpdated<p.renderVersionDirty&&(this.dirty=true);}this.dirty&&(this.dirty=false,this.renderVersionUpdated=this.device.renderVersion,this.impl.update(this));},e}(),nG=function(e,t,n,i){return void 0===i&&(i=1),e&~(i<<n)|t<<n},nH=function(e,t,n){return void 0===n&&(n=1),e>>t&n},nW=function(e,t,n){ void 0===n&&(n=1);var i=n<<t;return (e&i)===i},nj=function(){function e(e,t,n,i,r,s,a,o,l,u,c){ void 0===e&&(e=false),void 0===t&&(t=0),void 0===n&&(n=1),void 0===i&&(i=0),void 0===o&&(o=true),void 0===l&&(l=true),void 0===u&&(u=true),void 0===c&&(c=true),this.target0=0,this.setColorBlend(t,n,i),this.setAlphaBlend(null!=r?r:t,null!=s?s:n,null!=a?a:i),this.setColorWrite(o,l,u,c),this.blend=e;}var t,n=e.prototype;return n.setColorBlend=function(e,t,n){this.target0=nG(this.target0,e,0,7),this.target0=nG(this.target0,t,3,15),this.target0=nG(this.target0,n,7,15);},n.setAlphaBlend=function(e,t,n){this.target0=nG(this.target0,e,11,7),this.target0=nG(this.target0,t,14,15),this.target0=nG(this.target0,n,18,15);},n.setColorWrite=function(e,t,n,i){this.redWrite=e,this.greenWrite=t,this.blueWrite=n,this.alphaWrite=i;},n.copy=function(e){return this.target0=e.target0,this},n.clone=function(){return new this.constructor().copy(this)},n.equals=function(e){return this.target0===e.target0},t=[{key:"blend",get:function(){return nW(this.target0,26)},set:function(e){this.target0=nG(this.target0,+!!e,26);}},{key:"colorOp",get:function(){return nH(this.target0,0,7)}},{key:"colorSrcFactor",get:function(){return nH(this.target0,3,15)}},{key:"colorDstFactor",get:function(){return nH(this.target0,7,15)}},{key:"alphaOp",get:function(){return nH(this.target0,11,7)}},{key:"alphaSrcFactor",get:function(){return nH(this.target0,14,15)}},{key:"alphaDstFactor",get:function(){return nH(this.target0,18,15)}},{key:"redWrite",get:function(){return nW(this.target0,22)},set:function(e){this.target0=nG(this.target0,+!!e,22);}},{key:"greenWrite",get:function(){return nW(this.target0,23)},set:function(e){this.target0=nG(this.target0,+!!e,23);}},{key:"blueWrite",get:function(){return nW(this.target0,24)},set:function(e){this.target0=nG(this.target0,+!!e,24);}},{key:"alphaWrite",get:function(){return nW(this.target0,25)},set:function(e){this.target0=nG(this.target0,+!!e,25);}},{key:"allWrite",get:function(){return nH(this.target0,22,15)}},{key:"key",get:function(){return this.target0}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();nj.NOBLEND=Object.freeze(new nj),nj.NOWRITE=Object.freeze(new nj(void 0,void 0,void 0,void 0,void 0,void 0,void 0,false,false,false,false)),nj.ALPHABLEND=Object.freeze(new nj(true,0,6,8)),nj.ADDBLEND=Object.freeze(new nj(true,0,1,1));var nX=function(){function e(){this.map=new Map,this.id=0;}return e.prototype.get=function(e){var t=this.map.get(e);return void 0===t&&(t=this.id++,this.map.set(e,t)),t},e}(),nY=new nX,nq=function(){function e(e,t){ void 0===e&&(e=3),void 0===t&&(t=true),this.data=0,this._depthBias=0,this._depthBiasSlope=0,this.key=0,this.func=e,this.write=t;}var t,n=e.prototype;return n.copy=function(e){return this.data=e.data,this._depthBias=e._depthBias,this._depthBiasSlope=e._depthBiasSlope,this.key=e.key,this},n.clone=function(){return new this.constructor().copy(this)},n.updateKey=function(){var e=this.data,t=this._depthBias,n=this._depthBiasSlope;this.key=nY.get(e+"-"+t+"-"+n);},n.equals=function(e){return this.key===e.key},t=[{key:"test",get:function(){return 7!==this.func},set:function(e){this.func=e?3:7,this.updateKey();}},{key:"write",get:function(){return nW(this.data,3)},set:function(e){this.data=nG(this.data,+!!e,3),this.updateKey();}},{key:"func",get:function(){return nH(this.data,0,7)},set:function(e){this.data=nG(this.data,e,0,7),this.updateKey();}},{key:"depthBias",get:function(){return this._depthBias},set:function(e){this._depthBias=e,this.updateKey();}},{key:"depthBiasSlope",get:function(){return this._depthBiasSlope},set:function(e){this._depthBiasSlope=e,this.updateKey();}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();nq.DEFAULT=Object.freeze(new nq),nq.NODEPTH=Object.freeze(new nq(7,false)),nq.WRITEDEPTH=Object.freeze(new nq(7,true));var nK=function(){function e(){this.globalId=0,this.revision=0;}var t=e.prototype;return t.equals=function(e){return this.globalId===e.globalId&&this.revision===e.revision},t.copy=function(e){this.globalId=e.globalId,this.revision=e.revision;},t.reset=function(){this.globalId=0,this.revision=0;},e}(),nZ=0,nQ=function(){function e(){nZ++,this.version=new nK,this.version.globalId=nZ;}return e.prototype.increment=function(){this.version.revision++;},e}(),nJ=function(){function e(e){this.name=e,this.value=null,this.versionObject=new nQ;}var t=e.prototype;return t.toJSON=function(e){},t.setValue=function(e){this.value=e,this.versionObject.increment();},t.getValue=function(){return this.value},e}(),n$=function(){function e(e){this.name=e,this.variables=new Map;}var t=e.prototype;return t.resolve=function(e){return this.variables.has(e)||this.variables.set(e,new nJ(e)),this.variables.get(e)},t.removeValue=function(e){for(var t in this.variables){var n=this.variables[t];n.value===e&&(n.value=null);}},e}(),n0=0,n1=function(){function e(e,t,n,i){this.usage=0,this.usage=null!=(r=null==i?void 0:i.usage)?r:0,this.device=e,this.format=t,this.numVertices=n,this.id=n0++,this.impl=e.createVertexBufferImpl(this,t,i),this.numBytes=t.verticesByteSize?t.verticesByteSize:t.size*n,this.adjustVramSizeTracking(e._vram,this.numBytes);var r,s=null==i?void 0:i.data;s?this.setData(s):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this);}var t=e.prototype;return t.destroy=function(){var e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength));},t.adjustVramSizeTracking=function(e,t){e.vb+=t;},t.loseContext=function(){this.impl.loseContext();},t.getFormat=function(){return this.format},t.getUsage=function(){return this.usage},t.getNumVertices=function(){return this.numVertices},t.lock=function(){return this.storage},t.unlock=function(){this.impl.unlock(this);},t.setData=function(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),true)},e}();function n2(e){if(null==e)return 0;for(var t=0,n=0,i=e.length;n<i;n++)t=(t<<5)-t+e.charCodeAt(n)|0;return t}function n3(e){for(var t=0x811c9dc5,n=0;n<e.length;n++)t^=e[n],t*=0x1000193;return t>>>0}var n4=new nX,n5=[2,4,8,12,16],n8=new nD,n6=function(){function e(e,t,n){this.device=e,this._elements=[],this.hasUv0=false,this.hasUv1=false,this.hasColor=false,this.hasTangents=false,this.verticesByteSize=0,this.vertexCount=n,this.interleaved=void 0===n,this.instancing=false,this.size=t.reduce(function(e,t){return e+4*Math.ceil(t.components*n_[t.type]/4)},0);for(var i,r=0,s=0,a=t.length;s<a;s++){var o,l,u=t[s];i=u.components*n_[u.type],n&&(r=ek.roundUp(r,i));var c=null!=(o=u.asInt)&&o,h=!c&&null!=(l=u.normalize)&&l,f={name:u.semantic,offset:n?r:u.hasOwnProperty("offset")?u.offset:r,stride:n?i:u.hasOwnProperty("stride")?u.stride:this.size,dataType:u.type,numComponents:u.components,normalize:h,size:i,asInt:c};this._elements.push(f),n?r+=i*n:r+=4*Math.ceil(i/4),u.semantic===tL?this.hasUv0=true:u.semantic===tD?this.hasUv1=true:u.semantic===tP?this.hasColor=true:u.semantic===tw&&(this.hasTangents=true);}n&&(this.verticesByteSize=r),this._evaluateHash();}var t,n=e.prototype;return n.update=function(){this._evaluateHash();},n._evaluateHash=function(){for(var e=[],t=[],n=this._elements.length,i=0;i<n;i++){var r=this._elements[i],s=r.name,a=r.dataType,o=r.numComponents,l=r.normalize,u=r.offset,c=r.stride,h=r.size,f=s+a+o+l+r.asInt;e.push(f);var d=f+u+c+h;t.push(d);}e.sort();var p=e.join();this.batchingHash=n2(p),this.shaderProcessingHashString=p,this.renderingHashString=t.join("_"),this.renderingHash=n4.get(this.renderingHashString);},e.getDefaultInstancingFormat=function(t){return n8.get(t,function(){return new e(t,[{semantic:tK,components:4,type:6},{semantic:tZ,components:4,type:6},{semantic:tJ,components:4,type:6},{semantic:t$,components:4,type:6}])})},e.isElementValid=function(e,t){var n=t.components*n_[t.type];return !e.isWebGPU||!!n5.includes(n)},t=[{key:"elements",get:function(){return this._elements}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),n9=new nX,n7=function(){function e(e){var t,n,i,r,s,a,o;void 0===e&&(e={}),this._dirty=true,this._func=null!=(t=e.func)?t:7,this._ref=null!=(n=e.ref)?n:0,this._readMask=null!=(i=e.readMask)?i:255,this._writeMask=null!=(r=e.writeMask)?r:255,this._fail=null!=(s=e.fail)?s:0,this._zfail=null!=(a=e.zfail)?a:0,this._zpass=null!=(o=e.zpass)?o:0,this._evalKey();}var t,n=e.prototype;return n._evalKey=function(){var e=this._func+","+this._ref+","+this._fail+","+this._zfail+","+this._zpass+","+this._readMask+","+this._writeMask;this._key=n9.get(e),this._dirty=false;},n.copy=function(e){return this._func=e._func,this._ref=e._ref,this._readMask=e._readMask,this._writeMask=e._writeMask,this._fail=e._fail,this._zfail=e._zfail,this._zpass=e._zpass,this._dirty=e._dirty,this._key=e._key,this},n.clone=function(){return new this.constructor().copy(this)},t=[{key:"func",get:function(){return this._func},set:function(e){this._func=e,this._dirty=true;}},{key:"ref",get:function(){return this._ref},set:function(e){this._ref=e,this._dirty=true;}},{key:"fail",get:function(){return this._fail},set:function(e){this._fail=e,this._dirty=true;}},{key:"zfail",get:function(){return this._zfail},set:function(e){this._zfail=e,this._dirty=true;}},{key:"zpass",get:function(){return this._zpass},set:function(e){this._zpass=e,this._dirty=true;}},{key:"readMask",get:function(){return this._readMask},set:function(e){this._readMask=e,this._dirty=true;}},{key:"writeMask",get:function(){return this._writeMask},set:function(e){this._writeMask=e,this._dirty=true;}},{key:"key",get:function(){return this._dirty&&this._evalKey(),this._key}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function ie(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function it(){return (it=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);}return e}).apply(this,arguments)}function ii(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function ir(e,t){return (ir=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function is(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return ie(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ie(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}n7.DEFAULT=Object.freeze(new n7);var ia=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){(i=e.call(this)||this).backBuffer=null,i.backBufferSize=new eX,i.backBufferAntialias=false,i.isWebGPU=false,i.isWebGL2=false,i.isHdr=false,i.maxIndirectDrawCount=1024,i.maxColorAttachments=1,i.maxSamples=1,i.supportsCompute=false,i.supportsStorageTextureRead=false,i.renderTarget=null,i.shaders=[],i.textures=[],i.targets=new Set,i.renderVersion=0,i.insideRenderPass=false,i.supportsUniformBuffers=false,i.supportsClipDistances=false,i.textureRG11B10Renderable=false,i.textureFloatFilterable=false,i.blendState=new nj,i.depthState=new nq,i.stencilEnabled=false,i.stencilFront=new n7,i.stencilBack=new n7,i.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},i.clientRect={width:0,height:0},i._shadersDirty=false,i.capsDefines=new Map,i.mapsToClear=new Set,i.canvas=t,"setAttribute"in t&&t.setAttribute("data-engine","PlayCanvas "+J),i.initOptions=it({},n),null!=(r=i.initOptions).alpha||(r.alpha=true),null!=(s=i.initOptions).depth||(s.depth=true),null!=(a=i.initOptions).stencil||(a.stencil=true),null!=(o=i.initOptions).antialias||(o.antialias=true),null!=(l=i.initOptions).powerPreference||(l.powerPreference="high-performance"),null!=(u=i.initOptions).displayFormat||(u.displayFormat="ldr"),i._maxPixelRatio=ef.browser?Math.min(1,window.devicePixelRatio):1,i.buffers=[],i._vram={tex:0,vb:0,ib:0,ub:0,sb:0},i._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},i.initializeContextCaches(),i._drawCallsPerFrame=0,i._shaderSwitchesPerFrame=0,i._primsPerFrame=[];for(var i,r,s,a,o,l,u,c=0;c<=6;c++)i._primsPerFrame[c]=0;return i._renderTargetCreationTime=0,i.scope=new n$("Device"),i.textureBias=i.scope.resolve("textureBias"),i.textureBias.setValue(0),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&ir(t,e);var n,i=t.prototype;return i.postInit=function(){var e=new n6(this,[{semantic:tT,components:2,type:6}]),t=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this.quadVertexBuffer=new n1(this,e,4,{data:t});},i.initCapsDefines=function(){var e=this.capsDefines;e.clear(),this.textureFloatFilterable&&e.set("CAPS_TEXTURE_FLOAT_FILTERABLE",""),this.textureFloatRenderable&&e.set("CAPS_TEXTURE_FLOAT_RENDERABLE","");},i.destroy=function(){var e,t,n;this.fire("destroy"),null==(e=this.quadVertexBuffer)||e.destroy(),this.quadVertexBuffer=null,null==(t=this.dynamicBuffers)||t.destroy(),this.dynamicBuffers=null,null==(n=this.gpuProfiler)||n.destroy(),this.gpuProfiler=null;},i.onDestroyShader=function(e){this.fire("destroy:shader",e);var t=this.shaders.indexOf(e);-1!==t&&this.shaders.splice(t,1);},i.postDestroy=function(){this.scope=null,this.canvas=null;},i.loseContext=function(){this.contextLost=true,this.backBufferSize.set(-1,-1);for(var e,t,n=is(this.textures);!(t=n()).done;)t.value.loseContext();for(var i,r=is(this.buffers);!(i=r()).done;)i.value.loseContext();for(var s,a=is(this.targets);!(s=a()).done;)s.value.loseContext();null==(e=this.gpuProfiler)||e.loseContext();},i.restoreContext=function(){this.contextLost=false,this.initializeRenderState(),this.initializeContextCaches();for(var e,t,n,i=is(this.buffers);!(n=i()).done;)n.value.unlock();null==(t=this.gpuProfiler)||null==(e=t.restoreContext)||e.call(t);},i.toJSON=function(e){},i.initializeContextCaches=function(){this.vertexBuffers=[],this.shader=null,this.shaderValid=void 0,this.shaderAsyncCompile=false,this.renderTarget=null;},i.initializeRenderState=function(){this.blendState=new nj,this.depthState=new nq,this.cullMode=1,this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.blendColor=new eN(0,0,0,0);},i.setStencilState=function(e,t){},i.setBlendState=function(e){},i.setBlendColor=function(e,t,n,i){},i.setDepthState=function(e){},i.setCullMode=function(e){},i.setRenderTarget=function(e){this.renderTarget=e;},i.setVertexBuffer=function(e){e&&this.vertexBuffers.push(e);},i.clearVertexBuffer=function(){this.vertexBuffers.length=0;},i.getIndirectDrawSlot=function(){return 0},i.getRenderTarget=function(){return this.renderTarget},i.initRenderTarget=function(e){e.initialized||(e.init(),this.targets.add(e));},i.draw=function(e,t,n,i,r,s){},i._isBrowserInterface=function(e){return this._isImageBrowserInterface(e)||this._isImageCanvasInterface(e)||this._isImageVideoInterface(e)},i._isImageBrowserInterface=function(e){return "undefined"!=typeof ImageBitmap&&ii(e,ImageBitmap)||"undefined"!=typeof HTMLImageElement&&ii(e,HTMLImageElement)},i._isImageCanvasInterface=function(e){return "undefined"!=typeof HTMLCanvasElement&&ii(e,HTMLCanvasElement)},i._isImageVideoInterface=function(e){return "undefined"!=typeof HTMLVideoElement&&ii(e,HTMLVideoElement)},i.resizeCanvas=function(e,t){var n=Math.min(this._maxPixelRatio,ef.browser?window.devicePixelRatio:1),i=Math.floor(e*n),r=Math.floor(t*n);(i!==this.canvas.width||r!==this.canvas.height)&&this.setResolution(i,r);},i.setResolution=function(e,n){this.canvas.width=e,this.canvas.height=n,this.fire(t.EVENT_RESIZE,e,n);},i.update=function(){this.updateClientRect();},i.updateClientRect=function(){if(ef.worker)this.clientRect.width=this.canvas.width,this.clientRect.height=this.canvas.height;else {var e=this.canvas.getBoundingClientRect();this.clientRect.width=e.width,this.clientRect.height=e.height;}},i.startRenderPass=function(e){},i.endRenderPass=function(e){},i.startComputePass=function(e){},i.endComputePass=function(){},i.frameStart=function(){this.renderPassIndex=0,this.renderVersion++;},i.frameEnd=function(){this.mapsToClear.forEach(function(e){return e.clear()}),this.mapsToClear.clear();},i.computeDispatch=function(e,t){},i.getRenderableHdrFormat=function(e,t,n){ void 0===e&&(e=[18,12,14]),void 0===t&&(t=true),void 0===n&&(n=1);for(var i=0;i<e.length;i++){var r=e[i];switch(r){case 18:if(this.textureRG11B10Renderable)return r;break;case 12:if(this.textureHalfFloatRenderable)return r;break;case 14:if(this.isWebGPU&&n>1)continue;if(this.textureFloatRenderable&&(!t||this.textureFloatFilterable))return r}}},i.validateAttributes=function(e,t,n){},n=[{key:"indirectDrawBuffer",get:function(){return null}},{key:"width",get:function(){return this.canvas.width}},{key:"height",get:function(){return this.canvas.height}},{key:"fullscreen",get:function(){return  false},set:function(e){}},{key:"maxPixelRatio",get:function(){return this._maxPixelRatio},set:function(e){this._maxPixelRatio=e;}},{key:"deviceType",get:function(){return this._deviceType}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);ia.EVENT_RESIZE="resizecanvas";var io=0,il=function(){function e(e){ void 0===e&&(e={}),this.id=io++;var t,n,i,r,s,a,o,l,u,c,h,f,d,p,m,_=null!=(a=null!=(s=null!=(r=null==(t=e.colorBuffer)?void 0:t.device)?r:null==(n=e.colorBuffers)?void 0:n[0].device)?s:null==(i=e.depthBuffer)?void 0:i.device)?a:e.graphicsDevice;this._device=_;var v=this._device.maxSamples;if(this._samples=Math.min(null!=(o=e.samples)?o:1,v),_.isWebGPU&&(this._samples=this._samples>1?v:1),this._colorBuffer=e.colorBuffer,e.colorBuffer&&(this._colorBuffers=[e.colorBuffer]),this._depthBuffer=e.depthBuffer,this._face=null!=(l=e.face)?l:0,this._depthBuffer){var g=this._depthBuffer._format;16===g||69===g?(this._depth=true,this._stencil=false):17===g?(this._depth=true,this._stencil=true):(15===g&&this._depthBuffer.device.isWebGPU&&this._samples>1?this._depth=true:this._depth=false,this._stencil=false);}else this._depth=null==(u=e.depth)||u,this._stencil=null!=(c=e.stencil)&&c;e.colorBuffers&&!this._colorBuffers&&(this._colorBuffers=[].concat(e.colorBuffers),this._colorBuffer=e.colorBuffers[0]),this.autoResolve=null==(h=e.autoResolve)||h,this.name=e.name,this.name||(this.name=null==(f=this._colorBuffer)?void 0:f.name),this.name||(this.name=null==(d=this._depthBuffer)?void 0:d.name),this.name||(this.name="Untitled"),this.flipY=null!=(p=e.flipY)&&p,this._mipLevel=null!=(m=e.mipLevel)?m:0,this._mipLevel>0&&this._depth&&(this._mipLevel=0),this._mipmaps=void 0===e.mipLevel,this.validateMrt(),this.impl=_.createRenderTargetImpl(this);}var t,n=e.prototype;return n.destroy=function(){var e=this._device;e&&(e.targets.delete(this),e.renderTarget===this&&e.setRenderTarget(null),this.destroyFrameBuffers());},n.destroyFrameBuffers=function(){var e=this._device;e&&this.impl.destroy(e);},n.destroyTextureBuffers=function(){var e,t;null==(e=this._depthBuffer)||e.destroy(),this._depthBuffer=null,null==(t=this._colorBuffers)||t.forEach(function(e){e.destroy();}),this._colorBuffers=null,this._colorBuffer=null;},n.resize=function(e,t){if((this.width!==e||this.height!==t)&&!(this.mipLevel>0)){var n,i,r=this._device;this.destroyFrameBuffers(),r.renderTarget===this&&r.setRenderTarget(null),null==(n=this._depthBuffer)||n.resize(e,t),null==(i=this._colorBuffers)||i.forEach(function(n){n.resize(e,t);}),this.validateMrt(),this.impl=r.createRenderTargetImpl(this);}},n.validateMrt=function(){},n.init=function(){this.impl.init(this._device,this);},n.loseContext=function(){this.impl.loseContext();},n.resolve=function(e,t){ void 0===e&&(e=true),void 0===t&&(t=!!this._depthBuffer),this._device&&this._samples>1&&this.impl.resolve(this._device,this,e,t);},n.copy=function(e,t,n){if(!this._device)if(!e._device)return  false;else this._device=e._device;return this._device.copyRenderTarget(e,this,t,n)},n.getColorBuffer=function(e){var t;return null==(t=this._colorBuffers)?void 0:t[e]},n.isColorBufferSrgb=function(e){if(void 0===e&&(e=0),this.device.backBuffer===this)return tv(this.device.backBufferFormat);var t=this.getColorBuffer(e);return !!t&&tv(t.format)},t=[{key:"initialized",get:function(){return this.impl.initialized}},{key:"device",get:function(){return this._device}},{key:"samples",get:function(){return this._samples}},{key:"depth",get:function(){return this._depth}},{key:"stencil",get:function(){return this._stencil}},{key:"colorBuffer",get:function(){return this._colorBuffer}},{key:"depthBuffer",get:function(){return this._depthBuffer}},{key:"face",get:function(){return this._face}},{key:"mipLevel",get:function(){return this._mipLevel}},{key:"mipmaps",get:function(){return this._mipmaps}},{key:"width",get:function(){var e,t,n=(null==(e=this._colorBuffer)?void 0:e.width)||(null==(t=this._depthBuffer)?void 0:t.width)||this._device.width;return this._mipLevel>0&&(n=nM.calcLevelDimension(n,this._mipLevel)),n}},{key:"height",get:function(){var e,t,n=(null==(e=this._colorBuffer)?void 0:e.height)||(null==(t=this._depthBuffer)?void 0:t.height)||this._device.height;return this._mipLevel>0&&(n=nM.calcLevelDimension(n,this._mipLevel)),n}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),iu=function(){function e(){}var t=e.prototype;return t.update=function(e){this.destroy();var t=e.device,n=this.createDescriptor(t,e);this.bindGroup=t.wgpu.createBindGroup(n);},t.destroy=function(){this.bindGroup=null;},t.createDescriptor=function(e,t){var n=[],i=t.format,r=t.format.uniformBufferFormats;t.uniformBuffers.forEach(function(e,t){var i=r[t].slot,s=e.persistent?e.impl.buffer:e.allocation.gpuBuffer.buffer;n.push({binding:i,resource:{buffer:s,offset:0,size:e.format.byteSize}});});var s=t.format.textureFormats;t.textures.forEach(function(t,r){var a=t.impl,o=i.textureFormats[r],l=s[r].slot,u=a.getView(e);if(n.push({binding:l,resource:u}),o.hasSampler){var c=a.getSampler(e,o.sampleType);n.push({binding:l+1,resource:c});}});var a=t.format.storageTextureFormats;t.storageTextures.forEach(function(t,i){var r=t.impl,s=a[i].slot,o=r.getView(e);n.push({binding:s,resource:o});});var o=t.format.storageBufferFormats;return t.storageBuffers.forEach(function(e,t){var i=e.impl.buffer,r=o[t].slot;n.push({binding:r,resource:{buffer:i}});}),{layout:t.format.impl.bindGroupLayout,entries:n}},e}(),ic=function(){function e(){}return e.shaderStage=function(e){var t=0;return 1&e&&(t|=GPUShaderStage.VERTEX),2&e&&(t|=GPUShaderStage.FRAGMENT),4&e&&(t|=GPUShaderStage.COMPUTE),t},e}(),ih=[];ih[0]="",ih[1]="",ih[2]="",ih[52]="r8unorm",ih[53]="rg8unorm",ih[3]="",ih[4]="",ih[5]="",ih[6]="rgba8unorm",ih[7]="rgba8unorm",ih[8]="bc1-rgba-unorm",ih[9]="bc2-rgba-unorm",ih[10]="bc3-rgba-unorm",ih[11]="",ih[12]="rgba16float",ih[50]="r16float",ih[51]="rg16float",ih[13]="",ih[14]="rgba32float",ih[15]="r32float",ih[16]="depth32float",ih[69]="depth16unorm",ih[17]="depth24plus-stencil8",ih[18]="rg11b10ufloat",ih[19]="",ih[20]="rgba8unorm-srgb",ih[21]="",ih[22]="etc2-rgb8unorm",ih[23]="etc2-rgba8unorm",ih[24]="",ih[25]="",ih[26]="",ih[27]="",ih[28]="astc-4x4-unorm",ih[29]="",ih[30]="",ih[31]="bgra8unorm",ih[64]="bgra8unorm-srgb",ih[32]="r8sint",ih[33]="r8uint",ih[34]="r16sint",ih[35]="r16uint",ih[36]="r32sint",ih[37]="r32uint",ih[38]="rg8sint",ih[39]="rg8uint",ih[40]="rg16sint",ih[41]="rg16uint",ih[42]="rg32sint",ih[43]="rg32uint",ih[44]="rgba8sint",ih[45]="rgba8uint",ih[46]="rgba16sint",ih[47]="rgba16uint",ih[48]="rgba32sint",ih[49]="rgba32uint",ih[65]="bc6h-rgb-float",ih[66]="bc6h-rgb-ufloat",ih[67]="bc7-rgba-unorm",ih[54]="bc1-rgba-unorm-srgb",ih[55]="bc2-rgba-unorm-srgb",ih[56]="bc3-rgba-unorm-srgb",ih[61]="etc2-rgb8unorm-srgb",ih[62]="etc2-rgba8unorm-srgb",ih[68]="bc7-rgba-unorm-srgb",ih[63]="astc-4x4-unorm-srgb";var id=[];id[0]="filtering",id[1]="non-filtering",id[2]="comparison",id[3]="comparison",id[4]="comparison";var ip=[];ip[0]="float",ip[1]="unfilterable-float",ip[2]="depth",ip[3]="sint",ip[4]="uint";var im=new nX,i_=function(){function e(e){var t=e.device,n=this.createDescriptor(e),i=n.key,r=n.desc;this.key=im.get(i),this.bindGroupLayout=t.wgpu.createBindGroupLayout(r);}var t=e.prototype;return t.destroy=function(){this.bindGroupLayout=null;},t.loseContext=function(){},t.createDescriptor=function(e){var t=[],n="";return e.uniformBufferFormats.forEach(function(e){var i=ic.shaderStage(e.visibility);n+="#"+e.slot+"U:"+i,t.push({binding:e.slot,visibility:i,buffer:{type:"uniform",hasDynamicOffset:true}});}),e.textureFormats.forEach(function(e){var i=ic.shaderStage(e.visibility),r=e.sampleType,s=e.textureDimension,a=ip[r];if(n+="#"+e.slot+"T:"+i+"-"+a+"-"+s+"-false",t.push({binding:e.slot,visibility:i,texture:{sampleType:a,viewDimension:s,multisampled:false}}),e.hasSampler){var o=id[r];n+="#"+(e.slot+1)+"S:"+i+"-"+o,t.push({binding:e.slot+1,visibility:i,sampler:{type:o}});}}),e.storageTextureFormats.forEach(function(e){var i=e.format,r=e.textureDimension,s=e.read,a=e.write;n+="#"+e.slot+"ST:"+i+"-"+r+"-"+(s?"r1":"r0")+"-"+(a?"w1":"w0"),t.push({binding:e.slot,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:s?a?"read-write":"read-only":"write-only",format:ih[i],viewDimension:r}});}),e.storageBufferFormats.forEach(function(e){var i=e.readOnly,r=ic.shaderStage(e.visibility);n+="#"+e.slot+"SB:"+r+"-"+(i?"ro":"rw"),t.push({binding:e.slot,visibility:r,buffer:{type:i?"read-only-storage":"storage"}});}),{key:n,desc:{entries:t}}},e}(),iv=function(){function e(e){ void 0===e&&(e=0),this.buffer=null,this.usageFlags=0,this.usageFlags=e;}var t,n=e.prototype;return n.destroy=function(e){this.buffer&&(this.buffer.destroy(),this.buffer=null);},n.loseContext=function(){},n.allocate=function(e,t){this.buffer=e.wgpu.createBuffer({size:t,usage:this.usageFlags});},n.unlock=function(e,t){var n,i,r=e.wgpu;if(!this.buffer){var s=t.byteLength+3&-4;this.usageFlags|=GPUBufferUsage.COPY_DST,this.allocate(e,s);}var a=null!=(n=t.byteOffset)?n:0,o=new Uint8Array(null!=(i=t.buffer)?i:t,a,t.byteLength),l=new Uint8Array(this.buffer.size);l.set(o),r.queue.writeBuffer(this.buffer,0,l,0,l.length);},n.read=function(e,t,n,i,r){return e.readStorageBuffer(this,t,n,i,r)},n.write=function(e,t,n,i,r){e.writeStorageBuffer(this,t,n,i,r);},n.clear=function(e,t,n){e.clearStorageBuffer(this,t,n);},t=[{key:"initialized",get:function(){return !!this.buffer}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function ig(e,t){return (ig=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var iy=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,16|128*(null!=n&&!!n.storage))||this).format=null,i.format=1===t.format?"uint16":"uint32",i}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&ig(t,e),t.prototype.unlock=function(t){var n=t.device;e.prototype.unlock.call(this,n,t.storage);},t}(iv),iS={equals:function(e,t){if(e.length!==t.length)return  false;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return  false;return  true}},ix=[];ix[0]="sint8",ix[1]="uint8",ix[2]="sint16",ix[3]="uint16",ix[4]="sint32",ix[5]="uint32",ix[6]="float32",ix[7]="float16";var ib=[];ib[0]="snorm8",ib[1]="unorm8",ib[2]="snorm16",ib[3]="unorm16",ib[4]="sint32",ib[5]="uint32",ib[6]="float32",ib[7]="float16";var iT=function(){function e(){this.cache=new Map;}var t=e.prototype;return t.get=function(e,t){ void 0===t&&(t=null);var n=this.getKey(e,t),i=this.cache.get(n);return i||(i=this.create(e,t),this.cache.set(n,i)),i},t.getKey=function(e,t){return void 0===t&&(t=null),(null==e?void 0:e.renderingHashString)+"-"+(null==t?void 0:t.renderingHashString)},t.create=function(e,t){var n=[],i=function(e){for(var t=e.interleaved,i=e.instancing?"instance":"vertex",r=[],s=e.elements.length,a=0;a<s;a++){var o=e.elements[a],l=nS[o.name],u=o.normalize?ib:ix;r.push({shaderLocation:l,offset:t?o.offset:0,format:""+u[o.dataType]+(o.numComponents>1?"x"+o.numComponents:"")}),t&&a!==s-1||(n.push({attributes:r,arrayStride:o.stride,stepMode:i}),r=[]);}};return e&&i(e),t&&i(t),n},e}(),iE=function(){function e(e){this.device=e;}return e.prototype.getPipelineLayout=function(e){var t=[];return e.forEach(function(e){t.push(e.bindGroupLayout);}),this.device.wgpu.createPipelineLayout({bindGroupLayouts:t})},e}();function iw(e,t){return (iw=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var iA=["point-list","line-list",void 0,"line-strip","triangle-list","triangle-strip",void 0],iC=["add","subtract","reverse-subtract","min","max"],iP=["zero","one","src","one-minus-src","dst","one-minus-dst","src-alpha","src-alpha-saturated","one-minus-src-alpha","dst-alpha","one-minus-dst-alpha","constant","one-minus-constant"],iI=["never","less","equal","less-equal","greater","not-equal","greater-equal","always"],iL=["none","back","front"],iD=["keep","zero","replace","increment-clamp","increment-wrap","decrement-clamp","decrement-wrap","invert"],iM=["","uint16","uint32"],iR=function(){},iO=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).lookupHashes=new Uint32Array(14),n.vertexBufferLayout=new iT,n.cache=new Map,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&iw(t,e);var n=t.prototype;return n.get=function(e,t,n,i,r,s,a,o,l,u,c,h,f){var d,p,m,_,v,g,y,S,x=e.type;i&&3!==x&&5!==x&&(i=void 0);var b=this.lookupHashes;b[0]=x,b[1]=r.id,b[2]=u,b[3]=l.key,b[4]=o.key,b[5]=null!=(_=null==t?void 0:t.renderingHash)?_:0,b[6]=null!=(v=null==n?void 0:n.renderingHash)?v:0,b[7]=s.impl.key,b[8]=null!=(g=null==(d=a[0])?void 0:d.key)?g:0,b[9]=null!=(y=null==(p=a[1])?void 0:p.key)?y:0,b[10]=null!=(S=null==(m=a[2])?void 0:m.key)?S:0,b[11]=c?h.key:0,b[12]=c?f.key:0,b[13]=null!=i?i:0;var T=n3(b),E=this.cache.get(T);if(E)for(var w=0;w<E.length;w++){var A=E[w];if(iS.equals(A.hashes,b))return A.pipeline}var C=iA[x],P=this.getPipelineLayout(a),I=this.vertexBufferLayout.get(t,n),L=new iR;return L.hashes=new Uint32Array(b),L.pipeline=this.create(C,i,r,s,P,o,l,I,u,c,h,f),E?E.push(L):E=[L],this.cache.set(T,E),L.pipeline},n.getBlend=function(e){var t;return e.blend&&(t={color:{operation:iC[e.colorOp],srcFactor:iP[e.colorSrcFactor],dstFactor:iP[e.colorDstFactor]},alpha:{operation:iC[e.alphaOp],srcFactor:iP[e.alphaSrcFactor],dstFactor:iP[e.alphaDstFactor]}}),t},n.getDepthStencil=function(e,t,n,i,r,s){var a,o=t.depth,l=t.stencil;if(o||l){if(a={format:t.impl.depthAttachment.format},o){a.depthWriteEnabled=e.write,a.depthCompare=iI[e.func];var u="triangle-list"===s||"triangle-strip"===s;a.depthBias=u?e.depthBias:0,a.depthBiasSlopeScale=u?e.depthBiasSlope:0;}else a.depthWriteEnabled=false,a.depthCompare="always";l&&n&&(a.stencilReadMas=i.readMask,a.stencilWriteMask=i.writeMask,a.stencilFront={compare:iI[i.func],failOp:iD[i.fail],passOp:iD[i.zpass],depthFailOp:iD[i.zfail]},a.stencilBack={compare:iI[r.func],failOp:iD[r.fail],passOp:iD[r.zpass],depthFailOp:iD[r.zfail]});}return a},n.create=function(e,t,n,i,r,s,a,o,l,u,c,h){var f=this.device.wgpu,d=n.impl,p={vertex:{module:d.getVertexShaderModule(),entryPoint:d.vertexEntryPoint,buffers:o},primitive:{topology:e,frontFace:"ccw",cullMode:iL[l]},depthStencil:this.getDepthStencil(a,i,u,c,h,e),multisample:{count:i.samples},layout:r};t&&(p.primitive.stripIndexFormat=iM[t]),p.fragment={module:d.getFragmentShaderModule(),entryPoint:d.fragmentEntryPoint,targets:[]};var m=i.impl.colorAttachments;if(m.length>0){var _=0;s.redWrite&&(_|=GPUColorWrite.RED),s.greenWrite&&(_|=GPUColorWrite.GREEN),s.blueWrite&&(_|=GPUColorWrite.BLUE),s.alphaWrite&&(_|=GPUColorWrite.ALPHA);var v=this.getBlend(s);m.forEach(function(e){p.fragment.targets.push({format:e.format,writeMask:_,blend:v});});}return f.createRenderPipeline(p)},t}(iE);function ik(e,t){return (ik=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var iN=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){return e.apply(this,arguments)||this}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&ik(t,e);var n=t.prototype;return n.get=function(e,t){var n=this.getPipelineLayout([t.impl]);return this.create(e,n)},n.create=function(e,t){var n=this.device.wgpu,i=e.impl,r={compute:{module:i.getComputeShaderModule(),entryPoint:i.computeEntryPoint},layout:t};return n.createComputePipeline(r)},t}(iE),iF=function(){function e(){this._refCount=0;}var t,n=e.prototype;return n.incRefCount=function(){this._refCount++;},n.decRefCount=function(){this._refCount--;},t=[{key:"refCount",get:function(){return this._refCount}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function iB(e,t){return (iB=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var iU=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this).object=t,n.incRefCount(),n}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&iB(t,e),t}(iF);function iz(e,t){return (iz=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var iV=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){return e.apply(this,arguments)||this}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&iz(t,e),t.prototype.loseContext=function(e){this.clear();},t}(function(){function e(){this.cache=new Map;}var t=e.prototype;return t.destroy=function(){this.cache.forEach(function(e){var t;null==(t=e.object)||t.destroy();}),this.cache.clear();},t.clear=function(){this.cache.clear();},t.get=function(e){var t=this.cache.get(e);return t?(t.incRefCount(),t.object):null},t.set=function(e,t){this.cache.set(e,new iU(t));},t.release=function(e){var t,n=this.cache.get(e);n&&(n.decRefCount(),0===n.refCount&&(this.cache.delete(e),null==(t=n.object)||t.destroy()));},e}()),iG=new nD,iH=function(e){return iG.get(e,function(){return new iV})},iW=new nX,ij=function(){function e(){}return e.prototype.destroy=function(){var e;null==(e=this.multisampledBuffer)||e.destroy(),this.multisampledBuffer=null;},e}(),iX=function(){function e(e){this.depthTexture=null,this.depthTextureInternal=false,this.multisampledDepthBuffer=null,this.format=e,this.hasStencil="depth24plus-stencil8"===e;}return e.prototype.destroy=function(e){if(this.depthTextureInternal){var t;null==(t=this.depthTexture)||t.destroy(),this.depthTexture=null;}this.multisampledDepthBuffer&&(this.multisampledDepthBuffer=null,iH(e).release(this.multisampledDepthBufferKey));},e}(),iY=function(){function e(e){this.initialized=false,this.colorAttachments=[],this.depthAttachment=null,this.assignedColorTexture=null,this.renderPassDescriptor={},this.isBackbuffer=false,this.renderTarget=e;}var t=e.prototype;return t.destroy=function(e){var t;this.initialized=false,this.assignedColorTexture=null,this.colorAttachments.forEach(function(e){e.destroy();}),this.colorAttachments.length=0,null==(t=this.depthAttachment)||t.destroy(e),this.depthAttachment=null;},t.updateKey=function(){var e=this.renderTarget.samples+":"+(this.depthAttachment?this.depthAttachment.format:"nodepth");this.colorAttachments.forEach(function(t){e+=":"+t.format;}),this.key=iW.get(e);},t.assignColorTexture=function(e,t){this.assignedColorTexture=t;var n=t.createView({format:e.backBufferViewFormat}),i=this.renderPassDescriptor.colorAttachments[0];this.renderTarget.samples>1?i.resolveTarget=n:i.view=n,this.setColorAttachment(0,void 0,e.backBufferViewFormat),this.updateKey();},t.setColorAttachment=function(e,t,n){this.colorAttachments[e]||(this.colorAttachments[e]=new ij),t&&(this.colorAttachments[e].multisampledBuffer=t),n&&(this.colorAttachments[e].format=n);},t.init=function(e,t){var n=this,i=e.wgpu;this.initDepthStencil(e,i,t),t._colorBuffers&&t._colorBuffers.forEach(function(e,t){n.setColorAttachment(t,void 0,e.impl.format);}),this.renderPassDescriptor.colorAttachments=[];for(var r=this.isBackbuffer?1:null!=(o=null==(a=t._colorBuffers)?void 0:a.length)?o:0,s=0;s<r;++s){var a,o,l,u=this.initColor(e,i,t,s),c=0===s&&(null==(l=this.colorAttachments[0])?void 0:l.format);(u.view||c)&&this.renderPassDescriptor.colorAttachments.push(u);}this.updateKey(),this.initialized=true;},t.initDepthStencil=function(e,t,n){var i,r=n.samples,s=n.width,a=n.height,o=n.depth,l=n.depthBuffer;if(o||l){if(l)if(this.depthAttachment=new iX(l.impl.format),r>1){var u="depth24plus-stencil8";this.depthAttachment.format=u,this.depthAttachment.hasStencil=true;var c=l.id+":"+s+":"+a+":"+r+":"+u,h=iH(e),f=h.get(c);if(!f){var d={size:[s,a,1],dimension:"2d",sampleCount:r,format:u,usage:GPUTextureUsage.RENDER_ATTACHMENT|(u!==l.impl.format?GPUTextureUsage.TEXTURE_BINDING:0)};f=t.createTexture(d),h.set(c,f);}this.depthAttachment.multisampledDepthBuffer=f,this.depthAttachment.multisampledDepthBufferKey=c,i=f.createView();}else {var p=l.impl.gpuTexture;this.depthAttachment.depthTexture=p,i=p.createView();}else {this.depthAttachment=new iX("depth24plus-stencil8");var m={size:[s,a,1],dimension:"2d",sampleCount:r,format:this.depthAttachment.format,usage:GPUTextureUsage.RENDER_ATTACHMENT};r>1?m.usage|=GPUTextureUsage.TEXTURE_BINDING:m.usage|=GPUTextureUsage.COPY_SRC;var _=t.createTexture(m);this.depthAttachment.depthTexture=_,this.depthAttachment.depthTextureInternal=true,i=_.createView();}this.renderPassDescriptor.depthStencilAttachment={view:i};}},t.initColor=function(e,t,n,i){var r={},s=n.samples,a=n.width,o=n.height,l=n.mipLevel,u=n.getColorBuffer(i),c=null;if(u&&(c=u.cubemap?u.impl.createView({dimension:"2d",baseArrayLayer:n.face,arrayLayerCount:1,mipLevelCount:1,baseMipLevel:l}):u.impl.createView({mipLevelCount:1,baseMipLevel:l})),s>1){var h={size:[a,o,1],dimension:"2d",sampleCount:s,format:this.isBackbuffer?e.backBufferViewFormat:u.impl.format,usage:GPUTextureUsage.RENDER_ATTACHMENT},f=t.createTexture(h);this.setColorAttachment(i,f,h.format),r.view=f.createView(),r.resolveTarget=c;}else r.view=c;return r},t.setupForRenderPass=function(e,t){for(var n,i,r=null!=(i=null==(n=this.renderPassDescriptor.colorAttachments)?void 0:n.length)?i:0,s=0;s<r;++s){var a=this.renderPassDescriptor.colorAttachments[s],o=e.colorArrayOps[s];a.clearValue=t.isColorBufferSrgb(s)?o.clearValueLinear:o.clearValue,a.loadOp=o.clear?"clear":"load",a.storeOp=o.store?"store":"discard";}var l=this.renderPassDescriptor.depthStencilAttachment;l&&(l.depthClearValue=e.depthStencilOps.clearDepthValue,l.depthLoadOp=e.depthStencilOps.clearDepth?"clear":"load",l.depthStoreOp=e.depthStencilOps.storeDepth?"store":"discard",l.depthReadOnly=false,this.depthAttachment.hasStencil&&(l.stencilClearValue=e.depthStencilOps.clearStencilValue,l.stencilLoadOp=e.depthStencilOps.clearStencil?"clear":"load",l.stencilStoreOp=e.depthStencilOps.storeStencil?"store":"discard",l.stencilReadOnly=false));},t.loseContext=function(){this.initialized=false;},t.resolve=function(e,t,n,i){},e}(),iq=[];iq[2]=1,iq[3]=2,iq[4]=3,iq[5]=4,iq[1]=1,iq[6]=2,iq[7]=3,iq[8]=4,iq[0]=1,iq[9]=2,iq[10]=3,iq[11]=4,iq[12]=8,iq[13]=12,iq[14]=16,iq[26]=1,iq[27]=2,iq[28]=3,iq[29]=4;var iK=function(){var e;function t(e,t,n){if(void 0===n&&(n=0),this.shortName=e,this.name=n?""+e+"[0]":e,this.type=t,this.numComponents=iq[t],this.updateType=t,n>0)switch(t){case 2:this.updateType=17;break;case 1:this.updateType=30;break;case 26:this.updateType=31;break;case 0:this.updateType=32;break;case 3:this.updateType=21;break;case 6:this.updateType=33;break;case 27:this.updateType=34;break;case 9:this.updateType=35;break;case 4:this.updateType=22;break;case 7:this.updateType=36;break;case 28:this.updateType=37;break;case 10:this.updateType=38;break;case 5:this.updateType=23;break;case 8:this.updateType=39;break;case 29:this.updateType=40;break;case 11:this.updateType=41;break;case 14:this.updateType=24;}this.count=n;var i=this.numComponents;n&&(i=ek.roundUp(i,4)),this.byteSize=4*i,n&&(this.byteSize*=n);}return t.prototype.calculateOffset=function(e){var t=this.byteSize<=8?this.byteSize:16;this.count&&(t=16),e=ek.roundUp(e,t),this.offset=e/4;},e=[{key:"isArrayType",get:function(){return this.count>0}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}(),iZ=function(){function e(e,t){this.byteSize=0,this.map=new Map,this.scope=e.scope,this.uniforms=t;for(var n=0,i=0;i<t.length;i++){var r=t[i];r.calculateOffset(n),n=4*r.offset+r.byteSize,r.scopeId=this.scope.resolve(r.name),this.map.set(r.name,r);}this.byteSize=ek.roundUp(n,16);}return e.prototype.get=function(e){return this.map.get(e)},e}(),iQ=/[ \t]*(\battribute\b|\bvarying\b|\buniform\b)/g,iJ=/(\battribute\b|\bvarying\b|\bout\b|\buniform\b)[ \t]*([^;]+)(;+)/g,i$=/([\w-]+)\[(.*?)\]/,i0=new Set(["highp","mediump","lowp"]),i1=new Set(["sampler2DShadow","samplerCubeShadow","sampler2DArrayShadow"]),i2={sampler2D:"2d",sampler3D:"3d",samplerCube:t8,samplerCubeShadow:t8,sampler2DShadow:"2d",sampler2DArray:t5,sampler2DArrayShadow:t5,isampler2D:"2d",usampler2D:"2d",isampler3D:"3d",usampler3D:"3d",isamplerCube:t8,usamplerCube:t8,isampler2DArray:t5,usampler2DArray:t5},i3=((c={})["2d"]="texture2D",c[t8]="textureCube",c["3d"]="texture3D",c[t5]="texture2DArray",c),i4=function(e,t){this.line=e;var n=e.trim().split(/\s+/);if(i0.has(n[0])&&(this.precision=n.shift()),this.type=n.shift(),e.includes(","),e.includes("[")){var i=n.join(" "),r=i$.exec(i);this.name=r[1],this.arraySize=Number(r[2]),isNaN(this.arraySize)&&(t.failed=true);}else this.name=n.shift(),this.arraySize=0;this.isSampler=-1!==this.type.indexOf("sampler"),this.isSignedInt=-1!==this.type.indexOf("isampler"),this.isUnsignedInt=-1!==this.type.indexOf("usampler");},i5=function(){function e(){}return e.run=function(t,n,i){var r=new Map,s=e.extract(n.vshader),a=e.extract(n.fshader),o=new Map,l=e.processAttributes(s.attributes,n.attributes,o,n.processingOptions),u=e.processVaryings(s.varyings,r,true),c=e.processVaryings(a.varyings,r,false),h=e.processOuts(a.outs),f=Array.from(new Set(s.uniforms.concat(a.uniforms))).map(function(e){return new i4(e,i)}),d=e.processUniforms(t,f,n.processingOptions,i),p=l+"\n"+u+"\n"+d.code,m=s.src.replace("@@@",p),_=c+"\n"+h+"\n"+d.code;return {vshader:m,fshader:a.src.replace("@@@",_),attributes:o,meshUniformBufferFormat:d.meshUniformBufferFormat,meshBindGroupFormat:d.meshBindGroupFormat}},e.extract=function(t){for(var n,i=[],r=[],s=[],a=[],o="@@@\n";null!==(n=iQ.exec(t));){var l=n[1];switch(l){case "attribute":case "varying":case "uniform":case "out":iJ.lastIndex=n.index;var u=iJ.exec(t);"attribute"===l?i.push(u[2]):"varying"===l?r.push(u[2]):"out"===l?s.push(u[2]):"uniform"===l&&a.push(u[2]),t=e.cutOut(t,n.index,iJ.lastIndex,o),iQ.lastIndex=n.index+o.length,o="";}}return {src:t,attributes:i,varyings:r,outs:s,uniforms:a}},e.processUniforms=function(t,n,i,r){var s=[],a=[];n.forEach(function(e){e.isSampler?s.push(e):a.push(e);});var o=[];a.forEach(function(e){if(!i.hasUniform(e.name)){var t=nr.indexOf(e.type),n=new iK(e.name,t,e.arraySize);o.push(n);}}),0===o.length&&o.push(new iK(np,2));var l=o.length?new iZ(t,o):null,u=[];s.forEach(function(e){if(!i.hasTexture(e.name)){var t=0;e.isSignedInt?t=3:e.isUnsignedInt?t=4:("highp"===e.precision&&(t=1),i1.has(e.type)&&(t=2));var n=i2[e.type];u.push(new nP(e.name,3,n,t));}});var c=new nL(t,u),h="";return i.uniformFormats.forEach(function(t,n){t&&(h+=e.getUniformShaderDeclaration(t,n,0));}),l&&(h+=e.getUniformShaderDeclaration(l,2,0)),i.bindGroupFormats.forEach(function(t,n){t&&(h+=e.getTexturesShaderDeclaration(t,n));}),{code:h+=e.getTexturesShaderDeclaration(c,1),meshUniformBufferFormat:l,meshBindGroupFormat:c}},e.processVaryings=function(t,n,i){var r="",s=i?"out":"in";return t.forEach(function(t,a){var o=e.splitToWords(t),l=o.slice(0,-1).join(" "),u=o[o.length-1];i?n.set(u,a):a=n.get(u),r+="layout(location = "+a+") "+s+" "+l+" "+u+";\n";}),r},e.processOuts=function(e){var t="";return e.forEach(function(e,n){t+="layout(location = "+n+") out "+e+";\n";}),t},e.getTypeCount=function(e){var t=parseInt(e.substring(e.length-1),10);return isNaN(t)?1:t},e.processAttributes=function(t,n,i,r){var s="";return t.forEach(function(t){var a=e.splitToWords(t),o=a[0],l=a[1];if(n.hasOwnProperty(l)){var u,c=n[l],h=nS[c];i.set(h,l);var f=r.getVertexElement(c);if(f){var d=f.dataType;if(6!==d&&7!==d&&!f.normalize&&!f.asInt){var p=e.getTypeCount(o),m="_private_"+l;u="vec"+p+" "+l+" = vec"+p+"("+m+");\n",l=m;var _=0===d||2===d||4===d;o=1===p?_?"int":"uint":_?"ivec"+p:"uvec"+p;}}s+="layout(location = "+h+") in "+o+" "+l+";\n",u&&(s+=u);}}),s},e.splitToWords=function(e){return (e=e.replace(/\s+/g," ").trim()).split(" ")},e.cutOut=function(e,t,n,i){return e.substring(0,t)+i+e.substring(n)},e.getUniformShaderDeclaration=function(e,t,n){var i=nf[t],r="layout(set = "+t+", binding = "+n+", std140) uniform ub_"+i+" {\n";return e.uniforms.forEach(function(e){var t=nr[e.type];r+="    "+t+" "+e.shortName+(e.count?"["+e.count+"]":"")+";\n";}),""+r+"};\n"},e.getTexturesShaderDeclaration=function(e,t){var n="";return e.textureFormats.forEach(function(e){var i=i3[e.textureDimension],r="texture2DArray"===i,s=4===e.sampleType?"u":3===e.sampleType?"i":"";i=""+s+i;var a="",o="";r&&(a="_texture",o="#define "+e.name+" "+s+"sampler2DArray("+e.name+a+", "+e.name+"_sampler)\n"),n+="layout(set = "+t+", binding = "+e.slot+") uniform "+i+" "+e.name+a+";\n",e.hasSampler&&(n+="layout(set = "+t+", binding = "+(e.slot+1)+") uniform sampler "+e.name+"_sampler;\n"),n+=o;}),n},e}(),i8=/^[ \t]*(attribute|varying|uniform)[\t ]+/gm,i6=/^[ \t]*(attribute|varying|uniform)[ \t]*([^;]+)(;+)/gm,i9=/^[ \t]*var\s*(?:(<storage,[^>]*>)\s*([\w\d_]+)\s*:\s*(.*?)\s*;|(<(?!storage,)[^>]*>)?\s*([\w\d_]+)\s*:\s*(texture_.*|storage_texture_.*|storage\w.*|external_texture|sampler(?:_comparison)?)\s*;)\s*$/gm,i7=/(?:@interpolate\([^)]*\)\s*)?([\w]+)\s*:/,re=/(@vertex|@fragment)\s*fn\s+\w+\s*\(\s*(\w+)\s*:[\s\S]*?\{/,rt={texture_1d:{viewDimension:"1d",baseSampleType:0},texture_2d:{viewDimension:"2d",baseSampleType:0},texture_2d_array:{viewDimension:t5,baseSampleType:0},texture_3d:{viewDimension:"3d",baseSampleType:0},texture_cube:{viewDimension:t8,baseSampleType:0},texture_cube_array:{viewDimension:t6,baseSampleType:0},texture_multisampled_2d:{viewDimension:"2d",baseSampleType:0},texture_depth_2d:{viewDimension:"2d",baseSampleType:2},texture_depth_2d_array:{viewDimension:t5,baseSampleType:2},texture_depth_cube:{viewDimension:t8,baseSampleType:2},texture_depth_cube_array:{viewDimension:t6,baseSampleType:2},texture_external:{viewDimension:"2d",baseSampleType:1}},rn=function(e,t){var n=rt[e],i=n.baseSampleType;if(0===n.baseSampleType&&"texture_multisampled_2d"!==e)switch(t){case "u32":i=4;break;case "i32":i=3;break;case "f32":i=0;break;case "uff":i=1;}return {viewDimension:n.viewDimension,sampleType:i}},ri=function(e,t){var n,i;if(2===t)switch(e){case "2d":return "texture_depth_2d";case t5:return "texture_depth_2d_array";case t8:return "texture_depth_cube";case t6:return "texture_depth_cube_array"}switch(e){case "1d":n="texture_1d";break;case "2d":n="texture_2d";break;case t5:n="texture_2d_array";break;case "3d":n="texture_3d";break;case t8:n="texture_cube";break;case t6:n="texture_cube_array";}switch(t){case 0:case 1:i="f32";break;case 4:i="u32";break;case 3:i="i32";}return n+"<"+i+">"},rr={f32:"WrappedF32",i32:"WrappedI32",u32:"WrappedU32",vec2f:"WrappedVec2F",vec2i:"WrappedVec2I",vec2u:"WrappedVec2U"},rs=function(e){return (e=e.replace(/\s+/g," ").trim()).split(/[\s:]+/)},ra=/array<([^,]+),\s*([^>]+)>/,ro=function(e,t){this.ubName=null,this.arraySize=0,this.line=e;var n=rs(e);if(n.length<2){t.failed=true;return}if(this.name=n[0],this.type=n.slice(1).join(" "),this.type.includes("array<")){var i=ra.exec(this.type);this.type=i[1].trim(),this.arraySize=Number(i[2]),isNaN(this.arraySize)&&(t.failed=true);}},rl=/^\s*var\s+(\w+)\s*:\s*(texture_\w+)(?:<(\w+)>)?;\s*$/,ru=/^\s*var\s+([\w\d_]+)\s*:\s*(texture_storage_2d|texture_storage_2d_array)<([\w\d_]+),\s*(\w+)>\s*;\s*$/,rc=/^\s*var\s*<storage,\s*(read|write)?>\s*([\w\d_]+)\s*:\s*(.*)\s*;\s*$/,rh=/^\s*var\s+([\w\d_]+)\s*:\s*texture_external;\s*$/,rf=/^\s*var\s+([\w\d_]+)\s*:\s*(sampler|sampler_comparison)\s*;\s*$/,rd=function(){function e(e,t){this.originalLine=e,this.line=e,this.isTexture=false,this.isSampler=false,this.isStorageTexture=false,this.isStorageBuffer=false,this.isExternalTexture=false,this.type="",this.matchedElements=[];var n,i,r,s,a=this.line.match(rl);if(a){this.name=a[1],this.type=a[2],this.textureFormat=a[3],this.isTexture=true,(o=this.matchedElements).push.apply(o,[].concat(a));var o,l=rn(this.type,this.textureFormat);this.textureDimension=l.viewDimension,this.sampleType=l.sampleType;}var u=this.line.match(ru);u&&(this.isStorageTexture=true,this.name=u[1],this.textureType=u[2],this.format=u[3],this.access=u[4],(n=this.matchedElements).push.apply(n,[].concat(u)));var c=this.line.match(rc);c&&(this.isStorageBuffer=true,this.accessMode=c[1]||"none",this.name=c[2],this.type=c[3],(i=this.matchedElements).push.apply(i,[].concat(c)));var h=this.line.match(rh);h&&(this.name=h[1],this.isExternalTexture=true,(r=this.matchedElements).push.apply(r,[].concat(c)));var f=this.line.match(rf);f&&(this.name=f[1],this.samplerType=f[2],this.isSampler=true,(s=this.matchedElements).push.apply(s,[].concat(f))),0===this.matchedElements.length&&(t.failed=true);}return e.prototype.equals=function(e){return this.name===e.name&&this.type===e.type&&this.isTexture===e.isTexture&&this.isSampler===e.isSampler&&this.isStorageTexture===e.isStorageTexture&&this.isStorageBuffer===e.isStorageBuffer&&this.isExternalTexture===e.isExternalTexture&&this.textureFormat===e.textureFormat&&this.textureDimension===e.textureDimension&&this.sampleType===e.sampleType&&this.textureType===e.textureType&&this.format===e.format&&this.access===e.access&&this.accessMode===e.accessMode&&this.samplerType===e.samplerType&&true},e}(),rp=function(){function e(){}return e.run=function(t,n,i){var r=new Map,s=e.extract(n.vshader),a=e.extract(n.fshader),o=new Map,l=e.processAttributes(s.attributes,n.attributes,o,n.processingOptions,i),u=e.processVaryings(s.varyings,r,true),c=e.processVaryings(a.varyings,r,false),h=Array.from(new Set(s.uniforms.concat(a.uniforms))).map(function(e){return new ro(e,i)}),f=e.processUniforms(t,h,n.processingOptions,i);s.src=e.renameUniformAccess(s.src,h),a.src=e.renameUniformAccess(a.src,h);var d=e.mergeResources(s.resources,a.resources,i),p=e.processResources(t,d,n.processingOptions,i),m=e.generateFragmentOutputStruct(a.src,t.maxColorAttachments);s.src=e.copyInputs(s.src,i),a.src=e.copyInputs(a.src,i);var _=l+"\n"+u+"\n"+f.code+"\n"+p.code+"\n",v=s.src.replace("@@@",_),g=c+"\n"+m+"\n"+f.code+"\n"+p.code+"\n";return {vshader:v,fshader:a.src.replace("@@@",g),attributes:o,meshUniformBufferFormat:f.meshUniformBufferFormat,meshBindGroupFormat:p.meshBindGroupFormat}},e.extract=function(t){for(var n,i=[],r=[],s=[],a=[],o="@@@\n";null!==(n=i8.exec(t));){var l=n[1];i6.lastIndex=n.index;var u=i6.exec(t);"attribute"===l?i.push(u[2]):"varying"===l?r.push(u[2]):"uniform"===l&&s.push(u[2]),t=e.cutOut(t,n.index,i6.lastIndex,o),i8.lastIndex=n.index+o.length,o="";}for(;null!==(n=i9.exec(t));)a.push(n[0]),t=e.cutOut(t,n.index,i9.lastIndex,o),i9.lastIndex=n.index+o.length,o="";return {src:t,attributes:i,varyings:r,uniforms:s,resources:a}},e.processUniforms=function(t,n,i,r){var s=[];n.forEach(function(e){if(i.hasUniform(e.name))e.ubName="ub_view";else {e.ubName="ub_mesh_ub";var t=na.get(e.type),n=new iK(e.name,t,e.arraySize);s.push(n);}}),0===s.length&&s.push(new iK(np,2));var a=new iZ(t,s),o="";return i.uniformFormats.forEach(function(t,n){t&&(o+=e.getUniformShaderDeclaration(t,n,0));}),a&&(o+=e.getUniformShaderDeclaration(a,2,0)),{code:o,meshUniformBufferFormat:a}},e.renameUniformAccess=function(e,t){return t.forEach(function(t){var n="uniform."+t.name,i=t.ubName+"."+t.name,r=RegExp("\\b"+n+"\\b","g");e=e.replace(r,i);}),e},e.mergeResources=function(e,t,n){var i=e.map(function(e){return new rd(e,n)});return t.map(function(e){return new rd(e,n)}).forEach(function(e){var t=i.find(function(t){return t.name===e.name});t?t.equals(e)||(n.failed=true):i.push(e);}),i},e.processResources=function(t,n,i,r){for(var s=[],a=0;a<n.length;a++){var o=n[a];if(o.isTexture){var l=n[a+1],u=null==l?void 0:l.isSampler,c=o.sampleType,h=o.textureDimension;s.push(new nP(o.name,3,h,c,u,u?l.name:null)),u&&a++;}if(o.isStorageBuffer){var f="read_write"!==o.accessMode,d=new nC(o.name,3,f);d.format=o.type,s.push(d);}}var p=new nL(t,s),m="";return i.bindGroupFormats.forEach(function(t,n){t&&(m+=e.getTextureShaderDeclaration(t,n,1));}),{code:m+=e.getTextureShaderDeclaration(p,1,0),meshBindGroupFormat:p}},e.getUniformShaderDeclaration=function(e,t,n){var i=nf[t],r="struct_ub_"+i,s="struct "+r+" {\n";return e.uniforms.forEach(function(e){var t=ns[e.type][0];e.count>0?(rr.hasOwnProperty(t)&&(t=rr[t]),s+="    "+e.shortName+": array<"+t+", "+e.count+">,\n"):s+="    "+e.shortName+": "+t+",\n";}),s+="};\n"+("@group("+t+") @binding("+n+") var<uniform> ub_"+i+" : "+r)+";\n\n"},e.getTextureShaderDeclaration=function(e,t,n){var i="",r=n;return e.textureFormats.forEach(function(e){var n=ri(e.textureDimension,e.sampleType);if(i+="@group("+t+") @binding("+r+") var "+e.name+": "+n+";\n",r++,e.hasSampler){var s=2===e.sampleType?"sampler_comparison":"sampler";i+="@group("+t+") @binding("+r+") var "+e.samplerName+": "+s+";\n",r++;}}),e.storageBufferFormats.forEach(function(e){var n=e.readOnly?"read":"read_write";i+="@group("+t+") @binding("+r+") var<storage, "+n+"> "+e.name+" : "+e.format+";\n",r++;}),i},e.processVaryings=function(e,t,n){var i="",r="",s="";e.forEach(function(e,a){var o=e.match(i7);if(o){var l=o[1];n?t.set(l,a):a=t.get(l),i+="    @location("+a+") "+e+",\n",n||(r+="    var<private> "+e+";\n",s+="    "+l+" = input."+l+";\n");}}),n?i+="    @builtin(position) position : vec4f,\n":i+="    @builtin(position) position : vec4f,\n    @builtin(front_facing) frontFacing : bool,\n    @builtin(sample_index) sampleIndex : u32\n";var a=n?"":"\n            var<private> pcPosition: vec4f;\n            var<private> pcFrontFacing: bool;\n            var<private> pcSampleIndex: u32;\n            "+r+"\n            \n            // function to copy inputs (varyings) to private global variables\n            fn _pcCopyInputs(input: FragmentInput) {\n                "+s+"\n                pcPosition = input.position;\n                pcFrontFacing = input.frontFacing;\n                pcSampleIndex = input.sampleIndex;\n            }\n        ";return "\n            struct "+(n?"VertexOutput":"FragmentInput")+" {\n                "+i+"\n            };\n            "+a+"\n        "},e.generateFragmentOutputStruct=function(e,t){for(var n="struct FragmentOutput {\n",i=0;i<t;i++)n+="    @location("+i+") color"+(i>0?i:"")+" : pcOutType"+i+",\n";return -1!==e.search(/\.fragDepth\s*=/)&&(n+="    @builtin(frag_depth) fragDepth : f32\n"),""+n+"};\n"},e.floatAttributeToInt=function(e,t){return ({f32:t?"i32":"u32",vec2f:t?"vec2i":"vec2u",vec3f:t?"vec3i":"vec3u",vec4f:t?"vec4i":"vec4u"})[({f32:"f32","vec2<f32>":"vec2f","vec3<f32>":"vec3f","vec4<f32>":"vec4f"})[e]||e]||null},e.processAttributes=function(t,n,i,r,s){ void 0===n&&(n={});var a="",o="",l="";return t.forEach(function(t){var s=rs(t),u=s[0],c=s[1],h=c;if(n.hasOwnProperty(u)){var f=n[u],d=nS[f];i.set(d,u);var p=r.getVertexElement(f);if(p){var m=p.dataType;6===m||7===m||p.normalize||p.asInt||(c=e.floatAttributeToInt(c,0===m||2===m||4===m));}a+="    @location("+d+") "+u+": "+c+",\n",o+="    var<private> "+t+";\n",l+="    "+u+" = "+h+"(input."+u+");\n";}}),"\n            struct VertexInput {\n                "+a+"\n                @builtin(vertex_index) vertexIndex : u32,       // built-in vertex index\n                @builtin(instance_index) instanceIndex : u32    // built-in instance index\n            };\n\n            "+o+"\n            var<private> pcVertexIndex: u32;\n            var<private> pcInstanceIndex: u32;\n\n            fn _pcCopyInputs(input: VertexInput) {\n                "+l+"\n                pcVertexIndex = input.vertexIndex;\n                pcInstanceIndex = input.instanceIndex;\n            }\n        "},e.copyInputs=function(e,t){var n=e.match(re);if(!n||!n[2])return e;var i=n[2],r=n.index+n[0].length-1;return e.slice(0,r+1)+"\n    _pcCopyInputs("+i+");"+e.slice(r+1)},e.cutOut=function(e,t,n,i){return e.substring(0,t)+i+e.substring(n)},e}(),rm=function(){function e(e){this._vertexCode=null,this._fragmentCode=null,this._computeCode=null,this.vertexEntryPoint="main",this.fragmentEntryPoint="main",this.computeEntryPoint="main",this.shader=e;var t,n,i,r=e.definition;r.shaderLanguage===ni?(r.cshader?(this._computeCode=null!=(t=r.cshader)?t:null,this.computeUniformBufferFormats=r.computeUniformBufferFormats,this.computeBindGroupFormat=r.computeBindGroupFormat):(this.vertexEntryPoint="vertexMain",this.fragmentEntryPoint="fragmentMain",r.processingOptions?this.processWGSL():(this._vertexCode=null!=(n=r.vshader)?n:null,this._fragmentCode=null!=(i=r.fshader)?i:null,e.meshUniformBufferFormat=r.meshUniformBufferFormat,e.meshBindGroupFormat=r.meshBindGroupFormat)),e.ready=true):r.processingOptions&&this.processGLSL();}var t,n=e.prototype;return n.destroy=function(e){this._vertexCode=null,this._fragmentCode=null;},n.createShaderModule=function(e,t){return this.shader.device.wgpu.createShaderModule({code:e})},n.getVertexShaderModule=function(){return this.createShaderModule(this._vertexCode,"Vertex")},n.getFragmentShaderModule=function(){return this.createShaderModule(this._fragmentCode,"Fragment")},n.getComputeShaderModule=function(){return this.createShaderModule(this._computeCode,"Compute")},n.processGLSL=function(){var e=this.shader,t=i5.run(e.device,e.definition,e);this._vertexCode=this.transpile(t.vshader,"vertex",e.definition.vshader),this._fragmentCode=this.transpile(t.fshader,"fragment",e.definition.fshader),this._vertexCode&&this._fragmentCode?e.ready=true:e.failed=true,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat,e.attributes=t.attributes;},n.processWGSL=function(){var e=this.shader,t=rp.run(e.device,e.definition,e);this._vertexCode=t.vshader,this._fragmentCode=t.fshader,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat,e.attributes=t.attributes;},n.transpile=function(e,t,n){var i=this.shader.device;if(!i.glslang||!i.twgsl)return null;try{var r=i.glslang.compileGLSL(e,t);return i.twgsl.convertSpirV2WGSL(r)}catch(e){}},n.loseContext=function(){},n.restoreContext=function(e,t){},t=[{key:"vertexCode",get:function(){return this._vertexCode}},{key:"fragmentCode",get:function(){return this._fragmentCode}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function r_(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}var rv=[];rv[0]="repeat",rv[1]="clamp-to-edge",rv[2]="mirror-repeat";var rg=[];rg[0]={level:"nearest",mip:"nearest"},rg[1]={level:"linear",mip:"nearest"},rg[2]={level:"nearest",mip:"nearest"},rg[3]={level:"nearest",mip:"linear"},rg[4]={level:"linear",mip:"nearest"},rg[5]={level:"linear",mip:"linear"};var ry=function(e){},rS=function(){function e(e){this.samplers=[],this.texture=e,this.format=ih[e.format],this.create(e.device);}var t=e.prototype;return t.create=function(e){var t,n=this.texture,i=e.wgpu,r=n.numLevels;this.desc={size:{width:n.width,height:n.height,depthOrArrayLayers:n.cubemap?6:n.array?n.arrayLength:1},format:this.format,mipLevelCount:r,sampleCount:1,dimension:n.volume?"3d":"2d",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC|(t_(n.format)?0:GPUTextureUsage.RENDER_ATTACHMENT)|(n.storage?GPUTextureUsage.STORAGE_BINDING:0)},this.gpuTexture=i.createTexture(this.desc),17===this.texture.format&&(t={format:"depth24plus",aspect:"depth-only"}),this.view=this.createView(t);},t.destroy=function(e){},t.propertyChanged=function(e){this.samplers.length=0;},t.getView=function(e){return this.uploadImmediate(e,this.texture),this.view},t.createView=function(e){var t,n,i,r,s,a,o,l=null!=e?e:{},u=this.desc,c=this.texture,h={format:null!=(t=l.format)?t:u.format,dimension:null!=(n=l.dimension)?n:c.cubemap?"cube":c.volume?"3d":c.array?"2d-array":"2d",aspect:null!=(i=l.aspect)?i:"all",baseMipLevel:null!=(r=l.baseMipLevel)?r:0,mipLevelCount:null!=(s=l.mipLevelCount)?s:u.mipLevelCount,baseArrayLayer:null!=(a=l.baseArrayLayer)?a:0,arrayLayerCount:null!=(o=l.arrayLayerCount)?o:u.depthOrArrayLayers};return this.gpuTexture.createView(h)},t.getSampler=function(e,t){var n=this.samplers[t];if(!n){var i=this.texture,r={addressModeU:rv[i.addressU],addressModeV:rv[i.addressV],addressModeW:rv[i.addressW]};!t&&i.compareOnRead&&(t=2),2===t||3===t||4===t?(r.compare="less",r.magFilter="linear",r.minFilter="linear"):1===t||!e.textureFloatFilterable&&(14===i.format||12===i.format)||17===this.texture.format||tg(this.texture.format)?(r.magFilter="nearest",r.minFilter="nearest",r.mipmapFilter="nearest"):(r.magFilter=rg[i.magFilter].level,r.minFilter=rg[i.minFilter].level,r.mipmapFilter=rg[i.minFilter].mip);var s="linear"===r.minFilter&&"linear"===r.magFilter&&"linear"===r.mipmapFilter;r.maxAnisotropy=s?ek.clamp(Math.round(i._anisotropy),1,e.maxTextureAnisotropy):1,n=e.wgpu.createSampler(r),this.samplers[t]=n;}return n},t.loseContext=function(){},t.uploadImmediate=function(e,t){(t._needsUpload||t._needsMipmapsUpload)&&(this.uploadData(e),t._needsUpload=false,t._needsMipmapsUpload=false);},t.uploadData=function(e){var t=this.texture;if(t._levels){for(var n=false,i=false,r=t.numLevels,s=0;s<r;s++){var a=t._levels[s];if(a)if(t.cubemap)for(var o=0;o<6;o++){var l=a[o];l?this.isExternalImage(l)?(this.uploadExternalImage(e,l,s,o),n=true):ArrayBuffer.isView(l)&&(this.uploadTypedArrayData(e,l,s,o),n=true):i=true;}else if(t._volume);else if(t.array)if(t.arrayLength===a.length)for(var u=0;u<t._arrayLength;u++){var c=a[u];this.isExternalImage(c)?(this.uploadExternalImage(e,c,s,u),n=true):ArrayBuffer.isView(c)&&(this.uploadTypedArrayData(e,c,s,u),n=true);}else i=true;else this.isExternalImage(a)?(this.uploadExternalImage(e,a,s,0),n=true):ArrayBuffer.isView(a)&&(this.uploadTypedArrayData(e,a,s,0),n=true);else i=true;}n&&i&&t.mipmaps&&!t_(t.format)&&!tg(t.format)&&e.mipmapRenderer.generate(this),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize);}},t.isExternalImage=function(e){return "undefined"!=typeof ImageBitmap&&r_(e,ImageBitmap)||"undefined"!=typeof HTMLVideoElement&&r_(e,HTMLVideoElement)||"undefined"!=typeof HTMLCanvasElement&&r_(e,HTMLCanvasElement)||"undefined"!=typeof OffscreenCanvas&&r_(e,OffscreenCanvas)},t.uploadExternalImage=function(e,t,n,i){var r={texture:this.gpuTexture,mipLevel:n,origin:[0,0,i],aspect:"all"},s={width:this.desc.size.width,height:this.desc.size.height,depthOrArrayLayers:1};e.submit(),ry(r_(t,HTMLCanvasElement)&&t.getContext("2d")),e.wgpu.queue.copyExternalImageToTexture({source:t,origin:[0,0],flipY:false},r,s);},t.uploadTypedArrayData=function(e,t,n,i){var r,s,a=this.texture,o=e.wgpu,l={texture:this.gpuTexture,origin:[0,0,i],mipLevel:n},u=nM.calcLevelDimension(a.width,n),c=nM.calcLevelDimension(a.height,n);nM.calcLevelGpuSize(u,c,1,a.format);var h=tm.get(a.format);if(h.size)r={offset:0,bytesPerRow:h.size*u,rowsPerImage:c},s={width:u,height:c};else if(h.blockSize){var f=function(e){return Math.floor((e+3)/4)};r={offset:0,bytesPerRow:h.blockSize*f(u),rowsPerImage:f(c)},s={width:Math.max(4,u),height:Math.max(4,c)};}e.submit(),o.queue.writeTexture(l,t,r,s);},t.read=function(e,t,n,i,r){var s,a,o,l,u=null!=(s=r.mipLevel)?s:0,c=null!=(a=r.face)?a:0,h=null!=(o=r.data)?o:null,f=null!=(l=r.immediate)&&l,d=this.texture,p=n*tm.get(d.format).size,m=ek.roundUp(p,256),_=m*i,v=d.device,g=v.createBufferImpl(9);g.allocate(v,_);var y={texture:this.gpuTexture,mipLevel:u,origin:[e,t,c]},S={buffer:g.buffer,offset:0,bytesPerRow:m};return v.getCommandEncoder().copyTextureToBuffer(y,S,{width:n,height:i,depthOrArrayLayers:1}),v.readBuffer(g,_,null,f).then(function(e){for(var t,n=(null==h?void 0:h.constructor)===Uint8Array?h:new Uint8Array(null!=(t=null==h?void 0:h.buffer)?t:i*p),r=0;r<i;r++){var s=r*m,a=r*p,o=e.subarray(s,s+p);n.set(o,a);}return null!=h?h:n})},e}();function rx(e,t){return (rx=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var rb=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){return e.call(this,64)||this}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&rx(t,e),t.prototype.unlock=function(t){var n=t.device;e.prototype.unlock.call(this,n,t.storageInt32.buffer);},t}(iv);function rT(e,t){return (rT=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var rE=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i){return e.call(this,32|128*(null!=i&&!!i.storage))||this}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&rT(t,e),t.prototype.unlock=function(t){var n=t.device;e.prototype.unlock.call(this,n,t.storage);},t}(iv);function rw(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function rA(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return rw(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return rw(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var rC=/[ \t]*#(ifn?def|if|endif|else|elif|define|undef|extension|include)/g,rP=/define[ \t]+([^\n]+)\r?(?:\n|$)/g,rI=/extension[ \t]+([\w-]+)[ \t]*:[ \t]*(enable|require)/g,rL=/undef[ \t]+([^\n]+)\r?(?:\n|$)/g,rD=/(ifdef|ifndef|if)[ \t]*([^\r\n]+)\r?\n/g,rM=/(endif|else|elif)(?:[ \t]+([^\r\n]*))?\r?\n?/g,rR=/\{?[\w-]+\}?/,rO=/(!|\s)?defined\(([\w-]+)\)/,rk=/!?defined\s*\([^)]*\)/g,rN=/!?defined\s*$/,rF=/([a-z_]\w*)\s*(==|!=|<|<=|>|>=)\s*([\w"']+)/i,rB=/[+\-]/g,rU=/include[ \t]+"([\w-]+)(?:\s*,\s*([\w-]+))?"/g,rz=/\{i\}/g,rV=/(pcFragColor[1-8])\b/g,rG=function(){function e(){}return e.run=function(t,n,i){ void 0===n&&(n=new Map),void 0===i&&(i={}),e.sourceName=i.sourceName,t=(t=this.stripComments(t)).split(/\r?\n/).map(function(e){return e.trimEnd()}).join("\n");var r=new Map,s=new Map;if(null===(t=this._preprocess(t,r,s,n,i.stripDefines)))return null;var a=new Map;return r.forEach(function(e,t){Number.isInteger(parseFloat(e))&&!e.includes(".")&&a.set(t,e);}),t=this.stripComments(t),t=this.stripUnusedColorAttachments(t,i),t=this.RemoveEmptyLines(t),t=this.processArraySize(t,a),t=this.injectDefines(t,s)},e.stripUnusedColorAttachments=function(e,t){if(t.stripUnusedColorAttachments){var n=new Map,i=e.match(rV);if(null==i||i.forEach(function(e){var t,i=parseInt(e.charAt(e.length-1),10);n.set(i,(null!=(t=n.get(i))?t:0)+1);}),Array.from(n.values()).some(function(e){return 1===e})){for(var r=e.split("\n"),s=[],a=0;a<r.length;a++){var o=r[a].match(rV);if(o){var l=parseInt(o[0].charAt(o[0].length-1),10);if(l>0&&1===n.get(l))continue}s.push(r[a]);}e=s.join("\n");}}return e},e.stripComments=function(e){return e.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1")},e.processArraySize=function(e,t){return null!==e&&t.forEach(function(t,n){e=e.replace(RegExp("\\["+n+"\\]","g"),"["+t+"]");}),e},e.injectDefines=function(e,t){if(null!==e&&t.size>0){var n=e.split("\n");t.forEach(function(e,t){for(var i=RegExp(t,"g"),r=0;r<n.length;r++)n[r].includes("#")||(n[r]=n[r].replace(i,e));}),e=n.join("\n");}return e},e.RemoveEmptyLines=function(e){return null!==e&&(e=(e=e.split(/\r?\n/).map(function(e){return ""===e.trim()?"":e}).join("\n")).replace(/(\n\n){3,}/g,"\n\n")),e},e._preprocess=function(t,n,i,r,s){ void 0===n&&(n=new Map);for(var a=[],o=false;null!==(L=rC.exec(t))&&!o;){var l=L[1];switch(l){case "define":rP.lastIndex=L.index;var u=rP.exec(t);o||(o=null===u);var c=u[1];rR.lastIndex=u.index;var h=rR.exec(c)[0],f=c.substring(h.length).trim();""===f&&(f="true");var d=e._keep(a),p=s;if(d){var m=h.startsWith("{")&&h.endsWith("}");m&&(p=true),m?i.set(h,f):n.set(h,f),p&&(t=t.substring(0,u.index-1)+t.substring(rP.lastIndex),rC.lastIndex=u.index-1);}p||(rC.lastIndex=u.index+u[0].length);break;case "undef":rL.lastIndex=L.index;var _=rL.exec(t),v=_[1].trim();e._keep(a)&&(n.delete(v),s&&(t=t.substring(0,_.index-1)+t.substring(rL.lastIndex),rC.lastIndex=_.index-1)),s||(rC.lastIndex=_.index+_[0].length);break;case "extension":rI.lastIndex=L.index;var g=rI.exec(t);if(o||(o=null===g),g){var y=g[1];e._keep(a)&&n.set(y,"true");}rC.lastIndex=g.index+g[0].length;break;case "ifdef":case "ifndef":case "if":rD.lastIndex=L.index;var S=rD.exec(t),x=S[2],b=e.evaluate(x,n);o||(o=b.error);var T=b.result;"ifndef"===l&&(T=!T),a.push({anyKeep:T,keep:T,start:L.index,end:rD.lastIndex}),rC.lastIndex=S.index+S[0].length;break;case "endif":case "else":case "elif":rM.lastIndex=L.index;var E=rM.exec(t),w=a.pop();if(!w){o=true;continue}var A=w.keep?t.substring(w.end,L.index):"";t=t.substring(0,w.start)+A+t.substring(rM.lastIndex),rC.lastIndex=w.start+A.length;var C=E[1];if("else"===C||"elif"===C){var P=false;if(!w.anyKeep)if("else"===C)P=!w.keep;else {var I=e.evaluate(E[2],n);P=I.result,o||(o=I.error);}a.push({anyKeep:w.anyKeep||P,keep:P,start:rC.lastIndex,end:rC.lastIndex});}break;case "include":rU.lastIndex=L.index;var L,D,M=rU.exec(t);if(o||(o=null===M),!M){o=true;continue}var R=M[1].trim(),O=null==(D=M[2])?void 0:D.trim();if(e._keep(a)){var k=null==r?void 0:r.get(R);if(void 0!==k){if(k=this.stripComments(k),O){var N=parseFloat(n.get(O));if(Number.isInteger(N)){for(var F="",B=0;B<N;B++)F+=k.replace(rz,String(B));k=F;}else o=true;}t=t.substring(0,M.index-1)+k+t.substring(rU.lastIndex),rC.lastIndex=M.index-1;}else {o=true;continue}}}}return (a.length>0&&(o=true),o)?null:t},e._keep=function(e){for(var t=0;t<e.length;t++)if(!e[t].keep)return  false;return  true},e.evaluateAtomicExpression=function(e,t){var n=false;e=e.trim();var i=false;if("true"===e)return {result:true,error:n};if("false"===e)return {result:false,error:n};var r=rO.exec(e);if(r){i="!"===r[1],e=r[2].trim();var s=t.has(e);return {result:i?!s:s,error:n}}var a=rF.exec(e);if(a){var o,l,u=null!=(o=t.get(a[1].trim()))?o:a[1].trim(),c=null!=(l=t.get(a[3].trim()))?l:a[3].trim(),h=a[2].trim(),f=false;switch(h){case "==":f=u===c;break;case "!=":f=u!==c;break;case "<":f=u<c;break;case "<=":f=u<=c;break;case ">":f=u>c;break;case ">=":f=u>=c;break;default:n=true;}return {result:f,error:n}}return {result:t.has(e),error:n}},e.processParentheses=function(t,n){for(var i=false,r=t.trim();r.startsWith("(")&&r.endsWith(")");){for(var s=0,a=true,o=0;o<r.length-1;o++)if("("===r[o])s++;else if(")"===r[o]&&0==--s){a=false;break}if(a)r=r.slice(1,-1).trim();else break}for(;;){for(var l=false,u=0,c=0,h=-1,f=-1,d=0,p=0;p<r.length;p++)if("("===r[p]){var m=r.substring(0,p);rN.test(m)?d++:0===d&&(++u>c&&(c=u,h=p),l=true);}else ")"===r[p]&&(d>0?d--:u>0&&(u===c&&-1!==h&&(f=p),u--));if(!l||-1===h||-1===f)break;var _=r.substring(h+1,f),v=e.evaluate(_,n),g=v.result,y=v.error;i=i||y,r=r.substring(0,h)+(g?"true":"false")+r.substring(f+1);}return {expression:r,error:i}},e.evaluate=function(t,n){var i=null===rB.exec(t),r=t,s=false;if(-1!==t.replace(rk,"").indexOf("(")){var a=e.processParentheses(t,n);r=a.expression,s=a.error;}if(s)return {result:false,error:true};for(var o,l=r.split("||"),u=rA(l);!(o=u()).done;){for(var c,h=o.value.split("&&"),f=true,d=rA(h);!(c=d()).done;){var p=c.value,m=e.evaluateAtomicExpression(p.trim(),n),_=m.result,v=m.error;if(!_||v){f=false;break}}if(f)return {result:true,error:!i}}return {result:false,error:!i}},e}(),rH="\n#ifndef outType_0\n#define outType_0 vec4\n#endif\nlayout(location = 0) out highp outType_0 pcFragColor0;\n#if COLOR_ATTACHMENT_1\nlayout(location = 1) out highp outType_1 pcFragColor1;\n#endif\n#if COLOR_ATTACHMENT_2\nlayout(location = 2) out highp outType_2 pcFragColor2;\n#endif\n#if COLOR_ATTACHMENT_3\nlayout(location = 3) out highp outType_3 pcFragColor3;\n#endif\n#if COLOR_ATTACHMENT_4\nlayout(location = 4) out highp outType_4 pcFragColor4;\n#endif\n#if COLOR_ATTACHMENT_5\nlayout(location = 5) out highp outType_5 pcFragColor5;\n#endif\n#if COLOR_ATTACHMENT_6\nlayout(location = 6) out highp outType_6 pcFragColor6;\n#endif\n#if COLOR_ATTACHMENT_7\nlayout(location = 7) out highp outType_7 pcFragColor7;\n#endif\n#define gl_FragColor pcFragColor0\n#define varying in\n#define texture2D texture\n#define texture2DBias texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLod textureLod\n#define texture2DProjLod textureProjLod\n#define textureCubeLod textureLod\n#define texture2DGrad textureGrad\n#define texture2DProjGrad textureProjGrad\n#define textureCubeGrad textureGrad\n#define utexture2D texture\n#define itexture2D texture\n#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead\n#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod\n#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead\n#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead\n#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead\n#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead\n#define textureShadow(res, uv) textureGrad(res, uv, vec2(1, 1), vec2(1, 1))\n#define SHADOWMAP_PASS(name) name\n#define SHADOWMAP_ACCEPT(name) sampler2DShadow name\n#define TEXTURE_PASS(name) name\n#define TEXTURE_ACCEPT(name) sampler2D name\n#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name\n#define GL2\n",rW="\n#define attribute in\n#define varying out\n#define texture2D texture\n#define utexture2D texture\n#define itexture2D texture\n#define GL2\n#define VERTEXSHADER\n#define TEXTURE_PASS(name) name\n#define TEXTURE_ACCEPT(name) sampler2D name\n#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name\n",rj="\n#extension GL_EXT_samplerless_texture_functions : require\n#ifndef outType_0\n#define outType_0 vec4\n#endif\n#ifndef outType_1\n#define outType_1 vec4\n#endif\n#ifndef outType_2\n#define outType_2 vec4\n#endif\n#ifndef outType_3\n#define outType_3 vec4\n#endif\n#ifndef outType_4\n#define outType_4 vec4\n#endif\n#ifndef outType_5\n#define outType_5 vec4\n#endif\n#ifndef outType_6\n#define outType_6 vec4\n#endif\n#ifndef outType_7\n#define outType_7 vec4\n#endif\nlayout(location = 0) out highp outType_0 pcFragColor0;\nlayout(location = 1) out highp outType_1 pcFragColor1;\nlayout(location = 2) out highp outType_2 pcFragColor2;\nlayout(location = 3) out highp outType_3 pcFragColor3;\nlayout(location = 4) out highp outType_4 pcFragColor4;\nlayout(location = 5) out highp outType_5 pcFragColor5;\nlayout(location = 6) out highp outType_6 pcFragColor6;\nlayout(location = 7) out highp outType_7 pcFragColor7;\n#define gl_FragColor pcFragColor0\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n#define texture2DBias(res, uv, bias) texture(sampler2D(res, res ## _sampler), uv, bias)\n#define texture2DLod(res, uv, lod) textureLod(sampler2D(res, res ## _sampler), uv, lod)\n#define textureCube(res, uv) texture(samplerCube(res, res ## _sampler), uv)\n#define textureCubeLod(res, uv, lod) textureLod(samplerCube(res, res ## _sampler), uv, lod)\n#define textureShadow(res, uv) textureLod(sampler2DShadow(res, res ## _sampler), uv, 0.0)\n#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)\n#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)\n#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead\n#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod\n#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead\n#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead\n#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead\n#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead\n#define SHADOWMAP_PASS(name) name, name ## _sampler\n#define SHADOWMAP_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_PASS(name) name, name ## _sampler\n#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT\n#define GL2\n#define WEBGPU\n",rX="\n#extension GL_EXT_samplerless_texture_functions : require\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)\n#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)\n#define TEXTURE_PASS(name) name, name ## _sampler\n#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT\n#define GL2\n#define WEBGPU\n#define VERTEXSHADER\n#define gl_VertexID gl_VertexIndex\n#define gl_InstanceID gl_InstanceIndex\n",rY="\n#define VERTEXSHADER\n",rq="\nvec2 getGrabScreenPos(vec4 clipPos) {\n	vec2 uv = (clipPos.xy / clipPos.w) * 0.5 + 0.5;\n	#ifdef WEBGPU\n		uv.y = 1.0 - uv.y;\n	#endif\n	return uv;\n}\nvec2 getImageEffectUV(vec2 uv) {\n	#ifdef WEBGPU\n		uv.y = 1.0 - uv.y;\n	#endif\n	return uv;\n}\n",rK="\nfn getGrabScreenPos(clipPos: vec4<f32>) -> vec2<f32> {\n	var uv: vec2<f32> = (clipPos.xy / clipPos.w) * 0.5 + vec2<f32>(0.5);\n	uv.y = 1.0 - uv.y;\n	return uv;\n}\nfn getImageEffectUV(uv: vec2<f32>) -> vec2<f32> {\n	var modifiedUV: vec2<f32> = uv;\n	modifiedUV.y = 1.0 - modifiedUV.y;\n	return modifiedUV;\n}\nstruct WrappedF32 { @size(16) element: f32 }\nstruct WrappedI32 { @size(16) element: i32 }\nstruct WrappedU32 { @size(16) element: u32 }\nstruct WrappedVec2F { @size(16) element: vec2f }\nstruct WrappedVec2I { @size(16) element: vec2i }\nstruct WrappedVec2U { @size(16) element: vec2u }\n",rZ={vertex_position:tT,vertex_normal:tE,vertex_tangent:tw,vertex_texCoord0:tL,vertex_texCoord1:tD,vertex_texCoord2:tM,vertex_texCoord3:tR,vertex_texCoord4:tO,vertex_texCoord5:tk,vertex_texCoord6:tN,vertex_texCoord7:tF,vertex_color:tP,vertex_boneIndices:tC,vertex_boneWeights:tA},rQ=function(){function e(){}return e.createDefinition=function(t,n){var i,r,s,a,o=function(e){var t,n=null!=(t=e.fragmentOutputTypes)?t:"vec4";return Array.isArray(n)||(n=[n]),n},l=function(e,n,i,r){var s=t.isWebGPU?e:n,a="";if(!i)for(var l=o(r),u=0;u<t.maxColorAttachments;u++){a+="#define COLOR_ATTACHMENT_"+u+"\n";var c,h=null!=(c=l[u])?c:"vec4";a+="#define outType_"+u+" "+h+"\n";}return a+s},u=function(e,n){var i="";if(!e)for(var r=o(n),s=0;s<t.maxColorAttachments;s++){var a,l=null!=(a=r[s])?a:"vec4";i+="alias pcOutType"+s+" = "+ny.get(l)+";\n";}return i},c=null!=(i=n.name)?i:"Untitled",h=e.getDefinesCode(t,n.vertexDefines),f=e.getDefinesCode(t,n.fragmentDefines);return n.shaderLanguage===ni?(r="\n                "+u(true,n)+"\n                "+rY+"\n                "+rK+"\n                "+h+"\n                "+n.vertexCode+"\n            ",s="\n                "+u(false,n)+"\n                \n\n                "+rK+"\n                "+f+"\n                "+n.fragmentCode+"\n            "):(r=e.versionCode(t)+l(rX,rW,true,n)+h+e.precisionCode(t)+"\n                "+rq+"\n                "+e.getShaderNameCode(c)+"\n                "+n.vertexCode,s=(n.fragmentPreamble||"")+e.versionCode(t)+l(rj,rH,false,n)+f+e.precisionCode(t)+"\n                "+rq+"\n                "+e.getShaderNameCode(c)+"\n                "+n.fragmentCode),{name:c,shaderLanguage:null!=(a=n.shaderLanguage)?a:nn,attributes:n.attributes,vshader:r,vincludes:n.vertexIncludes,fincludes:n.fragmentIncludes,fshader:s,useTransformFeedback:n.useTransformFeedback,meshUniformBufferFormat:n.meshUniformBufferFormat,meshBindGroupFormat:n.meshBindGroupFormat}},e.getDefinesCode=function(e,t){var n="";return e.capsDefines.forEach(function(e,t){n+="#define "+t+" "+e+"\n";}),n+="\n",null==t||t.forEach(function(e,t){n+="#define "+t+" "+e+"\n";}),n+="\n"},e.getShaderNameCode=function(e){return "#define SHADER_NAME "+e+"\n"},e.versionCode=function(e){return e.isWebGPU?"#version 450\n":"#version 300 es\n"},e.precisionCode=function(e,t){t&&"highp"!==t&&"mediump"!==t&&"lowp"!==t&&(t=null),t&&("highp"===t&&"highp"!==e.maxPrecision&&(t="mediump"),"mediump"===t&&"lowp"===e.maxPrecision&&(t="lowp"));var n=t||e.precision;return "\n            precision "+n+" float;\n            precision "+n+" int;\n            precision "+n+" usampler2D;\n            precision "+n+" isampler2D;\n            precision "+n+" sampler2DShadow;\n            precision "+n+" samplerCubeShadow;\n            precision "+n+" sampler2DArray;\n        "},e.collectAttributes=function(e){for(var t={},n=0,i=e.indexOf("attribute");i>=0&&(!(i>0)||"/"!==e[i-1]);){var r=false;if(i>0){var s=e.lastIndexOf("\n",i);s=-1!==s?s+1:0,e.substring(s,i).includes("#")&&(r=true);}if(!r){var a=e.indexOf(";",i),o=e.lastIndexOf(" ",a),l=e.substring(o+1,a);if(t[l]);else {var u=rZ[l];void 0!==u?t[l]=u:(t[l]="ATTR"+n,n++);}}i=e.indexOf("attribute",i+1);}return t},e}(),rJ=0,r$=function(){function e(e,t){if(this.attributes=new Map,this.id=rJ++,this.device=e,this.definition=t,this.name=t.name||"Untitled",this.init(),t.cshader)t.cshader=rG.run(t.cshader,t.cincludes,{sourceName:"compute shader for "+this.label,stripDefines:true});else {var n=t.shaderLanguage===ni;t.vshader=rG.run(t.vshader,t.vincludes,{sourceName:"vertex shader for "+this.label,stripDefines:n}),t.shaderLanguage===nn&&(null!=t.attributes||(t.attributes=rQ.collectAttributes(t.vshader)));var i=e.isWebGL2&&("osx"===ef.name||"ios"===ef.name);if(t.fshader=rG.run(t.fshader,t.fincludes,{stripUnusedColorAttachments:i,stripDefines:n,sourceName:"fragment shader for "+this.label}),!t.vshader||!t.fshader){this.failed=true;return}}this.impl=e.createShaderImpl(this);}var t,n=e.prototype;return n.init=function(){this.ready=false,this.failed=false;},n.destroy=function(){this.device.onDestroyShader(this),this.impl.destroy(this);},n.loseContext=function(){this.init(),this.impl.loseContext();},n.restoreContext=function(){this.impl.restoreContext(this.device,this);},t=[{key:"label",get:function(){return "Shader Id "+this.id+" ("+(this.definition.shaderLanguage===ni?"WGSL":"GLSL")+") "+this.name}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),r0=function(){},r1=function(){},r2=function(){function e(e,t,n){this.gpuBuffers=[],this.stagingBuffers=[],this.usedBuffers=[],this.activeBuffer=null,this.device=e,this.bufferSize=t,this.bufferAlignment=n;}var t=e.prototype;return t.destroy=function(){var e=this;this.gpuBuffers.forEach(function(t){t.destroy(e.device);}),this.gpuBuffers=null,this.stagingBuffers.forEach(function(t){t.destroy(e.device);}),this.stagingBuffers=null,this.usedBuffers=null,this.activeBuffer=null;},t.alloc=function(e,t){if(this.activeBuffer){var n=ek.roundUp(this.activeBuffer.size,this.bufferAlignment);this.bufferSize-n<t&&this.scheduleSubmit();}if(!this.activeBuffer){var i=this.gpuBuffers.pop();i||(i=this.createBuffer(this.device,this.bufferSize,false));var r=this.stagingBuffers.pop();r||(r=this.createBuffer(this.device,this.bufferSize,true)),this.activeBuffer=new r0,this.activeBuffer.stagingBuffer=r,this.activeBuffer.gpuBuffer=i,this.activeBuffer.offset=0,this.activeBuffer.size=0;}var s=this.activeBuffer,a=ek.roundUp(s.size,this.bufferAlignment);e.gpuBuffer=s.gpuBuffer,e.offset=a,e.storage=s.stagingBuffer.alloc(a,t),s.size=a+t;},t.scheduleSubmit=function(){this.activeBuffer&&(this.usedBuffers.push(this.activeBuffer),this.activeBuffer=null);},t.submit=function(){this.scheduleSubmit();},e}(),r3=[];r3[2]=function(e,t,n){e.storageFloat32[n]=t;},r3[3]=function(e,t,n){var i=e.storageFloat32;i[n]=t[0],i[n+1]=t[1];},r3[4]=function(e,t,n){var i=e.storageFloat32;i[n]=t[0],i[n+1]=t[1],i[n+2]=t[2];},r3[5]=function(e,t,n){var i=e.storageFloat32;i[n]=t[0],i[n+1]=t[1],i[n+2]=t[2],i[n+3]=t[3];},r3[1]=function(e,t,n){e.storageInt32[n]=t;},r3[6]=function(e,t,n){var i=e.storageInt32;i[n]=t[0],i[n+1]=t[1];},r3[7]=function(e,t,n){var i=e.storageInt32;i[n]=t[0],i[n+1]=t[1],i[n+2]=t[2];},r3[8]=function(e,t,n){var i=e.storageInt32;i[n]=t[0],i[n+1]=t[1],i[n+2]=t[2],i[n+3]=t[3];},r3[12]=function(e,t,n){var i=e.storageFloat32;i[n]=t[0],i[n+1]=t[1],i[n+4]=t[2],i[n+5]=t[3],i[n+8]=t[4],i[n+9]=t[5];},r3[13]=function(e,t,n){var i=e.storageFloat32;i[n]=t[0],i[n+1]=t[1],i[n+2]=t[2],i[n+4]=t[3],i[n+5]=t[4],i[n+6]=t[5],i[n+8]=t[6],i[n+9]=t[7],i[n+10]=t[8];},r3[17]=function(e,t,n,i){for(var r=e.storageFloat32,s=0;s<i;s++)r[n+4*s]=t[s];},r3[21]=function(e,t,n,i){for(var r=e.storageFloat32,s=0;s<i;s++)r[n+4*s]=t[2*s],r[n+4*s+1]=t[2*s+1];},r3[22]=function(e,t,n,i){for(var r=e.storageFloat32,s=0;s<i;s++)r[n+4*s]=t[3*s],r[n+4*s+1]=t[3*s+1],r[n+4*s+2]=t[3*s+2];},r3[26]=function(e,t,n,i){e.storageUint32[n]=t;},r3[27]=function(e,t,n,i){var r=e.storageUint32;r[n]=t[0],r[n+1]=t[1];},r3[28]=function(e,t,n,i){var r=e.storageUint32;r[n]=t[0],r[n+1]=t[1],r[n+2]=t[2];},r3[29]=function(e,t,n,i){var r=e.storageUint32;r[n]=t[0],r[n+1]=t[1],r[n+2]=t[2],r[n+3]=t[3];},r3[30]=function(e,t,n,i){for(var r=e.storageInt32,s=0;s<i;s++)r[n+4*s]=t[s];},r3[32]=r3[30],r3[31]=function(e,t,n,i){for(var r=e.storageUint32,s=0;s<i;s++)r[n+4*s]=t[s];},r3[33]=function(e,t,n,i){for(var r=e.storageInt32,s=0;s<i;s++)r[n+4*s]=t[2*s],r[n+4*s+1]=t[2*s+1];},r3[35]=r3[33],r3[34]=function(e,t,n,i){for(var r=e.storageUint32,s=0;s<i;s++)r[n+4*s]=t[2*s],r[n+4*s+1]=t[2*s+1];},r3[36]=function(e,t,n,i){for(var r=e.storageInt32,s=0;s<i;s++)r[n+4*s]=t[3*s],r[n+4*s+1]=t[3*s+1],r[n+4*s+2]=t[3*s+2];},r3[38]=r3[36],r3[37]=function(e,t,n,i){for(var r=e.storageUint32,s=0;s<i;s++)r[n+4*s]=t[3*s],r[n+4*s+1]=t[3*s+1],r[n+4*s+2]=t[3*s+2];};var r4=function(){function e(e,t,n){if(void 0===n&&(n=true),this.renderVersionDirty=0,this.device=e,this.format=t,this.persistent=n,n){this.impl=e.createUniformBufferImpl(this);var i=new ArrayBuffer(t.byteSize);this.assignStorage(new Int32Array(i)),e._vram.ub+=this.format.byteSize;}else this.allocation=new r1;}var t,n=e.prototype;return n.destroy=function(){if(this.persistent){var e=this.device;this.impl.destroy(e),e._vram.ub-=this.format.byteSize;}},n.assignStorage=function(e){this.storageInt32=e,this.storageUint32=new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4),this.storageFloat32=new Float32Array(e.buffer,e.byteOffset,e.byteLength/4);},n.loseContext=function(){var e;null==(e=this.impl)||e.loseContext();},n.setUniform=function(e,t){var n=e.offset;if(null!=t){var i=r3[e.updateType];i?i(this,t,n,e.count):this.storageFloat32.set(t,n);}},n.set=function(e,t){var n=this.format.map.get(e);n&&this.setUniform(n,t);},n.startUpdate=function(e){if(!this.persistent){var t=this.allocation,n=t.gpuBuffer;this.device.dynamicBuffers.alloc(t,this.format.byteSize),this.assignStorage(t.storage),e&&(e.bindGroup=t.gpuBuffer.getBindGroup(this),e.offsets[0]=t.offset),n!==t.gpuBuffer&&(this.renderVersionDirty=this.device.renderVersion);}},n.endUpdate=function(){this.persistent?this.impl.unlock(this):(this.storageFloat32=null,this.storageInt32=null);},n.update=function(e){this.startUpdate(e);for(var t=this.format.uniforms,n=0;n<t.length;n++){var i=t[n].scopeId.value;this.setUniform(t[n],i);}this.endUpdate();},t=[{key:"offset",get:function(){return this.persistent?0:this.allocation.offset}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),r5={type:5,base:0,baseVertex:0,count:4,indexed:false},r8=function(){function e(e){var t="\n\n            struct ub_mesh {\n                color : vec4f,\n                depth: f32\n            }\n\n            @group(2) @binding(0) var<uniform> ubMesh : ub_mesh;\n\n            var<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n                vec2(-1.0, 1.0), vec2(1.0, 1.0),\n                vec2(-1.0, -1.0), vec2(1.0, -1.0)\n            );\n\n            struct VertexOutput {\n                @builtin(position) position : vec4f\n            }\n\n            @vertex\n            fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n                var output : VertexOutput;\n                output.position = vec4(pos[vertexIndex], ubMesh.depth, 1.0);\n                return output;\n            }\n\n            @fragment\n            fn fragmentMain() -> @location(0) vec4f {\n                return ubMesh.color;\n            }\n        ";this.shader=new r$(e,{name:"WebGPUClearRendererShader",shaderLanguage:ni,vshader:t,fshader:t}),this.uniformBuffer=new r4(e,new iZ(e,[new iK("color",5),new iK("depth",2)]),false),this.dynamicBindGroup=new nz,this.colorData=new Float32Array(4);}var t=e.prototype;return t.destroy=function(){this.shader.destroy(),this.shader=null,this.uniformBuffer.destroy(),this.uniformBuffer=null;},t.clear=function(e,t,n,i){var r=null!=(o=(n=n||i).flags)?o:i.flags;if(0!==r){var s=this.uniformBuffer,a=this.dynamicBindGroup;if(s.startUpdate(a),e.setBindGroup(2,a.bindGroup,a.offsets),e.setBindGroup(1,e.emptyBindGroup),1&r&&(t.colorBuffer||t.impl.assignedColorTexture)){var o,l,u=null!=(l=n.color)?l:i.color;this.colorData.set(u),e.setBlendState(nj.NOBLEND);}else e.setBlendState(nj.NOWRITE);if(s.set("color",this.colorData),2&r&&t.depth){var c,h=null!=(c=n.depth)?c:i.depth;s.set("depth",h),e.setDepthState(nq.WRITEDEPTH);}else s.set("depth",1),e.setDepthState(nq.NODEPTH);4&r&&t.stencil,s.endUpdate(),e.setCullMode(0),e.setShader(this.shader),e.draw(r5);}},e}(),r6=function(){function e(e){this.device=e;var t="\n \n            var<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n                vec2(-1.0, 1.0), vec2(1.0, 1.0),\n                vec2(-1.0, -1.0), vec2(1.0, -1.0)\n            );\n\n            struct VertexOutput {\n                @builtin(position) position : vec4f,\n                @location(0) texCoord : vec2f\n            };\n\n            @vertex\n            fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n              var output : VertexOutput;\n              output.texCoord = pos[vertexIndex] * vec2f(0.5, -0.5) + vec2f(0.5);\n              output.position = vec4f(pos[vertexIndex], 0, 1);\n              return output;\n            }\n\n            @group(0) @binding(0) var imgSampler : sampler;\n            @group(0) @binding(1) var img : texture_2d<f32>;\n\n            @fragment\n            fn fragmentMain(@location(0) texCoord : vec2f) -> @location(0) vec4f {\n              return textureSample(img, imgSampler, texCoord);\n            }\n        ";this.shader=new r$(e,{name:"WebGPUMipmapRendererShader",shaderLanguage:ni,vshader:t,fshader:t}),this.minSampler=e.wgpu.createSampler({minFilter:"linear"});}var t=e.prototype;return t.destroy=function(){this.shader.destroy(),this.shader=null;},t.generate=function(e){var t=e.desc;if(!(t.mipLevelCount<=1)&&!e.texture.volume){for(var n=this.device,i=n.wgpu,r=this.shader.impl,s=i.createRenderPipeline({layout:"auto",vertex:{module:r.getVertexShaderModule(),entryPoint:r.vertexEntryPoint},fragment:{module:r.getFragmentShaderModule(),entryPoint:r.fragmentEntryPoint,targets:[{format:t.format}]},primitive:{topology:"triangle-strip"}}),a=e.texture,o=a.cubemap?6:a.array?a.arrayLength:1,l=[],u=0;u<o;u++)l.push(e.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:u}));for(var c=n.getCommandEncoder(),h=1;h<t.mipLevelCount;h++)for(var f=0;f<o;f++){var d=e.createView({dimension:"2d",baseMipLevel:h,mipLevelCount:1,baseArrayLayer:f}),p=c.beginRenderPass({colorAttachments:[{view:d,loadOp:"clear",storeOp:"store"}]}),m=i.createBindGroup({layout:s.getBindGroupLayout(0),entries:[{binding:0,resource:this.minSampler},{binding:1,resource:l[f]}]});p.setPipeline(s),p.setBindGroup(0,m),p.draw(4),p.end(),l[f]=d;}n.pipeline=null;}},e}();function r9(e,t){return (r9=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var r7=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i){var r;return (r=e.call(this,t)||this).buffer=null,r.mappedRange=null,r.buffer=t.wgpu.createBuffer({size:n,usage:i?GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:i}),i&&r.onAvailable(),t._vram.ub+=n,r}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&r9(t,e);var n=t.prototype;return n.destroy=function(e){e._vram.ub-=this.buffer.size,this.buffer.destroy(),this.buffer=null;},n.onAvailable=function(){this.mappedRange=this.buffer.getMappedRange();},n.alloc=function(e,t){return new Int32Array(this.mappedRange,e,t/4)},t}(function(){function e(e){this.bindGroupCache=new Map,this.device=e,this.bindGroupFormat=new nL(this.device,[new nA(nd,3)]);}return e.prototype.getBindGroup=function(e){var t=e.format.byteSize,n=this.bindGroupCache.get(t);return n||((n=new nV(this.device,this.bindGroupFormat,e)).update(),this.bindGroupCache.set(t,n)),n},e}());function se(e,t){return (se=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var st=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return t=e.apply(this,arguments)||this,t.pendingStagingBuffers=[],t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&se(t,e);var n=t.prototype;return n.createBuffer=function(e,t,n){return new r7(e,t,n)},n.submit=function(){e.prototype.submit.call(this);var t=this.usedBuffers.length;if(t){for(var n=this.device,i=this.gpuBuffers,r=n.wgpu.createCommandEncoder(),s=t-1;s>=0;s--){var a=this.usedBuffers[s],o=a.stagingBuffer,l=a.gpuBuffer,u=a.offset,c=a.size,h=o.buffer;h.unmap(),r.copyBufferToBuffer(h,u,l.buffer,u,c),i.push(l);}var f=r.finish();n.addCommandBuffer(f,true);for(var d=0;d<t;d++){var p=this.usedBuffers[d].stagingBuffer;this.pendingStagingBuffers.push(p);}this.usedBuffers.length=0;}},n.onCommandBuffersSubmitted=function(){var e=this,t=this.pendingStagingBuffers.length;if(t){for(var n,i=0;i<t;i++)n=this,function(t){var i=n.pendingStagingBuffers[t];i.buffer.mapAsync(GPUMapMode.WRITE).then(function(){e.stagingBuffers&&(i.onAvailable(),e.stagingBuffers.push(i));});}(i);this.pendingStagingBuffers.length=0;}},t}(r2),sn=function(){function e(){this.frameAllocations=[],this.pastFrameAllocations=new Map,this._enabled=false,this._enableRequest=false,this._frameTime=0;}var t,n=e.prototype;return n.loseContext=function(){this.pastFrameAllocations.clear();},n.processEnableRequest=function(){this._enableRequest!==this._enabled&&(this._enabled=this._enableRequest,this._enabled||(this._frameTime=0));},n.request=function(e){this.pastFrameAllocations.set(e,this.frameAllocations),this.frameAllocations=[];},n.report=function(e,t){if(t){var n=this.pastFrameAllocations.get(e);if(t.length>0&&(this._frameTime=t.reduce(function(e,t){return e+t},0)),eO.get(Q))for(var i=0;i<n.length;++i)n[i],t[i];}this.pastFrameAllocations.delete(e);},n.getSlot=function(e){var t=this.frameAllocations.length;return this.frameAllocations.push(e),t},t=[{key:"enabled",get:function(){return this._enableRequest},set:function(e){this._enableRequest=e;}},{key:"slotCount",get:function(){return this.frameAllocations.length}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),si=function(){function e(e,t,n){this.stagingBuffers=[],this.activeStagingBuffer=null,this.device=e,this.capacity=n,this.bytesPerSlot=t?8:4;var i=e.wgpu;this.querySet=i.createQuerySet({type:t?"timestamp":"occlusion",count:n}),this.queryBuffer=i.createBuffer({size:this.bytesPerSlot*n,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST});}var t=e.prototype;return t.destroy=function(){var e,t;null==(e=this.querySet)||e.destroy(),this.querySet=null,null==(t=this.queryBuffer)||t.destroy(),this.queryBuffer=null,this.activeStagingBuffer=null,this.stagingBuffers.forEach(function(e){e.destroy();}),this.stagingBuffers=null;},t.getStagingBuffer=function(){var e=this.stagingBuffers.pop();return e||(e=this.device.wgpu.createBuffer({size:this.queryBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),e},t.resolve=function(e){var t=this.device.getCommandEncoder();t.resolveQuerySet(this.querySet,0,e,this.queryBuffer,0);var n=this.getStagingBuffer();this.activeStagingBuffer=n,t.copyBufferToBuffer(this.queryBuffer,0,n,0,this.bytesPerSlot*e);},t.request=function(e,t){var n=this,i=this.activeStagingBuffer;return this.activeStagingBuffer=null,i.mapAsync(GPUMapMode.READ).then(function(){for(var r,s=new BigInt64Array(i.getMappedRange()),a=[],o=0;o<e;o++)a.push(1e-6*Number(s[2*o+1]-s[2*o]));return i.unmap(),null==(r=n.stagingBuffers)||r.push(i),{renderVersion:t,timings:a}})},e}();function sr(e,t){return (sr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ss=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this).device=t,n.timestampQueriesSet=t.supportsTimestampQuery?new si(t,true,512):null,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&sr(t,e);var n=t.prototype;return n.destroy=function(){var e;null==(e=this.timestampQueriesSet)||e.destroy(),this.timestampQueriesSet=null;},n.frameStart=function(){this.processEnableRequest();},n.frameEnd=function(){if(this._enabled){var e;null==(e=this.timestampQueriesSet)||e.resolve(2*this.slotCount);}},n.request=function(){var t=this;if(this._enabled){var n,i=this.device.renderVersion;null==(n=this.timestampQueriesSet)||n.request(this.slotCount,i).then(function(e){t.report(e.renderVersion,e.timings);}),e.prototype.request.call(this,i);}},t}(sn),sa=function(){function e(e){this.pipelineCache=new Map,this.device=e;var t="\n \n            var<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n                vec2(-1.0, 1.0), vec2(1.0, 1.0), vec2(-1.0, -1.0), vec2(1.0, -1.0)\n            );\n\n            struct VertexOutput {\n                @builtin(position) position : vec4f,\n            };\n\n            @vertex\n            fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n              var output : VertexOutput;\n              output.position = vec4f(pos[vertexIndex], 0, 1);\n              return output;\n            }\n\n            @group(0) @binding(0) var img : texture_depth_multisampled_2d;\n\n            @fragment\n            fn fragmentMain(@builtin(position) fragColor: vec4f) -> @location(0) vec4f {\n                // load th depth value from sample index 0\n                var depth = textureLoad(img, vec2i(fragColor.xy), 0u);\n                return vec4f(depth, 0.0, 0.0, 0.0);\n            }\n        ";this.shader=new r$(e,{name:"WebGPUResolverDepthShader",shaderLanguage:ni,vshader:t,fshader:t});}var t=e.prototype;return t.destroy=function(){this.shader.destroy(),this.shader=null,this.pipelineCache=null;},t.getPipeline=function(e){var t=this.pipelineCache.get(e);return t||(t=this.createPipeline(e),this.pipelineCache.set(e,t)),t},t.createPipeline=function(e){var t=this.shader.impl;return this.device.wgpu.createRenderPipeline({layout:"auto",vertex:{module:t.getVertexShaderModule(),entryPoint:t.vertexEntryPoint},fragment:{module:t.getFragmentShaderModule(),entryPoint:t.fragmentEntryPoint,targets:[{format:e}]},primitive:{topology:"triangle-strip"}})},t.resolveDepth=function(e,t,n){for(var i=this.device,r=i.wgpu,s=this.getPipeline(n.format),a=t.depthOrArrayLayers,o=0;o<a;o++){var l=t.createView({dimension:"2d",aspect:"depth-only",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:o}),u=n.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:o}),c=e.beginRenderPass({colorAttachments:[{view:u,loadOp:"clear",storeOp:"store"}]}),h=r.createBindGroup({layout:s.getBindGroupLayout(0),entries:[{binding:0,resource:l}]});c.setPipeline(s),c.setBindGroup(0,h),c.draw(4),c.end();}i.pipeline=null;},e}(),so=function(){function e(e){this.uniformBuffers=[],this.bindGroup=null,this.compute=e;var t=e.device,n=e.shader,i=n.impl,r=i.computeBindGroupFormat,s=i.computeUniformBufferFormats;if(this.bindGroup=new nV(t,r),s){for(var a in s)if(s.hasOwnProperty(a)){var o=new r4(t,s[a],true);this.uniformBuffers.push(o),this.bindGroup.setUniformBuffer(a,o);}}this.pipeline=t.computePipeline.get(n,r);}var t=e.prototype;return t.destroy=function(){this.uniformBuffers.forEach(function(e){return e.destroy()}),this.uniformBuffers.length=0,this.bindGroup.destroy(),this.bindGroup=null;},t.updateBindGroup=function(){var e=this.bindGroup;e.updateUniformBuffers(),e.update();},t.dispatch=function(e,t,n){var i=this.compute.device;i.setBindGroup(0,this.bindGroup);var r=i.passEncoder;r.setPipeline(this.pipeline),r.dispatchWorkgroups(e,t,n);},e}(),sl=0,su=function(){function e(e,t,n){ void 0===n&&(n=0),this.id=sl++,this.device=e,this.byteSize=t,this.bufferUsage=n,this.impl=e.createBufferImpl(128|n),this.impl.allocate(e,t),this.device.buffers.push(this),this.adjustVramSizeTracking(e._vram,this.byteSize);}var t=e.prototype;return t.destroy=function(){var e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.adjustVramSizeTracking(e._vram,-this.byteSize),this.impl.destroy(e);},t.adjustVramSizeTracking=function(e,t){e.sb+=t;},t.read=function(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=this.byteSize),void 0===n&&(n=null),void 0===i&&(i=false),this.impl.read(this.device,e,t,n,i)},t.write=function(e,t,n,i){ void 0===e&&(e=0),void 0===n&&(n=0),this.impl.write(this.device,e,t,n,i);},t.clear=function(e,t){ void 0===e&&(e=0),void 0===t&&(t=this.byteSize),this.impl.clear(this.device,e,t);},e}();function sc(e,t,n,i,r,s,a){try{var o=e[s](a),l=o.value;}catch(e){n(e);return}o.done?t(l):Promise.resolve(l).then(i,r);}function sh(e){return function(){var t=this,n=arguments;return new Promise(function(i,r){var s=e.apply(t,n);function a(e){sc(s,i,r,a,o,"next",e);}function o(e){sc(s,i,r,a,o,"throw",e);}a(void 0);})}}function sf(e,t){return (sf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function sd(e,t){var n,i,r,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(l){var u=[o,l];if(n)throw TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(s=0)),s;)try{if(n=1,i&&(r=2&u[0]?i.return:u[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,u[1])).done)return r;switch(i=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,i=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===u[0]||2===u[0])){s=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){s.label=u[1];break}if(6===u[0]&&s.label<r[1]){s.label=r[1],r=u;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(u);break}r[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s);}catch(e){u=[6,e],i=0;}finally{n=r=0;}if(5&u[0])throw u[1];return {value:u[0]?u[1]:void 0,done:true}}}}var sp=new Map,sm=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i,r,s;return void 0===n&&(n={}),(i=e.call(this,t,n)||this).renderPipeline=new iO(i),i.computePipeline=new iN(i),i._indirectDrawBuffer=null,i._indirectDrawBufferCount=0,i._indirectDrawNextIndex=0,i.pipeline=null,i.bindGroupFormats=[],i.commandEncoder=null,i.commandBuffers=[],i.glslang=null,i.twgsl=null,(n=i.initOptions).alpha=null==(r=n.alpha)||r,i.backBufferAntialias=null!=(s=n.antialias)&&s,i.isWebGPU=true,i._deviceType=nu,i.scope.resolve(np).setValue(0),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&sf(t,e);var n,i=t.prototype;return i.destroy=function(){this.clearRenderer.destroy(),this.clearRenderer=null,this.mipmapRenderer.destroy(),this.mipmapRenderer=null,this.resolver.destroy(),this.resolver=null,e.prototype.destroy.call(this);},i.initDeviceCaps=function(){var e,t=null==(e=this.wgpu)?void 0:e.limits;this.limits=t,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=t.maxTextureDimension2D,this.maxCubeMapSize=t.maxTextureDimension2D,this.maxVolumeSize=t.maxTextureDimension3D,this.maxColorAttachments=t.maxColorAttachments,this.maxPixelRatio=1,this.maxAnisotropy=16,this.fragmentUniformsCount=t.maxUniformBufferBindingSize/16,this.vertexUniformsCount=t.maxUniformBufferBindingSize/16,this.supportsUniformBuffers=true,this.supportsAreaLights=true,this.supportsGpuParticles=true,this.supportsCompute=true,this.textureFloatRenderable=true,this.textureHalfFloatRenderable=true,this.supportsImageBitmap=true,this.samples=this.backBufferAntialias?4:1;var n=window.navigator.gpu.wgslLanguageFeatures;this.supportsStorageTextureRead=null==n?void 0:n.has("readonly_and_readwrite_storage_textures"),this.initCapsDefines();},i.initWebGpu=function(e,t){var n=this;return sh(function(){var i,r;return sd(this,function(s){switch(s.label){case 0:if(!window.navigator.gpu)throw Error("Unable to retrieve GPU. Ensure you are using a browser that supports WebGPU rendering.");if(!(e&&t))return [3,2];return i=function(e){return new URL(e,window.location.href).toString()},[4,Promise.all([Function("modulePath","return import(modulePath)")(""+i(t)).then(function(e){return twgsl(t.replace(".js",".wasm"))}),Function("modulePath","return import(modulePath)")(""+i(e)).then(function(e){return e.default()})])];case 1:n.twgsl=(r=s.sent())[0],n.glslang=r[1],s.label=2;case 2:return [2,n.createDevice()]}})})()},i.createDevice=function(){var e=this;return sh(function(){var t,n,i,r,s,a,o,l,u,c,h,f,d;return sd(this,function(p){switch(p.label){case 0:return r={powerPreference:"default"!==e.initOptions.powerPreference?e.initOptions.powerPreference:void 0,xrCompatible:e.initOptions.xrCompatible},[4,window.navigator.gpu.requestAdapter(r)];case 1:if(e.gpuAdapter=p.sent(),s=[],a=function(t){var n=e.gpuAdapter.features.has(t);return n&&s.push(t),n},e.textureFloatFilterable=a("float32-filterable"),e.textureFloatBlendable=a("float32-blendable"),e.extCompressedTextureS3TC=a("texture-compression-bc"),e.extCompressedTextureS3TCSliced3D=a("texture-compression-bc-sliced-3d"),e.extCompressedTextureETC=a("texture-compression-etc2"),e.extCompressedTextureASTC=a("texture-compression-astc"),e.extCompressedTextureASTCSliced3D=a("texture-compression-astc-sliced-3d"),e.supportsTimestampQuery=a("timestamp-query"),e.supportsDepthClip=a("depth-clip-control"),e.supportsDepth32Stencil=a("depth32float-stencil8"),e.supportsIndirectFirstInstance=a("indirect-first-instance"),e.supportsShaderF16=a("shader-f16"),e.supportsStorageRGBA8=a("bgra8unorm-storage"),e.textureRG11B10Renderable=a("rg11b10ufloat-renderable"),e.supportsClipDistances=a("clip-distances"),o=null==(t=e.gpuAdapter)?void 0:t.limits,l={},o)for(var m in o)"minSubgroupSize"!==m&&"maxSubgroupSize"!==m&&(l[m]=o[m]);return u={requiredFeatures:s,requiredLimits:l,defaultQueue:{label:"Default Queue"}},[4,e.gpuAdapter.requestDevice(u)];case 2:return e.wgpu=p.sent(),null==(n=e.wgpu.lost)||n.then(e.handleDeviceLost.bind(e)),e.initDeviceCaps(),e.gpuContext=e.canvas.getContext("webgpu"),c="standard",h=window.navigator.gpu.getPreferredCanvasFormat(),f=e.initOptions.displayFormat,e.backBufferFormat="rgba8unorm"===h?f===nh?20:7:f===nh?64:31,e.backBufferViewFormat=f===nh?""+h+"-srgb":h,"hdr"===f&&e.textureFloatFilterable&&(null==(d=window.matchMedia("(dynamic-range: high)"))?void 0:d.matches)&&(e.backBufferFormat=12,e.backBufferViewFormat="rgba16float",h="rgba16float",e.isHdr=true,c="extended"),e.canvasConfig={device:e.wgpu,colorSpace:"srgb",alphaMode:e.initOptions.alpha?"premultiplied":"opaque",format:h,toneMapping:{mode:c},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST,viewFormats:f===nh?[e.backBufferViewFormat]:[]},null==(i=e.gpuContext)||i.configure(e.canvasConfig),e.createBackbuffer(),e.clearRenderer=new r8(e),e.mipmapRenderer=new r6(e),e.resolver=new sa(e),e.postInit(),[2,e]}})})()},i.handleDeviceLost=function(t){var n=this;return sh(function(){return sd(this,function(i){switch(i.label){case 0:if("destroyed"===t.reason)return [3,2];return e.prototype.loseContext.call(n),[4,n.createDevice()];case 1:i.sent(),e.prototype.restoreContext.call(n),i.label=2;case 2:return [2]}})})()},i.postInit=function(){e.prototype.postInit.call(this),this.initializeRenderState(),this.setupPassEncoderDefaults(),this.gpuProfiler=new ss(this),this.dynamicBuffers=new st(this,102400,this.limits.minUniformBufferOffsetAlignment),this.emptyBindGroup=new nV(this,new nL(this,[])),this.emptyBindGroup.update();},i.createBackbuffer=function(){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new il({name:"WebgpuFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.isBackbuffer=true;},i.frameStart=function(){e.prototype.frameStart.call(this),this.gpuProfiler.frameStart(),this.submit();var t,n,i,r,s=null!=(r=null==(n=this.gpuContext)||null==(t=n.getCurrentTexture)?void 0:t.call(n))?r:null==(i=this.externalBackbuffer)?void 0:i.impl.gpuTexture;(this.backBufferSize.x!==s.width||this.backBufferSize.y!==s.height)&&(this.backBufferSize.set(s.width,s.height),this.backBuffer.destroy(),this.backBuffer=null,this.createBackbuffer());var a=this.backBuffer,o=a.impl;o.setColorAttachment(0,void 0,this.backBufferViewFormat),this.initRenderTarget(a),o.assignColorTexture(this,s);},i.frameEnd=function(){e.prototype.frameEnd.call(this),this.gpuProfiler.frameEnd(),this.submit(),this.contextLost||this.gpuProfiler.request(),this._indirectDrawNextIndex=0;},i.createBufferImpl=function(e){return new iv(e)},i.createUniformBufferImpl=function(e){return new rb(e)},i.createVertexBufferImpl=function(e,t,n){return new rE(e,t,n)},i.createIndexBufferImpl=function(e,t){return new iy(e,t)},i.createShaderImpl=function(e){return new rm(e)},i.createTextureImpl=function(e){return new rS(e)},i.createRenderTargetImpl=function(e){return new iY(e)},i.createBindGroupFormatImpl=function(e){return new i_(e)},i.createBindGroupImpl=function(e){return new iu},i.createComputeImpl=function(e){return new so(e)},i.allocateIndirectDrawBuffer=function(){if(0===this._indirectDrawNextIndex&&this._indirectDrawBufferCount<this.maxIndirectDrawCount){var e;null==(e=this._indirectDrawBuffer)||e.destroy(),this._indirectDrawBuffer=null;}null===this._indirectDrawBuffer&&(this._indirectDrawBuffer=new su(this,4*this.maxIndirectDrawCount,264),this._indirectDrawBufferCount=this.maxIndirectDrawCount);},i.getIndirectDrawSlot=function(){this.allocateIndirectDrawBuffer();var e=this._indirectDrawNextIndex;return this._indirectDrawNextIndex++,e},i.setBindGroup=function(e,t,n){this.passEncoder&&(this.passEncoder.setBindGroup(e,t.impl.bindGroup,null!=n?n:t.uniformBufferOffsets),this.bindGroupFormats[e]=t.format.impl);},i.submitVertexBuffer=function(e,t){var n=e.format,i=n.interleaved,r=n.elements,s=r.length,a=e.impl.buffer;if(i)return this.passEncoder.setVertexBuffer(t,a),1;for(var o=0;o<s;o++)this.passEncoder.setVertexBuffer(t+o,a,r[o].offset);return s},i.validateVBLocations=function(e,t){var n=function(e){for(var t=e.format.elements,n=0;n<t.length;n++){var i=t[n].name,r=nS[i];sp.has(r),sp.set(r,i);}};n(e),n(t),sp.clear();},i.draw=function(e,t,n,i,r,s){if(void 0===n&&(n=1),void 0===r&&(r=true),void 0===s&&(s=true),this.shader.ready&&!this.shader.failed){var a,o=this.passEncoder,l=this.pipeline,u=this.vertexBuffers[0],c=this.vertexBuffers[1];if(r){if(u){var h=this.submitVertexBuffer(u,0);c&&this.submitVertexBuffer(c,h);}l=this.renderPipeline.get(e,null==u?void 0:u.format,null==c?void 0:c.format,null==t?void 0:t.format,this.shader,this.renderTarget,this.bindGroupFormats,this.blendState,this.depthState,this.cullMode,this.stencilEnabled,this.stencilFront,this.stencilBack),this.pipeline!==l&&(this.pipeline=l,o.setPipeline(l));}if(t&&o.setIndexBuffer(t.impl.buffer,t.impl.format),void 0!==i){var f=20*i,d=this.indirectDrawBuffer.impl.buffer;t?o.drawIndexedIndirect(d,f):o.drawIndirect(d,f);}else t?o.drawIndexed(e.count,n,e.base,null!=(a=e.baseVertex)?a:0,0):o.draw(e.count,n,e.base,0);}s&&(this.clearVertexBuffer(),this.pipeline=null);},i.setShader=function(e,t){e!==this.shader&&(this.shader=e);},i.setBlendState=function(e){this.blendState.copy(e);},i.setDepthState=function(e){this.depthState.copy(e);},i.setStencilState=function(e,t){if(e||t){this.stencilEnabled=true,this.stencilFront.copy(null!=e?e:n7.DEFAULT),this.stencilBack.copy(null!=t?t:n7.DEFAULT);var n=this.stencilFront.ref;this.stencilRef!==n&&(this.stencilRef=n,this.passEncoder.setStencilReference(n));}else this.stencilEnabled=false;},i.setBlendColor=function(e,t,n,i){var r=this.blendColor;(e!==r.r||t!==r.g||n!==r.b||i!==r.a)&&(r.set(e,t,n,i),this.passEncoder.setBlendConstant(r));},i.setCullMode=function(e){this.cullMode=e;},i.setAlphaToCoverage=function(e){},i.initializeContextCaches=function(){e.prototype.initializeContextCaches.call(this);},i.setupPassEncoderDefaults=function(){this.pipeline=null,this.stencilRef=0,this.blendColor.set(0,0,0,0);},i._uploadDirtyTextures=function(){this.textures.forEach(function(e){(e._needsUpload||e._needsMipmaps)&&e.upload();});},i.setupTimeStampWrites=function(e,t){if(this.gpuProfiler._enabled&&this.gpuProfiler.timestampQueriesSet){var n=this.gpuProfiler.getSlot(t);(e=null!=e?e:{}).timestampWrites={querySet:this.gpuProfiler.timestampQueriesSet.querySet,beginningOfPassWriteIndex:2*n,endOfPassWriteIndex:2*n+1};}return e},i.startRenderPass=function(e){this._uploadDirtyTextures();var t=e.renderTarget||this.backBuffer;this.renderTarget=t;var n=t.impl;t!==this.backBuffer&&this.initRenderTarget(t),n.setupForRenderPass(e,t);var i=n.renderPassDescriptor;this.setupTimeStampWrites(i,e.name);var r=this.getCommandEncoder();this.passEncoder=r.beginRenderPass(i),this.passEncoder.label=e.name+"-PassEncoder RT:"+t.name,this.setupPassEncoderDefaults();var s=t.width,a=t.height;this.setViewport(0,0,s,a),this.setScissor(0,0,s,a),this.insideRenderPass=true;},i.endRenderPass=function(e){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=false,this.bindGroupFormats.length=0;var t=this.renderTarget;if(t&&t.depthBuffer&&e.depthStencilOps.resolveDepth&&e.samples>1&&t.autoResolve){var n=t.impl.depthAttachment,i=t.depthBuffer.impl.gpuTexture;n&&i&&this.resolver.resolveDepth(this.commandEncoder,n.multisampledDepthBuffer,i);}for(var r=0;r<e.colorArrayOps.length;r++)e.colorArrayOps[r].genMipmaps&&this.mipmapRenderer.generate(e.renderTarget._colorBuffers[r].impl);},i.startComputePass=function(e){this.pipeline=null;var t=this.setupTimeStampWrites(void 0,e),n=this.getCommandEncoder();this.passEncoder=n.beginComputePass(t),this.insideRenderPass=true;},i.endComputePass=function(){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=false,this.bindGroupFormats.length=0;},i.computeDispatch=function(e,t){ void 0===t&&(t="Unnamed"),this.startComputePass(t);for(var n=0;n<e.length;n++){var i=e[n];i.applyParameters(),i.impl.updateBindGroup();}for(var r=0;r<e.length;r++){var s=e[r];s.impl.dispatch(s.countX,s.countY,s.countZ);}this.endComputePass();},i.getCommandEncoder=function(){var e=this.commandEncoder;return e||(e=this.wgpu.createCommandEncoder(),this.commandEncoder=e),e},i.endCommandEncoder=function(){var e=this.commandEncoder;if(e){var t=e.finish();this.addCommandBuffer(t),this.commandEncoder=null;}},i.addCommandBuffer=function(e,t){ void 0===t&&(t=false),t?this.commandBuffers.unshift(e):this.commandBuffers.push(e);},i.submit=function(){this.endCommandEncoder(),this.commandBuffers.length>0&&(this.dynamicBuffers.submit(),this.wgpu.queue.submit(this.commandBuffers),this.commandBuffers.length=0,this.dynamicBuffers.onCommandBuffersSubmitted());},i.clear=function(e){e.flags&&this.clearRenderer.clear(this,this.renderTarget,e,this.defaultClearOptions);},i.setViewport=function(e,t,n,i){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-i),this.vx=e,this.vy=t,this.vw=n,this.vh=i,this.passEncoder.setViewport(e,t,n,i,0,1));},i.setScissor=function(e,t,n,i){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-i),this.sx=e,this.sy=t,this.sw=n,this.sh=i,this.passEncoder.setScissorRect(e,t,n,i));},i.clearStorageBuffer=function(e,t,n){ void 0===t&&(t=0),void 0===n&&(n=e.byteSize),this.getCommandEncoder().clearBuffer(e.buffer,t,n);},i.readStorageBuffer=function(e,t,n,i,r){ void 0===t&&(t=0),void 0===n&&(n=e.byteSize-t),void 0===i&&(i=null),void 0===r&&(r=false);var s=this.createBufferImpl(9);s.allocate(this,n);var a=s.buffer;return this.getCommandEncoder().copyBufferToBuffer(e.buffer,t,a,0,n),this.readBuffer(s,n,i,r)},i.readBuffer=function(e,t,n,i){var r=this;void 0===n&&(n=null),void 0===i&&(i=false);var s=e.buffer;return new Promise(function(a,o){var l=function(){null==s||s.mapAsync(GPUMapMode.READ).then(function(){null!=n||(n=new Uint8Array(t));var i=s.getMappedRange(0,t),o=n.constructor;n.set(new o(i)),s.unmap(),e.destroy(r),a(n);});};i?(r.submit(),l()):setTimeout(function(){l();});})},i.writeStorageBuffer=function(e,t,n,i,r){ void 0===t&&(t=0),void 0===i&&(i=0),this.wgpu.queue.writeBuffer(e.buffer,t,n,i,r);},i.copyRenderTarget=function(e,t,n,i){var r={width:e?e.width:t.width,height:e?e.height:t.height,depthOrArrayLayers:1},s=this.getCommandEncoder();if(n){var a={texture:e?e.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0},o={texture:t?t.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0};s.copyTextureToTexture(a,o,r);}if(i){var l=(e||this.renderTarget).impl.depthAttachment.depthTexture;if(e.samples>1){var u=t.colorBuffer.impl.gpuTexture;this.resolver.resolveDepth(s,l,u);}else {var c=t?t.depthBuffer.impl.gpuTexture:this.renderTarget.impl.depthAttachment.depthTexture;s.copyTextureToTexture({texture:l,mipLevel:0},{texture:c,mipLevel:0},r);}}return  true},n=[{key:"indirectDrawBuffer",get:function(){return this.allocateIndirectDrawBuffer(),this._indirectDrawBuffer}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ia),s_=function(){function e(){this.bufferId=null;}var t,n=e.prototype;return n.destroy=function(e){this.bufferId&&(e.gl.deleteBuffer(this.bufferId),this.bufferId=null);},n.loseContext=function(){this.bufferId=null;},n.unlock=function(e,t,n,i){var r,s=e.gl;if(this.bufferId)s.bindBuffer(n,this.bufferId),s.bufferSubData(n,0,i);else {switch(t){case 0:r=s.STATIC_DRAW;break;case 1:r=s.DYNAMIC_DRAW;break;case 2:r=s.STREAM_DRAW;break;case 3:r=s.DYNAMIC_COPY;}this.bufferId=s.createBuffer(),s.bindBuffer(n,this.bufferId),s.bufferData(n,i,r);}},t=[{key:"initialized",get:function(){return !!this.bufferId}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function sv(e,t){return (sv=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var sg=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return t=e.apply(this,arguments)||this,t.vao=null,t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&sv(t,e);var n=t.prototype;return n.destroy=function(t){e.prototype.destroy.call(this,t),t.unbindVertexArray();},n.loseContext=function(){e.prototype.loseContext.call(this),this.vao=null;},n.unlock=function(t){var n=t.device;e.prototype.unlock.call(this,n,t.usage,n.gl.ARRAY_BUFFER,t.storage);},t}(s_);function sy(e,t){return (sy=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var sS=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n=e.call(this)||this,i=t.device.gl,r=t.format;return 0===r?n.glFormat=i.UNSIGNED_BYTE:1===r?n.glFormat=i.UNSIGNED_SHORT:2===r&&(n.glFormat=i.UNSIGNED_INT),n}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&sy(t,e),t.prototype.unlock=function(t){var n=t.device;e.prototype.unlock.call(this,n,t.usage,n.gl.ELEMENT_ARRAY_BUFFER,t.storage);},t}(s_),sx=function(e,t,n,i){if(this.locationId=i,this.scopeId=e.scope.resolve(t),this.version=new nK,"[0]"===t.substring(t.length-3))switch(n){case 2:n=17;break;case 1:n=30;break;case 26:n=31;break;case 0:n=32;break;case 3:n=21;break;case 6:n=33;break;case 27:n=34;break;case 9:n=35;break;case 4:n=22;break;case 7:n=36;break;case 28:n=37;break;case 10:n=38;break;case 5:n=23;break;case 8:n=39;break;case 29:n=40;break;case 11:n=41;}this.dataType=n,this.value=[null,null,null,null],this.array=[];},sb=new Set(["gl_VertexID","gl_InstanceID","gl_DrawID","gl_BaseVertex","gl_BaseInstance"]),sT=function(){function e(){this.map=new Map;}var t=e.prototype;return t.destroy=function(e){this.map.forEach(function(t){e.gl.deleteShader(t);});},t.loseContext=function(e){this.map.clear();},e}(),sE=new nD,sw=new nD,sA=function(){function e(e){this.compileDuration=0,this.init(),this.compile(e.device,e),this.link(e.device,e),e.device.shaders.push(e);}var t=e.prototype;return t.destroy=function(e){this.glProgram&&(e.device.gl.deleteProgram(this.glProgram),this.glProgram=null);},t.init=function(){this.uniforms=[],this.samplers=[],this.attributes=[],this.glProgram=null,this.glVertexShader=null,this.glFragmentShader=null;},t.loseContext=function(){this.init();},t.restoreContext=function(e,t){this.compile(e,t),this.link(e,t);},t.compile=function(e,t){var n=t.definition;this.glVertexShader=this._compileShaderSource(e,n.vshader,true),this.glFragmentShader=this._compileShaderSource(e,n.fshader,false);},t.link=function(e,t){if(!this.glProgram){var n=e.gl;if(!n.isContextLost()){var i=n.createProgram();this.glProgram=i,n.attachShader(i,this.glVertexShader),n.attachShader(i,this.glFragmentShader);var r=t.definition,s=r.attributes;if(r.useTransformFeedback){var a=[];for(var o in s)s.hasOwnProperty(o)&&a.push("out_"+o);n.transformFeedbackVaryings(i,a,n.INTERLEAVED_ATTRIBS);}for(var l in s)if(s.hasOwnProperty(l)){var u=nS[s[l]];n.bindAttribLocation(i,u,l);}n.linkProgram(i);}}},t._compileShaderSource=function(e,t,n){var i=e.gl;if(i.isContextLost())return null;var r=(n?sE:sw).get(e,function(){return new sT}),s=r.map.get(t);return s||(s=i.createShader(n?i.VERTEX_SHADER:i.FRAGMENT_SHADER),i.shaderSource(s,t),i.compileShader(s),r.map.set(t,s)),s},t.finalize=function(e,t){var n=e.gl;if(n.isContextLost())return  true;var i=this.glProgram,r=t.definition;if(!n.getProgramParameter(i,n.LINK_STATUS))return !!this._isCompiled(e,t,this.glVertexShader,r.vshader,"vertex")&&!!this._isCompiled(e,t,this.glFragmentShader,r.fshader,"fragment")&&(n.getProgramInfoLog(i),false);var s=n.getProgramParameter(i,n.ACTIVE_ATTRIBUTES);t.attributes.clear();for(var a=0;a<s;a++){var o=n.getActiveAttrib(i,a),l=n.getAttribLocation(i,o.name);sb.has(o.name)||(void 0===r.attributes[o.name]?t.failed=true:t.attributes.set(l,o.name));}for(var u=e._samplerTypes,c=n.getProgramParameter(i,n.ACTIVE_UNIFORMS),h=0;h<c;h++){var f=n.getActiveUniform(i,h),d=n.getUniformLocation(i,f.name),p=new sx(e,f.name,e.pcUniformType[f.type],d);u.has(f.type)?this.samplers.push(p):this.uniforms.push(p);}return t.ready=true,true},t._isCompiled=function(e,t,n,i,r){var s=e.gl;if(!s.getShaderParameter(n,s.COMPILE_STATUS)){var a=s.getShaderInfoLog(n),o=this._processError(i,a);return o[0],o[1],false}return  true},t.isLinked=function(e){var t=e.extParallelShaderCompile;return !t||e.gl.getProgramParameter(this.glProgram,t.COMPLETION_STATUS_KHR)},t._processError=function(e,t){var n={},i="";if(e){var r=e.split("\n"),s=0,a=r.length;if(t&&t.startsWith("ERROR:")){var o=t.match(/^ERROR:\s(\d+):(\d+):\s*(.+)/);o&&(n.message=o[3],n.line=parseInt(o[2],10),s=Math.max(0,n.line-6),a=Math.min(r.length,n.line+5));}for(var l=s;l<a;l++)i+=(l+1===n.line?"> ":"  ")+(l+1)+":	"+r[l]+"\n";n.source=e;}return [i,n]},e}();function sC(e,t){var n=e.width,i=e.height;if(n>t||i>t){var r=t/Math.max(n,i),s=Math.floor(n*r),a=Math.floor(i*r),o=document.createElement("canvas");return o.width=s,o.height=a,o.getContext("2d").drawImage(e,0,0,n,i,0,0,s,a),o}return e}var sP=function(){function e(e){this._glTexture=null,this.dirtyParameterFlags=0,this.texture=e;}var t=e.prototype;return t.destroy=function(e){if(this._glTexture){for(var t=0;t<e.textureUnits.length;t++)for(var n=e.textureUnits[t],i=0;i<n.length;i++)n[i]===this._glTexture&&(n[i]=null);e.gl.deleteTexture(this._glTexture),this._glTexture=null;}},t.loseContext=function(){this._glTexture=null;},t.propertyChanged=function(e){this.dirtyParameterFlags|=e;},t.initialize=function(e,t){var n=e.gl;switch(this._glTexture=n.createTexture(),this._glTarget=t._cubemap?n.TEXTURE_CUBE_MAP:t._volume?n.TEXTURE_3D:t.array?n.TEXTURE_2D_ARRAY:n.TEXTURE_2D,t._format){case 0:this._glFormat=n.ALPHA,this._glInternalFormat=n.ALPHA,this._glPixelType=n.UNSIGNED_BYTE;break;case 1:this._glFormat=n.LUMINANCE,this._glInternalFormat=n.LUMINANCE,this._glPixelType=n.UNSIGNED_BYTE;break;case 2:this._glFormat=n.LUMINANCE_ALPHA,this._glInternalFormat=n.LUMINANCE_ALPHA,this._glPixelType=n.UNSIGNED_BYTE;break;case 52:this._glFormat=n.RED,this._glInternalFormat=n.R8,this._glPixelType=n.UNSIGNED_BYTE;break;case 53:this._glFormat=n.RG,this._glInternalFormat=n.RG8,this._glPixelType=n.UNSIGNED_BYTE;break;case 3:this._glFormat=n.RGB,this._glInternalFormat=n.RGB565,this._glPixelType=n.UNSIGNED_SHORT_5_6_5;break;case 4:this._glFormat=n.RGBA,this._glInternalFormat=n.RGB5_A1,this._glPixelType=n.UNSIGNED_SHORT_5_5_5_1;break;case 5:this._glFormat=n.RGBA,this._glInternalFormat=n.RGBA4,this._glPixelType=n.UNSIGNED_SHORT_4_4_4_4;break;case 6:this._glFormat=n.RGB,this._glInternalFormat=n.RGB8,this._glPixelType=n.UNSIGNED_BYTE;break;case 7:this._glFormat=n.RGBA,this._glInternalFormat=n.RGBA8,this._glPixelType=n.UNSIGNED_BYTE;break;case 31:case 64:break;case 8:this._glFormat=n.RGB,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:this._glFormat=n.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case 10:this._glFormat=n.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:this._glFormat=n.RGB,this._glInternalFormat=e.extCompressedTextureETC1.COMPRESSED_RGB_ETC1_WEBGL;break;case 24:this._glFormat=n.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case 25:this._glFormat=n.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:this._glFormat=n.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:this._glFormat=n.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:this._glFormat=n.RGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGB8_ETC2;break;case 23:this._glFormat=n.RGBA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:this._glFormat=n.RGBA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:this._glFormat=n.RGB,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGB_ATC_WEBGL;break;case 30:this._glFormat=n.RGBA,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 65:this._glFormat=n.RGB,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;break;case 66:this._glFormat=n.RGB,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT;break;case 67:this._glFormat=n.RGBA,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGBA_BPTC_UNORM_EXT;break;case 54:this._glFormat=n.SRGB,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_S3TC_DXT1_EXT;break;case 55:this._glFormat=n.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;break;case 56:this._glFormat=n.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;break;case 61:this._glFormat=n.SRGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_SRGB8_ETC2;break;case 62:this._glFormat=n.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case 63:this._glFormat=n.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 68:this._glFormat=n.RGBA,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 50:this._glFormat=n.RED,this._glInternalFormat=n.R16F,this._glPixelType=n.HALF_FLOAT;break;case 51:this._glFormat=n.RG,this._glInternalFormat=n.RG16F,this._glPixelType=n.HALF_FLOAT;break;case 11:this._glFormat=n.RGB,this._glInternalFormat=n.RGB16F,this._glPixelType=n.HALF_FLOAT;break;case 12:this._glFormat=n.RGBA,this._glInternalFormat=n.RGBA16F,this._glPixelType=n.HALF_FLOAT;break;case 13:this._glFormat=n.RGB,this._glInternalFormat=n.RGB32F,this._glPixelType=n.FLOAT;break;case 14:this._glFormat=n.RGBA,this._glInternalFormat=n.RGBA32F,this._glPixelType=n.FLOAT;break;case 15:this._glFormat=n.RED,this._glInternalFormat=n.R32F,this._glPixelType=n.FLOAT;break;case 16:this._glFormat=n.DEPTH_COMPONENT,this._glInternalFormat=n.DEPTH_COMPONENT32F,this._glPixelType=n.FLOAT;break;case 69:this._glFormat=n.DEPTH_COMPONENT,this._glInternalFormat=n.DEPTH_COMPONENT16,this._glPixelType=n.UNSIGNED_SHORT;break;case 17:this._glFormat=n.DEPTH_STENCIL,this._glInternalFormat=n.DEPTH24_STENCIL8,this._glPixelType=n.UNSIGNED_INT_24_8;break;case 18:this._glFormat=n.RGB,this._glInternalFormat=n.R11F_G11F_B10F,this._glPixelType=n.UNSIGNED_INT_10F_11F_11F_REV;break;case 19:this._glFormat=n.RGB,this._glInternalFormat=n.SRGB8,this._glPixelType=n.UNSIGNED_BYTE;break;case 20:this._glFormat=n.RGBA,this._glInternalFormat=n.SRGB8_ALPHA8,this._glPixelType=n.UNSIGNED_BYTE;break;case 32:this._glFormat=n.RED_INTEGER,this._glInternalFormat=n.R8I,this._glPixelType=n.BYTE;break;case 33:this._glFormat=n.RED_INTEGER,this._glInternalFormat=n.R8UI,this._glPixelType=n.UNSIGNED_BYTE;break;case 34:this._glFormat=n.RED_INTEGER,this._glInternalFormat=n.R16I,this._glPixelType=n.SHORT;break;case 35:this._glFormat=n.RED_INTEGER,this._glInternalFormat=n.R16UI,this._glPixelType=n.UNSIGNED_SHORT;break;case 36:this._glFormat=n.RED_INTEGER,this._glInternalFormat=n.R32I,this._glPixelType=n.INT;break;case 37:this._glFormat=n.RED_INTEGER,this._glInternalFormat=n.R32UI,this._glPixelType=n.UNSIGNED_INT;break;case 38:this._glFormat=n.RG_INTEGER,this._glInternalFormat=n.RG8I,this._glPixelType=n.BYTE;break;case 39:this._glFormat=n.RG_INTEGER,this._glInternalFormat=n.RG8UI,this._glPixelType=n.UNSIGNED_BYTE;break;case 40:this._glFormat=n.RG_INTEGER,this._glInternalFormat=n.RG16I,this._glPixelType=n.SHORT;break;case 41:this._glFormat=n.RG_INTEGER,this._glInternalFormat=n.RG16UI,this._glPixelType=n.UNSIGNED_SHORT;break;case 42:this._glFormat=n.RG_INTEGER,this._glInternalFormat=n.RG32I,this._glPixelType=n.INT;break;case 43:this._glFormat=n.RG_INTEGER,this._glInternalFormat=n.RG32UI,this._glPixelType=n.UNSIGNED_INT;break;case 44:this._glFormat=n.RGBA_INTEGER,this._glInternalFormat=n.RGBA8I,this._glPixelType=n.BYTE;break;case 45:this._glFormat=n.RGBA_INTEGER,this._glInternalFormat=n.RGBA8UI,this._glPixelType=n.UNSIGNED_BYTE;break;case 46:this._glFormat=n.RGBA_INTEGER,this._glInternalFormat=n.RGBA16I,this._glPixelType=n.SHORT;break;case 47:this._glFormat=n.RGBA_INTEGER,this._glInternalFormat=n.RGBA16UI,this._glPixelType=n.UNSIGNED_SHORT;break;case 48:this._glFormat=n.RGBA_INTEGER,this._glInternalFormat=n.RGBA32I,this._glPixelType=n.INT;break;case 49:this._glFormat=n.RGBA_INTEGER,this._glInternalFormat=n.RGBA32UI,this._glPixelType=n.UNSIGNED_INT;}this._glCreated=false;},t.upload=function(e,t){var n,i,r=e.gl;if(t._needsUpload||(!t._needsMipmapsUpload||!t._mipmapsUploaded)&&t.pot){var s=0,a=t.numLevels;for(t.array&&!this._glCreated&&r.texStorage3D(r.TEXTURE_2D_ARRAY,a,this._glInternalFormat,t._width,t._height,t._arrayLength);t._levels[s]||0===s;){if(t._needsUpload||0!==s){if(s&&(!t._needsMipmapsUpload||!t._mipmaps))break}else {s++;continue}if(n=t._levels[s],i=1/Math.pow(2,s),1!==s||t._compressed||t._integerFormat||!(t._levels.length<a)||(r.generateMipmap(this._glTarget),t._mipmapsUploaded=true),t._cubemap){var o,l=void 0;if(e._isBrowserInterface(n[0])){for(l=0;l<6;l++)if(t._levelsUpdated[0][l]){var u=n[l];e._isImageBrowserInterface(u)&&(u.width>e.maxCubeMapSize||u.height>e.maxCubeMapSize)&&(u=sC(u,e.maxCubeMapSize),0===s&&(t._width=u.width,t._height=u.height)),e.setUnpackFlipY(false),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated?r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,s,0,0,this._glFormat,this._glPixelType,u):r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,s,this._glInternalFormat,this._glFormat,this._glPixelType,u);}}else for(l=0,i=1/Math.pow(2,s);l<6;l++)if(t._levelsUpdated[0][l]){var c=n[l];t._compressed?this._glCreated&&c?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,s,0,0,Math.max(t._width*i,1),Math.max(t._height*i,1),this._glInternalFormat,c):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,s,this._glInternalFormat,Math.max(t._width*i,1),Math.max(t._height*i,1),0,c):(e.setUnpackFlipY(false),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&c?r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,s,0,0,Math.max(t._width*i,1),Math.max(t._height*i,1),this._glFormat,this._glPixelType,c):r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,s,this._glInternalFormat,Math.max(t._width*i,1),Math.max(t._height*i,1),0,this._glFormat,this._glPixelType,c));}}else if(t._volume)t._compressed?r.compressedTexImage3D(r.TEXTURE_3D,s,this._glInternalFormat,Math.max(t._width*i,1),Math.max(t._height*i,1),Math.max(t._depth*i,1),0,n):(e.setUnpackFlipY(false),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),r.texImage3D(r.TEXTURE_3D,s,this._glInternalFormat,Math.max(t._width*i,1),Math.max(t._height*i,1),Math.max(t._depth*i,1),0,this._glFormat,this._glPixelType,n));else if(t.array&&(void 0===n?"undefined":(o=n)&&"undefined"!=typeof Symbol&&o.constructor===Symbol?"symbol":typeof o)=="object"){if(t._arrayLength===n.length)if(t._compressed)for(var h=0;h<t._arrayLength;h++)r.compressedTexSubImage3D(r.TEXTURE_2D_ARRAY,s,0,0,h,Math.max(Math.floor(t._width*i),1),Math.max(Math.floor(t._height*i),1),1,this._glInternalFormat,n[h]);else for(var f=0;f<t._arrayLength;f++)r.texSubImage3D(r.TEXTURE_2D_ARRAY,s,0,0,f,Math.max(Math.floor(t._width*i),1),Math.max(Math.floor(t._height*i),1),1,this._glFormat,this._glPixelType,n[f]);}else {if(e._isBrowserInterface(n)){e._isImageBrowserInterface(n)&&(n.width>e.maxTextureSize||n.height>e.maxTextureSize)&&(n=sC(n,e.maxTextureSize),0===s&&(t._width=n.width,t._height=n.height));var d=n.width||n.videoWidth,p=n.height||n.videoHeight;e.setUnpackFlipY(t._flipY),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&t._width===d&&t._height===p&&!e._isImageVideoInterface(n)?r.texSubImage2D(r.TEXTURE_2D,s,0,0,this._glFormat,this._glPixelType,n):(r.texImage2D(r.TEXTURE_2D,s,this._glInternalFormat,this._glFormat,this._glPixelType,n),0===s&&(t._width=d,t._height=p));}else i=1/Math.pow(2,s),t._compressed?this._glCreated&&n?r.compressedTexSubImage2D(r.TEXTURE_2D,s,0,0,Math.max(Math.floor(t._width*i),1),Math.max(Math.floor(t._height*i),1),this._glInternalFormat,n):r.compressedTexImage2D(r.TEXTURE_2D,s,this._glInternalFormat,Math.max(Math.floor(t._width*i),1),Math.max(Math.floor(t._height*i),1),0,n):(e.setUnpackFlipY(false),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&n?r.texSubImage2D(r.TEXTURE_2D,s,0,0,Math.max(t._width*i,1),Math.max(t._height*i,1),this._glFormat,this._glPixelType,n):r.texImage2D(r.TEXTURE_2D,s,this._glInternalFormat,Math.max(t._width*i,1),Math.max(t._height*i,1),0,this._glFormat,this._glPixelType,n));0===s?t._mipmapsUploaded=false:t._mipmapsUploaded=true;}s++;}if(t._needsUpload)if(t._cubemap)for(var m=0;m<6;m++)t._levelsUpdated[0][m]=false;else t._levelsUpdated[0]=false;!t._compressed&&!t._integerFormat&&t._mipmaps&&t._needsMipmapsUpload&&1===t._levels.length&&(r.generateMipmap(this._glTarget),t._mipmapsUploaded=true),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize),this._glCreated=true;}},t.uploadImmediate=function(e,t){(t._needsUpload||t._needsMipmapsUpload)&&(e.setTexture(t,0),t._needsUpload=false,t._needsMipmapsUpload=false);},t.read=function(e,t,n,i,r){var s=this.texture;return s.device.readTextureAsync(s,e,t,n,i,r)},t.write=function(e,t,n,i,r){var s=this.texture,a=s.device;return a.setTexture(s,0),a.writeTextureAsync(s,e,t,n,i,r)},e}(),sI=function(){function e(e,t){this.msaaFB=e,this.resolveFB=t;}return e.prototype.destroy=function(e){this.msaaFB&&(e.deleteRenderbuffer(this.msaaFB),this.msaaFB=null),this.resolveFB&&(e.deleteRenderbuffer(this.resolveFB),this.resolveFB=null);},e}(),sL=function(){function e(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this.colorMrtFramebuffers=null,this._glMsaaColorBuffers=[],this._glMsaaDepthBuffer=null,this._isInitialized=false;}var t,n=e.prototype;return n.destroy=function(e){var t,n=e.gl;this._isInitialized=false,this._glFrameBuffer&&(this._glFrameBuffer!==this.suppliedColorFramebuffer&&n.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(n.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(this._glResolveFrameBuffer!==this.suppliedColorFramebuffer&&n.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffers.forEach(function(e){n.deleteRenderbuffer(e);}),this._glMsaaColorBuffers.length=0,null==(t=this.colorMrtFramebuffers)||t.forEach(function(e){e.destroy(n);}),this.colorMrtFramebuffers=null,this._glMsaaDepthBuffer&&(this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey&&iH(e).release(this.msaaDepthBufferKey)),this.suppliedColorFramebuffer=void 0;},n.init=function(e,t){var n=e.gl;this._isInitialized=true;var i=[];if(void 0!==this.suppliedColorFramebuffer)this._glFrameBuffer=this.suppliedColorFramebuffer;else {this._glFrameBuffer=n.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);for(var r,s,a=null!=(s=null==(r=t._colorBuffers)?void 0:r.length)?s:0,o=n.COLOR_ATTACHMENT0,l=0;l<a;++l){var u=t.getColorBuffer(l);u&&(u.impl._glTexture||(u._width=Math.min(u.width,e.maxRenderBufferSize),u._height=Math.min(u.height,e.maxRenderBufferSize),e.setTexture(u,0)),n.framebufferTexture2D(n.FRAMEBUFFER,o+l,u._cubemap?n.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:n.TEXTURE_2D,u.impl._glTexture,t.mipLevel),i.push(o+l));}n.drawBuffers(i);var c=t._depthBuffer;if(c||t._depth){var h=t._stencil?n.DEPTH_STENCIL_ATTACHMENT:n.DEPTH_ATTACHMENT;if(c)c.impl._glTexture||(c._width=Math.min(c.width,e.maxRenderBufferSize),c._height=Math.min(c.height,e.maxRenderBufferSize),e.setTexture(c,0)),n.framebufferTexture2D(n.FRAMEBUFFER,h,c._cubemap?n.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:n.TEXTURE_2D,t._depthBuffer.impl._glTexture,t.mipLevel);else if(!(t._samples>1)){this._glDepthBuffer||(this._glDepthBuffer=n.createRenderbuffer());var f=t._stencil?n.DEPTH24_STENCIL8:n.DEPTH_COMPONENT32F;n.bindRenderbuffer(n.RENDERBUFFER,this._glDepthBuffer),n.renderbufferStorage(n.RENDERBUFFER,f,t.width,t.height),n.framebufferRenderbuffer(n.FRAMEBUFFER,h,n.RENDERBUFFER,this._glDepthBuffer),n.bindRenderbuffer(n.RENDERBUFFER,null);}}}if(t._samples>1){this._glResolveFrameBuffer=this._glFrameBuffer,this._glFrameBuffer=n.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);var d=null!=(S=null==(y=t._colorBuffers)?void 0:y.length)?S:0;if(void 0!==this.suppliedColorFramebuffer){var p=n.createRenderbuffer();this._glMsaaColorBuffers.push(p);var m=7===e.backBufferFormat?n.RGBA8:n.RGB8;n.bindRenderbuffer(n.RENDERBUFFER,p),n.renderbufferStorageMultisample(n.RENDERBUFFER,t._samples,m,t.width,t.height),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.RENDERBUFFER,p);}else for(var _=0;_<d;++_){var v=t.getColorBuffer(_);if(v){var g=n.createRenderbuffer();this._glMsaaColorBuffers.push(g),n.bindRenderbuffer(n.RENDERBUFFER,g),n.renderbufferStorageMultisample(n.RENDERBUFFER,t._samples,v.impl._glInternalFormat,t.width,t.height),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+_,n.RENDERBUFFER,g);}}if(t._depth){var y,S,x,b=t._stencil?n.DEPTH24_STENCIL8:n.DEPTH_COMPONENT32F,T=t._stencil?n.DEPTH_STENCIL_ATTACHMENT:n.DEPTH_ATTACHMENT,E=t._depthBuffer;E&&(x=E.id+":"+t.width+":"+t.height+":"+t._samples+":"+b+":"+T,this._glMsaaDepthBuffer=iH(e).get(x)),!this._glMsaaDepthBuffer&&(this._glMsaaDepthBuffer=n.createRenderbuffer(),n.bindRenderbuffer(n.RENDERBUFFER,this._glMsaaDepthBuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t._samples,b,t.width,t.height),this._glMsaaDepthBuffer.destroy=function(){n.deleteRenderbuffer(this);},E&&iH(e).set(x,this._glMsaaDepthBuffer)),this.msaaDepthBufferKey=x,n.framebufferRenderbuffer(n.FRAMEBUFFER,T,n.RENDERBUFFER,this._glMsaaDepthBuffer);}d>1&&(this._createMsaaMrtFramebuffers(e,t,d),e.setFramebuffer(this._glFrameBuffer),n.drawBuffers(i));}},n._createMsaaMrtFramebuffers=function(e,t,n){var i=e.gl;this.colorMrtFramebuffers=[];for(var r=0;r<n;++r){var s=t.getColorBuffer(r),a=i.createFramebuffer();e.setFramebuffer(a);var o=this._glMsaaColorBuffers[r];i.bindRenderbuffer(i.RENDERBUFFER,o),i.renderbufferStorageMultisample(i.RENDERBUFFER,t._samples,s.impl._glInternalFormat,t.width,t.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.RENDERBUFFER,o),i.drawBuffers([i.COLOR_ATTACHMENT0]);var l=i.createFramebuffer();e.setFramebuffer(l),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,s._cubemap?i.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:i.TEXTURE_2D,s.impl._glTexture,0),this.colorMrtFramebuffers[r]=new sI(a,l);}},n._checkFbo=function(e,t,n){var i=e.gl;switch(i.checkFramebufferStatus(i.FRAMEBUFFER)){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:case i.FRAMEBUFFER_UNSUPPORTED:}},n.loseContext=function(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffers.length=0,this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey=void 0,this.colorMrtFramebuffers=null,this.suppliedColorFramebuffer=void 0,this._isInitialized=false;},n.internalResolve=function(e,t,n,i,r){e.setScissor(0,0,i.width,i.height);var s=e.gl;s.bindFramebuffer(s.READ_FRAMEBUFFER,t),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,n),s.blitFramebuffer(0,0,i.width,i.height,0,0,i.width,i.height,r,s.NEAREST);},n.resolve=function(e,t,n,i){var r=e.gl;if(this.colorMrtFramebuffers){if(n)for(var s=0;s<this.colorMrtFramebuffers.length;s++){var a=this.colorMrtFramebuffers[s];this.internalResolve(e,a.msaaFB,a.resolveFB,t,r.COLOR_BUFFER_BIT);}i&&this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,r.DEPTH_BUFFER_BIT);}else this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,(n?r.COLOR_BUFFER_BIT:0)|(i?r.DEPTH_BUFFER_BIT:0));r.bindFramebuffer(r.FRAMEBUFFER,this._glFrameBuffer);},t=[{key:"initialized",get:function(){return this._isInitialized}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function sD(e,t){return (sD=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var sM=function(){function e(){this.queries=[];}return e.prototype.destroy=function(e){this.queries.forEach(function(t){return e.deleteQuery(t)}),this.queries=null;},e}(),sR=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this).freeQueries=[],n.frameQueries=[],n.previousFrameQueries=[],n.timings=[],n.device=t,n.ext=t.extDisjointTimerQuery,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&sD(t,e);var n=t.prototype;return n.destroy=function(){var e=this;this.freeQueries.forEach(function(t){return e.device.gl.deleteQuery(t)}),this.frameQueries.forEach(function(t){return e.device.gl.deleteQuery(t)}),this.previousFrameQueries.forEach(function(t){return t.destroy(e.device.gl)}),this.freeQueries=null,this.frameQueries=null,this.previousFrameQueries=null;},n.loseContext=function(){e.prototype.loseContext.call(this),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[];},n.restoreContext=function(){this.ext=this.device.extDisjointTimerQuery;},n.getQuery=function(){var e;return null!=(e=this.freeQueries.pop())?e:this.device.gl.createQuery()},n.start=function(e){if(this.ext){var t=this.getSlot(e),n=this.getQuery();return this.frameQueries[t]=n,this.device.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,n),t}},n.end=function(e){ void 0!==e&&this.device.gl.endQuery(this.ext.TIME_ELAPSED_EXT);},n.frameStart=function(){this.processEnableRequest(),this._enabled&&(this.frameGPUMarkerSlot=this.start("GpuFrame"));},n.frameEnd=function(){this._enabled&&this.end(this.frameGPUMarkerSlot);},n.request=function(){var t=this;if(this._enabled){var n=this.ext,i=this.device.gl,r=this.device.renderVersion,s=this.frameQueries;if(s.length>0){this.frameQueries=[];var a=new sM;a.queries=s,a.renderVersion=r,this.previousFrameQueries.push(a);}if(this.previousFrameQueries.length>0){var o=this.previousFrameQueries[0],l=o.queries,u=l[l.length-1],c=i.getQueryParameter(u,i.QUERY_RESULT_AVAILABLE),h=i.getParameter(n.GPU_DISJOINT_EXT);if(c&&!h){this.previousFrameQueries.shift();var f=this.timings;f.length=0;for(var d=0;d<l.length;d++){var p=l[d],m=i.getQueryParameter(p,i.QUERY_RESULT);f[d]=1e-6*m,this.freeQueries.push(p);}this.report(o.renderVersion,f);}h&&(this.previousFrameQueries.forEach(function(e){t.report(e.renderVersion,null),e.destroy(i);}),this.previousFrameQueries.length=0);}e.prototype.request.call(this,r);}},t}(sn);function sO(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function sk(e,t,n,i,r,s,a){try{var o=e[s](a),l=o.value;}catch(e){n(e);return}o.done?t(l):Promise.resolve(l).then(i,r);}function sN(e){return function(){var t=this,n=arguments;return new Promise(function(i,r){var s=e.apply(t,n);function a(e){sk(s,i,r,a,o,"next",e);}function o(e){sk(s,i,r,a,o,"throw",e);}a(void 0);})}}function sF(e,t){return (sF=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function sB(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return sO(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return sO(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function sU(e,t){var n,i,r,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(l){var u=[o,l];if(n)throw TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(s=0)),s;)try{if(n=1,i&&(r=2&u[0]?i.return:u[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,u[1])).done)return r;switch(i=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,i=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===u[0]||2===u[0])){s=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){s.label=u[1];break}if(6===u[0]&&s.label<r[1]){s.label=r[1],r=u;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(u);break}r[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s);}catch(e){u=[6,e],i=0;}finally{n=r=0;}if(5&u[0])throw u[1];return {value:u[0]?u[1]:void 0,done:true}}}}var sz=[],sV=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){ void 0===n&&(n={}),(i=e.call(this,t,n)||this)._defaultFramebuffer=null,i._defaultFramebufferChanged=false,n=i.initOptions,i.updateClientRect(),i.initTextureUnits(),i.contextLost=false,i._contextLostHandler=function(e){e.preventDefault(),i.loseContext(),i.fire("devicelost");},i._contextRestoredHandler=function(){i.restoreContext(),i.fire("devicerestored");};var i,r,s,a,o,l,u,c,h="undefined"!=typeof navigator&&navigator.userAgent;if(i.forceDisableMultisampling=h&&h.includes("AppleWebKit")&&(h.includes("15.4")||h.includes("15_4")),i.forceDisableMultisampling&&(n.antialias=false),"firefox"===ef.browserName){var f=("undefined"!=typeof navigator?navigator.userAgent:"").match(/Firefox\/(\d+(\.\d+)*)/),d=f?f[1]:null;if(d){var p=parseFloat(d);("windows"===ef.name&&(p>=120||115===p)||"android"===ef.name&&p>=132)&&(n.antialias=false);}}i.backBufferAntialias=null!=(r=n.antialias)&&r,n.antialias=false;var m=null!=(s=n.gl)?s:t.getContext("webgl2",n);if(!m)throw Error("WebGL not supported");i.gl=m,i.isWebGL2=true,i._deviceType=nl,i.updateBackbufferFormat(null);var _="chrome"===ef.browserName,v="safari"===ef.browserName,g=ef.browser&&-1!==navigator.appVersion.indexOf("Mac");return i._tempEnableSafariTextureUnitWorkaround=v,i._tempMacChromeBlitFramebufferWorkaround=g&&_&&!n.alpha,t.addEventListener("webglcontextlost",i._contextLostHandler,false),t.addEventListener("webglcontextrestored",i._contextRestoredHandler,false),i.initializeExtensions(),i.initializeCapabilities(),i.initializeRenderState(),i.initializeContextCaches(),i.createBackbuffer(null),i.supportsImageBitmap=!v&&"undefined"!=typeof ImageBitmap,i._samplerTypes=new Set([m.SAMPLER_2D,m.SAMPLER_CUBE,m.UNSIGNED_INT_SAMPLER_2D,m.INT_SAMPLER_2D,m.SAMPLER_2D_SHADOW,m.SAMPLER_CUBE_SHADOW,m.SAMPLER_3D,m.INT_SAMPLER_3D,m.UNSIGNED_INT_SAMPLER_3D,m.SAMPLER_2D_ARRAY,m.INT_SAMPLER_2D_ARRAY,m.UNSIGNED_INT_SAMPLER_2D_ARRAY]),i.glAddress=[m.REPEAT,m.CLAMP_TO_EDGE,m.MIRRORED_REPEAT],i.glBlendEquation=[m.FUNC_ADD,m.FUNC_SUBTRACT,m.FUNC_REVERSE_SUBTRACT,m.MIN,m.MAX],i.glBlendFunctionColor=[m.ZERO,m.ONE,m.SRC_COLOR,m.ONE_MINUS_SRC_COLOR,m.DST_COLOR,m.ONE_MINUS_DST_COLOR,m.SRC_ALPHA,m.SRC_ALPHA_SATURATE,m.ONE_MINUS_SRC_ALPHA,m.DST_ALPHA,m.ONE_MINUS_DST_ALPHA,m.CONSTANT_COLOR,m.ONE_MINUS_CONSTANT_COLOR],i.glBlendFunctionAlpha=[m.ZERO,m.ONE,m.SRC_COLOR,m.ONE_MINUS_SRC_COLOR,m.DST_COLOR,m.ONE_MINUS_DST_COLOR,m.SRC_ALPHA,m.SRC_ALPHA_SATURATE,m.ONE_MINUS_SRC_ALPHA,m.DST_ALPHA,m.ONE_MINUS_DST_ALPHA,m.CONSTANT_ALPHA,m.ONE_MINUS_CONSTANT_ALPHA],i.glComparison=[m.NEVER,m.LESS,m.EQUAL,m.LEQUAL,m.GREATER,m.NOTEQUAL,m.GEQUAL,m.ALWAYS],i.glStencilOp=[m.KEEP,m.ZERO,m.REPLACE,m.INCR,m.INCR_WRAP,m.DECR,m.DECR_WRAP,m.INVERT],i.glClearFlag=[0,m.COLOR_BUFFER_BIT,m.DEPTH_BUFFER_BIT,m.COLOR_BUFFER_BIT|m.DEPTH_BUFFER_BIT,m.STENCIL_BUFFER_BIT,m.STENCIL_BUFFER_BIT|m.COLOR_BUFFER_BIT,m.STENCIL_BUFFER_BIT|m.DEPTH_BUFFER_BIT,m.STENCIL_BUFFER_BIT|m.COLOR_BUFFER_BIT|m.DEPTH_BUFFER_BIT],i.glCull=[0,m.BACK,m.FRONT,m.FRONT_AND_BACK],i.glFilter=[m.NEAREST,m.LINEAR,m.NEAREST_MIPMAP_NEAREST,m.NEAREST_MIPMAP_LINEAR,m.LINEAR_MIPMAP_NEAREST,m.LINEAR_MIPMAP_LINEAR],i.glPrimitive=[m.POINTS,m.LINES,m.LINE_LOOP,m.LINE_STRIP,m.TRIANGLES,m.TRIANGLE_STRIP,m.TRIANGLE_FAN],i.glType=[m.BYTE,m.UNSIGNED_BYTE,m.SHORT,m.UNSIGNED_SHORT,m.INT,m.UNSIGNED_INT,m.FLOAT,m.HALF_FLOAT],i.pcUniformType={},i.pcUniformType[m.BOOL]=0,i.pcUniformType[m.INT]=1,i.pcUniformType[m.FLOAT]=2,i.pcUniformType[m.FLOAT_VEC2]=3,i.pcUniformType[m.FLOAT_VEC3]=4,i.pcUniformType[m.FLOAT_VEC4]=5,i.pcUniformType[m.INT_VEC2]=6,i.pcUniformType[m.INT_VEC3]=7,i.pcUniformType[m.INT_VEC4]=8,i.pcUniformType[m.BOOL_VEC2]=9,i.pcUniformType[m.BOOL_VEC3]=10,i.pcUniformType[m.BOOL_VEC4]=11,i.pcUniformType[m.FLOAT_MAT2]=12,i.pcUniformType[m.FLOAT_MAT3]=13,i.pcUniformType[m.FLOAT_MAT4]=14,i.pcUniformType[m.SAMPLER_2D]=15,i.pcUniformType[m.SAMPLER_CUBE]=16,i.pcUniformType[m.UNSIGNED_INT]=26,i.pcUniformType[m.UNSIGNED_INT_VEC2]=27,i.pcUniformType[m.UNSIGNED_INT_VEC3]=28,i.pcUniformType[m.UNSIGNED_INT_VEC4]=29,i.pcUniformType[m.SAMPLER_2D_SHADOW]=18,i.pcUniformType[m.SAMPLER_CUBE_SHADOW]=19,i.pcUniformType[m.SAMPLER_2D_ARRAY]=25,i.pcUniformType[m.SAMPLER_3D]=20,i.pcUniformType[m.INT_SAMPLER_2D]=42,i.pcUniformType[m.UNSIGNED_INT_SAMPLER_2D]=43,i.pcUniformType[m.INT_SAMPLER_CUBE]=44,i.pcUniformType[m.UNSIGNED_INT_SAMPLER_2D]=45,i.pcUniformType[m.INT_SAMPLER_3D]=46,i.pcUniformType[m.UNSIGNED_INT_SAMPLER_3D]=47,i.pcUniformType[m.INT_SAMPLER_2D_ARRAY]=48,i.pcUniformType[m.UNSIGNED_INT_SAMPLER_2D_ARRAY]=49,i.targetToSlot={},i.targetToSlot[m.TEXTURE_2D]=0,i.targetToSlot[m.TEXTURE_CUBE_MAP]=1,i.targetToSlot[m.TEXTURE_3D]=2,i.commitFunction=[],i.commitFunction[0]=function(e,t){e.value!==t&&(m.uniform1i(e.locationId,t),e.value=t);},i.commitFunction[1]=i.commitFunction[0],i.commitFunction[2]=function(e,t){e.value!==t&&(m.uniform1f(e.locationId,t),e.value=t);},i.commitFunction[3]=function(e,t){c=e.value,a=t[0],o=t[1],(c[0]!==a||c[1]!==o)&&(m.uniform2fv(e.locationId,t),c[0]=a,c[1]=o);},i.commitFunction[4]=function(e,t){c=e.value,a=t[0],o=t[1],l=t[2],(c[0]!==a||c[1]!==o||c[2]!==l)&&(m.uniform3fv(e.locationId,t),c[0]=a,c[1]=o,c[2]=l);},i.commitFunction[5]=function(e,t){c=e.value,a=t[0],o=t[1],l=t[2],u=t[3],(c[0]!==a||c[1]!==o||c[2]!==l||c[3]!==u)&&(m.uniform4fv(e.locationId,t),c[0]=a,c[1]=o,c[2]=l,c[3]=u);},i.commitFunction[6]=function(e,t){c=e.value,a=t[0],o=t[1],(c[0]!==a||c[1]!==o)&&(m.uniform2iv(e.locationId,t),c[0]=a,c[1]=o);},i.commitFunction[9]=i.commitFunction[6],i.commitFunction[7]=function(e,t){c=e.value,a=t[0],o=t[1],l=t[2],(c[0]!==a||c[1]!==o||c[2]!==l)&&(m.uniform3iv(e.locationId,t),c[0]=a,c[1]=o,c[2]=l);},i.commitFunction[10]=i.commitFunction[7],i.commitFunction[8]=function(e,t){c=e.value,a=t[0],o=t[1],l=t[2],u=t[3],(c[0]!==a||c[1]!==o||c[2]!==l||c[3]!==u)&&(m.uniform4iv(e.locationId,t),c[0]=a,c[1]=o,c[2]=l,c[3]=u);},i.commitFunction[11]=i.commitFunction[8],i.commitFunction[12]=function(e,t){m.uniformMatrix2fv(e.locationId,false,t);},i.commitFunction[13]=function(e,t){m.uniformMatrix3fv(e.locationId,false,t);},i.commitFunction[14]=function(e,t){m.uniformMatrix4fv(e.locationId,false,t);},i.commitFunction[17]=function(e,t){m.uniform1fv(e.locationId,t);},i.commitFunction[21]=function(e,t){m.uniform2fv(e.locationId,t);},i.commitFunction[22]=function(e,t){m.uniform3fv(e.locationId,t);},i.commitFunction[23]=function(e,t){m.uniform4fv(e.locationId,t);},i.commitFunction[26]=function(e,t){e.value!==t&&(m.uniform1ui(e.locationId,t),e.value=t);},i.commitFunction[27]=function(e,t){c=e.value,a=t[0],o=t[1],(c[0]!==a||c[1]!==o)&&(m.uniform2uiv(e.locationId,t),c[0]=a,c[1]=o);},i.commitFunction[28]=function(e,t){c=e.value,a=t[0],o=t[1],l=t[2],(c[0]!==a||c[1]!==o||c[2]!==l)&&(m.uniform3uiv(e.locationId,t),c[0]=a,c[1]=o,c[2]=l);},i.commitFunction[29]=function(e,t){c=e.value,a=t[0],o=t[1],l=t[2],u=t[3],(c[0]!==a||c[1]!==o||c[2]!==l||c[3]!==u)&&(m.uniform4uiv(e.locationId,t),c[0]=a,c[1]=o,c[2]=l,c[3]=u);},i.commitFunction[30]=function(e,t){m.uniform1iv(e.locationId,t);},i.commitFunction[31]=function(e,t){m.uniform1uiv(e.locationId,t);},i.commitFunction[32]=i.commitFunction[30],i.commitFunction[33]=function(e,t){m.uniform2iv(e.locationId,t);},i.commitFunction[34]=function(e,t){m.uniform2uiv(e.locationId,t);},i.commitFunction[35]=i.commitFunction[33],i.commitFunction[36]=function(e,t){m.uniform3iv(e.locationId,t);},i.commitFunction[37]=function(e,t){m.uniform3uiv(e.locationId,t);},i.commitFunction[38]=i.commitFunction[36],i.commitFunction[39]=function(e,t){m.uniform4iv(e.locationId,t);},i.commitFunction[40]=function(e,t){m.uniform4uiv(e.locationId,t);},i.commitFunction[41]=i.commitFunction[39],i.commitFunction[24]=function(e,t){m.uniformMatrix4fv(e.locationId,false,t);},i.constantTexSource=i.scope.resolve("source"),i.postInit(),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&sF(t,e);var n,r=t.prototype;return r.postInit=function(){e.prototype.postInit.call(this),this.gpuProfiler=new sR(this);},r.destroy=function(){e.prototype.destroy.call(this);var t=this.gl;this.feedback&&t.deleteTransformFeedback(this.feedback),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,false),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,false),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,e.prototype.postDestroy.call(this);},r.createBackbuffer=function(e){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new il({name:"WebglFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.suppliedColorFramebuffer=e;},r.updateBackbufferFormat=function(e){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e);var n=this.gl.getParameter(this.gl.ALPHA_BITS);this.backBufferFormat=n?7:6;},r.updateBackbuffer=function(){var e=this.canvas.width!==this.backBufferSize.x||this.canvas.height!==this.backBufferSize.y;(this._defaultFramebufferChanged||e)&&(this._defaultFramebufferChanged&&this.updateBackbufferFormat(this._defaultFramebuffer),this._defaultFramebufferChanged=false,this.backBufferSize.set(this.canvas.width,this.canvas.height),this.backBuffer.destroy(),this.createBackbuffer(this._defaultFramebuffer));},r.createVertexBufferImpl=function(e,t){return new sg},r.createIndexBufferImpl=function(e){return new sS(e)},r.createShaderImpl=function(e){return new sA(e)},r.createTextureImpl=function(e){return new sP(e)},r.createRenderTargetImpl=function(e){return new sL},r.getPrecision=function(){var e=this.gl,t="highp";if(e.getShaderPrecisionFormat){var n=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT),i=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT),r=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT),s=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT);if(n&&i&&r&&s){var a=n.precision>0&&r.precision>0,o=i.precision>0&&s.precision>0;a||(t=o?"mediump":"lowp");}}return t},r.getExtension=function(){for(var e=0;e<arguments.length;e++)if(-1!==this.supportedExtensions.indexOf(arguments[e]))return this.gl.getExtension(arguments[e]);return null},r.initializeExtensions=function(){var e,t=this.gl;this.supportedExtensions=null!=(e=t.getSupportedExtensions())?e:[],this._extDisjointTimerQuery=null,this.textureRG11B10Renderable=true,this.extColorBufferFloat=this.getExtension("EXT_color_buffer_float"),this.textureFloatRenderable=!!this.extColorBufferFloat,this.extColorBufferHalfFloat=this.getExtension("EXT_color_buffer_half_float"),this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat||!!this.extColorBufferFloat,this.extDebugRendererInfo=this.getExtension("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=this.getExtension("OES_texture_float_linear"),this.textureFloatFilterable=!!this.extTextureFloatLinear,this.extFloatBlend=this.getExtension("EXT_float_blend"),this.extTextureFilterAnisotropic=this.getExtension("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extParallelShaderCompile=this.getExtension("KHR_parallel_shader_compile"),this.extCompressedTextureETC1=this.getExtension("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=this.getExtension("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=this.getExtension("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=this.getExtension("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureS3TC_SRGB=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.extCompressedTextureATC=this.getExtension("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=this.getExtension("WEBGL_compressed_texture_astc"),this.extTextureCompressionBPTC=this.getExtension("EXT_texture_compression_bptc");},r.initializeCapabilities=function(){var e,t,n,i=this.gl,r="undefined"!=typeof navigator?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();var s=i.getContextAttributes();this.supportsMsaa=null!=(t=null==s?void 0:s.antialias)&&t,this.supportsStencil=null!=(n=null==s?void 0:s.stencil)&&n,this.maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),this.maxCubeMapSize=i.getParameter(i.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=i.getParameter(i.MAX_RENDERBUFFER_SIZE),this.maxTextures=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=i.getParameter(i.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),this.maxColorAttachments=i.getParameter(i.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=i.getParameter(i.MAX_3D_TEXTURE_SIZE),e=this.extDebugRendererInfo,this.unmaskedRenderer=e?i.getParameter(e.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=e?i.getParameter(e.UNMASKED_VENDOR_WEBGL):"",this.supportsGpuParticles=!("ARM"===this.unmaskedVendor&&r.match(/SM-[a-zA-Z0-9]+/))&&!this.unmaskedRenderer.match(/\bMali-G52+/),e=this.extTextureFilterAnisotropic,this.maxAnisotropy=e?i.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1;var a=!this.forceDisableMultisampling;this.maxSamples=a?i.getParameter(i.MAX_SAMPLES):1,this.maxSamples=Math.min(this.maxSamples,4),this.samples=a&&this.backBufferAntialias?this.maxSamples:1,this.supportsAreaLights=!ef.android,this.maxTextures<=8&&(this.supportsAreaLights=false),this.initCapsDefines();},r.initializeRenderState=function(){e.prototype.initializeRenderState.call(this);var t=this.gl;t.disable(t.BLEND),t.blendFunc(t.ONE,t.ZERO),t.blendEquation(t.FUNC_ADD),t.colorMask(true,true,true,true),t.blendColor(0,0,0,0),t.enable(t.CULL_FACE),this.cullFace=t.BACK,t.cullFace(t.BACK),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.depthMask(true),this.stencil=false,t.disable(t.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=7,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,t.stencilFunc(t.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=0,this.stencilZfailFront=this.stencilZfailBack=0,this.stencilZpassFront=this.stencilZpassBack=0,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.stencilMask(255),this.alphaToCoverage=false,this.raster=true,t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.RASTERIZER_DISCARD),this.depthBiasEnabled=false,t.disable(t.POLYGON_OFFSET_FILL),this.clearDepth=1,t.clearDepth(1),this.clearColor=new eN(0,0,0,0),t.clearColor(0,0,0,0),this.clearStencil=0,t.clearStencil(0),t.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT,t.NICEST),t.enable(t.SCISSOR_TEST),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE),this.unpackFlipY=false,t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,false),this.unpackPremultiplyAlpha=false,t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false),t.pixelStorei(t.UNPACK_ALIGNMENT,1);},r.initTextureUnits=function(e){ void 0===e&&(e=16),this.textureUnits=[];for(var t=0;t<e;t++)this.textureUnits.push([null,null,null]);},r.initializeContextCaches=function(){e.prototype.initializeContextCaches.call(this),this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.initTextureUnits(this.maxCombinedTextures);},r.loseContext=function(){e.prototype.loseContext.call(this);for(var t,n=sB(this.shaders);!(t=n()).done;)t.value.loseContext();},r.restoreContext=function(){this.initializeExtensions(),this.initializeCapabilities(),e.prototype.restoreContext.call(this);for(var t,n=sB(this.shaders);!(t=n()).done;)t.value.restoreContext();},r.setViewport=function(e,t,n,i){(this.vx!==e||this.vy!==t||this.vw!==n||this.vh!==i)&&(this.gl.viewport(e,t,n,i),this.vx=e,this.vy=t,this.vw=n,this.vh=i);},r.setScissor=function(e,t,n,i){(this.sx!==e||this.sy!==t||this.sw!==n||this.sh!==i)&&(this.gl.scissor(e,t,n,i),this.sx=e,this.sy=t,this.sw=n,this.sh=i);},r.setFramebuffer=function(e){if(this.activeFramebuffer!==e){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e),this.activeFramebuffer=e;}},r.copyRenderTarget=function(e,t,n,i){var r,s,a=this.gl;if(e===this.backBuffer&&(e=null),n){if(t){if(e&&(!e._colorBuffer||!t._colorBuffer||e._colorBuffer._format!==t._colorBuffer._format))return  false}else if(!e._colorBuffer)return  false}if(i&&e&&!e._depth&&(!e._depthBuffer||!t._depthBuffer||e._depthBuffer._format!==t._depthBuffer._format))return  false;var o=this.renderTarget;this.renderTarget=t,this.updateBegin();var l=e?e.impl._glFrameBuffer:null==(r=this.backBuffer)?void 0:r.impl._glFrameBuffer,u=t?t.impl._glFrameBuffer:null==(s=this.backBuffer)?void 0:s.impl._glFrameBuffer;a.bindFramebuffer(a.READ_FRAMEBUFFER,l),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,u);var c=e?e.width:t?t.width:this.width,h=e?e.height:t?t.height:this.height;return a.blitFramebuffer(0,0,c,h,0,0,c,h,(n?a.COLOR_BUFFER_BIT:0)|(i?a.DEPTH_BUFFER_BIT:0),a.NEAREST),this.renderTarget=o,a.bindFramebuffer(a.FRAMEBUFFER,o?o.impl._glFrameBuffer:null),true},r.frameStart=function(){e.prototype.frameStart.call(this),this.updateBackbuffer(),this.gpuProfiler.frameStart();},r.frameEnd=function(){e.prototype.frameEnd.call(this),this.gpuProfiler.frameEnd(),this.gpuProfiler.request();},r.startRenderPass=function(e){var t,n=null!=(t=e.renderTarget)?t:this.backBuffer;this.renderTarget=n,this.updateBegin();var i=n.width,r=n.height;this.setViewport(0,0,i,r),this.setScissor(0,0,i,r);var s=e.colorOps,a=e.depthStencilOps;if((null==s?void 0:s.clear)||a.clearDepth||a.clearStencil){var o=0,l={};(null==s?void 0:s.clear)&&(o|=1,l.color=[s.clearValue.r,s.clearValue.g,s.clearValue.b,s.clearValue.a]),a.clearDepth&&(o|=2,l.depth=a.clearDepthValue),a.clearStencil&&(o|=4,l.stencil=a.clearStencilValue),l.flags=o,this.clear(l);}this.insideRenderPass=true;},r.endRenderPass=function(e){this.unbindVertexArray();var t=this.renderTarget,n=e.colorArrayOps.length;if(t){sz.length=0;for(var i,r=this.gl,s=0;s<n;s++){var a=e.colorArrayOps[s];a.store||a.resolve||sz.push(r.COLOR_ATTACHMENT0+s);}t!==this.backBuffer&&(e.depthStencilOps.storeDepth||sz.push(r.DEPTH_ATTACHMENT),e.depthStencilOps.storeStencil||sz.push(r.STENCIL_ATTACHMENT)),sz.length>0&&e.fullSizeClearRect&&r.invalidateFramebuffer(r.DRAW_FRAMEBUFFER,sz),n&&(null==(i=e.colorOps)?void 0:i.resolve)&&e.samples>1&&t.autoResolve&&t.resolve(true,false),t.depthBuffer&&e.depthStencilOps.resolveDepth&&e.samples>1&&t.autoResolve&&t.resolve(false,true);for(var o=0;o<n;o++)if(e.colorArrayOps[o].genMipmaps){var l=t._colorBuffers[o];l&&l.impl._glTexture&&l.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(l),this.gl.generateMipmap(l.impl._glTarget));}}this.insideRenderPass=false;},r.updateBegin=function(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(var e,t=0;t<this.textureUnits.length;++t)for(var n=0;n<3;++n)this.textureUnits[t][n]=null;var i=null!=(e=this.renderTarget)?e:this.backBuffer,r=i.impl;r.initialized||this.initRenderTarget(i),this.setFramebuffer(r._glFrameBuffer);},r.updateEnd=function(){this.unbindVertexArray();var e=this.renderTarget;if(e&&e!==this.backBuffer){e._samples>1&&e.autoResolve&&e.resolve();var t=e._colorBuffer;t&&t.impl._glTexture&&t.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(t),this.gl.generateMipmap(t.impl._glTarget));}},r.setUnpackFlipY=function(e){if(this.unpackFlipY!==e){this.unpackFlipY=e;var t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e);}},r.setUnpackPremultiplyAlpha=function(e){if(this.unpackPremultiplyAlpha!==e){this.unpackPremultiplyAlpha=e;var t=this.gl;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e);}},r.activeTexture=function(e){this.textureUnit!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.textureUnit=e);},r.bindTexture=function(e){var t=e.impl,n=t._glTarget,i=t._glTexture,r=this.textureUnit,s=this.targetToSlot[n];this.textureUnits[r][s]!==i&&(this.gl.bindTexture(n,i),this.textureUnits[r][s]=i);},r.bindTextureOnUnit=function(e,t){var n=e.impl,i=n._glTarget,r=n._glTexture,s=this.targetToSlot[i];this.textureUnits[t][s]!==r&&(this.activeTexture(t),this.gl.bindTexture(i,r),this.textureUnits[t][s]=r);},r.setTextureParameters=function(e){var t=this.gl,n=e.impl.dirtyParameterFlags,i=e.impl._glTarget;if(1&n){var r=e._minFilter;(!e._mipmaps||e._compressed&&1===e._levels.length)&&(2===r||3===r?r=0:(4===r||5===r)&&(r=1)),t.texParameteri(i,t.TEXTURE_MIN_FILTER,this.glFilter[r]);}if(2&n&&t.texParameteri(i,t.TEXTURE_MAG_FILTER,this.glFilter[e._magFilter]),4&n&&t.texParameteri(i,t.TEXTURE_WRAP_S,this.glAddress[e._addressU]),8&n&&t.texParameteri(i,t.TEXTURE_WRAP_T,this.glAddress[e._addressV]),16&n&&t.texParameteri(i,t.TEXTURE_WRAP_R,this.glAddress[e._addressW]),32&n&&t.texParameteri(i,t.TEXTURE_COMPARE_MODE,e._compareOnRead?t.COMPARE_REF_TO_TEXTURE:t.NONE),64&n&&t.texParameteri(i,t.TEXTURE_COMPARE_FUNC,this.glComparison[e._compareFunc]),128&n){var s=this.extTextureFilterAnisotropic;s&&t.texParameterf(i,s.TEXTURE_MAX_ANISOTROPY_EXT,ek.clamp(Math.round(e._anisotropy),1,this.maxAnisotropy));}},r.setTexture=function(e,t){var n=e.impl;n._glTexture||n.initialize(this,e),n.dirtyParameterFlags>0||e._needsUpload||e._needsMipmapsUpload?(this.activeTexture(t),this.bindTexture(e),n.dirtyParameterFlags&&(this.setTextureParameters(e),n.dirtyParameterFlags=0),(e._needsUpload||e._needsMipmapsUpload)&&(n.upload(this,e),e._needsUpload=false,e._needsMipmapsUpload=false)):this.bindTextureOnUnit(e,t);},r.createVertexArray=function(e){var t,n,i=e.length>1;if(i){t="";for(var r=0;r<e.length;r++){var s=e[r];t+=s.id+s.format.renderingHash;}n=this._vaoMap.get(t);}if(!n){var a=this.gl;n=a.createVertexArray(),a.bindVertexArray(n),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);for(var o=0;o<e.length;o++){var l=e[o];a.bindBuffer(a.ARRAY_BUFFER,l.impl.bufferId);for(var u=l.format.elements,c=0;c<u.length;c++){var h=u[c],f=nS[h.name];h.asInt?a.vertexAttribIPointer(f,h.numComponents,this.glType[h.dataType],h.stride,h.offset):a.vertexAttribPointer(f,h.numComponents,this.glType[h.dataType],h.normalize,h.stride,h.offset),a.enableVertexAttribArray(f),l.format.instancing&&a.vertexAttribDivisor(f,1);}}a.bindVertexArray(null),a.bindBuffer(a.ARRAY_BUFFER,null),i&&this._vaoMap.set(t,n);}return n},r.unbindVertexArray=function(){this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null));},r.setBuffers=function(e){var t,n=this.gl;if(1===this.vertexBuffers.length){var i=this.vertexBuffers[0];i.impl.vao||(i.impl.vao=this.createVertexArray(this.vertexBuffers)),t=i.impl.vao;}else t=this.createVertexArray(this.vertexBuffers);this.boundVao!==t&&(this.boundVao=t,n.bindVertexArray(t));var r=e?e.impl.bufferId:null;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,r);},r.draw=function(e,t,n,r,s,a){ void 0===s&&(s=true),void 0===a&&(a=true);var o=this.shader;if(o&&(this.activateShader(),this.shaderValid)){var l=this.gl;s&&this.setBuffers(t);for(var u=0,c=o.impl.samplers,h=0,f=c.length;h<f;h++){var d,p=c[h],m=p.scopeId.value;if(!m){var _=p.scopeId.name;"uSceneDepthMap"===_&&(m=nB(this,"white")),"uSceneColorMap"===_&&(m=nB(this,"pink")),m||(m=nB(this,"pink"));}if(d=m,null!=nO&&"undefined"!=typeof Symbol&&nO[Symbol.hasInstance]?!!nO[Symbol.hasInstance](d):i(d,nO)){var v=m;this.setTexture(v,u),p.slot!==u&&(l.uniform1i(p.locationId,u),p.slot=u),u++;}else {p.array.length=0;for(var g=m.length,y=0;y<g;y++){var S=m[y];this.setTexture(S,u),p.array[y]=u,u++;}l.uniform1iv(p.locationId,p.array);}}for(var x=o.impl.uniforms,b=0,T=x.length;b<T;b++){var E=x[b],w=E.scopeId,A=E.version,C=w.versionObject.version;if(A.globalId!==C.globalId||A.revision!==C.revision){A.globalId=C.globalId,A.revision=C.revision;var P=w.value;null!=P&&this.commitFunction[E.dataType](E,P);}}this.transformFeedbackBuffer&&(l.bindBufferBase(l.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),l.beginTransformFeedback(l.POINTS));var I=this.glPrimitive[e.type],L=e.count;if(e.indexed){var D=t.impl.glFormat,M=e.base*t.bytesPerIndex;n>0?l.drawElementsInstanced(I,L,D,M,n):l.drawElements(I,L,D,M);}else {var R=e.base;n>0?l.drawArraysInstanced(I,R,L,n):l.drawArrays(I,R,L);}this.transformFeedbackBuffer&&(l.endTransformFeedback(),l.bindBufferBase(l.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++;}a&&this.clearVertexBuffer();},r.clear=function(e){var t=this.defaultClearOptions,n=null!=(r=(e=e||t).flags)?r:t.flags;if(0!==n){var i=this.gl;if(1&n){var r,s,a=null!=(s=e.color)?s:t.color,o=a[0],l=a[1],u=a[2],c=a[3],h=this.clearColor;(o!==h.r||l!==h.g||u!==h.b||c!==h.a)&&(this.gl.clearColor(o,l,u,c),this.clearColor.set(o,l,u,c)),this.setBlendState(nj.NOBLEND);}if(2&n){var f,d=null!=(f=e.depth)?f:t.depth;d!==this.clearDepth&&(this.gl.clearDepth(d),this.clearDepth=d),this.setDepthState(nq.WRITEDEPTH);}if(4&n){var p,m=null!=(p=e.stencil)?p:t.stencil;m!==this.clearStencil&&(this.gl.clearStencil(m),this.clearStencil=m),i.stencilMask(255),this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255;}i.clear(this.glClearFlag[n]);}},r.submit=function(){this.gl.flush();},r.readPixels=function(e,t,n,i,r){var s=this.gl;s.readPixels(e,t,n,i,s.RGBA,s.UNSIGNED_BYTE,r);},r.clientWaitAsync=function(e,t){var n=this.gl,i=n.fenceSync(n.SYNC_GPU_COMMANDS_COMPLETE,0);return this.submit(),new Promise(function(r,s){!function a(){var o=n.clientWaitSync(i,e,0);o===n.TIMEOUT_EXPIRED?setTimeout(a,t):(n.deleteSync(i),o===n.WAIT_FAILED?s(Error("webgl clientWaitSync sync failed")):r());}();})},r.readPixelsAsync=function(e,t,n,i,r){var s=this;return sN(function(){var a,o,l,u,c,h,f,d;return sU(this,function(p){switch(p.label){case 0:return o=s.gl,c=null!=(u=null==(l=null==(a=s.renderTarget.colorBuffer)?void 0:a.impl)?void 0:l._glFormat)?u:o.RGBA,f=null!=(h=null==l?void 0:l._glPixelType)?h:o.UNSIGNED_BYTE,d=o.createBuffer(),o.bindBuffer(o.PIXEL_PACK_BUFFER,d),o.bufferData(o.PIXEL_PACK_BUFFER,r.byteLength,o.STREAM_READ),o.readPixels(e,t,n,i,c,f,0),o.bindBuffer(o.PIXEL_PACK_BUFFER,null),[4,s.clientWaitAsync(0,16)];case 1:return p.sent(),o.bindBuffer(o.PIXEL_PACK_BUFFER,d),o.getBufferSubData(o.PIXEL_PACK_BUFFER,0,r),o.bindBuffer(o.PIXEL_PACK_BUFFER,null),o.deleteBuffer(d),[2,r]}})})()},r.readTextureAsync=function(e,t,n,i,r,s){var a,o,l,u=this,c=null!=(a=s.face)?a:0,h=null!=(o=s.renderTarget)?o:new il({colorBuffer:e,depth:false,face:c}),f=new ArrayBuffer(nM.calcLevelGpuSize(i,r,1,e._format)),d=null!=(l=s.data)?l:new(tb(e._format))(f);return this.setRenderTarget(h),this.initRenderTarget(h),new Promise(function(e,a){u.readPixelsAsync(t,n,i,r,d).then(function(t){s.renderTarget||h.destroy(),e(t);}).catch(a);})},r.writeTextureAsync=function(e,t,n,i,r,s){var a=this;return sN(function(){var o,l,u,c,h,f,d;return sU(this,function(p){switch(p.label){case 0:return o=a.gl,c=null!=(u=null==(l=e.impl)?void 0:l._glFormat)?u:o.RGBA,f=null!=(h=null==l?void 0:l._glPixelType)?h:o.UNSIGNED_BYTE,d=o.createBuffer(),o.bindBuffer(o.PIXEL_UNPACK_BUFFER,d),o.bufferData(o.PIXEL_UNPACK_BUFFER,s,o.STREAM_DRAW),o.bindTexture(o.TEXTURE_2D,l._glTexture),o.texSubImage2D(o.TEXTURE_2D,0,t,n,i,r,c,f,0),o.bindBuffer(o.PIXEL_UNPACK_BUFFER,null),e._needsUpload=false,e._mipmapsUploaded=false,[4,a.clientWaitAsync(0,16)];case 1:return p.sent(),[2]}})})()},r.setAlphaToCoverage=function(e){this.alphaToCoverage!==e&&(this.alphaToCoverage=e,e?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE));},r.setTransformFeedbackBuffer=function(e){if(this.transformFeedbackBuffer!==e){this.transformFeedbackBuffer=e;var t=this.gl;e?(this.feedback||(this.feedback=t.createTransformFeedback()),t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,this.feedback)):t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,null);}},r.setRaster=function(e){this.raster!==e&&(this.raster=e,e?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD));},r.setStencilTest=function(e){if(this.stencil!==e){var t=this.gl;e?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.stencil=e;}},r.setStencilFunc=function(e,t,n){(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==n||this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==n)&&(this.gl.stencilFunc(this.glComparison[e],t,n),this.stencilFuncFront=this.stencilFuncBack=e,this.stencilRefFront=this.stencilRefBack=t,this.stencilMaskFront=this.stencilMaskBack=n);},r.setStencilFuncFront=function(e,t,n){if(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==n){var i=this.gl;i.stencilFuncSeparate(i.FRONT,this.glComparison[e],t,n),this.stencilFuncFront=e,this.stencilRefFront=t,this.stencilMaskFront=n;}},r.setStencilFuncBack=function(e,t,n){if(this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==n){var i=this.gl;i.stencilFuncSeparate(i.BACK,this.glComparison[e],t,n),this.stencilFuncBack=e,this.stencilRefBack=t,this.stencilMaskBack=n;}},r.setStencilOperation=function(e,t,n,i){(this.stencilFailFront!==e||this.stencilZfailFront!==t||this.stencilZpassFront!==n||this.stencilFailBack!==e||this.stencilZfailBack!==t||this.stencilZpassBack!==n)&&(this.gl.stencilOp(this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[n]),this.stencilFailFront=this.stencilFailBack=e,this.stencilZfailFront=this.stencilZfailBack=t,this.stencilZpassFront=this.stencilZpassBack=n),(this.stencilWriteMaskFront!==i||this.stencilWriteMaskBack!==i)&&(this.gl.stencilMask(i),this.stencilWriteMaskFront=i,this.stencilWriteMaskBack=i);},r.setStencilOperationFront=function(e,t,n,i){(this.stencilFailFront!==e||this.stencilZfailFront!==t||this.stencilZpassFront!==n)&&(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[n]),this.stencilFailFront=e,this.stencilZfailFront=t,this.stencilZpassFront=n),this.stencilWriteMaskFront!==i&&(this.gl.stencilMaskSeparate(this.gl.FRONT,i),this.stencilWriteMaskFront=i);},r.setStencilOperationBack=function(e,t,n,i){(this.stencilFailBack!==e||this.stencilZfailBack!==t||this.stencilZpassBack!==n)&&(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[n]),this.stencilFailBack=e,this.stencilZfailBack=t,this.stencilZpassBack=n),this.stencilWriteMaskBack!==i&&(this.gl.stencilMaskSeparate(this.gl.BACK,i),this.stencilWriteMaskBack=i);},r.setBlendState=function(e){var t=this.blendState;if(!t.equals(e)){var n=this.gl,i=e.blend,r=e.colorOp,s=e.alphaOp,a=e.colorSrcFactor,o=e.colorDstFactor,l=e.alphaSrcFactor,u=e.alphaDstFactor;if(t.blend!==i&&(i?n.enable(n.BLEND):n.disable(n.BLEND)),t.colorOp!==r||t.alphaOp!==s){var c=this.glBlendEquation;n.blendEquationSeparate(c[r],c[s]);}(t.colorSrcFactor!==a||t.colorDstFactor!==o||t.alphaSrcFactor!==l||t.alphaDstFactor!==u)&&n.blendFuncSeparate(this.glBlendFunctionColor[a],this.glBlendFunctionColor[o],this.glBlendFunctionAlpha[l],this.glBlendFunctionAlpha[u]),t.allWrite!==e.allWrite&&this.gl.colorMask(e.redWrite,e.greenWrite,e.blueWrite,e.alphaWrite),t.copy(e);}},r.setBlendColor=function(e,t,n,i){var r=this.blendColor;(e!==r.r||t!==r.g||n!==r.b||i!==r.a)&&(this.gl.blendColor(e,t,n,i),r.set(e,t,n,i));},r.setStencilState=function(e,t){e||t?(this.setStencilTest(true),e===t?(this.setStencilFunc(e.func,e.ref,e.readMask),this.setStencilOperation(e.fail,e.zfail,e.zpass,e.writeMask)):(null!=e||(e=n7.DEFAULT),this.setStencilFuncFront(e.func,e.ref,e.readMask),this.setStencilOperationFront(e.fail,e.zfail,e.zpass,e.writeMask),null!=t||(t=n7.DEFAULT),this.setStencilFuncBack(t.func,t.ref,t.readMask),this.setStencilOperationBack(t.fail,t.zfail,t.zpass,t.writeMask))):this.setStencilTest(false);},r.setDepthState=function(e){var t=this.depthState;if(!t.equals(e)){var n=this.gl,i=e.write;t.write!==i&&n.depthMask(i);var r=e.func,s=e.test;!s&&i&&(s=true,r=7),t.func!==r&&n.depthFunc(this.glComparison[r]),t.test!==s&&(s?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST));var a=e.depthBias,o=e.depthBiasSlope;a||o?(this.depthBiasEnabled||(this.depthBiasEnabled=true,this.gl.enable(this.gl.POLYGON_OFFSET_FILL)),n.polygonOffset(o,a)):this.depthBiasEnabled&&(this.depthBiasEnabled=false,this.gl.disable(this.gl.POLYGON_OFFSET_FILL)),t.copy(e);}},r.setCullMode=function(e){if(this.cullMode!==e){if(0===e)this.gl.disable(this.gl.CULL_FACE);else {0===this.cullMode&&this.gl.enable(this.gl.CULL_FACE);var t=this.glCull[e];this.cullFace!==t&&(this.gl.cullFace(t),this.cullFace=t);}this.cullMode=e;}},r.setShader=function(e,t){ void 0===t&&(t=false),e!==this.shader&&(this.shader=e,this.shaderAsyncCompile=t,this.shaderValid=void 0);},r.activateShader=function(){var e=this.shader,t=e.impl;void 0===this.shaderValid&&(e.failed?this.shaderValid=false:!e.ready&&(this.shaderAsyncCompile?t.isLinked(this)?t.finalize(this,e)||(e.failed=true,this.shaderValid=false):this.shaderValid=false:t.finalize(this,e)||(e.failed=true,this.shaderValid=false))),void 0===this.shaderValid&&(this.gl.useProgram(t.glProgram),this.shaderValid=true);},r.clearVertexArrayObjectCache=function(){var e=this.gl;this._vaoMap.forEach(function(t,n,i){e.deleteVertexArray(t);}),this._vaoMap.clear();},n=[{key:"extDisjointTimerQuery",get:function(){return this._extDisjointTimerQuery||(this._extDisjointTimerQuery=this.getExtension("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")),this._extDisjointTimerQuery}},{key:"defaultFramebuffer",get:function(){return this._defaultFramebuffer},set:function(e){this._defaultFramebuffer!==e&&(this._defaultFramebuffer=e,this._defaultFramebufferChanged=true);}},{key:"fullscreen",get:function(){return !!document.fullscreenElement},set:function(e){e?this.gl.canvas.requestFullscreen():document.exitFullscreen();}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ia),sG=function(){function e(){}return e.prototype.unlock=function(e){},e}(),sH=function(){function e(){}var t=e.prototype;return t.destroy=function(e){},t.init=function(e,t){},t.loseContext=function(){},t.resolve=function(e,t,n,i){},e}(),sW=function(){function e(){}var t=e.prototype;return t.destroy=function(e){},t.loseContext=function(){},t.restoreContext=function(e,t){},e}(),sj=function(){function e(){}var t=e.prototype;return t.destroy=function(e){},t.propertyChanged=function(e){},t.loseContext=function(){},e}(),sX=function(){function e(){}var t=e.prototype;return t.destroy=function(e){},t.unlock=function(e){},e}();function sY(e,t){return (sY=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var sq=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return void 0===n&&(n={}),n=(i=e.call(this,t,n)||this).initOptions,i.isNull=true,i._deviceType=nc,i.samples=1,i.backBuffer=new il({name:"Framebuffer",graphicsDevice:i,depth:i.initOptions.depth,stencil:i.supportsStencil,samples:i.samples}),i.initDeviceCaps(),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&sY(t,e);var n=t.prototype;return n.destroy=function(){e.prototype.destroy.call(this);},n.initDeviceCaps=function(){this.disableParticleSystem=true,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=4096,this.maxCubeMapSize=4096,this.maxVolumeSize=4096,this.maxColorAttachments=8,this.maxPixelRatio=1,this.maxAnisotropy=16,this.supportsUniformBuffers=false,this.supportsAreaLights=true,this.supportsGpuParticles=false,this.textureFloatRenderable=true,this.textureHalfFloatRenderable=true,this.supportsImageBitmap=false;},n.postInit=function(){e.prototype.postInit.call(this);},n.frameStart=function(){e.prototype.frameStart.call(this);},n.frameEnd=function(){e.prototype.frameEnd.call(this);},n.updateBegin=function(){},n.updateEnd=function(){},n.readPixels=function(e,t,n,i,r){},n.createVertexBufferImpl=function(e,t){return new sX(e,t)},n.createIndexBufferImpl=function(e){return new sG(e)},n.createShaderImpl=function(e){return new sW(e)},n.createTextureImpl=function(e){return new sj(e)},n.createRenderTargetImpl=function(e){return new sH(e)},n.draw=function(e,t,n,i,r,s){},n.setShader=function(e,t){},n.setBlendState=function(e){},n.setDepthState=function(e){},n.setStencilState=function(e,t){},n.setBlendColor=function(e,t,n,i){},n.setCullMode=function(e){},n.setAlphaToCoverage=function(e){},n.initializeContextCaches=function(){e.prototype.initializeContextCaches.call(this);},n.clear=function(e){},n.setViewport=function(e,t,n,i){},n.setScissor=function(e,t,n,i){},n.copyRenderTarget=function(e,t,n,i){return  true},t}(ia);function sK(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}var sZ=function(){this.scopeId=null;},sQ=function(){function e(e,t,n){ void 0===n&&(n="Unnamed"),this.shader=null,this.parameters=new Map,this.countX=1,this.device=e,this.shader=t,this.name=n,e.supportsCompute&&(this.impl=e.createComputeImpl(this));}var t=e.prototype;return t.setParameter=function(e,t){var n=this.parameters.get(e);n||((n=new sZ).scopeId=this.device.scope.resolve(e),this.parameters.set(e,n)),n.value=t;},t.getParameter=function(e){var t;return null==(t=this.parameters.get(e))?void 0:t.value},t.deleteParameter=function(e){this.parameters.delete(e);},t.applyParameters=function(){for(var e,t=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return sK(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return sK(e,void 0)}}(e))){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(this.parameters);!(e=t()).done;){var n=e.value[1];n.scopeId.setValue(n.value);}},t.setupDispatch=function(e,t,n){this.countX=e,this.countY=t,this.countZ=n;},e}(),sJ=0,s$=function(){function e(e,t,n,i,r,s){ void 0===i&&(i=0),this.device=e,this.format=t,this.numIndices=n,this.usage=i,this.id=sJ++,this.impl=e.createIndexBufferImpl(this,s);var a=ng[t];this.bytesPerIndex=a,this.numBytes=this.numIndices*a,r?this.setData(r):this.storage=new ArrayBuffer(this.numBytes),this.adjustVramSizeTracking(e._vram,this.numBytes),this.device.buffers.push(this);}var t=e.prototype;return t.destroy=function(){var e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.device.indexBuffer===this&&(this.device.indexBuffer=null),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength));},t.adjustVramSizeTracking=function(e,t){e.ib+=t;},t.loseContext=function(){this.impl.loseContext();},t.getFormat=function(){return this.format},t.getNumIndices=function(){return this.numIndices},t.lock=function(){return this.storage},t.unlock=function(){this.impl.unlock(this);},t.setData=function(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),true)},t._lockTypedArray=function(){var e=this.lock();return 2===this.format?new Uint32Array(e):1===this.format?new Uint16Array(e):new Uint8Array(e)},t.writeData=function(e,t){var n=this._lockTypedArray();if(e.length>t)if(ArrayBuffer.isView(e))e=e.subarray(0,t),n.set(e);else for(var i=0;i<t;i++)n[i]=e[i];else n.set(e);this.unlock();},t.readData=function(e){var t=this._lockTypedArray(),n=this.numIndices;if(ArrayBuffer.isView(e))e.set(t);else {e.length=0;for(var i=0;i<n;i++)e[i]=t[i];}return n},e}(),s0=function(){this.clearValue=new eN(0,0,0,1),this.clearValueLinear=new eN(0,0,0,1),this.clear=false,this.store=false,this.resolve=true,this.genMipmaps=false;},s1=function(){this.clearDepthValue=1,this.clearStencilValue=0,this.clearDepth=false,this.clearStencil=false,this.storeDepth=false,this.resolveDepth=false,this.storeStencil=false;},s2=function(){function e(e){this._enabled=true,this._skipStart=false,this._skipEnd=false,this.executeEnabled=true,this.samples=0,this.colorArrayOps=[],this.requiresCubemaps=true,this.fullSizeClearRect=true,this.beforePasses=[],this.afterPasses=[],this.device=e;}var t,n=e.prototype;return n.init=function(e,t){ void 0===e&&(e=null),this.options=t,this.renderTarget=e,this.samples=Math.max(this.renderTarget?this.renderTarget.samples:this.device.samples,1),this.allocateAttachments(),this.postInit();},n.allocateAttachments=function(){var e=this.renderTarget;this.depthStencilOps=new s1,(null==e?void 0:e.depthBuffer)&&(this.depthStencilOps.storeDepth=true);var t=e?null!=(r=null==(i=e._colorBuffers)?void 0:i.length)?r:0:1;this.colorArrayOps.length=0;for(var n=0;n<t;n++){var i,r,s,a,o,l=new s0;this.colorArrayOps[n]=l,1===this.samples&&(l.store=true,l.resolve=false);var u=null==(a=this.renderTarget)||null==(s=a._colorBuffers)?void 0:s[n];(null==(o=this.renderTarget)?void 0:o.mipmaps)&&(null==u?void 0:u.mipmaps)&&(l.genMipmaps=!tg(u._format));}},n.destroy=function(){},n.postInit=function(){},n.frameUpdate=function(){if(this._options&&this.renderTarget){var e,t=null!=(e=this._options.resizeSource)?e:this.device.backBuffer,n=Math.floor(t.width*this.scaleX),i=Math.floor(t.height*this.scaleY);this.renderTarget.resize(n,i);}},n.before=function(){},n.execute=function(){},n.after=function(){},n.onEnable=function(){},n.onDisable=function(){},n.setClearColor=function(e){for(var t=this.colorArrayOps.length,n=0;n<t;n++){var i=this.colorArrayOps[n];e&&(i.clearValue.copy(e),i.clearValueLinear.linear(e)),i.clear=!!e;}},n.setClearDepth=function(e){e&&(this.depthStencilOps.clearDepthValue=e),this.depthStencilOps.clearDepth=void 0!==e;},n.setClearStencil=function(e){e&&(this.depthStencilOps.clearStencilValue=e),this.depthStencilOps.clearStencil=void 0!==e;},n.render=function(){if(this.enabled){var e=this.device,t=void 0!==this.renderTarget;this.before(),this.executeEnabled&&(t&&!this._skipStart&&e.startRenderPass(this),this.execute(),t&&!this._skipEnd&&e.endRenderPass(this)),this.after(),e.renderPassIndex++;}},t=[{key:"colorOps",get:function(){return this.colorArrayOps[0]}},{key:"name",get:function(){return this._name||(this._name=this.constructor.name),this._name},set:function(e){this._name=e;}},{key:"scaleX",get:function(){return this._options.scaleX},set:function(e){this._options.scaleX=e;}},{key:"scaleY",get:function(){return this._options.scaleY},set:function(e){this._options.scaleY=e;}},{key:"options",get:function(){return this._options},set:function(e){if(this._options=e,e){var t,n;this.scaleX=null!=(t=this.scaleX)?t:1,this.scaleY=null!=(n=this.scaleY)?n:1;}}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,e?this.onEnable():this.onDisable());}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),s3=function(){function e(e,t){ void 0===t&&(t=3),this.device=e.device;var n=this.device.gl;this._inputBuffer=e,3===t&&e.usage!==t&&(n.bindBuffer(n.ARRAY_BUFFER,e.impl.bufferId),n.bufferData(n.ARRAY_BUFFER,e.storage,n.DYNAMIC_COPY)),this._outputBuffer=new n1(e.device,e.format,e.numVertices,{usage:t,data:e.storage});}var t,n=e.prototype;return n.destroy=function(){this._outputBuffer.destroy();},n.process=function(e,t){ void 0===t&&(t=true);var n=this.device,i=n.getRenderTarget();if(n.setRenderTarget(null),n.updateBegin(),n.setVertexBuffer(this._inputBuffer),n.setRaster(false),n.setTransformFeedbackBuffer(this._outputBuffer),n.setShader(e),n.draw({type:0,base:0,baseVertex:0,count:this._inputBuffer.numVertices,indexed:false}),n.setTransformFeedbackBuffer(null),n.setRaster(true),n.updateEnd(),n.setRenderTarget(i),t){var r=this._inputBuffer.impl.bufferId;this._inputBuffer.impl.bufferId=this._outputBuffer.impl.bufferId,this._outputBuffer.impl.bufferId=r,r=this._inputBuffer.impl.vao,this._inputBuffer.impl.vao=this._outputBuffer.impl.vao,this._outputBuffer.impl.vao=r;}},e.createShader=function(e,t,n){return new r$(e,rQ.createDefinition(e,{name:n,vertexCode:t,useTransformFeedback:true,fragmentCode:"void main(void) {gl_FragColor = vec4(0.0);}"}))},t=[{key:"inputBuffer",get:function(){return this._inputBuffer}},{key:"outputBuffer",get:function(){return this._outputBuffer}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function s4(e){this.array[this.index]=e;}function s5(e,t){this.array[this.index]=e,this.array[this.index+1]=t;}function s8(e,t,n){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=n;}function s6(e,t,n,i){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=n,this.array[this.index+3]=i;}function s9(e,t,n){this.array[e]=t[n];}function s7(e,t,n){this.array[e]=t[n],this.array[e+1]=t[n+1];}function ae(e,t,n){this.array[e]=t[n],this.array[e+1]=t[n+1],this.array[e+2]=t[n+2];}function at(e,t,n){this.array[e]=t[n],this.array[e+1]=t[n+1],this.array[e+2]=t[n+2],this.array[e+3]=t[n+3];}function an(e,t,n){t[n]=this.array[e];}function ai(e,t,n){t[n]=this.array[e],t[n+1]=this.array[e+1];}function ar(e,t,n){t[n]=this.array[e],t[n+1]=this.array[e+1],t[n+2]=this.array[e+2];}function as(e,t,n){t[n]=this.array[e],t[n+1]=this.array[e+1],t[n+2]=this.array[e+2],t[n+3]=this.array[e+3];}var aa=function(){function e(e,t,n){switch(this.index=0,this.numComponents=t.numComponents,n.interleaved?this.array=new nm[t.dataType](e,t.offset):this.array=new nm[t.dataType](e,t.offset,n.vertexCount*t.numComponents),this.stride=t.stride/this.array.constructor.BYTES_PER_ELEMENT,t.numComponents){case 1:this.set=s4,this.getToArray=an,this.setFromArray=s9;break;case 2:this.set=s5,this.getToArray=ai,this.setFromArray=s7;break;case 3:this.set=s8,this.getToArray=ar,this.setFromArray=ae;break;case 4:this.set=s6,this.getToArray=as,this.setFromArray=at;}}var t=e.prototype;return t.get=function(e){return this.array[this.index+e]},t.set=function(e,t,n,i){},t.getToArray=function(e,t,n){},t.setFromArray=function(e,t,n){},e}(),ao=function(){function e(e){this.vertexBuffer=e,this.vertexFormatSize=e.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};for(var t=this.vertexBuffer.getFormat(),n=0;n<t.elements.length;n++){var i=t.elements[n];this.accessors[n]=new aa(this.buffer,i,t),this.element[i.name]=this.accessors[n];}}var t=e.prototype;return t.next=function(e){ void 0===e&&(e=1);for(var t=0,n=this.accessors,i=this.accessors.length;t<i;){var r=n[t++];r.index+=e*r.stride;}},t.end=function(){this.vertexBuffer.unlock();},t.writeData=function(e,t,n){var i=this.element[e];if(i){n>this.vertexBuffer.numVertices&&(n=this.vertexBuffer.numVertices);var r=i.numComponents;if(this.vertexBuffer.getFormat().interleaved)for(var s=0,a=0;a<n;a++)i.setFromArray(s,t,a*r),s+=i.stride;else if(t.length>n*r){var o=n*r;if(ArrayBuffer.isView(t))t=t.subarray(0,o),i.array.set(t);else for(var l=0;l<o;l++)i.array[l]=t[l];}else i.array.set(t);}},t.readData=function(e,t){var n=this.element[e],i=0;if(n){i=this.vertexBuffer.numVertices;var r,s=n.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(t)&&(t.length=0),n.index=0;var a=0;for(r=0;r<i;r++)n.getToArray(a,t,r*s),a+=n.stride;}else if(ArrayBuffer.isView(t))t.set(n.array);else {t.length=0;var o=i*s;for(r=0;r<o;r++)t[r]=n.array[r];}}return i},e}(),al="mouse",au="keyboard",ac="gamepad",ah=function(e,t){this.key=null,this.element=null,this.event=null,t&&(this.key=t.keyCode,this.element=t.target,this.event=t);};function af(e,t){return (af=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ad=new ah;function ap(e){return ad.key=e.keyCode,ad.element=e.target,ad.event=e,ad}function am(e){return "string"==typeof e?e.toUpperCase().charCodeAt(0):e}var a_={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"},av=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return void 0===n&&(n={}),(i=e.call(this)||this)._element=null,i._keymap={},i._lastmap={},i._keyDownHandler=i._handleKeyDown.bind(i),i._keyUpHandler=i._handleKeyUp.bind(i),i._keyPressHandler=i._handleKeyPress.bind(i),i._visibilityChangeHandler=i._handleVisibilityChange.bind(i),i._windowBlurHandler=i._handleWindowBlur.bind(i),t&&i.attach(t),i.preventDefault=n.preventDefault||false,i.stopPropagation=n.stopPropagation||false,i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&af(t,e);var n=t.prototype;return n.attach=function(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("keydown",this._keyDownHandler,false),this._element.addEventListener("keypress",this._keyPressHandler,false),this._element.addEventListener("keyup",this._keyUpHandler,false),document.addEventListener("visibilitychange",this._visibilityChangeHandler,false),window.addEventListener("blur",this._windowBlurHandler,false);},n.detach=function(){this._element&&(this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null,document.removeEventListener("visibilitychange",this._visibilityChangeHandler,false),window.removeEventListener("blur",this._windowBlurHandler,false));},n.toKeyIdentifier=function(e){var t=a_[(e=am(e)).toString()];if(t)return t;for(var n=e.toString(16).toUpperCase(),i=n.length,r=0;r<4-i;r++)n="0"+n;return "U+"+n},n._handleKeyDown=function(e){var t=e.keyCode||e.charCode;if(void 0!==t){var n=this.toKeyIdentifier(t);this._keymap[n]=true,this.fire("keydown",ap(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation();}},n._handleKeyUp=function(e){var t=e.keyCode||e.charCode;if(void 0!==t){var n=this.toKeyIdentifier(t);delete this._keymap[n],this.fire("keyup",ap(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation();}},n._handleKeyPress=function(e){this.fire("keypress",ap(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation();},n._handleVisibilityChange=function(){"hidden"===document.visibilityState&&this._handleWindowBlur();},n._handleWindowBlur=function(){this._keymap={},this._lastmap={};},n.update=function(){for(var e in this._lastmap)delete this._lastmap[e];for(var t in this._keymap)this._keymap.hasOwnProperty(t)&&(this._lastmap[t]=this._keymap[t]);},n.isPressed=function(e){var t=am(e),n=this.toKeyIdentifier(t);return !!this._keymap[n]},n.wasPressed=function(e){var t=am(e),n=this.toKeyIdentifier(t);return !!this._keymap[n]&&!this._lastmap[n]},n.wasReleased=function(e){var t=am(e),n=this.toKeyIdentifier(t);return !this._keymap[n]&&!!this._lastmap[n]},t}(ex);function ag(){return !!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}av.EVENT_KEYDOWN="keydown",av.EVENT_KEYUP="keyup";var ay=function e(t,n){this.x=0,this.y=0,this.dx=0,this.dy=0,this.button=-1,this.wheelDelta=0,this.ctrlKey=false,this.altKey=false,this.shiftKey=false,this.metaKey=false;var r,s,a,o,l,u,c={x:0,y:0};if(n){if(r=n,null!=(s=e)&&"undefined"!=typeof Symbol&&s[Symbol.hasInstance]?!!s[Symbol.hasInstance](r):i(r,s))throw Error("Expected MouseEvent");c=t._getTargetCoords(n);}else n={};if(c)this.x=c.x,this.y=c.y;else {if(!ag())return;this.x=0,this.y=0;}"wheel"===n.type&&(n.deltaY>0?this.wheelDelta=1:n.deltaY<0&&(this.wheelDelta=-1)),ag()?(this.dx=n.movementX||n.webkitMovementX||n.mozMovementX||0,this.dy=n.movementY||n.webkitMovementY||n.mozMovementY||0):(this.dx=this.x-t._lastX,this.dy=this.y-t._lastY),("mousedown"===n.type||"mouseup"===n.type)&&(this.button=n.button),this.buttons=t._buttons.slice(0),this.element=n.target,this.ctrlKey=null!=(a=n.ctrlKey)&&a,this.altKey=null!=(o=n.altKey)&&o,this.shiftKey=null!=(l=n.shiftKey)&&l,this.metaKey=null!=(u=n.metaKey)&&u,this.event=n;};function aS(e,t){return (aS=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ax=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this)._lastX=0,n._lastY=0,n._buttons=[false,false,false],n._lastbuttons=[false,false,false],n._target=null,n._attached=false,n._upHandler=n._handleUp.bind(n),n._downHandler=n._handleDown.bind(n),n._moveHandler=n._handleMove.bind(n),n._wheelHandler=n._handleWheel.bind(n),n._contextMenuHandler=function(e){e.preventDefault();},n.attach(t),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&aS(t,e);var n=t.prototype;return n.attach=function(e){if(this._target=e,!this._attached){this._attached=true;var t=!!ef.passiveEvents&&{passive:false};window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t);}},n.detach=function(){if(this._attached){this._attached=false,this._target=null;var e=!!ef.passiveEvents&&{passive:false};window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e);}},n.disableContextMenu=function(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler);},n.enableContextMenu=function(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler);},n.enablePointerLock=function(e,t){if(!document.body.requestPointerLock){t&&t();return}var n=function(){e(),document.removeEventListener("pointerlockchange",n);},i=function(){t(),document.removeEventListener("pointerlockerror",i);};e&&document.addEventListener("pointerlockchange",n,false),t&&document.addEventListener("pointerlockerror",i,false),document.body.requestPointerLock();},n.disablePointerLock=function(e){if(document.exitPointerLock){var t=function(){e(),document.removeEventListener("pointerlockchange",t);};e&&document.addEventListener("pointerlockchange",t,false),document.exitPointerLock();}},n.update=function(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2];},n.isPressed=function(e){return this._buttons[e]},n.wasPressed=function(e){return this._buttons[e]&&!this._lastbuttons[e]},n.wasReleased=function(e){return !this._buttons[e]&&this._lastbuttons[e]},n._handleUp=function(e){this._buttons[e.button]=false;var t=new ay(this,e);t.event&&this.fire("mouseup",t);},n._handleDown=function(e){this._buttons[e.button]=true;var t=new ay(this,e);t.event&&this.fire("mousedown",t);},n._handleMove=function(e){var t=new ay(this,e);t.event&&(this.fire("mousemove",t),this._lastX=t.x,this._lastY=t.y);},n._handleWheel=function(e){var t=new ay(this,e);t.event&&this.fire("mousewheel",t);},n._getTargetCoords=function(e){var t=this._target.getBoundingClientRect(),n=Math.floor(t.left),i=Math.floor(t.top);return e.clientX<n||e.clientX>=n+this._target.clientWidth||e.clientY<i||e.clientY>=i+this._target.clientHeight?null:{x:e.clientX-n,y:e.clientY-i}},t.isPointerLocked=function(){return ag()},t}(ex);ax.EVENT_MOUSEMOVE="mousemove",ax.EVENT_MOUSEDOWN="mousedown",ax.EVENT_MOUSEUP="mouseup",ax.EVENT_MOUSEWHEEL="mousewheel";var ab=function(){function e(e,t){ void 0===t&&(t={}),this._element=null,this._actions={},this._axes={},this._axesValues={},this._keyboard=t.keyboard||null,this._mouse=t.mouse||null,this._gamepads=t.gamepads||null,e&&this.attach(e);}var t=e.prototype;return t.attach=function(e){this._element=e,this._keyboard&&this._keyboard.attach(e),this._mouse&&this._mouse.attach(e);},t.detach=function(){this._keyboard&&this._keyboard.detach(),this._mouse&&this._mouse.detach(),this._element=null;},t.disableContextMenu=function(){this._mouse||this._enableMouse(),this._mouse.disableContextMenu();},t.enableContextMenu=function(){this._mouse||this._enableMouse(),this._mouse.enableContextMenu();},t.update=function(e){for(var t in this._keyboard&&this._keyboard.update(),this._mouse&&this._mouse.update(),this._gamepads&&this._gamepads.update(),this._axesValues={},this._axes)this._axesValues[t]=[];},t.appendAction=function(e,t){this._actions[e]=this._actions[e]||[],this._actions[e].push(t);},t.registerKeys=function(e,t){if(this._keyboard||this._enableKeyboard(),this._actions[e])throw Error("Action: "+e+" already registered");if(void 0===t)throw Error("Invalid button");t.length||(t=[t]),this.appendAction(e,{type:au,keys:t});},t.registerMouse=function(e,t){if(this._mouse||this._enableMouse(),void 0===t)throw Error("Invalid button");this.appendAction(e,{type:al,button:t});},t.registerPadButton=function(e,t,n){if(void 0===n)throw Error("Invalid button");this.appendAction(e,{type:ac,button:n,pad:t});},t.registerAxis=function(e){var t=e.name;this._axes[t]||(this._axes[t]=[]);var n=this._axes[t].push(t);(e=e||{}).pad=e.pad||0;var i=function(i,r,s,a){switch(r){case "mousex":i._mouse.on("mousemove",function(e){i._axesValues[t][n]=e.dx/10;});break;case "mousey":i._mouse.on("mousemove",function(e){i._axesValues[t][n]=e.dy/10;});break;case "key":i._axes[t].push(function(){return i._keyboard.isPressed(a)?s:0});break;case "padrx":i._axes[t].push(function(){return i._gamepads.getAxis(e.pad,2)});break;case "padry":i._axes[t].push(function(){return i._gamepads.getAxis(e.pad,3)});break;case "padlx":i._axes[t].push(function(){return i._gamepads.getAxis(e.pad,0)});break;case "padly":i._axes[t].push(function(){return i._gamepads.getAxis(e.pad,1)});break;default:throw Error("Unknown axis")}};i(this,e.positive,1,e.positiveKey),(e.negativeKey||e.negative!==e.positive)&&i(this,e.negative,-1,e.negativeKey);},t.isPressed=function(e){if(!this._actions[e])return  false;for(var t=this._actions[e].length,n=0;n<t;++n){var i=this._actions[e][n];switch(i.type){case au:if(this._keyboard){for(var r=i.keys.length,s=0;s<r;s++)if(this._keyboard.isPressed(i.keys[s]))return  true}break;case al:if(this._mouse&&this._mouse.isPressed(i.button))return  true;break;case ac:if(this._gamepads&&this._gamepads.isPressed(i.pad,i.button))return  true}}return  false},t.wasPressed=function(e){if(!this._actions[e])return  false;for(var t=this._actions[e].length,n=0;n<t;++n){var i=this._actions[e][n];switch(i.type){case au:if(this._keyboard){for(var r=i.keys.length,s=0;s<r;s++)if(this._keyboard.wasPressed(i.keys[s]))return  true}break;case al:if(this._mouse&&this._mouse.wasPressed(i.button))return  true;break;case ac:if(this._gamepads&&this._gamepads.wasPressed(i.pad,i.button))return  true}}return  false},t.getAxis=function(e){var t=0;if(this._axes[e])for(var n=this._axes[e].length,i=0;i<n;i++)if("function"==typeof this._axes[e][i]){var r=this._axes[e][i]();Math.abs(r)>Math.abs(t)&&(t=r);}else this._axesValues[e]&&Math.abs(this._axesValues[e][i])>Math.abs(t)&&(t=this._axesValues[e][i]);return t},t._enableMouse=function(){if(this._mouse=new ax,!this._element)throw Error("Controller must be attached to an Element");this._mouse.attach(this._element);},t._enableKeyboard=function(){if(this._keyboard=new av,!this._element)throw Error("Controller must be attached to an Element");this._keyboard.attach(this._element);},e}();function aT(e,t,n,i,r,s,a){try{var o=e[s](a),l=o.value;}catch(e){n(e);return}o.done?t(l):Promise.resolve(l).then(i,r);}function aE(e){return function(){var t=this,n=arguments;return new Promise(function(i,r){var s=e.apply(t,n);function a(e){aT(s,i,r,a,o,"next",e);}function o(e){aT(s,i,r,a,o,"throw",e);}a(void 0);})}}function aw(e,t,n){return t&&function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}function aA(e,t){return (aA=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function aC(e,t){var n,i,r,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(l){var u=[o,l];if(n)throw TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(s=0)),s;)try{if(n=1,i&&(r=2&u[0]?i.return:u[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,u[1])).done)return r;switch(i=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,i=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===u[0]||2===u[0])){s=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){s.label=u[1];break}if(6===u[0]&&s.label<r[1]){s.label=r[1],r=u;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(u);break}r[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s);}catch(e){u=[6,e],i=0;}finally{n=r=0;}if(5&u[0])throw u[1];return {value:u[0]?u[1]:void 0,done:true}}}}var aP=Object.freeze([]),aI=function(){return aP};"undefined"!=typeof navigator&&(aI=(navigator.getGamepads||navigator.webkitGetGamepads||aI).bind(navigator));var aL={PAD_FACE_1:0,PAD_FACE_2:1,PAD_FACE_3:2,PAD_FACE_4:3,PAD_L_SHOULDER_1:4,PAD_R_SHOULDER_1:5,PAD_L_SHOULDER_2:6,PAD_R_SHOULDER_2:7,PAD_SELECT:8,PAD_START:9,PAD_L_STICK_BUTTON:10,PAD_R_STICK_BUTTON:11,PAD_UP:12,PAD_DOWN:13,PAD_LEFT:14,PAD_RIGHT:15,PAD_VENDOR:16,XRPAD_TRIGGER:0,XRPAD_SQUEEZE:1,XRPAD_TOUCHPAD_BUTTON:2,XRPAD_STICK_BUTTON:3,XRPAD_A:4,XRPAD_B:5},aD={PAD_L_STICK_X:0,PAD_L_STICK_Y:1,PAD_R_STICK_X:2,PAD_R_STICK_Y:3,XRPAD_TOUCHPAD_X:0,XRPAD_TOUCHPAD_Y:1,XRPAD_STICK_X:2,XRPAD_STICK_Y:3},aM={DEFAULT:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},DEFAULT_DUAL:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"],synthesizedButtons:{PAD_UP:{axis:0,min:0,max:1},PAD_DOWN:{axis:0,min:-1,max:0},PAD_LEFT:{axis:0,min:-1,max:0},PAD_RIGHT:{axis:0,min:0,max:1}}},PS3:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_4","PAD_FACE_3","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"],mapping:"standard"},DEFAULT_XR:{buttons:["XRPAD_TRIGGER","XRPAD_SQUEEZE","XRPAD_TOUCHPAD_BUTTON","XRPAD_STICK_BUTTON","XRPAD_A","XRPAD_B"],axes:["XRPAD_TOUCHPAD_X","XRPAD_TOUCHPAD_Y","XRPAD_STICK_X","XRPAD_STICK_Y"],mapping:"xr-standard"}},aR={"Product: 0268":"PS3"},aO={};function ak(e){var t=aO[e.id];if(t)return t;for(var n in aR)if(-1!==e.id.indexOf(n)){var i=aR[n];if(!e.mapping){var r=aM["RAW_"+i];if(r)return r}return aM[i]}if("xr-standard"===e.mapping)return aM.DEFAULT_XR;var s=aM.DEFAULT,a=e.buttons.length<s.buttons.length?aM.DEFAULT_DUAL:s;return a.mapping=e.mapping,a}var aN=.25,aF=function(){function e(e,t){var n,i;this.value=0,this.pressed=false,this.touched=false,this.wasPressed=false,this.wasReleased=false,this.wasTouched=false,"number"==typeof e?(this.value=e,this.pressed=1===e,this.touched=e>0):(this.value=e.value,this.pressed=e.pressed,this.touched=null!=(n=e.touched)?n:e.value>0),t&&("number"==typeof t?(this.wasPressed=1!==t&&this.pressed,this.wasReleased=1===t&&!this.pressed,this.wasTouched=0===t&&this.touched):(this.wasPressed=!t.pressed&&this.pressed,this.wasReleased=t.pressed&&!this.pressed,this.wasTouched=!(null!=(i=t.touched)?i:t.value>0)&&this.touched));}return e.prototype.update=function(e){var t,n=e.value,i=e.pressed,r=null!=(t=e.touched)?t:n>0;this.wasPressed=!this.pressed&&i,this.wasReleased=this.pressed&&!i,this.wasTouched=!this.touched&&r,this.value=n,this.pressed=i,this.touched=r;},e}(),aB=Object.freeze(new aF(0)),aU=function(){function e(e,t){this._compiledMapping={buttons:[],axes:[]},this.id=e.id,this.index=e.index,this._buttons=e.buttons.map(function(e){return new aF(e)}),this._axes=[].concat(e.axes),this._previousAxes=[].concat(e.axes),this.mapping=t.mapping,this.map=t,this.hand=e.hand||"none",this.pad=e,this._compileMapping();}var t=e.prototype;return t._compileMapping=function(){var e=this,t=this._compiledMapping,n=t.axes,i=t.buttons;n.length=0,i.length=0,this.map.axes&&this.map.axes.forEach(function(t,i){n[aD[t]]=function(){return e.pad.axes[i]||0};});for(var r=0,s=n.length;r<s;r++)n[r]||(n[r]=function(){return 0});var a=this.map.buttons;a&&a.forEach(function(t,n){i[aL[t]]=function(){return e._buttons[n]||aB};});var o=this.map.synthesizedButtons;o&&Object.entries(o).forEach(function(t){var n=t[1],r=n.axis,s=n.max,a=n.min;i[aL[t[0]]]=function(){var t,n;return new aF(Math.abs(ek.clamp(null!=(t=e._axes[r])?t:0,a,s)),Math.abs(ek.clamp(null!=(n=e._previousAxes[r])?n:0,a,s)))};});for(var l=0,u=i.length;l<u;l++)i[l]||(i[l]=function(){return aB});},t.update=function(e){this.pad=e;var t=this._previousAxes,n=this._axes;t.length=0,t.push.apply(t,[].concat(n)),n.length=0,n.push.apply(n,[].concat(e.axes));for(var i=this._buttons,r=0,s=i.length;r<s;r++)i[r].update(e.buttons[r]);return this},t.updateMap=function(e){e.mapping="custom",aO[this.id]=e,this.map=e,this.mapping="custom",this._compileMapping();},t.resetMap=function(){if(aO[this.id]){delete aO[this.id];var e=ak(this.pad);this.map=e,this.mapping=e.mapping,this._compileMapping();}},t.pulse=function(e,t,n){var i=this;return aE(function(){var r,s,a,o,l,u,c;return aC(this,function(h){switch(h.label){case 0:if(!(r=i.pad.vibrationActuator?[i.pad.vibrationActuator]:i.pad.hapticActuators||aP).length)return [3,2];return a=null!=(s=null==n?void 0:n.startDelay)?s:0,l=null!=(o=null==n?void 0:n.strongMagnitude)?o:e,c=null!=(u=null==n?void 0:n.weakMagnitude)?u:e,[4,Promise.all(r.map(aE(function(n){return aC(this,function(i){switch(i.label){case 0:if(!n)return [2,true];if(!n.playEffect)return [3,1];return [2,n.playEffect(n.type,{duration:t,startDelay:a,strongMagnitude:l,weakMagnitude:c})];case 1:if(!n.pulse)return [3,3];return [4,new Promise(function(e){setTimeout(e,a);})];case 2:return i.sent(),[2,n.pulse(e,t)];case 3:return [2,false]}})})))];case 1:return [2,h.sent().some(function(e){return  true===e||"complete"===e})];case 2:return [2,false]}})})()},t.getButton=function(e){var t=this._compiledMapping.buttons[e];return t?t():aB},t.isPressed=function(e){return this.getButton(e).pressed},t.wasPressed=function(e){return this.getButton(e).wasPressed},t.wasReleased=function(e){return this.getButton(e).wasReleased},t.isTouched=function(e){return this.getButton(e).touched},t.wasTouched=function(e){return this.getButton(e).wasTouched},t.getValue=function(e){return this.getButton(e).value},t.getAxis=function(e){var t=this.axes[e];return t&&Math.abs(t)>aN?t:0},aw(e,[{key:"connected",get:function(){return this.pad.connected}},{key:"axes",get:function(){return this._compiledMapping.axes.map(function(e){return e()})}},{key:"buttons",get:function(){return this._compiledMapping.buttons.map(function(e){return e()})}}]),e}(),az=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return (t=e.call(this)||this).gamepadsSupported=ef.gamepads,t.current=[],t._previous=[],t._ongamepadconnectedHandler=t._ongamepadconnected.bind(t),t._ongamepaddisconnectedHandler=t._ongamepaddisconnected.bind(t),window.addEventListener("gamepadconnected",t._ongamepadconnectedHandler,false),window.addEventListener("gamepaddisconnected",t._ongamepaddisconnectedHandler,false),t.poll(),t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&aA(t,e);var n=t.prototype;return n._ongamepadconnected=function(e){for(var t=new aU(e.gamepad,this.getMap(e.gamepad)),n=this.current,i=n.findIndex(function(e){return e.index===t.index});-1!==i;)n.splice(i,1),i=n.findIndex(function(e){return e.index===t.index});n.push(t),this.fire("gamepadconnected",t);},n._ongamepaddisconnected=function(e){var t=this.current,n=t.findIndex(function(t){return t.index===e.gamepad.index});-1!==n&&(this.fire("gamepaddisconnected",t[n]),t.splice(n,1));},n.update=function(){this.poll();},n.poll=function(e){ void 0===e&&(e=[]),e.length>0&&(e.length=0);for(var t=aI(),n=0,i=t.length;n<i;n++)if(t[n]){var r=this.findByIndex(t[n].index);if(r)e.push(r.update(t[n]));else {var s=new aU(t[n],this.getMap(t[n]));this.current.push(s),e.push(s);}}return e},n.destroy=function(){window.removeEventListener("gamepadconnected",this._ongamepadconnectedHandler,false),window.removeEventListener("gamepaddisconnected",this._ongamepaddisconnectedHandler,false);},n.getMap=function(e){return ak(e)},n.isPressed=function(e,t){var n;return (null==(n=this.current[e])?void 0:n.isPressed(t))||false},n.wasPressed=function(e,t){var n;return (null==(n=this.current[e])?void 0:n.wasPressed(t))||false},n.wasReleased=function(e,t){var n;return (null==(n=this.current[e])?void 0:n.wasReleased(t))||false},n.getAxis=function(e,t){var n;return (null==(n=this.current[e])?void 0:n.getAxis(t))||0},n.pulse=function(e,t,n,i){var r=this.current[e];return r?r.pulse(t,n,i):Promise.resolve(false)},n.pulseAll=function(e,t,n){return Promise.all(this.current.map(function(i){return i.pulse(e,t,n)}))},n.findById=function(e){return this.current.find(function(t){return t&&t.id===e})||null},n.findByIndex=function(e){return this.current.find(function(t){return t&&t.index===e})||null},aw(t,[{key:"deadZone",get:function(){return aN},set:function(e){aN=e;}},{key:"previous",get:function(){for(var e=this.current,t=0,n=e.length;t<n;t++){var i=e[t]._buttons;this._previous[t]||(this._previous[t]=[]);for(var r=0,s=i.length;r<s;r++){var a=i[t];this.previous[t][r]=!!a&&(!a.wasPressed&&a.pressed||a.wasReleased);}}return this._previous.length=this.current.length,this._previous}}]),t}(ex);function aV(e){for(var t,n,r=0,s=0,a=e.target;t=a,(null!=(n=HTMLElement)&&"undefined"!=typeof Symbol&&n[Symbol.hasInstance]?!n[Symbol.hasInstance](t):!i(t,n))&&a;)a=a.parentNode;for(;a;)r+=a.offsetLeft-a.scrollLeft,s+=a.offsetTop-a.scrollTop,a=a.offsetParent;return {x:e.pageX-r,y:e.pageY-s}}az.EVENT_GAMEPADCONNECTED="gamepadconnected",az.EVENT_GAMEPADDISCONNECTED="gamepaddisconnected";var aG=function(e){var t=aV(e);this.id=e.identifier,this.x=t.x,this.y=t.y,this.target=e.target,this.touch=e;},aH=function(){function e(e,t){this.touches=[],this.changedTouches=[],this.element=t.target,this.event=t,this.touches=Array.from(t.touches).map(function(e){return new aG(e)}),this.changedTouches=Array.from(t.changedTouches).map(function(e){return new aG(e)});}return e.prototype.getTouchById=function(e,t){return t.find(function(t){return t.id===e})||null},e}();function aW(e,t){return (aW=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var aj=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this)._element=null,n._startHandler=n._handleTouchStart.bind(n),n._endHandler=n._handleTouchEnd.bind(n),n._moveHandler=n._handleTouchMove.bind(n),n._cancelHandler=n._handleTouchCancel.bind(n),n.attach(t),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&aW(t,e);var n=t.prototype;return n.attach=function(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("touchstart",this._startHandler,false),this._element.addEventListener("touchend",this._endHandler,false),this._element.addEventListener("touchmove",this._moveHandler,false),this._element.addEventListener("touchcancel",this._cancelHandler,false);},n.detach=function(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,false),this._element.removeEventListener("touchend",this._endHandler,false),this._element.removeEventListener("touchmove",this._moveHandler,false),this._element.removeEventListener("touchcancel",this._cancelHandler,false)),this._element=null;},n._handleTouchStart=function(e){this.fire("touchstart",new aH(this,e));},n._handleTouchEnd=function(e){this.fire("touchend",new aH(this,e));},n._handleTouchMove=function(e){e.preventDefault(),this.fire("touchmove",new aH(this,e));},n._handleTouchCancel=function(e){this.fire("touchcancel",new aH(this,e));},t}(ex);function aX(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}aj.EVENT_TOUCHSTART="touchstart",aj.EVENT_TOUCHEND="touchend",aj.EVENT_TOUCHMOVE="touchmove",aj.EVENT_TOUCHCANCEL="touchcancel";var aY=function(){function e(){}var t=e.prototype;return t.get=function(e,t,n){"function"==typeof t&&(n=t,t={});var i=this.request("GET",e,t,n),r=t.progress;if(r){var s=function(e){e.lengthComputable&&r.fire("progress",e.loaded,e.total);},a=function(e){s(e),i.removeEventListener("loadstart",s),i.removeEventListener("progress",s),i.removeEventListener("loadend",a);};i.addEventListener("loadstart",s),i.addEventListener("progress",s),i.addEventListener("loadend",a);}return i},t.post=function(e,t,n,i){return "function"==typeof n&&(i=n,n={}),n.postdata=t,this.request("POST",e,n,i)},t.put=function(e,t,n,i){return "function"==typeof n&&(i=n,n={}),n.postdata=t,this.request("PUT",e,n,i)},t.del=function(e,t,n){return "function"==typeof t&&(n=t,t={}),this.request("DELETE",e,t,n)},t.request=function(t,n,i,r){var s,a,o,l=this,u=false;if("function"==typeof i&&(r=i,i={}),i.retry&&(i=Object.assign({retries:0,maxRetries:5},i)),i.callback=r,null==i.async&&(i.async=true),null==i.headers&&(i.headers={}),null!=i.postdata)if(aX(i.postdata,Document))o=i.postdata;else if(aX(i.postdata,FormData))o=i.postdata;else if(aX(i.postdata,Object)){var c=i.headers["Content-Type"];switch(void 0===c&&(i.headers["Content-Type"]=e.ContentType.FORM_URLENCODED,c=i.headers["Content-Type"]),c){case e.ContentType.FORM_URLENCODED:o="";var h=true;for(var f in i.postdata)i.postdata.hasOwnProperty(f)&&(h?h=false:o+="&",o+=encodeURIComponent(f)+"="+encodeURIComponent(i.postdata[f]));break;default:case e.ContentType.JSON:null==c&&(i.headers["Content-Type"]=e.ContentType.JSON),o=JSON.stringify(i.postdata);}}else o=i.postdata;if(false===i.cache){var d=eL();(s=new eR(n)).query?s.query=s.query+"&ts="+d:s.query="ts="+d,n=s.toString();}i.query&&(a=ee((s=new eR(n)).getQuery(),i.query),s.setQuery(a),n=s.toString());var p=new XMLHttpRequest;for(var m in p.open(t,n,i.async),p.withCredentials=void 0!==i.withCredentials&&i.withCredentials,p.responseType=i.responseType||this._guessResponseType(n),i.headers)i.headers.hasOwnProperty(m)&&p.setRequestHeader(m,i.headers[m]);p.onreadystatechange=function(){l._onReadyStateChange(t,n,i,p);},p.onerror=function(){l._onError(t,n,i,p),u=true;};try{p.send(o);}catch(e){u||i.error(p.status,p,e);}return p},t._guessResponseType=function(t){var n=new eR(t),i=en.getExtension(n.path).toLowerCase();return e.binaryExtensions.indexOf(i)>=0?e.ResponseType.ARRAY_BUFFER:".json"===i?e.ResponseType.JSON:".xml"===i?e.ResponseType.DOCUMENT:e.ResponseType.TEXT},t._isBinaryContentType=function(t){return [e.ContentType.BASIS,e.ContentType.BIN,e.ContentType.DDS,e.ContentType.GLB,e.ContentType.MP3,e.ContentType.MP4,e.ContentType.OGG,e.ContentType.OPUS,e.ContentType.WAV].indexOf(t)>=0},t._isBinaryResponseType=function(t){return t===e.ResponseType.ARRAY_BUFFER||t===e.ResponseType.BLOB||t===e.ResponseType.JSON},t._onReadyStateChange=function(e,t,n,i){if(4===i.readyState)switch(i.status){case 0:i.responseURL&&i.responseURL.startsWith("file:///")?this._onSuccess(e,t,n,i):this._onError(e,t,n,i);break;case 200:case 201:case 206:case 304:this._onSuccess(e,t,n,i);break;default:this._onError(e,t,n,i);}},t._onSuccess=function(t,n,i,r){var s,a,o=r.getResponseHeader("Content-Type");o&&(a=o.split(";")[0].trim());try{s=this._isBinaryContentType(a)||this._isBinaryResponseType(r.responseType)?r.response:a===e.ContentType.JSON||n.split("?")[0].endsWith(".json")?JSON.parse(r.responseText):r.responseType===e.ResponseType.DOCUMENT||a===e.ContentType.XML?r.responseXML:r.responseText,i.callback(null,s);}catch(e){i.callback(e);}},t._onError=function(t,n,i,r){var s=this;i.retrying||(i.retry&&i.retries<i.maxRetries?(i.retries++,i.retrying=true,setTimeout(function(){i.retrying=false,s.request(t,n,i,i.callback);},ek.clamp(Math.pow(2,i.retries)*e.retryDelay,0,i.maxRetryDelay||5e3))):i.callback(0===r.status?"Network error":r.status,null));},e}();aY.ContentType={AAC:"audio/aac",BASIS:"image/basis",BIN:"application/octet-stream",DDS:"image/dds",FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",GLB:"model/gltf-binary",JPEG:"image/jpeg",JSON:"application/json",MP3:"audio/mpeg",MP4:"audio/mp4",OGG:"audio/ogg",OPUS:'audio/ogg; codecs="opus"',PNG:"image/png",TEXT:"text/plain",WAV:"audio/x-wav",XML:"application/xml"},aY.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},aY.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb",".opus"],aY.retryDelay=100;var aq=new aY,aK="linear",aZ="inverse",aQ="exponential",aJ=function(){function e(e){this.position=new eW,this.orientation=new e$,this._manager=e;}var t,n=e.prototype;return n.getPosition=function(){return this.position},n.setPosition=function(e){this.position.copy(e);var t=this.listener;t&&("positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z));},n.setOrientation=function(e){this.orientation.copy(e);var t=this.listener;if(t){var n=e.data;"forwardX"in t?(t.forwardX.value=-n[8],t.forwardY.value=-n[9],t.forwardZ.value=-n[10],t.upX.value=n[4],t.upY.value=n[5],t.upZ.value=n[6]):t.setOrientation&&t.setOrientation(-n[8],-n[9],-n[10],n[4],n[5],n[6]);}},n.getOrientation=function(){return this.orientation},t=[{key:"listener",get:function(){var e=this._manager.context;return e?e.listener:null}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function a$(e,t){return (a$=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var a0="running",a1=["click","touchstart","mousedown"],a2=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return (t=e.call(this)||this)._context=null,t.AudioContext="undefined"!=typeof AudioContext&&AudioContext||"undefined"!=typeof webkitAudioContext&&webkitAudioContext,!t.AudioContext,t._unlockHandlerFunc=t._unlockHandler.bind(t),t._userSuspended=false,t.listener=new aJ(t),t._volume=1,t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&a$(t,e);var n,i=t.prototype;return i.suspend=function(){!this._userSuspended&&(this._userSuspended=true,this._context&&this._context.state===a0&&this._suspend());},i.resume=function(){this._userSuspended&&(this._userSuspended=false,this._context&&this._context.state!==a0&&this._resume());},i.destroy=function(){if(this.fire("destroy"),this._context){var e;this._removeUnlockListeners(),null==(e=this._context)||e.close(),this._context=null;}},i._resume=function(){var e=this;this._context.resume().then(function(){var t=e._context.createBufferSource();t.buffer=e._context.createBuffer(1,1,e._context.sampleRate),t.connect(e._context.destination),t.start(0),t.onended=function(n){t.disconnect(0),e.fire("resume");};},function(e){}).catch(function(e){});},i._suspend=function(){var e=this;this._context.suspend().then(function(){e.fire("suspend");},function(e){}).catch(function(e){});},i._unlockHandler=function(){this._removeUnlockListeners(),this._userSuspended||this._context.state===a0||this._resume();},i._registerUnlockListeners=function(){var e=this;a1.forEach(function(t){window.addEventListener(t,e._unlockHandlerFunc,false);});},i._removeUnlockListeners=function(){var e=this;a1.forEach(function(t){window.removeEventListener(t,e._unlockHandlerFunc,false);});},n=[{key:"volume",get:function(){return this._volume},set:function(e){e=ek.clamp(e,0,1),this._volume=e,this.fire("volumechange",e);}},{key:"suspended",get:function(){return this._userSuspended}},{key:"context",get:function(){return !this._context&&this.AudioContext&&(this._context=new this.AudioContext,this._context.state!==a0&&this._registerUnlockListeners()),this._context}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex),a3=function(){var e;function t(e){var t;(null!=(t=Audio)&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t))?this.audio=e:this.buffer=e;}return e=[{key:"duration",get:function(){var e=0;return this.buffer?e=this.buffer.duration:this.audio&&(e=this.audio.duration),e||0}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}();function a4(){return "undefined"!=typeof AudioContext||"undefined"!=typeof webkitAudioContext}function a5(e,t){return (a5=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var a8=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i){var r;return (r=e.call(this)||this).source=null,r._manager=t,r._volume=void 0!==i.volume?ek.clamp(Number(i.volume)||0,0,1):1,r._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,r._loop=!!(void 0!==i.loop&&i.loop),r._sound=n,r._state=2,r._suspended=false,r._suspendEndEvent=0,r._suspendInstanceEvents=false,r._playWhenLoaded=true,r._startTime=Math.max(0,Number(i.startTime)||0),r._duration=Math.max(0,Number(i.duration)||0),r._startOffset=null,r._onPlayCallback=i.onPlay,r._onPauseCallback=i.onPause,r._onResumeCallback=i.onResume,r._onStopCallback=i.onStop,r._onEndCallback=i.onEnd,a4()?(r._startedAt=0,r._currentTime=0,r._currentOffset=0,r._inputNode=null,r._connectorNode=null,r._firstNode=null,r._lastNode=null,r._waitingContextSuspension=false,r._initializeNodes(),r._endedHandler=r._onEnded.bind(r)):(r._isReady=false,r._loadedMetadataHandler=r._onLoadedMetadata.bind(r),r._timeUpdateHandler=r._onTimeUpdate.bind(r),r._endedHandler=r._onEnded.bind(r),r._createSource()),r}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&a5(t,e);var n,i=t.prototype;return i._onPlay=function(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this);},i._onPause=function(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this);},i._onResume=function(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this);},i._onStop=function(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this);},i._onEnded=function(){if(this._suspendEndEvent>0)return void this._suspendEndEvent--;this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop();},i._onManagerVolumeChange=function(){this.volume=this._volume;},i._onManagerSuspend=function(){0!==this._state||this._suspended||(this._suspended=true,this.pause());},i._onManagerResume=function(){this._suspended&&(this._suspended=false,this.resume());},i._initializeNodes=function(){this.gain=this._manager.context.createGain(),this._inputNode=this.gain,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination);},i.play=function(){return 2!==this._state&&this.stop(),this._state=0,this._playWhenLoaded=false,!this._waitingContextSuspension&&(this._manager.suspended?(this._manager.once("resume",this._playAudioImmediate,this),this._waitingContextSuspension=true,false):(this._playAudioImmediate(),true))},i._playAudioImmediate=function(){if(this._waitingContextSuspension=false,0===this._state){this.source||this._createSource();var e=this._startOffset%this.duration||0;e=(this._startTime+e)%this._sound.duration||0,this._startOffset=null,this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._suspendInstanceEvents||this._onPlay();}},i.pause=function(){return this._playWhenLoaded=false,0===this._state&&(this._state=1,!!this._waitingContextSuspension||(this._updateCurrentTime(),this._suspendEndEvent++,this.source.stop(0),this.source=null,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),true))},i.resume=function(){if(1!==this._state)return  false;var e=this.currentTime;return this._state=0,!!this._waitingContextSuspension||(this.source||this._createSource(),null!==this._startOffset&&(e=this._startOffset%this.duration||0,e=(this._startTime+e)%this._sound.duration||0,this._startOffset=null),this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=false,this._suspendInstanceEvents||this._onResume(),true)},i.stop=function(){if(this._playWhenLoaded=false,2===this._state)return  false;var e=0===this._state;return this._state=2,!!this._waitingContextSuspension||(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._startOffset=null,this._suspendEndEvent++,e&&this.source&&this.source.stop(0),this.source=null,this._suspendInstanceEvents||this._onStop(),true)},i.setExternalNodes=function(e,t){if(e){t||(t=e);var n=this._manager.context.destination;this._firstNode!==e&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(n),this._firstNode=e,this._connectorNode.connect(e)),this._lastNode!==t&&(this._lastNode&&this._lastNode.disconnect(n),this._lastNode=t,this._lastNode.connect(n));}},i.clearExternalNodes=function(){var e=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(e),this._lastNode=null),this._connectorNode.connect(e);},i.getExternalNodes=function(){return [this._firstNode,this._lastNode]},i._createSource=function(){if(!this._sound)return null;var e=this._manager.context;return this._sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=this._startTime%this.source.buffer.duration||0,this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,(this._startTime+this._duration)%this.source.buffer.duration||0))),this.source},i._updateCurrentTime=function(){this._currentTime=((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset)%this.duration||0;},i._onManagerDestroy=function(){this.source&&0===this._state&&(this.source.stop(0),this.source=null);},n=[{key:"currentTime",get:function(){return null!==this._startOffset?this._startOffset:1===this._state?this._currentTime:2!==this._state&&this.source?(this._updateCurrentTime(),this._currentTime):0},set:function(e){if(!(e<0))if(0===this._state){var t=this._suspendInstanceEvents;this._suspendInstanceEvents=true,this.stop(),this._startOffset=e,this.play(),this._suspendInstanceEvents=t;}else this._startOffset=e,this._currentTime=e;}},{key:"duration",get:function(){if(!this._sound)return 0;if(this._duration)return this._duration%this._sound.duration||0;return this._sound.duration},set:function(e){this._duration=Math.max(0,Number(e)||0);var t=0===this._state;this.stop(),t&&this.play();}},{key:"isPaused",get:function(){return 1===this._state}},{key:"isPlaying",get:function(){return 0===this._state}},{key:"isStopped",get:function(){return 2===this._state}},{key:"isSuspended",get:function(){return this._suspended}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=!!e,this.source&&(this.source.loop=this._loop);}},{key:"pitch",get:function(){return this._pitch},set:function(e){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch);}},{key:"sound",get:function(){return this._sound},set:function(e){this._sound=e,2!==this._state?this.stop():this._createSource();}},{key:"startTime",get:function(){return this._startTime},set:function(e){this._startTime=Math.max(0,Number(e)||0);var t=0===this._state;this.stop(),t&&this.play();}},{key:"volume",get:function(){return this._volume},set:function(e){e=ek.clamp(e,0,1),this._volume=e,this.gain&&(this.gain.gain.value=e*this._manager.volume);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function a6(e,t){return (a6=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}a8.EVENT_PLAY="play",a8.EVENT_PAUSE="pause",a8.EVENT_RESUME="resume",a8.EVENT_STOP="stop",a8.EVENT_END="end",a4()||(Object.assign(a8.prototype,{play:function(){return 2!==this._state&&this.stop(),(!!this.source||!!this._createSource())&&(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=0,this._playWhenLoaded=false,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),true)},pause:function(){return !!this.source&&0===this._state&&(this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=false,this._state=1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),true)},resume:function(){return !!this.source&&1===this._state&&(this._state=0,this._playWhenLoaded=false,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),true)},stop:function(){return !!this.source&&2!==this._state&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=false,this._state=2,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),true)},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return [null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=true;var e=this._startOffset%this.duration||0;e=(this._startTime+e)%this._sound.duration||0,this._startOffset=null,this.source.currentTime=e;},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=false,this.source=this._sound.audio.cloneNode(true),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>((this._startTime+this._duration)%this.source.duration||0)&&(this.loop?this.source.currentTime=this._startTime%this.source.duration||0:(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()));},_onManagerDestroy:function(){this.source&&this.source.pause();}}),Object.defineProperty(a8.prototype,"volume",{get:function(){return this._volume},set:function(e){e=ek.clamp(e,0,1),this._volume=e,this.source&&(this.source.volume=e*this._manager.volume);}}),Object.defineProperty(a8.prototype,"pitch",{get:function(){return this._pitch},set:function(e){this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate=this._pitch);}}),Object.defineProperty(a8.prototype,"sound",{get:function(){return this._sound},set:function(e){this.stop(),this._sound=e;}}),Object.defineProperty(a8.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function(e){!(e<0)&&(this._startOffset=e,this.source&&this._isReady)&&(this.source.currentTime=(this._startTime+(e%this.duration||0))%this._sound.duration||0,this._startOffset=null);}}));var a9=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(t,n,i){var r;return void 0===i&&(i={}),(r=e.call(this,t,n,i)||this)._position=new eW,r._velocity=new eW,i.position&&(r.position=i.position),r.maxDistance=void 0!==i.maxDistance?Number(i.maxDistance):1e4,r.refDistance=void 0!==i.refDistance?Number(i.refDistance):1,r.rollOffFactor=void 0!==i.rollOffFactor?Number(i.rollOffFactor):1,r.distanceModel=void 0!==i.distanceModel?i.distanceModel:aK,r}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:true,configurable:true}}),e&&a6(n,e),n.prototype._initializeNodes=function(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination);},t=[{key:"position",get:function(){return this._position},set:function(e){this._position.copy(e);var t=this.panner;"positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z);}},{key:"velocity",get:function(){return this._velocity},set:function(e){this._velocity.copy(e);}},{key:"maxDistance",get:function(){return this.panner.maxDistance},set:function(e){this.panner.maxDistance=e;}},{key:"refDistance",get:function(){return this.panner.refDistance},set:function(e){this.panner.refDistance=e;}},{key:"rollOffFactor",get:function(){return this.panner.rolloffFactor},set:function(e){this.panner.rolloffFactor=e;}},{key:"distanceModel",get:function(){return this.panner.distanceModel},set:function(e){this.panner.distanceModel=e;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(n.prototype,t),n}(a8);if(!a4()){var a7=new eW,oe=function(e,t,n,i,r,s){var a=(a7=a7.sub2(e,t)).length();if(a<n)return 1;if(a>i)return 0;var o=0;return s===aK?o=1-r*(a-n)/(i-n):s===aZ?o=n/(n+r*(a-n)):s===aQ&&(o=Math.pow(a/n,-r)),ek.clamp(o,0,1)};Object.defineProperty(a9.prototype,"position",{get:function(){return this._position},set:function(e){if(this._position.copy(e),this.source){var t=oe(this._manager.listener.getPosition(),this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),n=this.volume;this.source.volume=n*t*this._manager.volume;}}}),Object.defineProperty(a9.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(e){this._maxDistance=e;}}),Object.defineProperty(a9.prototype,"refDistance",{get:function(){return this._refDistance},set:function(e){this._refDistance=e;}}),Object.defineProperty(a9.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(e){this._rollOffFactor=e;}}),Object.defineProperty(a9.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(e){this._distanceModel=e;}});}var ot=((h={})[0]="SUBTRACTIVE",h[1]="ADDITIVE",h[2]="NORMAL",h[3]="NONE",h[4]="PREMULTIPLIED",h[5]="MULTIPLICATIVE",h[6]="ADDITIVEALPHA",h[7]="MULTIPLICATIVE2X",h[8]="SCREEN",h[9]="MIN",h[10]="MAX",h),on="none",oi="linear",or=((f={})[0]="NONE",f[2]="SCHLICK",f),os=((d={})[0]="DIRECTIONAL",d[1]="OMNI",d[2]="SPOT",d),oa=((p={})[0]="PUNCTUAL",p[1]="RECT",p[2]="DISK",p[3]="SPHERE",p),oo=((m={})[0]="LINEAR",m[1]="INVERSESQUARED",m),ol=new Map([[5,{name:"PCF1_32F",kind:"PCF1",format:16,pcf:true}],[0,{name:"PCF3_32F",kind:"PCF3",format:16,pcf:true}],[4,{name:"PCF5_32F",kind:"PCF5",format:16,pcf:true}],[7,{name:"PCF1_16F",kind:"PCF1",format:69,pcf:true}],[8,{name:"PCF3_16F",kind:"PCF3",format:69,pcf:true}],[9,{name:"PCF5_16F",kind:"PCF5",format:69,pcf:true}],[2,{name:"VSM_16F",kind:"VSM",format:12,vsm:true}],[3,{name:"VSM_32F",kind:"VSM",format:14,vsm:true}],[6,{name:"PCSS_32F",kind:"PCSS",format:15,pcss:true}]]),ou=((_={})[0]="NONE",_[1]="BOX",_),oc=((v={})[0]="NONE",v[1]="SRGB",v),oh=["LINEAR","FILMIC","HEJL","ACES","ACES2","NEUTRAL","NONE"],of=((g={})[0]="NONE",g[1]="AO",g[2]="GLOSSDEPENDENT",g),od="none",op="envAtlas",om="envAtlasHQ",o_="cubeMap",ov="sphereMap",og=((y={})[od]="NONE",y[op]="ENVATLAS",y[om]="ENVATLASHQ",y[o_]="CUBEMAP",y[ov]="SPHEREMAP",y),oy="ambientSH",oS="envAtlas",ox="constant",ob=((S={})[oy]="AMBIENTSH",S[oS]="ENVALATLAS",S[ox]="CONSTANT",S),oT=((x={})[0]="SIMPLE",x[1]="SLICED",x[2]="TILED",x),oE="infinite",ow="dome",oA="none",oC="bayer8",oP="bluenoise",oI="ignnoise",oL=((b={})[oA]="NONE",b[oC]="BAYER8",b[oP]="BLUENOISE",b[oI]="IGNNOISE",b),oD="prerender",oM="postrender",oR="prerender:layer",oO="postrender:layer",ok="precull",oN="postcull",oF="cull:end",oB=function(){function e(e,t,n){this.uniformFormats=[],this.bindGroupFormats=[],this.uniformFormats[0]=e,this.bindGroupFormats[0]=t,this.vertexFormat=n;}var t=e.prototype;return t.hasUniform=function(e){for(var t=0;t<this.uniformFormats.length;t++){var n=this.uniformFormats[t];if(null==n?void 0:n.get(e))return  true}return  false},t.hasTexture=function(e){for(var t=0;t<this.bindGroupFormats.length;t++){var n=this.bindGroupFormats[t];if(null==n?void 0:n.getTexture(e))return  true}return  false},t.getVertexElement=function(e){var t;return null==(t=this.vertexFormat)?void 0:t.elements.find(function(t){return t.name===e})},t.generateKey=function(e){var t,n=JSON.stringify(this.uniformFormats)+JSON.stringify(this.bindGroupFormats);return e.isWebGPU&&(n+=null==(t=this.vertexFormat)?void 0:t.shaderProcessingHashString),n},e}(),oU=new nD;function oz(e){return oU.get(e)}var oV=function(){function e(){}return e.definesHash=function(e){return n2(JSON.stringify(Array.from(e).sort(function(e,t){return e[0]>t[0]?1:-1})))},e}(),oG=new nD,oH=function(){function e(e,t,n){ void 0===n&&(n={}),this.defines=new Map,this.name=e,this.index=t,Object.assign(this,n),this.buildShaderDefines();}return e.prototype.buildShaderDefines=function(){var e;this.isShadow?e="SHADOW":this.isForward?e="FORWARD":3===this.index&&(e="PICK"),this.defines.set(""+e+"_PASS",""),this.defines.set(""+this.name.toUpperCase()+"_PASS","");},e}(),oW=function(){function e(){var e=this;this.passesNamed=new Map,this.passesIndexed=[],this.nextIndex=0;var t=function(t,n,i){e.allocate(t,i);};t("forward",0,{isForward:true}),t("prepass"),t("shadow"),t("pick");}var t=e.prototype;return t.allocate=function(e,t){var n=this.passesNamed.get(e);return void 0===n&&(n=new oH(e,this.nextIndex,t),this.passesNamed.set(n.name,n),this.passesIndexed[n.index]=n,this.nextIndex++),n},t.getByIndex=function(e){return this.passesIndexed[e]},t.getByName=function(e){return this.passesNamed.get(e)},e.get=function(t){return oG.get(t,function(){return new e})},e}();function oj(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function oX(e,t,n){return (oX=oZ()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&oq(r,n.prototype),r}).apply(null,arguments)}function oY(e){return (oY=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function oq(e,t){return (oq=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function oK(e){var t="function"==typeof Map?new Map:void 0;return (oK=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n);}function n(){return oX(e,arguments,oY(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:false,writable:true,configurable:true}}),oq(n,e)})(e)}function oZ(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));}catch(e){}return (oZ=function(){return !!e})()}function oQ(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return oj(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return oj(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var oJ=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return t=e.apply(this,arguments)||this,t._keyDirty=false,t._key="",t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&oq(t,e);var n,i=t.prototype;return i.set=function(t,n){return this.has(t)&&this.get(t)===n||this.markDirty(),e.prototype.set.call(this,t,n)},i.add=function(e){for(var t,n=oQ(Object.entries(e));!(t=n()).done;){var i=t.value,r=i[0],s=i[1];this.set(r,s);}return this},i.delete=function(t){var n=this.has(t),i=e.prototype.delete.call(this,t);return n&&i&&this.markDirty(),i},i.clear=function(){this.size>0&&this.markDirty(),e.prototype.clear.call(this);},i.markDirty=function(){this._dirty=true,this._keyDirty=true;},i.isDirty=function(){return this._dirty},i.resetDirty=function(){this._dirty=false;},i.copy=function(e){this.clear();for(var t,n=oQ(e);!(t=n()).done;){var i=t.value,r=i[0],s=i[1];this.set(r,s);}return this},n=[{key:"key",get:function(){return this._keyDirty&&(this._keyDirty=false,this._key=Array.from(this.entries()).sort(function(e,t){var n=e[0],i=t[0];return n<i?-1:+(n>i)}).map(function(e){return e[0]+"="+n2(e[1])}).join(",")),this._key}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(oK(Map)),o$=new nD,o0=function(){function e(){this.glsl=new oJ,this.wgsl=new oJ,this.version="";}var t,n=e.prototype;return n.isDirty=function(){return this.glsl.isDirty()||this.wgsl.isDirty()},n.resetDirty=function(){this.glsl.resetDirty(),this.wgsl.resetDirty();},n.copy=function(e){return this.version=e.version,this.glsl.copy(e.glsl),this.wgsl.copy(e.wgsl),this},e.get=function(t,n){ void 0===n&&(n=nn);var i=o$.get(t,function(){return new e});return n===nn?i.glsl:i.wgsl},t=[{key:"useWGSL",get:function(){return 0===this.glsl.size||this.wgsl.size>0}},{key:"key",get:function(){return "GLSL:"+this.glsl.key+"|WGSL:"+this.wgsl.key+"|API:"+this.version}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function o1(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}var o2=function(){function e(){}return e.merge=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=new Map(null!=(a=t[0])?a:[]),r=1;r<t.length;r++){var s=t[r];if(s)for(var a,o,l=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return o1(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return o1(e,void 0)}}(e))){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(s);!(o=l()).done;){var u=o.value,c=u[0],h=u[1];i.set(c,h);}}return i},e}();function o3(){return (o3=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);}return e}).apply(this,arguments)}function o4(e,t){return (o4=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var o5=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this)||this).key=t,i.shaderDefinition=n,i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&o4(t,e);var n=t.prototype;return n.generateKey=function(e){return this.key},n.createShaderDefinition=function(e,t){return this.shaderDefinition},t}(oV),o8=function(){function e(){}return e.createShader=function(e,t){var n=oz(e),i=n.getCachedShader(t.uniqueName);if(!i){var r=e.isWebGPU&&(!!t.vertexWGSL||!!t.vertexChunk)&&(!!t.fragmentWGSL||!!t.fragmentChunk),s=o0.get(e,r?ni:nn),a=t.vertexChunk?s.get(t.vertexChunk):r?t.vertexWGSL:t.vertexGLSL,o=t.fragmentChunk?s.get(t.fragmentChunk):r?t.fragmentWGSL:t.fragmentGLSL,l=o2.merge(s,t.fragmentIncludes),u=o2.merge(s,t.vertexIncludes);i=new r$(e,rQ.createDefinition(e,{name:t.uniqueName,shaderLanguage:r?ni:nn,attributes:t.attributes,vertexCode:a,fragmentCode:o,useTransformFeedback:t.useTransformFeedback,vertexIncludes:u,vertexDefines:t.vertexDefines,fragmentIncludes:l,fragmentDefines:t.fragmentDefines,fragmentOutputTypes:t.fragmentOutputTypes})),n.setCachedShader(t.uniqueName,i);}return i},e.getCoreDefines=function(e,t){var n=new Map(e.defines);return t.cameraShaderParams.defines.forEach(function(e,t){return n.set(t,e)}),oW.get(t.device).getByIndex(t.pass).defines.forEach(function(e,t){return n.set(t,e)}),n},e.processShader=function(e,t){var n,i=e.definition,r=new o5((null!=(n=i.name)?n:"shader")+"-id-"+e.id,i),s="shader",a=oz(e.device);a.register(s,r);var o=a.getProgram(s,{},t);return a.unregister(s),o},e.addScreenDepthChunkDefines=function(e,t,n){t.sceneDepthMapLinear&&n.set("SCENE_DEPTHMAP_LINEAR",""),e.textureFloatRenderable&&n.set("SCENE_DEPTHMAP_FLOAT","");},e}(),o6={type:5,base:0,baseVertex:0,count:4,indexed:false},o9=new eY,o7=new eY,le=new nz,lt=function(){function e(e){var t=e.device;if(this.shader=e,t.supportsUniformBuffers){var n=new oB;this.shader=o8.processShader(e,n);var i=this.shader.meshUniformBufferFormat;i&&(this.uniformBuffer=new r4(t,i,false));var r=this.shader.meshBindGroupFormat;this.bindGroup=new nV(t,r);}}var t=e.prototype;return t.destroy=function(){var e,t;null==(e=this.uniformBuffer)||e.destroy(),this.uniformBuffer=null,null==(t=this.bindGroup)||t.destroy(),this.bindGroup=null;},t.render=function(e,t){var n=this.shader.device;e&&(o9.set(n.vx,n.vy,n.vw,n.vh),o7.set(n.sx,n.sy,n.sw,n.sh),t=null!=t?t:e,n.setViewport(e.x,e.y,e.z,e.w),n.setScissor(t.x,t.y,t.z,t.w)),n.setVertexBuffer(n.quadVertexBuffer);var i=this.shader;if(n.setShader(i),n.supportsUniformBuffers){n.setBindGroup(0,n.emptyBindGroup);var r=this.bindGroup;r.update(),n.setBindGroup(1,r);var s=this.uniformBuffer;s?(s.update(le),n.setBindGroup(2,le.bindGroup,le.offsets)):n.setBindGroup(2,n.emptyBindGroup);}n.draw(o6),e&&(n.setViewport(o9.x,o9.y,o9.z,o9.w),n.setScissor(o7.x,o7.y,o7.z,o7.w));},e}();function ln(e,t){return (ln=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var li=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i,r){var s;return (s=e.call(this,t)||this).quad=n,s.rect=i,s.scissorRect=r,s}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&ln(t,e),t.prototype.execute=function(){var e=this.device;e.setCullMode(0),e.setDepthState(nq.NODEPTH),e.setStencilState(null,null),this.quad.render(this.rect,this.scissorRect);},t}(s2),lr=new eY;function ls(e,t,n,i,r){var s=new lt(n);i||((i=lr).x=0,i.y=0,i.z=t?t.width:e.width,i.w=t?t.height:e.height);var a=new li(e,s,i,r);a.init(t),a.colorOps.clear=false,a.depthStencilOps.clearDepth=false,e.isWebGPU&&null===t&&e.samples>1&&(a.colorOps.store=true),a.render(),s.destroy();}var la=function(){function e(e,t,n){this._aabb=new e8,this.meshInstance=null,this.origMeshInstances=e,this.dynamic=t,this.batchGroupId=n;}var t,n=e.prototype;return n.destroy=function(e,t){this.meshInstance&&(this.removeFromLayers(e,t),this.meshInstance.destroy(),this.meshInstance=null);},n.addToLayers=function(e,t){for(var n=0;n<t.length;n++){var i=e.layers.getLayerById(t[n]);i&&i.addMeshInstances([this.meshInstance]);}},n.removeFromLayers=function(e,t){for(var n=0;n<t.length;n++){var i=e.layers.getLayerById(t[n]);i&&i.removeMeshInstances([this.meshInstance]);}},n.updateBoundingBox=function(){this._aabb.copy(this.origMeshInstances[0].aabb);for(var e=1;e<this.origMeshInstances.length;e++)this._aabb.add(this.origMeshInstances[e].aabb);this.meshInstance.aabb=this._aabb,this.meshInstance._aabbVer=0;},t=[{key:"model",get:function(){}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),lo=function(e,t,n,i,r){ void 0===r&&(r=[0]),this._ui=false,this._sprite=false,this._obj={model:[],element:[],sprite:[],render:[]},this.id=e,this.name=t,this.dynamic=n,this.maxAabbSize=i,this.layers=r;};lo.MODEL="model",lo.ELEMENT="element",lo.SPRITE="sprite",lo.RENDER="render";var ll=new e$,lu=function(){function e(e){this._dirty=true,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=true,e&&this.initSkin(e);}var t,n=e.prototype;return n.init=function(e,t){var n=3*t,i=Math.ceil(Math.sqrt(n)),r=Math.ceil(n/(i=ek.roundUp(i,3)));this.boneTexture=new nO(e,{width:i,height:r,format:14,mipmaps:false,minFilter:0,magFilter:0,name:"skin"}),this.matrixPalette=this.boneTexture.lock({mode:1}),this.boneTexture.unlock();},n.destroy=function(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null);},n.resolve=function(e,t){this.rootBone=e;for(var n=this.skin,i=[],r=0;r<n.boneNames.length;r++){var s=n.boneNames[r],a=e.findByName(s);a||(a=t),i.push(a);}this.bones=i;},n.initSkin=function(e){this.skin=e,this.bones=[];var t=e.inverseBindPose.length;this.init(e.device,t),this.matrices=[];for(var n=0;n<t;n++)this.matrices[n]=new e$;},n.uploadBones=function(e){this.boneTexture.upload();},n._updateMatrices=function(e,t){if(this._skinUpdateIndex!==t){this._skinUpdateIndex=t,ll.copy(e.getWorldTransform()).invert();for(var n=this.bones.length-1;n>=0;n--)this.matrices[n].mulAffine2(ll,this.bones[n].getWorldTransform()),this.matrices[n].mulAffine2(this.matrices[n],this.skin.inverseBindPose[n]);}},n.updateMatrices=function(e,t){this._updateBeforeCull&&this._updateMatrices(e,t);},n.updateMatrixPalette=function(e,t){this._updateMatrices(e,t);for(var n=this.matrixPalette,i=this.bones.length,r=0;r<i;r++){var s=this.matrices[r].data,a=12*r;n[a]=s[0],n[a+1]=s[4],n[a+2]=s[8],n[a+3]=s[12],n[a+4]=s[1],n[a+5]=s[5],n[a+6]=s[9],n[a+7]=s[13],n[a+8]=s[2],n[a+9]=s[6],n[a+10]=s[10],n[a+11]=s[14];}this.uploadBones(this.skin.device);},t=[{key:"rootBone",get:function(){return this._rootBone},set:function(e){this._rootBone=e;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function lc(e,t){return (lc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var lh=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i){var r=e.call(this)||this,s=n.length;return r.init(t,s),r.device=t,r.rootNode=i,r.bones=n,r}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&lc(t,e);var n=t.prototype;return n.updateMatrices=function(e,t){},n.updateMatrixPalette=function(e,t){for(var n=this.matrixPalette,i=this.bones.length,r=0;r<i;r++){var s=this.bones[r].getWorldTransform().data,a=12*r;n[a]=s[0],n[a+1]=s[4],n[a+2]=s[8],n[a+3]=s[12],n[a+4]=s[1],n[a+5]=s[5],n[a+6]=s[9],n[a+7]=s[13],n[a+8]=s[2],n[a+9]=s[6],n[a+10]=s[10],n[a+11]=s[14];}this.uploadBones(this.device);},t}(lu);function lf(e,t){return (lf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ld=0,lp=function(){function e(){this.initDefaults();}var t=e.prototype;return t.initDefaults=function(){this.recreate=false,this.verticesUsage=0,this.indicesUsage=0,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=false,this.indexStreamUpdated=false,this.vertexStreamDictionary={},this.indices=null;},t._changeVertexCount=function(e,t){this.vertexCount||(this.vertexCount=e);},e}();lp.DEFAULT_COMPONENTS_POSITION=3,lp.DEFAULT_COMPONENTS_NORMAL=3,lp.DEFAULT_COMPONENTS_UV=2,lp.DEFAULT_COMPONENTS_COLORS=4;var lm=function(e,t,n,i,r){this.data=e,this.componentCount=t,this.dataType=n,this.dataTypeNormalize=i,this.asInt=r;},l_=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this)||this).indexBuffer=[null],i.vertexBuffer=null,i.primitive=[{type:0,base:0,baseVertex:0,count:0}],i.skin=null,i.boneAabb=null,i._aabbVer=0,i._aabb=new e8,i._geometryData=null,i._morph=null,i._storageIndex=false,i._storageVertex=false,i.id=ld++,i.device=t,i._storageIndex=(null==n?void 0:n.storageIndex)||false,i._storageVertex=(null==n?void 0:n.storageVertex)||false,i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&lf(t,e);var n,i=t.prototype;return i.destroy=function(){var e=this.morph;e&&(this.morph=null,e.refCount<1&&e.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(var t=0;t<this.indexBuffer.length;t++)this._destroyIndexBuffer(t);this.indexBuffer.length=0,this._geometryData=null;},i._destroyIndexBuffer=function(e){this.indexBuffer[e]&&(this.indexBuffer[e].destroy(),this.indexBuffer[e]=null);},i._initBoneAabbs=function(e){this.boneAabb=[],this.boneUsed=[];for(var t,n,i,r,s,a,o,l,u=[],c=[],h=this.boneUsed,f=this.skin.boneNames.length,d=0;d<f;d++)u[d]=new eW(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),c[d]=new eW(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var p=new ao(this.vertexBuffer),m=p.element[tT],_=p.element[tA],v=p.element[tC],g=this.vertexBuffer.numVertices,y=0;y<g;y++){for(var S=0;S<4;S++)if(_.array[_.index+S]>0){var x=v.array[v.index+S];if(h[x]=true,t=m.array[m.index],n=m.array[m.index+1],i=m.array[m.index+2],r=c[x],(s=u[x]).x>t&&(s.x=t),s.y>n&&(s.y=n),s.z>i&&(s.z=i),r.x<t&&(r.x=t),r.y<n&&(r.y=n),r.z<i&&(r.z=i),e){for(var b=a=t,T=o=n,E=l=i,w=0;w<e.length;w++){var A=e[w],C=A.deltaPositions[3*y],P=A.deltaPositions[3*y+1],I=A.deltaPositions[3*y+2];C<0?b+=C:a+=C,P<0?T+=P:o+=P,I<0?E+=I:l+=I;}s.x>b&&(s.x=b),s.y>T&&(s.y=T),s.z>E&&(s.z=E),r.x<a&&(r.x=a),r.y<o&&(r.y=o),r.z<l&&(r.z=l);}}p.next();}var L=this.vertexBuffer.getFormat().elements.find(function(e){return e.name===tT});if(L&&L.normalize){for(var D=function(){switch(L.dataType){case 0:return function(e){return Math.max(e/127,-1)};case 1:return function(e){return e/255};case 2:return function(e){return Math.max(e/32767,-1)};case 3:return function(e){return e/65535};default:return function(e){return e}}}(),M=0;M<f;M++)if(h[M]){var R=u[M],O=c[M];R.set(D(R.x),D(R.y),D(R.z)),O.set(D(O.x),D(O.y),D(O.z));}}for(var k=0;k<f;k++){var N=new e8;N.setMinMax(u[k],c[k]),this.boneAabb.push(N);}},i._initGeometryData=function(){!this._geometryData&&(this._geometryData=new lp,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices));},i.clear=function(e,t,n,i){ void 0===n&&(n=0),void 0===i&&(i=0),this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=true,this._geometryData.maxVertices=n,this._geometryData.maxIndices=i,this._geometryData.verticesUsage=+!e,this._geometryData.indicesUsage=+!t;},i.setVertexStream=function(e,t,n,i,r,s,a){ void 0===r&&(r=6),void 0===s&&(s=false),void 0===a&&(a=false),this._initGeometryData();var o=i||t.length/n;this._geometryData._changeVertexCount(o,e),this._geometryData.vertexStreamsUpdated=true,this._geometryData.vertexStreamDictionary[e]=new lm(t,n,r,s,a);},i.getVertexStream=function(e,t){var n=0,i=false;if(this._geometryData){var r=this._geometryData.vertexStreamDictionary[e];r&&(i=true,n=this._geometryData.vertexCount,ArrayBuffer.isView(t)?t.set(r.data):(t.length=0,t.push(r.data)));}return !i&&this.vertexBuffer&&(n=new ao(this.vertexBuffer).readData(e,t)),n},i.setPositions=function(e,t,n){ void 0===t&&(t=lp.DEFAULT_COMPONENTS_POSITION),this.setVertexStream(tT,e,t,n,6,false);},i.setNormals=function(e,t,n){ void 0===t&&(t=lp.DEFAULT_COMPONENTS_NORMAL),this.setVertexStream(tE,e,t,n,6,false);},i.setUvs=function(e,t,n,i){ void 0===n&&(n=lp.DEFAULT_COMPONENTS_UV),this.setVertexStream(tI+e,t,n,i,6,false);},i.setColors=function(e,t,n){ void 0===t&&(t=lp.DEFAULT_COMPONENTS_COLORS),this.setVertexStream(tP,e,t,n,6,false);},i.setColors32=function(e,t){this.setVertexStream(tP,e,lp.DEFAULT_COMPONENTS_COLORS,t,1,true);},i.setIndices=function(e,t){this._initGeometryData(),this._geometryData.indexStreamUpdated=true,this._geometryData.indices=e,this._geometryData.indexCount=t||e.length;},i.getPositions=function(e){return this.getVertexStream(tT,e)},i.getNormals=function(e){return this.getVertexStream(tE,e)},i.getUvs=function(e,t){return this.getVertexStream(tI+e,t)},i.getColors=function(e){return this.getVertexStream(tP,e)},i.getIndices=function(e){var t=0;if(this._geometryData&&this._geometryData.indices){var n=this._geometryData.indices;if(t=this._geometryData.indexCount,ArrayBuffer.isView(e))e.set(n);else {e.length=0;for(var i=0,r=n.length;i<r;i++)e.push(n[i]);}}else this.indexBuffer.length>0&&this.indexBuffer[0]&&(t=this.indexBuffer[0].readData(e));return t},i.update=function(e,t){if(void 0===e&&(e=4),void 0===t&&(t=true),this._geometryData){if(t){var n=this._geometryData.vertexStreamDictionary[tT];n&&3===n.componentCount&&(this._aabb.compute(n.data,this._geometryData.vertexCount),this._aabbVer++);}var i=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(i=true,this._geometryData.maxVertices=this._geometryData.vertexCount),i&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);var r=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(r=true,this._geometryData.maxIndices=this._geometryData.indexCount),r&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=e,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=true):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=false),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=false,this._geometryData.indexStreamUpdated=false,this._geometryData.recreate=false,this.updateRenderStates();}},i._buildVertexFormat=function(e){var t=[];for(var n in this._geometryData.vertexStreamDictionary){var i=this._geometryData.vertexStreamDictionary[n];t.push({semantic:n,components:i.componentCount,type:i.dataType,normalize:i.dataTypeNormalize,asInt:i.asInt});}return new n6(this.device,t,e)},i._updateVertexBuffer=function(){if(!this.vertexBuffer){var e=this._geometryData.maxVertices,t=this._buildVertexFormat(e);this.vertexBuffer=new n1(this.device,t,e,{usage:this._geometryData.verticesUsage,storage:this._storageVertex});}var n=new ao(this.vertexBuffer),i=this._geometryData.vertexCount;for(var r in this._geometryData.vertexStreamDictionary){var s=this._geometryData.vertexStreamDictionary[r];n.writeData(r,s.data,i),delete this._geometryData.vertexStreamDictionary[r];}n.end();},i._updateIndexBuffer=function(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){var e=this._geometryData.maxVertices,t=this._storageIndex?{storage:true}:void 0;this.indexBuffer[0]=new s$(this.device,e>65535||0===e?2:1,this._geometryData.maxIndices,this._geometryData.indicesUsage,void 0,t);}var n=this._geometryData.indices;n&&(this.indexBuffer[0].writeData(n,this._geometryData.indexCount),this._geometryData.indices=null);},i.prepareRenderState=function(e){1===e?this.generateWireframe():2===e&&(this.primitive[2]={type:0,base:0,baseVertex:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:false});},i.updateRenderStates=function(){this.primitive[2]&&this.prepareRenderState(2),this.primitive[1]&&this.prepareRenderState(1);},i.generateWireframe=function(){this._destroyIndexBuffer(1);var e,t=this.vertexBuffer.numVertices,n=[];if(this.indexBuffer.length>0&&this.indexBuffer[0]){for(var i=[[0,1],[1,2],[2,0]],r=this.primitive[0].base,s=this.primitive[0].count,a=this.primitive[0].baseVertex||0,o=this.indexBuffer[0],l=new nv[o.format](o.storage),u=new Set,c=r;c<r+s;c+=3)for(var h=0;h<3;h++){var f=l[c+i[h][0]]+a,d=l[c+i[h][1]]+a,p=f>d?d*t+f:f*t+d;u.has(p)||(u.add(p),n.push(f,d));}e=o.format;}else {for(var m=0;m<t;m+=3)n.push(m,m+1,m+1,m+2,m+2,m);e=n.length>65535?2:1;}var _=new s$(this.vertexBuffer.device,e,n.length);new nv[_.format](_.storage).set(n),_.unlock(),this.primitive[1]={type:1,base:0,baseVertex:0,count:n.length,indexed:true},this.indexBuffer[1]=_;},t.fromGeometry=function(e,n,i){ void 0===i&&(i={});var r=new t(e,i),s=n.positions,a=n.normals,o=n.tangents,l=n.colors,u=n.uvs,c=n.uvs1,h=n.blendIndices,f=n.blendWeights,d=n.indices;return s&&r.setPositions(s),a&&r.setNormals(a),o&&r.setVertexStream(tw,o,4),l&&r.setColors32(l),u&&r.setUvs(0,u),c&&r.setUvs(1,c),h&&r.setVertexStream(tC,h,4,h.length/4,1),f&&r.setVertexStream(tA,f,4),d&&r.setIndices(d),r.update(),r},n=[{key:"morph",get:function(){return this._morph},set:function(e){e!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=e,e&&e.incRefCount());}},{key:"aabb",get:function(){return this._aabb},set:function(e){this._aabb=e,this._aabbVer++;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(iF),lv=new nD;function lg(e){return lv.get(e)}var ly=function(){function e(){this.cache=new Map;}var t=e.prototype;return t.destroy=function(){this.cache.forEach(function(e,t){t.destroy();}),this.cache.clear();},t.incRef=function(e){var t=(this.cache.get(e)||0)+1;this.cache.set(e,t);},t.decRef=function(e){if(e){var t=this.cache.get(e);t&&(0==--t?(this.cache.delete(e),e.destroy()):this.cache.set(e,t));}},e}(),lS=function(){function e(){}return e.incRef=function(e){this.cache.incRef(e);},e.decRef=function(e){this.cache.decRef(e);},e.destroy=function(){this.cache.destroy();},e}();lS.cache=new ly;var lx=0,lb=new e8,lT=new e8,lE=new e7,lw=new Set,lA=new Uint32Array(4),lC=function(){function e(e){this.vertexBuffer=null,this._destroyVertexBuffer=false,this.count=e;}return e.prototype.destroy=function(){if(this._destroyVertexBuffer){var e;null==(e=this.vertexBuffer)||e.destroy();}this.vertexBuffer=null;},e}(),lP=function(){function e(){this.map=new Map,this.meshMetaData=new Int32Array(4);}return e.prototype.get=function(e){var t;return null!=(t=this.map.get(e))?t:this.map.get(null)},e}(),lI=function(){function e(){this.bindGroup=null,this.uniformBuffer=null;}var t=e.prototype;return t.getBindGroup=function(e){if(!this.bindGroup){var t=this.shader.meshBindGroupFormat;this.bindGroup=new nV(e,t);}return this.bindGroup},t.getUniformBuffer=function(e){if(!this.uniformBuffer){var t=this.shader.meshUniformBufferFormat;this.uniformBuffer=new r4(e,t,false);}return this.uniformBuffer},t.destroy=function(){var e,t;null==(e=this.bindGroup)||e.destroy(),this.bindGroup=null,null==(t=this.uniformBuffer)||t.destroy(),this.uniformBuffer=null;},e}(),lL=function(){function e(e,t,n){if(void 0===n&&(n=null),this.castShadow=false,this.shadowCascadeMask=255,this.cull=true,this.drawOrder=0,this._drawBucket=127,this.visible=true,this.visibleThisFrame=false,this.flipFacesFactor=1,this.gsplatInstance=null,this.id=lx++,this.isVisibleFunc=null,this.instancingData=null,this.indirectData=null,this.parameters={},this.pick=true,this.stencilFront=null,this.stencilBack=null,this.transparent=false,this._aabb=new e8,this._aabbVer=-1,this._aabbMeshVer=-1,this._customAabb=null,this._updateAabb=true,this._updateAabbFunc=null,this._sortKeyShadow=0,this._sortKeyForward=0,this._sortKeyDynamic=0,this._layer=15,this._material=null,this._skinInstance=null,this._morphInstance=null,this._receiveShadow=true,this._renderStyle=0,this._screenSpace=false,this._shaderCache=new Map,this._shaderDefs=65536,this._calculateSortDistance=null,this.node=n,this._mesh=e,e.incRefCount(),this.material=t,e.vertexBuffer){var i=e.vertexBuffer.format;this._shaderDefs|=4*!!i.hasUv0,this._shaderDefs|=8*!!i.hasUv1,this._shaderDefs|=16*!!i.hasColor,this._shaderDefs|=512*!!i.hasTangents;}this.updateKey();}var t,n=e.prototype;return n.clearShaders=function(){this._shaderCache.forEach(function(e){e.destroy();}),this._shaderCache.clear();},n.getShaderInstance=function(e,t,n,i,r,s,a){var o=this._shaderDefs;lA[0]=e,lA[1]=t,lA[2]=o,lA[3]=i.hash;var l=n3(lA),u=this._shaderCache.get(l);if(!u){var c=this._material;if((u=new lI).shader=c.variants.get(l),u.hashes=new Uint32Array(lA),!u.shader){var h,f=c.getShaderVariant({device:this.mesh.device,scene:n,objDefs:o,cameraShaderParams:i,pass:e,sortedLights:a,viewUniformFormat:r,viewBindGroupFormat:s,vertexFormat:null==(h=this.mesh.vertexBuffer)?void 0:h.format});c.variants.set(l,f),u.shader=f;}this._shaderCache.set(l,u);}return u},n._updateShaderDefs=function(e){e!==this._shaderDefs&&(this._shaderDefs=e,this.clearShaders());},n.destroy=function(){var t,n,i,r=this.mesh;r&&(this.mesh=null,r.refCount<1&&r.destroy()),this.setRealtimeLightmap(e.lightmapParamNames[0],null),this.setRealtimeLightmap(e.lightmapParamNames[1],null),null==(t=this._skinInstance)||t.destroy(),this._skinInstance=null,null==(n=this.morphInstance)||n.destroy(),this.morphInstance=null,this.clearShaders(),this.material=null,null==(i=this.instancingData)||i.destroy();},n._isVisible=function(e){return !!this.visible&&(this.isVisibleFunc?this.isVisibleFunc(e):(lE.center=this.aabb.center,lE.radius=this._aabb.halfExtents.length(),e.frustum.containsSphere(lE)>0))},n.updateKey=function(){var e=this.material;this._sortKeyForward=this._drawBucket<<23|(e.alphaToCoverage||e.alphaTest?4194304:0)|4194303&e.id;},n.setInstancing=function(e,t){ void 0===t&&(t=false),e?(this.instancingData=new lC(e.numVertices),this.instancingData.vertexBuffer=e,e.format.instancing=true,this.cull=t):(this.instancingData=null,this.cull=true),this._updateShaderDefs(e?32|this._shaderDefs:-33&this._shaderDefs);},n.setIndirect=function(e,t){var n;this._allocIndirectData(),this.indirectData.map.set(null!=(n=null==e?void 0:e.camera)?n:null,t),this.mesh.device.mapsToClear.add(this.indirectData.map);},n.getIndirectMetaData=function(){this._allocIndirectData();var e,t=null==(e=this.mesh)?void 0:e.primitive[this.renderStyle],n=this.indirectData.meshMetaData;return n[0]=t.count,n[1]=t.base,n[2]=t.baseVertex,n},n._allocIndirectData=function(){this.indirectData||(this.indirectData=new lP);},n.ensureMaterial=function(e){this.material||(this.material=lg(e));},n.clearParameters=function(){this.parameters={};},n.getParameters=function(){return this.parameters},n.getParameter=function(e){return this.parameters[e]},n.setParameter=function(e,t,n){ void 0===n&&(n=0xffffffff);var i=this.parameters[e];i?(i.data=t,i.passFlags=n):this.parameters[e]={scopeId:null,data:t,passFlags:n};},n.setRealtimeLightmap=function(e,t){var n=this.getParameter(e);n!==t&&(n&&lS.decRef(n.data),t?(lS.incRef(t),this.setParameter(e,t)):this.deleteParameter(e));},n.deleteParameter=function(e){this.parameters[e]&&delete this.parameters[e];},n.setParameters=function(e,t){var n=this.parameters;for(var i in n){var r=n[i];r.passFlags&t&&(r.scopeId||(r.scopeId=e.scope.resolve(i)),r.scopeId.setValue(r.data));}},n.setLightmapped=function(t){t?this.mask=(2|this.mask)&-6:(this.setRealtimeLightmap(e.lightmapParamNames[0],null),this.setRealtimeLightmap(e.lightmapParamNames[1],null),this._shaderDefs&=-4289,this.mask=(1|this.mask)&-7);},n.setCustomAabb=function(e){e?this._customAabb?this._customAabb.copy(e):this._customAabb=e.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate();},n._setupSkinUpdate=function(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb);},e._prepareRenderStyleForArray=function(e,t){if(e){for(var n=0;n<e.length;n++){e[n]._renderStyle=t;var i=e[n].mesh;lw.has(i)||(lw.add(i),i.prepareRenderState(t));}lw.clear();}},t=[{key:"drawBucket",get:function(){return this._drawBucket},set:function(e){this._drawBucket=255&Math.floor(e),this.updateKey();}},{key:"renderStyle",get:function(){return this._renderStyle},set:function(e){this._renderStyle=e,this.mesh.prepareRenderState(e);}},{key:"mesh",get:function(){return this._mesh},set:function(e){e!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=e,e&&e.incRefCount());}},{key:"aabb",get:function(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);var e=this._customAabb,t=!!e;if(!e){if(e=lb,this.skinInstance){if(!this.mesh.boneAabb){var n=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(n);}for(var i=this.mesh.boneUsed,r=true,s=0;s<this.mesh.boneAabb.length;s++)i[s]&&(lT.setFromTransformedAabb(this.mesh.boneAabb[s],this.skinInstance.matrices[s]),r?(r=false,e.center.copy(lT.center),e.halfExtents.copy(lT.halfExtents)):e.add(lT));t=true;}else if(this.node._aabbVer!==this._aabbVer||this.mesh._aabbVer!==this._aabbMeshVer){if(this.mesh?(e.center.copy(this.mesh.aabb.center),e.halfExtents.copy(this.mesh.aabb.halfExtents)):(e.center.set(0,0,0),e.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph){var a=this.mesh.morph.aabb;e._expand(a.getMin(),a.getMax());}t=true,this._aabbVer=this.node._aabbVer,this._aabbMeshVer=this.mesh._aabbVer;}}return t&&this._aabb.setFromTransformedAabb(e,this.node.getWorldTransform()),this._aabb},set:function(e){this._aabb=e;}},{key:"material",get:function(){return this._material},set:function(e){this.clearShaders();var t=this._material;t&&t.removeMeshInstanceRef(this),this._material=e,e&&(e.addMeshInstanceRef(this),this.transparent=e.transparent,this.updateKey());}},{key:"calculateSortDistance",get:function(){return this._calculateSortDistance},set:function(e){this._calculateSortDistance=e;}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow!==e&&(this._receiveShadow=e,this._updateShaderDefs(e?-2&this._shaderDefs:1|this._shaderDefs));}},{key:"batching",get:function(){return (16384&this._shaderDefs)!=0},set:function(e){this._updateShaderDefs(e?16384|this._shaderDefs:-16385&this._shaderDefs);}},{key:"skinInstance",get:function(){return this._skinInstance},set:function(e){this._skinInstance=e,this._updateShaderDefs(e?2|this._shaderDefs:-3&this._shaderDefs),this._setupSkinUpdate();}},{key:"morphInstance",get:function(){return this._morphInstance},set:function(e){null==(t=this._morphInstance)||t.destroy(),this._morphInstance=e;var t,n=this._shaderDefs;n=e&&e.morph.morphPositions?1024|n:-1025&n,n=e&&e.morph.morphNormals?2048|n:-2049&n,n=e&&e.morph.intRenderFormat?8192|n:-8193&n,this._updateShaderDefs(n);}},{key:"screenSpace",get:function(){return this._screenSpace},set:function(e){this._screenSpace!==e&&(this._screenSpace=e,this._updateShaderDefs(e?256|this._shaderDefs:-257&this._shaderDefs));}},{key:"key",get:function(){return this._sortKeyForward},set:function(e){this._sortKeyForward=e;}},{key:"mask",get:function(){return this._shaderDefs>>16},set:function(e){var t=65535&this._shaderDefs;this._updateShaderDefs(t|e<<16);}},{key:"instancingCount",get:function(){return this.instancingData?this.instancingData.count:0},set:function(e){this.instancingData&&(this.instancingData.count=e);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function lD(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}lL.lightmapParamNames=["texture_lightMap","texture_dirLightMap"];var lM=[0,1,3,2,3,1],lR=[0,1,3,0,3,2],lO=new ej;function lk(e,t){if(e&&!t||!e&&t)return  false;if((e=e.data)===(t=t.data))return  true;if(lD(e,Float32Array)&&lD(t,Float32Array)){if(e.length!==t.length)return  false;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return  false;return  true}return  false}function lN(e){return e.node.worldTransform.scaleSign}var lF=function(){function e(e,t,n){this.device=e,this.rootNode=t,this.scene=n,this._init=false,this._batchGroups={},this._batchGroupCounter=0,this._batchList=[],this._dirtyGroups=[];}var t=e.prototype;return t.destroy=function(){this.device=null,this.rootNode=null,this.scene=null,this._batchGroups={},this._batchList=[],this._dirtyGroups=[];},t.addGroup=function(e,t,n,i,r){if(void 0===i&&(i=this._batchGroupCounter,this._batchGroupCounter++),!this._batchGroups[i]){var s=new lo(i,e,t,n,r);return this._batchGroups[i]=s,s}},t.removeGroup=function(e){if(this._batchGroups[e]){for(var t=[],n=0;n<this._batchList.length;n++)this._batchList[n].batchGroupId===e?this.destroyBatch(this._batchList[n]):t.push(this._batchList[n]);this._batchList=t,this._removeModelsFromBatchGroup(this.rootNode,e),delete this._batchGroups[e];}},t.markGroupDirty=function(e){0>this._dirtyGroups.indexOf(e)&&this._dirtyGroups.push(e);},t.getGroupByName=function(e){var t=this._batchGroups;for(var n in t)if(t.hasOwnProperty(n)&&t[n].name===e)return t[n];return null},t.getBatches=function(e){for(var t=[],n=this._batchList.length,i=0;i<n;i++){var r=this._batchList[i];r.batchGroupId===e&&t.push(r);}return t},t._removeModelsFromBatchGroup=function(e,t){if(e.enabled){e.model&&e.model.batchGroupId===t&&(e.model.batchGroupId=-1),e.render&&e.render.batchGroupId===t&&(e.render.batchGroupId=-1),e.element&&e.element.batchGroupId===t&&(e.element.batchGroupId=-1),e.sprite&&e.sprite.batchGroupId===t&&(e.sprite.batchGroupId=-1);for(var n=0;n<e._children.length;n++)this._removeModelsFromBatchGroup(e._children[n],t);}},t.insert=function(e,t,n){var i=this._batchGroups[t];i&&0>i._obj[e].indexOf(n)&&(i._obj[e].push(n),this.markGroupDirty(t));},t.remove=function(e,t,n){var i=this._batchGroups[t];if(i){var r=i._obj[e].indexOf(n);r>=0&&(i._obj[e].splice(r,1),this.markGroupDirty(t));}},t._extractRender=function(e,t,n,i){return e.render&&(t=i[e.render.batchGroupId]=t.concat(e.render.meshInstances),e.render.removeFromLayers()),t},t._extractModel=function(e,t,n,i){return e.model&&e.model.model&&(t=i[e.model.batchGroupId]=t.concat(e.model.meshInstances),e.model.removeModelFromLayers()),t},t._extractElement=function(e,t,n){if(e.element){var i=false;e.element._text&&e.element._text._model.meshInstances.length>0?(t.push(e.element._text._model.meshInstances[0]),e.element.removeModelFromLayers(e.element._text._model),i=true):e.element._image&&(t.push(e.element._image._renderable.meshInstance),e.element.removeModelFromLayers(e.element._image._renderable.model),e.element._image._renderable.unmaskMeshInstance&&(t.push(e.element._image._renderable.unmaskMeshInstance),e.element._image._renderable.unmaskMeshInstance.stencilFront&&e.element._image._renderable.unmaskMeshInstance.stencilBack||(e.element._dirtifyMask(),e.element._onPrerender())),i=true),i&&(n._ui=true);}},t._collectAndRemoveMeshInstances=function(e,t){for(var n=0;n<t.length;n++){var i=t[n],r=this._batchGroups[i];if(r){var s=e[i];s||(s=e[i]=[]);for(var a=0;a<r._obj.model.length;a++)s=this._extractModel(r._obj.model[a],s,r,e);for(var o=0;o<r._obj.render.length;o++)s=this._extractRender(r._obj.render[o],s,r,e);for(var l=0;l<r._obj.element.length;l++)this._extractElement(r._obj.element[l],s,r);for(var u=0;u<r._obj.sprite.length;u++){var c=r._obj.sprite[u];c.sprite&&c.sprite._meshInstance&&(r.dynamic||0===c.sprite.sprite._renderMode)&&(s.push(c.sprite._meshInstance),c.sprite.removeModelFromLayers(),r._sprite=true,c.sprite._batchGroup=r);}}}},t.generate=function(e){var t,n,i,r,s={};e||(e=Object.keys(this._batchGroups));for(var a=[],o=0;o<this._batchList.length;o++){if(0>e.indexOf(this._batchList[o].batchGroupId)){a.push(this._batchList[o]);continue}this.destroyBatch(this._batchList[o]);}if(this._batchList=a,this._collectAndRemoveMeshInstances(s,e),e===this._dirtyGroups)this._dirtyGroups.length=0;else {for(var l=[],u=0;u<this._dirtyGroups.length;u++)0>e.indexOf(this._dirtyGroups[u])&&l.push(this._dirtyGroups[u]);this._dirtyGroups=l;}for(var c in s)if(s.hasOwnProperty(c)&&(t=s[c],i=this._batchGroups[c])){n=this.prepare(t,i.dynamic,i.maxAabbSize,i._ui||i._sprite);for(var h=0;h<n.length;h++)(r=this.create(n[h],i.dynamic,parseInt(c,10)))&&r.addToLayers(this.scene,i.layers);}},t.prepare=function(e,t,n,i){if(void 0===n&&(n=Number.POSITIVE_INFINITY),0===e.length)return [];var r,s,a=.5*n,o=new e8,l=new e8,u=null,c=[],h=0;i&&e.sort(function(e,t){return e.drawOrder-t.drawOrder});for(var f=e,d=i?function(e){u?u.add(e.aabb):u=e.aabb.clone(),s.push(e);}:function(e){s.push(e);};f.length>0;){c[h]=[f[0]],s=[];var p=f[0].material,m=f[0].layer,_=f[0]._shaderDefs,v=f[0].parameters,g=f[0].stencilFront,y=f[0].mesh.vertexBuffer.getNumVertices(),S=f[0].drawOrder;o.copy(f[0].aabb);var x=lN(f[0]),b=f[0].mesh.vertexBuffer.format.batchingHash,T=f[0].mesh.primitive[0].indexed;u=null;for(var E=1;E<f.length;E++){var w=f[E];if(t&&c[h].length>=1024){s=s.concat(f.slice(E));break}if(p!==w.material||m!==w.layer||b!==w.mesh.vertexBuffer.format.batchingHash||T!==w.mesh.primitive[0].indexed||_!==w._shaderDefs||y+w.mesh.vertexBuffer.getNumVertices()>0xffffffff||(l.copy(o),l.add(w.aabb),l.halfExtents.x>a||l.halfExtents.y>a||l.halfExtents.z>a||g&&(!(r=w.stencilFront)||g.func!==r.func||g.zpass!==r.zpass)||x!==lN(w)||!function(e,t){for(var n in e)if(e.hasOwnProperty(n)&&!lk(e[n],t[n]))return  false;for(var i in t)if(t.hasOwnProperty(i)&&!lk(t[i],e[i]))return  false;return  true}(v,w.parameters)||i&&u&&u.intersects(w.aabb)&&w.drawOrder!==S)){d(w);continue}o.add(w.aabb),y+=w.mesh.vertexBuffer.getNumVertices(),c[h].push(w);}h++,f=s;}return c},t.collectBatchedMeshData=function(e,t){for(var n=null,i=0,r=0,s=null,a=0;a<e.length;a++)if(e[a].visible){var o=e[a].mesh;if(i+=o.vertexBuffer.numVertices,o.primitive[0].indexed)r+=o.primitive[0].count;else {var l=o.primitive[0].type;(6===l||5===l)&&4===o.primitive[0].count&&(r+=6);}if(!n){s=e[a].material,n={};for(var u=o.vertexBuffer.format.elements,c=0;c<u.length;c++)n[u[c].name]={numComponents:u[c].numComponents,dataType:u[c].dataType,normalize:u[c].normalize,count:0};t&&(n[tC]={numComponents:1,dataType:6,normalize:false,count:0});}}return {streams:n,batchNumVerts:i,batchNumIndices:r,material:s}},t.create=function(e,t,n){this._init||(this.vertexFormats={},this._init=true);var i=null,r=null,s=this.collectBatchedMeshData(e,t);if(s.streams){var a,o,l,u,c,h,f,d,p=s.streams,m=s.material,_=s.batchNumVerts,v=s.batchNumIndices;r=new la(e,t,n),this._batchList.push(r);var g=0,y=0,S=new(_<=65535?Uint16Array:Uint32Array)(v);for(a in p)(i=p[a]).typeArrayType=nm[i.dataType],i.elementByteSize=n_[i.dataType],i.buffer=new i.typeArrayType(_*i.numComponents);for(var x=0;x<e.length;x++)if(e[x].visible){for(a in l=(o=e[x].mesh).vertexBuffer.numVertices,t||(d=e[x].node.getWorldTransform()),p)if(a!==tC){var b=new(i=p[a]).typeArrayType(i.buffer.buffer,i.elementByteSize*i.count),T=o.getVertexStream(a,b)*i.numComponents;if(i.count+=T,!t&&i.numComponents>=3){if(a===tT)for(var E=d.data,w=E[0],A=E[1],C=E[2],P=E[4],I=E[5],L=E[6],D=E[8],M=E[9],R=E[10],O=E[12],k=E[13],N=E[14],F=void 0,B=void 0,U=void 0,z=0;z<T;z+=i.numComponents)F=b[z],B=b[z+1],U=b[z+2],b[z]=F*w+B*P+U*D+O,b[z+1]=F*A+B*I+U*M+k,b[z+2]=F*C+B*L+U*R+N;else if(a===tE||a===tw){lO.invertMat4(d).transpose();for(var V=lO.data,G=V[0],H=V[1],W=V[2],j=V[3],X=V[4],Y=V[5],q=V[6],K=V[7],Z=V[8],Q=void 0,J=void 0,$=void 0,ee=0;ee<T;ee+=i.numComponents)Q=b[ee],J=b[ee+1],$=b[ee+2],b[ee]=Q*G+J*j+$*q,b[ee+1]=Q*H+J*X+$*K,b[ee+2]=Q*W+J*Y+$*Z;}}}if(t){i=p[tC];for(var et=0;et<l;et++)i.buffer[i.count++]=x;}if(o.primitive[0].indexed)u=o.primitive[0].base,c=o.primitive[0].baseVertex||0,h=o.primitive[0].count,f=new nv[o.indexBuffer[0].getFormat()](o.indexBuffer[0].storage);else {c=0;var en=o.primitive[0].type;if(6===en||5===en)if(4===o.primitive[0].count)u=0,h=6,f=6===en?lM:lR;else {h=0;continue}}for(var ei=0;ei<h;ei++)S[ei+y]=f[u+ei]+c+g;y+=h,g+=l;}for(a in o=new l_(this.device),p)i=p[a],o.setVertexStream(a,i.buffer,i.numComponents,void 0,i.dataType,i.normalize);S.length>0&&o.setIndices(S),o.update(4,false),t&&(m=m.clone()).update();var er=new lL(o,m,this.rootNode);er.castShadow=r.origMeshInstances[0].castShadow,er.parameters=r.origMeshInstances[0].parameters,er.layer=r.origMeshInstances[0].layer,er._shaderDefs=r.origMeshInstances[0]._shaderDefs,er.batching=true,er.cull=r.origMeshInstances[0].cull;var es=this._batchGroups[n];if(es&&es._ui&&(er.cull=false),t){for(var ea=[],eo=0;eo<r.origMeshInstances.length;eo++)ea.push(r.origMeshInstances[eo].node);er.skinInstance=new lh(this.device,ea,this.rootNode);}er._updateAabb=false,er.drawOrder=r.origMeshInstances[0].drawOrder,er.stencilFront=r.origMeshInstances[0].stencilFront,er.stencilBack=r.origMeshInstances[0].stencilBack,er.flipFacesFactor=lN(r.origMeshInstances[0]),er.castShadow=r.origMeshInstances[0].castShadow,r.meshInstance=er,r.updateBoundingBox();}return r},t.updateAll=function(){this._dirtyGroups.length>0&&this.generate(this._dirtyGroups);for(var e=0;e<this._batchList.length;e++)this._batchList[e].dynamic&&this._batchList[e].updateBoundingBox();},t.clone=function(e,t){var n=new la(t,e.dynamic,e.batchGroupId);this._batchList.push(n);for(var i=[],r=0;r<t.length;r++)i.push(t[r].node);return n.meshInstance=new lL(e.meshInstance.mesh,e.meshInstance.material,e.meshInstance.node),n.meshInstance._updateAabb=false,n.meshInstance.parameters=t[0].parameters,n.meshInstance.cull=t[0].cull,n.meshInstance.layer=t[0].layer,e.dynamic&&(n.meshInstance.skinInstance=new lh(this.device,i,this.rootNode)),n.meshInstance.castShadow=e.meshInstance.castShadow,n},t.destroyBatch=function(e){e.destroy(this.scene,this._batchGroups[e.batchGroupId].layers);},e}();function lB(e,t){return (lB=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var lU="uSceneColorMap",lz=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return t=e.apply(this,arguments)||this,t.colorRenderTarget=null,t.source=null,t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&lB(t,e);var n=t.prototype;return n.destroy=function(){e.prototype.destroy.call(this),this.releaseRenderTarget(this.colorRenderTarget);},n.shouldReallocate=function(e,t,n){if((null==e?void 0:e.colorBuffer.format)!==n)return  true;var i=(null==t?void 0:t.width)||this.device.width,r=(null==t?void 0:t.height)||this.device.height;return !e||i!==e.width||r!==e.height},n.allocateRenderTarget=function(e,t,n,i){var r=new nO(n,{name:lU,format:i,width:t?t.colorBuffer.width:n.width,height:t?t.colorBuffer.height:n.height,mipmaps:true,minFilter:5,magFilter:1,addressU:1,addressV:1});return e?(e.destroyFrameBuffers(),e._colorBuffer=r,e._colorBuffers=[r]):e=new il({name:"ColorGrabRT",colorBuffer:r,depth:false,stencil:false,autoResolve:false}),e},n.releaseRenderTarget=function(e){e&&(e.destroyTextureBuffers(),e.destroy());},n.frameUpdate=function(){var e,t=this.device,n=this.source,i=null!=(e=null==n?void 0:n.colorBuffer.format)?e:this.device.backBufferFormat;this.shouldReallocate(this.colorRenderTarget,null==n?void 0:n.colorBuffer,i)&&(this.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=this.allocateRenderTarget(this.colorRenderTarget,n,t,i));var r=this.colorRenderTarget.colorBuffer;t.scope.resolve(lU).setValue(r);},n.execute=function(){var e=this.device,t=this.source,n=this.colorRenderTarget.colorBuffer;e.isWebGPU?(e.copyRenderTarget(t,this.colorRenderTarget,true,false),e.mipmapRenderer.generate(this.colorRenderTarget.colorBuffer.impl)):(e.copyRenderTarget(t,this.colorRenderTarget,true,false),e.activeTexture(e.maxCombinedTextures-1),e.bindTexture(n),e.gl.generateMipmap(n.impl._glTarget));},t}(s2);function lV(e,t){return (lV=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var lG="uSceneDepthMap",lH=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t)||this).depthRenderTarget=null,i.camera=null,i.camera=n,i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&lV(t,e);var n=t.prototype;return n.destroy=function(){e.prototype.destroy.call(this),this.releaseRenderTarget(this.depthRenderTarget);},n.shouldReallocate=function(e,t){var n=(null==t?void 0:t.width)||this.device.width,i=(null==t?void 0:t.height)||this.device.height;return !e||n!==e.width||i!==e.height},n.allocateRenderTarget=function(e,t,n,i,r){var s=new nO(n,{name:lG,format:i,width:t?t.colorBuffer.width:n.width,height:t?t.colorBuffer.height:n.height,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1});return e?(e.destroyFrameBuffers(),r?e._depthBuffer=s:(e._colorBuffer=s,e._colorBuffers=[s])):e=new il({name:"DepthGrabRT",colorBuffer:r?null:s,depthBuffer:r?s:null,depth:!r,stencil:n.supportsStencil,autoResolve:false}),e},n.releaseRenderTarget=function(e){e&&(e.destroyTextureBuffers(),e.destroy());},n.before=function(){var e,t,n,i,r=this.camera,s=this.device,a=null!=(n=null==r?void 0:r.renderTarget)?n:s.backBuffer,o=true,l=a.stencil?17:16;s.isWebGPU&&a.samples>1&&(l=15,o=false);var u=null!=(i=null==(e=r.renderTarget)?void 0:e.depthBuffer)?i:null==(t=r.renderTarget)?void 0:t.colorBuffer;this.shouldReallocate(this.depthRenderTarget,u)&&(this.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=this.allocateRenderTarget(this.depthRenderTarget,r.renderTarget,s,l,o));var c=o?this.depthRenderTarget.depthBuffer:this.depthRenderTarget.colorBuffer;s.scope.resolve(lG).setValue(c);},n.execute=function(){var e=this.device;if(e.isWebGL2&&e.renderTarget.samples>1){var t=e.renderTarget.impl._glFrameBuffer,n=this.depthRenderTarget;e.renderTarget=n,e.updateBegin(),this.depthRenderTarget.impl.internalResolve(e,t,n.impl._glFrameBuffer,this.depthRenderTarget,e.gl.DEPTH_BUFFER_BIT);}else e.copyRenderTarget(e.renderTarget,this.depthRenderTarget,false,true);},t}(s2),lW=function(){var e;function t(){this._gammaCorrection=1,this._toneMapping=0,this._srgbRenderTarget=false,this._ssaoEnabled=false,this._fog=on,this._sceneDepthMapLinear=false,this._defines=new Map,this._definesDirty=true;}return t.prototype.markDirty=function(){this._hash=void 0,this._definesDirty=true;},e=[{key:"hash",get:function(){if(void 0===this._hash){var e=this.gammaCorrection+"_"+this.toneMapping+"_"+this.srgbRenderTarget+"_"+this.fog+"_"+this.ssaoEnabled+"_"+this.sceneDepthMapLinear;this._hash=n2(e);}return this._hash}},{key:"defines",get:function(){var e=this._defines;return this._definesDirty&&(this._definesDirty=false,e.clear(),this._sceneDepthMapLinear&&e.set("SCENE_DEPTHMAP_LINEAR",true),e.set("FOG",this._fog.toUpperCase()),e.set("TONEMAP",oh[this._toneMapping]),e.set("GAMMA",oc[this.shaderOutputGamma])),e}},{key:"fog",get:function(){return this._fog},set:function(e){this._fog!==e&&(this._fog=e,this.markDirty());}},{key:"ssaoEnabled",get:function(){return this._ssaoEnabled},set:function(e){this._ssaoEnabled!==e&&(this._ssaoEnabled=e,this.markDirty());}},{key:"gammaCorrection",get:function(){return this._gammaCorrection},set:function(e){this._gammaCorrectionAssigned=true,this._gammaCorrection!==e&&(this._gammaCorrection=e,this.markDirty());}},{key:"toneMapping",get:function(){return this._toneMapping},set:function(e){this._toneMapping!==e&&(this._toneMapping=e,this.markDirty());}},{key:"srgbRenderTarget",get:function(){return this._srgbRenderTarget},set:function(e){this._srgbRenderTarget!==e&&(this._srgbRenderTarget=e,this.markDirty());}},{key:"sceneDepthMapLinear",get:function(){return this._sceneDepthMapLinear},set:function(e){this._sceneDepthMapLinear!==e&&(this._sceneDepthMapLinear=e,this.markDirty());}},{key:"shaderOutputGamma",get:function(){return +(1===this._gammaCorrection&&!this._srgbRenderTarget)}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}(),lj=new eW,lX=new eW,lY=new eW,lq=new e$,lK=[new eW,new eW,new eW,new eW,new eW,new eW,new eW,new eW],lZ=function(){function e(){this.shaderPassInfo=null,this.renderPassColorGrab=null,this.renderPassDepthGrab=null,this.fogParams=null,this.shaderParams=new lW,this.renderPasses=[],this.jitter=0,this._aspectRatio=16/9,this._aspectRatioMode=0,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new eN(.75,.75,.75,1),this._clearColorBuffer=true,this._clearDepth=1,this._clearDepthBuffer=true,this._clearStencil=0,this._clearStencilBuffer=true,this._cullFaces=true,this._farClip=1e3,this._flipFaces=false,this._fov=45,this._frustumCulling=true,this._horizontalFov=false,this._layers=[0,1,2,4,3],this._layersSet=new Set(this._layers),this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=0,this._rect=new eY(0,0,1,1),this._renderTarget=null,this._scissorRect=new eY(0,0,1,1),this._scissorRectClear=false,this._aperture=16,this._shutter=.001,this._sensitivity=1e3,this._projMat=new e$,this._projMatDirty=true,this._projMatSkybox=new e$,this._viewMat=new e$,this._viewMatDirty=true,this._viewProjMat=new e$,this._viewProjMatDirty=true,this._shaderMatricesVersion=0,this._viewProjInverse=new e$,this._viewProjCurrent=null,this._viewProjPrevious=new e$,this._jitters=[0,0,0,0],this.frustum=new tt,this._xr=null,this._xrProperties={horizontalFov:this._horizontalFov,fov:this._fov,aspectRatio:this._aspectRatio,farClip:this._farClip,nearClip:this._nearClip};}var t,n=e.prototype;return n.destroy=function(){var e,t;null==(e=this.renderPassColorGrab)||e.destroy(),this.renderPassColorGrab=null,null==(t=this.renderPassDepthGrab)||t.destroy(),this.renderPassDepthGrab=null,this.renderPasses.length=0;},n._storeShaderMatrices=function(e,t,n,i){if(this._shaderMatricesVersion!==i){var r;this._shaderMatricesVersion=i,this._viewProjPrevious.copy(null!=(r=this._viewProjCurrent)?r:e),null!=this._viewProjCurrent||(this._viewProjCurrent=new e$),this._viewProjCurrent.copy(e),this._viewProjInverse.invert(e),this._jitters[2]=this._jitters[0],this._jitters[3]=this._jitters[1],this._jitters[0]=t,this._jitters[1]=n;}},n.clone=function(){return new e().copy(this)},n.copy=function(e){return this._aspectRatio=e._aspectRatio,this._farClip=e._farClip,this._fov=e._fov,this._horizontalFov=e._horizontalFov,this._nearClip=e._nearClip,this._xrProperties.aspectRatio=e._xrProperties.aspectRatio,this._xrProperties.farClip=e._xrProperties.farClip,this._xrProperties.fov=e._xrProperties.fov,this._xrProperties.horizontalFov=e._xrProperties.horizontalFov,this._xrProperties.nearClip=e._xrProperties.nearClip,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepth=e.clearDepth,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencil=e.clearStencil,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.flipFaces=e.flipFaces,this.frustumCulling=e.frustumCulling,this.layers=e.layers,this.orthoHeight=e.orthoHeight,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.aperture=e.aperture,this.shutter=e.shutter,this.sensitivity=e.sensitivity,this.shaderPassInfo=e.shaderPassInfo,this.jitter=e.jitter,this._projMatDirty=true,this},n._enableRenderPassColorGrab=function(e,t){if(t)this.renderPassColorGrab||(this.renderPassColorGrab=new lz(e));else {var n;null==(n=this.renderPassColorGrab)||n.destroy(),this.renderPassColorGrab=null;}},n._enableRenderPassDepthGrab=function(e,t,n){if(n)this.renderPassDepthGrab||(this.renderPassDepthGrab=new lH(e,this));else {var i;null==(i=this.renderPassDepthGrab)||i.destroy(),this.renderPassDepthGrab=null;}},n._updateViewProjMat=function(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=false);},n.worldToScreen=function(e,t,n,i){ void 0===i&&(i=new eW),this._updateViewProjMat(),this._viewProjMat.transformPoint(e,i);var r=this._viewProjMat.data,s=e.x*r[3]+e.y*r[7]+e.z*r[11]+ +r[15];i.x=(i.x/s+1)*.5,i.y=(1-i.y/s)*.5;var a=this._rect,o=a.x,l=a.y,u=a.z,c=a.w;return i.x=i.x*u*t+o*t,i.y=i.y*c*n+(1-l-c)*n,i},n.screenToWorld=function(e,t,n,i,r,s){ void 0===s&&(s=new eW);var a=this._rect,o=a.x,l=a.y,u=a.z,c=a.w,h=this.farClip-this.nearClip;if(lj.set((e-o*i)/(u*i),1-(t-(1-l-c)*r)/(c*r),n/h),lj.mulScalar(2),lj.sub(eW.ONE),0===this._projection){e$._getPerspectiveHalfSize(lX,this.fov,this.aspectRatio,this.nearClip,this.horizontalFov),lX.x*=lj.x,lX.y*=lj.y;var f=this._node.getWorldTransform();lX.z=-this.nearClip,f.transformPoint(lX,lY);var d=this._node.getPosition();s.sub2(lY,d),s.normalize(),s.mulScalar(n),s.add(d);}else this._updateViewProjMat(),lq.copy(this._viewProjMat).invert(),lq.transformPoint(lj,s);return s},n._evaluateProjectionMatrix=function(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip,this.horizontalFov),this._projMatSkybox.copy(this._projMat);else {var e=this._orthoHeight,t=e*this.aspectRatio;this._projMat.setOrtho(-t,t,-e,e,this.nearClip,this.farClip),this._projMatSkybox.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip);}this._projMatDirty=false;}},n.getProjectionMatrixSkybox=function(){return this._evaluateProjectionMatrix(),this._projMatSkybox},n.getExposure=function(){return 1/(1.2*Math.pow(2,Math.log2(this._aperture*this._aperture/this._shutter*100/this._sensitivity)))},n.getScreenSize=function(e){if(0===this._projection){var t=this._node.getPosition().distance(e.center);return t<e.radius?1:Math.min(Math.tan(Math.asin(e.radius/t))/Math.tan(this.fov/2*ek.DEG_TO_RAD),1)}return ek.clamp(e.radius/this._orthoHeight,0,1)},n.getFrustumCorners=function(e,t){ void 0===e&&(e=this.nearClip),void 0===t&&(t=this.farClip);var n,i,r=this.fov*Math.PI/180;return 0===this.projection?this.horizontalFov?i=(n=e*Math.tan(r/2))/this.aspectRatio:n=(i=e*Math.tan(r/2))*this.aspectRatio:n=(i=this._orthoHeight)*this.aspectRatio,lK[0].x=n,lK[0].y=-i,lK[0].z=-e,lK[1].x=n,lK[1].y=i,lK[1].z=-e,lK[2].x=-n,lK[2].y=i,lK[2].z=-e,lK[3].x=-n,lK[3].y=-i,lK[3].z=-e,0===this._projection&&(this.horizontalFov?i=(n=t*Math.tan(r/2))/this.aspectRatio:n=(i=t*Math.tan(r/2))*this.aspectRatio),lK[4].x=n,lK[4].y=-i,lK[4].z=-t,lK[5].x=n,lK[5].y=i,lK[5].z=-t,lK[6].x=-n,lK[6].y=i,lK[6].z=-t,lK[7].x=-n,lK[7].y=-i,lK[7].z=-t,lK},n.setXrProperties=function(e){Object.assign(this._xrProperties,e),this._projMatDirty=true;},t=[{key:"fullSizeClearRect",get:function(){var e=this._scissorRectClear?this.scissorRect:this._rect;return 0===e.x&&0===e.y&&1===e.z&&1===e.w}},{key:"aspectRatio",get:function(){var e;return (null==(e=this.xr)?void 0:e.active)?this._xrProperties.aspectRatio:this._aspectRatio},set:function(e){this._aspectRatio!==e&&(this._aspectRatio=e,this._projMatDirty=true);}},{key:"aspectRatioMode",get:function(){return this._aspectRatioMode},set:function(e){this._aspectRatioMode!==e&&(this._aspectRatioMode=e,this._projMatDirty=true);}},{key:"calculateProjection",get:function(){return this._calculateProjection},set:function(e){this._calculateProjection=e,this._projMatDirty=true;}},{key:"calculateTransform",get:function(){return this._calculateTransform},set:function(e){this._calculateTransform=e;}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.copy(e);}},{key:"clearColorBuffer",get:function(){return this._clearColorBuffer},set:function(e){this._clearColorBuffer=e;}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(e){this._clearDepth=e;}},{key:"clearDepthBuffer",get:function(){return this._clearDepthBuffer},set:function(e){this._clearDepthBuffer=e;}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(e){this._clearStencil=e;}},{key:"clearStencilBuffer",get:function(){return this._clearStencilBuffer},set:function(e){this._clearStencilBuffer=e;}},{key:"cullFaces",get:function(){return this._cullFaces},set:function(e){this._cullFaces=e;}},{key:"farClip",get:function(){var e;return (null==(e=this.xr)?void 0:e.active)?this._xrProperties.farClip:this._farClip},set:function(e){this._farClip!==e&&(this._farClip=e,this._projMatDirty=true);}},{key:"flipFaces",get:function(){return this._flipFaces},set:function(e){this._flipFaces=e;}},{key:"fov",get:function(){var e;return (null==(e=this.xr)?void 0:e.active)?this._xrProperties.fov:this._fov},set:function(e){this._fov!==e&&(this._fov=e,this._projMatDirty=true);}},{key:"frustumCulling",get:function(){return this._frustumCulling},set:function(e){this._frustumCulling=e;}},{key:"horizontalFov",get:function(){var e;return (null==(e=this.xr)?void 0:e.active)?this._xrProperties.horizontalFov:this._horizontalFov},set:function(e){this._horizontalFov!==e&&(this._horizontalFov=e,this._projMatDirty=true);}},{key:"layers",get:function(){return this._layers},set:function(e){this._layers=e.slice(0),this._layersSet=new Set(this._layers);}},{key:"layersSet",get:function(){return this._layersSet}},{key:"nearClip",get:function(){var e;return (null==(e=this.xr)?void 0:e.active)?this._xrProperties.nearClip:this._nearClip},set:function(e){this._nearClip!==e&&(this._nearClip=e,this._projMatDirty=true);}},{key:"node",get:function(){return this._node},set:function(e){this._node=e;}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight!==e&&(this._orthoHeight=e,this._projMatDirty=true);}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection!==e&&(this._projection=e,this._projMatDirty=true);}},{key:"projectionMatrix",get:function(){return this._evaluateProjectionMatrix(),this._projMat}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.copy(e);}},{key:"renderTarget",get:function(){return this._renderTarget},set:function(e){this._renderTarget=e;}},{key:"scissorRect",get:function(){return this._scissorRect},set:function(e){this._scissorRect.copy(e);}},{key:"viewMatrix",get:function(){if(this._viewMatDirty){var e=this._node.getWorldTransform();this._viewMat.copy(e).invert(),this._viewMatDirty=false;}return this._viewMat}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e;}},{key:"sensitivity",get:function(){return this._sensitivity},set:function(e){this._sensitivity=e;}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e;}},{key:"xr",get:function(){return this._xr},set:function(e){this._xr!==e&&(this._xr=e,this._projMatDirty=true);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function lQ(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function lJ(e,t){return (lJ=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var l$=new e$,l0=new eW,l1=new e0,l2=new e0,l3=new eW,l4=new eW,l5=new e$,l8=new e0,l6=new eW,l9=new e$,l7=new e0,ue=new e0,ut=new e$,un=new eW,ui=new eW;function ur(e,t){return lQ(e,Function)?e:function(n){var i=n[e];return lQ(i,Function)&&(i=i()),i===t}}var us=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return void 0===t&&(t="Untitled"),(n=e.call(this)||this).tags=new eI(n),n.localPosition=new eW,n.localRotation=new e0,n.localScale=new eW(1,1,1),n.localEulerAngles=new eW,n.position=new eW,n.rotation=new e0,n.eulerAngles=new eW,n._scale=null,n.localTransform=new e$,n._dirtyLocal=false,n._aabbVer=0,n._frozen=false,n.worldTransform=new e$,n._dirtyWorld=false,n._worldScaleSign=0,n._normalMatrix=new ej,n._dirtyNormal=true,n._right=null,n._up=null,n._forward=null,n._parent=null,n._children=[],n._graphDepth=0,n._enabled=true,n._enabledInHierarchy=false,n.scaleCompensation=false,n.name=t,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&lJ(t,e);var n,i=t.prototype;return i._notifyHierarchyStateChanged=function(e,t){e._onHierarchyStateChanged(t);for(var n=e._children,i=0,r=n.length;i<r;i++)n[i]._enabled&&this._notifyHierarchyStateChanged(n[i],t);},i._onHierarchyStateChanged=function(e){this._enabledInHierarchy=e,e&&!this._frozen&&this._unfreezeParentToRoot();},i._cloneInternal=function(e){e.name=this.name;var t=this.tags._list;e.tags.clear();for(var n=0;n<t.length;n++)e.tags.add(t[n]);e.localPosition.copy(this.localPosition),e.localRotation.copy(this.localRotation),e.localScale.copy(this.localScale),e.localEulerAngles.copy(this.localEulerAngles),e.position.copy(this.position),e.rotation.copy(this.rotation),e.eulerAngles.copy(this.eulerAngles),e.localTransform.copy(this.localTransform),e._dirtyLocal=this._dirtyLocal,e.worldTransform.copy(this.worldTransform),e._dirtyWorld=this._dirtyWorld,e._dirtyNormal=this._dirtyNormal,e._aabbVer=this._aabbVer+1,e._enabled=this._enabled,e.scaleCompensation=this.scaleCompensation,e._enabledInHierarchy=false;},i.clone=function(){var e=new this.constructor;return this._cloneInternal(e),e},i.copy=function(e){return e._cloneInternal(this),this},i.destroy=function(){this.remove();for(var e=this._children;e.length;){var t=e.pop();t._parent=null,t.destroy();}this.fire("destroy",this),this.off();},i.find=function(e,t){var n=[],i=ur(e,t);return this.forEach(function(e){i(e)&&n.push(e);}),n},i.findOne=function(e,t){return function e(t,n){if(n(t))return t;for(var i=t._children,r=i.length,s=0;s<r;++s){var a=e(i[s],n);if(a)return a}return null}(this,ur(e,t))},i.findByTag=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=[],r=function(e,n){var s;n&&(s=e.tags).has.apply(s,[].concat(t))&&i.push(e);for(var a=0;a<e._children.length;a++)r(e._children[a],true);};return r(this,false),i},i.findByName=function(e){return this.findOne("name",e)},i.findByPath=function(e){for(var t=function(e,t){if(!(i=i.children.find(function(t){return t.name===n[e]})))return {v:null}},n=Array.isArray(e)?e:e.split("/"),i=this,r=0,s=n.length;r<s;++r){var a=t(r);if("object"==(a&&"undefined"!=typeof Symbol&&a.constructor===Symbol?"symbol":typeof a))return a.v}return i},i.forEach=function(e,t){e.call(t,this);for(var n=this._children,i=n.length,r=0;r<i;++r)n[r].forEach(e,t);},i.isDescendantOf=function(e){for(var t=this._parent;t;){if(t===e)return  true;t=t._parent;}return  false},i.isAncestorOf=function(e){return e.isDescendantOf(this)},i.getEulerAngles=function(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles},i.getLocalEulerAngles=function(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles},i.getLocalPosition=function(){return this.localPosition},i.getLocalRotation=function(){return this.localRotation},i.getLocalScale=function(){return this.localScale},i.getLocalTransform=function(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=false),this.localTransform},i.getPosition=function(){return this.getWorldTransform().getTranslation(this.position),this.position},i.getRotation=function(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation},i.getScale=function(){return this._scale||(this._scale=new eW),this.getWorldTransform().getScale(this._scale)},i.getWorldTransform=function(){return (this._dirtyLocal||this._dirtyWorld)&&(this._parent&&this._parent.getWorldTransform(),this._sync()),this.worldTransform},i.remove=function(){var e;null==(e=this._parent)||e.removeChild(this);},i.reparent=function(e,t){this.remove(),e&&(t>=0?e.insertChild(this,t):e.addChild(this));},i.setLocalEulerAngles=function(e,t,n){this.localRotation.setFromEulerAngles(e,t,n),this._dirtyLocal||this._dirtifyLocal();},i.setLocalPosition=function(e,t,n){lQ(e,eW)?this.localPosition.copy(e):this.localPosition.set(e,t,n),this._dirtyLocal||this._dirtifyLocal();},i.setLocalRotation=function(e,t,n,i){lQ(e,e0)?this.localRotation.copy(e):this.localRotation.set(e,t,n,i),this._dirtyLocal||this._dirtifyLocal();},i.setLocalScale=function(e,t,n){lQ(e,eW)?this.localScale.copy(e):this.localScale.set(e,t,n),this._dirtyLocal||this._dirtifyLocal();},i._dirtifyLocal=function(){!this._dirtyLocal&&(this._dirtyLocal=true,this._dirtyWorld||this._dirtifyWorld());},i._unfreezeParentToRoot=function(){for(var e=this._parent;e;)e._frozen=false,e=e._parent;},i._dirtifyWorld=function(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal();},i._dirtifyWorldInternal=function(){if(!this._dirtyWorld){this._frozen=false,this._dirtyWorld=true;for(var e=0;e<this._children.length;e++)this._children[e]._dirtyWorld||this._children[e]._dirtifyWorldInternal();}this._dirtyNormal=true,this._worldScaleSign=0,this._aabbVer++;},i.setPosition=function(e,t,n){lQ(e,eW)?l6.copy(e):l6.set(e,t,n),null===this._parent?this.localPosition.copy(l6):(l9.copy(this._parent.getWorldTransform()).invert(),l9.transformPoint(l6,this.localPosition)),this._dirtyLocal||this._dirtifyLocal();},i.setRotation=function(e,t,n,i){if(lQ(e,e0)?l7.copy(e):l7.set(e,t,n,i),null===this._parent)this.localRotation.copy(l7);else {var r=this._parent.getRotation();ue.copy(r).invert(),this.localRotation.copy(ue).mul(l7);}this._dirtyLocal||this._dirtifyLocal();},i.setPositionAndRotation=function(e,t){if(null===this._parent)this.localPosition.copy(e),this.localRotation.copy(t);else {var n=this._parent.getWorldTransform();l9.copy(n).invert(),l9.transformPoint(e,this.localPosition),this.localRotation.setFromMat4(l9).mul(t);}this._dirtyLocal||this._dirtifyLocal();},i.setEulerAngles=function(e,t,n){if(this.localRotation.setFromEulerAngles(e,t,n),null!==this._parent){var i=this._parent.getRotation();ue.copy(i).invert(),this.localRotation.mul2(ue,this.localRotation);}this._dirtyLocal||this._dirtifyLocal();},i.addChild=function(e){this._prepareInsertChild(e),this._children.push(e),this._onInsertChild(e);},i.addChildAndSaveTransform=function(e){var t=e.getPosition(),n=e.getRotation();this._prepareInsertChild(e),e.setPosition(l5.copy(this.worldTransform).invert().transformPoint(t)),e.setRotation(l8.copy(this.getRotation()).invert().mul(n)),this._children.push(e),this._onInsertChild(e);},i.insertChild=function(e,t){this._prepareInsertChild(e),this._children.splice(t,0,e),this._onInsertChild(e);},i._prepareInsertChild=function(e){e.remove();},i._fireOnHierarchy=function(e,t,n){this.fire(e,n);for(var i=0;i<this._children.length;i++)this._children[i]._fireOnHierarchy(t,t,n);},i._onInsertChild=function(e){e._parent=this;var t=e._enabled&&this.enabled;e._enabledInHierarchy!==t&&(e._enabledInHierarchy=t,e._notifyHierarchyStateChanged(e,t)),e._updateGraphDepth(),e._dirtifyWorld(),this._frozen&&e._unfreezeParentToRoot(),e._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",e);},i._updateGraphDepth=function(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(var e=0,t=this._children.length;e<t;e++)this._children[e]._updateGraphDepth();},i.removeChild=function(e){var t=this._children.indexOf(e);-1!==t&&(this._children.splice(t,1),e._parent=null,e._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",e));},i._sync=function(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=false),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){var e,t=this._parent,n=this.localScale,i=t;if(i){for(;i&&i.scaleCompensation;)i=i._parent;i&&(i=i._parent)&&(e=i.worldTransform.getScale(),l3.mul2(e,this.localScale),n=l3);}l2.setFromMat4(t.worldTransform),l1.mul2(l2,this.localRotation);var r=t.worldTransform;t.scaleCompensation&&(l4.mul2(e,t.getLocalScale()),l$.setTRS(t.worldTransform.getTranslation(l0),l2,l4),r=l$),r.transformPoint(this.localPosition,l0),this.worldTransform.setTRS(l0,l1,n);}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=false;}},i.syncHierarchy=function(){if(this._enabled&&!this._frozen){this._frozen=true,(this._dirtyLocal||this._dirtyWorld)&&this._sync();for(var e=this._children,t=0,n=e.length;t<n;t++)e[t].syncHierarchy();}},i.lookAt=function(e,t,n,i,r,s){if(void 0===i&&(i=0),void 0===r&&(r=1),void 0===s&&(s=0),lQ(e,eW))un.copy(e),lQ(t,eW)?ui.copy(t):ui.copy(eW.UP);else {if(void 0===n)return;un.set(e,t,n),ui.set(i,r,s);}ut.setLookAt(this.getPosition(),un,ui),l7.setFromMat4(ut),this.setRotation(l7);},i.translate=function(e,t,n){lQ(e,eW)?l6.copy(e):l6.set(e,t,n),l6.add(this.getPosition()),this.setPosition(l6);},i.translateLocal=function(e,t,n){lQ(e,eW)?l6.copy(e):l6.set(e,t,n),this.localRotation.transformVector(l6,l6),this.localPosition.add(l6),this._dirtyLocal||this._dirtifyLocal();},i.rotate=function(e,t,n){if(l7.setFromEulerAngles(e,t,n),null===this._parent)this.localRotation.mul2(l7,this.localRotation);else {var i=this.getRotation(),r=this._parent.getRotation();ue.copy(r).invert(),l7.mul2(ue,l7),this.localRotation.mul2(l7,i);}this._dirtyLocal||this._dirtifyLocal();},i.rotateLocal=function(e,t,n){l7.setFromEulerAngles(e,t,n),this.localRotation.mul(l7),this._dirtyLocal||this._dirtifyLocal();},n=[{key:"right",get:function(){return this._right||(this._right=new eW),this.getWorldTransform().getX(this._right).normalize()}},{key:"up",get:function(){return this._up||(this._up=new eW),this.getWorldTransform().getY(this._up).normalize()}},{key:"forward",get:function(){return this._forward||(this._forward=new eW),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}},{key:"normalMatrix",get:function(){var e=this._normalMatrix;return this._dirtyNormal&&(e.invertMat4(this.getWorldTransform()).transpose(),this._dirtyNormal=false),e}},{key:"enabled",get:function(){return this._enabled&&this._enabledInHierarchy},set:function(e){if(this._enabled!==e){var t;this._enabled=e,(e&&(null==(t=this._parent)?void 0:t.enabled)||!e)&&this._notifyHierarchyStateChanged(this,e);}}},{key:"parent",get:function(){return this._parent}},{key:"path",get:function(){var e=this._parent;if(!e)return "";for(var t=this.name;e&&e._parent;)t=e.name+"/"+t,e=e._parent;return t}},{key:"root",get:function(){for(var e=this;e._parent;)e=e._parent;return e}},{key:"children",get:function(){return this._children}},{key:"graphDepth",get:function(){return this._graphDepth}},{key:"worldScaleSign",get:function(){return 0===this._worldScaleSign&&(this._worldScaleSign=this.getWorldTransform().scaleSign),this._worldScaleSign}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex),ua=new e$,uo=new e$,ul=new e$,uu=function(){function e(){}return e.create=function(t,n,i){var r=new lZ;switch(r.node=new us(t),r.aspectRatio=1,r.aspectRatioMode=1,r._scissorRectClear=true,n){case 1:r.node.setRotation(e.pointLightRotations[i]),r.fov=90,r.projection=0;break;case 2:r.projection=0;break;case 0:r.projection=1;}return r},e.evalSpotCookieMatrix=function(t){var n=e._spotCookieCamera;n||(n=e.create("SpotCookieCamera",2),e._spotCookieCamera=n),n.fov=2*t._outerConeAngle;var i=n._node;i.setPosition(t._node.getPosition()),i.setRotation(t._node.getRotation()),i.rotateLocal(-90,0,0),ua.setTRS(i.getPosition(),i.getRotation(),eW.ONE).invert(),uo.mul2(n.projectionMatrix,ua);var r=t.cookieMatrix,s=t.atlasViewport;return ul.setViewport(s.x,s.y,s.z,s.w),r.mul2(ul,uo),r},e}();uu.pointLightRotations=[new e0().setFromEulerAngles(0,90,180),new e0().setFromEulerAngles(0,-90,180),new e0().setFromEulerAngles(90,0,0),new e0().setFromEulerAngles(-90,0,0),new e0().setFromEulerAngles(0,180,180),new e0().setFromEulerAngles(0,0,180)],uu._spotCookieCamera=null;var uc=new eW,uh=new Float32Array(6),uf=new eW(-0.5,0,0),ud=new eW(0,0,.5),up={POSITION_RANGE:0,DIRECTION_FLAGS:1,COLOR_ANGLES_BIAS:2,PROJ_MAT_0:3,ATLAS_VIEWPORT:3,PROJ_MAT_1:4,PROJ_MAT_2:5,PROJ_MAT_3:6,AREA_DATA_WIDTH:7,AREA_DATA_HEIGHT:8,COUNT:9},um=function(e,t){return Object.keys(e).map(function(n){return "#define {"+t+n+"} "+e[n]}).join("\n")},u_="\n\n    "+um(up,"CLUSTER_TEXTURE_")+"\n    "+um({LIGHTSHAPE_PUNCTUAL:"0u",LIGHTSHAPE_RECT:"1u",LIGHTSHAPE_DISK:"2u",LIGHTSHAPE_SPHERE:"3u",LIGHT_COLOR_DIVIDER:"100.0"},"")+"\n",uv=function(){function e(e){this.areaLightsEnabled=false,this.device=e,o0.get(e,nn).set("lightBufferDefinesPS",u_),o0.get(e,ni).set("lightBufferDefinesPS",u_),this.cookiesEnabled=false,this.shadowsEnabled=false,this.areaLightsEnabled=false,this.maxLights=255;var t=up.COUNT;this.lightsFloat=new Float32Array(4*t*this.maxLights),this.lightsUint=new Uint32Array(this.lightsFloat.buffer),this.lightsTexture=this.createTexture(this.device,t,this.maxLights,14,"LightsTexture"),this._lightsTextureId=this.device.scope.resolve("lightsTexture"),this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new eW,this.boundsDelta=new eW;}var t=e.prototype;return t.destroy=function(){var e;null==(e=this.lightsTexture)||e.destroy(),this.lightsTexture=null;},t.createTexture=function(e,t,n,i,r){return new nO(e,{name:r,width:t,height:n,mipmaps:false,format:i,addressU:1,addressV:1,type:t0,magFilter:0,minFilter:0,anisotropy:1})},t.setBounds=function(e,t){this.boundsMin.copy(e),this.boundsDelta.copy(t);},t.uploadTextures=function(){this.lightsTexture.lock().set(this.lightsFloat),this.lightsTexture.unlock();},t.updateUniforms=function(){this._lightsTextureId.setValue(this.lightsTexture);},t.getSpotDirection=function(e,t){t._node.getWorldTransform().getY(e).mulScalar(-1),e.normalize();},t.getLightAreaSizes=function(e){var t=e._node.getWorldTransform();return t.transformVector(uf,uc),uh[0]=uc.x,uh[1]=uc.y,uh[2]=uc.z,t.transformVector(ud,uc),uh[3]=uc.x,uh[4]=uc.y,uh[5]=uc.z,uh},t.addLightData=function(e,t){var n=2===e._type,i=e.atlasViewportAllocated,r=this.cookiesEnabled&&!!e._cookie&&i,s=this.areaLightsEnabled&&0!==e.shape,a=this.shadowsEnabled&&e.castShadows&&i,o=e._node.getPosition(),l=null,u=null;n?a?l=e.getRenderData(null,0).shadowMatrix:r&&(l=uu.evalSpotCookieMatrix(e)):(a||r)&&(u=e.atlasViewport);var c=this.lightsFloat,h=this.lightsUint,f=t*this.lightsTexture.width*4;c[f+4*up.POSITION_RANGE+0]=o.x,c[f+4*up.POSITION_RANGE+1]=o.y,c[f+4*up.POSITION_RANGE+2]=o.z,c[f+4*up.POSITION_RANGE+3]=e.attenuationEnd;var d=e.clusteredData;if(h[f+4*up.COLOR_ANGLES_BIAS+0]=d[0],h[f+4*up.COLOR_ANGLES_BIAS+1]=d[1],h[f+4*up.COLOR_ANGLES_BIAS+2]=d[2],e.castShadows){var p=e.getRenderData(null,0),m=e._getUniformBiasValues(p),_=eG.float2Half(m.bias),v=eG.float2Half(m.normalBias);h[f+4*up.COLOR_ANGLES_BIAS+3]=_|v<<16;}if(n&&(this.getSpotDirection(uc,e),c[f+4*up.DIRECTION_FLAGS+0]=uc.x,c[f+4*up.DIRECTION_FLAGS+1]=uc.y,c[f+4*up.DIRECTION_FLAGS+2]=uc.z),h[f+4*up.DIRECTION_FLAGS+3]=e.getClusteredFlags(a,r),l)for(var g=l.data,y=0;y<16;y++)c[f+4*up.PROJ_MAT_0+y]=g[y];if(u&&(c[f+4*up.ATLAS_VIEWPORT+0]=u.x,c[f+4*up.ATLAS_VIEWPORT+1]=u.y,c[f+4*up.ATLAS_VIEWPORT+2]=u.z/3),s){var S=this.getLightAreaSizes(e);c[f+4*up.AREA_DATA_WIDTH+0]=S[0],c[f+4*up.AREA_DATA_WIDTH+1]=S[1],c[f+4*up.AREA_DATA_WIDTH+2]=S[2],c[f+4*up.AREA_DATA_HEIGHT+0]=S[3],c[f+4*up.AREA_DATA_HEIGHT+1]=S[4],c[f+4*up.AREA_DATA_HEIGHT+2]=S[5];}},e}(),ug=new eW,uy=new eW,uS=new eW,ux=new e8,ub=function(){this.light=null,this.min=new eW,this.max=new eW;},uT=function(){function e(e){this.device=e,this.name="Untitled",this.reportCount=0,this.boundsMin=new eW,this.boundsMax=new eW,this.boundsDelta=new eW,this._cells=new eW(1,1,1),this._cellsLimit=new eW,this.cells=this._cells,this.maxCellLightCount=4,this._usedLights=[],this._usedLights.push(new ub),this.lightsBuffer=new uv(e),this.registerUniforms(e);}var t,n=e.prototype;return n.destroy=function(){this.lightsBuffer.destroy(),this.releaseClusterTexture();},n.releaseClusterTexture=function(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null);},n.registerUniforms=function(e){this._clusterSkipId=e.scope.resolve("clusterSkip"),this._clusterMaxCellsId=e.scope.resolve("clusterMaxCells"),this._clusterWorldTextureId=e.scope.resolve("clusterWorldTexture"),this._clusterTextureSizeId=e.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=e.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=e.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=e.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=e.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=e.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3);},n.updateParams=function(e){e&&(this.cells=e.cells,this.maxCellLightCount=e.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=e.cookiesEnabled,this.lightsBuffer.shadowsEnabled=e.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=e.areaLightsEnabled);},n.updateCells=function(){if(this._cellsDirty){this._cellsDirty=false;var e=this._cells.x,t=this._cells.y,n=this._cells.z,i=e*t*n,r=this.maxCellLightCount*i,s=Math.ceil(Math.sqrt(r)),a=Math.ceil(r/(s=ek.roundUp(s,this.maxCellLightCount)));this._clusterCellsMaxData[0]=e,this._clusterCellsMaxData[1]=t,this._clusterCellsMaxData[2]=n,this._clusterCellsDotData[0]=this.maxCellLightCount,this._clusterCellsDotData[1]=e*n*this.maxCellLightCount,this._clusterCellsDotData[2]=e*this.maxCellLightCount,this.clusters=new Uint8ClampedArray(r),this.counts=new Int32Array(i),this._clusterTextureSizeData[0]=s,this._clusterTextureSizeData[1]=1/s,this._clusterTextureSizeData[2]=1/a,this.releaseClusterTexture(),this.clusterTexture=this.lightsBuffer.createTexture(this.device,s,a,52,"ClusterTexture");}},n.uploadTextures=function(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures();},n.updateUniforms=function(){this._clusterSkipId.setValue(this._usedLights.length>1?0:1),this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture),this._clusterMaxCellsId.setValue(this.maxCellLightCount);var e=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/e.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/e.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/e.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=e.x,this._clusterBoundsDeltaData[1]=e.y,this._clusterBoundsDeltaData[2]=e.z,this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData);},n.evalLightCellMinMax=function(e,t,n){t.copy(e.min),t.sub(this.boundsMin),t.div(this.boundsDelta),t.mul2(t,this.cells),t.floor(),n.copy(e.max),n.sub(this.boundsMin),n.div(this.boundsDelta),n.mul2(n,this.cells),n.ceil(),t.max(eW.ZERO),n.min(this._cellsLimit);},n.collectLights=function(e){var t=this.lightsBuffer.maxLights,n=this._usedLights,i=1;e.forEach(function(e){var r,s=!!(3&e.mask),a=2===e.type&&0===e._outerConeAngle;e.enabled&&0!==e.type&&e.visibleThisFrame&&e.intensity>0&&s&&!a&&i<t&&(i<n.length?r=n[i]:(r=new ub,n.push(r)),r.light=e,e.getBoundingBox(ux),r.min.copy(ux.getMin()),r.max.copy(ux.getMax()),i++);}),n.length=i;},n.evaluateBounds=function(){var e=this._usedLights,t=this.boundsMin,n=this.boundsMax;if(e.length>1){t.copy(e[1].min),n.copy(e[1].max);for(var i=2;i<e.length;i++)t.min(e[i].min),n.max(e[i].max);}else t.set(0,0,0),n.set(1,1,1);this.boundsDelta.sub2(n,t),this.lightsBuffer.setBounds(t,this.boundsDelta);},n.updateClusters=function(e){this.counts.fill(0),this.clusters.fill(0),this.lightsBuffer.areaLightsEnabled=!!e&&e.areaLightsEnabled;for(var t=this._cells.x,n=this._cells.z,i=this.counts,r=this._maxCellLightCount,s=this.clusters,a=this.maxCellLightCount,o=this._usedLights,l=1;l<o.length;l++){var u=o[l],c=u.light;this.lightsBuffer.addLightData(c,l),this.evalLightCellMinMax(u,uy,uS);for(var h=uy.x,f=uS.x,d=uy.y,p=uS.y,m=uy.z,_=uS.z,v=h;v<=f;v++)for(var g=m;g<=_;g++)for(var y=d;y<=p;y++){var S=v+t*(g+y*n),x=i[S];x<r&&(s[a*S+x]=l,i[S]=x+1);}}},n.update=function(e,t){ void 0===t&&(t=null),this.updateParams(t),this.updateCells(),this.collectLights(e),this.evaluateBounds(),this.updateClusters(t),this.uploadTextures();},n.activate=function(){this.updateUniforms();},t=[{key:"maxCellLightCount",get:function(){return this._maxCellLightCount},set:function(e){e!==this._maxCellLightCount&&(this._maxCellLightCount=e,this._cellsDirty=true);}},{key:"cells",get:function(){return this._cells},set:function(e){ug.copy(e).floor(),this._cells.equals(ug)||(this._cells.copy(ug),this._cellsLimit.copy(ug).sub(eW.ONE),this._cellsDirty=true);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),uE=null,uw=function(){if(!uE){var e=atob("muPIHORMLNDCz4DxVR/ZvYfAUVEFR47KRIC4nwAAAAAP7WxlhD6Ci+2HCe7BF8jRAPZwdH2UPpI5PdLCJdkvG4UTaNDJ/0crAzne71GCrb4kbdMjjCEGzdX6fNxDMLJq5xkeoIVTdfiZkodEeArmZmp/FQzFjD4x8iOW7Dg64n+3mWqyEwLxXT8zoJXfbw8QJKDCaarUYyTlMzNFHbgUe9IQV7g4YOgtSKpIFZJ0qERm7u4PpmiF89ktHWCywaGmD6h+hfh2/Zd8KYlKqqo4Cem4T42bT/Z9FpCQF1hhSjfBzZ5XFn/y3jegWC6u86KuELRundQS/1Rp+XuKKGIgRv3CvP5y749yqLlFO495JOT3+f2CXgd71npU0/KjjpkZucbJ5m78IVyuSrSozc9jgBUhDrz0hFsyb7LFUH9//wJbBgLdNWJZObfKxrNt8TliLA9w9sXFv6g26iXpf6r/BqcAusj/QzGBZuoUGeEtw8BCXCZ3jUiw4hvM18ZVqlUD3C40LAFXW6FRjuAZGRNstb0/qVk4skwyT+MHrvRorI4rKHVMWZmKyAkzL/78u/9pMQuX14pZN50b2PHn6fRxeaCQLsfT4dpvIkWWFuFVENZIh+8xgR6lU+85W0PPdAu1j99kcCG40JBQa4JMyRzq6qriOBLtqF87vpCJan0WEduVr/mOYkS00urVA0mA6M3031+GmGmW48PaJDYOEIb3bIXWPaLoAOEinX1TN3+/vwhG6nqJu0TdHpedS7QsGZIoxH3nQYYjQP1jmbahlbNngw5ogsGk1y50XZyUmQBY+/JBJ3Unu4dApm+WmPwHPU9gLb+4mHh4BiY6M86pq+WeTyWdI3s0CXPEtHGXZ8zMZgUoyRomBi1VdazzuN+WOmQ9Pa0Z0tlNopUi8AJ4x2Xn4mmOKEbXLxlbVsWu8XhuDGYFOGCRVdSqDPXrHU5SDdUlti3k5///SBwzTMwK3L4a1H7w4lnpEas6////AfX8asyIBfeFXVJ3tgvxQ/blZuUKyIODIfr/UzdWNu7pciLBpdZRZ4pIfZ1R6szq+XNxkGG///8EZFpu7VHAhFWqHEOrB9unw+YQa5o8/9IR/V5/zq+986rJSyfgJKt2u9hxU1wzyQWPjJGvzG9+eWWxGFOHVKqI4jBQALwZZswesnvZ2UmmkEXdiRpz8B+oWE7PY70ZTMndisYSXg2TqoI+3y9BxbnY2Y4EfbdcRhAvG59NqDENNYbxKvK5HJfPG5M+Wi2AcpLVJrD6caiEOzgSoVNSgQK8fm2M3zGcF4xtClv/8Hs9oD7C3jitTATYNQxmKqKf1LhIxzf1bmfiNn7UKFmcJu4sLqVLwxGSue3taBEyknkw5hXTsUCvqmmL/f8n/w0giR7Hu/9EHvpkz3yuu64TioMkzdTJ30i0+hFnQqW1+v9mMwq+z9qGX0UFu9MomvVG2xod6vc12AAAAACq7sGa5qptFR0jF3nQt/D+7PibKYahaxP3hEixPbGi9nwNf2LAa7LkEZRKxzXeCD64Xpii5n+8Kpg8eHIv7AWXZltgMoGltmoJ0XGdOCL8WkzphvR9N2o3ARSZ42l5e5Pe4B58MCRlP3EKv+mcloknH+fto5BWsmEutW6KvjOVsznFCktkSczVk4aGvj9VXlRcLeDoKG8RkBgdcNG2bf8HUL4MT2DM+ar7NImJhKpxakX4Vk0CnP+/XNhl5UsP0lXgeZXPoDBMSW5An+DXlTCO5FQGwSPYwHLKYVIimEdAoVe49rQLaaNcye5LxU2/c5TijTgJtD5eQQIe1snxauj5jZsxJBUJdoP/zqpjqv8qBruoPsVsP8N44PCUW5Dd0DzqjSS/Dl5mI9cn1w2ndN/0KAEm1QAAAACwu6KM/083IBbH5bPa/9oHUwcU8I9v3j6/v18QYammrf+P6VL///8BrpuM3fOLCxaLNOFNF1zPbPYTP65ni6njft4eVcyrVXRQFrs52tr35StiSp55edVDCBC0H5rIfac6nzUwxQSt7y15QoKb+5zebEQUmVbrPjXuUa19Ey7sqXMiSUKHaw72PJKDdrutJoQr3u6lEYJ8K0MakWKj9zjTFi4X94TsKYco0GrLeB60M6D8M/80rhXUW8iMequg8y5F838WI0+gp3GBN5Kj/xIOxTWQuUaPV/LwvARr1VH93BFgGZR1MFW0Ua30GbYmdnAgo9VWy8SQtpDUgGE2r2zq2eTEMCL7sMKmE1hchVhuF/TCq9iXKEm86kzOf3Rp9ZnCxbpDUj+FKNxVyXe6pVZkRXv/m95SnB/EB8aME29N85MtAcDoXWlor8De2Q5Dg1tar+8wgiZufbMam81j//ASUohoR/zSh2KG4bvT6mkIPz6C5/98DC3LaWlaEZ1zA5JORZRu6J/a0GY285sEYzw71YqOT1ihAG0z5SDt1xNiDQWZdFpndArp6xWhqSDkRb4kSJEHb9liPvw7uLV/6i5MVf//A9Qjr8xkAEUh+KDI+zdtJ68d6MBOktg1iyp/SCq8O9f5pbamn1VVVQPRTWqNBvhQKa07s6P0lc9Luu/3gw4HeyOUfz8MxMwV4UQhua+t9cr4bz/nIB2wnDSK1K7I94M+s6C84htaX/CNlMQUSs2KJO+yaebfTbkNX5yWcqEJevo0vbKUiETuFXiL019A3E+lmsyZMwXrXLLiQAZ5t9+jI3JobhJTMiDH5ZOQ+8Jau5555NMjHSscP9qCVaa40doh+1a3Ukf6jqBmLddgh79/fwTfCyqiuldNkUoy+nUp+4nerwg0OjtGv2x485PJOJvUEokNhYIdWjpx7BWk0VZGWOp3jSFTJ2bnu6KCduZtG/UcBC9RZ3W/jMSfSMw4Etr/DoD/XYP2V5Ovw+YoM3F5g2dGLdvuG6ZkVGLE6Dk5Zr+sdSyGliJP1y2OFf/KFO0RWO+3gsGhesTnfZVpTd8/HwgO216gwaqo+vY3TljfJWowY+i0p0Os4SLn/1wLqDHMlszggmT/D8MRFzs+pLv6LNJSsNZ/r41mWi/rF6ZcKp/yzJdK0VU44hskq3RGpgO6mIpJDsf/mZkFrz0yYOMLbuaj/wp1v7JMFM5eqvBhmTd7U8frQAtHtys4zgpjZmzUhOVTfNNLifElGXADlqHGKrkBT/nYwX8ZRm3RjvyPvjKyEqEGKUpVnvOGx+NKPHiWM//ZDpDVGvvrjmk8RPF/wiYZD3+Us8YCXjrVOfjdd1UPAfjLp8jgSn4me7DPTpz1Ggy9XL80guFO7ECT10AvILKfD18Qx+KY/f8aRqu0oOO8hfKRFZa9PUJwCsp6VdZz6LFkm2b9Pl2LIifCwzRy7TpdG2uAtOxP2OemY26bJMa9ZGSLIRlMsgpDpnDJwd0oa5pQ13x1hrHf52HpulUWonGWsfXZbSQYKu9bnEN76ciQih0opN3deDVrbrxorfVlnCmL1R9zq3ePGWIv21c7pW8kEiFTM5JX8dAw867s/60cf79/BH+MDFCZBHlz1L+qGOJf/1txhhmrf3//As+RIJwevDb+fgNXVeHw67QptZegayhrEwr5Gy+EPo1RLaMtPbqOZYoVzXzwzjMFWZxyUG9YUIf6////AQWy84iAygLk9COtXt92+0mT/xg0zMzMBeLkb8y9SL2TDXgSX422hDgpGNLJyuPioA+YJ91G8znrpNqHkwYyscaJDEc9Vc+j4cXle3hvcd2JqDQH2lBZxDn6mUTs0b75raMvbs727codX01Anj8f3wir9P2xQaQ22v/TxCMglKDFoTjaP01XTLgxnTvPv02JgEUrW6UDgOnobFpLdvKdlypgIzPcq14fgXU5tvVW0FEs7VRlsG1IyA69fN4n+awHhT34cE+xUvdj86C8LgAsFheTjI9Ht9EyYAAAAAAVBVKRx2wLgUTI0/2QfyJo2riRw3JDqzEShmx/Lifo6mRkQVbS7X53t+EvKxcXogtdts31e9MRHdcHgsA8rt4/mt2unlzQ/wsU8Gu7+W6Oj7eD8EQdDp5XlCsVaS/AV/t5ZpPOHR3rGpyAJe9IPV+xMrBL1Oz/8MQhFs31h0N1cVnq371uqIJYHyafKH1jteAK3VpMXBcuC+yt0ZeKyRUY4QhdrJJ4tJ1wg3Hu6kDsbovxupTMkGdRrm8oZSoYPbJ+PwH/xotgTdkA1205vUEfnqkI04T/fnnd1fiZW5AwNcggd7fi4j5zasmcntZexIxqFZQMzMJpfndmI5jn17cgn5EV5t9XN0C///8Q9wlJpMGXdoiaMTG2sVyHQsn8mWRISCLNG777S0OuDRP2GlLcJ2UeOg7Fo8hTNPeJ//iTJhyqxhKRUntdXOihq2wfKfH///8B0GGrwT+fSOQRdctKxjjGCSS11d6BlQ9BDfE0J6Z25FaNTKGpFKNCMr2G/041KpWwBLVe1k08vncseQbKZdXi8x1t9XA45U/Wd43D9wAh3Tal0aiLVzGPusOZ1F+W3TWoqlX/A95+dNef11TsuGful+ctGssldk3fqpfqh+43XTxL42+leSHoF/dWHYGX6maqUEuLX7UB+r/6Llr4LKocbVIeu+hB9QTPfz9fCP8RyWmX4SmbhMFsNtCijV7lVcwejLKlvl0GfCndnWV7/39VBrtTRuUx92oke3GBgKkC5fdGK0YvNK+xenKaDmsHDjNFUM3NMz3ZiXXFuLgojosPVCDEl2W5BjX3Ms+j0GSqACHmh0+RPWyuNm/Qe8vFf9AW7N1uRaxWirrUytqEJnJ4/Flm8hSoiZ2NQBsS6w/yQlC4gCaFo8q4nyY6AFdo4hiwhBXzbNKKvZvktCjSCukRR/BbYVbNwZi2Yh3hGodEacLW8qijiWJODf0P2bhfaiPspPT4lYJBgi/KfcFwCfvyUIgkJOv///8CG/JEepRBLaMFE+2TgrqsJXOVOWHt6g/bFwVLLMVBsMR50dis/39/AlBX+/rMTJkUQrnlxpR2iu0Tp8tATkRYGmDIrcAiRP8PjoWIlb7/0ecTdSCE9Y58+a+n/FovJQTVF4F2jAxMZhTgrM/KVS5BQu6bVbkWY5HXnxRshks3urDdW4RkWp4M4TeLmFK5KF/uHkkiO5Kv96RioH984v/CSDBnG+BwlnU9B+o7Y+0X0Nob+0pLsStxjvPXMy2eCpzhOWV4XbObBHN4UE2sLQ/DIqXhOzxVf38GlTi6aG7EnePO7TRJm9yOfUUcqq1I2iQHrVDqn3TUNRi/lMw8KbMW/3/nqCz/Ef8PoW5Qxcz2yHR/f78EPB2Stbd+ZFmfNTUYILzsb9YNhpaHcaymYrBiNHmFE3Y4ccYJ25Prqm7zHobGHED8/93ZNlWro9vcKivGZs31UiK1k5zjUhexUgbqJb+fUTjxce/7Zly8a5KMC1fX5nfjPgibdvzbXV1jRT2asXvmSAusaLdq1TSIJ8fXINk5AtT34EWPAsfP9IFQqM5K11O6saoHJA==");uE=Uint8Array.from(e,function(e){return e.charCodeAt(0)});}},uA=function(){function e(e){ void 0===e&&(e=0),this.seed=0,this.seed=4*e,uw();}var t=e.prototype;return t._next=function(){this.seed=(this.seed+4)%uE.length;},t.value=function(){return this._next(),uE[this.seed]/255},t.vec4=function(e){return void 0===e&&(e=new eY),this._next(),e.set(uE[this.seed],uE[this.seed+1],uE[this.seed+2],uE[this.seed+3]).mulScalar(1/255)},e}(),uC=[new eW(-1,0,0),new eW(1,0,0),new eW(0,-1,0),new eW(0,1,0),new eW(0,0,-1),new eW(0,0,1)],uP=function(){function e(){this.colors=new Float32Array(18);}return e.prototype.update=function(e,t){for(var n=this.colors,i=e.r,r=e.g,s=e.b,a=0;a<6;a++)n[3*a]=i,n[3*a+1]=r,n[3*a+2]=s;for(var o=0;o<t.length;o++){var l=t[o];if(0===l._type)for(var u=0;u<6;u++){var c=Math.max(uC[u].dot(l._direction),0)*l._intensity,h=l._color;n[3*u]+=h.r*c,n[3*u+1]+=h.g*c,n[3*u+2]+=h.b*c;}}},e}(),uI=function(e,t,n,i){var r=new nO(e,{name:""+t+n,width:n,height:n,format:7,addressU:0,addressV:0,type:t0,magFilter:0,minFilter:0,anisotropy:1,mipmaps:false});return r.lock().set(i),r.unlock(),r},uL=new nD,uD=function(){function e(e,t){this.texture=e,this.cached=false,this.renderTargets=t;}return e.prototype.destroy=function(){this.texture&&(this.texture.destroy(),this.texture=null);for(var e=this.renderTargets,t=0;t<e.length;t++)e[t].destroy();this.renderTargets.length=0;},e.create=function(e,t){return 1===t._type?this.createCubemap(e,t._shadowResolution,t._shadowType):this.create2dMap(e,t._shadowResolution,t._shadowType)},e.createAtlas=function(e,t,n){for(var i=this.create2dMap(e,t,n),r=i.renderTargets,s=r[0],a=0;a<5;a++)r.push(s);return i},e.create2dMap=function(t,n,i){var r,s=ol.get(i),a=s.format;15===a&&!t.textureFloatRenderable&&t.textureHalfFloatRenderable&&(a=50);var o=null==(r=tm.get(a))?void 0:r.name,l=1;3===i&&(l=+!!t.extTextureFloatLinear),6===i&&(l=0);var u=new nO(t,{format:a,width:n,height:n,mipmaps:false,minFilter:l,magFilter:l,addressU:1,addressV:1,name:"ShadowMap2D_"+o}),c=null;return (null==s?void 0:s.pcf)?(u.compareOnRead=true,u.compareFunc=1,c=new il({depthBuffer:u})):c=new il({colorBuffer:u,depth:true}),t.isWebGPU&&(c.flipY=true),new e(u,[c])},e.createCubemap=function(t,n,i){var r,s=ol.get(i),a=null==(r=tm.get(s.format))?void 0:r.name,o=6===i,l=+!o,u=new nO(t,{format:null==s?void 0:s.format,width:n,height:n,cubemap:true,mipmaps:false,minFilter:l,magFilter:l,addressU:1,addressV:1,name:"ShadowMapCube_"+a});o||(u.compareOnRead=true,u.compareFunc=1);for(var c=[],h=0;h<6;h++)o?c.push(new il({colorBuffer:u,face:h,depth:true})):c.push(new il({depthBuffer:u,face:h}));return new e(u,c)},e}(),uM=[],uR=[],uO=new eY,uk=new eY,uN=function(e){this.size=Math.floor(1024*e.w),this.used=false,this.lightId=-1,this.rect=e;},uF=function(){function e(e){this.device=e,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=4,this.cookieAtlas=new nO(this.device,{name:"CookieAtlas",width:this.cookieAtlasResolution,height:this.cookieAtlasResolution,format:20,cubemap:false,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1}),this.cookieRenderTarget=new il({colorBuffer:this.cookieAtlas,depth:false,flipY:true}),this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new eX(0,0),new eX(0,1),new eX(1,0),new eX(1,1),new eX(2,0),new eX(2,1)],this.scissorVec=new eY,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms();}var t=e.prototype;return t.destroy=function(){this.destroyShadowAtlas(),this.destroyCookieAtlas();},t.destroyShadowAtlas=function(){var e;null==(e=this.shadowAtlas)||e.destroy(),this.shadowAtlas=null;},t.destroyCookieAtlas=function(){var e,t;null==(e=this.cookieAtlas)||e.destroy(),this.cookieAtlas=null,null==(t=this.cookieRenderTarget)||t.destroy(),this.cookieRenderTarget=null;},t.allocateShadowAtlas=function(e,t){ void 0===t&&(t=0);var n,i=null==(n=this.shadowAtlas)?void 0:n.texture.format,r=ol.get(t).format;if(!this.shadowAtlas||this.shadowAtlas.texture.width!==e||i!==r){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=uD.createAtlas(this.device,e,t),this.shadowAtlas.cached=true;var s=4/this.shadowAtlasResolution;this.scissorVec.set(s,s,-2*s,-2*s);}},t.allocateCookieAtlas=function(e){this.cookieAtlas.width!==e&&(this.cookieRenderTarget.resize(e,e),this.version++);},t.allocateUniforms=function(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture");},t.updateUniforms=function(){var e=this.shadowAtlas.renderTargets[0].depthBuffer;this._shadowAtlasTextureId.setValue(e),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas);},t.subdivide=function(e,t){var n=t.atlasSplit;if(!n){var i=Math.ceil(Math.sqrt(e));(n=uR)[0]=i,n.length=1;}if(r=n,s=this.atlasSplit,!(r.length===s.length&&r.every(function(e,t){return e===s[t]}))){this.version++,this.slots.length=0,this.atlasSplit.length=0,(a=this.atlasSplit).push.apply(a,[].concat(n));var r,s,a,o=this.atlasSplit[0];if(o>1)for(var l=1/o,u=0;u<o;u++)for(var c=0;c<o;c++){var h=new eY(u*l,c*l,l,l),f=this.atlasSplit[1+u*o+c];if(f>1)for(var d=0;d<f;d++)for(var p=0;p<f;p++){var m=l/f,_=new eY(h.x+d*m,h.y+p*m,m,m);this.slots.push(new uN(_));}else this.slots.push(new uN(h));}else this.slots.push(new uN(new eY(0,0,1,1)));this.slots.sort(function(e,t){return t.size-e.size});}},t.collectLights=function(e,t){var n=t.cookiesEnabled,i=t.shadowsEnabled,r=false,s=false;return uM.length=0,(n||i)&&function(e){for(var t=0;t<e.length;t++){var a=e[t];if(a.visibleThisFrame){var o=i&&a.castShadows,l=n&&!!a.cookie;r||(r=o),s||(s=l),(o||l)&&uM.push(a);}}}(e),uM.sort(function(e,t){return t.maxScreenSize-e.maxScreenSize}),r&&this.allocateShadowAtlas(this.shadowAtlasResolution,t.shadowType),s&&this.allocateCookieAtlas(this.cookieAtlasResolution),(r||s)&&this.subdivide(uM.length,t),uM},t.setupSlot=function(e,t){e.atlasViewport.copy(t);for(var n=e.numShadowFaces,i=0;i<n;i++)if(e.castShadows||e._cookie){if(uO.copy(t),uk.copy(t),2===e._type&&uO.add(this.scissorVec),1===e._type){var r=uO.z/3,s=this.cubeSlotsOffsets[i];uO.x+=r*s.x,uO.y+=r*s.y,uO.z=r,uO.w=r,uk.copy(uO);}if(e.castShadows){var a=e.getRenderData(null,i);a.shadowViewport.copy(uO),a.shadowScissor.copy(uk);}}},t.assignSlot=function(e,t,n){e.atlasViewportAllocated=true;var i=this.slots[t];i.lightId=e.id,i.used=true,n&&(e.atlasSlotUpdated=true,e.atlasVersion=this.version,e.atlasSlotIndex=t);},t.update=function(e,t){this.shadowAtlasResolution=t.shadowAtlasResolution,this.cookieAtlasResolution=t.cookieAtlasResolution;var n=this.collectLights(e,t);if(n.length>0){for(var i=this.slots,r=0;r<i.length;r++)i[r].used=false;for(var s=Math.min(n.length,i.length),a=0;a<s;a++){var o=n[a];o.castShadows&&(o._shadowMap=this.shadowAtlas);var l=i[o.atlasSlotIndex];if(o.atlasVersion===this.version&&o.id===(null==l?void 0:l.lightId)){var u=i[o.atlasSlotIndex];u.size!==i[a].size||u.used||this.assignSlot(o,o.atlasSlotIndex,false);}}for(var c=0,h=0;h<s;h++){for(;c<i.length&&i[c].used;)c++;var f=n[h];f.atlasViewportAllocated||this.assignSlot(f,c,true);var d=i[f.atlasSlotIndex];this.setupSlot(f,d.rect);}}this.updateUniforms();},e}();function uB(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}var uU=[];uU[0]={src:1,dst:1,op:2},uU[3]={src:1,dst:0,op:0},uU[2]={src:6,dst:8,op:0,alphaSrc:1},uU[4]={src:1,dst:8,op:0},uU[1]={src:1,dst:1,op:0},uU[6]={src:6,dst:1,op:0},uU[7]={src:4,dst:2,op:0},uU[8]={src:5,dst:1,op:0},uU[5]={src:4,dst:0,op:0},uU[9]={src:1,dst:1,op:3},uU[10]={src:1,dst:1,op:4};var uz=0,uV=function(){function e(){this.meshInstances=[],this.name="Untitled",this.userId="",this.id=uz++,this.variants=new Map,this.defines=new Map,this._definesDirty=false,this.parameters={},this.alphaTest=0,this.alphaToCoverage=false,this._blendState=new nj,this._depthState=new nq,this.cull=1,this.stencilFront=null,this.stencilBack=null,this._shaderChunks=null,this._oldChunks={},this._dirtyShader=true,this._shaderVersion=0,this._scene=null,this.dirty=true,(null!=e&&"undefined"!=typeof Symbol&&e[Symbol.hasInstance]?!!e[Symbol.hasInstance](this):i(this,e))&&this.constructor;}var t,n=e.prototype;return n.getShaderChunks=function(e){ void 0===e&&(e=nn);var t=this.shaderChunks;return e===nn?t.glsl:t.wgsl},n._updateTransparency=function(){for(var e=this.transparent,t=this.meshInstances,n=0;n<t.length;n++)t[n].transparent=e;},n.copy=function(e){var t,n,i=this;for(var r in this.name=e.name,this.alphaTest=e.alphaTest,this.alphaToCoverage=e.alphaToCoverage,this._blendState.copy(e._blendState),this._depthState.copy(e._depthState),this.cull=e.cull,this.stencilFront=null==(t=e.stencilFront)?void 0:t.clone(),e.stencilBack&&(this.stencilBack=e.stencilFront===e.stencilBack?this.stencilFront:e.stencilBack.clone()),this.clearParameters(),e.parameters)e.parameters.hasOwnProperty(r)&&this._setParameterSimple(r,e.parameters[r].data);return this.defines.clear(),e.defines.forEach(function(e,t){return i.defines.set(t,e)}),this._shaderChunks=e.hasShaderChunks?new o0:null,null==(n=this._shaderChunks)||n.copy(e._shaderChunks),this},n.clone=function(){return new this.constructor().copy(this)},n._updateMeshInstanceKeys=function(){for(var e=this.meshInstances,t=0;t<e.length;t++)e[t].updateKey();},n.updateUniforms=function(e,t){this._dirtyShader&&this.clearVariants();},n.getShaderVariant=function(e){},n.update=function(){if(Object.keys(this._oldChunks).length>0)for(var e,t,n,i=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return uB(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return uB(e,void 0)}}(e))){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(Object.entries(this._oldChunks));!(n=i()).done;){var r=n.value,s=r[0],a=r[1];this.shaderChunks.glsl.set(s,a),delete this._oldChunks[s];}(this._definesDirty||(null==(t=this._shaderChunks)?void 0:t.isDirty()))&&(this._definesDirty=false,null==(e=this._shaderChunks)||e.resetDirty(),this.clearVariants()),this.dirty=true;},n.clearParameters=function(){this.parameters={};},n.getParameters=function(){return this.parameters},n.clearVariants=function(){this.variants.clear();for(var e=this.meshInstances,t=e.length,n=0;n<t;n++)e[n].clearShaders();},n.getParameter=function(e){return this.parameters[e]},n._setParameterSimple=function(e,t){var n=this.parameters[e];n?n.data=t:this.parameters[e]={scopeId:null,data:t};},n.setParameter=function(e,t){var n;if(void 0===t&&(void 0===e?"undefined":(n=e)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)=="object"){var i=e;if(i.length){for(var r=0;r<i.length;r++)this.setParameter(i[r]);return}e=i.name,t=i.value;}this._setParameterSimple(e,t);},n.deleteParameter=function(e){this.parameters[e]&&delete this.parameters[e];},n.setParameters=function(e,t){var n=this.parameters;for(var i in void 0===t&&(t=n),t){var r=n[i];r&&(r.scopeId||(r.scopeId=e.scope.resolve(i)),r.scopeId.setValue(r.data));}},n.setDefine=function(e,t){var n=false,i=this.defines;void 0!==t&&false!==t?(n=!i.has(e)||i.get(e)!==t,i.set(e,t)):(n=i.has(e),i.delete(e)),this._definesDirty||(this._definesDirty=n);},n.getDefine=function(e){return this.defines.has(e)},n.destroy=function(){this.variants.clear();for(var e=0;e<this.meshInstances.length;e++){var t=this.meshInstances[e];if(t.clearShaders(),t._material=null,t.mesh){var n=lg(t.mesh.device);this!==n&&(t.material=n);}}this.meshInstances.length=0;},n.addMeshInstanceRef=function(e){this.meshInstances.push(e);},n.removeMeshInstanceRef=function(e){var t=this.meshInstances,n=t.indexOf(e);-1!==n&&t.splice(n,1);},t=[{key:"hasShaderChunks",get:function(){return null!=this._shaderChunks}},{key:"shaderChunks",get:function(){return this._shaderChunks||(this._shaderChunks=new o0),this._shaderChunks}},{key:"shaderChunksVersion",get:function(){return this.shaderChunks.version},set:function(e){this.shaderChunks.version=e;}},{key:"chunks",get:function(){return Object.assign(this._oldChunks,Object.fromEntries(this.shaderChunks.glsl)),this._oldChunks},set:function(e){this._oldChunks=e;}},{key:"depthBias",get:function(){return this._depthState.depthBias},set:function(e){this._depthState.depthBias=e;}},{key:"slopeDepthBias",get:function(){return this._depthState.depthBiasSlope},set:function(e){this._depthState.depthBiasSlope=e;}},{key:"redWrite",get:function(){return this._blendState.redWrite},set:function(e){this._blendState.redWrite=e;}},{key:"greenWrite",get:function(){return this._blendState.greenWrite},set:function(e){this._blendState.greenWrite=e;}},{key:"blueWrite",get:function(){return this._blendState.blueWrite},set:function(e){this._blendState.blueWrite=e;}},{key:"alphaWrite",get:function(){return this._blendState.alphaWrite},set:function(e){this._blendState.alphaWrite=e;}},{key:"transparent",get:function(){return this._blendState.blend}},{key:"blendState",get:function(){return this._blendState},set:function(e){this._blendState.copy(e),this._updateTransparency();}},{key:"blendType",get:function(){if(!this.transparent)return 3;for(var e=this._blendState,t=e.colorOp,n=e.colorSrcFactor,i=e.colorDstFactor,r=e.alphaOp,s=e.alphaSrcFactor,a=e.alphaDstFactor,o=0;o<uU.length;o++){var l=uU[o];if(l.src===n&&l.dst===i&&l.op===t&&l.src===s&&l.dst===a&&l.op===r)return o}return 2},set:function(e){var t,n,i,r=uU[e];this._blendState.setColorBlend(r.op,r.src,r.dst),this._blendState.setAlphaBlend(null!=(t=r.alphaOp)?t:r.op,null!=(n=r.alphaSrc)?n:r.src,null!=(i=r.alphaDst)?i:r.dst);var s=3!==e;this._blendState.blend!==s&&(this._blendState.blend=s,this._updateTransparency()),this._updateMeshInstanceKeys();}},{key:"depthState",get:function(){return this._depthState},set:function(e){this._depthState.copy(e);}},{key:"depthTest",get:function(){return this._depthState.test},set:function(e){this._depthState.test=e;}},{key:"depthFunc",get:function(){return this._depthState.func},set:function(e){this._depthState.func=e;}},{key:"depthWrite",get:function(){return this._depthState.write},set:function(e){this._depthState.write=e;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),uG=function(){function e(){this.cache=new Map;}var t=e.prototype;return t.destroy=function(){this.clear(),this.cache=null;},t.clear=function(){this.cache.forEach(function(e){e.forEach(function(e){e.destroy();});}),this.cache.clear();},t.getKey=function(e){return (1===e._type)+"-"+e._shadowType+"-"+e._shadowResolution},t.get=function(e,t){var n=this.getKey(t),i=this.cache.get(n);if(i&&i.length)return i.pop();var r=uD.create(e,t);return r.cached=true,r},t.add=function(e,t){var n=this.getKey(e),i=this.cache.get(n);i?i.push(t):this.cache.set(n,[t]);},e}();function uH(e,t){return (uH=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var uW=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i,r,s){var a;return (a=e.call(this,t)||this).requiresCubemaps=false,a.shadowRenderer=n,a.light=i,a.face=r,a.applyVsm=s,a.shadowCamera=n.prepareFace(i,null,r),n.setupRenderPass(a,a.shadowCamera,true),a}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&uH(t,e);var n=t.prototype;return n.execute=function(){this.shadowRenderer.renderFace(this.light,null,this.face,false);},n.after=function(){this.applyVsm&&this.shadowRenderer.renderVsm(this.light,this.shadowCamera);},t}(s2),uj=function(){function e(e,t){this.shadowLights=[],this.renderer=e,this.shadowRenderer=t,this.device=e.device;}var t=e.prototype;return t.cull=function(e,t,n){ void 0===n&&(n=null);var i=this.renderer.scene.clusteredLightingEnabled;e.visibleThisFrame=true,i||e._shadowMap||(e._shadowMap=uD.create(this.device,e));for(var r=e._type,s=2===r?1:6,a=0;a<s;a++){var o=e.getRenderData(null,a),l=o.shadowCamera;l.nearClip=e.attenuationEnd/1e3,l.farClip=e.attenuationEnd;var u=l._node,c=e._node;u.setPosition(c.getPosition()),2===r?(l.fov=2*e._outerConeAngle,u.setRotation(c.getRotation()),u.rotateLocal(-90,0,0)):1===r&&(i?l.fov=Math.atan(1+2/(this.shadowRenderer.lightTextureAtlas.shadowAtlasResolution*e.atlasViewport.z/3)*this.shadowRenderer.lightTextureAtlas.shadowEdgePixels)*ek.RAD_TO_DEG*2:l.fov=90),this.renderer.updateCameraFrustum(l),this.shadowRenderer.cullShadowCasters(t,e,o.visibleCasters,l,n);}},t.prepareLights=function(e,t){for(var n,i=0;i<t.length;i++){var r=t[i];if(this.shadowRenderer.needsShadowRendering(r)&&r.atlasViewportAllocated){e.push(r);for(var s=0;s<r.numShadowFaces;s++)n=this.shadowRenderer.prepareFace(r,null,s);}}return n},t.buildNonClusteredRenderPasses=function(e,t){for(var n=0;n<t.length;n++){var i=t[n];if(this.shadowRenderer.needsShadowRendering(i))for(var r=2===i._type,s=i.numShadowFaces,a=0;a<s;a++){var o=new uW(this.device,this.shadowRenderer,i,a,r);e.addRenderPass(o);}}},e}();function uX(e,t){return (uX=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var uY=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i,r,s){var a;return (a=e.call(this,t)||this).shadowRenderer=n,a.light=i,a.camera=r,a.allCascadesRendering=s,a}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&uX(t,e);var n=t.prototype;return n.execute=function(){for(var e=this.light,t=this.camera,n=this.shadowRenderer,i=this.allCascadesRendering,r=e.numShadowFaces,s=e.shadowUpdateOverrides,a=0;a<r;a++)(null==s?void 0:s[a])!==0&&n.renderFace(e,t,a,!i),(null==s?void 0:s[a])===1&&(s[a]=0);},n.after=function(){this.shadowRenderer.renderVsm(this.light,this.camera);},t}(s2),uq=new e8,uK=new eW,uZ=new e$,uQ=[new eW,new eW,new eW,new eW,new eW,new eW,new eW,new eW],uJ={min:0,max:0},u$=function(){function e(e,t){this.renderer=e,this.shadowRenderer=t,this.device=e.device;}var t=e.prototype;return t.cull=function(e,t,n,i){ void 0===i&&(i=null),e.visibleThisFrame=true,e._shadowMap||(e._shadowMap=uD.create(this.device,e));var r=n._nearClip;this.generateSplitDistances(e,r,Math.min(n._farClip,e.shadowDistance));for(var s=e.shadowUpdateOverrides,a=0;a<e.numCascades&&(null==s?void 0:s[a])!==0;a++){var o=e.getRenderData(n,a),l=o.shadowCamera;l.renderTarget=e._shadowMap.renderTargets[0],o.shadowViewport.copy(e.cascades[a]),o.shadowScissor.copy(e.cascades[a]);var u=l._node,c=e._node;u.setPosition(c.getPosition()),u.setRotation(c.getRotation()),u.rotateLocal(-90,0,0);var h=0===a?r:e._shadowCascadeDistances[a-1],f=e._shadowCascadeDistances[a],d=n.getFrustumCorners(h,f);uK.set(0,0,0);for(var p=n.node.getWorldTransform(),m=0;m<8;m++)p.transformPoint(d[m],d[m]),uK.add(d[m]);uK.mulScalar(1/8);for(var _=0,v=0;v<8;v++){var g=d[v].sub(uK).length();g>_&&(_=g);}var y=u.right,S=u.up,x=u.forward,b=.25*e._shadowResolution/_,T=Math.ceil(uK.dot(S)*b)/b,E=Math.ceil(uK.dot(y)*b)/b,w=S.mulScalar(T),A=y.mulScalar(E),C=uK.dot(x),P=x.mulScalar(C);uK.add2(w,A).add(P),u.setPosition(uK),u.translateLocal(0,0,1e6),l.nearClip=.01,l.farClip=2e6,l.orthoHeight=_,this.renderer.updateCameraFrustum(l),this.shadowRenderer.cullShadowCasters(t,e,o.visibleCasters,l,i);for(var I=1<<a,L=o.visibleCasters,D=L.length,M=0,R=0;R<D;R++){var O=L[R];O.shadowCascadeMask&I&&(L[M++]=O,1===M?uq.copy(O.aabb):uq.add(O.aabb));}D!==M&&(L.length=M),uZ.copy(u.getWorldTransform()).invert();var k=function(e,t,n){uQ[0].x=uQ[1].x=uQ[2].x=uQ[3].x=t.x,uQ[1].y=uQ[3].y=uQ[7].y=uQ[5].y=t.y,uQ[2].z=uQ[3].z=uQ[6].z=uQ[7].z=t.z,uQ[4].x=uQ[5].x=uQ[6].x=uQ[7].x=n.x,uQ[0].y=uQ[2].y=uQ[4].y=uQ[6].y=n.y,uQ[0].z=uQ[1].z=uQ[4].z=uQ[5].z=n.z;for(var i=0x2540be3ff,r=-9999999999,s=0;s<8;++s){e.transformPoint(uQ[s],uQ[s]);var a=uQ[s].z;a<i&&(i=a),a>r&&(r=a);}return uJ.min=i,uJ.max=r,uJ}(uZ,uq.getMin(),uq.getMax());u.translateLocal(0,0,k.max+.1),l.farClip=k.max-k.min+.2,o.projectionCompensation=_;}},t.generateSplitDistances=function(e,t,n){e._shadowCascadeDistances.fill(n);for(var i=1;i<e.numCascades;i++){var r=i/e.numCascades,s=t+(n-t)*r,a=t*Math.pow(n/t,r),o=ek.lerp(s,a,e.cascadeDistribution);e._shadowCascadeDistances[i-1]=o;}},t.getLightRenderPass=function(e,t){var n=null;if(this.shadowRenderer.needsShadowRendering(e)){for(var i,r=e.numShadowFaces,s=e.shadowUpdateOverrides,a=true,o=0;o<r;o++)(null==s?void 0:s[o])===0&&(a=false),i=this.shadowRenderer.prepareFace(e,t,o);n=new uY(this.device,this.shadowRenderer,e,t,a),this.shadowRenderer.setupRenderPass(n,i,a);}return n},e}(),u0=new Set,u1=new e$,u2=new e$,u3=new Float32Array(2),u4=new eY(1,1,0,0),u5=new e$,u8=function(){function e(e,t){this.shadowPassCache=[],this.device=e.device,this.renderer=e,this.lightTextureAtlas=t;var n=this.device.scope;this.sourceId=n.resolve("source"),this.pixelOffsetId=n.resolve("pixelOffset"),this.weightId=n.resolve("weight[0]"),this.blurVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=n.resolve("light_radius"),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this.blendStateWrite=new nj,this.blendStateNoWrite=new nj,this.blendStateNoWrite.setColorWrite(false,false,false,false);}var t=e.prototype;return t._cullShadowCastersInternal=function(e,t,n){for(var i=e.length,r=0;r<i;r++){var s=e[r];s.castShadow&&(!s.cull||s._isVisible(n))&&(s.visibleThisFrame=true,t.push(s));}},t.cullShadowCasters=function(e,t,n,i,r){var s,a;if(null==(s=this.renderer.scene)||s.fire(ok,i),n.length=0,r)this._cullShadowCastersInternal(r,n,i);else {for(var o=e.layerList,l=o.length,u=0;u<l;u++){var c=o[u];c._lightsSet.has(t)&&!u0.has(c)&&(u0.add(c),this._cullShadowCastersInternal(c.shadowCasters,n,i));}u0.clear();}n.sort(this.sortCompareShader),null==(a=this.renderer.scene)||a.fire(oN,i);},t.sortCompareShader=function(e,t){var n=e._sortKeyShadow,i=t._sortKeyShadow;return n===i?t.mesh.id-e.mesh.id:i-n},t.setupRenderState=function(e,t){var n=this.renderer.scene.clusteredLightingEnabled?t._isPcf:t._isPcf&&1!==t._type;e.setBlendState(n?this.blendStateNoWrite:this.blendStateWrite),e.setDepthState(t.shadowDepthState),e.setStencilState(null,null);},t.dispatchUniforms=function(e,t,n,i){var r=t._node;0!==e._type&&(this.renderer.dispatchViewPos(r.getPosition()),this.shadowMapLightRadiusId.setValue(e.attenuationEnd)),u1.setTRS(r.getPosition(),r.getRotation(),eW.ONE).invert(),u2.mul2(t.projectionMatrix,u1);var s=n.shadowViewport;t.rect=s,t.scissorRect=n.shadowScissor,u5.setViewport(s.x,s.y,s.z,s.w),n.shadowMatrix.mul2(u5,u2),0===e._type&&e._shadowMatrixPalette.set(n.shadowMatrix.data,16*i);},t.getShadowPass=function(e){var t,n=e._type,i=e._shadowType,r=null==(t=this.shadowPassCache[n])?void 0:t[i];return r||(r=oW.get(this.device).allocate("ShadowPass_"+n+"_"+i,{isShadow:true,lightType:n,shadowType:i}),this.shadowPassCache[n]||(this.shadowPassCache[n]=[]),this.shadowPassCache[n][i]=r),r.index},t.submitCasters=function(e,t,n){for(var i=this.device,r=this.renderer,s=r.scene,a=this.getShadowPass(t),o=n.shaderParams,l=n.renderTarget.flipY?-1:1,u=e.length,c=0;c<u;c++){var h,f=e[c],d=f.mesh,p=f.instancingData;if(!p||!(p.count<=0)){f.ensureMaterial(i);var m=f.material;r.setBaseConstants(i,m),r.setSkinning(i,f),m.dirty&&(m.updateUniforms(i,s),m.dirty=false),r.setupCullMode(true,l,f),m.setParameters(i),f.setParameters(i,4);var _=f.getShaderInstance(a,0,s,o,this.viewUniformFormat,this.viewBindGroupFormat),v=_.shader;if(!v.failed){f._sortKeyShadow=v.id,i.setShader(v),r.setVertexBuffers(i,d),r.setMorphing(i,f.morphInstance),p&&i.setVertexBuffer(p.vertexBuffer),r.setMeshInstanceMatrices(f),r.setupMeshUniformBuffers(_);var g=f.renderStyle,y=null==(h=f.indirectData)?void 0:h.get(n);i.draw(d.primitive[g],d.indexBuffer[g],null==p?void 0:p.count,y),r._shadowDrawCalls++,p&&r._instancedDrawCalls++;}}}},t.needsShadowRendering=function(e){var t=e.enabled&&e.castShadows&&0!==e.shadowUpdateMode&&e.visibleThisFrame;return 1===e.shadowUpdateMode&&(e.shadowUpdateMode=0),t&&(this.renderer._shadowMapUpdates+=e.numShadowFaces),t},t.getLightRenderData=function(e,t,n){return e.getRenderData(0===e._type?t:null,n)},t.setupRenderPass=function(e,t,n){var i=t.renderTarget;e.init(i),e.depthStencilOps.clearDepthValue=1,e.depthStencilOps.clearDepth=n,i.depthBuffer?e.depthStencilOps.storeDepth=true:(e.colorOps.clearValue.copy(t.clearColor),e.colorOps.clear=n,e.depthStencilOps.storeDepth=false),e.requiresCubemaps=false;},t.prepareFace=function(e,t,n){var i=e._type,r=this.getLightRenderData(e,t,n).shadowCamera,s=0===i?0:n;return r.renderTarget=e._shadowMap.renderTargets[s],r},t.renderFace=function(e,t,n,i,r){ void 0===r&&(r=true);var s=this.device,a=this.getLightRenderData(e,t,n),o=a.shadowCamera;this.dispatchUniforms(e,o,a,n);var l=o.renderTarget,u=this.renderer;u.setCameraUniforms(o,l),s.supportsUniformBuffers&&u.setupViewUniformBuffers(a.viewBindGroups,this.viewUniformFormat,this.viewBindGroupFormat,null),r?(u.setupViewport(o,l),i&&u.clear(o)):u.clearView(o,l,true,false),this.setupRenderState(s,e),this.submitCasters(a.visibleCasters,e,o);},t.render=function(e,t,n){if(void 0===n&&(n=true),this.needsShadowRendering(e)){for(var i=e.numShadowFaces,r=0;r<i;r++)this.prepareFace(e,t,r),this.renderFace(e,t,r,true,n);this.renderVsm(e,t);}},t.renderVsm=function(e,t){e._isVsm&&e._vsmBlurSize>1&&(this.renderer.scene.clusteredLightingEnabled&&0!==e._type||this.applyVsmBlur(e,t));},t.getVsmBlurShader=function(e,t){var n=this.blurVsmShader,i=n[e][t];if(!i){this.blurVsmWeights[t]=function(e){for(var t,n=(e-1)/6,i=(e-1)*.5,r=Array(e),s=0,a=0;a<e;++a)r[a]=Math.exp(-((t=a-i)*t)/(2*n*n)),s+=r[a];for(var o=0;o<e;++o)r[o]/=s;return r}(t);var r=new Map;r.set("{SAMPLES}",t),1===e&&r.set("GAUSS",""),i=o8.createShader(this.device,{uniqueName:"blurVsm"+e+t,attributes:{vertex_position:tT},vertexChunk:"fullscreenQuadVS",fragmentChunk:"blurVSMPS",fragmentDefines:r}),n[e][t]=i;}return i},t.applyVsmBlur=function(e,t){var n=this.device;n.setBlendState(nj.NOBLEND);var i=e.getRenderData(0===e._type?t:null,0).shadowCamera.renderTarget,r=this.renderer.shadowMapCache.get(n,e),s=r.renderTargets[0],a=e.vsmBlurMode,o=e._vsmBlurSize,l=this.getVsmBlurShader(a,o);u4.z=e._shadowResolution-2,u4.w=u4.z,this.sourceId.setValue(i.colorBuffer),u3[0]=1/e._shadowResolution,u3[1]=0,this.pixelOffsetId.setValue(u3),1===a&&this.weightId.setValue(this.blurVsmWeights[o]),ls(n,s,l,null,u4),this.sourceId.setValue(s.colorBuffer),u3[1]=u3[0],u3[0]=0,this.pixelOffsetId.setValue(u3),ls(n,i,l,null,u4),this.renderer.shadowMapCache.add(e,r);},t.initViewBindGroupFormat=function(){this.device.supportsUniformBuffers&&!this.viewUniformFormat&&(this.viewUniformFormat=new iZ(this.device,[new iK("matrix_viewProjection",14)]),this.viewBindGroupFormat=new nL(this.device,[new nA(nd,3)]));},t.frameUpdate=function(){this.initViewBindGroupFormat();},e.createShadowCamera=function(e,t,n){var i,r,s=uu.create("ShadowCamera",t,n),a=ol.get(e),o=null!=(i=null==a?void 0:a.vsm)&&i,l=null!=(r=null==a?void 0:a.pcf)&&r;return o?s.clearColor=new eN(0,0,0,0):s.clearColor=new eN(1,1,1,1),s.clearDepthBuffer=true,s.clearStencilBuffer=false,s.clearColorBuffer=!l,s},e}(),u6=[],u9=function(){function e(e){this._empty=null,this._allocated=[],this._clusters=new Map,this.device=e;}var t,n=e.prototype;return n.destroy=function(){this._empty&&(this._empty.destroy(),this._empty=null),this._allocated.forEach(function(e){e.destroy();}),this._allocated.length=0;},n.assign=function(e){u6.push.apply(u6,[].concat(this._allocated)),this._allocated.length=0,this._clusters.clear();for(var t=e.length,n=0;n<t;n++){var i=e[n].renderActions;if(i)for(var r=i.length,s=0;s<r;s++){var a=i[s];a.lightClusters=null;var o=a.layer;if(o.hasClusteredLights&&o.meshInstances.length){var l,u=o.getLightIdHash(),c=this._clusters.get(u),h=null==c?void 0:c.lightClusters;h||(h=null!=(l=u6.pop())?l:new uT(this.device),this._allocated.push(h),this._clusters.set(u,a)),a.lightClusters=h;}a.lightClusters||(a.lightClusters=this.empty);}}u6.forEach(function(e){return e.destroy()}),u6.length=0;},n.update=function(e,t){this.assign(e),this._clusters.forEach(function(e){var n=e.layer;e.lightClusters.update(n.clusteredLightsSet,t);});},t=[{key:"count",get:function(){return this._allocated.length}},{key:"empty",get:function(){if(!this._empty){var e=new uT(this.device);e.name="ClusterEmpty",e.update([]),this._empty=e;}return this._empty}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function u7(e,t){return (u7=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ce=new eY,ct=[],cn=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t)||this)._quadRenderer2D=null,i._quadRendererCube=null,i._filteredLights=[],i._forceCopy=false,i._evtDeviceRestored=null,i._cubeSlotsOffsets=n,i.requiresCubemaps=false,i.blitTextureId=t.scope.resolve("blitTexture"),i.invViewProjId=t.scope.resolve("invViewProj"),i._evtDeviceRestored=t.on("devicerestored",i.onDeviceRestored,i),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&u7(t,e);var n,i=t.prototype;return i.destroy=function(){var e,t,n;null==(e=this._quadRenderer2D)||e.destroy(),this._quadRenderer2D=null,null==(t=this._quadRendererCube)||t.destroy(),this._quadRendererCube=null,null==(n=this._evtDeviceRestored)||n.off(),this._evtDeviceRestored=null;},i.onDeviceRestored=function(){this._forceCopy=true;},i.update=function(e){var t=this._filteredLights;this.filter(e,t),this.executeEnabled=t.length>0;},i.filter=function(e,t){for(var n=0;n<e.length;n++){var i=e[n];0!==i._type&&i.atlasViewportAllocated&&(i.atlasSlotUpdated||this._forceCopy)&&i.enabled&&i.cookie&&i.visibleThisFrame&&t.push(i);}this._forceCopy=false;},i.initInvViewProjMatrices=function(){if(!ct.length)for(var e=0;e<6;e++){var t=uu.create(null,1,e),n=t.projectionMatrix,i=t.node.getLocalTransform().clone().invert();ct[e]=new e$().mul2(n,i).invert();}},i.execute=function(){var e=this.device;e.setBlendState(nj.NOBLEND),e.setCullMode(0),e.setDepthState(nq.NODEPTH),e.setStencilState();for(var t=this.renderTarget.colorBuffer.width,n=this._cubeSlotsOffsets,i=this._filteredLights,r=0;r<i.length;r++){var s=i[r],a=s.numShadowFaces,o=a>1?this.quadRendererCube:this.quadRenderer2D;a>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(s.cookie);for(var l=0;l<a;l++){if(ce.copy(s.atlasViewport),a>1){var u=ce.z/3,c=n[l];ce.x+=u*c.x,ce.y+=u*c.y,ce.z=u,ce.w=u,this.invViewProjId.setValue(ct[l].data);}ce.mulScalar(t),o.render(ce);}}i.length=0;},t.create=function(e,n){var i=new t(e.device,n);return i.init(e),i.colorOps.clear=false,i.depthStencilOps.clearDepth=false,i},n=[{key:"quadRenderer2D",get:function(){if(!this._quadRenderer2D){var e=o8.createShader(this.device,{uniqueName:"cookieRenderer2d",attributes:{vertex_position:tT},vertexChunk:"cookieBlitVS",fragmentChunk:"cookieBlit2DPS"});this._quadRenderer2D=new lt(e);}return this._quadRenderer2D}},{key:"quadRendererCube",get:function(){if(!this._quadRendererCube){var e=o8.createShader(this.device,{uniqueName:"cookieRendererCube",attributes:{vertex_position:tT},vertexChunk:"cookieBlitVS",fragmentChunk:"cookieBlitCubePS"});this._quadRendererCube=new lt(e);}return this._quadRendererCube}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(s2);function ci(e,t){return (ci=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var cr=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i){var r;return (r=e.call(this,t)||this).requiresCubemaps=false,r.shadowRenderer=n,r.shadowRendererLocal=i,r}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&ci(t,e);var n=t.prototype;return n.update=function(e){var t=this.shadowRendererLocal.shadowLights,n=this.shadowRendererLocal.prepareLights(t,e),i=t.length;this.enabled=i>0,i&&this.shadowRenderer.setupRenderPass(this,n,false);},n.execute=function(){for(var e=this.shadowRendererLocal.shadowLights,t=e.length,n=0;n<t;n++)for(var i=e[n],r=0;r<i.numShadowFaces;r++)this.shadowRenderer.renderFace(i,null,r,true);e.length=0;},t}(s2);function cs(e,t){return (cs=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ca=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i,r,s){var a;return (a=e.call(this,t)||this).renderer=n,a.frameGraph=null,a.cookiesRenderPass=cn.create(s.cookieRenderTarget,s.cubeSlotsOffsets),a.beforePasses.push(a.cookiesRenderPass),a.shadowRenderPass=new cr(t,i,r),a.beforePasses.push(a.shadowRenderPass),a}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&cs(t,e);var n=t.prototype;return n.update=function(e,t,n,i,r){this.frameGraph=e,this.cookiesRenderPass.enabled=n,n&&this.cookiesRenderPass.update(i),this.shadowRenderPass.enabled=t,t&&this.shadowRenderPass.update(r);},n.destroy=function(){this.cookiesRenderPass.destroy(),this.cookiesRenderPass=null;},n.execute=function(){var e=this.renderer,t=e.scene;e.worldClustersAllocator.update(this.frameGraph.renderPasses,t.lighting);},t}(s2);function co(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function cl(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return co(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return co(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var cu=0,cc=new e$,ch=new e$,cf=new e$,cd=new ej,cp=new e7,cm=new e$().setScale(1,-1,1),c_=new Set,cv=new Set,cg=new nz,cy=new e$().set([1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1]),cS=[new eX(.5,.333333),new eX(.25,.666667),new eX(.75,.111111),new eX(.125,.444444),new eX(.625,.777778),new eX(.375,.222222),new eX(.875,.555556),new eX(.0625,.888889),new eX(.5625,.037037),new eX(.3125,.37037),new eX(.8125,.703704),new eX(.1875,.148148),new eX(.6875,.481481),new eX(.4375,.814815),new eX(.9375,.259259),new eX(.03125,.592593)],cx=new e$,cb=new e$,cT=new e$,cE=new e$,cw=new e$,cA=new e$,cC=new Set,cP=[],cI=[],cL=function(){function e(e,t){this.clustersDebugRendered=false,this.processingMeshInstances=new Set,this.lights=[],this.localLights=[],this.cameraDirShadowLights=new Map,this.dirLightShadows=new Map,this.blueNoise=new uA(123),this.gsplatDirector=null,this.device=e,this.scene=t,this.worldClustersAllocator=new u9(e),this.lightTextureAtlas=new uF(e),this.shadowMapCache=new uG,this.shadowRenderer=new u8(this,this.lightTextureAtlas),this._shadowRendererLocal=new uj(this,this.shadowRenderer),this._shadowRendererDirectional=new u$(this,this.shadowRenderer),this.scene.clusteredLightingEnabled&&(this._renderPassUpdateClustered=new ca(this.device,this,this.shadowRenderer,this._shadowRendererLocal,this.lightTextureAtlas)),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this._skinTime=0,this._morphTime=0,this._cullTime=0,this._shadowMapTime=0,this._lightClustersTime=0,this._layerCompositionUpdateTime=0,this._shadowDrawCalls=0,this._skinDrawCalls=0,this._instancedDrawCalls=0,this._shadowMapUpdates=0,this._numDrawCallsCulled=0,this._camerasRendered=0,this._lightClusters=0;var n=e.scope;this.boneTextureId=n.resolve("texture_poseMap"),this.modelMatrixId=n.resolve("matrix_model"),this.normalMatrixId=n.resolve("matrix_normal"),this.viewInvId=n.resolve("matrix_viewInverse"),this.viewPos=new Float32Array(3),this.viewPosId=n.resolve("view_position"),this.projId=n.resolve("matrix_projection"),this.projSkyboxId=n.resolve("matrix_projectionSkybox"),this.viewId=n.resolve("matrix_view"),this.viewId3=n.resolve("matrix_view3"),this.viewProjId=n.resolve("matrix_viewProjection"),this.flipYId=n.resolve("projectionFlipY"),this.tbnBasis=n.resolve("tbnBasis"),this.nearClipId=n.resolve("camera_near"),this.farClipId=n.resolve("camera_far"),this.cameraParams=new Float32Array(4),this.cameraParamsId=n.resolve("camera_params"),this.viewIndexId=n.resolve("view_index"),this.viewIndexId.setValue(0),this.blueNoiseJitterVersion=0,this.blueNoiseJitterVec=new eY,this.blueNoiseJitterData=new Float32Array(4),this.blueNoiseJitterId=n.resolve("blueNoiseJitter"),this.blueNoiseTextureId=n.resolve("blueNoiseTex32"),this.alphaTestId=n.resolve("alpha_ref"),this.opacityMapId=n.resolve("texture_opacityMap"),this.exposureId=n.resolve("exposure"),this.twoSidedLightingNegScaleFactorId=n.resolve("twoSidedLightingNegScaleFactor"),this.twoSidedLightingNegScaleFactorId.setValue(0),this.morphPositionTex=n.resolve("morphPositionTex"),this.morphNormalTex=n.resolve("morphNormalTex"),this.morphTexParams=n.resolve("morph_tex_params"),this.lightCube=new uP,this.constantLightCube=n.resolve("lightCube[0]");}var t=e.prototype;return t.destroy=function(){var e;this.shadowRenderer=null,this._shadowRendererLocal=null,this._shadowRendererDirectional=null,this.shadowMapCache.destroy(),this.shadowMapCache=null,null==(e=this._renderPassUpdateClustered)||e.destroy(),this._renderPassUpdateClustered=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null;},t.setupViewport=function(e,t){var n=this.device,i=t?t.width:n.width,r=t?t.height:n.height,s=e.rect,a=Math.floor(s.x*i),o=Math.floor(s.y*r),l=Math.floor(s.z*i),u=Math.floor(s.w*r);if(n.setViewport(a,o,l,u),e._scissorRectClear){var c=e.scissorRect;a=Math.floor(c.x*i),o=Math.floor(c.y*r),l=Math.floor(c.z*i),u=Math.floor(c.w*r);}n.setScissor(a,o,l,u);},t.setCameraUniforms=function(e,t){var n=null==t?void 0:t.flipY,i=null;if(e.xr&&e.xr.session){var r,s,a=(null==(s=e._node)||null==(r=s.parent)?void 0:r.getWorldTransform())||null;i=e.xr.views.list;for(var o=0;o<i.length;o++){var l=i[o];l.updateTransforms(a),e.frustum.setFromMat4(l.projViewOffMat);}}else {var u=e.projectionMatrix;e.calculateProjection&&e.calculateProjection(u,0);var c=e.getProjectionMatrixSkybox();n&&(u=cx.mul2(cm,u),c=cb.mul2(cm,c)),this.device.isWebGPU&&(u=cT.mul2(cy,u),c=cE.mul2(cy,c));var h=e.jitter,f=0,d=0;if(h>0){var p=t?t.width:this.device.width,m=t?t.height:this.device.height,_=cS[this.device.renderVersion%cS.length];f=h*(2*_.x-1)/p,d=h*(2*_.y-1)/m,(u=cw.copy(u)).data[8]=f,u.data[9]=d,(c=cA.copy(c)).data[8]=f,c.data[9]=d,this.blueNoiseJitterVersion!==this.device.renderVersion&&(this.blueNoiseJitterVersion=this.device.renderVersion,this.blueNoise.vec4(this.blueNoiseJitterVec));}var v=h>0?this.blueNoiseJitterVec:eY.ZERO;if(this.blueNoiseJitterData[0]=v.x,this.blueNoiseJitterData[1]=v.y,this.blueNoiseJitterData[2]=v.z,this.blueNoiseJitterData[3]=v.w,this.blueNoiseJitterId.setValue(this.blueNoiseJitterData),this.projId.setValue(u.data),this.projSkyboxId.setValue(c.data),e.calculateTransform)e.calculateTransform(ch,0);else {var g=e._node.getPosition(),y=e._node.getRotation();ch.setTRS(g,y,eW.ONE);}this.viewInvId.setValue(ch.data),cf.copy(ch).invert(),this.viewId.setValue(cf.data),cd.setFromMat4(cf),this.viewId3.setValue(cd.data),cc.mul2(u,cf),this.viewProjId.setValue(cc.data),e._storeShaderMatrices(cc,f,d,this.device.renderVersion),this.flipYId.setValue(n?-1:1),this.dispatchViewPos(e._node.getPosition()),e.frustum.setFromMat4(cc);}this.tbnBasis.setValue(n?-1:1);var S=e._nearClip,x=e._farClip;return this.nearClipId.setValue(S),this.farClipId.setValue(x),this.cameraParams[0]=1/x,this.cameraParams[1]=x,this.cameraParams[2]=S,this.cameraParams[3]=+(1===e.projection),this.cameraParamsId.setValue(this.cameraParams),this.exposureId.setValue(this.scene.physicalUnits?e.getExposure():this.scene.exposure),i},t.clear=function(e,t,n,i){var r=(null!=t?!!t:!!e._clearColorBuffer)|2*(null!=n?!!n:!!e._clearDepthBuffer)|4*(null!=i?!!i:!!e._clearStencilBuffer);r&&this.device.clear({color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,stencil:e._clearStencil,flags:r});},t.setCamera=function(e,t,n,i){this.setCameraUniforms(e,t),this.clearView(e,t,n,false);},t.clearView=function(e,t,n,i){var r=this.device;if(r.setRenderTarget(t),r.updateBegin(),i&&(r.setColorWrite(true,true,true,true),r.setDepthWrite(true)),this.setupViewport(e,t),n){var s=e._clearOptions;r.clear(s||{color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,flags:!!e._clearColorBuffer|2*!!e._clearDepthBuffer|4*!!e._clearStencilBuffer,stencil:e._clearStencil});}},t.setupCullMode=function(e,t,n){var i=n.material,r=0;if(e){var s=1;(2===i.cull||1===i.cull)&&(s=t*n.flipFacesFactor*n.node.worldScaleSign),r=s<0?2===i.cull?1:2:i.cull;}this.device.setCullMode(r),0===r&&0===i.cull&&this.twoSidedLightingNegScaleFactorId.setValue(n.node.worldScaleSign);},t.updateCameraFrustum=function(e){if(e.xr&&e.xr.views.list.length){var t=e.xr.views.list[0];cc.mul2(t.projMat,t.viewOffMat),e.frustum.setFromMat4(cc);return}var n=e.projectionMatrix;if(e.calculateProjection&&e.calculateProjection(n,0),e.calculateTransform)e.calculateTransform(ch,0);else {var i=e._node.getPosition(),r=e._node.getRotation();ch.setTRS(i,r,eW.ONE),this.viewInvId.setValue(ch.data);}cf.copy(ch).invert(),cc.mul2(n,cf),e.frustum.setFromMat4(cc);},t.setBaseConstants=function(e,t){e.setCullMode(t.cull),t.opacityMap&&this.opacityMapId.setValue(t.opacityMap),(t.opacityMap||t.alphaTest>0)&&this.alphaTestId.setValue(t.alphaTest);},t.updateCpuSkinMatrices=function(e){cu++;var t=e.length;if(0!==t)for(var n=0;n<t;n++){var i=e[n].skinInstance;i&&(i.updateMatrices(e[n].node,cu),i._dirty=true);}},t.updateGpuSkinMatrices=function(e){for(var t,n=cl(e);!(t=n()).done;){var i=t.value,r=i.skinInstance;r&&r._dirty&&(r.updateMatrixPalette(i.node,cu),r._dirty=false);}},t.updateMorphing=function(e){for(var t,n=cl(e);!(t=n()).done;){var i=t.value.morphInstance;i&&i._dirty&&i.update();}},t.updateGSplats=function(e){for(var t,n,i=cl(e);!(n=i()).done;)null==(t=n.value.gsplatInstance)||t.update();},t.gpuUpdate=function(e){this.updateGpuSkinMatrices(e),this.updateMorphing(e),this.updateGSplats(e);},t.setVertexBuffers=function(e,t){e.setVertexBuffer(t.vertexBuffer);},t.setMorphing=function(e,t){t&&(t.prepareRendering(e),e.setVertexBuffer(t.morph.vertexBufferIds),this.morphPositionTex.setValue(t.texturePositions),this.morphNormalTex.setValue(t.textureNormals),this.morphTexParams.setValue(t._textureParams));},t.setSkinning=function(e,t){var n=t.skinInstance;if(n){this._skinDrawCalls++;var i=n.boneTexture;this.boneTextureId.setValue(i);}},t.dispatchViewPos=function(e){var t=this.viewPos;t[0]=e.x,t[1]=e.y,t[2]=e.z,this.viewPosId.setValue(t);},t.initViewBindGroupFormat=function(e){if(this.device.supportsUniformBuffers&&!this.viewUniformFormat){var t=[new iK("matrix_view",14),new iK("matrix_viewInverse",14),new iK("matrix_projection",14),new iK("matrix_projectionSkybox",14),new iK("matrix_viewProjection",14),new iK("matrix_view3",13),new iK("cubeMapRotationMatrix",13),new iK("view_position",4),new iK("skyboxIntensity",2),new iK("exposure",2),new iK("textureBias",2),new iK("view_index",2)];e&&t.push.apply(t,[new iK("clusterCellsCountByBoundsSize",4),new iK("clusterTextureSize",4),new iK("clusterBoundsMin",4),new iK("clusterBoundsDelta",4),new iK("clusterCellsDot",4),new iK("clusterCellsMax",4),new iK("shadowAtlasParams",3),new iK("clusterMaxCells",1),new iK("clusterSkip",2)]),this.viewUniformFormat=new iZ(this.device,t);var n=[new nA(nd,3)];this.viewBindGroupFormat=new nL(this.device,n);}},t.setupViewUniforms=function(e,t){this.projId.setValue(e.projMat.data),this.projSkyboxId.setValue(e.projMat.data),this.viewId.setValue(e.viewOffMat.data),this.viewInvId.setValue(e.viewInvOffMat.data),this.viewId3.setValue(e.viewMat3.data),this.viewProjId.setValue(e.projViewOffMat.data),this.viewPosId.setValue(e.positionData),this.viewIndexId.setValue(t);},t.setupViewUniformBuffers=function(e,t,n,i){for(var r,s=this.device,a=null!=(r=null==i?void 0:i.length)?r:1;e.length<a;){var o=new r4(s,t,false),l=new nV(s,n,o);e.push(l);}if(i)for(var u=0;u<a;u++){var c=i[u];this.setupViewUniforms(c,u);var h=e[u];h.defaultUniformBuffer.update(),h.update();}else {var f=e[0];f.defaultUniformBuffer.update(),f.update();}i||s.setBindGroup(0,e[0]);},t.setupMeshUniformBuffers=function(e){var t=this.device;if(t.supportsUniformBuffers){var n=e.getBindGroup(t);n.update(),t.setBindGroup(1,n),e.getUniformBuffer(t).update(cg),t.setBindGroup(2,cg.bindGroup,cg.offsets);}},t.setMeshInstanceMatrices=function(e,t){ void 0===t&&(t=false);var n=e.node.worldTransform;this.modelMatrixId.setValue(n.data),t&&this.normalMatrixId.setValue(e.node.normalMatrix.data);},t.cull=function(e,t,n){var i=n.opaque;i.length=0;var r=n.transparent;r.length=0;for(var s=e.frustumCulling,a=t.length,o=0;o<a;o++){var l=t[o];l.visible&&(!s||!l.cull||l._isVisible(e))&&(l.visibleThisFrame=true,(l.transparent?r:i).push(l),(l.skinInstance||l.morphInstance||l.gsplatInstance)&&(this.processingMeshInstances.add(l),l.gsplatInstance&&l.gsplatInstance.cameras.push(e)));}},t.collectLights=function(e){this.lights.length=0,this.localLights.length=0;for(var t=this.scene._stats,n=e.layerList.length,i=0;i<n;i++){var r=e.layerList[i];if(!cv.has(r)){cv.add(r);for(var s=r._lights,a=0;a<s.length;a++){var o=s[a];c_.has(o)||(c_.add(o),this.lights.push(o),0!==o._type&&this.localLights.push(o));}}}t.lights=this.lights.length,c_.clear(),cv.clear();},t.cullLights=function(e,t){for(var n=this.scene.clusteredLightingEnabled,i=this.scene.physicalUnits,r=0;r<t.length;r++){var s=t[r];if(s.enabled)if(0!==s._type)if(s.getBoundingSphere(cp),e.frustum.containsSphere(cp)){s.visibleThisFrame=true,s.usePhysicalUnits=i;var a=e.getScreenSize(cp);s.maxScreenSize=Math.max(s.maxScreenSize,a);}else n||!s.castShadows||s.shadowMap||(s.visibleThisFrame=true);else s.usePhysicalUnits=this.scene.physicalUnits;}},t.cullShadowmaps=function(e){for(var t=this.scene.clusteredLightingEnabled,n=0;n<this.localLights.length;n++){var i=this.localLights[n];0!==i._type&&(t?i.atlasSlotUpdated&&0===i.shadowUpdateMode&&(i.shadowUpdateMode=1):0===i.shadowUpdateMode&&i.castShadows&&!i.getRenderData(null,0).shadowCamera.renderTarget&&(i.shadowUpdateMode=1),i.visibleThisFrame&&i.castShadows&&0!==i.shadowUpdateMode&&this._shadowRendererLocal.cull(i,e));}this.cameraDirShadowLights.clear();for(var r=e.cameras,s=0;s<r.length;s++){var a=r[s];if(a.enabled){for(var o=a.camera,l=void 0,u=o.layers,c=0;c<u.length;c++){var h=e.getLayerById(u[c]);if(h)for(var f=h.splitLights[0],d=0;d<f.length;d++){var p=f[d];p.castShadows&&!cC.has(p)&&(cC.add(p),(l=null!=l?l:[]).push(p),this._shadowRendererDirectional.cull(p,e,o));}}l&&this.cameraDirShadowLights.set(o,l),cC.clear();}}},t.cullComposition=function(e){var t=this.scene;this.processingMeshInstances.clear();var n=e.cameras.length;this._camerasRendered+=n;for(var i=0;i<n;i++){var r=e.cameras[i];null==t||t.fire(ok,r);var s=r.renderTarget;r.frameUpdate(s),this.updateCameraFrustum(r.camera);for(var a=r.layers,o=0;o<a.length;o++){var l=e.getLayerById(a[o]);if(l&&l.enabled){this.cullLights(r.camera,l._lights);var u=l.getCulledInstances(r.camera);this.cull(r.camera,l.meshInstances,u);}}null==t||t.fire(oN,r);}t.clusteredLightingEnabled&&this.updateLightTextureAtlas(),this.cullShadowmaps(e),null==t||t.fire(oF);},t.updateShaders=function(e,t){for(var n=e.length,i=0;i<n;i++){var r=e[i].material;if(r&&!cC.has(r)&&(cC.add(r),r.getShaderVariant!==uV.prototype.getShaderVariant)){if(t&&(!r.useLighting||r.emitter&&!r.emitter.lighting))continue;r.clearVariants();}}cC.clear();},t.updateFrameUniforms=function(){var e;this.blueNoiseTextureId.setValue((e=this.device,uL.get(e,function(){var t=(uw(),uE);return uI(e,"BlueNoise",Math.sqrt(t.length/4),t)})));},t.beginFrame=function(e){for(var t=this.scene,n=t.updateShaders||this.device._shadersDirty,i=e.layerList,r=i.length,s=0;s<r;s++)for(var a=i[s].meshInstances,o=a.length,l=0;l<o;l++){var u=a[l];u.visibleThisFrame=false,n&&cP.push(u),u.skinInstance&&cI.push(u);}if(n){var c=!t.updateShaders||!this.device._shadersDirty;this.updateShaders(cP,c),t.updateShaders=false,this.device._shadersDirty=false,t._shaderVersion++;}this.updateFrameUniforms(),this.updateCpuSkinMatrices(cI),cP.length=0,cI.length=0;for(var h=this.lights,f=h.length,d=0;d<f;d++)h[d].beginFrame();},t.updateLightTextureAtlas=function(){this.lightTextureAtlas.update(this.localLights,this.scene.lighting);},t.updateLayerComposition=function(e){for(var t=e.layerList.length,n=this.scene._shaderVersion,i=0;i<t;i++)e.layerList[i]._shaderVersion=n;e._update();},t.frameUpdate=function(){this.clustersDebugRendered=false,this.initViewBindGroupFormat(this.scene.clusteredLightingEnabled),this.dirLightShadows.clear();},e}(),cD=function(){function e(){this.camera=null,this.layer=null,this.transparent=false,this.renderTarget=null,this.lightClusters=null,this.clearColor=false,this.clearDepth=false,this.clearStencil=false,this.triggerPostprocess=false,this.firstCameraUse=false,this.lastCameraUse=false,this.viewBindGroups=[],this.useCameraPasses=false;}var t=e.prototype;return t.destroy=function(){this.viewBindGroups.forEach(function(e){e.defaultUniformBuffer.destroy(),e.destroy();}),this.viewBindGroups.length=0;},t.setupClears=function(e,t){this.clearColor=(null==e?void 0:e.clearColorBuffer)||t.clearColorBuffer,this.clearDepth=(null==e?void 0:e.clearDepthBuffer)||t.clearDepthBuffer,this.clearStencil=(null==e?void 0:e.clearStencilBuffer)||t.clearStencilBuffer;},e}();function cM(e,t){return (cM=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var cR=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i,r){var s;return (s=e.call(this,t)||this).renderActions=[],s.noDepthClear=false,s.layerComposition=n,s.scene=i,s.renderer=r,s}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&cM(t,e);var n,i=t.prototype;return i.addRenderAction=function(e){this.renderActions.push(e);},i.addLayer=function(e,t,n,i){ void 0===i&&(i=true);var r=new cD;if(r.renderTarget=this.renderTarget,r.camera=e,r.layer=t,r.transparent=n,i){var s=0===this.renderActions.length;r.setupClears(s?e:void 0,t);}this.addRenderAction(r);},i.addLayers=function(e,t,n,i,r,s){ void 0===s&&(s=true);for(var a=e.layerList,o=e.subLayerList,l=i,u=n;u<a.length;){var c=a[u],h=o[u];if(t.camera.layersSet.has(c.id)&&(this.addLayer(t,c,h,l),l=false),u++,c.id===r&&h===s)break}return u},i.updateDirectionalShadows=function(){for(var e=this.renderer,t=this.renderActions,n=0;n<t.length;n++){var i=t[n].camera.camera,r=this.renderer.cameraDirShadowLights.get(i);if(r)for(var s=0;s<r.length;s++){var a=r[s];if(e.dirLightShadows.get(a)!==i){e.dirLightShadows.set(a,i);var o=e._shadowRendererDirectional.getLightRenderPass(a,i);o&&this.beforePasses.push(o);}}}},i.updateClears=function(){var e=this.renderActions[0];if(e){var t=e.camera.camera,n=t.fullSizeClearRect;this.setClearColor(n&&e.clearColor?t.clearColor:void 0),this.setClearDepth(n&&e.clearDepth&&!this.noDepthClear?t.clearDepth:void 0),this.setClearStencil(n&&e.clearStencil?t.clearStencil:void 0);}},i.frameUpdate=function(){e.prototype.frameUpdate.call(this),this.updateDirectionalShadows(),this.updateClears();},i.before=function(){for(var e=this.renderActions,t=0;t<e.length;t++){var n=e[t];n.firstCameraUse&&this.scene.fire(oD,n.camera);}},i.execute=function(){for(var e=this.layerComposition,t=this.renderActions,n=0;n<t.length;n++){var i=t[n],r=i.layer;e.isEnabled(r,i.transparent)&&this.renderRenderAction(i,0===n);}},i.after=function(){for(var e=0;e<this.renderActions.length;e++){var t=this.renderActions[e];t.lastCameraUse&&this.scene.fire(oM,t.camera);}this.beforePasses.length=0;},i.renderRenderAction=function(e,t){var n=this.renderer,i=this.scene,r=n.device,s=e.layer,a=e.transparent,o=e.camera;if(o){var l,u,c,h=o.gammaCorrection,f=o.toneMapping;void 0!==this.gammaCorrection&&(o.gammaCorrection=this.gammaCorrection),void 0!==this.toneMapping&&(o.toneMapping=this.toneMapping),i.fire(oR,o,s,a);var d={lightClusters:e.lightClusters},p=null!=(u=null==(l=o.camera.shaderPassInfo)?void 0:l.index)?u:0;t&&o.camera.fullSizeClearRect||(d.clearColor=e.clearColor,d.clearDepth=e.clearDepth,d.clearStencil=e.clearStencil);var m=null!=(c=e.renderTarget)?c:r.backBuffer;n.renderForwardLayer(o.camera,m,s,a,p,e.viewBindGroups,d),r.setBlendState(nj.NOBLEND),r.setStencilState(null,null),r.setAlphaToCoverage(false),i.fire(oO,o,s,a),void 0!==this.gammaCorrection&&(o.gammaCorrection=h),void 0!==this.toneMapping&&(o.toneMapping=f);}},n=[{key:"rendersAnything",get:function(){return this.renderActions.length>0}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(s2);function cO(e,t){return (cO=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ck=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i){var r;return (r=e.call(this,t)||this).renderer=n,r.renderAction=i,r.requiresCubemaps=false,r}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&cO(t,e),t.prototype.execute=function(){this.renderAction.camera.onPostprocessing();},t}(s2);function cN(e,t){return (cN=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var cF=[[],[],[]],cB=new eN,cU={drawCalls:[],shaderInstances:[],isNewMaterial:[],lightMaskChanged:[],clear:function(){this.drawCalls.length=0,this.shaderInstances.length=0,this.isNewMaterial.length=0,this.lightMaskChanged.length=0;}},cz=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i=e.call(this,t,n)||this,r=i.device;i._forwardDrawCalls=0,i._materialSwitches=0,i._depthMapTime=0,i._forwardTime=0,i._sortTime=0;var s=r.scope;return i.fogColorId=s.resolve("fog_color"),i.fogStartId=s.resolve("fog_start"),i.fogEndId=s.resolve("fog_end"),i.fogDensityId=s.resolve("fog_density"),i.ambientId=s.resolve("light_globalAmbient"),i.skyboxIntensityId=s.resolve("skyboxIntensity"),i.cubeMapRotationMatrixId=s.resolve("cubeMapRotationMatrix"),i.pcssDiskSamplesId=s.resolve("pcssDiskSamples[0]"),i.pcssSphereSamplesId=s.resolve("pcssSphereSamples[0]"),i.lightColorId=[],i.lightDir=[],i.lightDirId=[],i.lightShadowMapId=[],i.lightShadowMatrixId=[],i.lightShadowParamsId=[],i.lightShadowIntensity=[],i.lightRadiusId=[],i.lightPos=[],i.lightPosId=[],i.lightWidth=[],i.lightWidthId=[],i.lightHeight=[],i.lightHeightId=[],i.lightInAngleId=[],i.lightOutAngleId=[],i.lightCookieId=[],i.lightCookieIntId=[],i.lightCookieMatrixId=[],i.lightCookieOffsetId=[],i.lightShadowSearchAreaId=[],i.lightCameraParamsId=[],i.lightSoftShadowParamsId=[],i.shadowMatrixPaletteId=[],i.shadowCascadeDistancesId=[],i.shadowCascadeCountId=[],i.shadowCascadeBlendId=[],i.screenSizeId=s.resolve("uScreenSize"),i._screenSize=new Float32Array(4),i.fogColor=new Float32Array(3),i.ambientColor=new Float32Array(3),i.pcssDiskSamples=function(e){for(var t=[],n=0;n<16;++n){var i=Math.sqrt(n+.5)/Math.sqrt(16);t.push(i);}return t}(),i.pcssSphereSamples=function(e){for(var t=[],n=0;n<16;n++){var i=n/16,r=Math.sqrt(i*i);t.push(r);}return t}(),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&cN(t,e);var n=t.prototype;return n.destroy=function(){e.prototype.destroy.call(this);},n.dispatchGlobalLights=function(e){var t=this.ambientColor;if(cB.linear(e.ambientLight),t[0]=cB.r,t[1]=cB.g,t[2]=cB.b,e.physicalUnits)for(var n=0;n<3;n++)t[n]*=e.ambientLuminance;this.ambientId.setValue(t),this.skyboxIntensityId.setValue(e.physicalUnits?e.skyboxLuminance:e.skyboxIntensity),this.cubeMapRotationMatrixId.setValue(e._skyboxRotationMat3.data);},n._resolveLight=function(e,t){var n="light"+t;this.lightColorId[t]=e.resolve(""+n+"_color"),this.lightDir[t]=new Float32Array(3),this.lightDirId[t]=e.resolve(""+n+"_direction"),this.lightShadowMapId[t]=e.resolve(""+n+"_shadowMap"),this.lightShadowMatrixId[t]=e.resolve(""+n+"_shadowMatrix"),this.lightShadowParamsId[t]=e.resolve(""+n+"_shadowParams"),this.lightShadowIntensity[t]=e.resolve(""+n+"_shadowIntensity"),this.lightShadowSearchAreaId[t]=e.resolve(""+n+"_shadowSearchArea"),this.lightRadiusId[t]=e.resolve(""+n+"_radius"),this.lightPos[t]=new Float32Array(3),this.lightPosId[t]=e.resolve(""+n+"_position"),this.lightWidth[t]=new Float32Array(3),this.lightWidthId[t]=e.resolve(""+n+"_halfWidth"),this.lightHeight[t]=new Float32Array(3),this.lightHeightId[t]=e.resolve(""+n+"_halfHeight"),this.lightInAngleId[t]=e.resolve(""+n+"_innerConeAngle"),this.lightOutAngleId[t]=e.resolve(""+n+"_outerConeAngle"),this.lightCookieId[t]=e.resolve(""+n+"_cookie"),this.lightCookieIntId[t]=e.resolve(""+n+"_cookieIntensity"),this.lightCookieMatrixId[t]=e.resolve(""+n+"_cookieMatrix"),this.lightCookieOffsetId[t]=e.resolve(""+n+"_cookieOffset"),this.lightCameraParamsId[t]=e.resolve(""+n+"_cameraParams"),this.lightSoftShadowParamsId[t]=e.resolve(""+n+"_softShadowParams"),this.shadowMatrixPaletteId[t]=e.resolve(""+n+"_shadowMatrixPalette[0]"),this.shadowCascadeDistancesId[t]=e.resolve(""+n+"_shadowCascadeDistances"),this.shadowCascadeCountId[t]=e.resolve(""+n+"_shadowCascadeCount"),this.shadowCascadeBlendId[t]=e.resolve(""+n+"_shadowCascadeBlend");},n.setLTCDirectionalLight=function(e,t,n,i,r){this.lightPos[t][0]=i.x-n.x*r,this.lightPos[t][1]=i.y-n.y*r,this.lightPos[t][2]=i.z-n.z*r,this.lightPosId[t].setValue(this.lightPos[t]);var s=e.transformVector(new eW(-0.5,0,0));this.lightWidth[t][0]=s.x*r,this.lightWidth[t][1]=s.y*r,this.lightWidth[t][2]=s.z*r,this.lightWidthId[t].setValue(this.lightWidth[t]);var a=e.transformVector(new eW(0,0,.5));this.lightHeight[t][0]=a.x*r,this.lightHeight[t][1]=a.y*r,this.lightHeight[t][2]=a.z*r,this.lightHeightId[t].setValue(this.lightHeight[t]);},n.dispatchDirectLights=function(e,t,n){for(var i=0,r=this.device.scope,s=0;s<e.length;s++)if(e[s].mask&t){var a=e[s],o=a._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(r,i),this.lightColorId[i].setValue(a._colorLinear),o.getY(a._direction).mulScalar(-1),a._direction.normalize(),this.lightDir[i][0]=a._direction.x,this.lightDir[i][1]=a._direction.y,this.lightDir[i][2]=a._direction.z,this.lightDirId[i].setValue(this.lightDir[i]),0!==a.shape&&this.setLTCDirectionalLight(o,i,a._direction,n._node.getPosition(),n.farClip),a.castShadows){var l=a.getRenderData(n,0),u=a._getUniformBiasValues(l);this.lightShadowMapId[i].setValue(l.shadowBuffer),this.lightShadowMatrixId[i].setValue(l.shadowMatrix.data),this.shadowMatrixPaletteId[i].setValue(a._shadowMatrixPalette),this.shadowCascadeDistancesId[i].setValue(a._shadowCascadeDistances),this.shadowCascadeCountId[i].setValue(a.numCascades),this.shadowCascadeBlendId[i].setValue(1-a.cascadeBlend),this.lightShadowIntensity[i].setValue(a.shadowIntensity),this.lightSoftShadowParamsId[i].setValue(a._softShadowParams),l.shadowCamera.renderTarget&&this.lightShadowSearchAreaId[i].setValue(a.penumbraSize/l.shadowCamera.renderTarget.width*l.projectionCompensation);var c=a._shadowCameraParams;c.length=4,c[0]=0,c[1]=l.shadowCamera._farClip,c[2]=l.shadowCamera._nearClip,c[3]=1,this.lightCameraParamsId[i].setValue(c);var h=a._shadowRenderParams;h.length=4,h[0]=a._shadowResolution,h[1]=u.normalBias,h[2]=u.bias,h[3]=0,this.lightShadowParamsId[i].setValue(h);}i++;}return i},n.setLTCPositionalLight=function(e,t){var n=e.transformVector(new eW(-0.5,0,0));this.lightWidth[t][0]=n.x,this.lightWidth[t][1]=n.y,this.lightWidth[t][2]=n.z,this.lightWidthId[t].setValue(this.lightWidth[t]);var i=e.transformVector(new eW(0,0,.5));this.lightHeight[t][0]=i.x,this.lightHeight[t][1]=i.y,this.lightHeight[t][2]=i.z,this.lightHeightId[t].setValue(this.lightHeight[t]);},n.dispatchOmniLight=function(e,t,n){var i=t._node.getWorldTransform();if(this.lightColorId[n]||this._resolveLight(e,n),this.lightRadiusId[n].setValue(t.attenuationEnd),this.lightColorId[n].setValue(t._colorLinear),i.getTranslation(t._position),this.lightPos[n][0]=t._position.x,this.lightPos[n][1]=t._position.y,this.lightPos[n][2]=t._position.z,this.lightPosId[n].setValue(this.lightPos[n]),0!==t.shape&&this.setLTCPositionalLight(i,n),t.castShadows){var r=t.getRenderData(null,0);this.lightShadowMapId[n].setValue(r.shadowBuffer);var s=t._getUniformBiasValues(r),a=t._shadowRenderParams;a.length=4,a[0]=t._shadowResolution,a[1]=s.normalBias,a[2]=s.bias,a[3]=1/t.attenuationEnd,this.lightShadowParamsId[n].setValue(a),this.lightShadowIntensity[n].setValue(t.shadowIntensity);var o=t.penumbraSize/r.shadowCamera.renderTarget.width;this.lightShadowSearchAreaId[n].setValue(o);var l=t._shadowCameraParams;l.length=4,l[0]=0,l[1]=r.shadowCamera._farClip,l[2]=r.shadowCamera._nearClip,l[3]=0,this.lightCameraParamsId[n].setValue(l);}t._cookie&&(this.lightCookieId[n].setValue(t._cookie),this.lightShadowMatrixId[n].setValue(i.data),this.lightCookieIntId[n].setValue(t.cookieIntensity));},n.dispatchSpotLight=function(e,t,n){var i=t._node.getWorldTransform();if(this.lightColorId[n]||this._resolveLight(e,n),this.lightInAngleId[n].setValue(t._innerConeAngleCos),this.lightOutAngleId[n].setValue(t._outerConeAngleCos),this.lightRadiusId[n].setValue(t.attenuationEnd),this.lightColorId[n].setValue(t._colorLinear),i.getTranslation(t._position),this.lightPos[n][0]=t._position.x,this.lightPos[n][1]=t._position.y,this.lightPos[n][2]=t._position.z,this.lightPosId[n].setValue(this.lightPos[n]),0!==t.shape&&this.setLTCPositionalLight(i,n),i.getY(t._direction).mulScalar(-1),t._direction.normalize(),this.lightDir[n][0]=t._direction.x,this.lightDir[n][1]=t._direction.y,this.lightDir[n][2]=t._direction.z,this.lightDirId[n].setValue(this.lightDir[n]),t.castShadows){var r=t.getRenderData(null,0);this.lightShadowMapId[n].setValue(r.shadowBuffer),this.lightShadowMatrixId[n].setValue(r.shadowMatrix.data);var s=t._getUniformBiasValues(r),a=t._shadowRenderParams;a.length=4,a[0]=t._shadowResolution,a[1]=s.normalBias,a[2]=s.bias,a[3]=1/t.attenuationEnd,this.lightShadowParamsId[n].setValue(a),this.lightShadowIntensity[n].setValue(t.shadowIntensity);var o=t.penumbraSize/r.shadowCamera.renderTarget.width,l=1/Math.tan(r.shadowCamera._fov*Math.PI/180/2);this.lightShadowSearchAreaId[n].setValue(o*l);var u=t._shadowCameraParams;u.length=4,u[0]=0,u[1]=r.shadowCamera._farClip,u[2]=r.shadowCamera._nearClip,u[3]=0,this.lightCameraParamsId[n].setValue(u);}if(t._cookie){if(!t.castShadows){var c=uu.evalSpotCookieMatrix(t);this.lightShadowMatrixId[n].setValue(c.data);}this.lightCookieId[n].setValue(t._cookie),this.lightCookieIntId[n].setValue(t.cookieIntensity),t._cookieTransform&&(t._cookieTransformUniform[0]=t._cookieTransform.x,t._cookieTransformUniform[1]=t._cookieTransform.y,t._cookieTransformUniform[2]=t._cookieTransform.z,t._cookieTransformUniform[3]=t._cookieTransform.w,this.lightCookieMatrixId[n].setValue(t._cookieTransformUniform),t._cookieOffsetUniform[0]=t._cookieOffset.x,t._cookieOffsetUniform[1]=t._cookieOffset.y,this.lightCookieOffsetId[n].setValue(t._cookieOffsetUniform));}},n.dispatchLocalLights=function(e,t,n){for(var i=n,r=this.device.scope,s=e[1],a=s.length,o=0;o<a;o++){var l=s[o];l.mask&t&&(this.dispatchOmniLight(r,l,i),i++);}for(var u=e[2],c=u.length,h=0;h<c;h++){var f=u[h];f.mask&t&&(this.dispatchSpotLight(r,f,i),i++);}},n.renderForwardPrepareMaterials=function(e,t,n,i,r,s){var a=null!=(l=e.fogParams)?l:this.scene.fog,o=e.shaderParams;o.fog=a.type,o.srgbRenderTarget=null!=(u=null==t?void 0:t.isColorBufferSrgb(0))&&u,cU.clear();for(var l,u,c,h,f,d=this.device,p=this.scene,m=p.clusteredLightingEnabled,_=null!=(c=null==r?void 0:r.getLightHash(m))?c:0,v=null,g=n.length,y=0;y<g;y++){var S=n[y],x=S.instancingData;if(!x||!(x.count<=0)){S.ensureMaterial(d);var b,T,E=S.material,w=S._shaderDefs,A=S.mask;E&&E===v&&w!==h&&(v=null),E!==v&&(this._materialSwitches++,E._scene=p,E.dirty&&(E.updateUniforms(d,p),E.dirty=false));var C=S.getShaderInstance(s,_,p,o,this.viewUniformFormat,this.viewBindGroupFormat,i);b=E!==v,T=!v||A!==f,cU.drawCalls.push(S),cU.shaderInstances.push(C),cU.isNewMaterial.push(b),cU.lightMaskChanged.push(T),v=E,h=w,f=A;}}return cU},n.renderForwardInternal=function(e,t,n,i,r,s,a){for(var o=this.device,l=this.scene,u=1<<i,c=s?-1:1,h=l.clusteredLightingEnabled,f=(null==(m=e.xr)?void 0:m.session)&&e.xr.views.list.length?e.xr.views.list:null,d=t.drawCalls.length,p=0;p<d;p++){var m,_,v,g,y=t.drawCalls[p],S=t.isNewMaterial[p],x=t.lightMaskChanged[p],b=t.shaderInstances[p],T=y.material,E=y.mask;if(!b.shader.failed){if(S){if(o.setShader(b.shader,false),T.setParameters(o),x){var w=this.dispatchDirectLights(n[0],E,e);h||this.dispatchLocalLights(n,E,w);}this.alphaTestId.setValue(T.alphaTest),o.setBlendState(T.blendState),o.setDepthState(T.depthState),o.setAlphaToCoverage(T.alphaToCoverage);}this.setupCullMode(e._cullFaces,c,y);var A=null!=(v=y.stencilFront)?v:T.stencilFront,C=null!=(g=y.stencilBack)?g:T.stencilBack;o.setStencilState(A,C),y.setParameters(o,u),o.scope.resolve("meshInstanceId").setValue(y.id);var P=y.mesh;this.setVertexBuffers(o,P),this.setMorphing(o,y.morphInstance),this.setSkinning(o,y);var I=y.instancingData;I&&o.setVertexBuffer(I.vertexBuffer),this.setMeshInstanceMatrices(y,true),this.setupMeshUniformBuffers(b);var L=y.renderStyle,D=P.indexBuffer[L];null==r||r(y,p);var M=null==(_=y.indirectData)?void 0:_.get(e);if(f)for(var R=0;R<f.length;R++){var O=f[R];if(o.setViewport(O.viewport.x,O.viewport.y,O.viewport.z,O.viewport.w),o.supportsUniformBuffers){var k=a[R];o.setBindGroup(0,k);}else this.setupViewUniforms(O,R);var N=0===R,F=R===f.length-1;o.draw(P.primitive[L],D,null==I?void 0:I.count,M,N,F),this._forwardDrawCalls++,y.instancingData&&this._instancedDrawCalls++;}else o.draw(P.primitive[L],D,null==I?void 0:I.count,M),this._forwardDrawCalls++,y.instancingData&&this._instancedDrawCalls++;p<d-1&&!t.isNewMaterial[p+1]&&T.setParameters(o,y.parameters);}}},n.renderForward=function(e,t,n,i,r,s,a,o,l){var u=this.renderForwardPrepareMaterials(e,t,n,i,a,r);this.renderForwardInternal(e,u,i,r,s,o,l),cU.clear();},n.renderForwardLayer=function(e,t,n,i,r,s,a){ void 0===a&&(a={});var o,l,u,c,h,f,d,p,m=this.scene,_=this.device,v=m.clusteredLightingEnabled;if(this.setupViewport(e,t),n){n.sortVisible(e,i);var g=n.getCulledInstances(e);o=i?g.transparent:g.opaque,m.immediate.onPreRenderLayer(n,o,i),n.requiresLightCube&&(this.lightCube.update(m.ambientLight,n._lights),this.constantLightCube.setValue(this.lightCube.colors)),l=n.splitLights;}else o=a.meshInstances,l=null!=(u=a.splitLights)?u:cF;v&&((null!=(c=a.lightClusters)?c:this.worldClustersAllocator.empty).activate(),n&&!this.clustersDebugRendered&&m.lighting.debugLayer===n.id&&(this.clustersDebugRendered=true)),m._activeCamera=e;var y=null!=(h=e.fogParams)?h:this.scene.fog;this.setFogConstants(y);var S=this.setCameraUniforms(e,t);_.supportsUniformBuffers&&this.setupViewUniformBuffers(s,this.viewUniformFormat,this.viewBindGroupFormat,S);var x=null!=(f=a.clearColor)&&f,b=null!=(d=a.clearDepth)&&d,T=null!=(p=a.clearStencil)&&p;(x||b||T)&&this.clear(e,x,b,T);var E=!!(e._flipFaces^(null==t?void 0:t.flipY)),w=this._forwardDrawCalls;this.renderForward(e,t,o,l,r,null,n,E,s),n&&(n._forwardDrawCalls+=this._forwardDrawCalls-w);},n.setFogConstants=function(e){if(e.type!==on){cB.linear(e.color);var t=this.fogColor;t[0]=cB.r,t[1]=cB.g,t[2]=cB.b,this.fogColorId.setValue(t),e.type===oi?(this.fogStartId.setValue(e.start),this.fogEndId.setValue(e.end)):this.fogDensityId.setValue(e.density);}},n.setSceneConstants=function(){var e=this.scene;this.dispatchGlobalLights(e);var t=this.device;this._screenSize[0]=t.width,this._screenSize[1]=t.height,this._screenSize[2]=1/t.width,this._screenSize[3]=1/t.height,this.screenSizeId.setValue(this._screenSize),this.pcssDiskSamplesId.setValue(this.pcssDiskSamples),this.pcssSphereSamplesId.setValue(this.pcssSphereSamples);},n.buildFrameGraph=function(e,t){var n=this.scene;if(e.reset(),n.clusteredLightingEnabled){var i=n.lighting,r=i.shadowsEnabled,s=i.cookiesEnabled;this._renderPassUpdateClustered.update(e,r,s,this.lights,this.localLights),e.addRenderPass(this._renderPassUpdateClustered);}else this._shadowRendererLocal.buildNonClusteredRenderPasses(e,this.localLights);for(var a=0,o=true,l=null,u=t._renderActions,c=a;c<u.length;c++){var h=u[c],f=h.layer,d=h.camera;if(h.useCameraPasses)d.camera.renderPasses.forEach(function(t){e.addRenderPass(t);});else {var p=1===f.id,m=p&&(d.renderSceneColorMap||d.renderSceneDepthMap);o&&(o=false,a=c,l=h.renderTarget);var _=u[c+1],v=!!_&&!_.useCameraPasses&&1===_.layer.id&&(d.renderSceneColorMap||d.renderSceneDepthMap),g=!!_&&_.firstCameraUse&&this.cameraDirShadowLights.has(_.camera.camera);if(!_||_.renderTarget!==l||g||v||m){if(p&&a===c||this.addMainRenderPass(e,t,l,a,c),p){if(d.renderSceneColorMap){var y=d.camera.renderPassColorGrab;y.source=d.renderTarget,e.addRenderPass(y);}d.renderSceneDepthMap&&e.addRenderPass(d.camera.renderPassDepthGrab);}if(h.triggerPostprocess&&(null==d?void 0:d.onPostprocessing)){var S=new ck(this.device,this,h);e.addRenderPass(S);}o=true;}}}},n.addMainRenderPass=function(e,t,n,i,r){var s=new cR(this.device,t,this.scene,this);s.init(n);for(var a=t._renderActions,o=i;o<=r;o++)s.addRenderAction(a[o]);e.addRenderPass(s);},n.update=function(e){var t;this.frameUpdate(),this.shadowRenderer.frameUpdate(),this.scene._updateSkyMesh(),this.updateLayerComposition(e),this.collectLights(e),this.beginFrame(e),this.setSceneConstants(),null==(t=this.gsplatDirector)||t.update(e),this.cullComposition(e),this.gpuUpdate(this.processingMeshInstances);},t}(cL),cV=0,cG=[],cH=new Set,cW=[null,function(e,t){return e.drawOrder-t.drawOrder},function(e,t){var n=e._sortKeyForward,i=t._sortKeyForward;return n===i?t.mesh.id-e.mesh.id:i-n},function(e,t){return t._sortKeyDynamic-e._sortKeyDynamic},function(e,t){return e._sortKeyDynamic-t._sortKeyDynamic}],cj=function(){this.opaque=[],this.transparent=[];},cX=function(){function e(e){var t,n,i;void 0===e&&(e={}),this.meshInstances=[],this.meshInstancesSet=new Set,this.shadowCasters=[],this.shadowCastersSet=new Set,this._visibleInstances=new WeakMap,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this._splitLightsDirty=true,this.requiresLightCube=false,this.cameras=[],this.camerasSet=new Set,this.gsplatPlacements=[],this.gsplatPlacementsDirty=true,this._dirtyComposition=false,void 0!==e.id?(this.id=e.id,cV=Math.max(this.id+1,cV)):this.id=cV++,this.name=e.name,this._enabled=null==(t=e.enabled)||t,this._refCounter=+!!this._enabled,this.opaqueSortMode=null!=(n=e.opaqueSortMode)?n:2,this.transparentSortMode=null!=(i=e.transparentSortMode)?i:3,e.renderTarget&&(this.renderTarget=e.renderTarget),this._clearColorBuffer=!!e.clearColorBuffer,this._clearDepthBuffer=!!e.clearDepthBuffer,this._clearStencilBuffer=!!e.clearStencilBuffer,this.onEnable=e.onEnable,this.onDisable=e.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.customSortCallback=null,this.customCalculateSortValues=null,this._lightHash=0,this._lightHashDirty=false,this._lightIdHash=0,this._lightIdHashDirty=false,this._shaderVersion=-1;}var t,n=e.prototype;return n.incrementCounter=function(){0===this._refCounter&&(this._enabled=true,this.onEnable&&this.onEnable()),this._refCounter++;},n.decrementCounter=function(){if(1===this._refCounter)this._enabled=false,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--;},n.addGSplatPlacement=function(e){this.gsplatPlacements.includes(e)||(this.gsplatPlacements.push(e),this.gsplatPlacementsDirty=true);},n.removeGSplatPlacement=function(e){var t=this.gsplatPlacements.indexOf(e);t>=0&&(this.gsplatPlacements.splice(t,1),this.gsplatPlacementsDirty=true);},n.addMeshInstances=function(e,t){for(var n=this.meshInstances,i=this.meshInstancesSet,r=0;r<e.length;r++){var s=e[r];i.has(s)||(n.push(s),i.add(s),cH.add(s.material));}if(t||this.addShadowCasters(e),cH.size>0){var a=this._shaderVersion;cH.forEach(function(e){a>=0&&e._shaderVersion!==a&&(e.getShaderVariant!==uV.prototype.getShaderVariant&&e.clearVariants(),e._shaderVersion=a);}),cH.clear();}},n.removeMeshInstances=function(e,t){for(var n=this.meshInstances,i=this.meshInstancesSet,r=0;r<e.length;r++){var s=e[r];if(i.has(s)){i.delete(s);var a=n.indexOf(s);a>=0&&n.splice(a,1);}}t||this.removeShadowCasters(e);},n.addShadowCasters=function(e){for(var t=this.shadowCasters,n=this.shadowCastersSet,i=0;i<e.length;i++){var r=e[i];r.castShadow&&!n.has(r)&&(n.add(r),t.push(r));}},n.removeShadowCasters=function(e){for(var t=this.shadowCasters,n=this.shadowCastersSet,i=0;i<e.length;i++){var r=e[i];if(n.has(r)){n.delete(r);var s=t.indexOf(r);s>=0&&t.splice(s,1);}}},n.clearMeshInstances=function(e){ void 0===e&&(e=false),this.meshInstances.length=0,this.meshInstancesSet.clear(),e||(this.shadowCasters.length=0,this.shadowCastersSet.clear());},n.markLightsDirty=function(){this._lightHashDirty=true,this._lightIdHashDirty=true,this._splitLightsDirty=true;},n.hasLight=function(e){return this._lightsSet.has(e)},n.addLight=function(e){var t=e.light;this._lightsSet.has(t)||(this._lightsSet.add(t),this._lights.push(t),this.markLightsDirty()),0!==t.type&&this._clusteredLightsSet.add(t);},n.removeLight=function(e){var t=e.light;this._lightsSet.has(t)&&(this._lightsSet.delete(t),this._lights.splice(this._lights.indexOf(t),1),this.markLightsDirty()),0!==t.type&&this._clusteredLightsSet.delete(t);},n.clearLights=function(){var e=this;this._lightsSet.forEach(function(t){return t.removeLayer(e)}),this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this.markLightsDirty();},n.evaluateLightHash=function(e,t,n){for(var i=0,r=this._lights,s=0;s<r.length;s++){var a=0!==r[s].type;(e&&a||t&&!a)&&cG.push(n?r[s].id:r[s].key);}return cG.length>0&&(cG.sort(),i=n3(cG),cG.length=0),i},n.getLightHash=function(e){return this._lightHashDirty&&(this._lightHashDirty=false,this._lightHash=this.evaluateLightHash(!e,true,false)),this._lightHash},n.getLightIdHash=function(){return this._lightIdHashDirty&&(this._lightIdHashDirty=false,this._lightIdHash=this.evaluateLightHash(true,false,true)),this._lightIdHash},n.addCamera=function(e){this.camerasSet.has(e.camera)||(this.camerasSet.add(e.camera),this.cameras.push(e),this._dirtyComposition=true);},n.removeCamera=function(e){if(this.camerasSet.has(e.camera)){this.camerasSet.delete(e.camera);var t=this.cameras.indexOf(e);this.cameras.splice(t,1),this._dirtyComposition=true;}},n.clearCameras=function(){this.cameras.length=0,this.camerasSet.clear(),this._dirtyComposition=true;},n._calculateSortDistances=function(e,t,n){for(var i=e.length,r=t.x,s=t.y,a=t.z,o=n.x,l=n.y,u=n.z,c=0;c<i;c++){var h=e[c],f=void 0;if(h.calculateSortDistance)f=h.calculateSortDistance(h,t,n);else {var d=h.aabb.center;f=(d.x-r)*o+(d.y-s)*l+(d.z-a)*u;}var p=1e9*h._drawBucket;h._sortKeyDynamic=p+f;}},n.getCulledInstances=function(e){var t=this._visibleInstances.get(e);return t||(t=new cj,this._visibleInstances.set(e,t)),t},n.sortVisible=function(e,t){var n=t?this.transparentSortMode:this.opaqueSortMode;if(0!==n){var i=this.getCulledInstances(e),r=t?i.transparent:i.opaque,s=e.node;if(5===n){var a=s.getPosition(),o=s.forward;this.customCalculateSortValues&&this.customCalculateSortValues(r,r.length,a,o),this.customSortCallback&&r.sort(this.customSortCallback);}else {if(3===n||4===n){var l=s.getPosition(),u=s.forward;this._calculateSortDistances(r,l,u);}r.sort(cW[n]);}}},t=[{key:"enabled",get:function(){return this._enabled},set:function(e){e!==this._enabled&&(this._dirtyComposition=true,this.gsplatPlacementsDirty=true,this._enabled=e,e?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()));}},{key:"clearColorBuffer",get:function(){return this._clearColorBuffer},set:function(e){this._clearColorBuffer=e,this._dirtyComposition=true;}},{key:"clearDepthBuffer",get:function(){return this._clearDepthBuffer},set:function(e){this._clearDepthBuffer=e,this._dirtyComposition=true;}},{key:"clearStencilBuffer",get:function(){return this._clearStencilBuffer},set:function(e){this._clearStencilBuffer=e,this._dirtyComposition=true;}},{key:"hasClusteredLights",get:function(){return this._clusteredLightsSet.size>0}},{key:"clusteredLightsSet",get:function(){return this._clusteredLightsSet}},{key:"splitLights",get:function(){if(this._splitLightsDirty){this._splitLightsDirty=false;for(var e=this._splitLights,t=0;t<e.length;t++)e[t].length=0;for(var n=this._lights,i=0;i<n.length;i++){var r=n[i];r.enabled&&e[r._type].push(r);}for(var s=0;s<e.length;s++)e[s].sort(function(e,t){return e.key-t.key});}return this._splitLights}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),cY=function(e,t){return e.priority-t.priority},cq=function(e){return e.sort(cY)};function cK(e,t){return (cK=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var cZ=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return void 0===t&&(t="Untitled"),(n=e.call(this)||this).layerList=[],n.layerIdMap=new Map,n.layerNameMap=new Map,n.layerOpaqueIndexMap=new Map,n.layerTransparentIndexMap=new Map,n.subLayerList=[],n.subLayerEnabled=[],n.cameras=[],n.camerasSet=new Set,n._renderActions=[],n._dirty=false,n.name=t,n._opaqueOrder={},n._transparentOrder={},n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&cK(t,e);var n=t.prototype;return n.destroy=function(){this.destroyRenderActions();},n.destroyRenderActions=function(){this._renderActions.forEach(function(e){return e.destroy()}),this._renderActions.length=0;},n.markDirty=function(){this._dirty=true;},n._update=function(){var e=this.layerList.length;if(!this._dirty){for(var t=0;t<e;t++)if(this.layerList[t]._dirtyComposition){this._dirty=true;break}}if(this._dirty){this._dirty=false,this.cameras.length=0,this.camerasSet.clear();for(var n=0;n<e;n++){var i=this.layerList[n];i._dirtyComposition=false;for(var r=0;r<i.cameras.length;r++){var s=i.cameras[r];this.camerasSet.has(s.camera)||(this.camerasSet.add(s.camera),this.cameras.push(s));}}this.cameras.length>1&&cq(this.cameras);var a=[],o=0;this.destroyRenderActions();for(var l=0;l<this.cameras.length;l++){var u=this.cameras[l];if(a.length=0,u.camera.renderPasses.length>0){this.addDummyRenderAction(o,u),o++;continue}for(var c=true,h=o,f=null,d=false,p=0;p<e;p++){var m=this.layerList[p];if(m.enabled&&this.subLayerEnabled[p]&&m.cameras.length>0&&u.layers.indexOf(m.id)>=0){a.push(m),!d&&m.id===u.disablePostEffectsLayer&&(d=true,f&&(f.triggerPostprocess=true));var _=this.subLayerList[p];f=this.addRenderAction(o,m,_,u,c,d),o++,c=false;}}h<o&&(f.lastCameraUse=true),!d&&f&&(f.triggerPostprocess=true),u.renderTarget&&u.postEffectsEnabled&&this.propagateRenderTarget(h-1,u);}this._logRenderActions();}},n.getNextRenderAction=function(e){var t=new cD;return this._renderActions.push(t),t},n.addDummyRenderAction=function(e,t){var n=this.getNextRenderAction(e);n.camera=t,n.useCameraPasses=true;},n.addRenderAction=function(e,t,n,i,r,s){for(var a=1!==t.id?i.renderTarget:null,o=false,l=this._renderActions,u=e-1;u>=0;u--)if(l[u].camera===i&&l[u].renderTarget===a){o=true;break}s&&i.postEffectsEnabled&&(a=null);var c=this.getNextRenderAction(e);c.triggerPostprocess=false,c.layer=t,c.transparent=n,c.camera=i,c.renderTarget=a,c.firstCameraUse=r,c.lastCameraUse=false;var h=r||!o,f=t.clearColorBuffer||t.clearDepthBuffer||t.clearStencilBuffer;return (h||f)&&c.setupClears(h?i:void 0,t),c},n.propagateRenderTarget=function(e,t){for(var n=e;n>=0;n--){var i=this._renderActions[n],r=i.layer;if(i.renderTarget&&1!==r.id)break;if(1!==r.id){if(i.useCameraPasses)break;var s=null==i?void 0:i.camera.camera;if(s&&(!t.camera.rect.equals(s.rect)||!t.camera.scissorRect.equals(s.scissorRect)))break;i.renderTarget=t.renderTarget;}}},n._logRenderActions=function(){},n._isLayerAdded=function(e){return this.layerIdMap.get(e.id)===e},n._isSublayerAdded=function(e,t){return void 0!==(t?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).get(e)},n.push=function(e){this._isLayerAdded(e)||(this.layerList.push(e),this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(false)-1,this._transparentOrder[e.id]=this.subLayerList.push(true)-1,this.subLayerEnabled.push(true),this.subLayerEnabled.push(true),this._updateLayerMaps(),this._dirty=true,this.fire("add",e));},n.insert=function(e,t){if(!this._isLayerAdded(e)){this.layerList.splice(t,0,e,e),this.subLayerList.splice(t,0,false,true);var n=this.layerList.length;this._updateOpaqueOrder(t,n-1),this._updateTransparentOrder(t,n-1),this.subLayerEnabled.splice(t,0,true,true),this._updateLayerMaps(),this._dirty=true,this.fire("add",e);}},n.remove=function(e){var t=this.layerList.indexOf(e);for(delete this._opaqueOrder[t],delete this._transparentOrder[t];t>=0;)this.layerList.splice(t,1),this.subLayerList.splice(t,1),this.subLayerEnabled.splice(t,1),t=this.layerList.indexOf(e),this._dirty=true,this.fire("remove",e);var n=this.layerList.length;this._updateOpaqueOrder(0,n-1),this._updateTransparentOrder(0,n-1),this._updateLayerMaps();},n.pushOpaque=function(e){this._isSublayerAdded(e,false)||(this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(false)-1,this.subLayerEnabled.push(true),this._updateLayerMaps(),this._dirty=true,this.fire("add",e));},n.insertOpaque=function(e,t){if(!this._isSublayerAdded(e,false)){this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,false);var n=this.subLayerList.length;this._updateOpaqueOrder(t,n-1),this.subLayerEnabled.splice(t,0,true),this._updateLayerMaps(),this._dirty=true,this.fire("add",e);}},n.removeOpaque=function(e){for(var t=0,n=this.layerList.length;t<n;t++)if(this.layerList[t]===e&&!this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),n--,this._updateOpaqueOrder(t,n-1),this.subLayerEnabled.splice(t,1),this._dirty=true,0>this.layerList.indexOf(e)&&this.fire("remove",e);break}this._updateLayerMaps();},n.pushTransparent=function(e){this._isSublayerAdded(e,true)||(this.layerList.push(e),this._transparentOrder[e.id]=this.subLayerList.push(true)-1,this.subLayerEnabled.push(true),this._updateLayerMaps(),this._dirty=true,this.fire("add",e));},n.insertTransparent=function(e,t){if(!this._isSublayerAdded(e,true)){this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,true);var n=this.subLayerList.length;this._updateTransparentOrder(t,n-1),this.subLayerEnabled.splice(t,0,true),this._updateLayerMaps(),this._dirty=true,this.fire("add",e);}},n.removeTransparent=function(e){for(var t=0,n=this.layerList.length;t<n;t++)if(this.layerList[t]===e&&this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),n--,this._updateTransparentOrder(t,n-1),this.subLayerEnabled.splice(t,1),this._dirty=true,0>this.layerList.indexOf(e)&&this.fire("remove",e);break}this._updateLayerMaps();},n.getOpaqueIndex=function(e){var t;return null!=(t=this.layerOpaqueIndexMap.get(e))?t:-1},n.getTransparentIndex=function(e){var t;return null!=(t=this.layerTransparentIndexMap.get(e))?t:-1},n.isEnabled=function(e,t){if(e.enabled){var n=t?this.getTransparentIndex(e):this.getOpaqueIndex(e);if(n>=0)return this.subLayerEnabled[n]}return  false},n._updateLayerMaps=function(){this.layerIdMap.clear(),this.layerNameMap.clear(),this.layerOpaqueIndexMap.clear(),this.layerTransparentIndexMap.clear();for(var e=0;e<this.layerList.length;e++){var t=this.layerList[e];this.layerIdMap.set(t.id,t),this.layerNameMap.set(t.name,t),(this.subLayerList[e]?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).set(t,e);}},n.getLayerById=function(e){var t;return null!=(t=this.layerIdMap.get(e))?t:null},n.getLayerByName=function(e){var t;return null!=(t=this.layerNameMap.get(e))?t:null},n._updateOpaqueOrder=function(e,t){for(var n=e;n<=t;n++) false===this.subLayerList[n]&&(this._opaqueOrder[this.layerList[n].id]=n);},n._updateTransparentOrder=function(e,t){for(var n=e;n<=t;n++) true===this.subLayerList[n]&&(this._transparentOrder[this.layerList[n].id]=n);},n._sortLayersDescending=function(e,t,n){for(var i=-1,r=-1,s=0,a=e.length;s<a;s++){var o=e[s];n.hasOwnProperty(o)&&(i=Math.max(i,n[o]));}for(var l=0,u=t.length;l<u;l++){var c=t[l];n.hasOwnProperty(c)&&(r=Math.max(r,n[c]));}return -1===i&&-1!==r?1:-1===r&&-1!==i?-1:r-i},n.sortTransparentLayers=function(e,t){return this._sortLayersDescending(e,t,this._transparentOrder)},n.sortOpaqueLayers=function(e,t){return this._sortLayersDescending(e,t,this._opaqueOrder)},t}(ex);function cQ(e,t,n){return t&&function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}var cJ=new eW,c$={bias:0,normalBias:0},c0=new eN,c1={r:0,g:1,b:2,a:3},c2={directional:0,omni:1,point:1,spot:2},c3=[[new eY(0,0,1,1)],[new eY(0,0,.5,.5),new eY(0,.5,.5,.5)],[new eY(0,0,.5,.5),new eY(0,.5,.5,.5),new eY(.5,0,.5,.5)],[new eY(0,0,.5,.5),new eY(0,.5,.5,.5),new eY(.5,0,.5,.5),new eY(.5,.5,.5,.5)]],c4={rrr:1,ggg:2,bbb:4,aaa:8,rgb:7},c5=0,c8=function(){function e(e,t,n){this.light=n,this.camera=e,this.shadowCamera=u8.createShadowCamera(n._shadowType,n._type,t),this.shadowMatrix=new e$,this.shadowViewport=new eY(0,0,1,1),this.shadowScissor=new eY(0,0,1,1),this.projectionCompensation=0,this.face=t,this.visibleCasters=[],this.viewBindGroups=[];}return e.prototype.destroy=function(){this.viewBindGroups.forEach(function(e){e.defaultUniformBuffer.destroy(),e.destroy();}),this.viewBindGroups.length=0;},cQ(e,[{key:"shadowBuffer",get:function(){var e=this.shadowCamera.renderTarget;return e?this.light._isPcf?e.depthBuffer:e.colorBuffer:null}}]),e}(),c6=function(){function e(e,t){this.layers=new Set,this.shadowDepthState=nq.DEFAULT.clone(),this.clusteredFlags=0,this.clusteredData=new Uint32Array(3),this.clusteredData16=new Uint16Array(this.clusteredData.buffer),this._evtDeviceRestored=null,this.device=e,this.clusteredLighting=t,this.id=c5++,this._evtDeviceRestored=e.on("devicerestored",this.onDeviceRestored,this),this._type=0,this._color=new eN(.8,.8,.8),this._intensity=1,this._affectSpecularity=true,this._luminance=0,this._castShadows=false,this._enabled=false,this._mask=1,this.isStatic=false,this.key=0,this.bakeDir=true,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=0,this._shadowType=0,this._vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=true,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=false,this._cookieOffsetSet=false,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this._cascadeBlend=0,this.cascadeDistribution=.5,this._shape=0,this._colorLinear=new Float32Array(3),this._updateLinearColor(),this._position=new eW(0,0,0),this._direction=new eW(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._updateOuterAngle(this._outerConeAngle),this._usePhysicalUnits=void 0,this._shadowMap=null,this._shadowRenderParams=[],this._shadowCameraParams=[],this.shadowDistance=40,this._shadowResolution=1024,this._shadowBias=-5e-4,this._shadowIntensity=1,this._normalOffsetBias=0,this.shadowUpdateMode=2,this.shadowUpdateOverrides=null,this._isVsm=false,this._isPcf=true,this._softShadowParams=new Float32Array(4),this.shadowSamples=16,this.shadowBlockerSamples=16,this.penumbraSize=1,this.penumbraFalloff=1,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=false,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=false,this._node=null,this._renderData=[],this.visibleThisFrame=false,this.maxScreenSize=0,this._updateShadowBias();}var t=e.prototype;return t.destroy=function(){var e;null==(e=this._evtDeviceRestored)||e.off(),this._evtDeviceRestored=null,this._destroyShadowMap(),this.releaseRenderData(),this._renderData=null;},t.onDeviceRestored=function(){0===this.shadowUpdateMode&&(this.shadowUpdateMode=1);},t.releaseRenderData=function(){if(this._renderData){for(var e=0;e<this._renderData.length;e++)this._renderData[e].destroy();this._renderData.length=0;}},t.addLayer=function(e){this.layers.add(e);},t.removeLayer=function(e){this.layers.delete(e);},t._updateOuterAngle=function(e){var t=e*Math.PI/180;this._outerConeAngleCos=Math.cos(t),this._outerConeAngleSin=Math.sin(t),this.updateClusterData(false,true);},t.beginFrame=function(){this.visibleThisFrame=0===this._type&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=false,this.atlasSlotUpdated=false;},t._destroyShadowMap=function(){if(this.releaseRenderData(),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),0===this.shadowUpdateMode&&(this.shadowUpdateMode=1),this.shadowUpdateOverrides)for(var e=0;e<this.shadowUpdateOverrides.length;e++)0===this.shadowUpdateOverrides[e]&&(this.shadowUpdateOverrides[e]=1);},t.getRenderData=function(e,t){for(var n=0;n<this._renderData.length;n++){var i=this._renderData[n];if(i.camera===e&&i.face===t)return i}var r=new c8(e,t,this);return this._renderData.push(r),r},t.clone=function(){var t=new e(this.device,this.clusteredLighting);return t.type=this._type,t.setColor(this._color),t.intensity=this._intensity,t.affectSpecularity=this._affectSpecularity,t.luminance=this._luminance,t.castShadows=this.castShadows,t._enabled=this._enabled,t.attenuationStart=this.attenuationStart,t.attenuationEnd=this.attenuationEnd,t.falloffMode=this._falloffMode,t.shadowType=this._shadowType,t.vsmBlurSize=this._vsmBlurSize,t.vsmBlurMode=this.vsmBlurMode,t.vsmBias=this.vsmBias,t.shadowUpdateMode=this.shadowUpdateMode,t.mask=this.mask,this.shadowUpdateOverrides&&(t.shadowUpdateOverrides=this.shadowUpdateOverrides.slice()),t.innerConeAngle=this._innerConeAngle,t.outerConeAngle=this._outerConeAngle,t.numCascades=this.numCascades,t.cascadeDistribution=this.cascadeDistribution,t.cascadeBlend=this._cascadeBlend,t.shape=this._shape,t.shadowDepthState.copy(this.shadowDepthState),t.shadowBias=this.shadowBias,t.normalOffsetBias=this._normalOffsetBias,t.shadowResolution=this._shadowResolution,t.shadowDistance=this.shadowDistance,t.shadowIntensity=this.shadowIntensity,t.shadowSamples=this.shadowSamples,t.shadowBlockerSamples=this.shadowBlockerSamples,t.penumbraSize=this.penumbraSize,t.penumbraFalloff=this.penumbraFalloff,t},t._getUniformBiasValues=function(e){var t=e.shadowCamera._farClip;switch(this._type){case 1:c$.bias=this.shadowBias,c$.normalBias=this._normalOffsetBias;break;case 2:this._isVsm?c$.bias=-2e-4:c$.bias=20*this.shadowBias,c$.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case 0:this._isVsm?c$.bias=-2e-4:c$.bias=this.shadowBias/t*100,c$.normalBias=this._isVsm?this.vsmBias/(t/7):this._normalOffsetBias;}return c$},t.getColor=function(){return this._color},t.getBoundingSphere=function(e){if(2===this._type){var t=this.attenuationEnd,n=this._outerConeAngle,i=this._outerConeAngleCos,r=this._node;cJ.copy(r.up),n>45?(e.radius=t*this._outerConeAngleSin,cJ.mulScalar(-t*i)):(e.radius=t/(2*i),cJ.mulScalar(-e.radius)),e.center.add2(r.getPosition(),cJ);}else 1===this._type&&(e.center=this._node.getPosition(),e.radius=this.attenuationEnd);},t.getBoundingBox=function(e){if(2===this._type){var t=this.attenuationEnd,n=this._outerConeAngle,i=this._node,r=Math.abs(Math.sin(n*ek.DEG_TO_RAD)*t);e.center.set(0,-(.5*t),0),e.halfExtents.set(r,.5*t,r),e.setFromTransformedAabb(e,i.getWorldTransform(),true);}else 1===this._type&&(e.center.copy(this._node.getPosition()),e.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd));},t._updateShadowBias=function(){if(1!==this._type||this.clusteredLighting){var e=-1e3*this.shadowBias;this.shadowDepthState.depthBias=e,this.shadowDepthState.depthBiasSlope=e;}else this.shadowDepthState.depthBias=0,this.shadowDepthState.depthBiasSlope=0;},t._updateLinearColor=function(){var t=this._intensity;this._usePhysicalUnits&&(t=this._luminance/e.getLightUnitConversion(this._type,this._outerConeAngle*ek.DEG_TO_RAD,this._innerConeAngle*ek.DEG_TO_RAD));var n=this._color,i=this._colorLinear;t>=1?c0.linear(n).mulScalar(t):c0.copy(n).mulScalar(t).linear(),i[0]=c0.r,i[1]=c0.g,i[2]=c0.b,this.updateClusterData(true);},t.setColor=function(){1==arguments.length?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):3==arguments.length&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateLinearColor();},t.layersDirty=function(){var e=this;this.layers.forEach(function(t){t.hasLight(e)&&t.markLightsDirty();});},t.updateKey=function(){var e=this._type<<29|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias)<<22|!!this._cookie<<21|!!this._cookieFalloff<<20|c1[this._cookieChannel.charAt(0)]<<18|!!this._cookieTransform<<12|this._shape<<10|(this.numCascades>0)<<9|(this._cascadeBlend>0)<<8|!!this.affectSpecularity<<7|this.mask<<6|!!this._castShadows<<3;3===this._cookieChannel.length&&(e|=c1[this._cookieChannel.charAt(1)]<<16,e|=c1[this._cookieChannel.charAt(2)]<<14),e!==this.key&&this.layersDirty(),this.key=e;},t.updateClusteredFlags=function(){var e,t=!!(1&this.mask),n=!!(2&this.mask);this.clusteredFlags=(2===this.type)<<30|(3&this._shape)<<28|(1&this._falloffMode)<<27|(null!=(e=c4[this._cookieChannel])?e:0)<<23|!!t<<22|!!n<<21;},t.getClusteredFlags=function(e,t){return this.clusteredFlags|(e?Math.floor(255*this.shadowIntensity):0)&255|((t?Math.floor(255*this.cookieIntensity):0)&255)<<8},t.updateClusterData=function(e,t){var n=this.clusteredData16,i=eG.float2Half;e&&(n[0]=i(ek.clamp(this._colorLinear[0]/100,0,65504)),n[1]=i(ek.clamp(this._colorLinear[1]/100,0,65504)),n[2]=i(ek.clamp(this._colorLinear[2]/100,0,65504))),t&&(n[4]=i(this._innerConeAngleCos),n[5]=i(this._outerConeAngleCos));},e.getLightUnitConversion=function(e,t,n){switch(void 0===t&&(t=Math.PI/4),void 0===n&&(n=0),e){case 2:var i=Math.cos(n);return 2*Math.PI*(1-i+(i-Math.cos(t))/2);case 1:return 4*Math.PI;case 0:return 1}},cQ(e,[{key:"shadowSamples",get:function(){return this._softShadowParams[0]},set:function(e){this._softShadowParams[0]=e;}},{key:"shadowBlockerSamples",get:function(){return this._softShadowParams[1]},set:function(e){this._softShadowParams[1]=e;}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias!==e&&(this._shadowBias=e,this._updateShadowBias());}},{key:"numCascades",get:function(){return this.cascades.length},set:function(e){this.cascades&&this.numCascades===e||(this.cascades=c3[e-1],this._shadowMatrixPalette=new Float32Array(64),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey());}},{key:"cascadeBlend",get:function(){return this._cascadeBlend},set:function(e){this._cascadeBlend!==e&&(this._cascadeBlend=e,this.updateKey());}},{key:"shadowMap",get:function(){return this._shadowMap},set:function(e){this._shadowMap!==e&&(this._destroyShadowMap(),this._shadowMap=e);}},{key:"mask",get:function(){return this._mask},set:function(e){this._mask!==e&&(this._mask=e,this.updateKey(),this.updateClusteredFlags());}},{key:"numShadowFaces",get:function(){var e=this._type;return 0===e?this.numCascades:1===e?6:1}},{key:"type",get:function(){return this._type},set:function(e){if(this._type!==e){this._type=e,this._destroyShadowMap(),this._updateShadowBias(),this.updateKey(),this.updateClusteredFlags();var t=this._shadowType;this._shadowType=null,this.shadowUpdateOverrides=null,this.shadowType=t;}}},{key:"shape",get:function(){return this._shape},set:function(e){if(this._shape!==e){this._shape=e,this._destroyShadowMap(),this.updateKey(),this.updateClusteredFlags();var t=this._shadowType;this._shadowType=null,this.shadowType=t;}}},{key:"usePhysicalUnits",get:function(){return this._usePhysicalUnits},set:function(e){this._usePhysicalUnits!==e&&(this._usePhysicalUnits=e,this._updateLinearColor());}},{key:"shadowType",get:function(){return this._shadowType},set:function(e){if(this._shadowType!==e){var t,n,i=ol.get(e);i||(e=0);var r=this.device;6!==e||r.textureFloatRenderable||r.textureHalfFloatRenderable||(e=0),1===this._type&&5!==e&&0!==e&&7!==e&&8!==e&&6!==e&&(e=0),3!==e||r.textureFloatRenderable&&r.textureFloatFilterable||(e=2),2!==e||r.textureHalfFloatRenderable||(e=0),i=ol.get(e),this._isVsm=null!=(t=null==i?void 0:i.vsm)&&t,this._isPcf=null!=(n=null==i?void 0:i.pcf)&&n,this._shadowType=e,this._destroyShadowMap(),this.updateKey();}}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this.layersDirty());}},{key:"castShadows",get:function(){return this._castShadows&&4!==this._mask&&0!==this._mask},set:function(e){this._castShadows!==e&&(this._castShadows=e,this._destroyShadowMap(),this.layersDirty(),this.updateKey());}},{key:"shadowIntensity",get:function(){return this._shadowIntensity},set:function(e){this._shadowIntensity!==e&&(this._shadowIntensity=e,this.updateKey());}},{key:"bakeShadows",get:function(){return this._castShadows&&4===this._mask}},{key:"shadowResolution",get:function(){return this._shadowResolution},set:function(e){this._shadowResolution!==e&&(e=1===this._type?Math.min(e,this.device.maxCubeMapSize):Math.min(e,this.device.maxTextureSize),this._shadowResolution=e,this._destroyShadowMap());}},{key:"vsmBlurSize",get:function(){return this._vsmBlurSize},set:function(e){this._vsmBlurSize!==e&&(e%2==0&&e++,this._vsmBlurSize=e);}},{key:"normalOffsetBias",get:function(){return this._normalOffsetBias},set:function(e){if(this._normalOffsetBias!==e){var t=!this._normalOffsetBias&&e||this._normalOffsetBias&&!e;this._normalOffsetBias=e,t&&this.updateKey();}}},{key:"falloffMode",get:function(){return this._falloffMode},set:function(e){this._falloffMode!==e&&(this._falloffMode=e,this.updateKey(),this.updateClusteredFlags());}},{key:"innerConeAngle",get:function(){return this._innerConeAngle},set:function(e){this._innerConeAngle!==e&&(this._innerConeAngle=e,this._innerConeAngleCos=Math.cos(e*Math.PI/180),this.updateClusterData(false,true),this._usePhysicalUnits&&this._updateLinearColor());}},{key:"outerConeAngle",get:function(){return this._outerConeAngle},set:function(e){this._outerConeAngle!==e&&(this._outerConeAngle=e,this._updateOuterAngle(e),this._usePhysicalUnits&&this._updateLinearColor());}},{key:"penumbraSize",get:function(){return this._penumbraSize},set:function(e){this._penumbraSize=e,this._softShadowParams[2]=e;}},{key:"penumbraFalloff",get:function(){return this._softShadowParams[3]},set:function(e){this._softShadowParams[3]=e;}},{key:"intensity",get:function(){return this._intensity},set:function(e){this._intensity!==e&&(this._intensity=e,this._updateLinearColor());}},{key:"affectSpecularity",get:function(){return this._affectSpecularity},set:function(e){0===this._type&&(this._affectSpecularity=e,this.updateKey());}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance!==e&&(this._luminance=e,this._updateLinearColor());}},{key:"cookieMatrix",get:function(){return this._cookieMatrix||(this._cookieMatrix=new e$),this._cookieMatrix}},{key:"atlasViewport",get:function(){return this._atlasViewport||(this._atlasViewport=new eY(0,0,1,1)),this._atlasViewport}},{key:"cookie",get:function(){return this._cookie},set:function(e){this._cookie!==e&&(this._cookie=e,this.updateKey());}},{key:"cookieFalloff",get:function(){return this._cookieFalloff},set:function(e){this._cookieFalloff!==e&&(this._cookieFalloff=e,this.updateKey());}},{key:"cookieChannel",get:function(){return this._cookieChannel},set:function(e){if(this._cookieChannel!==e){if(e.length<3)for(var t=e.charAt(e.length-1),n=3-e.length,i=0;i<n;i++)e+=t;this._cookieChannel=e,this.updateKey(),this.updateClusteredFlags();}}},{key:"cookieTransform",get:function(){return this._cookieTransform},set:function(e){this._cookieTransform!==e&&(this._cookieTransform=e,this._cookieTransformSet=!!e,e&&!this._cookieOffset&&(this.cookieOffset=new eX,this._cookieOffsetSet=false),this.updateKey());}},{key:"cookieOffset",get:function(){return this._cookieOffset},set:function(e){this._cookieOffset!==e&&((this._cookieTransformSet||e)&&!e&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=e,this._cookieOffsetSet=!!e,e&&!this._cookieTransform&&(this.cookieTransform=new eY(1,1,0,0),this._cookieTransformSet=false),this.updateKey());}}]),e}(),c9=function(){var e;function t(e,t,n){this._areaLightsEnabled=false,this._cells=new eW(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=true,this._shadowType=0,this._shadowAtlasResolution=2048,this._cookiesEnabled=false,this._cookieAtlasResolution=2048,this.atlasSplit=null,this._supportsAreaLights=e,this._maxTextureSize=t,this._dirtyLightsFnc=n;}return t.prototype.applySettings=function(e){var t,n,i,r,s,a,o;this.shadowsEnabled=null!=(t=e.lightingShadowsEnabled)?t:this.shadowsEnabled,this.cookiesEnabled=null!=(n=e.lightingCookiesEnabled)?n:this.cookiesEnabled,this.areaLightsEnabled=null!=(i=e.lightingAreaLightsEnabled)?i:this.areaLightsEnabled,this.shadowAtlasResolution=null!=(r=e.lightingShadowAtlasResolution)?r:this.shadowAtlasResolution,this.cookieAtlasResolution=null!=(s=e.lightingCookieAtlasResolution)?s:this.cookieAtlasResolution,this.maxLightsPerCell=null!=(a=e.lightingMaxLightsPerCell)?a:this.maxLightsPerCell,this.shadowType=null!=(o=e.lightingShadowType)?o:this.shadowType,e.lightingCells&&(this.cells=new eW(e.lightingCells));},e=[{key:"cells",get:function(){return this._cells},set:function(e){this._cells.copy(e);}},{key:"maxLightsPerCell",get:function(){return this._maxLightsPerCell},set:function(e){this._maxLightsPerCell=ek.clamp(e,1,255);}},{key:"cookieAtlasResolution",get:function(){return this._cookieAtlasResolution},set:function(e){this._cookieAtlasResolution=ek.clamp(e,32,this._maxTextureSize);}},{key:"shadowAtlasResolution",get:function(){return this._shadowAtlasResolution},set:function(e){this._shadowAtlasResolution=ek.clamp(e,32,this._maxTextureSize);}},{key:"shadowType",get:function(){return this._shadowType},set:function(e){this._shadowType!==e&&(this._shadowType=e,this._dirtyLightsFnc());}},{key:"cookiesEnabled",get:function(){return this._cookiesEnabled},set:function(e){this._cookiesEnabled!==e&&(this._cookiesEnabled=e,this._dirtyLightsFnc());}},{key:"areaLightsEnabled",get:function(){return this._areaLightsEnabled},set:function(e){this._supportsAreaLights&&this._areaLightsEnabled!==e&&(this._areaLightsEnabled=e,this._dirtyLightsFnc());}},{key:"shadowsEnabled",get:function(){return this._shadowsEnabled},set:function(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this._dirtyLightsFnc());}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}(),c7=function(){function e(e){var t=this;this.morph=e,e.incRefCount(),this.device=e.device;var n=e._targets.length;this.shader=this._createShader(n),this._weights=[],this._weightMap=new Map;for(var i=0;i<e._targets.length;i++){var r=e._targets[i];r.name&&this._weightMap.set(r.name,i),this.setWeight(i,r.defaultWeight);}this._shaderMorphWeights=new Float32Array(n),this._shaderMorphIndex=new Uint32Array(n);var s=function(n,i){return t[i]=e._createTexture(n,e._renderTextureFormat),new il({colorBuffer:t[i],depth:false})};e.morphPositions&&(this.rtPositions=s("MorphRTPos","texturePositions")),e.morphNormals&&(this.rtNormals=s("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([e.morphTextureWidth,e.morphTextureHeight]);var a=e.aabb.halfExtents;this._aabbSize=new Float32Array([4*a.x,4*a.y,4*a.z]);var o=e.aabb.getMin();this._aabbMin=new Float32Array([2*o.x,2*o.y,2*o.z]),this._aabbNrmSize=new Float32Array([2,2,2]),this._aabbNrmMin=new Float32Array([-1,-1,-1]),this.aabbSizeId=this.device.scope.resolve("aabbSize"),this.aabbMinId=this.device.scope.resolve("aabbMin"),this.morphTextureId=this.device.scope.resolve("morphTexture"),this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.morphIndex=this.device.scope.resolve("morphIndex[0]"),this.countId=this.device.scope.resolve("count"),this.zeroTextures=false;}var t=e.prototype;return t.destroy=function(){this.shader=null;var e,t,n,i,r=this.morph;r&&(this.morph=null,r.decRefCount(),r.refCount<1&&r.destroy()),null==(e=this.rtPositions)||e.destroy(),this.rtPositions=null,null==(t=this.texturePositions)||t.destroy(),this.texturePositions=null,null==(n=this.rtNormals)||n.destroy(),this.rtNormals=null,null==(i=this.textureNormals)||i.destroy(),this.textureNormals=null;},t.clone=function(){return new e(this.morph)},t._getWeightIndex=function(e){return "string"==typeof e?this._weightMap.get(e):e},t.getWeight=function(e){var t=this._getWeightIndex(e);return this._weights[t]},t.setWeight=function(e,t){var n=this._getWeightIndex(e);this._weights[n]=t,this._dirty=true;},t._createShader=function(e){var t=new Map;t.set("{MORPH_TEXTURE_MAX_COUNT}",e),this.morph.intRenderFormat&&t.set("MORPH_INT","");var n=this.morph.intRenderFormat?"uvec4":"vec4";return o8.createShader(this.device,{uniqueName:"TextureMorphShader_"+e+"-"+(this.morph.intRenderFormat?"int":"float"),attributes:{vertex_position:tT},vertexChunk:"morphVS",fragmentChunk:"morphPS",fragmentDefines:t,fragmentOutputTypes:[n]})},t._updateTextureRenderTarget=function(e,t,n){var i=this.morph,r=this.device;this.setAabbUniforms(n),this.morphTextureId.setValue(n?i.targetsTexturePositions:i.targetsTextureNormals),r.setBlendState(nj.NOBLEND),this.countId.setValue(t),this.morphFactor.setValue(this._shaderMorphWeights),this.morphIndex.setValue(this._shaderMorphIndex),ls(r,e,this.shader);},t._updateTextureMorph=function(e){this.device,(e>0||!this.zeroTextures)&&(this.rtPositions&&this._updateTextureRenderTarget(this.rtPositions,e,true),this.rtNormals&&this._updateTextureRenderTarget(this.rtNormals,e,false),this.zeroTextures=0===e);},t.setAabbUniforms=function(e){ void 0===e&&(e=true),this.aabbSizeId.setValue(e?this._aabbSize:this._aabbNrmSize),this.aabbMinId.setValue(e?this._aabbMin:this._aabbNrmMin);},t.prepareRendering=function(e){this.setAabbUniforms();},t.update=function(){this._dirty=false;for(var e=this.morph._targets,t=this._shaderMorphWeights,n=this._shaderMorphIndex,i=0,r=0;r<e.length;r++)Math.abs(this.getWeight(r))>1e-5&&(t[i]=this.getWeight(r),n[i]=r,i++);this._updateTextureMorph(i);},e}(),he=function(){function e(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=false;}var t=e.prototype;return t.getGraph=function(){return this.graph},t.setGraph=function(e){this.graph=e;},t.getCameras=function(){return this.cameras},t.setCameras=function(e){this.cameras=e;},t.getLights=function(){return this.lights},t.setLights=function(e){this.lights=e;},t.getMaterials=function(){for(var e=[],t=0;t<this.meshInstances.length;t++){var n=this.meshInstances[t];-1===e.indexOf(n.material)&&e.push(n.material);}return e},t.clone=function(){for(var t=[],n=[],i=function(e){var r=e.clone();t.push(e),n.push(r);for(var s=0;s<e._children.length;s++)r.addChild(i(e._children[s]));return r},r=i(this.graph),s=[],a=[],o=[],l=0;l<this.skinInstances.length;l++){for(var u=this.skinInstances[l].skin,c=new lu(u),h=[],f=0;f<u.boneNames.length;f++){var d=u.boneNames[f],p=r.findByName(d);h.push(p);}c.bones=h,a.push(c);}for(var m=0;m<this.morphInstances.length;m++){var _=new c7(this.morphInstances[m].morph);o.push(_);}for(var v=0;v<this.meshInstances.length;v++){var g=this.meshInstances[v],y=t.indexOf(g.node),S=new lL(g.mesh,g.material,n[y]);g.skinInstance&&(S.skinInstance=a[this.skinInstances.indexOf(g.skinInstance)]),g.morphInstance&&(S.morphInstance=o[this.morphInstances.indexOf(g.morphInstance)]),s.push(S);}var x=new e;return x.graph=r,x.meshInstances=s,x.skinInstances=a,x.morphInstances=o,x.getGraph().syncHierarchy(),x},t.destroy=function(){for(var e=this.meshInstances,t=0;t<e.length;t++)e[t].destroy();this.meshInstances.length=0;},t.generateWireframe=function(){lL._prepareRenderStyleForArray(this.meshInstances,1);},e}();function ht(e,t){return (ht=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var hn=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i){var r,s,a=(void 0===i?{}:i).preferHighPrecision;(r=e.call(this)||this).device=n,r.preferHighPrecision=void 0!==a&&a,r._targets=t.slice();var o=n.textureHalfFloatRenderable?12:void 0,l=n.textureFloatRenderable?14:void 0;return r._renderTextureFormat=r.preferHighPrecision?null!=l?l:o:null!=o?o:l,r._renderTextureFormat=null!=(s=r._renderTextureFormat)?s:47,r.intRenderFormat=tg(r._renderTextureFormat),r._textureFormat=r.preferHighPrecision?14:12,r._init(),r._updateMorphFlags(),r}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&ht(t,e);var n,i=t.prototype;return i.destroy=function(){var e,t,n;null==(e=this.vertexBufferIds)||e.destroy(),this.vertexBufferIds=null,null==(t=this.targetsTexturePositions)||t.destroy(),this.targetsTexturePositions=null,null==(n=this.targetsTextureNormals)||n.destroy(),this.targetsTextureNormals=null;},i._init=function(){this._initTextureBased();for(var e=0;e<this._targets.length;e++)this._targets[e]._postInit();},i._findSparseSet=function(e,t,n){for(var i=1,r=e[0].length,s=0;s<r;s+=3){for(var a=false,o=0;o<e.length;o++){var l=e[o];if(0!==l[s]||0!==l[s+1]||0!==l[s+2]){a=true;break}}a?(t.push(i),n.push(s/3),i++):t.push(0);}return i},i._initTextureBased=function(){for(var e=[],t=[],n=this._targets,i=0;i<n.length;i++){var r=n[i];r.options.deltaPositions&&(e.push(r.options.deltaPositions),t.push(true)),r.options.deltaNormals&&(e.push(r.options.deltaNormals),t.push(false));}var s=[],a=[],o=this._findSparseSet(e,s,a),l=this.device.maxTextureSize,u=Math.ceil(Math.sqrt(o)),c=Math.ceil(o/(u=Math.min(u,l)));if(!(c>l)){this.morphTextureWidth=u,this.morphTextureHeight=c;var h=false,f=eG.float2Half;12===this._textureFormat&&(h=true);for(var d=[],p=[],m=u*c*4,_=0;_<e.length;_++){var v=e[_],g=12===this._textureFormat?new Uint16Array(m):new Float32Array(m);if((t[_]?d:p).push(g),h)for(var y=0;y<a.length;y++){var S=3*a[y],x=4*y+4;g[x]=f(v[S]),g[x+1]=f(v[S+1]),g[x+2]=f(v[S+2]);}else for(var b=0;b<a.length;b++){var T=3*a[b],E=4*b+4;g[E]=v[T],g[E+1]=v[T+1],g[E+2]=v[T+2];}}d.length>0&&(this.targetsTexturePositions=this._createTexture("MorphPositionsTexture",this._textureFormat,n.length,[d])),p.length>0&&(this.targetsTextureNormals=this._createTexture("MorphNormalsTexture",this._textureFormat,n.length,[p]));var w=[{semantic:t$,components:1,type:5,asInt:true}];return this.vertexBufferIds=new n1(this.device,new n6(this.device,w,s.length),s.length,{data:new Uint32Array(s)}),true}},i._updateMorphFlags=function(){this._morphPositions=false,this._morphNormals=false;for(var e=0;e<this._targets.length;e++){var t=this._targets[e];t.morphPositions&&(this._morphPositions=true),t.morphNormals&&(this._morphNormals=true);}},i._createTexture=function(e,t,n,i){return new nO(this.device,{levels:i,arrayLength:n,width:this.morphTextureWidth,height:this.morphTextureHeight,format:t,cubemap:false,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1,name:e})},n=[{key:"aabb",get:function(){if(!this._aabb){for(var e=new eW,t=new eW,n=0;n<this._targets.length;n++){var i=this._targets[n].aabb;e.min(i.getMin()),t.max(i.getMax());}this._aabb=new e8,this._aabb.setMinMax(e,t);}return this._aabb}},{key:"morphPositions",get:function(){return this._morphPositions}},{key:"morphNormals",get:function(){return this._morphNormals}},{key:"targets",get:function(){return this._targets}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(iF),hi=function(){function e(e){this.used=false,this.options=e,this._name=e.name,this._defaultWeight=e.defaultWeight||0,this._aabb=e.aabb,this.deltaPositions=e.deltaPositions,this.morphPositions=!!e.deltaPositions,this.morphNormals=!!e.deltaNormals;}var t,n=e.prototype;return n.clone=function(){return new e(this.options)},n._postInit=function(){this.options.preserveData||(this.options=null),this.used=true;},t=[{key:"name",get:function(){return this._name}},{key:"defaultWeight",get:function(){return this._defaultWeight}},{key:"aabb",get:function(){return !this._aabb&&(this._aabb=new e8,this.deltaPositions&&this._aabb.compute(this.deltaPositions)),this._aabb}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),hr=1,hs=new e$,ha=new e$,ho=new eW,hl=new eW,hu=new eW,hc=new eW,hh=new eW,hf=new eW,hd=new eW,hp=new eW,hm=new eW,h_=new eW,hv=new eW,hg=new eW,hy=new eW;function hS(e){return e-Math.floor(e)}function hx(e,t){return e-t*Math.floor(e/t)}function hb(e){var t=hS(e),n=hS(255*e);return [t-=n/255,n-=n/255]}var hT=function(){function e(e){this._emitter=e;}var t=e.prototype;return t.calcSpawnPosition=function(e,t,n,i,r){var s=this._emitter,a=Math.random(),o=Math.random(),l=Math.random(),u=Math.random();if(s.useCpu&&(e[4*r+0+2*s.numParticlesPot*4]=a,e[4*r+1+2*s.numParticlesPot*4]=o,e[4*r+2+2*s.numParticlesPot*4]=l),hl.x=a-.5,hl.y=o-.5,hl.z=l-.5,0===s.emitterShape){var c=Math.max(Math.abs(hl.x),Math.max(Math.abs(hl.y),Math.abs(hl.z))),h=c+(.5-c)*n[0],f=c+(.5-c)*n[1],d=c+(.5-c)*n[2];hl.x=h*(c===Math.abs(hl.x)?Math.sign(hl.x):2*hl.x),hl.y=f*(c===Math.abs(hl.y)?Math.sign(hl.y):2*hl.y),hl.z=d*(c===Math.abs(hl.z)?Math.sign(hl.z):2*hl.z),s.localSpace?ho.copy(t.transformPoint(hl)):ho.copy(i).add(t.transformPoint(hl));}else {hl.normalize();var p=0===s.emitterRadius?0:s.emitterRadiusInner/s.emitterRadius,m=u*(1-p)+p;s.localSpace?ho.copy(hl.mulScalar(m*s.emitterRadius)):ho.copy(i).add(hl.mulScalar(m*s.emitterRadius));}var _=-ek.lerp(s.rate,s.rate2,a)*r;if(s.pack8){var v,g,y,S,x,b=(ho.x-s.worldBounds.center.x)/s.worldBoundsSize.x+.5,T=(ho.y-s.worldBounds.center.y)/s.worldBoundsSize.y+.5,E=(ho.z-s.worldBounds.center.z)/s.worldBoundsSize.z+.5,w=ek.lerp(s.startAngle*ek.DEG_TO_RAD,s.startAngle2*ek.DEG_TO_RAD,a);w=w%(2*Math.PI)/(2*Math.PI);var A=hb(b);e[4*r]=A[0],e[4*r+1]=A[1];var C=hb(T);e[4*r+2]=C[0],e[4*r+3]=C[1];var P=hb(E);e[4*r+0+4*s.numParticlesPot]=P[0],e[4*r+1+4*s.numParticlesPot]=P[1];var I=hb(w);e[4*r+2+4*s.numParticlesPot]=I[0],e[4*r+3+4*s.numParticlesPot]=I[1],e[4*r+3+4*s.numParticlesPot*2]=1;var L=Math.max(s.lifetime,(s.numParticles-1)*Math.max(s.rate,s.rate2)),D=(g=hS(v=_=(_+L)/(L+(s.lifetime+1))),y=hS(255*v),S=hS(65025*v),x=hS(0x99246ff*v),[g-=y/255,y-=S/255,S-=x/255,x-=x/255]);e[4*r+0+4*s.numParticlesPot*3]=D[0],e[4*r+1+4*s.numParticlesPot*3]=D[1],e[4*r+2+4*s.numParticlesPot*3]=D[2],e[4*r+3+4*s.numParticlesPot*3]=D[3];}else e[4*r]=ho.x,e[4*r+1]=ho.y,e[4*r+2]=ho.z,e[4*r+3]=ek.lerp(s.startAngle*ek.DEG_TO_RAD,s.startAngle2*ek.DEG_TO_RAD,a),e[4*r+3+4*s.numParticlesPot]=_;},t.update=function(e,t,n,i,r,s,a,o){var l,u,c,h,f,d,p,m,_,v,g,y,S=this._emitter;if(S.meshInstance.node){for(var x=S.meshInstance.node.worldTransform,b=0;b<12;b++)hs.data[b]=x.data[b];ha.copy(hs),ha.invert(),hr=Math.max(Math.max((T=S.meshInstance.node.localScale).x,T.y),T.z);}s=null===S.meshInstance.node||S.localSpace?eW.ZERO:S.meshInstance.node.getPosition();for(var E=S.camera?S.camera._node.getPosition():eW.ZERO,w=S.useMesh?17:15,A=S.precision-1,C=0;C<S.numParticles;C++){var P=Math.floor(S.vbCPU[C*S.numParticleVerts*(S.useMesh?6:4)+3]),I=n[4*P+0+2*S.numParticlesPot*4];hu.x=I,hu.y=n[4*P+1+2*S.numParticlesPot*4],hu.z=n[4*P+2+2*S.numParticlesPot*4];var L=S.rate+(S.rate2-S.rate)*I,D=S.lifetime,M=n[4*P+3+4*S.numParticlesPot]+a,R=Math.max(Math.min(M/D,1),0),O=0,k=0;(M-a<=0||M>=D)&&this.calcSpawnPosition(n,i,r,s,P);var N=M>0&&M<D;N&&(h=Math.floor(c=R*A),f=Math.ceil(c),c%=1,d=(l=S.qRotSpeed[h])+((u=S.qRotSpeed[f])-l)*c,p=(l=S.qRotSpeed2[h])+((u=S.qRotSpeed2[f])-l)*c,O=(l=S.qScale[h])+((u=S.qScale[f])-l)*c,m=(l=S.qScale2[h])+((u=S.qScale2[f])-l)*c,_=(l=S.qAlpha[h])+((u=S.qAlpha[f])-l)*c,v=(l=S.qAlpha2[h])+((u=S.qAlpha2[f])-l)*c,g=(l=S.qRadialSpeed[h])+((u=S.qRadialSpeed[f])-l)*c,y=(l=S.qRadialSpeed2[h])+((u=S.qRadialSpeed2[f])-l)*c,g+=100*I%1*(y-g),hc.x=n[4*P],hc.y=n[4*P+1],hc.z=n[4*P+2],S.localSpace?hm.copy(hc):hm.copy(hc).sub(s),hm.normalize().mulScalar(g),h*=3,f*=3,l=S.qLocalVelocity[h],u=S.qLocalVelocity[f],hf.x=l+(u-l)*c,l=S.qLocalVelocity[h+1],u=S.qLocalVelocity[f+1],hf.y=l+(u-l)*c,l=S.qLocalVelocity[h+2],u=S.qLocalVelocity[f+2],hf.z=l+(u-l)*c,l=S.qLocalVelocity2[h],u=S.qLocalVelocity2[f],hp.x=l+(u-l)*c,l=S.qLocalVelocity2[h+1],u=S.qLocalVelocity2[f+1],hp.y=l+(u-l)*c,l=S.qLocalVelocity2[h+2],u=S.qLocalVelocity2[f+2],hp.z=l+(u-l)*c,l=S.qVelocity[h],u=S.qVelocity[f],hh.x=l+(u-l)*c,l=S.qVelocity[h+1],u=S.qVelocity[f+1],hh.y=l+(u-l)*c,l=S.qVelocity[h+2],u=S.qVelocity[f+2],hh.z=l+(u-l)*c,l=S.qVelocity2[h],u=S.qVelocity2[f],hd.x=l+(u-l)*c,l=S.qVelocity2[h+1],u=S.qVelocity2[f+1],hd.y=l+(u-l)*c,l=S.qVelocity2[h+2],u=S.qVelocity2[f+2],hd.z=l+(u-l)*c,hf.x+=(hp.x-hf.x)*hu.x,hf.y+=(hp.y-hf.y)*hu.y,hf.z+=(hp.z-hf.z)*hu.z,S.initialVelocity>0&&(1===S.emitterShape?(hl.copy(hu).mulScalar(2).sub(eW.ONE).normalize(),hf.add(hl.mulScalar(S.initialVelocity))):hf.add(eW.FORWARD.mulScalar(S.initialVelocity))),hh.x+=(hd.x-hh.x)*hu.x,hh.y+=(hd.y-hh.y)*hu.y,hh.z+=(hd.z-hh.z)*hu.z,d+=(p-d)*hu.y,O=(O+1e4*I%1*(m-O))*hr,k=1e3*I%1*(v-_),S.meshInstance.node&&(S.localSpace?(hf.x/=T.x,hf.y/=T.y,hf.z/=T.z):hs.transformPoint(hf,hf)),S.localSpace?(ha.transformPoint(hh,hh),hf.add(hh).add(hm)):(hf.add(hh.mul(T)),hf.add(hm.mul(T))),hg.copy(hf),h_.copy(hc).add(hf.mulScalar(a)),hv.copy(h_),n[4*P]=hv.x,n[4*P+1]=hv.y,n[4*P+2]=hv.z,n[4*P+3]+=d*a,S.wrap&&S.wrapBounds&&(S.localSpace||hv.sub(s),hv.x=hx(hv.x,S.wrapBounds.x)-.5*S.wrapBounds.x,hv.y=hx(hv.y,S.wrapBounds.y)-.5*S.wrapBounds.y,hv.z=hx(hv.z,S.wrapBounds.z)-.5*S.wrapBounds.z,S.localSpace||hv.add(s)),S.sort>0&&(1===S.sort?(hy.copy(hv).sub(E),S.particleDistance[P]=-(hy.x*hy.x+hy.y*hy.y+hy.z*hy.z)):2===S.sort?S.particleDistance[P]=M:3===S.sort&&(S.particleDistance[P]=-M))),o?M<0&&(n[4*P+3+2*S.numParticlesPot*4]=-1):(M>=D&&(M-=Math.max(D,(S.numParticles-1)*L),n[4*P+3+2*S.numParticlesPot*4]=S.loop?1:-1),M<0&&S.loop&&(n[4*P+3+2*S.numParticlesPot*4]=1)),n[4*P+3+2*S.numParticlesPot*4]<0&&(N=false),n[4*P+3+4*S.numParticlesPot]=M;for(var F=0;F<S.numParticleVerts;F++){var B=(C*S.numParticleVerts+F)*(S.useMesh?6:4),U=S.vbCPU[B],z=S.vbCPU[B+1],V=S.vbCPU[B+2];N||(U=z=V=0);var G=C*S.numParticleVerts*w+F*w;e[G]=hv.x,e[G+1]=hv.y,e[G+2]=hv.z,e[G+3]=R,e[G+4]=S.alignToMotion?0:n[4*P+3],e[G+5]=O,e[G+6]=k,e[G+7]=hg.x,e[G+8]=U,e[G+9]=z,e[G+10]=V,e[G+11]=hg.y,e[G+12]=P,e[G+13]=hg.z,e[G+14]=S.vbCPU[B+3],S.useMesh&&(e[G+15]=S.vbCPU[B+4],e[G+16]=S.vbCPU[B+5]);}}if(S.sort>0&&S.camera){for(var H=S.useMesh?6:4,W=S.particleDistance,j=0;j<S.numParticles;j++)t[j][0]=j,t[j][1]=W[Math.floor(S.vbCPU[j*S.numParticleVerts*H+3])];S.vbOld.set(S.vbCPU),t.sort(function(e,t){return e[1]-t[1]});for(var X=0;X<S.numParticles;X++)for(var Y=t[X][0]*S.numParticleVerts*H,q=X*S.numParticleVerts*H,K=0;K<S.numParticleVerts*H;K++)S.vbCPU[q+K]=S.vbOld[Y+K];}},e}(),hE=new ej,hw=new ej,hA=new ej,hC=function(){function e(e,t){this._emitter=e,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=t.scope.resolve("particleTexIN"),this.constantParticleTexOUT=t.scope.resolve("particleTexOUT"),this.constantEmitterPos=t.scope.resolve("emitterPos"),this.constantEmitterScale=t.scope.resolve("emitterScale"),this.constantSpawnBounds=t.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=t.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=t.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=t.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=t.scope.resolve("initialVelocity"),this.constantFrameRandom=t.scope.resolve("frameRandom"),this.constantDelta=t.scope.resolve("delta"),this.constantRate=t.scope.resolve("rate"),this.constantRateDiv=t.scope.resolve("rateDiv"),this.constantLifetime=t.scope.resolve("lifetime"),this.constantGraphSampleSize=t.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=t.scope.resolve("graphNumSamples"),this.constantInternalTex0=t.scope.resolve("internalTex0"),this.constantInternalTex1=t.scope.resolve("internalTex1"),this.constantInternalTex2=t.scope.resolve("internalTex2"),this.constantInternalTex3=t.scope.resolve("internalTex3"),this.constantEmitterMatrix=t.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=t.scope.resolve("emitterMatrixInv"),this.constantNumParticles=t.scope.resolve("numParticles"),this.constantNumParticlesPot=t.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=t.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=t.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=t.scope.resolve("rotSpeedDivMult"),this.constantSeed=t.scope.resolve("seed"),this.constantStartAngle=t.scope.resolve("startAngle"),this.constantStartAngle2=t.scope.resolve("startAngle2"),this.constantOutBoundsMul=t.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=t.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=t.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=t.scope.resolve("inBoundsCenter"),this.constantMaxVel=t.scope.resolve("maxVel"),this.constantFaceTangent=t.scope.resolve("faceTangent"),this.constantFaceBinorm=t.scope.resolve("faceBinorm");}var t=e.prototype;return t._setInputBounds=function(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform);},t.randomize=function(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random();},t.update=function(e,t,n,i,r){var s=this._emitter;e.setBlendState(nj.NOBLEND),e.setDepthState(nq.NODEPTH),e.setCullMode(0),this.randomize(),this.constantGraphSampleSize.setValue(1/s.precision),this.constantGraphNumSamples.setValue(s.precision),this.constantNumParticles.setValue(s.numParticles),this.constantNumParticlesPot.setValue(s.numParticlesPot),this.constantInternalTex0.setValue(s.internalTex0),this.constantInternalTex1.setValue(s.internalTex1),this.constantInternalTex2.setValue(s.internalTex2),this.constantInternalTex3.setValue(s.internalTex3);var a=s.meshInstance.node,o=null===a?eW.ONE:a.localScale;if(s.pack8){this.worldBoundsMulUniform[0]=s.worldBoundsMul.x,this.worldBoundsMulUniform[1]=s.worldBoundsMul.y,this.worldBoundsMulUniform[2]=s.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=s.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=s.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=s.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();var l=s.maxVel*Math.max(Math.max(o.x,o.y),o.z);l=Math.max(l,1),this.constantMaxVel.setValue(l);}var u=null===a||s.localSpace?eW.ZERO:a.getPosition(),c=null===a?e$.IDENTITY:a.getWorldTransform();0===s.emitterShape?(hE.setFromMat4(t),this.constantSpawnBounds.setValue(hE.data),this.constantSpawnPosInnerRatio.setValue(n)):(this.constantSpawnBoundsSphere.setValue(s.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(0===s.emitterRadius?0:s.emitterRadiusInner/s.emitterRadius)),this.constantInitialVelocity.setValue(s.initialVelocity),hw.setFromMat4(c),hA.invertMat4(c),this.emitterPosUniform[0]=u.x,this.emitterPosUniform[1]=u.y,this.emitterPosUniform[2]=u.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(i),this.constantRate.setValue(s.rate),this.constantRateDiv.setValue(s.rate2-s.rate),this.constantStartAngle.setValue(s.startAngle*ek.DEG_TO_RAD),this.constantStartAngle2.setValue(s.startAngle2*ek.DEG_TO_RAD),this.constantSeed.setValue(s.seed),this.constantLifetime.setValue(s.lifetime),this.emitterScaleUniform[0]=o.x,this.emitterScaleUniform[1]=o.y,this.emitterScaleUniform[2]=o.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(hw.data),this.constantEmitterMatrixInv.setValue(hA.data),this.constantLocalVelocityDivMult.setValue(s.localVelocityUMax),this.constantVelocityDivMult.setValue(s.velocityUMax),this.constantRotSpeedDivMult.setValue(s.rotSpeedUMax[0]);var h=s.swapTex?s.particleTexOUT:s.particleTexIN;h=s.beenReset?s.particleTexStart:h;var f=s.swapTex?s.particleTexIN:s.particleTexOUT;this.constantParticleTexIN.setValue(h),ls(e,s.swapTex?s.rtParticleTexIN:s.rtParticleTexOUT,r?s.shaderParticleUpdateOnStop:s.loop?s.shaderParticleUpdateRespawn:s.shaderParticleUpdateNoRespawn),s.material.setParameter("particleTexOUT",h),s.material.setParameter("particleTexIN",f),s.beenReset=false,s.swapTex=!s.swapTex,s.prevWorldBoundsSize.copy(s.worldBoundsSize),s.prevWorldBoundsCenter.copy(s.worldBounds.center),s.pack8&&this._setInputBounds();},e}();function hP(e,t){return (hP=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var hI=["NONE","VERTEX","MAP"],hL=new(function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){return e.apply(this,arguments)||this}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&hP(t,e);var n=t.prototype;return n.generateKey=function(e){var t="particle_"+oV.definesHash(e.defines)+"_";for(var n in e)e.hasOwnProperty(n)&&(t+=e[n]);return t},n.createVertexDefines=function(e,t){var n=new Map(e.defines);return e.mesh&&n.set("USE_MESH",""),e.meshUv&&n.set("USE_MESH_UV",""),e.localSpace&&n.set("LOCAL_SPACE",""),e.screenSpace&&n.set("SCREEN_SPACE",""),e.animTex&&n.set("ANIMTEX",""),e.soft>0&&n.set("SOFT",""),e.stretch>0&&n.set("STRETCH",""),e.customFace&&n.set("CUSTOM_FACE",""),e.pack8&&n.set("PACK8",""),e.localSpace&&n.set("LOCAL_SPACE",""),e.animTexLoop&&n.set("ANIMTEX_LOOP",""),e.wrap&&n.set("WRAP",""),e.alignToMotion&&n.set("ALIGN_TO_MOTION",""),n.set("NORMAL",hI[e.normal]),t.particle_vertexData=tT,e.mesh&&e.meshUv&&(t.particle_uv=tL),e.useCpu&&(t.particle_vertexData2=tU,t.particle_vertexData3=tz,t.particle_vertexData4=tV,t.particle_vertexData5=tG),n},n.createFragmentDefines=function(e){var t=new Map(e.defines);return e.soft>0&&t.set("SOFT",""),e.halflambert&&t.set("HALF_LAMBERT",""),t.set("NORMAL",hI[e.normal]),t.set("BLEND",ot[e.blend]),t},n.createShaderDefinition=function(e,t){var n=e.isWebGPU?ni:nn,i=o0.get(e,n),r={},s=this.createVertexDefines(t,r),a=this.createFragmentDefines(t),o="PARTICLE_"+(t.useCpu?"CPU":"GPU")+"\n";s.set(o,""),a.set(o,"");var l=new Map(i);return rQ.createDefinition(e,{name:"ParticleShader",shaderLanguage:n,attributes:r,vertexCode:i.get("particle_shaderVS"),fragmentCode:i.get("particle_shaderPS"),fragmentDefines:a,fragmentIncludes:l,vertexIncludes:l,vertexDefines:s})},t}(oV));function hD(e,t){return (hD=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var hM=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this).emitter=null,n.emitter=t,n}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&hD(t,e),t.prototype.getShaderVariant=function(e){var t,n,i=e.device,r=e.scene,s=e.cameraShaderParams,a=e.objDefs,o=this.emitter,l={defines:o8.getCoreDefines(this,e),pass:0,useCpu:this.emitter.useCpu,normal:o.lighting?null!==o.normalMap?2:1:0,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,meshUv:4&a,gamma:null!=(t=null==s?void 0:s.shaderOutputGamma)?t:0,toneMap:null!=(n=null==s?void 0:s.toneMapping)?n:0,fog:r&&!this.emitter.noFog?r.fog.type:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:!o.inTools&&this.emitter.screenSpace,blend:this.emitter.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:0!==this.emitter.orientation},u=new oB(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),c=oz(i);return c.register("particle",hL),c.getProgram("particle",l,u,this.userId)},t}(uV),hR=[[-1,-1],[1,-1],[1,1],[-1,1]];function hO(e,t,n,i,r,s,a){ void 0===r&&(r=14);var o=0;a&&(7===r||20===r)&&(o=1);var l=new nO(e,{width:t,height:n,format:r,cubemap:false,mipmaps:false,minFilter:o,magFilter:o,addressU:1,addressV:1,name:"ParticleSystemTexture"}),u=l.lock();if(7===r||20===r){for(var c=new Uint8Array(i.length),h=0;h<i.length;h++)c[h]=i[h]*s*255;i=c;}return u.set(i),l.unlock(),l}function hk(e){return Math.max(Math.min(e,1),0)}var hN=new eB([0,0,1,0]),hF=new eB([0,1,1,1]),hB=new eU([0,0,1,0],[0,0,1,0],[0,0,1,0]),hU=new eU([0,1,1,1],[0,1,1,1],[0,1,1,1]),hz=2,hV=new Float32Array(3),hG=new e$,hH=new eW,hW=new eW,hj=new eW;function hX(e,t){ void 0!==w[e]&&null!==w[e]?E[e]=w[e]:E[e]=t;}function hY(e,t,n){return (255*e<<16|255*t<<8|255*n)/0x1000000}function hq(e,t){for(var n=e.length/3,i=Array(4*n),r=0;r<n;r++)i[4*r]=e[3*r],i[4*r+1]=e[3*r+1],i[4*r+2]=e[3*r+2],i[4*r+3]=hY(t[3*r],t[3*r+1],t[3*r+2]);return i}function hK(e,t){for(var n=t.length,i=e.length/n,r=0;r<i;r++)for(var s=0;s<n;s++){var a=Math.abs(e[r*n+s]);t[s]=Math.max(t[s],a);}}function hZ(e,t,n){var i=function(e,t){for(var n=new Float32Array(e.length),i=0;i<e.length;i++)n[i]=e[i]-t[i];return n}(t,e);hK(i,n);for(var r=n.length,s=i.length/r,a=0;a<s;a++)for(var o=0;o<r;o++)i[a*r+o]/=0===n[o]?1:n[o],i[a*r+o]*=.5,i[a*r+o]+=.5;return i}var hQ=new nD,hJ=function(){function e(e,t){this.material=null,this.internalTex0=null,this.internalTex1=null,this.internalTex2=null,this.colorParam=null,this.graphicsDevice=e,this.precision=32,this._addTimeTime=0,E=this,w=t,hX("numParticles",1),this.numParticles>e.maxTextureSize&&(this.numParticles=e.maxTextureSize),hX("rate",1),hX("rate2",this.rate),hX("lifetime",50),hX("emitterExtents",new eW(0,0,0)),hX("emitterExtentsInner",new eW(0,0,0)),hX("emitterRadius",0),hX("emitterRadiusInner",0),hX("emitterShape",0),hX("initialVelocity",1),hX("wrap",false),hX("localSpace",false),hX("screenSpace",false),hX("wrapBounds",null),hX("colorMap",this.defaultParamTexture),hX("normalMap",null),hX("loop",true),hX("preWarm",false),hX("sort",0),hX("mode",0),hX("scene",null),hX("lighting",false),hX("halfLambert",false),hX("intensity",1),hX("stretch",0),hX("alignToMotion",false),hX("depthSoftening",0),hX("mesh",null),hX("particleNormal",new eW(0,1,0)),hX("orientation",0),hX("depthWrite",false),hX("noFog",false),hX("blendType",2),hX("node",null),hX("startAngle",0),hX("startAngle2",this.startAngle),hX("animTilesX",1),hX("animTilesY",1),hX("animStartFrame",0),hX("animNumFrames",1),hX("animNumAnimations",1),hX("animIndex",0),hX("randomizeAnimIndex",false),hX("animSpeed",1),hX("animLoop",true),this._gpuUpdater=new hC(this,e),this._cpuUpdater=new hT(this),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),hX("colorGraph",hU),hX("colorGraph2",this.colorGraph),hX("scaleGraph",hF),hX("scaleGraph2",this.scaleGraph),hX("alphaGraph",hF),hX("alphaGraph2",this.alphaGraph),hX("localVelocityGraph",hB),hX("localVelocityGraph2",this.localVelocityGraph),hX("velocityGraph",hB),hX("velocityGraph2",this.velocityGraph),hX("rotationSpeedGraph",hN),hX("rotationSpeedGraph2",this.rotationSpeedGraph),hX("radialSpeedGraph",hN),hX("radialSpeedGraph2",this.radialSpeedGraph),this.animTilesParams=new Float32Array(2),this.animParams=new Float32Array(4),this.animIndexParams=new Float32Array(2),this.vbToSort=null,this.vbOld=null,this.particleDistance=null,this.camera=null,this.swapTex=false,this.useMesh=true,this.useCpu=!e.supportsGpuParticles,this.pack8=true,this.localBounds=new e8,this.worldBoundsNoTrail=new e8,this.worldBoundsTrail=[new e8,new e8],this.worldBounds=new e8,this.worldBoundsSize=new eW,this.prevWorldBoundsSize=new eW,this.prevWorldBoundsCenter=new eW,this.prevEmitterExtents=this.emitterExtents,this.prevEmitterRadius=this.emitterRadius,this.worldBoundsMul=new eW,this.worldBoundsAdd=new eW,this.timeToSwitchBounds=0,this.shaderParticleUpdateRespawn=null,this.shaderParticleUpdateNoRespawn=null,this.shaderParticleUpdateOnStop=null,this.numParticleVerts=0,this.numParticleIndices=0,this.material=null,this.meshInstance=null,this.drawOrder=0,this.seed=Math.random(),this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTime=0,this.simTimeTotal=0,this.beenReset=false,this._layer=null,this.rebuild();}var t,n=e.prototype;return n.onChangeCamera=function(){this.resetMaterial();},n.calculateBoundsMad=function(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).mulScalar(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5;},n.calculateWorldBounds=function(){if(this.node){if(this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),!this.useCpu){(0===this.emitterShape?this.emitterExtents.equals(this.prevEmitterExtents):this.emitterRadius===this.prevEmitterRadius)||this.calculateLocalBounds();}var t=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,t),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);var n=this.simTimeTotal;n>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=n+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,t),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,t)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad();}},n.resetWorldBounds=function(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?e$.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.simTimeTotal=0,this.timeToSwitchBounds=0);},n.calculateLocalBounds=function(){for(var e,t,n,i=Number.MAX_VALUE,r=Number.MAX_VALUE,s=Number.MAX_VALUE,a=-Number.MAX_VALUE,o=-Number.MAX_VALUE,l=-Number.MAX_VALUE,u=0,c=0,h=this.lifetime/this.precision,f=[this.qVelocity,this.qVelocity2],d=[this.qLocalVelocity,this.qLocalVelocity2],p=[0,0],m=[0,0],_=[0,0],v=[0,0],g=[0,0],y=0;y<this.precision+1;y++){for(var S=Math.min(y,this.precision-1),x=0;x<2;x++)e=d[x][3*S+0]*h+p[x],t=d[x][3*S+1]*h+m[x],n=d[x][3*S+2]*h+_[x],i=Math.min(e,i),r=Math.min(t,r),s=Math.min(n,s),a=Math.max(e,a),o=Math.max(t,o),l=Math.max(n,l),p[x]=e,m[x]=t,_[x]=n;for(var b=0;b<2;b++)g[b]+=h*Math.sqrt(f[b][3*S+0]*f[b][3*S+0]+f[b][3*S+1]*f[b][3*S+1]+f[b][3*S+2]*f[b][3*S+2]);v[0]+=this.qRadialSpeed[S]*h,v[1]+=this.qRadialSpeed2[S]*h,u=Math.max(u,Math.max(Math.abs(v[0]),Math.abs(v[1]))),c=Math.max(c,this.qScale[S]);}0===this.emitterShape?(e=.5*this.emitterExtents.x,t=.5*this.emitterExtents.y,n=.5*this.emitterExtents.z):(e=this.emitterRadius,t=this.emitterRadius,n=this.emitterRadius);var T=Math.max(g[0],g[1]);hW.x=i-c-e-u-T,hW.y=r-c-t-u-T,hW.z=s-c-n-u-T,hj.x=a+c+e+u+T,hj.y=o+c+t+u+T,hj.z=l+c+n+u+T,this.localBounds.setMinMax(hW,hj);},n.rebuild=function(){var e=this.graphicsDevice;null===this.colorMap&&(this.colorMap=this.defaultParamTexture),this.spawnBounds=0===this.emitterShape?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||this.sort>0||e.maxVertexTextures<=1||e.fragmentUniformsCount<64||e.forceCpuParticles;var t=this._destroyResources();this.pack8=(this.pack8||!e.textureFloatRenderable)&&!this.useCpu,hz=this.useCpu||this.pack8?4:2,this.useMesh=!!this.mesh,this.numParticlesPot=ek.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?e$.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=Array(this.numParticles);for(var n=0;n<this.numParticles;n++)this.vbToSort[n]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*hz*4);var i=null===this.node||this.localSpace?eW.ZERO:this.node.getPosition();0===this.emitterShape&&(null===this.node||this.localSpace?hG.setTRS(eW.ZERO,e0.IDENTITY,this.spawnBounds):hG.setTRS(eW.ZERO,this.node.getRotation(),hH.copy(this.spawnBounds).mul(this.node.localScale)),hV[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,hV[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,hV[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0);for(var r=0;r<this.numParticles;r++)this._cpuUpdater.calcSpawnPosition(this.particleTex,hG,hV,i,r),this.useCpu&&(this.particleTex[4*r+3+2*this.numParticlesPot*4]=1);this.particleTexStart=new Float32Array(this.numParticlesPot*hz*4);for(var s=0;s<this.particleTexStart.length;s++)this.particleTexStart[s]=this.particleTex[s];this.useCpu||(this.pack8?(this.particleTexIN=hO(e,this.numParticlesPot,hz,this.particleTex,7,1,false),this.particleTexOUT=hO(e,this.numParticlesPot,hz,this.particleTex,7,1,false),this.particleTexStart=hO(e,this.numParticlesPot,hz,this.particleTexStart,7,1,false)):(this.particleTexIN=hO(e,this.numParticlesPot,hz,this.particleTex),this.particleTexOUT=hO(e,this.numParticlesPot,hz,this.particleTex),this.particleTexStart=hO(e,this.numParticlesPot,hz,this.particleTexStart)),this.rtParticleTexIN=new il({colorBuffer:this.particleTexIN,depth:false}),this.rtParticleTexOUT=new il({colorBuffer:this.particleTexOUT,depth:false}),this.swapTex=false);var a=new Map;this.localSpace&&a.set("LOCAL_SPACE",""),this.pack8&&a.set("PACK8",""),0===this.emitterShape&&a.set("EMITTERSHAPE_BOX","");var o="Shape:"+this.emitterShape+"-Pack:"+this.pack8+"-Local:"+this.localSpace,l={attributes:{vertex_position:tT},vertexChunk:"fullscreenQuadVS",fragmentChunk:"particle_simulationPS",fragmentDefines:a,fragmentIncludes:new Map(o0.get(e,e.isWebGPU?ni:nn))};l.uniqueName="ParticleUpdateRespawn-"+o,a.set("RESPAWN",""),this.shaderParticleUpdateRespawn=o8.createShader(e,l),a.delete("RESPAWN"),l.uniqueName="ParticleUpdateNoRespawn-"+o,a.set("NO_RESPAWN",""),this.shaderParticleUpdateNoRespawn=o8.createShader(e,l),a.delete("NO_RESPAWN"),l.uniqueName="ParticleUpdateStop-"+o,a.set("ON_STOP",""),this.shaderParticleUpdateOnStop=o8.createShader(e,l),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles);var u=new l_(e);u.vertexBuffer=this.vertexBuffer,u.indexBuffer[0]=this.indexBuffer,u.primitive[0].type=4,u.primitive[0].base=0,u.primitive[0].count=this.numParticles*this.numParticleIndices,u.primitive[0].indexed=true,this.material=this._createMaterial(),this.resetMaterial(),this.meshInstance=new lL(u,this.material,this.node),this.meshInstance.pick=false,this.meshInstance.updateKey(),this.meshInstance.cull=true,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=false,this.meshInstance.visible=t,this._setMaterialTextures(),this.resetTime(),this.addTime(0,false),this.preWarm&&this.prewarm(this.lifetime);},n._isAnimated=function(){return this.animNumFrames>=1&&(this.animTilesX>1||this.animTilesY>1)&&(this.colorMap&&this.colorMap!==this.defaultParamTexture||this.normalMap)},n.rebuildGraphs=function(){var e=this.precision,t=this.graphicsDevice;this.qLocalVelocity=this.localVelocityGraph.quantize(e),this.qVelocity=this.velocityGraph.quantize(e),this.qColor=this.colorGraph.quantizeClamped(e,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(e),this.qScale=this.scaleGraph.quantize(e),this.qAlpha=this.alphaGraph.quantize(e),this.qRadialSpeed=this.radialSpeedGraph.quantize(e),this.qLocalVelocity2=this.localVelocityGraph2.quantize(e),this.qVelocity2=this.velocityGraph2.quantize(e),this.qColor2=this.colorGraph2.quantizeClamped(e,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(e),this.qScale2=this.scaleGraph2.quantize(e),this.qAlpha2=this.alphaGraph2.quantize(e),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(e);for(var n=0;n<e;n++)this.qRotSpeed[n]*=ek.DEG_TO_RAD,this.qRotSpeed2[n]*=ek.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=hZ(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=hZ(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=hZ(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=hZ(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=hZ(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=hZ(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=hZ(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){var i=[0,0,0];hK(this.qVelocity,i);var r=[0,0,0];hK(this.qVelocity2,r);var s=[0,0,0];hK(this.qLocalVelocity,s);var a=[0,0,0];hK(this.qLocalVelocity2,a);var o=[0];hK(this.qRadialSpeed,o);var l=[0];hK(this.qRadialSpeed2,l);var u=Math.max(i[0],r[0]);u=Math.max(u=Math.max(u=Math.max(u=Math.max(u,i[1]),r[1]),i[2]),r[2]);var c=Math.max(s[0],a[0]);c=Math.max(c=Math.max(c=Math.max(c=Math.max(c,s[1]),a[1]),s[2]),a[2]);var h=Math.max(o[0],l[0]);this.maxVel=u+c+h;}this.useCpu||(this.internalTex0=hO(t,e,1,hq(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=hO(t,e,1,hq(this.qVelocity,this.qVelocityDiv)),this.internalTex2=hO(t,e,1,function(e,t,n,i,r){for(var s=Array(4*e.length),a=0;a<e.length;a++)s[4*a]=e[a],s[4*a+1]=t[a],s[4*a+2]=0,s[4*a+3]=hY(n[a],i[a],r[a]);return s}(this.qRotSpeed,this.qScale,this.qScaleDiv,this.qRotSpeedDiv,this.qAlphaDiv)),this.internalTex3=hO(t,e,1,function(e,t){for(var n=Array(4*e.length),i=0;i<e.length;i++)n[4*i]=e[i],n[4*i+1]=t[i],n[4*i+2]=0,n[4*i+3]=0;return n}(this.qRadialSpeed,this.qRadialSpeedDiv))),this.colorParam=hO(t,e,1,function(e,t){for(var n=Array(4*t.length),i=0;i<t.length;i++)n[4*i]=e[3*i],n[4*i+1]=e[3*i+1],n[4*i+2]=e[3*i+2],n[4*i+3]=t[i];return n}(this.qColor,this.qAlpha),20,1,true);},n._setMaterialTextures=function(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap));},n._createMaterial=function(){var e=new hM(this);return e.name="EmitterMaterial:"+this.node.name,e.cull=0,e.alphaWrite=false,e.blendType=this.blendType,e.depthWrite=this.depthWrite,e},n.resetMaterial=function(){var e=this.material;e.setParameter("stretch",this.stretch),this._isAnimated()&&(e.setParameter("animTexTilesParams",this.animTilesParams),e.setParameter("animTexParams",this.animParams),e.setParameter("animTexIndexParams",this.animIndexParams)),e.setParameter("colorMult",this.intensity),this.useCpu||(e.setParameter("internalTex0",this.internalTex0),e.setParameter("internalTex1",this.internalTex1),e.setParameter("internalTex2",this.internalTex2),e.setParameter("internalTex3",this.internalTex3)),e.setParameter("colorParam",this.colorParam),e.setParameter("numParticles",this.numParticles),e.setParameter("numParticlesPot",this.numParticlesPot),e.setParameter("lifetime",this.lifetime),e.setParameter("rate",this.rate),e.setParameter("rateDiv",this.rate2-this.rate),e.setParameter("seed",this.seed),e.setParameter("scaleDivMult",this.scaleUMax[0]),e.setParameter("alphaDivMult",this.alphaUMax[0]),e.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),e.setParameter("graphNumSamples",this.precision),e.setParameter("graphSampleSize",1/this.precision),e.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),e.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),e.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),e.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,e.setParameter("wrapBounds",this.wrapBoundsUniform)),this._setMaterialTextures(),this.depthSoftening>0&&e.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),this.stretch>0&&(e.cull=0),this._compParticleFaceParams();},n._compParticleFaceParams=function(){if(0===this.orientation)e=new Float32Array([1,0,0]),t=new Float32Array([0,0,1]);else {var e,t,n=1===this.orientation?this.particleNormal.normalize():(null===this.node?e$.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize(),i=new eW(1,0,0);1===Math.abs(i.dot(n))&&i.set(0,0,1);var r=new eW().cross(n,i).normalize();i.cross(r,n).normalize(),e=new Float32Array([i.x,i.y,i.z]),t=new Float32Array([r.x,r.y,r.z]);}this.material.setParameter("faceTangent",e),this.material.setParameter("faceBinorm",t);},n.getVertexInfo=function(){var e=[];return this.useCpu?e.push({semantic:tB,components:4,type:6},{semantic:tU,components:4,type:6},{semantic:tz,components:4,type:6},{semantic:tV,components:1,type:6},{semantic:tG,components:this.useMesh?4:2,type:6}):(e.push({semantic:tB,components:4,type:6}),this.useMesh&&e.push({semantic:tU,components:2,type:6})),e},n._allocate=function(e){var t=e*this.numParticleVerts,n=e*this.numParticleIndices;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==t){var i,r,s,a=this.getVertexInfo(),o=new n6(this.graphicsDevice,a);this.vertexBuffer=new n1(this.graphicsDevice,o,t,{usage:1}),this.indexBuffer=new s$(this.graphicsDevice,2,n);var l=new Float32Array(this.vertexBuffer.lock());if(this.useMesh){r=(i=new Float32Array(this.mesh.vertexBuffer.lock())).length/this.mesh.vertexBuffer.numVertices;for(var u=0;u<this.mesh.vertexBuffer.format.elements.length;u++)if(this.mesh.vertexBuffer.format.elements[u].name===tL){s=this.mesh.vertexBuffer.format.elements[u].offset/4;break}}for(var c=0;c<t;c++){var h=Math.floor(c/this.numParticleVerts);if(this.useMesh){var f=c%this.numParticleVerts;l[6*c]=i[f*r],l[6*c+1]=i[f*r+1],l[6*c+2]=i[f*r+2],l[6*c+3]=h,l[6*c+4]=i[f*r+s+0],l[6*c+5]=1-i[f*r+s+1];}else {var d=c%4;l[4*c]=hR[d][0],l[4*c+1]=hR[d][1],l[4*c+2]=0,l[4*c+3]=h;}}this.useCpu&&(this.vbCPU=new Float32Array(l),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock();var p=0,m=new Uint32Array(this.indexBuffer.lock());if(this.useMesh){var _=this.mesh.indexBuffer[0];i=new nv[_.format](_.lock());}for(var v=0;v<e;v++)if(this.useMesh)for(var g=0;g<this.numParticleIndices;g++)m[v*this.numParticleIndices+g]=i[g]+v*this.numParticleVerts;else {var y=4*v;m[p++]=y,m[p++]=y+1,m[p++]=y+2,m[p++]=y,m[p++]=y+2,m[p++]=y+3;}this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock();}},n.reset=function(){if(this.beenReset=true,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(var e=0;e<this.particleTexStart.length;e++)this.particleTex[e]=this.particleTexStart[e];else this._setMaterialTextures();this.resetWorldBounds(),this.resetTime();var t=this.loop;this.loop=true,this.addTime(0,false),this.loop=t,this.preWarm&&this.prewarm(this.lifetime);},n.prewarm=function(e){for(var t=Math.min(Math.floor(e/this.lifetime*this.precision),this.precision),n=e/t,i=0;i<t;i++)this.addTime(n,false);},n.resetTime=function(){var e;this.endTime=(e=Math.max(this.rate,this.rate2)*this.numParticles+this.lifetime,Date.now()+1e3*e);},n.finishFrame=function(){this.useCpu&&this.vertexBuffer.unlock();},n.addTime=function(e,t){var n,i=this.graphicsDevice;if(this.simTimeTotal+=e,this.calculateWorldBounds(),this._isAnimated()){var r=this.animTilesParams;r[0]=1/this.animTilesX,r[1]=1/this.animTilesY;var s=this.animParams;s[0]=this.animStartFrame,s[1]=this.animNumFrames*this.animSpeed,s[2]=this.animNumFrames-1,s[3]=this.animNumAnimations-1;var a=this.animIndexParams;a[0]=this.animIndex,a[1]=this.randomizeAnimIndex;}this.scene&&this.camera!==this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),0===this.emitterShape&&(hV[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,hV[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,hV[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0,null===this.meshInstance.node?hG.setTRS(eW.ZERO,e0.IDENTITY,this.emitterExtents):hG.setTRS(eW.ZERO,this.meshInstance.node.getRotation(),hH.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));var o=null===this.meshInstance.node?eW.ONE:this.meshInstance.node.localScale;if(this.emitterScaleUniform[0]=o.x,this.emitterScaleUniform[1]=o.y,this.emitterScaleUniform[2]=o.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node&&(n=this.meshInstance.node.getPosition(),this.emitterPosUniform[0]=n.x,this.emitterPosUniform[1]=n.y,this.emitterPosUniform[2]=n.z,this.material.setParameter("emitterPos",this.emitterPosUniform)),this._compParticleFaceParams(),this.useCpu){var l=new Float32Array(this.vertexBuffer.lock());this._cpuUpdater.update(l,this.vbToSort,this.particleTex,hG,hV,n,e,t);}else this._gpuUpdater.update(i,hG,hV,e,t);!this.loop&&Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=false),this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder);},n._destroyResources=function(){null==(e=this.particleTexIN)||e.destroy(),this.particleTexIN=null,null==(t=this.particleTexOUT)||t.destroy(),this.particleTexOUT=null,this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),null==(n=this.rtParticleTexIN)||n.destroy(),this.rtParticleTexIN=null,null==(i=this.rtParticleTexOUT)||i.destroy(),this.rtParticleTexOUT=null,null==(r=this.internalTex0)||r.destroy(),this.internalTex0=null,null==(s=this.internalTex1)||s.destroy(),this.internalTex1=null,null==(a=this.internalTex2)||a.destroy(),this.internalTex2=null,null==(o=this.internalTex3)||o.destroy(),this.internalTex3=null,null==(l=this.colorParam)||l.destroy(),this.colorParam=null,this.vertexBuffer=void 0,this.indexBuffer=void 0;var e,t,n,i,r,s,a,o,l,u,c,h,f,d=null==(f=null==(u=this.meshInstance)?void 0:u.visible)||f;return null==(c=this.meshInstance)||c.destroy(),this.meshInstance=null,null==(h=this.material)||h.destroy(),this.material=null,d},n.destroy=function(){this.camera=null,this._destroyResources();},t=[{key:"defaultParamTexture",get:function(){var e=this;return hQ.get(this.graphicsDevice,function(){for(var t=new Float32Array(1024),n=0;n<16;n++)for(var i=0;i<16;i++){var r=i+1-8.5,s=n+1-8.5,a=hk(1-hk(Math.sqrt(r*r+s*s)/16)-.5),o=16*n+i;t[4*o]=1,t[4*o+1]=1,t[4*o+2]=1,t[4*o+3]=a;}var l=hO(e.graphicsDevice,16,16,t,20,1,true);return l.minFilter=1,l.magFilter=1,l})}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function h$(){return (h$=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);}return e}).apply(this,arguments)}function h0(e,t){return (h0=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var h1=new(function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){return e.apply(this,arguments)||this}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&h0(t,e);var n=t.prototype;return n.generateKey=function(e){var t,n,i=e.shaderDesc,r=i.vertexGLSL?n2(i.vertexGLSL):0,s=i.fragmentGLSL?n2(i.fragmentGLSL):0,a=i.vertexWGSL?n2(i.vertexWGSL):0,o=i.fragmentWGSL?n2(i.fragmentWGSL):0,l=oV.definesHash(e.defines),u=null!=(n=null==(t=e.shaderChunks)?void 0:t.key)?n:"",c=i.uniqueName+"_"+l+"_"+r+"_"+s+"_"+a+"_"+o+"_"+u;return e.skin&&(c+="_skin"),e.useInstancing&&(c+="_inst"),e.useMorphPosition&&(c+="_morphp"),e.useMorphNormal&&(c+="_morphn"),e.useMorphTextureBasedInt&&(c+="_morphi"),c},n.createAttributesDefinition=function(e,t){var n=t.shaderDesc.attributes,i=n?h$({},n):void 0;t.skin&&(i.vertex_boneWeights=tA,i.vertex_boneIndices=tC),(t.useMorphPosition||t.useMorphNormal)&&(i.morph_vertex_id=t$),e.attributes=i;},n.createVertexDefinition=function(e,t,n,i){var r=t.shaderDesc,s=new Map(n);s.set("transformInstancingVS","");var a=new Map(t.defines);t.skin&&a.set("SKIN",true),t.useInstancing&&a.set("INSTANCING",true),(t.useMorphPosition||t.useMorphNormal)&&(a.set("MORPHING",true),t.useMorphTextureBasedInt&&a.set("MORPHING_INT",true),t.useMorphPosition&&a.set("MORPHING_POSITION",true),t.useMorphNormal&&a.set("MORPHING_NORMAL",true)),e.vertexCode=i?r.vertexWGSL:r.vertexGLSL,e.vertexIncludes=s,e.vertexDefines=a;},n.createFragmentDefinition=function(e,t,n,i){var r=t.shaderDesc,s=new Map(n),a=new Map(t.defines);e.fragmentCode=i?r.fragmentWGSL:r.fragmentGLSL,e.fragmentIncludes=s,e.fragmentDefines=a;},n.createShaderDefinition=function(e,t){var n,i,r=t.shaderDesc,s=e.isWebGPU&&!!r.vertexWGSL&&!!r.fragmentWGSL&&(null==(i=null==(n=t.shaderChunks)?void 0:n.useWGSL)||i),a={name:"ShaderMaterial-"+r.uniqueName,shaderLanguage:s?ni:nn,fragmentOutputTypes:r.fragmentOutputTypes,meshUniformBufferFormat:r.meshUniformBufferFormat,meshBindGroupFormat:r.meshBindGroupFormat},o=s?ni:nn,l=o2.merge(o0.get(e,o),t.shaderChunks[o]);return this.createAttributesDefinition(a,t),this.createVertexDefinition(a,t,l,s),this.createFragmentDefinition(a,t,l,s),rQ.createDefinition(e,a)},t}(oV));function h2(e,t){return (h2=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var h3=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this).shaderDesc=t,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&h2(t,e);var n,i=t.prototype;return i.copy=function(t){return e.prototype.copy.call(this,t),this.shaderDesc=t.shaderDesc,this},i.getShaderVariant=function(e){var t=e.objDefs,n={defines:o8.getCoreDefines(this,e),skin:(2&t)!=0,useInstancing:(32&t)!=0,useMorphPosition:(1024&t)!=0,useMorphNormal:(2048&t)!=0,useMorphTextureBasedInt:(8192&t)!=0,pass:e.pass,gamma:e.cameraShaderParams.shaderOutputGamma,toneMapping:e.cameraShaderParams.toneMapping,fog:e.cameraShaderParams.fog,shaderDesc:this.shaderDesc,shaderChunks:this.shaderChunks},i=new oB(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),r=oz(e.device);return r.register("shader-material",h1),r.getProgram("shader-material",n,i,this.userId)},n=[{key:"shaderDesc",get:function(){return this._shaderDesc},set:function(e){if(this._shaderDesc=void 0,e&&(this._shaderDesc={uniqueName:e.uniqueName,attributes:e.attributes,fragmentOutputTypes:e.fragmentOutputTypes,vertexGLSL:e.vertexGLSL,fragmentGLSL:e.fragmentGLSL,vertexWGSL:e.vertexWGSL,fragmentWGSL:e.fragmentWGSL},e.vertexCode||e.fragmentCode||e.shaderLanguage)){var t,n=null!=(t=e.shaderLanguage)?t:nn;n===nn?(this._shaderDesc.vertexGLSL=e.vertexCode,this._shaderDesc.fragmentGLSL=e.fragmentCode):n===ni&&(this._shaderDesc.vertexWGSL=e.vertexCode,this._shaderDesc.fragmentWGSL=e.fragmentCode);}this.clearVariants();}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(uV),h4={linear:"decodeLinear",srgb:"decodeGamma",rgbm:"decodeRGBM",rgbe:"decodeRGBE",rgbp:"decodeRGBP",xy:"unpackNormalXY",xyz:"unpackNormalXYZ"},h5={linear:"encodeLinear",srgb:"encodeGamma",rgbm:"encodeRGBM",rgbe:"encodeRGBE",rgbp:"encodeRGBP"},h8=function(){function e(){}return e.decodeFunc=function(e){var t;return null!=(t=h4[e])?t:"decodeGamma"},e.encodeFunc=function(e){var t;return null!=(t=h5[e])?t:"encodeGamma"},e}(),h6=function(e,t){for(var n=t.length/3,i=e.length/3,r=new eW,s=new eW,a=new eW,o=new eW,l=new eW,u=new eW,c=[],h=0;h<e.length;h++)c[h]=0;for(var f=0;f<n;f++){var d=t[3*f],p=t[3*f+1],m=t[3*f+2];r.set(e[3*d],e[3*d+1],e[3*d+2]),s.set(e[3*p],e[3*p+1],e[3*p+2]),a.set(e[3*m],e[3*m+1],e[3*m+2]),o.sub2(s,r),l.sub2(a,r),u.cross(o,l).normalize(),c[3*d]+=u.x,c[3*d+1]+=u.y,c[3*d+2]+=u.z,c[3*p]+=u.x,c[3*p+1]+=u.y,c[3*p+2]+=u.z,c[3*m]+=u.x,c[3*m+1]+=u.y,c[3*m+2]+=u.z;}for(var _=0;_<i;_++){var v=c[3*_],g=c[3*_+1],y=c[3*_+2],S=1/Math.sqrt(v*v+g*g+y*y);c[3*_]*=S,c[3*_+1]*=S,c[3*_+2]*=S;}return c},h9=function(e,t,n,i){for(var r=i.length/3,s=e.length/3,a=new eW,o=new eW,l=new eW,u=new eX,c=new eX,h=new eX,f=new eW,d=new eW,p=new Float32Array(3*s),m=new Float32Array(3*s),_=[],v=0;v<r;v++){var g=i[3*v],y=i[3*v+1],S=i[3*v+2];a.set(e[3*g],e[3*g+1],e[3*g+2]),o.set(e[3*y],e[3*y+1],e[3*y+2]),l.set(e[3*S],e[3*S+1],e[3*S+2]),u.set(n[2*g],n[2*g+1]),c.set(n[2*y],n[2*y+1]),h.set(n[2*S],n[2*S+1]);var x=o.x-a.x,b=l.x-a.x,T=o.y-a.y,E=l.y-a.y,w=o.z-a.z,A=l.z-a.z,C=c.x-u.x,P=h.x-u.x,I=c.y-u.y,L=h.y-u.y,D=C*L-P*I;if(0===D)f.set(0,1,0),d.set(1,0,0);else {var M=1/D;f.set((L*x-I*b)*M,(L*T-I*E)*M,(L*w-I*A)*M),d.set((C*b-P*x)*M,(C*E-P*T)*M,(C*A-P*w)*M);}p[3*g+0]+=f.x,p[3*g+1]+=f.y,p[3*g+2]+=f.z,p[3*y+0]+=f.x,p[3*y+1]+=f.y,p[3*y+2]+=f.z,p[3*S+0]+=f.x,p[3*S+1]+=f.y,p[3*S+2]+=f.z,m[3*g+0]+=d.x,m[3*g+1]+=d.y,m[3*g+2]+=d.z,m[3*y+0]+=d.x,m[3*y+1]+=d.y,m[3*y+2]+=d.z,m[3*S+0]+=d.x,m[3*S+1]+=d.y,m[3*S+2]+=d.z;}for(var R=new eW,O=new eW,k=new eW,N=new eW,F=0;F<s;F++){k.set(t[3*F],t[3*F+1],t[3*F+2]),R.set(p[3*F],p[3*F+1],p[3*F+2]),O.set(m[3*F],m[3*F+1],m[3*F+2]);var B=k.dot(R);N.copy(k).mulScalar(B),N.sub2(R,N).normalize(),_[4*F]=N.x,_[4*F+1]=N.y,_[4*F+2]=N.z,N.cross(k,R),_[4*F+3]=0>N.dot(O)?-1:1;}return _},h7=function(){function e(){}var t=e.prototype;return t.calculateNormals=function(){this.normals=h6(this.positions,this.indices);},t.calculateTangents=function(){this.tangents=h9(this.positions,this.normals,this.uvs,this.indices);},e}();function fe(e,t){return (fe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ft=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){ void 0===t&&(t={});var n,i,r,s,a,o=e.call(this)||this,l=null!=(n=t.halfExtents)?n:new eW(.5,.5,.5),u=null!=(i=t.widthSegments)?i:1,c=null!=(r=t.lengthSegments)?r:1,h=null!=(s=t.heightSegments)?s:1,f=null!=(a=t.yOffset)?a:0,d=-l.y+f,p=l.y+f,m=[new eW(-l.x,d,l.z),new eW(l.x,d,l.z),new eW(l.x,p,l.z),new eW(-l.x,p,l.z),new eW(l.x,d,-l.z),new eW(-l.x,d,-l.z),new eW(-l.x,p,-l.z),new eW(l.x,p,-l.z)],_=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],v=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],g=[],y=[],S=[],x=[],b=0,T=function(e,t,n){for(var i=new eW,r=new eW,s=new eW,a=new eW,o=0;o<=t;o++)for(var l=0;l<=n;l++){i.lerp(m[_[e][0]],m[_[e][1]],o/t),r.lerp(m[_[e][0]],m[_[e][2]],l/n),s.sub2(r,m[_[e][0]]),a.add2(i,s);var u=o/t,c=l/n;g.push(a.x,a.y,a.z),y.push(v[e][0],v[e][1],v[e][2]),S.push(u,1-c),c=(.875*c+.0625)/3,u=(.875*u+.0625)/3+e%3/3,c+=Math.floor(e/3)/3,o<t&&l<n&&(x.push(b+n+1,b+1,b),x.push(b+n+1,b+n+2,b+1)),b++;}};return T(0,u,h),T(1,u,h),T(2,u,c),T(3,u,c),T(4,c,h),T(5,c,h),o.positions=g,o.normals=y,o.uvs=S,o.uvs1=S,o.indices=x,t.calculateTangents&&(o.tangents=h9(g,y,S,x)),o}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&fe(t,e),t}(h7);function fn(e,t){return (fn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var fi=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){ void 0===t&&(t={});for(var n,i,r,s=e.call(this)||this,a=null!=(n=t.radius)?n:.5,o=null!=(i=t.latitudeBands)?i:16,l=null!=(r=t.longitudeBands)?r:16,u=[],c=[],h=[],f=[],d=0;d<=o;d++)for(var p=d*Math.PI/o,m=Math.sin(p),_=Math.cos(p),v=0;v<=l;v++){var g=2*v*Math.PI/l-Math.PI/2,y=Math.sin(g),S=Math.cos(g)*m,x=y*m,b=1-v/l,T=1-d/o;u.push(S*a,_*a,x*a),c.push(S,_,x),h.push(b,1-T);}for(var E=0;E<o;++E)for(var w=0;w<l;++w){var A=E*(l+1)+w,C=A+l+1;f.push(A+1,C,A),f.push(A+1,C+1,C);}return s.positions=u,s.normals=c,s.uvs=h,s.uvs1=h,s.indices=f,t.calculateTangents&&(s.tangents=h9(u,c,h,f)),s}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&fn(t,e),t}(h7);function fr(e,t){return (fr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var fs=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){ void 0===t&&(t={});var n,i,r,s=null!=(i=t.latitudeBands)?i:16,a=null!=(r=t.longitudeBands)?r:16;n=e.call(this,{radius:.5,latitudeBands:s,longitudeBands:a})||this;for(var o=n.positions,l=0;l<o.length;l+=3){var u=o[l]/.5,c=o[l+1]/.5,h=o[l+2]/.5;c<0&&(c*=.3,u*u+h*h<.9025&&(c=-0.1)),c+=.1,c*=.5,o[l+1]=c;}return n}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&fr(t,e),t}(fi),fa=function(){function e(){}return e.create=function(t,n){switch(n){case "box":return e.box(t);case ow:return e.dome(t)}return e.infinite(t)},e.infinite=function(e){return l_.fromGeometry(e,new ft(e))},e.box=function(e){return l_.fromGeometry(e,new ft({yOffset:.5}))},e.dome=function(e){var t=new fs({latitudeBands:50,longitudeBands:50});return t.normals=void 0,t.uvs=void 0,l_.fromGeometry(e,t)},e}(),fo=function(){var e;function t(e,t,n,i,r){this.meshInstance=null,this._depthWrite=false;var s=new h3({uniqueName:"SkyMaterial",vertexGLSL:o0.get(e,nn).get("skyboxVS"),fragmentGLSL:o0.get(e,nn).get("skyboxPS"),vertexWGSL:o0.get(e,ni).get("skyboxVS"),fragmentWGSL:o0.get(e,ni).get("skyboxPS"),attributes:{aPosition:tT}});s.setDefine("{SKYBOX_DECODE_FNC}",h8.decodeFunc(i.encoding)),r!==oE&&s.setDefine("SKYMESH",""),i.cubemap&&s.setDefine("SKY_CUBEMAP",""),s.setParameter("skyboxHighlightMultiplier",t.skyboxHighlightMultiplier),i.cubemap?s.setParameter("texture_cubeMap",i):(s.setParameter("texture_envAtlas",i),s.setParameter("mipLevel",t.skyboxMip)),s.cull=2,s.depthWrite=this._depthWrite;var a=t.layers.getLayerById(2);if(a){var o=new lL(fa.create(e,r),s,n);this.meshInstance=o,o.cull=false,o.pick=false,a.addMeshInstances([o]),this.skyLayer=a;}}return t.prototype.destroy=function(){this.meshInstance&&(this.skyLayer&&this.skyLayer.removeMeshInstances([this.meshInstance]),this.meshInstance.destroy(),this.meshInstance=null);},e=[{key:"depthWrite",get:function(){return this._depthWrite},set:function(e){this._depthWrite=e,this.meshInstance&&(this.meshInstance.material.depthWrite=e);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}(),fl=function(){function e(e){this._type=oE,this._center=new eW(0,1,0),this.skyMesh=null,this._depthWrite=false,this.node=new us("SkyMeshNode"),this.device=e.device,this.scene=e,this.center=new eW(0,1,0),this.centerArray=new Float32Array(3),this.projectedSkydomeCenterId=this.device.scope.resolve("projectedSkydomeCenter");}var t,n=e.prototype;return n.applySettings=function(e){var t,n,i,r;this.type=null!=(t=e.skyType)?t:oE,this.node.setLocalPosition(new eW(null!=(n=e.skyMeshPosition)?n:[0,0,0])),this.node.setLocalEulerAngles(new eW(null!=(i=e.skyMeshRotation)?i:[0,0,0])),this.node.setLocalScale(new eW(null!=(r=e.skyMeshScale)?r:[1,1,1])),e.skyCenter&&(this._center=new eW(e.skyCenter));},n.updateSkyMesh=function(){var e=this.scene._getSkyboxTex();e&&(this.resetSkyMesh(),this.skyMesh=new fo(this.device,this.scene,this.node,e,this.type),this.skyMesh.depthWrite=this._depthWrite,this.scene.fire("set:skybox",e));},n.resetSkyMesh=function(){var e;null==(e=this.skyMesh)||e.destroy(),this.skyMesh=null;},n.update=function(){if(this.type!==oE){var e=this.center,t=this.centerArray,n=new eW;this.node.getWorldTransform().transformPoint(e,n),t[0]=n.x,t[1]=n.y,t[2]=n.z,this.projectedSkydomeCenterId.setValue(t);}},t=[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this.scene.updateShaders=true,this.updateSkyMesh());}},{key:"center",get:function(){return this._center},set:function(e){this._center.copy(e);}},{key:"depthWrite",get:function(){return this._depthWrite},set:function(e){this._depthWrite!==e&&(this._depthWrite=e,this.skyMesh&&(this.skyMesh.depthWrite=e));}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),fu=new us;fu.worldTransform=e$.IDENTITY,fu._dirtyWorld=fu._dirtyNormal=false;var fc=function(){function e(e,t,n){this.material=t,this.layer=n,this.positions=[],this.colors=[],this.mesh=new l_(e),this.meshInstance=null;}var t=e.prototype;return t.addLines=function(e,t){for(var n=this.positions,i=e.length,r=0;r<i;r++){var s=e[r];n.push(s.x,s.y,s.z);}var a=this.colors;if(t.length)for(var o=0;o<i;o++){var l=t[o];a.push(l.r,l.g,l.b,l.a);}else for(var u=0;u<i;u++)a.push(t.r,t.g,t.b,t.a);},t.addLinesArrays=function(e,t){for(var n=this.positions,i=0;i<e.length;i+=3)n.push(e[i],e[i+1],e[i+2]);var r=this.colors;if(t.length)for(var s=0;s<t.length;s+=4)r.push(t[s],t[s+1],t[s+2],t[s+3]);else for(var a=e.length/3,o=0;o<a;o++)r.push(t.r,t.g,t.b,t.a);},t.onPreRender=function(e,t){this.positions.length>0&&this.material.transparent===t&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(1,false),this.meshInstance||(this.meshInstance=new lL(this.mesh,this.material,fu)),e.push(this.meshInstance));},t.clear=function(){this.positions.length=0,this.colors.length=0;},e}(),fh=function(){function e(e){this.device=e,this.map=new Map;}var t=e.prototype;return t.getBatch=function(e,t){var n=this.map.get(e);return n||(n=new fc(this.device,e,t),this.map.set(e,n)),n},t.onPreRender=function(e,t){this.map.forEach(function(n){n.onPreRender(e,t);});},t.clear=function(){this.map.forEach(function(e){return e.clear()});},e}(),ff=[],fd=new eW,fp=function(){function e(e){this.shaderDescs=new Map,this.device=e,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map;}var t,n=e.prototype;return n.createMaterial=function(e){var t=new h3({uniqueName:"ImmediateLine",vertexGLSL:o0.get(this.device,nn).get("immediateLineVS"),fragmentGLSL:o0.get(this.device,nn).get("immediateLinePS"),vertexWGSL:o0.get(this.device,ni).get("immediateLineVS"),fragmentWGSL:o0.get(this.device,ni).get("immediateLinePS"),attributes:{vertex_position:tT,vertex_color:tP}});return t.blendType=2,t.depthTest=e,t.update(),t},n.getBatch=function(e,t){var n=this.batchesMap.get(e);n||(n=new fh(this.device),this.batchesMap.set(e,n)),this.allBatches.add(n);var i=t?this.materialDepth:this.materialNoDepth;return n.getBatch(i,e)},n.getShaderDesc=function(e,t,n){return this.shaderDescs.has(e)||this.shaderDescs.set(e,{uniqueName:"DebugShader:"+e,vertexGLSL:"\n					attribute vec2 vertex_position;\n					uniform mat4 matrix_model;\n					varying vec2 uv0;\n					void main(void) {\n						gl_Position = matrix_model * vec4(vertex_position, 0, 1);\n						uv0 = vertex_position.xy + 0.5;\n					}\n				",vertexWGSL:"\n					attribute vertex_position: vec2f;\n					uniform matrix_model: mat4x4f;\n					varying uv0: vec2f;\n					@vertex fn vertexMain(input: VertexInput) -> VertexOutput {\n						var output: VertexOutput;\n						output.position = uniform.matrix_model * vec4f(input.vertex_position, 0.0, 1.0);\n						output.uv0 = input.vertex_position.xy + vec2f(0.5);\n						return output;\n					}\n				",fragmentGLSL:t,fragmentWGSL:n,attributes:{vertex_position:tT}}),this.shaderDescs.get(e)},n.getTextureShaderDesc=function(e){var t=h8.decodeFunc(e);return this.getShaderDesc("textureShader-"+e,'\n			#include "gammaPS"\n			varying vec2 uv0;\n			uniform sampler2D colorMap;\n			void main (void) {\n				vec3 linearColor = '+t+"(texture2D(colorMap, uv0));\n				gl_FragColor = vec4(gammaCorrectOutput(linearColor), 1);\n			}\n		",'\n			#include "gammaPS"\n			varying uv0: vec2f;\n			var colorMap: texture_2d<f32>;\n			var colorMapSampler: sampler;\n			@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n				var output: FragmentOutput;\n				let sampledTex = textureSample(colorMap, colorMapSampler, input.uv0);\n				let linearColor: vec3f = '+t+"(sampledTex);\n				output.color = vec4f(gammaCorrectOutput(linearColor), 1.0);\n				return output;\n			}\n		")},n.getUnfilterableTextureShaderDesc=function(){return this.getShaderDesc("textureShaderUnfilterable","\n			varying vec2 uv0;\n			uniform highp sampler2D colorMap;\n			void main (void) {\n				ivec2 uv = ivec2(uv0 * textureSize(colorMap, 0));\n				gl_FragColor = vec4(texelFetch(colorMap, uv, 0).xyz, 1);\n			}\n		","\n			varying uv0: vec2f;\n			var colorMap: texture_2d<uff>;\n			@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n				var output: FragmentOutput;\n				let uv : vec2<i32> = vec2<i32>(input.uv0 * vec2f(textureDimensions(colorMap, 0)));\n				let fetchedColor : vec4f = textureLoad(colorMap, uv, 0);\n				output.color = vec4f(fetchedColor.xyz, 1.0);\n				return output;\n			}\n		")},n.getDepthTextureShaderDesc=function(){return this.getShaderDesc("depthTextureShader",'\n			#include "screenDepthPS"\n			#include "gammaPS"\n			varying vec2 uv0;\n			void main() {\n				float depth = getLinearScreenDepth(getImageEffectUV(uv0)) * camera_params.x;\n				gl_FragColor = vec4(gammaCorrectOutput(vec3(depth)), 1.0);\n			}\n		','\n			#include "screenDepthPS"\n			#include "gammaPS"\n			varying uv0: vec2f;\n			@fragment fn fragmentMain(input: FragmentInput) -> FragmentOutput {\n				var output: FragmentOutput;\n				let depth: f32 = getLinearScreenDepth(getImageEffectUV(input.uv0)) * uniform.camera_params.x;\n				output.color = vec4f(gammaCorrectOutput(vec3f(depth)), 1.0);\n				return output;\n			}\n		')},n.getQuadMesh=function(){return this.quadMesh||(this.quadMesh=new l_(this.device),this.quadMesh.setPositions([-0.5,-0.5,0,.5,-0.5,0,-0.5,.5,0,.5,.5,0]),this.quadMesh.update(5)),this.quadMesh},n.drawMesh=function(e,t,n,i,r){i||(i=new lL(n,e,this.getGraphNode(t)));var s=this.layerMeshInstances.get(r);s||(s=[],this.layerMeshInstances.set(r,s)),s.push(i);},n.drawWireAlignedBox=function(e,t,n,i,r,s){if(s){var a=function(e,t,n){fd.set(e,t,n),s.transformPoint(fd,fd),ff.push(fd.x,fd.y,fd.z);};a(e.x,e.y,e.z),a(e.x,t.y,e.z),a(e.x,t.y,e.z),a(t.x,t.y,e.z),a(t.x,t.y,e.z),a(t.x,e.y,e.z),a(t.x,e.y,e.z),a(e.x,e.y,e.z),a(e.x,e.y,t.z),a(e.x,t.y,t.z),a(e.x,t.y,t.z),a(t.x,t.y,t.z),a(t.x,t.y,t.z),a(t.x,e.y,t.z),a(t.x,e.y,t.z),a(e.x,e.y,t.z),a(e.x,e.y,e.z),a(e.x,e.y,t.z),a(e.x,t.y,e.z),a(e.x,t.y,t.z),a(t.x,t.y,e.z),a(t.x,t.y,t.z),a(t.x,e.y,e.z),a(t.x,e.y,t.z);}else ff.push(e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,e.z,e.x,t.y,t.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,e.y,e.z,t.x,e.y,t.z);this.getBatch(r,i).addLinesArrays(ff,n),ff.length=0;},n.drawWireSphere=function(e,t,n,i,r,s){for(var a=2*Math.PI/i,o=0,l=0;l<i;l++){var u=Math.sin(o),c=Math.cos(o),h=Math.sin(o+=a),f=Math.cos(o);ff.push(e.x+t*u,e.y,e.z+t*c),ff.push(e.x+t*h,e.y,e.z+t*f),ff.push(e.x+t*u,e.y+t*c,e.z),ff.push(e.x+t*h,e.y+t*f,e.z),ff.push(e.x,e.y+t*u,e.z+t*c),ff.push(e.x,e.y+t*h,e.z+t*f);}this.getBatch(s,r).addLinesArrays(ff,n),ff.length=0;},n.getGraphNode=function(e){var t=new us("ImmediateDebug");return t.worldTransform=e,t._dirtyWorld=t._dirtyNormal=false,t},n.onPreRenderLayer=function(e,t,n){if(this.batchesMap.forEach(function(i,r){r===e&&i.onPreRender(t,n);}),!this.updatedLayers.has(e)){this.updatedLayers.add(e);var i=this.layerMeshInstances.get(e);if(i){for(var r=0;r<i.length;r++)t.push(i[r]);i.length=0;}}},n.onPostRender=function(){this.allBatches.forEach(function(e){return e.clear()}),this.allBatches.clear(),this.updatedLayers.clear();},t=[{key:"materialDepth",get:function(){return this._materialDepth||(this._materialDepth=this.createMaterial(true)),this._materialDepth}},{key:"materialNoDepth",get:function(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(false)),this._materialNoDepth}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),fm={circlePointDeterministic:function(e,t,n){var i=2.399963229728653*t,r=Math.sqrt(t)/Math.sqrt(n);e.x=r*Math.cos(i),e.y=r*Math.sin(i);},spherePointDeterministic:function(e,t,n,i,r){ void 0===i&&(i=0),void 0===r&&(r=1),i=1-2*i,r=1-2*r;var s=ek.lerp(i,r,t/n),a=Math.sqrt(1-s*s),o=2.399963229728653*t;e.x=Math.cos(o)*a,e.y=s,e.z=Math.sin(o)*a;},radicalInverse:function(e){var t=(e<<16|e>>>16)>>>0;return 23283064365386963e-26*(t=((0xff00ff&(t=((0xf0f0f0f&(t=((0x33333333&(t=((0x55555555&t)<<1|(0xaaaaaaaa&t)>>>1)>>>0))<<2|(0xcccccccc&t)>>>2)>>>0))<<4|(0xf0f0f0f0&t)>>>4)>>>0))<<8|(0xff00ff00&t)>>>8)>>>0)}},f_=function(e){switch(e){case t7:return "Cubemap";case nt:return "Octahedral";default:return "Equirect"}},fv=function(e,t,n){if(e<=0)t[n+0]=0,t[n+1]=0,t[n+2]=0,t[n+3]=0;else if(e>=1)t[n+0]=255,t[n+1]=0,t[n+2]=0,t[n+3]=0;else {var i=e%1,r=255*e%1,s=65025*e%1,a=0xfd02ff*e%1;i-=r/255,r-=s/255,s-=a/255,t[n+0]=Math.min(255,Math.floor(256*i)),t[n+1]=Math.min(255,Math.floor(256*r)),t[n+2]=Math.min(255,Math.floor(256*s)),t[n+3]=Math.min(255,Math.floor(256*a));}},fg=function(e){for(var t=e.length,n=Math.min(t,512),i=Math.ceil(t/n),r=new Uint8Array(n*i*4),s=0,a=0;a<t;a+=4)fv(.5*e[a+0]+.5,r,s+0),fv(.5*e[a+1]+.5,r,s+4),fv(.5*e[a+2]+.5,r,s+8),fv(e[a+3]/8,r,s+12),s+=16;return {width:n,height:i,data:r}},fy=function(e,t,n,i){var r=2*n*Math.PI,s=Math.pow(1-t,1/(i+1)),a=Math.sqrt(1-s*s);e.set(Math.cos(r)*a,Math.sin(r)*a,s).normalize();},fS=function(e,t,n){var i=2*n*Math.PI,r=Math.sqrt(1-t),s=Math.sqrt(t);e.set(Math.cos(i)*s,Math.sin(i)*s,r).normalize();},fx=function(e,t,n,i){var r=2*n*Math.PI,s=Math.sqrt((1-t)/(1+(i*i-1)*t)),a=Math.sqrt(1-s*s);e.set(Math.cos(r)*a,Math.sin(r)*a,s).normalize();},fb=function(e,t){var n=e*t,i=t/(1-e*e+n*n);return i*i*(1/Math.PI)},fT=function(e,t){for(var n=new eW,i=[],r=0;r<e;++r)fy(n,r/e,fm.radicalInverse(r),t),i.push(n.x,n.y,n.z,0);return i},fE=function(e,t){for(var n=t/e,i=new eW,r=[],s=0;s<e;++s){fS(i,s/e,fm.radicalInverse(s));var a=.5*Math.log2(n/(i.z/Math.PI));r.push(i.x,i.y,i.z,a);}return r},fw={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}},fA=function(e,t){var n=fw[e];return n&&n[t]||e},fC=function(e,t,n){for(var i=n/e,r=1-Math.log2(t)/11,s=r*r,a=new eW,o=new eW,l=new eW(0,0,1),u=[],c=fA(e,t),h=0;h<c;++h){fx(a,h/c,fm.radicalInverse(h),s);var f=a.z;if(o.set(a.x,a.y,a.z).mulScalar(2*f).sub(l),o.z>0){var d=.5*Math.log2(i/(fb(Math.min(1,f),s)/4+.001));u.push(o.x,o.y,o.z,d);}}for(;u.length<4*e;)u.push(0,0,0,0);return u},fP=function(e,t,n){var i=fg(n);return new nO(e,{name:t,width:i.width,height:i.height,mipmaps:false,minFilter:0,magFilter:0,levels:[i.data]})},fI=function(){function e(e){ void 0===e&&(e=true),this.map=new Map,this.destroyContent=e;}var t=e.prototype;return t.destroy=function(){this.destroyContent&&this.map.forEach(function(e,t){e.destroy();});},t.get=function(e,t){if(!this.map.has(e)){var n=t();return this.map.set(e,n),n}return this.map.get(e)},e}(),fL=new fI(false),fD=new nD,fM=function(e,t,n){return fD.get(e,function(){return new fI}).get(t,function(){return fP(e,t,fL.get(t,n))})};function fR(e,t,n){ void 0===n&&(n={});var i,r,s,a,o,l=null!=(s=n.seamPixels)?s:0,u=(null!=(a=null==(i=n.rect)?void 0:i.z)?a:t.width)-2*l,c=(null!=(o=null==(r=n.rect)?void 0:r.w)?o:t.height)-2*l;if(u<1||c<1)return  false;var h=n.hasOwnProperty("specularPower")?n.specularPower:1,f=n.hasOwnProperty("face")?n.face:null,d=n.hasOwnProperty("distribution")?n.distribution:1===h?"none":"phong",p={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"}[d]||"reproject",m=p.startsWith("prefilterSamples"),_=h8.decodeFunc(e.encoding),v=h8.encodeFunc(t.encoding),g="sample"+f_(e.projection),y="getDirection"+f_(t.projection),S=n.hasOwnProperty("numSamples")?n.numSamples:1024,x="ReprojectShader:"+p+"_"+_+"_"+v+"_"+g+"_"+y+"_"+S,b=e.device,T=oz(b).getCachedShader(x);if(!T){var E=new Map;m&&E.set("USE_SAMPLES_TEX",""),e.cubemap&&E.set("CUBEMAP_SOURCE",""),E.set("{PROCESS_FUNC}",p),E.set("{DECODE_FUNC}",_),E.set("{ENCODE_FUNC}",v),E.set("{SOURCE_FUNC}",g),E.set("{TARGET_FUNC}",y),E.set("{NUM_SAMPLES}",S),E.set("{NUM_SAMPLES_SQRT}",Math.round(Math.sqrt(S)).toFixed(1));var w=b.isWebGPU,A=o0.get(b,w?ni:nn),C=new Map;C.set("decodePS",A.get("decodePS")),C.set("encodePS",A.get("encodePS")),T=o8.createShader(b,{uniqueName:x,attributes:{vertex_position:tT},vertexChunk:"reprojectVS",fragmentChunk:"reprojectPS",fragmentIncludes:C,fragmentDefines:E});}b.setBlendState(nj.NOBLEND),b.scope.resolve(e.cubemap?"sourceCube":"sourceTex").setValue(e);var P=b.scope.resolve("params"),I=b.scope.resolve("uvMod");l>0?I.setValue([(u+2*l)/u,(c+2*l)/c,-l/u,-l/c]):I.setValue([1,1,0,0]);var L=[0,t.width*t.height*(t.cubemap?6:1),e.width*e.height*(e.cubemap?6:1)];if(m){var D=e.width*e.height*(e.cubemap?6:1),M="ggx"===d?fM(b,"ggx-samples-"+S+"-"+h+"-"+D,function(){return fC(S,h,D)}):"lambert"===d?fM(b,"lambert-samples-"+S+"-"+D,function(){return fE(S,D)}):fM(b,"phong-samples-"+S+"-"+h,function(){return fT(S,h)});b.scope.resolve("samplesTex").setValue(M),b.scope.resolve("samplesTexInverseSize").setValue([1/M.width,1/M.height]);}for(var R=0;R<(t.cubemap?6:1);R++)if(null===f||R===f){var O=new il({colorBuffer:t,face:R,depth:false,flipY:b.isWebGPU});L[0]=R,P.setValue(L),ls(b,O,T,null==n?void 0:n.rect),O.destroy();}return  true}var fO=function(e,t){return void 0===t&&(t=0),1+Math.floor(Math.log2(Math.max(e,t)))},fk=function(){function e(){}return e.generateSkyboxCubemap=function(e,t){var n,i,r=(n=e.device,i=t||(e.cubemap?e.width:e.width/4),new nO(n,{name:"lighting-"+i,cubemap:true,width:i,height:i,format:7,type:t3,addressU:1,addressV:1,mipmaps:false}));return fR(e,r,{numSamples:1024}),r},e.generateLightingSource=function(e,t){var n,i=e.device,r=(n=i).textureHalfFloatRenderable?12:n.textureFloatRenderable?14:7,s=(null==t?void 0:t.target)||new nO(i,{name:"lighting-source",cubemap:true,width:(null==t?void 0:t.size)||128,height:(null==t?void 0:t.size)||128,format:r,type:7===r?t3:t0,addressU:1,addressV:1,mipmaps:true});return fR(e,s,{numSamples:e.mipmaps?1:1024}),s},e.generateAtlas=function(e,t){for(var n=e.device,i=(null==t?void 0:t.target)||new nO(n,{name:"envAtlas",width:(null==t?void 0:t.size)||512,height:(null==t?void 0:t.size)||512,format:7,type:t3,projection:ne,addressU:1,addressV:1,mipmaps:false}),r=i.width/512,s=new eY(0,0,512*r,256*r),a=fO(256)-fO(4),o=0;o<a;++o)fR(e,i,{numSamples:1,rect:s,seamPixels:r}),s.x+=s.w,s.y+=s.w,s.z=Math.max(1,Math.floor(.5*s.z)),s.w=Math.max(1,Math.floor(.5*s.w));s.set(0,256*r,256*r,128*r);for(var l=1;l<7;++l)fR(e,i,{numSamples:(null==t?void 0:t.numReflectionSamples)||1024,distribution:(null==t?void 0:t.distribution)||"ggx",specularPower:Math.max(1,2048>>2*l),rect:s,seamPixels:r}),s.y+=s.w,s.z=Math.max(1,Math.floor(.5*s.z)),s.w=Math.max(1,Math.floor(.5*s.w));return s.set(128*r,384*r,64*r,32*r),fR(e,i,{numSamples:(null==t?void 0:t.numAmbientSamples)||2048,distribution:"lambert",rect:s,seamPixels:r}),i},e.generatePrefilteredAtlas=function(e,t){for(var n=e[0].device,i=e[0].format,r=e[0].type,s=(null==t?void 0:t.target)||new nO(n,{name:"envPrefilteredAtlas",width:(null==t?void 0:t.size)||512,height:(null==t?void 0:t.size)||512,format:i,type:r,projection:ne,addressU:1,addressV:1,mipmaps:false}),a=s.width/512,o=new eY(0,0,512*a,256*a),l=fO(512),u=0;u<l;++u)fR(e[0],s,{numSamples:1,rect:o,seamPixels:a}),o.x+=o.w,o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));o.set(0,256*a,256*a,128*a);for(var c=1;c<e.length;++c)fR(e[c],s,{numSamples:1,rect:o,seamPixels:a}),o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));return o.set(128*a,384*a,64*a,32*a),(null==t?void 0:t.legacyAmbient)?fR(e[5],s,{numSamples:1,rect:o,seamPixels:a}):fR(e[0],s,{numSamples:(null==t?void 0:t.numSamples)||2048,distribution:"lambert",rect:o,seamPixels:a}),s},e}(),fN=function(){this.type=on,this.color=new eN(0,0,0),this.density=0,this.start=1,this.end=1e3;};function fF(e,t){return (fF=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var fB=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this).ambientBake=false,n.ambientBakeOcclusionBrightness=0,n.ambientBakeOcclusionContrast=0,n.ambientLight=new eN(0,0,0),n.ambientLuminance=0,n.exposure=1,n.lightmapSizeMultiplier=1,n.lightmapMaxResolution=2048,n.lightmapMode=1,n.lightmapFilterEnabled=false,n.lightmapHDR=false,n.root=null,n.physicalUnits=false,n._envAtlas=null,n._skyboxCubeMap=null,n._fogParams=new fN,n.forcePassThroughSpecular=false,n.device=t,n._gravity=new eW(0,-9.8,0),n._layers=null,n._prefilteredCubemaps=[],n._internalEnvAtlas=null,n._skyboxIntensity=1,n._skyboxLuminance=0,n._skyboxMip=0,n._skyboxHighlightMultiplier=1,n._skyboxRotationShaderInclude=false,n._skyboxRotation=new e0,n._skyboxRotationMat3=new ej,n._skyboxRotationMat4=new e$,n._ambientBakeNumSamples=1,n._ambientBakeSpherePart=.4,n._lightmapFilterRange=10,n._lightmapFilterSmoothness=.2,n._clusteredLightingEnabled=true,n._lightingParams=new c9(n.device.supportsAreaLights,n.device.maxTextureSize,function(){n.updateShaders=true;}),n._sky=new fl(n),n._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,updateShadersTime:0},n.updateShaders=true,n._shaderVersion=0,n.immediate=new fp(n.device),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&fF(t,e);var n,i=t.prototype;return i.destroy=function(){this._resetSkyMesh(),this.root=null,this.off();},i.drawLine=function(e,t,n,i,r){ void 0===n&&(n=eN.WHITE),void 0===i&&(i=true),void 0===r&&(r=this.defaultDrawLayer),this.immediate.getBatch(r,i).addLines([e,t],[n,n]);},i.drawLines=function(e,t,n,i){ void 0===n&&(n=true),void 0===i&&(i=this.defaultDrawLayer),this.immediate.getBatch(i,n).addLines(e,t);},i.drawLineArrays=function(e,t,n,i){ void 0===n&&(n=true),void 0===i&&(i=this.defaultDrawLayer),this.immediate.getBatch(i,n).addLinesArrays(e,t);},i.applySettings=function(e){var t,n,i,r,s=this,a=e.physics,o=e.render;this._gravity.set(a.gravity[0],a.gravity[1],a.gravity[2]),this.ambientLight.set(o.global_ambient[0],o.global_ambient[1],o.global_ambient[2]),this.ambientLuminance=o.ambientLuminance,this.fog.type=o.fog,this.fog.color.set(o.fog_color[0],o.fog_color[1],o.fog_color[2]),this.fog.start=o.fog_start,this.fog.end=o.fog_end,this.fog.density=o.fog_density,this.lightmapSizeMultiplier=o.lightmapSizeMultiplier,this.lightmapMaxResolution=o.lightmapMaxResolution,this.lightmapMode=o.lightmapMode,this.exposure=o.exposure,this._skyboxIntensity=null!=(t=o.skyboxIntensity)?t:1,this._skyboxLuminance=null!=(n=o.skyboxLuminance)?n:2e4,this._skyboxMip=null!=(i=o.skyboxMip)?i:0,o.skyboxRotation&&(this.skyboxRotation=new e0().setFromEulerAngles(o.skyboxRotation[0],o.skyboxRotation[1],o.skyboxRotation[2])),this.sky.applySettings(o),this.clusteredLightingEnabled=null!=(r=o.clusteredLightingEnabled)&&r,this.lighting.applySettings(o),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach(function(e){o.hasOwnProperty(e)&&(s[e]=o[e]);}),this._resetSkyMesh();},i._getSkyboxTex=function(){var e=this._prefilteredCubemaps;return this._skyboxMip?e[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||e[0]||this._skyboxCubeMap:this._skyboxCubeMap||e[0]||this._envAtlas},i._updateSkyMesh=function(){this.sky.skyMesh||this.sky.updateSkyMesh(),this.sky.update();},i._resetSkyMesh=function(){this.sky.resetSkyMesh(),this.updateShaders=true;},i.setSkybox=function(e){e?(this.skybox=e[0]||null,e[1]&&!e[1].cubemap?this.envAtlas=e[1]:this.prefilteredCubemaps=e.slice(1)):(this.skybox=null,this.envAtlas=null);},n=[{key:"defaultDrawLayer",get:function(){return this.layers.getLayerById(3)}},{key:"ambientBakeNumSamples",get:function(){return this._ambientBakeNumSamples},set:function(e){this._ambientBakeNumSamples=ek.clamp(Math.floor(e),1,255);}},{key:"ambientBakeSpherePart",get:function(){return this._ambientBakeSpherePart},set:function(e){this._ambientBakeSpherePart=ek.clamp(e,.001,1);}},{key:"clusteredLightingEnabled",get:function(){return this._clusteredLightingEnabled},set:function(e){(!this.device.isWebGPU||e)&&(this._clusteredLightingEnabled||!e)&&(this._clusteredLightingEnabled=e);}},{key:"envAtlas",get:function(){return this._envAtlas},set:function(e){e!==this._envAtlas&&(this._envAtlas=e,e&&(e.addressU=1,e.addressV=1,e.minFilter=1,e.magFilter=1,e.mipmaps=false),this._prefilteredCubemaps=[],this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._resetSkyMesh());}},{key:"layers",get:function(){return this._layers},set:function(e){var t=this._layers;this._layers=e,this.fire("set:layers",t,e);}},{key:"sky",get:function(){return this._sky}},{key:"lighting",get:function(){return this._lightingParams}},{key:"fog",get:function(){return this._fogParams}},{key:"lightmapFilterRange",get:function(){return this._lightmapFilterRange},set:function(e){this._lightmapFilterRange=Math.max(e,.001);}},{key:"lightmapFilterSmoothness",get:function(){return this._lightmapFilterSmoothness},set:function(e){this._lightmapFilterSmoothness=Math.max(e,.001);}},{key:"prefilteredCubemaps",get:function(){return this._prefilteredCubemaps},set:function(e){e=e||[];var t=this._prefilteredCubemaps;(t.length!==e.length||t.some(function(t,n){return t!==e[n]}))&&(6===e.length&&e.every(function(e){return !!e})?(this._internalEnvAtlas=fk.generatePrefilteredAtlas(e,{target:this._internalEnvAtlas}),this._envAtlas=this._internalEnvAtlas):(this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._envAtlas=null),this._prefilteredCubemaps=e.slice(),this._resetSkyMesh());}},{key:"skybox",get:function(){return this._skyboxCubeMap},set:function(e){e!==this._skyboxCubeMap&&(this._skyboxCubeMap=e,this._resetSkyMesh());}},{key:"skyboxIntensity",get:function(){return this._skyboxIntensity},set:function(e){e!==this._skyboxIntensity&&(this._skyboxIntensity=e,this._resetSkyMesh());}},{key:"skyboxLuminance",get:function(){return this._skyboxLuminance},set:function(e){e!==this._skyboxLuminance&&(this._skyboxLuminance=e,this._resetSkyMesh());}},{key:"skyboxMip",get:function(){return this._skyboxMip},set:function(e){e!==this._skyboxMip&&(this._skyboxMip=e,this._resetSkyMesh());}},{key:"skyboxHighlightMultiplier",get:function(){return this._skyboxHighlightMultiplier},set:function(e){e!==this._skyboxHighlightMultiplier&&(this._skyboxHighlightMultiplier=e,this._resetSkyMesh());}},{key:"skyboxRotation",get:function(){return this._skyboxRotation},set:function(e){if(!this._skyboxRotation.equals(e)){var t=e.equals(e0.IDENTITY);this._skyboxRotation.copy(e),t?this._skyboxRotationMat3.setIdentity():(this._skyboxRotationMat4.setTRS(eW.ZERO,e,eW.ONE),this._skyboxRotationMat3.invertMat4(this._skyboxRotationMat4)),this._skyboxRotationShaderInclude||t||(this._skyboxRotationShaderInclude=true,this._resetSkyMesh());}}},{key:"lightmapPixelFormat",get:function(){return this.lightmapHDR&&this.device.getRenderableHdrFormat()||7}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);fB.EVENT_SETLAYERS="set:layers",fB.EVENT_SETSKYBOX="set:skybox",fB.EVENT_PRERENDER="prerender",fB.EVENT_POSTRENDER="postrender",fB.EVENT_PRERENDER_LAYER="prerender:layer",fB.EVENT_POSTRENDER_LAYER="postrender:layer",fB.EVENT_PRECULL="precull",fB.EVENT_POSTCULL="postcull";var fU=function(e,t,n){this.device=e,this.inverseBindPose=t,this.boneNames=n;};function fz(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function fV(e,t){return (fV=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var fG=[0,0,1,0,0,1,0,0,1,0,0,1],fH=[0,1,3,2,3,1],fW=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this)||this)._device=t,i._pixelsPerUnit=n&&void 0!==n.pixelsPerUnit?n.pixelsPerUnit:1,i._renderMode=n&&void 0!==n.renderMode?n.renderMode:0,i._atlas=n&&void 0!==n.atlas?n.atlas:null,i._frameKeys=n&&void 0!==n.frameKeys?n.frameKeys:null,i._meshes=[],i._updatingProperties=false,i._meshesDirty=false,i._atlas&&i._frameKeys&&i._createMeshes(),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&fV(t,e);var n,i=t.prototype;return i._createMeshes=function(){for(var e=this._meshes.length,t=0;t<e;t++){var n=this._meshes[t];n&&n.destroy();}var i=this._frameKeys.length;this._meshes=Array(i);for(var r=1===this.renderMode||2===this._renderMode?this._create9SliceMesh:this._createSimpleMesh,s=0;s<i;s++){var a=this._atlas.frames[this._frameKeys[s]];this._meshes[s]=a?r.call(this,a):null;}this.fire("set:meshes");},i._createSimpleMesh=function(e){var t=e.rect,n=this._atlas.texture.width,i=this._atlas.texture.height,r=t.z/this._pixelsPerUnit,s=t.w/this._pixelsPerUnit,a=e.pivot.x,o=e.pivot.y,l=t.x/n,u=1-t.y/i,c=(t.x+t.z)/n,h=1-(t.y+t.w)/i,f=new h7;return f.positions=[-a*r,-o*s,0,(1-a)*r,-o*s,0,(1-a)*r,(1-o)*s,0,-a*r,(1-o)*s,0],f.normals=fG,f.uvs=[l,u,c,u,c,h,l,h],f.indices=fH,l_.fromGeometry(this._device,f)},i._create9SliceMesh=function(){for(var e=eX.ONE,t=[],n=[],i=[],r=[],s=0,a=0;a<=3;a++)for(var o=+(0!==a&&3!==a),l=0;l<=3;l++){var u=-e.x+2*e.x*(a<=1?0:3)/3,c=-(-e.y+2*e.y*(l<=1?0:3)/3),h=+(0!==l&&3!==l);t.push(-u,0,c),n.push(0,1,0),i.push(o,h),a<3&&l<3&&(r.push(s+3+1,s+1,s),r.push(s+3+1,s+3+2,s+1)),s++;}var f=new h7;return f.positions=t,f.normals=n,f.uvs=i,f.indices=r,l_.fromGeometry(this._device,f)},i._onSetFrames=function(e){this._updatingProperties?this._meshesDirty=true:this._createMeshes();},i._onFrameChanged=function(e,t){var n=this._frameKeys.indexOf(e);n<0||(t?0===this.renderMode&&(this._meshes[n]=this._createSimpleMesh(t)):this._meshes[n]=null,this.fire("set:meshes"));},i._onFrameRemoved=function(e){var t=this._frameKeys.indexOf(e);t<0||(this._meshes[t]=null,this.fire("set:meshes"));},i.startUpdate=function(){this._updatingProperties=true,this._meshesDirty=false;},i.endUpdate=function(){this._updatingProperties=false,this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes(),this._meshesDirty=false;},i.destroy=function(){for(var e,t=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return fz(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return fz(e,void 0)}}(e))){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(this._meshes);!(e=t()).done;){var n=e.value;n&&n.destroy();}this._meshes.length=0;},n=[{key:"frameKeys",get:function(){return this._frameKeys},set:function(e){this._frameKeys=e,this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=true:this._createMeshes()),this.fire("set:frameKeys",e);}},{key:"atlas",get:function(){return this._atlas},set:function(e){e!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),this._atlas=e,this._atlas&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=true:this._createMeshes()),this.fire("set:atlas",e));}},{key:"pixelsPerUnit",get:function(){return this._pixelsPerUnit},set:function(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this.fire("set:pixelsPerUnit",e),this._atlas&&this._frameKeys&&0===this.renderMode&&(this._updatingProperties?this._meshesDirty=true:this._createMeshes()));}},{key:"renderMode",get:function(){return this._renderMode},set:function(e){if(this._renderMode!==e){var t=this._renderMode;this._renderMode=e,this.fire("set:renderMode",e),(0===t||0===e)&&this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=true:this._createMeshes());}}},{key:"meshes",get:function(){return this._meshes}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function fj(e,t){return (fj=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var fX=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return (t=e.call(this)||this)._texture=null,t._frames=null,t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&fj(t,e);var n,i=t.prototype;return i.setFrame=function(e,t){var n=this._frames[e];n?(n.rect.copy(t.rect),n.pivot.copy(t.pivot),n.border.copy(t.border)):(n={rect:t.rect.clone(),pivot:t.pivot.clone(),border:t.border.clone()},this._frames[e]=n),this.fire("set:frame",e.toString(),n);},i.removeFrame=function(e){var t=this._frames[e];t&&(delete this._frames[e],this.fire("remove:frame",e.toString(),t));},i.destroy=function(){this._texture&&this._texture.destroy();},n=[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this.fire("set:texture",e);}},{key:"frames",get:function(){return this._frames},set:function(e){this._frames=e,this.fire("set:frames",e);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex),fY=function(e,t,n,i){this.time=e,this.position=t,this.rotation=n,this.scale=i;},fq=function(){this._name="",this._keys=[];},fK=function(){function e(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={};}var t,n=e.prototype;return n.getNode=function(e){return this._nodeDict[e]},n.addNode=function(e){this._nodes.push(e),this._nodeDict[e._name]=e;},t=[{key:"nodes",get:function(){return this._nodes}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),fZ=function(){function e(){this._written=false,this._name="",this._keyFrames=[],this._quat=new e0,this._pos=new eW,this._scale=new eW,this._targetNode=null;}var t=e.prototype;return t.getTarget=function(){return this._targetNode},t.setTarget=function(e){this._targetNode=e;},e}(),fQ=function(){function e(e){var t=this;this.looping=true,this._animation=null,this._time=0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;var n=function(e){var i=new fZ;i._name=e.name,t._interpolatedKeys.push(i),t._interpolatedKeyDict[e.name]=i,t._currKeyIndices[e.name]=0;for(var r=0;r<e._children.length;r++)n(e._children[r]);};n(e);}var t,n=e.prototype;return n.addTime=function(e){if(null!==this._animation){var t=this._animation._nodes,n=this._animation.duration;if(this._time!==n||this.looping){if(this._time+=e,this._time>n){this._time=this.looping?0:n;for(var i=0;i<t.length;i++){var r=t[i]._name;this._currKeyIndices[r]=0;}}else if(this._time<0){this._time=this.looping?n:0;for(var s=0;s<t.length;s++){var a=t[s],o=a._name;this._currKeyIndices[o]=a._keys.length-2;}}for(var l=e>=0?1:-1,u=0;u<t.length;u++){var c=t[u],h=c._name,f=c._keys,d=this._interpolatedKeyDict[h];if(void 0!==d){var p=false;if(1!==f.length)for(var m=this._currKeyIndices[h];m<f.length-1&&m>=0;m+=l){var _=f[m],v=f[m+1];if(_.time<=this._time&&v.time>=this._time){var g=(this._time-_.time)/(v.time-_.time);d._pos.lerp(_.position,v.position,g),d._quat.slerp(_.rotation,v.rotation,g),d._scale.lerp(_.scale,v.scale,g),d._written=true,this._currKeyIndices[h]=m,p=true;break}}(1===f.length||!p&&0===this._time&&this.looping)&&(d._pos.copy(f[0].position),d._quat.copy(f[0].rotation),d._scale.copy(f[0].scale),d._written=true);}}}}},n.blend=function(e,t,n){for(var i=this._interpolatedKeys.length,r=0;r<i;r++){var s=e._interpolatedKeys[r],a=t._interpolatedKeys[r],o=this._interpolatedKeys[r];s._written&&a._written?(o._quat.slerp(s._quat,t._interpolatedKeys[r]._quat,n),o._pos.lerp(s._pos,t._interpolatedKeys[r]._pos,n),o._scale.lerp(s._scale,a._scale,n),o._written=true):s._written?(o._quat.copy(s._quat),o._pos.copy(s._pos),o._scale.copy(s._scale),o._written=true):a._written&&(o._quat.copy(a._quat),o._pos.copy(a._pos),o._scale.copy(a._scale),o._written=true);}},n.setGraph=function(e){if(this.graph=e,e)for(var t=0;t<this._interpolatedKeys.length;t++){var n=this._interpolatedKeys[t],i=e.findByName(n._name);this._interpolatedKeys[t].setTarget(i);}else for(var r=0;r<this._interpolatedKeys.length;r++)this._interpolatedKeys[r].setTarget(null);},n.updateGraph=function(){if(this.graph)for(var e=0;e<this._interpolatedKeys.length;e++){var t=this._interpolatedKeys[e];if(t._written){var n=t.getTarget();n.localPosition.copy(t._pos),n.localRotation.copy(t._quat),n.localScale.copy(t._scale),n._dirtyLocal||n._dirtifyLocal(),t._written=false;}}},t=[{key:"animation",get:function(){return this._animation},set:function(e){this._animation=e,this.currentTime=0;}},{key:"currentTime",get:function(){return this._time},set:function(e){this._time=e;for(var t=this._interpolatedKeys.length,n=0;n<t;n++){var i=this._interpolatedKeys[n]._name;this._currKeyIndices[i]=0;}this.addTime(0),this.updateGraph();}},{key:"numNodes",get:function(){return this._interpolatedKeys.length}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),fJ=new eY,f$=function(){function e(e){this.device=e,this.needsDepthBuffer=false;}var t=e.prototype;return t.render=function(e,t,n){},t.drawQuad=function(e,t,n){var i;if(n){var r=e?e.width:this.device.width,s=e?e.height:this.device.height;i=fJ.set(n.x*r,n.y*s,n.z*r,n.w*s);}this.device.setBlendState(nj.NOBLEND),ls(this.device,e,t,i);},e}();function f0(e,t){return (f0=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}f$.quadVertexShader="\n        attribute vec2 aPosition;\n        varying vec2 vUv0;\n        void main(void)\n        {\n            gl_Position = vec4(aPosition, 0.0, 1.0);\n            vUv0 = getImageEffectUV((aPosition.xy + 1.0) * 0.5);\n        }\n    ";var f1=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var t;return t=e.apply(this,arguments)||this,t._shader=null,t.quadRender=null,t.cullMode=0,t.blendState=nj.NOBLEND,t.depthState=nq.NODEPTH,t.stencilFront=null,t.stencilBack=null,t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:true,configurable:true}}),e&&f0(n,e),n.prototype.execute=function(){var e=this.device;e.setBlendState(this.blendState),e.setCullMode(this.cullMode),e.setDepthState(this.depthState),e.setStencilState(this.stencilFront,this.stencilBack),this.quadRender.render();},t=[{key:"shader",get:function(){return this._shader},set:function(e){var t;null==(t=this.quadRender)||t.destroy(),this.quadRender=null,this._shader=e,e&&(this.quadRender=new lt(e));}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(n.prototype,t),n}(s2),f2=function(){this.hasTangents=false,this.shaderChunks=null,this.pass=0,this.alphaTest=false,this.blendType=3,this.separateAmbient=false,this.screenSpace=false,this.skin=false,this.batch=false,this.useInstancing=false,this.useMorphPosition=false,this.useMorphNormal=false,this.useMorphTextureBasedInt=false,this.nineSlicedMode=0,this.clusteredLightingEnabled=true,this.clusteredLightingCookiesEnabled=false,this.clusteredLightingShadowsEnabled=false,this.clusteredLightingShadowType=0,this.clusteredLightingAreaLightsEnabled=false,this.vertexColors=false,this.lightMapEnabled=false,this.dirLightMapEnabled=false,this.useHeights=false,this.useNormals=false,this.useClearCoatNormals=false,this.useAo=false,this.diffuseMapEnabled=false,this.pixelSnap=false,this.ambientSH=false,this.ssao=false,this.twoSidedLighting=false,this.occludeDirect=false,this.occludeSpecular=0,this.occludeSpecularFloat=false,this.useMsdf=false,this.msdfTextAttribute=false,this.alphaToCoverage=false,this.opacityFadesSpecular=false,this.opacityDither=oA,this.opacityShadowDither=oA,this.cubeMapProjection=0,this.useSpecular=false,this.useSpecularityFactor=false,this.enableGGXSpecular=false,this.fresnelModel=0,this.useRefraction=false,this.useClearCoat=false,this.useSheen=false,this.useIridescence=false,this.useMetalness=false,this.useDynamicRefraction=false,this.dispersion=false,this.fog=on,this.gamma=0,this.toneMap=-1,this.reflectionSource=od,this.reflectionEncoding=null,this.reflectionCubemapEncoding=null,this.ambientSource="constant",this.ambientEncoding=null,this.skyboxIntensity=1,this.useCubeMapRotation=false,this.lightMapWithoutAmbient=false,this.lights=[],this.noShadow=false,this.lightMaskDynamic=0,this.userAttributes={},this.linearDepth=false,this.shadowCatcher=false;},f3=function(){function e(){}return e.update=function(t,n,i,r,s,a,o){e.updateSharedOptions(t,n,i,s,a),e.updateMaterialOptions(t,n),e.updateEnvOptions(t,n,i,r),e.updateLightingOptions(t,n,i,s,o);},e.updateSharedOptions=function(e,t,n,i,r){e.shaderChunks=t.shaderChunks,e.pass=r,e.alphaTest=t.alphaTest>0,e.blendType=t.blendType,e.screenSpace=i&&(256&i)!=0,e.skin=i&&(2&i)!=0,e.useInstancing=i&&(32&i)!=0,e.useMorphPosition=i&&(1024&i)!=0,e.useMorphNormal=i&&(2048&i)!=0,e.useMorphTextureBasedInt=i&&(8192&i)!=0,e.hasTangents=i&&(512&i)!=0,e.nineSlicedMode=t.nineSlicedMode||0,t.useLighting&&n.clusteredLightingEnabled?(e.clusteredLightingEnabled=true,e.clusteredLightingCookiesEnabled=n.lighting.cookiesEnabled,e.clusteredLightingShadowsEnabled=n.lighting.shadowsEnabled,e.clusteredLightingShadowType=n.lighting.shadowType,e.clusteredLightingAreaLightsEnabled=n.lighting.areaLightsEnabled):(e.clusteredLightingEnabled=false,e.clusteredLightingCookiesEnabled=false,e.clusteredLightingShadowsEnabled=false,e.clusteredLightingAreaLightsEnabled=false);},e.updateMaterialOptions=function(e,t){e.separateAmbient=false,e.pixelSnap=t.pixelSnap,e.ambientSH=t.ambientSH,e.twoSidedLighting=t.twoSidedLighting,e.occludeDirect=t.occludeDirect,e.occludeSpecular=t.occludeSpecular,e.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.useMsdf=false,e.msdfTextAttribute=false,e.alphaToCoverage=t.alphaToCoverage,e.opacityFadesSpecular=t.opacityFadesSpecular,e.opacityDither=t.opacityDither,e.cubeMapProjection=0,e.useSpecular=t.hasSpecular,e.useSpecularityFactor=t.hasSpecularityFactor,e.enableGGXSpecular=t.ggxSpecular,e.fresnelModel=t.fresnelModel,e.useRefraction=t.hasRefraction,e.useClearCoat=t.hasClearCoat,e.useSheen=t.hasSheen,e.useIridescence=t.hasIrridescence,e.useMetalness=t.hasMetalness,e.useDynamicRefraction=t.dynamicRefraction,e.dispersion=t.dispersion>0,e.vertexColors=false,e.lightMapEnabled=t.hasLighting,e.dirLightMapEnabled=t.dirLightMap,e.useHeights=t.hasHeights,e.useNormals=t.hasNormals,e.useClearCoatNormals=t.hasClearCoatNormals,e.useAo=t.hasAo,e.diffuseMapEnabled=t.hasDiffuseMap;},e.updateEnvOptions=function(e,t,n,i){e.fog=t.useFog?i.fog:on,e.gamma=i.shaderOutputGamma,e.toneMap=t.useTonemap?i.toneMapping:6,t.useSkybox&&n.envAtlas&&n.skybox?(e.reflectionSource=om,e.reflectionEncoding=n.envAtlas.encoding,e.reflectionCubemapEncoding=n.skybox.encoding):t.useSkybox&&n.envAtlas?(e.reflectionSource=op,e.reflectionEncoding=n.envAtlas.encoding):t.useSkybox&&n.skybox?(e.reflectionSource=o_,e.reflectionEncoding=n.skybox.encoding):(e.reflectionSource=od,e.reflectionEncoding=null),t.ambientSH?(e.ambientSource=oy,e.ambientEncoding=null):e.reflectionSource!==od&&n.envAtlas?(e.ambientSource=oS,e.ambientEncoding=n.envAtlas.encoding):(e.ambientSource=ox,e.ambientEncoding=null);var r=e.reflectionSource!==od;e.skyboxIntensity=r,e.useCubeMapRotation=r&&n._skyboxRotationShaderInclude;},e.updateLightingOptions=function(t,n,i,r,s){if(t.lightMapWithoutAmbient=false,n.useLighting){var a=[],o=r?r>>16:1;t.lightMaskDynamic=!!(1&o),t.lightMapWithoutAmbient=false,s&&(e.collectLights(0,s[0],a,o),i.clusteredLightingEnabled||(e.collectLights(1,s[1],a,o),e.collectLights(2,s[2],a,o))),t.lights=a;}else t.lights=[];(0!==t.lights.length||i.clusteredLightingEnabled)&&(1&r)==0||(t.noShadow=true);},e.collectLights=function(e,t,n,i){for(var r=0;r<t.length;r++){var s=t[r];s.enabled&&s.mask&i&&n.push(s);}},e}();function f4(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}var f5={vertex_normal:tE,vertex_tangent:tw,vertex_texCoord0:tL,vertex_texCoord1:tD,vertex_color:tP,vertex_boneWeights:tA,vertex_boneIndices:tC},f8=function(){function e(e,t,n){var i=this;void 0===n&&(n=true),this.varyingsCode="",this.vDefines=new Map,this.fDefines=new Map,this.includes=new Map,this.chunks=null,this.device=e,this.options=t;var r=t.shaderChunks;if(this.shaderLanguage=e.isWebGPU&&n&&(null==r?void 0:r.useWGSL)?ni:nn,this.attributes={vertex_position:tT},t.userAttributes)for(var s,a=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return f4(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return f4(e,void 0)}}(e))){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(Object.entries(t.userAttributes));!(s=a()).done;){var o=s.value,l=o[0],u=o[1];this.attributes[u]=l;}var c=o0.get(e,this.shaderLanguage);this.chunks=new Map(c),r&&(this.shaderLanguage===nn?r.glsl:r.wgsl).forEach(function(e,t){for(var n in f5)f5.hasOwnProperty(n)&&e.indexOf(n)>=0&&(i.attributes[n]=f5[n]);i.chunks.set(t,e);}),this.shaderPassInfo=oW.get(this.device).getByIndex(t.pass),this.shadowPass=this.shaderPassInfo.isShadow,this.lighting=t.lights.length>0||t.dirLightMapEnabled||t.clusteredLightingEnabled,this.reflections=t.reflectionSource!==od,this.needsNormal=this.lighting||this.reflections||t.useSpecular||t.ambientSH||t.useHeights||t.enableGGXSpecular||t.clusteredLightingEnabled&&!this.shadowPass||t.useClearCoatNormals,this.needsNormal=this.needsNormal&&!this.shadowPass,this.needsSceneColor=t.useDynamicRefraction,this.needsScreenSize=t.useDynamicRefraction,this.needsTransforms=t.useDynamicRefraction,this.vshader=null,this.fshader=null;}var t=e.prototype;return t.fDefineSet=function(e,t,n){ void 0===n&&(n=""),e&&this.fDefines.set(t,n);},t.generateVertexShader=function(e,t,n){var i=this,r=this.options,s=this.vDefines,a=this.attributes,o=new Map;if(o.set("vPositionW","vec3"),(1===r.nineSlicedMode||2===r.nineSlicedMode)&&s.set("NINESLICED",true),this.options.linearDepth&&(s.set("LINEAR_DEPTH",true),o.set("vLinearDepth","float")),this.needsNormal&&s.set("NORMALS",true),this.options.useInstancing){var l=o0.get(this.device,this.shaderLanguage);this.chunks.get("transformInstancingVS")===l.get("transformInstancingVS")&&(a.instance_line1=tK,a.instance_line2=tZ,a.instance_line3=tJ,a.instance_line4=t$);}this.needsNormal&&(a.vertex_normal=tE,o.set("vNormalW","vec3"),r.hasTangents&&(r.useHeights||r.useNormals||r.useClearCoatNormals||r.enableGGXSpecular)?(s.set("TANGENTS",true),a.vertex_tangent=tw,o.set("vTangentW","vec3"),o.set("vBinormalW","vec3")):r.enableGGXSpecular&&(s.set("GGX_SPECULAR",true),o.set("vObjectSpaceUpW","vec3")));for(var u=0;u<2;u++)e[u]&&(s.set("UV"+u,true),a["vertex_texCoord"+u]="TEXCOORD"+u),t[u]&&(s.set("UV"+u+"_UNMODIFIED",true),o.set("vUv"+u,"vec2"));var c=0,h=new Set;n.forEach(function(e){var t=e.id,n=e.uv,i=e.name,r=t+100*n;!h.has(r)&&(h.add(r),o.set("vUV"+n+"_"+t,"vec2"),s.set("{TRANSFORM_NAME_"+c+"}","texture_"+i+"MapTransform"),s.set("{TRANSFORM_UV_"+c+"}",n),s.set("{TRANSFORM_ID_"+c+"}",t),c++);}),s.set("UV_TRANSFORMS_COUNT",c),r.vertexColors&&(a.vertex_color=tP,s.set("VERTEX_COLOR",true),o.set("vVertexColor","vec4")),r.useMsdf&&r.msdfTextAttribute&&(a.vertex_outlineParameters=tX,a.vertex_shadowParameters=tY,s.set("MSDF",true)),(r.useMorphPosition||r.useMorphNormal)&&(s.set("MORPHING",true),r.useMorphTextureBasedInt&&s.set("MORPHING_INT",true),r.useMorphPosition&&s.set("MORPHING_POSITION",true),r.useMorphNormal&&s.set("MORPHING_NORMAL",true),a.morph_vertex_id=t$),r.skin&&(a.vertex_boneIndices=tC,r.batch?s.set("BATCH",true):(a.vertex_boneWeights=tA,s.set("SKIN",true))),r.useInstancing&&s.set("INSTANCING",true),r.screenSpace&&s.set("SCREENSPACE",true),r.pixelSnap&&s.set("PIXELSNAP",true),o.forEach(function(e,t){i.varyingsCode+="#define VARYING_"+t.toUpperCase()+"\n",i.varyingsCode+=i.shaderLanguage===ni?"varying "+t+": "+ny.get(e)+";\n":"varying "+e+" "+t+";\n";}),this.includes.set("varyingsVS",this.varyingsCode),this.includes.set("varyingsPS",this.varyingsCode),this.vshader='\n            #include "litMainVS"\n        ';},t._setupLightingDefines=function(e,t){var n=this.fDefines,i=this.options;if(this.fDefines.set("LIGHT_COUNT",i.lights.length),e&&n.set("AREA_LIGHTS",true),t&&this.lighting&&(n.set("LIT_CLUSTERED_LIGHTS",true),i.clusteredLightingCookiesEnabled&&n.set("CLUSTER_COOKIES",true),i.clusteredLightingAreaLightsEnabled&&n.set("CLUSTER_AREALIGHTS",true),i.lightMaskDynamic&&n.set("CLUSTER_MESH_DYNAMIC_LIGHTS",true),i.clusteredLightingShadowsEnabled&&!i.noShadow)){var r=ol.get(i.clusteredLightingShadowType);n.set("CLUSTER_SHADOWS",true),n.set("SHADOW_KIND_"+r.kind,true),n.set("CLUSTER_SHADOW_TYPE_"+r.kind,true);}for(var s=0;s<i.lights.length;s++){var a=i.lights[s],o=a._type;if(!t||0===o){var l=e&&a._shape?a._shape:0,u=a._shadowType,c=a.castShadows&&!i.noShadow,h=ol.get(u);n.set("LIGHT"+s,true),n.set("LIGHT"+s+"TYPE",""+os[o]),n.set("LIGHT"+s+"SHADOWTYPE",""+h.name),n.set("LIGHT"+s+"SHAPE",""+oa[l]),n.set("LIGHT"+s+"FALLOFF",""+oo[a._falloffMode]),a.affectSpecularity&&n.set("LIGHT"+s+"AFFECT_SPECULARITY",true),a._cookie&&(2===o&&!a._cookie._cubemap||1===o&&a._cookie._cubemap)&&(n.set("LIGHT"+s+"COOKIE",true),n.set("{LIGHT"+s+"COOKIE_CHANNEL}",a._cookieChannel),2===o&&(a._cookieTransform&&n.set("LIGHT"+s+"COOKIE_TRANSFORM",true),a._cookieFalloff&&n.set("LIGHT"+s+"COOKIE_FALLOFF",true))),c&&(n.set("LIGHT"+s+"CASTSHADOW",true),h.pcf&&n.set("LIGHT"+s+"SHADOW_PCF",true),a._normalOffsetBias&&!a._isVsm&&n.set("LIGHT"+s+"_SHADOW_SAMPLE_NORMAL_OFFSET",true),0===o&&(n.set("LIGHT"+s+"_SHADOW_SAMPLE_ORTHO",true),a.cascadeBlend>0&&n.set("LIGHT"+s+"_SHADOW_CASCADE_BLEND",true),a.numCascades>1&&n.set("LIGHT"+s+"_SHADOW_CASCADES",true)),(h.pcf||h.pcss||this.device.isWebGPU)&&n.set("LIGHT"+s+"_SHADOW_SAMPLE_SOURCE_ZBUFFER",true),1===o&&n.set("LIGHT"+s+"_SHADOW_SAMPLE_POINT",true)),c&&(n.set("SHADOW_KIND_"+h.kind,true),0===o&&n.set("SHADOW_DIRECTIONAL",true));}}},t.prepareForwardPass=function(e){var t=this.options,n=t.clusteredLightingEnabled&&t.clusteredLightingAreaLightsEnabled||t.lights.some(function(e){return e._shape&&0!==e._shape}),i=!t.lightMapEnabled||t.lightMapWithoutAmbient,r=this.needsNormal&&(t.useNormals||t.useClearCoatNormals||t.enableGGXSpecular&&!t.useHeights);t.useSpecular&&(this.fDefineSet(true,"LIT_SPECULAR"),this.fDefineSet(this.reflections,"LIT_REFLECTIONS"),this.fDefineSet(t.useClearCoat,"LIT_CLEARCOAT"),this.fDefineSet(t.fresnelModel>0,"LIT_SPECULAR_FRESNEL"),this.fDefineSet(t.useSheen,"LIT_SHEEN"),this.fDefineSet(t.useIridescence,"LIT_IRIDESCENCE")),this.fDefineSet(this.lighting&&t.useSpecular||this.reflections,"LIT_SPECULAR_OR_REFLECTION"),this.fDefineSet(this.needsSceneColor,"LIT_SCENE_COLOR"),this.fDefineSet(this.needsScreenSize,"LIT_SCREEN_SIZE"),this.fDefineSet(this.needsTransforms,"LIT_TRANSFORMS"),this.fDefineSet(this.needsNormal,"LIT_NEEDS_NORMAL"),this.fDefineSet(this.lighting,"LIT_LIGHTING"),this.fDefineSet(t.useMetalness,"LIT_METALNESS"),this.fDefineSet(t.enableGGXSpecular,"LIT_GGX_SPECULAR"),this.fDefineSet(t.useSpecularityFactor,"LIT_SPECULARITY_FACTOR"),this.fDefineSet(t.useCubeMapRotation,"CUBEMAP_ROTATION"),this.fDefineSet(t.occludeSpecularFloat,"LIT_OCCLUDE_SPECULAR_FLOAT"),this.fDefineSet(t.separateAmbient,"LIT_SEPARATE_AMBIENT"),this.fDefineSet(t.twoSidedLighting,"LIT_TWO_SIDED_LIGHTING"),this.fDefineSet(t.lightMapEnabled,"LIT_LIGHTMAP"),this.fDefineSet(t.dirLightMapEnabled,"LIT_DIR_LIGHTMAP"),this.fDefineSet(t.skyboxIntensity>0,"LIT_SKYBOX_INTENSITY"),this.fDefineSet(t.clusteredLightingShadowsEnabled,"LIT_CLUSTERED_SHADOWS"),this.fDefineSet(t.clusteredLightingAreaLightsEnabled,"LIT_CLUSTERED_AREA_LIGHTS"),this.fDefineSet(r,"LIT_TBN"),this.fDefineSet(i,"LIT_ADD_AMBIENT"),this.fDefineSet(t.hasTangents,"LIT_TANGENTS"),this.fDefineSet(t.useNormals,"LIT_USE_NORMALS"),this.fDefineSet(t.useClearCoatNormals,"LIT_USE_CLEARCOAT_NORMALS"),this.fDefineSet(t.useRefraction,"LIT_REFRACTION"),this.fDefineSet(t.useDynamicRefraction,"LIT_DYNAMIC_REFRACTION"),this.fDefineSet(t.dispersion,"LIT_DISPERSION"),this.fDefineSet(t.useHeights,"LIT_HEIGHTS"),this.fDefineSet(t.opacityFadesSpecular,"LIT_OPACITY_FADES_SPECULAR"),this.fDefineSet(t.alphaToCoverage,"LIT_ALPHA_TO_COVERAGE"),this.fDefineSet(t.alphaTest,"LIT_ALPHA_TEST"),this.fDefineSet(t.useMsdf,"LIT_MSDF"),this.fDefineSet(t.ssao,"LIT_SSAO"),this.fDefineSet(t.useAo,"LIT_AO"),this.fDefineSet(t.occludeDirect,"LIT_OCCLUDE_DIRECT"),this.fDefineSet(t.msdfTextAttribute,"LIT_MSDF_TEXT_ATTRIBUTE"),this.fDefineSet(t.diffuseMapEnabled,"LIT_DIFFUSE_MAP"),this.fDefineSet(t.shadowCatcher,"LIT_SHADOW_CATCHER"),this.fDefineSet(true,"LIT_FRESNEL_MODEL",or[t.fresnelModel]),this.fDefineSet(true,"LIT_NONE_SLICE_MODE",oT[t.nineSlicedMode]),this.fDefineSet(true,"LIT_BLEND_TYPE",ot[t.blendType]),this.fDefineSet(true,"LIT_CUBEMAP_PROJECTION",ou[t.cubeMapProjection]),this.fDefineSet(true,"LIT_OCCLUDE_SPECULAR",of[t.occludeSpecular]),this.fDefineSet(true,"LIT_REFLECTION_SOURCE",og[t.reflectionSource]),this.fDefineSet(true,"LIT_AMBIENT_SOURCE",ob[t.ambientSource]),this.fDefineSet(true,"{lightingUv}",null!=e?e:""),this.fDefineSet(true,"{reflectionDecode}",h8.decodeFunc(t.reflectionEncoding)),this.fDefineSet(true,"{reflectionCubemapDecode}",h8.decodeFunc(t.reflectionCubemapEncoding)),this.fDefineSet(true,"{ambientDecode}",h8.decodeFunc(t.ambientEncoding)),this._setupLightingDefines(n,t.clusteredLightingEnabled);},t.prepareShadowPass=function(){var e=this.options,t=this.shaderPassInfo.lightType,n=this.shaderPassInfo.shadowType,i=ol.get(n),r=0===t||!i.vsm&&2===t;this.fDefineSet(r,"PERSPECTIVE_DEPTH"),this.fDefineSet(true,"LIGHT_TYPE",""+os[t]),this.fDefineSet(true,"SHADOW_TYPE",""+i.name),this.fDefineSet(e.alphaTest,"LIT_ALPHA_TEST");},t.generateFragmentShader=function(e,t,n){var i=this.options;this.includes.set("frontendDeclPS",null!=e?e:""),this.includes.set("frontendCodePS",null!=t?t:""),3===i.pass||1===i.pass||(this.shadowPass?this.prepareShadowPass():this.prepareForwardPass(n)),this.fshader='\n            #include "litMainPS"\n        ';},e}(),f6={generateKey:function(e){return "lit"+Object.keys(e).sort().map(function(t){if("shaderChunks"===t){var n,i;return null!=(i=null==(n=e.shaderChunks)?void 0:n.key)?i:""}return "lights"===t?f6.generateLightsKey(e):t+e[t]}).join("\n")},generateLightsKey:function(e){return "lights:"+e.lights.map(function(t){return e.clusteredLightingEnabled&&0!==t._type?"":""+t.key+","}).join("")}};function f9(e,t){return (f9=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var f7=[0,1,2,3,4,5,6,7],de=new(function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){return e.apply(this,arguments)||this}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&f9(t,e);var n=t.prototype;return n.generateKey=function(e){var t,n,i=oV.definesHash(e.defines),r=n2(null!=(t=e.shaderChunkGLSL)?t:""),s=n2(null!=(n=e.shaderChunkWGSL)?n:""),a=f6.generateKey(e.litOptions);return "lit_"+i+"_"+f7.map(function(t,n){return e.usedUvs[n]?"1":"0"}).join("")+"_"+r+"_"+s+"_"+a},n.createShaderDefinition=function(e,t){var n=!!t.shaderChunkWGSL,i=new f8(e,t.litOptions,n),r={name:"LitShader",shaderLanguage:i.shaderLanguage,tag:i.shaderPassInfo.isForward?1:void 0},s=t.usedUvs||[true];i.generateVertexShader(s,s,[]),i.generateFragmentShader("",i.shaderLanguage===ni?t.shaderChunkWGSL:t.shaderChunkGLSL,"vUv0");var a=o2.merge(i.chunks,i.includes),o=i.vDefines;t.defines.forEach(function(e,t){return o.set(t,e)});var l=i.fDefines;return t.defines.forEach(function(e,t){return l.set(t,e)}),r.attributes=i.attributes,r.vertexCode=i.vshader,r.vertexIncludes=a,r.vertexDefines=o,r.fragmentCode=i.fshader,r.fragmentIncludes=a,r.fragmentDefines=l,rQ.createDefinition(e,r)},t}(oV));function dt(e,t){return (dt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var dn=new function(){this.litOptions=new f2;},di=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return t=e.apply(this,arguments)||this,t.usedUvs=[true],t.shaderChunkGLSL=null,t.shaderChunkWGSL=null,t.useLighting=true,t.useFog=true,t.useTonemap=true,t.useSkybox=true,t.ambientSH=null,t.pixelSnap=false,t.nineSlicedMode=null,t.twoSidedLighting=false,t.occludeDirect=false,t.occludeSpecular=1,t.occludeSpecularIntensity=1,t.opacityFadesSpecular=true,t.opacityDither=oA,t.opacityShadowDither=oA,t.shadowCatcher=false,t.ggxSpecular=false,t.fresnelModel=2,t.dynamicRefraction=false,t.hasAo=false,t.hasSpecular=false,t.hasSpecularityFactor=false,t.hasLighting=false,t.hasHeights=false,t.hasNormals=false,t.hasSheen=false,t.hasRefraction=false,t.hasIrridescence=false,t.hasMetalness=false,t.hasClearCoat=false,t.hasClearCoatNormals=false,t}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&dt(t,e),t.prototype.getShaderVariant=function(e){dn.usedUvs=this.usedUvs.slice(),dn.shaderChunkGLSL=this.shaderChunkGLSL,dn.shaderChunkWGSL=this.shaderChunkWGSL,dn.defines=o8.getCoreDefines(this,e),f3.update(dn.litOptions,this,e.scene,e.cameraShaderParams,e.objDefs,e.pass,e.sortedLights);var t=new oB(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),n=oz(e.device);return n.register("lit",de),n.getProgram("lit",dn,t,this.userId)},t}(uV),dr=function(){var e;function t(){this.defines=new Map,this.forceUv1=false,this.specularTint=false,this.metalnessTint=false,this.glossTint=false,this.emissiveEncoding="linear",this.lightMapEncoding="linear",this.packedNormal=false,this.normalDetailPackedNormal=false,this.clearCoatPackedNormal=false,this.glossInvert=false,this.sheenGlossInvert=false,this.clearCoatGlossInvert=false,this.useAO=false,this.litOptions=new f2;}return e=[{key:"pass",get:function(){return this.litOptions.pass}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}();function ds(e,t){return (ds=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var da=[],dl=function(e){return Object.keys(e).filter(function(e){return "litOptions"!==e}).sort()},du=new(function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return t=e.apply(this,arguments)||this,t.optionsContext=new dr,t.optionsContextMin=new dr,t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&ds(t,e);var n=t.prototype;return n.generateKey=function(e){var t;return e===this.optionsContextMin?(this.propsMin||(this.propsMin=dl(e)),t=this.propsMin):e===this.optionsContext?(this.props||(this.props=dl(e)),t=this.props):t=dl(e),"standard:\n"+oV.definesHash(e.defines)+"\n"+t.map(function(t){return t+e[t]}).join("\n")+f6.generateKey(e.litOptions)},n._getUvSourceExpression=function(e,t,n){var i,r=n[e],s=n[t],a=0===n.litOptions.pass;return a&&1===n.litOptions.nineSlicedMode||a&&2===n.litOptions.nineSlicedMode?i="nineSlicedUv":(i=0===r?"vUv"+s:"vUV"+s+"_"+r,n.heightMap&&"heightMapTransform"!==e&&(i+=" + dUvOffset")),i},n._validateMapChunk=function(e,t,n){},n._addMapDefines=function(e,t,n,i,r,s,a){ void 0===a&&(a=null);var o=""+t+"Map",l=t.toUpperCase(),u=""+o+"Channel",c=""+t+"VertexColorChannel",h=""+t+"Tint",f=""+t+"VertexColor",d=""+t+"Mode",p=""+t+"Invert",m=i[h],_=i[f],v=i[o],g=i[""+o+"Identifier"],y=i[d],S=r.get(n);if(v){e.set("STD_"+l+"_TEXTURE","");var x=this._getUvSourceExpression(""+o+"Transform",""+o+"Uv",i);e.set("{STD_"+l+"_TEXTURE_UV}",x),e.set("{STD_"+l+"_TEXTURE_CHANNEL}",i[u]);var b="{STD_"+l+"_TEXTURE_NAME}";if(S.includes(b)){var T="texture_"+o,E=s[g];E?T=E:(s[g]=T,e.set("STD_"+l+"_TEXTURE_ALLOCATE","")),e.set(b,T);}if(a){var w="aaa"===i[u]?"passThrough":h8.decodeFunc(a);e.set("{STD_"+l+"_TEXTURE_DECODE}",w);}}_&&(e.set("STD_"+l+"_VERTEX",""),e.set("{STD_"+l+"_VERTEX_CHANNEL}",i[c])),y&&e.set("{STD_"+l+"_DETAILMODE}",y),m&&e.set("STD_"+l+"_CONSTANT",""),i[p]&&e.set("STD_"+l+"_INVERT","");},n._correctChannel=function(e,t,n){if(n[e]>0){if(n[e]<t.length)return t.substring(0,n[e]);if(n[e]>t.length){for(var i=t,r=i.charAt(i.length-1),s=n[e]-i.length,a=0;a<s;a++)i+=r;return i}return t}},n.createVertexShader=function(e,t){var n=[],i=[],r=[];for(var s in da){var a=""+s+"Map";if(t[""+s+"VertexColor"]){var o=""+s+"VertexColorChannel";t[o]=this._correctChannel(s,t[o],da);}if(t[a]){var l=""+a+"Channel",u=""+a+"Transform",c=""+a+"Uv";t[c]=Math.min(t[c],1),t[l]=this._correctChannel(s,t[l],da);var h=t[c];n[h]=true,i[h]=i[h]||t[a]&&!t[u],t[u]&&r.push({name:s,id:t[u],uv:t[c]});}}t.forceUv1&&(n[1]=true,i[1]=void 0===i[1]||i[1]),e.generateVertexShader(n,i,r);},n.prepareFragmentDefines=function(e,t,n){var i=function(e,n,i){ void 0===i&&(i=""),e&&t.set(n,i);};i(e.lightMap,"STD_LIGHTMAP",""),i(e.lightVertexColor,"STD_LIGHT_VERTEX_COLOR",""),i(e.dirLightMap&&e.litOptions.useSpecular,"STD_LIGHTMAP_DIR",""),i(e.heightMap,"STD_HEIGHT_MAP",""),i(e.useSpecularColor,"STD_SPECULAR_COLOR",""),i(e.aoMap||e.aoVertexColor||e.useAO,"STD_AO",""),i(true,"STD_OPACITY_DITHER",oL[n.isForward?e.litOptions.opacityDither:e.litOptions.opacityShadowDither]);},n.createShaderDefinition=function(e,t){var n=oW.get(e).getByIndex(t.litOptions.pass),i=n.isForward,r=new f8(e,t.litOptions);this.createVertexShader(r,t);var s={};t.litOptions.fresnelModel=0===t.litOptions.fresnelModel?2:t.litOptions.fresnelModel;var a=r.fDefines;this.prepareFragmentDefines(t,a,n);var o="";if(i){if(t.heightMap&&this._addMapDefines(a,"height","parallaxPS",t,r.chunks,s),(3!==t.litOptions.blendType||t.litOptions.alphaTest||t.litOptions.alphaToCoverage||t.litOptions.opacityDither!==oA)&&this._addMapDefines(a,"opacity","opacityPS",t,r.chunks,s),r.needsNormal){if((t.normalMap||t.clearCoatNormalMap)&&!t.litOptions.hasTangents){var l=t.normalMap?"normalMap":"clearCoatNormalMap";o=this._getUvSourceExpression(""+l+"Transform",""+l+"Uv",t);}this._addMapDefines(a,"normalDetail","normalMapPS",t,r.chunks,s,t.normalDetailPackedNormal?"xy":"xyz"),this._addMapDefines(a,"normal","normalMapPS",t,r.chunks,s,t.packedNormal?"xy":"xyz");}t.diffuseDetail&&this._addMapDefines(a,"diffuseDetail","diffusePS",t,r.chunks,s,t.diffuseDetailEncoding),this._addMapDefines(a,"diffuse","diffusePS",t,r.chunks,s,t.diffuseEncoding),t.litOptions.useRefraction&&(this._addMapDefines(a,"refraction","transmissionPS",t,r.chunks,s),this._addMapDefines(a,"thickness","thicknessPS",t,r.chunks,s)),t.litOptions.useIridescence&&(this._addMapDefines(a,"iridescence","iridescencePS",t,r.chunks,s),this._addMapDefines(a,"iridescenceThickness","iridescenceThicknessPS",t,r.chunks,s)),(r.lighting&&t.litOptions.useSpecular||r.reflections)&&(t.litOptions.useSheen&&(this._addMapDefines(a,"sheen","sheenPS",t,r.chunks,s,t.sheenEncoding),this._addMapDefines(a,"sheenGloss","sheenGlossPS",t,r.chunks,s)),t.litOptions.useMetalness&&(this._addMapDefines(a,"metalness","metalnessPS",t,r.chunks,s),this._addMapDefines(a,"ior","iorPS",t,r.chunks,s)),t.litOptions.useSpecularityFactor&&this._addMapDefines(a,"specularityFactor","specularityFactorPS",t,r.chunks,s),t.useSpecularColor&&this._addMapDefines(a,"specular","specularPS",t,r.chunks,s,t.specularEncoding),this._addMapDefines(a,"gloss","glossPS",t,r.chunks,s)),t.aoDetail&&this._addMapDefines(a,"aoDetail","aoPS",t,r.chunks,s),(t.aoMap||t.aoVertexColor||t.useAO)&&this._addMapDefines(a,"ao","aoPS",t,r.chunks,s),this._addMapDefines(a,"emissive","emissivePS",t,r.chunks,s,t.emissiveEncoding),t.litOptions.useClearCoat&&(this._addMapDefines(a,"clearCoat","clearCoatPS",t,r.chunks,s),this._addMapDefines(a,"clearCoatGloss","clearCoatGlossPS",t,r.chunks,s),this._addMapDefines(a,"clearCoatNormal","clearCoatNormalPS",t,r.chunks,s,t.clearCoatPackedNormal?"xy":"xyz")),t.litOptions.enableGGXSpecular&&this._addMapDefines(a,"anisotropy","anisotropyPS",t,r.chunks,s),(t.lightMap||t.lightVertexColor)&&this._addMapDefines(a,"light","lightmapPS",t,r.chunks,s,t.lightMapEncoding);}else {var u=t.litOptions.opacityShadowDither;(t.litOptions.alphaTest||u)&&this._addMapDefines(a,"opacity","opacityPS",t,r.chunks,s);}r.generateFragmentShader(r.chunks.get("stdDeclarationPS"),r.chunks.get("stdFrontEndPS"),o);var c=o2.merge(r.chunks,r.includes),h=r.vDefines;t.defines.forEach(function(e,t){return h.set(t,e)}),t.defines.forEach(function(e,t){return a.set(t,e)});var f=rQ.createDefinition(e,{name:"StandardShader",attributes:r.attributes,shaderLanguage:r.shaderLanguage,vertexCode:r.vshader,fragmentCode:r.fshader,vertexIncludes:c,fragmentIncludes:c,fragmentDefines:a,vertexDefines:h});return r.shaderPassInfo.isForward&&(f.tag=1),f},t}(oV)),dc=function(e,t){if(e.length!==t.length)return  false;for(var n=0;n<e.length;++n)if(e[n]!==t[n])return  false;return  true},dh=function(){function e(){this._mapXForms=null;}var t=e.prototype;return t.updateMinRef=function(e,t,n,i,r,s){this._updateSharedOptions(e,t,n,i,r),this._updateMinOptions(e,n,r),this._updateUVOptions(e,n,i,true);},t.updateRef=function(e,t,n,i,r,s,a){this._updateSharedOptions(e,t,i,r,s),this._updateEnvOptions(e,i,t,n),this._updateMaterialOptions(e,i,t),e.litOptions.hasTangents=r&&(512&r)!=0,this._updateLightOptions(e,t,i,r,a),this._updateUVOptions(e,i,r,false,n);},t._updateSharedOptions=function(e,t,n,i,r){e.forceUv1=n.forceUv1,n.userAttributes&&(e.litOptions.userAttributes=Object.fromEntries(n.userAttributes.entries())),e.litOptions.shaderChunks=n.shaderChunks,e.litOptions.pass=r,e.litOptions.alphaTest=n.alphaTest>0,e.litOptions.blendType=n.blendType,e.litOptions.screenSpace=i&&(256&i)!=0,e.litOptions.skin=i&&(2&i)!=0,e.litOptions.batch=i&&(16384&i)!=0,e.litOptions.useInstancing=i&&(32&i)!=0,e.litOptions.useMorphPosition=i&&(1024&i)!=0,e.litOptions.useMorphNormal=i&&(2048&i)!=0,e.litOptions.useMorphTextureBasedInt=i&&(8192&i)!=0,e.litOptions.nineSlicedMode=n.nineSlicedMode||0,t.clusteredLightingEnabled&&n.useLighting?(e.litOptions.clusteredLightingEnabled=true,e.litOptions.clusteredLightingCookiesEnabled=t.lighting.cookiesEnabled,e.litOptions.clusteredLightingShadowsEnabled=t.lighting.shadowsEnabled,e.litOptions.clusteredLightingShadowType=t.lighting.shadowType,e.litOptions.clusteredLightingAreaLightsEnabled=t.lighting.areaLightsEnabled):(e.litOptions.clusteredLightingEnabled=false,e.litOptions.clusteredLightingCookiesEnabled=false,e.litOptions.clusteredLightingShadowsEnabled=false,e.litOptions.clusteredLightingAreaLightsEnabled=false);},t._updateUVOptions=function(e,t,n,i,r){var s=false,a=false,o=false;n&&(s=(4&n)!=0,a=(8&n)!=0,o=(16&n)!=0),e.litOptions.vertexColors=false,this._mapXForms=[];var l={};for(var u in da)this._updateTexOptions(e,t,u,s,a,o,i,l);this._mapXForms=null,e.litOptions.ssao=null==r?void 0:r.ssaoEnabled,e.useAO=e.litOptions.ssao,e.litOptions.lightMapEnabled=e.lightMap,e.litOptions.dirLightMapEnabled=e.dirLightMap,e.litOptions.useHeights=e.heightMap,e.litOptions.useNormals=e.normalMap,e.litOptions.useClearCoatNormals=e.clearCoatNormalMap,e.litOptions.useAo=e.aoMap||e.aoVertexColor||e.litOptions.ssao,e.litOptions.diffuseMapEnabled=e.diffuseMap;},t._updateTexOptions=function(e,t,n,i,r,s,a,o){var l="opacity"===n;if(!a||l){var u=""+n+"Map",c=""+n+"VertexColor",h=""+n+"VertexColorChannel",f=""+u+"Channel",d=""+u+"Transform",p=""+u+"Uv",m=""+u+"Identifier";if("light"!==n&&(e[u]=false,e[m]=void 0,e[f]="",e[d]=0,e[p]=0),e[c]=false,e[h]="",l&&3===t.blendType&&0===t.alphaTest&&!t.alphaToCoverage&&t.opacityDither===oA)return;if("height"!==n&&t[c]&&s&&(e[c]=t[c],e[h]=t[h],e.litOptions.vertexColors=true),t[u]){var _=true;if(0!==t[p]||i||(_=false),1!==t[p]||r||(_=false),_){var v=t[u].id,g=o[v];void 0===g&&(o[v]=n,g=n),e[u]=!!t[u],e[m]=g,e[d]=this._getMapTransformID(t.getUniform(d),t[p]),e[f]=t[f],e[p]=t[p];}}}},t._updateMinOptions=function(e,t,n){var i=1===n;e.litOptions.opacityShadowDither=i?t.opacityDither:t.opacityShadowDither,e.litOptions.linearDepth=i,e.litOptions.lights=[];},t._updateMaterialOptions=function(e,t,n){var i,r,s,a,o,l,u,c,h=!!(t.useMetalness||t.specularMap||t.sphereMap||t.cubeMap||0!==(r=t.specular).r||0!==r.g||0!==r.b||t.specularityFactor>0&&t.useMetalness||t.enableGGXSpecular||t.clearCoat>0),f=!t.useMetalness||t.useMetalnessSpecularColor,d=h&&(t.specularTint||!t.specularMap&&!t.specularVertexColor)&&(1!==(i=t.specular).r||1!==i.g||1!==i.b),p=h&&t.useMetalnessSpecularColor&&(t.specularityFactorTint||t.specularityFactor<1&&!t.specularityFactorMap),m=function(e){return !!e&&(10===e.format||e.type===t4)},_=function(e,t){return 1e-4>Math.abs(e-t)};e.specularTint=d,e.specularityFactorTint=p,e.metalnessTint=t.useMetalness&&t.metalness<1,e.glossTint=true,e.diffuseEncoding=null==(s=t.diffuseMap)?void 0:s.encoding,e.diffuseDetailEncoding=null==(a=t.diffuseDetailMap)?void 0:a.encoding,e.emissiveEncoding=null==(o=t.emissiveMap)?void 0:o.encoding,e.lightMapEncoding=null==(l=t.lightMap)?void 0:l.encoding,e.packedNormal=m(t.normalMap),e.refractionTint=_(t.refraction,1),e.refractionIndexTint=_(t.refractionIndex,1/1.5),e.thicknessTint=t.useDynamicRefraction&&1!==t.thickness,e.specularEncoding=null==(u=t.specularMap)?void 0:u.encoding,e.sheenEncoding=null==(c=t.sheenMap)?void 0:c.encoding,e.aoMapUv=t.aoUvSet,e.aoDetail=!!t.aoDetailMap,e.diffuseDetail=!!t.diffuseDetailMap,e.normalDetail=!!t.normalMap,e.normalDetailPackedNormal=m(t.normalDetailMap),e.diffuseDetailMode=t.diffuseDetailMode,e.aoDetailMode=t.aoDetailMode,e.clearCoatGloss=!!t.clearCoatGloss,e.clearCoatPackedNormal=m(t.clearCoatNormalMap),e.iorTint=_(t.refractionIndex,1/1.5),n.forcePassThroughSpecular&&(e.specularEncoding="linear",e.sheenEncoding="linear"),e.iridescenceTint=1!==t.iridescence,e.glossInvert=t.glossInvert,e.sheenGlossInvert=t.sheenGlossInvert,e.clearCoatGlossInvert=t.clearCoatGlossInvert,e.useSpecularColor=f,e.litOptions.separateAmbient=false,e.litOptions.pixelSnap=t.pixelSnap,e.litOptions.ambientSH=!!t.ambientSH,e.litOptions.twoSidedLighting=t.twoSidedLighting,e.litOptions.occludeSpecular=t.occludeSpecular,e.litOptions.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.litOptions.useMsdf=!!t.msdfMap,e.litOptions.msdfTextAttribute=!!t.msdfTextAttribute,e.litOptions.alphaToCoverage=t.alphaToCoverage,e.litOptions.opacityFadesSpecular=t.opacityFadesSpecular,e.litOptions.opacityDither=t.opacityDither,e.litOptions.cubeMapProjection=t.cubeMapProjection,e.litOptions.occludeDirect=t.occludeDirect,e.litOptions.useSpecular=h,e.litOptions.useSpecularityFactor=(p||!!t.specularityFactorMap)&&t.useMetalnessSpecularColor,e.litOptions.enableGGXSpecular=t.enableGGXSpecular,e.litOptions.fresnelModel=t.fresnelModel,e.litOptions.useRefraction=(t.refraction||!!t.refractionMap)&&(t.useDynamicRefraction||e.litOptions.reflectionSource!==od),e.litOptions.useClearCoat=!!t.clearCoat,e.litOptions.useSheen=t.useSheen,e.litOptions.useIridescence=t.useIridescence&&0!==t.iridescence,e.litOptions.useMetalness=t.useMetalness,e.litOptions.useDynamicRefraction=t.useDynamicRefraction,e.litOptions.dispersion=t.dispersion>0,e.litOptions.shadowCatcher=t.shadowCatcher;},t._updateEnvOptions=function(e,t,n,i){e.litOptions.fog=t.useFog?i.fog:on,e.litOptions.gamma=i.shaderOutputGamma,e.litOptions.toneMap=t.useTonemap?i.toneMapping:6;var r=false;if(t.envAtlas&&t.cubeMap?(e.litOptions.reflectionSource=om,e.litOptions.reflectionEncoding=t.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=t.cubeMap.encoding):t.envAtlas?(e.litOptions.reflectionSource=op,e.litOptions.reflectionEncoding=t.envAtlas.encoding):t.cubeMap?(e.litOptions.reflectionSource=o_,e.litOptions.reflectionEncoding=t.cubeMap.encoding):t.sphereMap?(e.litOptions.reflectionSource=ov,e.litOptions.reflectionEncoding=t.sphereMap.encoding):t.useSkybox&&n.envAtlas&&n.skybox?(e.litOptions.reflectionSource=om,e.litOptions.reflectionEncoding=n.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=n.skybox.encoding,r=true):t.useSkybox&&n.envAtlas?(e.litOptions.reflectionSource=op,e.litOptions.reflectionEncoding=n.envAtlas.encoding,r=true):t.useSkybox&&n.skybox?(e.litOptions.reflectionSource=o_,e.litOptions.reflectionEncoding=n.skybox.encoding,r=true):(e.litOptions.reflectionSource=od,e.litOptions.reflectionEncoding=null),t.ambientSH)e.litOptions.ambientSource=oy,e.litOptions.ambientEncoding=null;else {var s=t.envAtlas||(t.useSkybox&&n.envAtlas?n.envAtlas:null);s&&!t.sphereMap?(e.litOptions.ambientSource=oS,e.litOptions.ambientEncoding=s.encoding):(e.litOptions.ambientSource=ox,e.litOptions.ambientEncoding=null);}e.litOptions.skyboxIntensity=r,e.litOptions.useCubeMapRotation=r&&n._skyboxRotationShaderInclude;},t._updateLightOptions=function(e,t,n,i,r){if(e.lightMap=false,e.lightMapChannel="",e.lightMapUv=0,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=false,e.dirLightMap=false,i&&(e.litOptions.noShadow=(1&i)!=0,(64&i)!=0&&(e.lightMapEncoding=7===t.lightmapPixelFormat?"rgbm":"linear",e.lightMap=true,e.lightMapChannel="rgb",e.lightMapUv=1,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!n.lightMap,(128&i)!=0&&(e.dirLightMap=true),(4096&i)!=0&&(e.litOptions.lightMapWithoutAmbient=false))),n.useLighting){var s=[],a=i?i>>16:1;e.litOptions.lightMaskDynamic=!!(1&a),r&&(f3.collectLights(0,r[0],s,a),t.clusteredLightingEnabled||(f3.collectLights(1,r[1],s,a),f3.collectLights(2,r[2],s,a))),e.litOptions.lights=s;}else e.litOptions.lights=[];0!==e.litOptions.lights.length||t.clusteredLightingEnabled||(e.litOptions.noShadow=true);},t._getMapTransformID=function(e,t){if(!e)return 0;var n=this._mapXForms[t];n||(n=[],this._mapXForms[t]=n);for(var i=0;i<n.length;i++)if(dc(n[i][0].value,e[0].value)&&dc(n[i][1].value,e[1].value))return i+1;return n.push(e)},e}();function df(){return (df=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);}return e}).apply(this,arguments)}function dd(e,t,n){ void 0===t&&(t=true),void 0===n&&(n=true);var i={};return i[""+e+"Map"]="texture",i[""+e+"MapTiling"]="vec2",i[""+e+"MapOffset"]="vec2",i[""+e+"MapRotation"]="number",i[""+e+"MapUv"]="number",t&&(i[""+e+"MapChannel"]="string",n&&(i[""+e+"VertexColor"]="boolean",i[""+e+"VertexColorChannel"]="string")),i}var dp=df({name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb"},dd("ao"),dd("aoDetail",true,false),{aoDetailMode:"string",aoIntensity:"number",diffuse:"rgb"},dd("diffuse"),dd("diffuseDetail",true,false),{diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean"},dd("specular"),{occludeSpecular:"enum:occludeSpecular",specularityFactor:"number",specularityFactorTint:"boolean"},dd("specularityFactor"),{useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",metalnessTint:"boolean"},dd("metalness"),{useMetalnessSpecularColor:"boolean",anisotropyIntensity:"number",anisotropyRotation:"number"},dd("anisotropy"),{shininess:"number",gloss:"number",glossInvert:"boolean"},dd("gloss"),{clearCoat:"number"},dd("clearCoat"),{clearCoatGloss:"number",clearCoatGlossInvert:"boolean"},dd("clearCoatGloss"),{clearCoatBumpiness:"number"},dd("clearCoatNormal",false),{useSheen:"boolean",sheen:"rgb"},dd("sheen"),{sheenGloss:"number",sheenGlossInvert:"boolean"},dd("sheenGloss"),{fresnelModel:"number",emissive:"rgb"},dd("emissive"),{emissiveIntensity:"number"},dd("normal",false),{bumpiness:"number"},dd("normalDetail",false),{normalDetailMapBumpiness:"number"},dd("height",true,false),{heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number"},dd("opacity"),{opacityFadesSpecular:"boolean",opacityDither:"string",opacityShadowDither:"string",reflectivity:"number",refraction:"number",refractionTint:"boolean"},dd("refraction"),{refractionIndex:"number",dispersion:"number",thickness:"number",thicknessTint:"boolean"},dd("thickness"),{attenuation:"rgb",attenuationDistance:"number",useDynamicRefraction:"boolean",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",useIridescence:"boolean",iridescence:"number",iridescenceTint:"boolean"},dd("iridescence"),{iridescenceThicknessTint:"boolean",iridescenceThicknessMin:"number",iridescenceThicknessMax:"number",iridescenceRefractionIndex:"number"},dd("iridescenceThickness"),dd("light"),{depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useTonemap:"boolean",envAtlas:"texture",twoSidedLighting:"boolean",shadowCatcher:"boolean"}),dm=[];for(var d_ in dp)"texture"===dp[d_]&&dm.push(d_);var dv=[];for(var dg in dp)"cubemap"===dp[dg]&&dv.push(dg);var dy={aoMapVertexColor:"boolean",diffuseMapTint:"boolean",diffuseMapVertexColor:"boolean",emissiveMapTint:"boolean",emissiveMapVertexColor:"boolean",glossMapVertexColor:"boolean",metalnessMapVertexColor:"boolean",opacityMapVertexColor:"boolean",specularAntialias:"boolean",specularMapTint:"boolean",specularMapVertexColor:"boolean",ambientTint:"boolean",emissiveTint:"boolean",diffuseTint:"boolean",sheenTint:"boolean",conserveEnergy:"boolean",useGamma:"boolean",useGammaTonemap:"boolean",sheenGlossTint:"boolean",anisotropy:"boolean"};function dS(e,t){return (dS=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var dx={},db={},dT=new Set,dE=new eN,dw=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return (t=e.call(this)||this).userAttributes=new Map,t._assetReferences={},t._activeParams=new Set,t._activeLightingParams=new Set,t.shaderOptBuilder=new dh,t.reset(),t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&dS(t,e);var n=t.prototype;return n.reset=function(){var e=this;Object.keys(dx).forEach(function(t){e["_"+t]=dx[t].value();}),this._uniformCache={};},n.copy=function(t){var n=this;return e.prototype.copy.call(this,t),Object.keys(dx).forEach(function(e){n[e]=t[e];}),this.userAttributes=new Map(t.userAttributes),this},n.setAttribute=function(e,t){this.userAttributes.set(t,e);},n._setParameter=function(e,t){dT.add(e),this.setParameter(e,t);},n._setParameters=function(e){var t=this;e.forEach(function(e){t._setParameter(e.name,e.value);});},n._processParameters=function(e){var t=this,n=this[e];n.forEach(function(e){dT.has(e)||delete t.parameters[e];}),this[e]=dT,(dT=n).clear();},n._updateMap=function(e){var t=""+e+"Map",n=this[t];if(n){this._setParameter("texture_"+t,n);var i=this.getUniform(""+t+"Transform");i&&this._setParameters(i);}},n._allocUniform=function(e,t){var n=this._uniformCache[e];return n||(n=t(),this._uniformCache[e]=n),n},n.getUniform=function(e,t,n){return db[e](this,t,n)},n.updateUniforms=function(t,n){var i=this,r=function(e){return i.getUniform(e,t,n)};for(var s in this._setParameter("material_ambient",r("ambient")),this._setParameter("material_diffuse",r("diffuse")),this._setParameter("material_aoIntensity",this.aoIntensity),this.useMetalness?((!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness),(!this.specularMap||this.specularTint)&&this._setParameter("material_specular",r("specular")),(!this.specularityFactorMap||this.specularityFactorTint)&&this._setParameter("material_specularityFactor",this.specularityFactor),this._setParameter("material_sheen",r("sheen")),this._setParameter("material_sheenGloss",this.sheenGloss),this._setParameter("material_refractionIndex",this.refractionIndex)):(!this.specularMap||this.specularTint)&&this._setParameter("material_specular",r("specular")),this.enableGGXSpecular&&(this._setParameter("material_anisotropyIntensity",this.anisotropyIntensity),this._setParameter("material_anisotropyRotation",[Math.cos(this.anisotropyRotation*ek.DEG_TO_RAD),Math.sin(this.anisotropyRotation*ek.DEG_TO_RAD)])),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGloss",this.clearCoatGloss),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_gloss",this.gloss),this._setParameter("material_emissive",r("emissive")),this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&this._setParameter("material_refraction",this.refraction),this.dispersion>0&&this._setParameter("material_dispersion",this.dispersion),this.useDynamicRefraction&&(this._setParameter("material_thickness",this.thickness),this._setParameter("material_attenuation",r("attenuation")),this._setParameter("material_invAttenuationDistance",0===this.attenuationDistance?0:1/this.attenuationDistance)),this.useIridescence&&(this._setParameter("material_iridescence",this.iridescence),this._setParameter("material_iridescenceRefractionIndex",this.iridescenceRefractionIndex),this._setParameter("material_iridescenceThicknessMin",this.iridescenceThicknessMin),this._setParameter("material_iridescenceThicknessMax",this.iridescenceThicknessMax)),this._setParameter("material_opacity",this.opacity),false===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),1===this.cubeMapProjection&&this._setParameter(r("cubeMapProjectionBox")),da)this._updateMap(s);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",r("heightMapFactor")),this.envAtlas&&this.cubeMap?(this._setParameter("texture_envAtlas",this.envAtlas),this._setParameter("texture_cubeMap",this.cubeMap)):this.envAtlas?this._setParameter("texture_envAtlas",this.envAtlas):this.cubeMap?this._setParameter("texture_cubeMap",this.cubeMap):this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),e.prototype.updateUniforms.call(this,t,n);},n.updateEnvUniforms=function(e,t){!(this.envAtlas||this.cubeMap||this.sphereMap)&&this.useSkybox&&(t.envAtlas&&t.skybox?(this._setParameter("texture_envAtlas",t.envAtlas),this._setParameter("texture_cubeMap",t.skybox)):t.envAtlas?this._setParameter("texture_envAtlas",t.envAtlas):t.skybox&&this._setParameter("texture_cubeMap",t.skybox)),this._processParameters("_activeLightingParams");},n.getShaderVariant=function(e){var t=e.device,n=e.scene,i=e.pass,r=e.objDefs,s=e.sortedLights,a=e.cameraShaderParams;this.updateEnvUniforms(t,n);var o=oW.get(t).getByIndex(i),l=3===i||1===i||o.isShadow,u=l?du.optionsContextMin:du.optionsContext;u.defines=o8.getCoreDefines(this,e),l?this.shaderOptBuilder.updateMinRef(u,n,this,r,i,s):this.shaderOptBuilder.updateRef(u,n,a,this,r,i,s),this.useFog||u.defines.set("FOG","NONE"),u.defines.set("TONEMAP",oh[u.litOptions.toneMap]),this.onUpdateShader&&(u=this.onUpdateShader(u));var c=new oB(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),h=oz(t);h.register("standard",du);var f=h.getProgram("standard",u,c,this.userId);return this._dirtyShader=false,f},n.destroy=function(){for(var t in this._assetReferences)this._assetReferences[t]._unbind();this._assetReferences=null,e.prototype.destroy.call(this);},t}(uV);dw.TEXTURE_PARAMETERS=dm,dw.CUBEMAP_PARAMETERS=dv;var dA=function(e,t){db[e]=t;},dC=function(e,t,n,i){Object.defineProperty(dw.prototype,e,{get:i||function(){return this["_"+e]},set:n}),dx[e]={value:t};},dP=function(e){var t="_"+e.name,n=e.dirtyShaderFunc||function(){return  true};dC(e.name,function(){return e.defaultValue},function(e){var i=this[t];i!==e&&(this._dirtyShader=this._dirtyShader||n(i,e),this[t]=e);},e.getterFunc);},dI=function(e){var t="_"+e.name,n=e.dirtyShaderFunc||function(){return  true};dC(e.name,function(){return e.defaultValue.clone()},function(e){var i=this[t];i.equals(e)||(this._dirtyShader=this._dirtyShader||n(i,e),this[t]=i.copy(e));},e.getterFunc);},dL=function(e){return e.defaultValue&&e.defaultValue.clone?dI(e):dP(e)};function dD(e,t,n,i){ void 0===t&&(t="rgb"),void 0===n&&(n=true),void 0===i&&(i=0),da[e]=t.length||-1,dL({name:""+e+"Map",defaultValue:null,dirtyShaderFunc:function(e,t){return !!e!=!!t||e&&(e.type!==t.type||e.format!==t.format)}}),dL({name:""+e+"MapTiling",defaultValue:new eX(1,1)}),dL({name:""+e+"MapOffset",defaultValue:new eX(0,0)}),dL({name:""+e+"MapRotation",defaultValue:0}),dL({name:""+e+"MapUv",defaultValue:i}),t&&(dL({name:""+e+"MapChannel",defaultValue:t}),n&&(dL({name:""+e+"VertexColor",defaultValue:false}),dL({name:""+e+"VertexColorChannel",defaultValue:t})));var r=""+e+"MapTiling",s=""+e+"MapOffset",a=""+e+"MapRotation",o=""+e+"MapTransform";dA(o,function(e,t,n){var i=e[r],l=e[s],u=e[a];if(1===i.x&&1===i.y&&0===l.x&&0===l.y&&0===u)return null;var c=e._allocUniform(o,function(){return [{name:"texture_"+o+"0",value:new Float32Array(3)},{name:"texture_"+o+"1",value:new Float32Array(3)}]}),h=Math.cos(u*ek.DEG_TO_RAD),f=Math.sin(u*ek.DEG_TO_RAD),d=c[0].value;d[0]=h*i.x,d[1]=-f*i.y,d[2]=l.x;var p=c[1].value;return p[0]=f*i.x,p[1]=h*i.y,p[2]=1-i.y-l.y,c});}function dM(e,t){dL({name:e,defaultValue:t,getterFunc:function(){return this._dirtyShader=true,this["_"+e]}}),dA(e,function(t,n,i){var r=t._allocUniform(e,function(){return new Float32Array(3)}),s=t[e];return dE.linear(s),r[0]=dE.r,r[1]=dE.g,r[2]=dE.b,r});}function dR(e,t,n){dL({name:e,defaultValue:t,dirtyShaderFunc:function(e,t){return (0===e||1===e)!=(0===t||1===t)}}),dA(e,n);}function dO(e,t){dL({name:e,defaultValue:null,dirtyShaderFunc:function(e,t){return !!e==!!t}}),dA(e,t);}function dk(e,t){dL({name:e,defaultValue:t});}function dN(e,t){return (dN=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}dM("ambient",new eN(1,1,1)),dM("diffuse",new eN(1,1,1)),dM("specular",new eN(0,0,0)),dM("emissive",new eN(0,0,0)),dM("sheen",new eN(1,1,1)),dM("attenuation",new eN(1,1,1)),dR("emissiveIntensity",1),dR("specularityFactor",1),dR("sheenGloss",0),dR("gloss",.25),dR("aoIntensity",1),dR("heightMapFactor",1,function(e,t,n){return .025*e.heightMapFactor}),dR("opacity",1),dR("alphaFade",1),dR("alphaTest",0),dR("bumpiness",1),dR("normalDetailMapBumpiness",1),dR("reflectivity",1),dR("occludeSpecularIntensity",1),dR("refraction",0),dR("refractionIndex",1/1.5),dR("dispersion",0),dR("thickness",0),dR("attenuationDistance",0),dR("metalness",1),dR("anisotropyIntensity",0),dR("anisotropyRotation",0),dR("clearCoat",0),dR("clearCoatGloss",1),dR("clearCoatBumpiness",1),dR("aoUvSet",0,null),dR("iridescence",0),dR("iridescenceRefractionIndex",1/1.5),dR("iridescenceThicknessMin",0),dR("iridescenceThicknessMax",0),dO("ambientSH"),dO("cubeMapProjectionBox",function(e,t,n){var i=e._allocUniform("cubeMapProjectionBox",function(){return [{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}]}),r=e.cubeMapProjectionBox.getMin(),s=i[0].value;s[0]=r.x,s[1]=r.y,s[2]=r.z;var a=e.cubeMapProjectionBox.getMax(),o=i[1].value;return o[0]=a.x,o[1]=a.y,o[2]=a.z,i}),dk("specularTint",false),dk("specularityFactorTint",false),dk("useMetalness",false),dk("useMetalnessSpecularColor",false),dk("useSheen",false),dk("enableGGXSpecular",false),dk("occludeDirect",false),dk("opacityFadesSpecular",true),dk("occludeSpecular",1),dk("fresnelModel",2),dk("useDynamicRefraction",false),dk("cubeMapProjection",0),dk("useFog",true),dk("useLighting",true),dk("useTonemap",true),dk("useSkybox",true),dk("forceUv1",false),dk("pixelSnap",false),dk("twoSidedLighting",false),dk("nineSlicedMode",void 0),dk("msdfTextAttribute",false),dk("useIridescence",false),dk("glossInvert",false),dk("sheenGlossInvert",false),dk("clearCoatGlossInvert",false),dk("opacityDither",oA),dk("opacityShadowDither",oA),dk("shadowCatcher",false),dD("diffuse"),dD("specular"),dD("emissive"),dD("thickness","g"),dD("specularityFactor","g"),dD("normal",""),dD("metalness","g"),dD("gloss","g"),dD("opacity","a"),dD("refraction","g"),dD("height","g",false),dD("ao","g"),dD("light","rgb",true,1),dD("msdf",""),dD("diffuseDetail","rgb",false),dD("normalDetail",""),dD("aoDetail","g",false),dD("clearCoat","g"),dD("clearCoatGloss","g"),dD("clearCoatNormal",""),dD("sheen","rgb"),dD("sheenGloss","g"),dD("iridescence","g"),dD("iridescenceThickness","g"),dD("anisotropy",""),dk("diffuseDetailMode","mul"),dk("aoDetailMode","mul"),dO("cubeMap"),dO("sphereMap"),dO("envAtlas"),s=[null,null,null,null,null,null],dC("prefilteredCubemaps",function(){return s.slice()},function(e){var t=this._prefilteredCubemaps;e=e||[];for(var n=false,i=true,r=0;r<6;++r){var s=e[r]||null;t[r]!==s&&(t[r]=s,n=true),i=i&&!!t[r];}n&&(i?this.envAtlas=fk.generatePrefilteredAtlas(t,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=true);},function(){return this._prefilteredCubemaps});var dF=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i,r,s,a){var o,l=e.call(this)||this,u=new eW,c=new eW,h=new eW,f=new eW,d=new eW,p=new eW,m=[],_=[],v=[],g=[],y=[];if(i>0)for(var S=0;S<=r;S++)for(var x=0;x<=s;x++){var b=x/s*2*Math.PI-Math.PI,T=Math.sin(b),E=Math.cos(b);d.set(T*t,-i/2,E*t),f.set(T*n,i/2,E*n),u.lerp(d,f,S/r),c.sub2(f,d).normalize(),p.set(E,0,-T),h.cross(p,c).normalize(),m.push(u.x,u.y,u.z),_.push(h.x,h.y,h.z);var w=x/s,A=S/r;v.push(w,1-A);var C=A;if(A=w,w=.875*(w=C)+.0625,A=.875*A+.0625,w/=3,g.push(w,1-A),S<r&&x<s){var P=S*(s+1)+x,I=S*(s+1)+(x+1),L=(S+1)*(s+1)+x,D=(S+1)*(s+1)+(x+1);y.push(P,I,L),y.push(I,D,L);}}if(a){for(var M=Math.floor(s/2),R=i/2,O=0;O<=M;O++)for(var k=O*Math.PI*.5/M,N=Math.sin(k),F=Math.cos(k),B=0;B<=s;B++){var U=2*B*Math.PI/s-Math.PI/2,z=Math.sin(U),V=Math.cos(U)*N,G=z*N,H=1-B/s,W=1-O/M;m.push(V*n,F*n+R,G*n),_.push(V,F,G),v.push(H,1-W),W=(.875*W+.0625)/3,H=(.875*H+.0625)/3+1/3,g.push(H,1-W);}o=(r+1)*(s+1);for(var j=0;j<M;++j)for(var X=0;X<s;++X){var Y=j*(s+1)+X,q=Y+s+1;y.push(o+Y+1,o+q,o+Y),y.push(o+Y+1,o+q+1,o+q);}for(var K=0;K<=M;K++)for(var Z=.5*Math.PI+K*Math.PI*.5/M,Q=Math.sin(Z),J=Math.cos(Z),$=0;$<=s;$++){var ee=2*$*Math.PI/s-Math.PI/2,et=Math.sin(ee),en=Math.cos(ee)*Q,ei=et*Q,er=1-$/s,es=1-K/M;m.push(en*n,J*n-R,ei*n),_.push(en,J,ei),v.push(er,1-es),es=(.875*es+.0625)/3,er=(.875*er+.0625)/3+2/3,g.push(er,1-es);}o=(r+1)*(s+1)+(s+1)*(M+1);for(var ea=0;ea<M;++ea)for(var eo=0;eo<s;++eo){var el=ea*(s+1)+eo,eu=el+s+1;y.push(o+el+1,o+eu,o+el),y.push(o+el+1,o+eu+1,o+eu);}}else {if(o=(r+1)*(s+1),t>0)for(var ec=0;ec<s;ec++){var eh=ec/s*2*Math.PI,ef=Math.sin(eh),ed=-i/2,ep=Math.cos(eh),em=1-(ef+1)/2,e_=(ep+1)/2;m.push(ef*t,ed,ep*t),_.push(0,-1,0),v.push(em,1-e_),e_=(.875*e_+.0625)/3,em=(.875*em+.0625)/3+1/3,g.push(em,1-e_),ec>1&&y.push(o,o+ec,o+ec-1);}if(o+=s,n>0)for(var ev=0;ev<s;ev++){var eg=ev/s*2*Math.PI,ey=Math.sin(eg),eS=i/2,ex=Math.cos(eg),eb=1-(ey+1)/2,eT=(ex+1)/2;m.push(ey*n,eS,ex*n),_.push(0,1,0),v.push(eb,1-eT),eT=(.875*eT+.0625)/3,eb=(.875*eb+.0625)/3+2/3,g.push(eb,1-eT),ev>1&&y.push(o,o+ev-1,o+ev);}}return l.positions=m,l.normals=_,l.uvs=v,l.uvs1=g,l.indices=y,l}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&dN(t,e),t}(h7);function dB(e,t){return (dB=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var dU=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){ void 0===t&&(t={});var n,i,r,s,a,o=null!=(i=t.radius)?i:.3,l=null!=(r=t.height)?r:1,u=null!=(s=t.heightSegments)?s:1,c=null!=(a=t.sides)?a:20;return n=e.call(this,o,o,l-2*o,u,c,true)||this,t.calculateTangents&&(n.tangents=h9(n.positions,n.normals,n.uvs,n.indices)),n}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&dB(t,e),t}(dF);function dz(e,t){return (dz=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var dV=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){ void 0===t&&(t={});var n,i,r,s,a,o,l=null!=(i=t.baseRadius)?i:.5,u=null!=(r=t.peakRadius)?r:0,c=null!=(s=t.height)?s:1,h=null!=(a=t.heightSegments)?a:5,f=null!=(o=t.capSegments)?o:18;return n=e.call(this,l,u,c,h,f,false)||this,t.calculateTangents&&(n.tangents=h9(n.positions,n.normals,n.uvs,n.indices)),n}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&dz(t,e),t}(dF);function dG(e,t){return (dG=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var dH=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){ void 0===t&&(t={});var n,i,r,s,a,o=null!=(i=t.radius)?i:.5,l=null!=(r=t.height)?r:1,u=null!=(s=t.heightSegments)?s:5,c=null!=(a=t.capSegments)?a:20;return n=e.call(this,o,o,l,u,c,false)||this,t.calculateTangents&&(n.tangents=h9(n.positions,n.normals,n.uvs,n.indices)),n}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&dG(t,e),t}(dF);function dW(e,t){return (dW=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var dj=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){ void 0===t&&(t={});for(var n,i,r,s=e.call(this)||this,a=null!=(n=t.halfExtents)?n:new eX(.5,.5),o=null!=(i=t.widthSegments)?i:5,l=null!=(r=t.lengthSegments)?r:5,u=[],c=[],h=[],f=[],d=0,p=0;p<=o;p++)for(var m=0;m<=l;m++){var _=-a.x+2*a.x*p/o,v=-(-a.y+2*a.y*m/l),g=p/o,y=m/l;u.push(_,0,v),c.push(0,1,0),h.push(g,1-y),p<o&&m<l&&(f.push(d+l+1,d+1,d),f.push(d+l+1,d+l+2,d+1)),d++;}return s.positions=u,s.normals=c,s.uvs=h,s.uvs1=h,s.indices=f,t.calculateTangents&&(s.tangents=h9(u,c,h,f)),s}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&dW(t,e),t}(h7);function dX(e,t){return (dX=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var dY=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){ void 0===t&&(t={});for(var n,i,r,s,a,o=e.call(this)||this,l=null!=(n=t.tubeRadius)?n:.2,u=null!=(i=t.ringRadius)?i:.3,c=(null!=(r=t.sectorAngle)?r:360)*ek.DEG_TO_RAD,h=null!=(s=t.segments)?s:30,f=null!=(a=t.sides)?a:20,d=[],p=[],m=[],_=[],v=0;v<=f;v++)for(var g=0;g<=h;g++){var y=Math.cos(c*g/h)*(u+l*Math.cos(2*Math.PI*v/f)),S=Math.sin(2*Math.PI*v/f)*l,x=Math.sin(c*g/h)*(u+l*Math.cos(2*Math.PI*v/f)),b=Math.cos(c*g/h)*Math.cos(2*Math.PI*v/f),T=Math.sin(2*Math.PI*v/f),E=Math.sin(c*g/h)*Math.cos(2*Math.PI*v/f),w=v/f,A=1-g/h;if(d.push(y,S,x),p.push(b,T,E),m.push(w,1-A),v<f&&g<h){var C=v*(h+1)+g,P=(v+1)*(h+1)+g,I=v*(h+1)+(g+1),L=(v+1)*(h+1)+(g+1);_.push(C,P,I),_.push(P,L,I);}}return o.positions=d,o.normals=p,o.uvs=m,o.uvs1=m,o.indices=_,t.calculateTangents&&(o.tangents=h9(d,p,m,_)),o}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&dX(t,e),t}(h7),dq=function(){function e(e,t){var n=this;this.processedCache=new Map,this.definitionsCache=new Map,this._generators=new Map,this._device=e,this._isClearingCache=false,this._precached=false,this._programsCollection=[],this._defaultStdMatOption=new dr,this._defaultStdMatOptionMin=new dr;var i=new lW;t.shaderOptBuilder.updateRef(this._defaultStdMatOption,{},i,t,null,[],0,null),t.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,{},t,null,2,null),e.on("destroy:shader",function(e){n.removeFromCache(e);});}var t=e.prototype;return t.destroy=function(){this.clearCache();},t.register=function(e,t){this._generators.has(e)||this._generators.set(e,t);},t.unregister=function(e){this._generators.has(e)&&this._generators.delete(e);},t.isRegistered=function(e){return this._generators.has(e)},t.generateShaderDefinition=function(e,t,n,i){var r=this.definitionsCache.get(n);if(!r){(null==(s=i.litOptions)?void 0:s.lights)&&(o=i.litOptions.lights,i.litOptions.lights=o.map(function(e){var t=e.clone?e.clone():e;return t.key=e.key,t})),this.storeNewProgram(t,i),(null==(a=i.litOptions)?void 0:a.lights)&&(i.litOptions.lights=o),this._precached;var s,a,o,l,u=this._device;(r=e.createShaderDefinition(u,i)).name=null!=(l=r.name)?l:i.pass?t+"-pass:"+i.pass:t,this.definitionsCache.set(n,r);}return r},t.getCachedShader=function(e){return this.processedCache.get(e)},t.setCachedShader=function(e,t){this.processedCache.set(e,t);},t.getProgram=function(e,t,n,i){var r=this._generators.get(e);if(!r)return null;var s=n2(r.generateKey(t)),a=s+"#"+n2(n.generateKey(this._device)),o=this.getCachedShader(a);if(!o){var l,u=this.generateShaderDefinition(r,e,s,t),c="";void 0!==t.pass&&(c="-"+(l=oW.get(this._device).getByIndex(t.pass)).name),this._device.fire("shader:generate",{userMaterialId:i,shaderPassInfo:l,definition:u});var h={name:""+u.name+c+"-proc",attributes:u.attributes,vshader:u.vshader,vincludes:u.vincludes,fincludes:u.fincludes,fshader:u.fshader,processingOptions:n,shaderLanguage:u.shaderLanguage,meshUniformBufferFormat:u.meshUniformBufferFormat,meshBindGroupFormat:u.meshBindGroupFormat};o=new r$(this._device,h),this.setCachedShader(a,o);}return o},t.storeNewProgram=function(e,t){var n={};if("standard"===e){var i=this._getDefaultStdMatOptions(t.pass);for(var r in t)(t.hasOwnProperty(r)&&i[r]!==t[r]||"pass"===r)&&(n[r]=t[r]);for(var s in t.litOptions)n[s]=t.litOptions[s];}else n=t;this._programsCollection.push(JSON.stringify({name:e,options:n}));},t.dumpPrograms=function(){var e="let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\n";e+="let shaders = [",this._programsCollection[0]&&(e+="\n	"+this._programsCollection[0]);for(var t=1;t<this._programsCollection.length;++t)e+=",\n	"+this._programsCollection[t];e+="\n];\npc.getProgramLibrary(device).precompile(shaders);\n"+('if (pc.version != "'+J+'" || pc.revision != "'+$)+'")\n	console.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';var n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),n.setAttribute("download","precompile-shaders.js"),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n);},t.clearCache=function(){this._isClearingCache=true,this.processedCache.forEach(function(e){e.destroy();}),this.processedCache.clear(),this._isClearingCache=false;},t.removeFromCache=function(e){var t=this;this._isClearingCache||this.processedCache.forEach(function(n,i){e===n&&t.processedCache.delete(i);});},t._getDefaultStdMatOptions=function(e){var t=oW.get(this._device).getByIndex(e);return 3===e||1===e||t.isShadow?this._defaultStdMatOptionMin:this._defaultStdMatOption},t.precompile=function(e){if(e)for(var t=Array(e.length),n=0;n<e.length;n++){if("standard"===e[n].name){var i=e[n].options,r=this._getDefaultStdMatOptions(i.pass);for(var s in r)r.hasOwnProperty(s)&&void 0===i[s]&&(i[s]=r[s]);}t[n]=this.getProgram(e[n].name,e[n].options);}this._precached=true;},e}(),dK=new e$,dZ=new e0,dQ=new e8,dJ=new e8,d$=new eN(1,1,0,.4),d0=function(e,t,n,i,r){var s=e.getProp("x"),a=e.getProp("y"),o=e.getProp("z"),l=e.getProp("rot_1"),u=e.getProp("rot_2"),c=e.getProp("rot_3"),h=e.getProp("rot_0"),f=e.getProp("scale_0"),d=e.getProp("scale_1"),p=e.getProp("scale_2"),m=e.getProp("f_dc_0"),_=e.getProp("f_dc_1"),v=e.getProp("f_dc_2"),g=e.getProp("opacity"),y=function(e){if(e>0)return 1/(1+Math.exp(-e));var t=Math.exp(e);return t/(1+t)};this.read=function(e){t&&(t.x=s[e],t.y=a[e],t.z=o[e]),n&&n.set(l[e],u[e],c[e],h[e]),i&&i.set(Math.exp(f[e]),Math.exp(d[e]),Math.exp(p[e])),r&&r.set(.5+.28209479177387814*m[e],.5+.28209479177387814*_[e],.5+.28209479177387814*v[e],y(g[e]));};},d1=function(e,t,n){dZ.set(n.x,n.y,n.z,n.w).normalize(),e.setTRS(t,dZ,eW.ONE);},d2=function(){function e(e,t){ void 0===t&&(t=[]),this.elements=e,this.numSplats=this.getElement("vertex").count,this.comments=t;}var t,n=e.prototype;return n.getProp=function(e,t){var n,i;return void 0===t&&(t="vertex"),null==(i=this.getElement(t))||null==(n=i.properties.find(function(t){return t.name===e}))?void 0:n.storage},n.getElement=function(e){return this.elements.find(function(t){return t.name===e})},n.addProp=function(e,t){this.getElement("vertex").properties.push({type:"float",name:e,storage:t,byteSize:4});},n.createIter=function(e,t,n,i){return new d0(this,e,t,n,i)},n.calcAabb=function(e,t){for(var n,i,r,s,a,o,l=true,u=this.getProp("x"),c=this.getProp("y"),h=this.getProp("z"),f=this.getProp("scale_0"),d=this.getProp("scale_1"),p=this.getProp("scale_2"),m=0;m<this.numSplats;++m)if(!t||t(m)){var _=u[m],v=c[m],g=h[m],y=Math.max(f[m],d[m],p[m]);if(isFinite(_)&&isFinite(v)&&isFinite(g)&&isFinite(y)){var S=2*Math.exp(y);l?(l=false,n=_-S,i=v-S,r=g-S,s=_+S,a=v+S,o=g+S):(n=Math.min(n,_-S),i=Math.min(i,v-S),r=Math.min(r,g-S),s=Math.max(s,_+S),a=Math.max(a,v+S),o=Math.max(o,g+S));}}return l||(e.center.set((n+s)*.5,(i+a)*.5,(r+o)*.5),e.halfExtents.set((s-n)*.5,(a-i)*.5,(o-r)*.5)),!l},n.calcAabbExact=function(t,n){for(var i=new eW,r=new e0,s=new eW,a=this.createIter(i,r,s),o=true,l=0;l<this.numSplats;++l)(!n||n(l))&&(a.read(l),o?(o=false,e.calcSplatAabb(t,i,r,s)):(e.calcSplatAabb(dJ,i,r,s),t.add(dJ)));return !o},n.getCenters=function(e){for(var t=this.getProp("x"),n=this.getProp("y"),i=this.getProp("z"),r=0;r<this.numSplats;++r)e[3*r+0]=t[r],e[3*r+1]=n[r],e[3*r+2]=i[r];},n.calcFocalPoint=function(e,t){var n=this.getProp("x"),i=this.getProp("y"),r=this.getProp("z"),s=this.getProp("scale_0"),a=this.getProp("scale_1"),o=this.getProp("scale_2");e.x=0,e.y=0,e.z=0;for(var l=0,u=0;u<this.numSplats;++u)if(!t||t(u)){var c=n[u],h=i[u],f=r[u];if(isFinite(c)&&isFinite(h)&&isFinite(f)){var d=1/(1+Math.exp(Math.max(s[u],a[u],o[u])));e.x+=c*d,e.y+=h*d,e.z+=f*d,l+=d;}}e.mulScalar(1/l);},n.renderWireframeBounds=function(e,t){for(var n=new eW,i=new e0,r=new eW,s=new eW,a=new eW,o=this.createIter(n,i,r),l=0;l<this.numSplats;++l)o.read(l),d1(dK,n,i),dK.mul2(t,dK),s.set(-2*r.x,-2*r.y,-2*r.z),a.set(2*r.x,2*r.y,2*r.z),e.immediate.drawWireAlignedBox(s,a,d$,true,e.defaultDrawLayer,dK);},n.calcMortonOrder=function(){for(var e=function(e){for(var t=e[0],n=e[0],i=1;i<e.length;i++)e[i]<t&&(t=e[i]),e[i]>n&&(n=e[i]);return {min:t,max:n}},t=this.getProp("x"),n=this.getProp("y"),i=this.getProp("z"),r=e(t),s=r.min,a=r.max,o=e(n),l=o.min,u=o.max,c=e(i),h=c.min,f=c.max,d=s===a?0:1024/(a-s),p=l===u?0:1024/(u-l),m=h===f?0:1024/(f-h),_=new Map,v=0;v<this.numSplats;v++){var g=function(e,t,n){var i=function(e){return e&=1023,e=((e=((e=((e=(e^e<<16)&0xff0000ff)^e<<8)&0x300f00f)^e<<4)&0x30c30c3)^e<<2)&0x9249249};return (i(n)<<2)+(i(t)<<1)+i(e)}(Math.min(1023,Math.floor((t[v]-s)*d)),Math.min(1023,Math.floor((n[v]-l)*p)),Math.min(1023,Math.floor((i[v]-h)*m))),y=_.get(g);y?y.push(v):_.set(g,[v]);}for(var S=Array.from(_.keys()).sort(function(e,t){return e-t}),x=new Uint32Array(this.numSplats),b=0,T=0;T<S.length;++T)for(var E=_.get(S[T]),w=0;w<E.length;++w)x[b++]=E[w];return x},n.reorder=function(e){var t=new Map,n=function(e){if(t.has(e)){var n=t.get(e);return t.delete(e),n}return new ArrayBuffer(e)},i=function(e){t.set(e.byteLength,e);},r=function(t){for(var r=new t.constructor(n(t.byteLength)),s=0;s<e.length;s++)r[s]=t[e[s]];return i(t.buffer),r};this.elements.forEach(function(e){e.properties.forEach(function(e){e.storage&&(e.storage=r(e.storage));});});},n.reorderData=function(){this.reorder(this.calcMortonOrder());},e.calcSplatAabb=function(e,t,n,i){d1(dK,t,n),dQ.center.set(0,0,0),dQ.halfExtents.set(2*i.x,2*i.y,2*i.z),e.setFromTransformedAabb(dQ,dK);},t=[{key:"isCompressed",get:function(){return  false}},{key:"shBands",get:function(){var e,t=this;return null!=(e=({9:1,24:2,45:3})[function(){for(var e=0;e<45;++e)if(!t.getProp("f_rest_"+e))return e;return 45}()])?e:0}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function d3(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}function d4(){return (d4=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);}return e}).apply(this,arguments)}var d5=0,d8=new Map,d6=function(){function e(e,t,n){this.device=e,this.material=n;var i=new Map(n.defines),r=o8.createShader(this.device,{uniqueName:"SplatCopyToWorkBuffer:"+t,attributes:{vertex_position:tT},vertexDefines:i,fragmentDefines:i,vertexChunk:"fullscreenQuadVS",fragmentGLSL:'\n#define GSPLAT_CENTER_NOPROJ\n#include "gsplatStructsVS"\n#include "gsplatCenterVS"\n#include "gsplatEvalSHVS"\n#include "gsplatQuatToMat3VS"\n#include "gsplatSourceFormatVS"\nuniform mat4 uTransform;\nuniform int uStartLine;\nuniform int uViewportWidth;\n#ifdef GSPLAT_LOD\n	uniform usampler2D uIntervalsTexture;\n#endif\n#ifdef GSPLAT_COLORIZE\n	uniform vec3 uLodColor;\n#endif\nuniform int uActiveSplats;\nvoid main(void) {\n	ivec2 localFragCoords = ivec2(int(gl_FragCoord.x), int(gl_FragCoord.y) - uStartLine);\n	int targetIndex = localFragCoords.y * uViewportWidth + localFragCoords.x;\n	if (targetIndex >= uActiveSplats) {\n		pcFragColor0 = vec4(0.0);\n		pcFragColor1 = vec4(0.0);\n		pcFragColor2 = vec4(0.0);\n		pcFragColor3 = vec4(0.0);\n	} else {\n		#ifdef GSPLAT_LOD\n			int intervalsSize = int(textureSize(uIntervalsTexture, 0).x);\n			ivec2 intervalUV = ivec2(targetIndex % intervalsSize, targetIndex / intervalsSize);\n			uint originalIndex = texelFetch(uIntervalsTexture, intervalUV, 0).r;\n		#else\n			uint originalIndex = uint(targetIndex);\n		#endif\n		\n		#if defined(GSPLAT_SOGS_DATA) || defined(GSPLAT_COMPRESSED_DATA)\n			uint srcSize = uint(textureSize(packedTexture, 0).x);\n		#else\n			uint srcSize = uint(textureSize(splatColor, 0).x);\n		#endif\n		\n		SplatSource source;\n		source.id = uint(originalIndex);\n		source.uv = ivec2(source.id % srcSize, source.id / srcSize);\n		vec3 modelCenter = readCenter(source);\n		modelCenter = (uTransform * vec4(modelCenter, 1.0)).xyz;\n		SplatCenter center;\n		initCenter(modelCenter, center);\n		vec3 covA, covB;\n		readCovariance(source, covA, covB);\n		mat3 C = mat3(\n			covA.x, covA.y, covA.z,\n			covA.y, covB.x, covB.y,\n			covA.z, covB.y, covB.z\n		);\n		mat3 linear = mat3(uTransform);\n		mat3 Ct = linear * C * transpose(linear);\n		covA = Ct[0];\n		covB = vec3(Ct[1][1], Ct[1][2], Ct[2][2]);\n		vec4 color = readColor(source);\n		#if SH_BANDS > 0\n			vec3 dir = normalize(center.view * mat3(center.modelView));\n			vec3 sh[SH_COEFFS];\n			float scale;\n			readSHData(source, sh, scale);\n			color.xyz += evalSH(sh, dir) * scale;\n		#endif\n		#ifdef GSPLAT_COLORIZE\n			color.xyz *= uLodColor;\n		#endif\n		pcFragColor0 = color;\n		pcFragColor1 = vec4(modelCenter, 1.0);\n		pcFragColor2 = vec4(covA, 1.0);\n		pcFragColor3 = vec4(covB, 1.0);\n	}\n}\n',fragmentWGSL:'\n#define GSPLAT_CENTER_NOPROJ\n#include "gsplatStructsVS"\n#include "gsplatCenterVS"\n#include "gsplatEvalSHVS"\n#include "gsplatQuatToMat3VS"\n#include "gsplatSourceFormatVS"\nuniform uTransform: mat4x4f;\nuniform uStartLine: i32;\nuniform uViewportWidth: i32;\n#ifdef GSPLAT_LOD\n	var uIntervalsTexture: texture_2d<u32>;\n#endif\n#ifdef GSPLAT_COLORIZE\n	uniform uLodColor: vec3f;\n#endif\nuniform uActiveSplats: i32;\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n	var output: FragmentOutput;\n	\n	let localFragCoords = vec2i(i32(input.position.x), i32(input.position.y) - uniform.uStartLine);\n	let targetIndex = localFragCoords.y * uniform.uViewportWidth + localFragCoords.x;\n	\n	if (targetIndex >= uniform.uActiveSplats) {\n		output.color = vec4f(0.0);\n		output.color1 = vec4f(0.0);\n		output.color2 = vec4f(0.0);\n		output.color3 = vec4f(0.0);\n	} else {\n		#ifdef GSPLAT_LOD\n			let intervalsSize = i32(textureDimensions(uIntervalsTexture, 0).x);\n			let intervalUV = vec2i(targetIndex % intervalsSize, targetIndex / intervalsSize);\n			let originalIndex = textureLoad(uIntervalsTexture, intervalUV, 0).r;\n		#else\n			let originalIndex = targetIndex;\n		#endif\n		\n		var srcSize: u32;\n		#if defined(GSPLAT_SOGS_DATA) || defined(GSPLAT_COMPRESSED_DATA)\n			srcSize = u32(textureDimensions(packedTexture, 0).x);\n		#else\n			srcSize = u32(textureDimensions(splatColor, 0).x);\n		#endif\n		\n		var source: SplatSource;\n		source.id = u32(originalIndex);\n		source.uv = vec2i(i32(source.id % srcSize), i32(source.id / srcSize));\n		var modelCenter = readCenter(&source);\n		modelCenter = (uniform.uTransform * vec4f(modelCenter, 1.0)).xyz;\n		var center: SplatCenter;\n		initCenter(modelCenter, &center);\n		var covA: vec3f;\n		var covB: vec3f;\n		readCovariance(&source, &covA, &covB);\n		let C = mat3x3f(\n			vec3f(covA.x, covA.y, covA.z),\n			vec3f(covA.y, covB.x, covB.y),\n			vec3f(covA.z, covB.y, covB.z)\n		);\n		let linear = mat3x3f(uniform.uTransform[0].xyz, uniform.uTransform[1].xyz, uniform.uTransform[2].xyz);\n		let Ct = linear * C * transpose(linear);\n		covA = Ct[0];\n		covB = vec3f(Ct[1][1], Ct[1][2], Ct[2][2]);\n		var color = readColor(&source);\n		#if SH_BANDS > 0\n			let dir = normalize(center.view * mat3x3f(center.modelView[0].xyz, center.modelView[1].xyz, center.modelView[2].xyz));\n			var sh: array<vec3f, SH_COEFFS>;\n			var scale: f32;\n			readSHData(&source, &sh, &scale);\n			color = vec4f(color.xyz + evalSH(&sh, dir) * scale, color.w);\n		#endif\n		#ifdef GSPLAT_COLORIZE\n			color = vec4f(color.xyz * uniform.uLodColor, color.w);\n		#endif\n		output.color = color;\n		output.color1 = vec4f(modelCenter, 1.0);\n		output.color2 = vec4f(covA, 1.0);\n		output.color3 = vec4f(covB, 1.0);\n	}\n	\n	return output;\n}\n'});this.quadRender=new lt(r);}return e.prototype.destroy=function(){var e,t;null==(e=this.material)||e.destroy(),null==(t=this.quadRender)||t.destroy();},e}(),d9=function(){function e(t,n){this.id=d5++,this.workBufferRenderInfos=new Map,this.device=t,this.gsplatData=n,this.centers=new Float32Array(3*n.numSplats),n.getCenters(this.centers),this.aabb=new e8,n.calcAabb(this.aabb),this.mesh=e.createMesh(t),this.instanceIndices=e.createInstanceIndices(t,n.numSplats),this.mesh.incRefCount(),this.mesh.aabb.copy(this.aabb);}var t,n,i=e.prototype;return i.destroy=function(){var e,t;null==(e=this.mesh)||e.destroy(),null==(t=this.instanceIndices)||t.destroy(),this.workBufferRenderInfos.forEach(function(e){return e.destroy()}),this.workBufferRenderInfos.clear();},i.getWorkBufferRenderInfo=function(e,t){this.configureMaterialDefines(d8),e&&d8.set("GSPLAT_LOD",""),t&&d8.set("GSPLAT_COLORIZE","");var n=Array.from(d8.entries()).map(function(e){return e[0]+"="+e[1]}).join(";"),i=this.workBufferRenderInfos.get(n);if(!i){var r=new h3;this.configureMaterial(r),d8.forEach(function(e,t){return r.setDefine(t,e)}),i=new d6(this.device,n,r),this.workBufferRenderInfos.set(n,i);}return d8.clear(),i},i.configureMaterial=function(e){},i.configureMaterialDefines=function(e){},i.evalTextureSize=function(e){return eX.ZERO},i.createTexture=function(e,t,n,i){return new nO(this.device,d4({name:e,width:n.x,height:n.y,format:t,cubemap:false,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1},i?{levels:[i]}:{}))},i.instantiate=function(){},e.createMesh=function(t){for(var n=e.instanceSize,i=new Float32Array(12*n),r=new Uint32Array(6*n),s=0;s<n;++s){i.set([-1,-1,s,1,-1,s,1,1,s,-1,1,s],12*s);var a=4*s;r.set([0+a,1+a,2+a,0+a,2+a,3+a],6*s);}var o=new l_(t);return o.setPositions(i,3),o.setIndices(r),o.update(),o},e.createInstanceIndices=function(t,n){for(var i=e.instanceSize,r=Math.ceil(n/i)*i/i,s=new Uint32Array(r),a=0;a<r;++a)s[a]=a*i;var o=new n6(t,[{semantic:tQ,components:1,type:5,asInt:true}]);return new n1(t,o,r,{usage:0,data:s.buffer})},n=[{key:"instanceSize",get:function(){return 128}}],t=[{key:"numSplats",get:function(){return this.gsplatData.numSplats}}],d3(e.prototype,t),n&&d3(e,n),e}();function d7(e,t){return (d7=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var pe=function(e,t){for(var n=[],i=0;i<t;++i)n.push(e.getProp("f_rest_"+i));return n},pt=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i=e.call(this,t,n)||this,r=n.numSplats,s=i.evalTextureSize(r);return i.colorTexture=i.createTexture("splatColor",12,s),i.transformATexture=i.createTexture("transformA",49,s),i.transformBTexture=i.createTexture("transformB",12,s),i.updateColorData(n),i.updateTransformData(n),i.shBands=n.shBands,i.shBands>0&&(i.sh1to3Texture=i.createTexture("splatSH_1to3",49,s),i.shBands>1&&(i.sh4to7Texture=i.createTexture("splatSH_4to7",49,s),i.shBands>2?(i.sh8to11Texture=i.createTexture("splatSH_8to11",49,s),i.sh12to15Texture=i.createTexture("splatSH_12to15",49,s)):i.sh8to11Texture=i.createTexture("splatSH_8to11",37,s)),i.updateSHData(n)),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&d7(t,e);var n=t.prototype;return n.destroy=function(){var t,n,i,r,s,a,o;null==(t=this.colorTexture)||t.destroy(),null==(n=this.transformATexture)||n.destroy(),null==(i=this.transformBTexture)||i.destroy(),null==(r=this.sh1to3Texture)||r.destroy(),null==(s=this.sh4to7Texture)||s.destroy(),null==(a=this.sh8to11Texture)||a.destroy(),null==(o=this.sh12to15Texture)||o.destroy(),e.prototype.destroy.call(this);},n.configureMaterialDefines=function(e){e.set("SH_BANDS",this.shBands);},n.configureMaterial=function(e){this.configureMaterialDefines(e.defines),e.setParameter("splatColor",this.colorTexture),e.setParameter("transformA",this.transformATexture),e.setParameter("transformB",this.transformBTexture),this.sh1to3Texture&&e.setParameter("splatSH_1to3",this.sh1to3Texture),this.sh4to7Texture&&e.setParameter("splatSH_4to7",this.sh4to7Texture),this.sh8to11Texture&&e.setParameter("splatSH_8to11",this.sh8to11Texture),this.sh12to15Texture&&e.setParameter("splatSH_12to15",this.sh12to15Texture);},n.evalTextureSize=function(e){var t=Math.ceil(Math.sqrt(e)),n=Math.ceil(e/t);return new eX(t,n)},n.updateColorData=function(e){var t=this.colorTexture;if(t){for(var n=eG.float2Half,i=t.lock(),r=e.getProp("f_dc_0"),s=e.getProp("f_dc_1"),a=e.getProp("f_dc_2"),o=e.getProp("opacity"),l=0;l<this.numSplats;++l){var u=.28209479177387814*r[l]+.5,c=.28209479177387814*s[l]+.5,h=.28209479177387814*a[l]+.5,f=1/(1+Math.exp(-o[l]));i[4*l+0]=n(u),i[4*l+1]=n(c),i[4*l+2]=n(h),i[4*l+3]=n(f);}t.unlock();}},n.updateTransformData=function(e){var t=eG.float2Half;if(this.transformATexture){for(var n=this.transformATexture.lock(),i=new Float32Array(n.buffer),r=this.transformBTexture.lock(),s=new eW,a=new e0,o=new eW,l=e.createIter(s,a,o),u=0;u<this.numSplats;u++)l.read(u),a.normalize(),a.w<0&&a.mulScalar(-1),i[4*u+0]=s.x,i[4*u+1]=s.y,i[4*u+2]=s.z,n[4*u+3]=t(a.x)|t(a.y)<<16,r[4*u+0]=t(o.x),r[4*u+1]=t(o.y),r[4*u+2]=t(o.z),r[4*u+3]=t(a.z);this.transformATexture.unlock(),this.transformBTexture.unlock();}},n.updateSHData=function(e){for(var t,n,i,r,s,a,o=this.sh1to3Texture.lock(),l=null==(t=this.sh4to7Texture)?void 0:t.lock(),u=null==(n=this.sh8to11Texture)?void 0:n.lock(),c=null==(i=this.sh12to15Texture)?void 0:i.lock(),h={1:3,2:8,3:15}[this.shBands],f=pe(e,3*h),d=new Float32Array(1),p=new Uint32Array(d.buffer),m=Array(3*h).fill(0),_=0;_<e.numSplats;++_){for(var v=0;v<h;++v)m[3*v]=f[v][_],m[3*v+1]=f[v+h][_],m[3*v+2]=f[v+2*h][_];for(var g=m[0],y=1;y<3*h;++y)g=Math.max(g,Math.abs(m[y]));if(0!==g){for(var S=0;S<h;++S)m[3*S+0]=Math.max(0,Math.min(2047,Math.floor((m[3*S+0]/g*.5+.5)*2047+.5))),m[3*S+1]=Math.max(0,Math.min(1023,Math.floor((m[3*S+1]/g*.5+.5)*1023+.5))),m[3*S+2]=Math.max(0,Math.min(2047,Math.floor((m[3*S+2]/g*.5+.5)*2047+.5)));d[0]=g,o[4*_+0]=p[0],o[4*_+1]=m[0]<<21|m[1]<<11|m[2],o[4*_+2]=m[3]<<21|m[4]<<11|m[5],o[4*_+3]=m[6]<<21|m[7]<<11|m[8],this.shBands>1&&(l[4*_+0]=m[9]<<21|m[10]<<11|m[11],l[4*_+1]=m[12]<<21|m[13]<<11|m[14],l[4*_+2]=m[15]<<21|m[16]<<11|m[17],l[4*_+3]=m[18]<<21|m[19]<<11|m[20],this.shBands>2?(u[4*_+0]=m[21]<<21|m[22]<<11|m[23],u[4*_+1]=m[24]<<21|m[25]<<11|m[26],u[4*_+2]=m[27]<<21|m[28]<<11|m[29],u[4*_+3]=m[30]<<21|m[31]<<11|m[32],c[4*_+0]=m[33]<<21|m[34]<<11|m[35],c[4*_+1]=m[36]<<21|m[37]<<11|m[38],c[4*_+2]=m[39]<<21|m[40]<<11|m[41],c[4*_+3]=m[42]<<21|m[43]<<11|m[44]):u[_]=m[21]<<21|m[22]<<11|m[23]);}}this.sh1to3Texture.unlock(),null==(r=this.sh4to7Texture)||r.unlock(),null==(s=this.sh8to11Texture)||s.unlock(),null==(a=this.sh12to15Texture)||a.unlock();},t}(d9);function pn(e,t){return (pn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var pi=function(e,t){for(var n in t)e.resolve(n).setValue(t[n]);},pr=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return t=e.apply(this,arguments)||this,t.executeCallback=null,t}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&pn(t,e),t.prototype.execute=function(){null==this.executeCallback||this.executeCallback.call(this);},t}(s2),ps=new e$,pa=new eW,po=function(){function e(e,t){this.prevDir=new eW,this.updateMode="enable",this.device=e,this.gsplatInstance=t;var n=t.resource,i=new Map(o0.get(e,e.isWebGPU?"wgsl":"glsl"));this.shader=o8.createShader(e,{uniqueName:"gsplatResolveSH",vertexGLSL:"\n	attribute vec2 vertex_position;\n	void main(void) {\n		gl_Position = vec4(vertex_position, 0.0, 1.0);\n	}\n",fragmentGLSL:'\n	#include "gsplatEvalSHVS"\n	vec4 packRgb(vec3 v) {\n		uvec3 vb = uvec3(clamp(v, vec3(0.0), vec3(1.0)) * vec3(2047.0, 2047.0, 1023.0));\n		uint bits = (vb.x << 21) | (vb.y << 10) | vb.z;\n		return vec4((uvec4(bits) >> uvec4(24, 16, 8, 0)) & uvec4(0xff)) / vec4(255.0);\n	}\n	uniform mediump vec3 dir;\n	uniform mediump sampler2D centroids;\n	uniform mediump float shN_mins;\n	uniform mediump float shN_maxs;\n	void main(void) {\n		ivec2 uv = ivec2(gl_FragCoord.xy) * ivec2(SH_COEFFS, 1);\n		mediump vec3 coefficients[SH_COEFFS];\n		for (int i = 0; i < SH_COEFFS; i++) {\n			vec3 s = texelFetch(centroids, ivec2(uv.x + i, uv.y), 0).xyz;\n			coefficients[i] = mix(vec3(shN_mins), vec3(shN_maxs), s);\n		}\n		gl_FragColor = packRgb(evalSH(coefficients, dir) * 0.25 + 0.5);\n	}\n',vertexWGSL:"\n	attribute vertex_position: vec2f;\n	@vertex\n	fn vertexMain(input: VertexInput) -> VertexOutput {\n		var output: VertexOutput;\n		output.position = vec4f(vertex_position, 0.0, 1.0);\n		return output;\n	}\n",fragmentWGSL:'\n	#include "gsplatEvalSHVS"\n	fn packRgb(v: vec3f) -> vec4f {\n		let vb = vec3u(clamp(v, vec3f(0.0), vec3f(1.0)) * vec3f(2047.0, 2047.0, 1023.0));\n		let bits = dot(vb, vec3u(1 << 21, 1 << 10, 1));\n		return vec4f((vec4u(bits) >> vec4u(24, 16, 8, 0)) & vec4u(0xff)) / vec4f(255.0);\n	}\n	uniform dir: vec3f;\n	uniform shN_mins: f32;\n	uniform shN_maxs: f32;\n	var centroids: texture_2d<f32>;\n	@fragment\n	fn fragmentMain(input: FragmentInput) -> FragmentOutput {\n		var output: FragmentOutput;\n		var uv = vec2i(input.position.xy) * vec2i(SH_COEFFS, 1);\n		var coefficients: array<vec3f, SH_COEFFS>;\n		for (var i: i32 = 0; i < SH_COEFFS; i++) {\n			let s: vec3f = textureLoad(centroids, vec2i(uv.x + i, uv.y), 0).xyz;\n			coefficients[i] = mix(vec3f(uniform.shN_mins), vec3f(uniform.shN_maxs), s);\n		}\n		output.color = packRgb(evalSH(&coefficients, uniform.dir) * 0.25 + 0.5);\n		return output;\n	}\n',vertexIncludes:i,fragmentIncludes:i,fragmentDefines:new Map([["SH_BANDS",n.gsplatData.shBands.toString()]]),attributes:{vertex_position:tT}}),this.texture=n.createTexture("centroids",7,new eX(64,1024)),this.renderTarget=new il({colorBuffer:this.texture,depth:false}),this.renderPass=new pr(e),this.renderPass.init(this.renderTarget,{}),this.renderPass.colorOps.clear=true,this.quadRender=new lt(this.shader);var r=t.material;r.setDefine("SH_BANDS","0");var s=r.shaderChunks;s.glsl.set("gsplatSogsColorVS","\n	uniform mediump sampler2D sh0;\n	uniform highp sampler2D sh_labels;\n	uniform mediump sampler2D sh_result;\n	uniform vec4 sh0_mins;\n	uniform vec4 sh0_maxs;\n	float SH_C0 = 0.28209479177387814;\n	vec3 unpackRgb(vec4 v) {\n		uvec4 uv = uvec4(v * 255.0);\n		uint bits = (uv.x << 24) | (uv.y << 16) | (uv.z << 8) | uv.w;\n		uvec3 vb = (uvec3(bits) >> uvec3(21, 10, 0)) & uvec3(0x7ffu, 0x7ffu, 0x3ffu);\n		return vec3(vb) / vec3(2047.0, 2047.0, 1023.0);\n	}\n	vec4 readColor(in SplatSource source) {\n		vec4 baseSample = mix(sh0_mins, sh0_maxs, texelFetch(sh0, source.uv, 0));\n		vec4 base = vec4(vec3(0.5) + baseSample.xyz * SH_C0, 1.0 / (1.0 + exp(-baseSample.w)));\n		ivec2 labelSample = ivec2(texelFetch(sh_labels, source.uv, 0).xy * 255.0);\n		int n = labelSample.x + labelSample.y * 256;\n		vec4 shSample = texelFetch(sh_result, ivec2(n % 64, n / 64), 0);\n		vec3 sh = (unpackRgb(shSample) - vec3(0.5)) * 4.0;\n		return vec4(base.xyz + sh, base.w);\n	}\n"),s.wgsl.set("gsplatSogsColorVS","\n	var sh0: texture_2d<f32>;\n	var sh_labels: texture_2d<f32>;\n	var sh_result: texture_2d<f32>;\n	uniform sh0_mins: vec4f;\n	uniform sh0_maxs: vec4f;\n	const SH_C0: f32 = 0.28209479177387814;\n	fn unpackRgb(v: vec4f) -> vec3f {\n		let bits = dot(vec4u(v * 255.0), vec4u(1u << 24, 1u << 16, 1u << 8, 1u));\n		let vb = (vec3u(bits) >> vec3u(21, 10, 0)) & vec3u(0x7ffu, 0x7ffu, 0x3ffu);\n		return vec3f(vb) / vec3f(2047.0, 2047.0, 1023.0);\n	}\n	fn readColor(source: ptr<function, SplatSource>) -> vec4f {\n		let baseSample: vec4f = mix(uniform.sh0_mins, uniform.sh0_maxs, textureLoad(sh0, source.uv, 0));\n		let base = vec4f(vec3f(0.5) + baseSample.xyz * SH_C0, 1.0 / (1.0 + exp(-baseSample.w)));\n		let labelSample: vec2i = vec2i(textureLoad(sh_labels, source.uv, 0).xy * 255.0);\n		let n = labelSample.x + labelSample.y * 256;\n		let shSample: vec4f = textureLoad(sh_result, vec2i(n % 64, n / 64), 0);\n		let sh: vec3f = (unpackRgb(shSample) - vec3f(0.5)) * 4.0;\n		return vec4f(base.xyz + sh, base.w);\n	}\n"),r.update(),e.scope.resolve("sh_result").setValue(this.texture);}var t=e.prototype;return t.destroy=function(){var e=this.gsplatInstance,t=e.material;t.setDefine("SH_BANDS",e.resource.gsplatData.shBands.toString());var n=t.shaderChunks;n.glsl.delete("gsplatSogsColorVS"),n.wgsl.delete("gsplatSogsColorVS"),t.update(),this.quadRender.destroy(),this.renderPass.destroy(),this.renderTarget.destroy(),this.texture.destroy(),this.shader.destroy();},t.render=function(e,t){var n=this,i=this.prevDir,r=this.updateMode;"disable"!==r&&(ps.invert(t),ps.transformVector(e.forward,pa),pa.normalize(),"enable"===r&&pa.equalsApprox(i,.001)||(i.copy(pa),this.renderPass.executeCallback=function(){var e=n.device,t=n.gsplatInstance.resource.gsplatData,i=t.sh_centroids,r=t.meta;pi(e.scope,{dir:pa.toArray(),centroids:i,shN_mins:r.shN.mins,shN_maxs:r.shN.maxs}),e.setCullMode(0),e.setDepthState(nq.NODEPTH),e.setStencilState(null,null),e.setBlendState(nj.NOBLEND),n.quadRender.render();},this.renderPass.render()));},e}();function pl(){var e,t,n,i,r,s,a,o,l="undefined"!=typeof self&&self||require("node:worker_threads").parentPort,u=false,c={x:0,y:0,z:0},h={x:0,y:0,z:0},f={x:0,y:0,z:0},d={x:0,y:0,z:0},p=Array(32).fill(0),m=Array(32).fill(0),_=Array(32).fill(0),v=function(e,t,n){for(;e<=t;){var i=t+e>>1,r=n(i);if(r>0)e=i+1;else {if(!(r<0))return i;t=i-1;}}return ~e},g=function(){if(e&&t&&0!==t.length&&r&&s){var g,y,S=r.x,x=r.y,b=r.z,T=s.x,E=s.y,w=s.z;if(!(!u&&.001>Math.abs(S-c.x)&&.001>Math.abs(x-c.y)&&.001>Math.abs(b-c.z)&&.001>Math.abs(T-h.x)&&.001>Math.abs(E-h.y)&&.001>Math.abs(w-h.z))){u=false,c.x=S,c.y=x,c.z=b,h.x=T,h.y=E,h.z=w;for(var A,C=0;C<8;++C){var P=(1&C?f.x:d.x)*T+(2&C?f.y:d.y)*E+(4&C?f.z:d.z)*w;0===C?g=y=P:(g=Math.min(g,P),y=Math.max(y,P));}var I=t.length/3,L=Math.pow(2,Math.max(10,Math.min(20,Math.round(Math.log2(I/4)))))+1;(null==a?void 0:a.length)!==I&&(a=new Uint32Array(I)),o&&o.length===L?o.fill(0):o=new Uint32Array(L);var D=y-g;if(D<1e-6)for(var M=0;M<I;++M)a[M]=0,o[0]++;else {var R=n.length/4;p.fill(0);for(var O=0;O<R;++O)for(var k=n[4*O+0],N=n[4*O+1],F=n[4*O+2],B=n[4*O+3],U=k*T+N*E+F*w-g,z=Math.max(0,Math.floor((U-B)*32/D)),V=Math.min(32,Math.ceil((U+B)*32/D)),G=z;G<V;++G)p[G]++;for(var H=p.reduce(function(e,t){return e+t},0),W=0;W<32;++W)_[W]=p[W]/H*L>>>0;for(var j=0;j<32;++j)m[j]=0===j?0:m[j-1]+_[j-1];for(var X=D/32,Y=0,q=0;q<I;++q){var K=(t[Y++]*T+t[Y++]*E+t[Y++]*w-g)/X,Z=K>>>0,Q=m[Z]+_[Z]*(K-Z)>>>0;a[q]=Q,o[Q]++;}}for(var J=1;J<L;J++)o[J]+=o[J-1];for(var $=0;$<I;$++){var ee=a[$];e[--o[ee]]=$;}var et=S*T+x*E+b*w,en=function(n){var i=3*e[n];return t[i++]*T+t[i++]*E+t[i]*w-et},ei=en(I-1)>=0?(A=v(0,I-1,function(e){return -en(e)}),Math.min(I,Math.abs(A))):I;if(i)for(var er=0;er<I;++er)e[er]=i[e[er]];l.postMessage({order:e.buffer,count:ei},[e.buffer]),e=null;}}};l.addEventListener("message",function(a){var o=null!=(S=a.data)?S:a;if(o.order&&(e=new Uint32Array(o.order)),o.centers)if(t=new Float32Array(o.centers),u=true,o.chunks){var l=new Float32Array(o.chunks);n=new Float32Array(o.chunks,0,4*l.length/6),f.x=l[0],f.y=l[1],f.z=l[2],d.x=l[3],d.y=l[4],d.z=l[5];for(var c=0;c<l.length/6;++c){var h=l[6*c+0],p=l[6*c+1],m=l[6*c+2],_=l[6*c+3],v=l[6*c+4],y=l[6*c+5];n[4*c+0]=(h+_)*.5,n[4*c+1]=(p+v)*.5,n[4*c+2]=(m+y)*.5,n[4*c+3]=.5*Math.sqrt(Math.pow(_-h,2)+Math.pow(v-p,2)+Math.pow(y-m,2)),h<f.x&&(f.x=h),p<f.y&&(f.y=p),m<f.z&&(f.z=m),_>d.x&&(d.x=_),v>d.y&&(d.y=v),y>d.z&&(d.z=y);}}else {var S,x,b,T,E,w,A,C=t.length/3,P=Math.ceil(C/256);n=new Float32Array(4*P),f.x=f.y=f.z=1/0,d.x=d.y=d.z=-1/0;for(var I=0;I<P;++I){x=b=T=1/0,E=w=A=-1/0;for(var L=256*I,D=Math.min(C,(I+1)*256),M=L;M<D;++M){var R=t[3*M+0],O=t[3*M+1],k=t[3*M+2],N=Number.isFinite(R),F=Number.isFinite(O),B=Number.isFinite(k);N||(t[3*M+0]=0),F||(t[3*M+1]=0),B||(t[3*M+2]=0),N&&F&&B&&(R<x?x=R:R>E&&(E=R),O<b?b=O:O>w&&(w=O),k<T?T=k:k>A&&(A=k),R<f.x?f.x=R:R>d.x&&(d.x=R),O<f.y?f.y=O:O>d.y&&(d.y=O),k<f.z?f.z=k:k>d.z&&(d.z=k));}n[4*I+0]=(x+E)*.5,n[4*I+1]=(b+w)*.5,n[4*I+2]=(T+A)*.5,n[4*I+3]=.5*Math.sqrt(Math.pow(E-x,2)+Math.pow(w-b,2)+Math.pow(A-T,2));}}o.hasOwnProperty("mapping")&&(i=o.mapping?new Uint32Array(o.mapping):null,u=true),o.cameraPosition&&(r=o.cameraPosition),o.cameraDirection&&(s=o.cameraDirection),g();});}function pu(e,t){return (pu=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var pc=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t=e.call(this)||this,n=function(e){var n,i=null!=(n=e.data)?n:e,r=i.order,s=t.orderTexture._levels[0].buffer;t.worker.postMessage({order:s},[s]),t.orderTexture._levels[0]=new Uint32Array(r),t.orderTexture.upload(),t.fire("updated",i.count);},i="("+pl.toString()+")()";return "node"===ef.environment?(t.worker=new Worker(i,{eval:true}),t.worker.on("message",n)):(t.worker=new Worker(URL.createObjectURL(new Blob([i],{type:"application/javascript"}))),t.worker.addEventListener("message",n)),t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&pu(t,e);var n=t.prototype;return n.destroy=function(){this.worker.terminate(),this.worker=null;},n.init=function(e,t,n){this.orderTexture=e,this.centers=t.slice();var i=this.orderTexture.lock({mode:1}).slice();this.orderTexture.unlock();for(var r=0;r<i.length;++r)i[r]=r;var s={order:i.buffer,centers:t.buffer,chunks:null==n?void 0:n.buffer},a=[i.buffer,t.buffer].concat(n?[n.buffer]:[]);this.worker.postMessage(s,a);},n.setMapping=function(e){if(e){for(var t=new Float32Array(3*e.length),n=0;n<e.length;++n){var i=3*e[n],r=3*n;t[r+0]=this.centers[i+0],t[r+1]=this.centers[i+1],t[r+2]=this.centers[i+2];}this.worker.postMessage({centers:t.buffer,mapping:e.buffer},[t.buffer,e.buffer]);}else {var s=this.centers.slice();this.worker.postMessage({centers:s.buffer,mapping:null},[s.buffer]);}},n.setCamera=function(e,t){this.worker.postMessage({cameraPosition:{x:e.x,y:e.y,z:e.z},cameraDirection:{x:t.x,y:t.y,z:t.z}});},t}(ex),ph="\nuint pack8888(vec4 v) {\n	uvec4 t = uvec4(v * 255.0) << uvec4(24u, 16u, 8u, 0u);\n	return t.x | t.y | t.z | t.w;\n}\nuint pack101010(vec3 v) {\n	uvec3 t = uvec3(v * 1023.0) << uvec3(20u, 10u, 0u);\n	return t.x | t.y | t.z;\n}\nuint pack111110(vec3 v) {\n	uvec3 t = uvec3(v * vec3(2047.0, 2047.0, 1023.0)) << uvec3(21u, 10u, 0u);\n	return t.x | t.y | t.z;\n}\nvec4 unpack8888(uint v) {\n	return vec4((uvec4(v) >> uvec4(24u, 16u, 8u, 0u)) & 0xffu) / 255.0;\n}\nvec3 unpack101010(uint v) {\n	return vec3((uvec3(v) >> uvec3(20u, 10u, 0u)) & 0x3ffu) / 1023.0;\n}\nvec3 unpack111110(uint v) {\n	return vec3((uvec3(v) >> uvec3(21u, 10u, 0u)) & uvec3(0x7ffu, 0x7ffu, 0x3ffu)) / vec3(2047.0, 2047.0, 1023.0);\n}\nvec3 resolveCodebook(vec3 s, vec4 codebook[64]) {\n	uvec3 idx = uvec3(s * 255.0);\n	vec3 v = vec3(\n		codebook[idx.x >> 2u][idx.x & 3u],\n		codebook[idx.y >> 2u][idx.y & 3u],\n		codebook[idx.z >> 2u][idx.z & 3u]\n	);\n	return (v - codebook[0].x) / (codebook[63].w - codebook[0].x);\n}\n",pf="\nfn pack8888(v: vec4f) -> u32 {\n	let t = vec4u(v * 255.0) << vec4u(24u, 16u, 8u, 0u);\n	return t.x | t.y | t.z | t.w;\n}\nfn pack101010(v: vec3f) -> u32 {\n	let t = vec3u(v * vec3f(1023.0, 1023.0, 1023.0)) << vec3u(20u, 10u, 0u);\n	return t.x | t.y | t.z;\n}\nfn pack111110(v: vec3f) -> u32 {\n	let t = vec3u(v * vec3f(2047.0, 2047.0, 1023.0)) << vec3u(21u, 10u, 0u);\n	return t.x | t.y | t.z;\n}\nfn unpack8888(v: u32) -> vec4f {\n	return vec4f((vec4u(v) >> vec4u(24u, 16u, 8u, 0u)) & vec4u(0xffu)) / 255.0;\n}\nfn unpack101010(v: u32) -> vec3f {\n	return vec3f((vec3u(v) >> vec3u(20u, 10u, 0u)) & vec3u(0x3ffu)) / 1023.0;\n}\nfn unpack111110(v: u32) -> vec3f {\n	return vec3f((vec3u(v) >> vec3u(21u, 10u, 0u)) & vec3u(0x7ffu, 0x7ffu, 0x3ffu)) / vec3f(2047.0, 2047.0, 1023.0);\n}\nfn resolveCodebook(s: vec3f, codebook: ptr<uniform, array<vec4f, 64>>) -> vec3f {\n	let idx = vec3u(s * 255.0);\n	let v = vec3f(\n		codebook[idx.x >> 2u][idx.x & 3u],\n		codebook[idx.y >> 2u][idx.y & 3u],\n		codebook[idx.z >> 2u][idx.z & 3u]\n	);\n	return (v - codebook[0].x) / (codebook[63].w - codebook[0].x);\n}\n";function pd(e,t,n,i,r,s,a){try{var o=e[s](a),l=o.value;}catch(e){n(e);return}o.done?t(l):Promise.resolve(l).then(i,r);}function pp(e){return function(){var t=this,n=arguments;return new Promise(function(i,r){var s=e.apply(t,n);function a(e){pd(s,i,r,a,o,"next",e);}function o(e){pd(s,i,r,a,o,"throw",e);}a(void 0);})}}function pm(e,t){var n,i,r,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(l){var u=[o,l];if(n)throw TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(s=0)),s;)try{if(n=1,i&&(r=2&u[0]?i.return:u[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,u[1])).done)return r;switch(i=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,i=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===u[0]||2===u[0])){s=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){s.label=u[1];break}if(6===u[0]&&s.label<r[1]){s.label=r[1],r=u;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(u);break}r[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s);}catch(e){u=[6,e],i=0;}finally{n=r=0;}if(5&u[0])throw u[1];return {value:u[0]?u[1]:void 0,done:true}}}}var p_=function(e){return e.read(0,0,e.width,e.height,{mipLevel:0,face:0,immediate:true})},pv=function(e,t){for(var n in t)e.resolve(n).setValue(t[n]);},pg=function(e,t,n,i,r,s){var a,o=function(e,t,n){return e*(1-n)+t*n},l=e.meta,u=e.shBands,c=l.means,h=l.scales,f=l.sh0,d=l.shN,p=t&&e.means_l._levels[0],m=t&&e.means_u._levels[0],_=n&&e.quats._levels[0],v=i&&e.scales._levels[0],g=r&&e.sh0._levels[0],y=s&&e.sh_labels._levels[0],S=s&&e.sh_centroids._levels[0],x=2/Math.sqrt(2),b=null!=(a=({1:3,2:8,3:15})[u])?a:0;this.read=function(a){if(t){var u=o(c.mins[0],c.maxs[0],((m[4*a+0]<<8)+p[4*a+0])/65535),T=o(c.mins[1],c.maxs[1],((m[4*a+1]<<8)+p[4*a+1])/65535),E=o(c.mins[2],c.maxs[2],((m[4*a+2]<<8)+p[4*a+2])/65535);t.x=Math.sign(u)*(Math.exp(Math.abs(u))-1),t.y=Math.sign(T)*(Math.exp(Math.abs(T))-1),t.z=Math.sign(E)*(Math.exp(Math.abs(E))-1);}if(n){var w=(_[4*a+0]/255-.5)*x,A=(_[4*a+1]/255-.5)*x,C=(_[4*a+2]/255-.5)*x,P=Math.sqrt(Math.max(0,1-(w*w+A*A+C*C)));switch(_[4*a+3]-252){case 0:n.set(w,A,C,P);break;case 1:n.set(P,A,C,w);break;case 2:n.set(A,P,C,w);break;case 3:n.set(A,C,P,w);}}if(i)if(2===l.version){var I=h.codebook[v[4*a+0]],L=h.codebook[v[4*a+1]],D=h.codebook[v[4*a+2]];i.set(I,L,D);}else {var M=o(h.mins[0],h.maxs[0],v[4*a+0]/255),R=o(h.mins[1],h.maxs[1],v[4*a+1]/255),O=o(h.mins[2],h.maxs[2],v[4*a+2]/255);i.set(M,R,O);}if(r)if(2===l.version){var k=f.codebook[g[4*a+0]],N=f.codebook[g[4*a+1]],F=f.codebook[g[4*a+2]],B=g[4*a+3]/255;r.set(.5+.28209479177387814*k,.5+.28209479177387814*N,.5+.28209479177387814*F,B);}else {var U=o(f.mins[0],f.maxs[0],g[4*a+0]/255),z=o(f.mins[1],f.maxs[1],g[4*a+1]/255),V=o(f.mins[2],f.maxs[2],g[4*a+2]/255),G=o(f.mins[3],f.maxs[3],g[4*a+3]/255);r.set(.5+.28209479177387814*U,.5+.28209479177387814*z,.5+.28209479177387814*V,1/(1+Math.exp(-G)));}if(s){var H=y[4*a+0]+(y[4*a+1]<<8),W=H%64*b,j=Math.floor(H/64);if(2===l.version)for(var X=0;X<3;++X)for(var Y=0;Y<b;++Y)s[15*X+Y]=d.codebook[S[(W+Y)*4+X+j*e.sh_centroids.width*4]];else for(var q=0;q<3;++q)for(var K=0;K<b;++K)s[15*q+K]=o(d.mins,d.maxs,S[(W+K)*4+q+j*e.sh_centroids.width*4]/255);}};},py=function(){function e(){}var t,n=e.prototype;return n.destroy=function(){var e,t,n,i,r,s,a,o,l,u;null==(e=this.means_l)||e.destroy(),null==(t=this.means_u)||t.destroy(),null==(n=this.quats)||n.destroy(),null==(i=this.scales)||i.destroy(),null==(r=this.sh0)||r.destroy(),null==(s=this.sh_centroids)||s.destroy(),null==(a=this.sh_labels)||a.destroy(),null==(o=this.packedTexture)||o.destroy(),null==(l=this.packedSh0)||l.destroy(),null==(u=this.packedShN)||u.destroy();},n.createIter=function(e,t,n,i,r){return new pg(this,e,t,n,i,r)},n.calcAabb=function(e){var t=this.meta.means,n=t.mins,i=t.maxs,r=function(e){return Math.sign(e)*(Math.exp(Math.abs(e))-1)};e.center.set((r(n[0])+r(i[0]))*.5,(r(n[1])+r(i[1]))*.5,(r(n[2])+r(i[2]))*.5),e.halfExtents.set((r(i[0])-r(n[0]))*.5,(r(i[1])-r(n[1]))*.5,(r(i[2])-r(n[2]))*.5);},n.getCenters=function(e){for(var t=this.meta,n=this.means_l,i=this.means_u,r=this.numSplats,s=t.means,a=new Uint32Array(i._levels[0].buffer),o=new Uint32Array(n._levels[0].buffer),l=s.mins[0]/65535,u=s.mins[1]/65535,c=s.mins[2]/65535,h=s.maxs[0]/65535,f=s.maxs[1]/65535,d=s.maxs[2]/65535,p=0;p<r;p++){var m=p,_=a[m],v=o[m],g=_<<8&65280|255&v,y=65280&_|v>>>8&255,S=_>>>8&65280|v>>>16&255,x=l*(65535-g)+h*g,b=u*(65535-y)+f*y,T=c*(65535-S)+d*S,E=x<0?-x:x,w=b<0?-b:b,A=T<0?-T:T;e[3*p]=(x<0?-1:1)*(Math.exp(E)-1),e[3*p+1]=(b<0?-1:1)*(Math.exp(w)-1),e[3*p+2]=(T<0?-1:1)*(Math.exp(A)-1);}},n.calcFocalPoint=function(e,t){e.set(0,0,0);},n.decompress=function(){var e=this;return pp(function(){var t,n,i,r,s,a,o,l,u,c,h,f,d,p,m,_,v,g,y,S,x,b,T,E,w,A,C,P,I,L,D,M,R,O,k;return pm(this,function(N){switch(N.label){case 0:return t=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],n=e.shBands,i=e.means_l,r=e.means_u,s=e.quats,a=e.scales,o=e.sh0,l=e.sh_labels,u=e.sh_centroids,c=i._levels,h=0,[4,p_(i)];case 1:return c[h]=N.sent(),f=r._levels,d=0,[4,p_(r)];case 2:return f[d]=N.sent(),p=s._levels,m=0,[4,p_(s)];case 3:return p[m]=N.sent(),_=a._levels,v=0,[4,p_(a)];case 4:return _[v]=N.sent(),g=o._levels,y=0,[4,p_(o)];case 5:if(g[y]=N.sent(),!(n>0))return [3,8];return x=l._levels,b=0,[4,p_(l)];case 6:return x[b]=N.sent(),T=u._levels,E=0,[4,p_(u)];case 7:for(A=0,T[E]=N.sent(),w=[];A<45;++A)w.push("f_rest_"+A);(S=t).splice.apply(S,[].concat([t.indexOf("f_dc_0")+1,0],w)),N.label=8;case 8:for(C={},t.forEach(function(t){C[t]=new Float32Array(e.numSplats);}),P=new eW,I=new e0,L=new eW,D=new eY,M=n>0?new Float32Array(45):null,R=e.createIter(P,I,L,D,M),O=0;O<e.numSplats;++O)if(R.read(O),C.x[O]=P.x,C.y[O]=P.y,C.z[O]=P.z,C.rot_1[O]=I.x,C.rot_2[O]=I.y,C.rot_3[O]=I.z,C.rot_0[O]=I.w,C.scale_0[O]=L.x,C.scale_1[O]=L.y,C.scale_2[O]=L.z,C.f_dc_0[O]=(D.x-.5)/.28209479177387814,C.f_dc_1[O]=(D.y-.5)/.28209479177387814,C.f_dc_2[O]=(D.z-.5)/.28209479177387814,C.opacity[O]=D.w<=0?-40:D.w>=1?40:-Math.log(1/D.w-1),M)for(k=0;k<45;++k)C["f_rest_"+k][O]=M[k];return [2,new d2([{name:"vertex",count:e.numSplats,properties:t.map(function(e){return {name:e,type:"float",byteSize:4,storage:C[e]}})}])]}})})()},n.packGpuMemory=function(){var e=this.meta,t=this.means_l,n=this.means_u,i=this.quats,r=this.scales,s=this.sh0,a=this.sh_labels,o=this.numSplats,l=t.device,u=l.scope,c=2===e.version?"v2":"v1",h=o8.createShader(l,{uniqueName:"GsplatSogsReorderShader-"+c,attributes:{vertex_position:tT},vertexChunk:"fullscreenQuadVS",fragmentGLSL:'\n#include "gsplatPackingPS"\nuniform highp sampler2D means_l;\nuniform highp sampler2D means_u;\nuniform highp sampler2D quats;\nuniform highp sampler2D scales;\nuniform highp sampler2D sh0;\nuniform highp sampler2D sh_labels;\nuniform highp uint numSplats;\n#ifdef REORDER_V1\n	float sigmoid(float x) { return 1.0 / (1.0 + exp(-x)); }\n	vec3 vmin(vec3 v) { return vec3(min(min(v.x, v.y), v.z)); }\n	vec3 vmax(vec3 v) { return vec3(max(max(v.x, v.y), v.z)); }\n	vec3 resolve(vec3 m, vec3 M, vec3 v) { return (mix(m, M, v) - vmin(m)) / (vmax(M) - vmin(m)); }\n	\n	uniform vec3 scalesMins;\n	uniform vec3 scalesMaxs;\n	uniform vec4 sh0Mins;\n	uniform vec4 sh0Maxs;\n#else\n	uniform vec4 scales_codebook[64];\n	uniform vec4 sh0_codebook[64];\n#endif\nvoid main(void) {\n	int w = int(textureSize(means_l, 0).x);\n	ivec2 uv = ivec2(gl_FragCoord.xy);\n	if (uint(uv.x + uv.y * w) >= numSplats) {\n		discard;\n	}\n	vec3 meansLSample   = texelFetch(means_l, uv, 0).xyz;\n	vec3 meansUSample   = texelFetch(means_u, uv, 0).xyz;\n	vec4 quatsSample	= texelFetch(quats, uv, 0);\n	vec3 scalesSample   = texelFetch(scales, uv, 0).xyz;\n	vec4 sh0Sample	  = texelFetch(sh0, uv, 0);\n	vec2 shLabelsSample = texelFetch(sh_labels, uv, 0).xy;\n	#ifdef REORDER_V1\n		uint scale = pack101010(resolve(scalesMins, scalesMaxs, scalesSample));\n		uint sh0 = pack111110(resolve(sh0Mins.xyz, sh0Maxs.xyz, sh0Sample.xyz));\n		float alpha = sigmoid(mix(sh0Mins.w, sh0Maxs.w, sh0Sample.w));\n	#else\n		uint scale = pack101010(resolveCodebook(scalesSample, scales_codebook));\n		uint sh0 = pack111110(resolveCodebook(sh0Sample.xyz, sh0_codebook));\n		float alpha = sh0Sample.w;\n	#endif\n	uint qmode = uint(quatsSample.w * 255.0) - 252u;\n	pcFragColor0 = uvec4(\n		pack8888(vec4(meansLSample, shLabelsSample.x)),\n		pack8888(vec4(meansUSample, shLabelsSample.y)),\n		pack8888(vec4(quatsSample.xyz, alpha)),\n		(scale << 2u) | qmode\n	);\n	pcFragColor1 = unpack8888(sh0);\n}\n',fragmentWGSL:'\n#include "gsplatPackingPS"\nvar means_l: texture_2d<f32>;\nvar means_u: texture_2d<f32>;\nvar quats: texture_2d<f32>;\nvar scales: texture_2d<f32>;\nvar sh0: texture_2d<f32>;\nvar sh_labels: texture_2d<f32>;\nuniform numSplats: u32;\n#ifdef REORDER_V1\n	fn sigmoid(x: f32) -> f32 { return 1.0 / (1.0 + exp(-x)); }\n	fn vmin(v: vec3f) -> vec3f { return vec3f(min(min(v.x, v.y), v.z)); }\n	fn vmax(v: vec3f) -> vec3f { return vec3f(max(max(v.x, v.y), v.z)); }\n	fn resolve(m: vec3f, M: vec3f, v: vec3f) -> vec3f { return (mix(m, M, v) - vmin(m)) / (vmax(M) - vmin(m)); }\n	uniform scalesMins: vec3f;\n	uniform scalesMaxs: vec3f;\n	uniform sh0Mins: vec4f;\n	uniform sh0Maxs: vec4f;\n#else\n	uniform scales_codebook: array<vec4f, 64>;\n	uniform sh0_codebook: array<vec4f, 64>;\n#endif\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n	var output: FragmentOutput;\n	let w: u32 = textureDimensions(means_l, 0).x;\n	let uv: vec2<u32> = vec2<u32>(input.position.xy);\n	if (uv.x + uv.y * w >= uniform.numSplats) {\n		discard;\n		return output;\n	}\n	let meansLSample: vec3<f32> = textureLoad(means_l, uv, 0).xyz;\n	let meansUSample: vec3<f32> = textureLoad(means_u, uv, 0).xyz;\n	let quatsSample: vec4<f32> = textureLoad(quats, uv, 0);\n	let scalesSample: vec3<f32> = textureLoad(scales, uv, 0).xyz;\n	let sh0Sample: vec4f = textureLoad(sh0, uv, 0);\n	let shLabelsSample: vec2<f32> = textureLoad(sh_labels, uv, 0).xy;\n	#ifdef REORDER_V1\n		let scale = pack101010(resolve(uniform.scalesMins, uniform.scalesMaxs, scalesSample));\n		let sh0 = pack111110(resolve(uniform.sh0Mins.xyz, uniform.sh0Maxs.xyz, sh0Sample.xyz));\n		let alpha = sigmoid(mix(uniform.sh0Mins.w, uniform.sh0Maxs.w, sh0Sample.w));\n	#else\n		let scale = pack101010(resolveCodebook(scalesSample, &uniform.scales_codebook));\n		let sh0 = pack111110(resolveCodebook(sh0Sample.xyz, &uniform.sh0_codebook));\n		let alpha = sh0Sample.w;\n	#endif\n	let qmode = u32(quatsSample.w * 255.0) - 252u;\n	output.color = vec4u(\n		pack8888(vec4f(meansLSample, shLabelsSample.x)),\n		pack8888(vec4f(meansUSample, shLabelsSample.y)),\n		pack8888(vec4f(quatsSample.xyz, alpha)),\n		(scale << 2u) | qmode\n	);\n	output.color1 = unpack8888(sh0);\n	return output;\n}\n',fragmentOutputTypes:["uvec4","vec4"],fragmentIncludes:new Map([["gsplatPackingPS",l.isWebGPU?pf:ph]]),fragmentDefines:2===e.version?void 0:new Map([["REORDER_V1","1"]])}),f=new il({colorBuffers:[this.packedTexture,this.packedSh0],depth:false,mipLevel:0});l.setCullMode(0),l.setBlendState(nj.NOBLEND),l.setDepthState(nq.NODEPTH),pv(u,{means_l:t,means_u:n,quats:i,scales:r,sh0:s,sh_labels:null!=a?a:t,numSplats:o,"scales_codebook[0]":this.meta.scales.codebook,"sh0_codebook[0]":this.meta.sh0.codebook,scalesMins:e.scales.mins,scalesMaxs:e.scales.maxs,sh0Mins:e.sh0.mins,sh0Maxs:e.sh0.maxs}),ls(l,f,h),f.destroy();},n.packShMemory=function(){var e=this.meta,t=this.sh_centroids,n=t.device,i=n.scope,r=2===e.version?"v2":"v1",s=o8.createShader(n,{uniqueName:"GsplatSogsReorderShShader-"+r,attributes:{vertex_position:tT},vertexChunk:"fullscreenQuadVS",fragmentGLSL:'\n#include "gsplatPackingPS"\nuniform highp sampler2D sh_centroids;\nuniform vec4 shN_codebook[64];\nvoid main(void) {\n	ivec2 uv = ivec2(gl_FragCoord.xy);\n	vec3 shNSample = texelFetch(sh_centroids, uv, 0).xyz;\n#ifdef REORDER_V1\n	pcFragColor0 = unpack8888(pack111110(shNSample));\n#else\n	pcFragColor0 = unpack8888(pack111110(resolveCodebook(shNSample, shN_codebook)));\n#endif\n}\n',fragmentWGSL:'\n#include "gsplatPackingPS"\nvar sh_centroids: texture_2d<f32>;\nuniform shN_codebook: array<vec4f, 64>;\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n	var output: FragmentOutput;\n	var uv = vec2i(input.position.xy);\n	var shNSample = textureLoad(sh_centroids, uv, 0).xyz;\n#ifdef REORDER_V1\n	output.color = unpack8888(pack111110(shNSample));\n#else\n	output.color = unpack8888(pack111110(resolveCodebook(shNSample, &uniform.shN_codebook)));\n#endif\n	return output;\n}\n',fragmentIncludes:new Map([["gsplatPackingPS",n.isWebGPU?pf:ph]]),fragmentDefines:2===e.version?void 0:new Map([["REORDER_V1","1"]])}),a=new il({colorBuffer:this.packedShN,depth:false,mipLevel:0});n.setCullMode(0),n.setBlendState(nj.NOBLEND),n.setDepthState(nq.NODEPTH),pv(i,{sh_centroids:t,"shN_codebook[0]":this.meta.shN.codebook}),ls(n,a,s),a.destroy();},n.prepareGpuData=function(){var e=this;return pp(function(){var t,n,i,r,s,a,o,l;return pm(this,function(u){switch(u.label){case 0:return n=(t=e.means_l).device,i=t.height,r=t.width,s=e.means_l._levels,a=0,[4,p_(e.means_l)];case 1:return s[a]=u.sent(),o=e.means_u._levels,l=0,[4,p_(e.means_u)];case 2:return o[l]=u.sent(),e.packedTexture=new nO(n,{name:"sogsPackedTexture",width:r,height:i,format:49,mipmaps:false}),e.packedSh0=new nO(n,{name:"sogsPackedSh0",width:r,height:i,format:7,mipmaps:false}),e.packedShN=e.sh_centroids&&new nO(n,{name:"sogsPackedShN",width:e.sh_centroids.width,height:e.sh_centroids.height,format:7,mipmaps:false}),n.on("devicerestored",function(){e.packGpuMemory(),e.packedShN&&e.packShMemory();}),e.packGpuMemory(),e.packedShN&&e.packShMemory(),[2]}})})()},n.reorderData=function(){return this.prepareGpuData()},t=[{key:"isSogs",get:function(){return  true}},{key:"shBands",get:function(){var e,t;return null!=(t=({192:1,512:2,960:3})[null==(e=this.sh_centroids)?void 0:e.width])?t:0}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),pS=new e$,px=new eW,pb=new eW,pT=[0,0],pE=function(){function e(e,t){var n,i,r=this;void 0===t&&(t={}),this.options={},this.sorter=null,this.lastCameraPosition=new eW,this.lastCameraDirection=new eW,this.resolveSH=null,this.cameras=[],this.resource=e,this.orderTexture=e.createTexture("splatOrder",37,e.evalTextureSize(e.numSplats)),t.material?(this._material=t.material,this._material.setParameter("splatOrder",this.orderTexture)):(this._material=new h3({uniqueName:"SplatMaterial",vertexGLSL:'#include "gsplatVS"',fragmentGLSL:'#include "gsplatPS"',vertexWGSL:'#include "gsplatVS"',fragmentWGSL:'#include "gsplatPS"',attributes:{vertex_position:tT,vertex_id_attrib:tQ}}),this.configureMaterial(this._material),this._material.update()),this.meshInstance=new lL(e.mesh,this._material),this.meshInstance.setInstancing(e.instanceIndices,true),this.meshInstance.gsplatInstance=this,this.meshInstance.instancingCount=0;var s=e.centers.slice(),a=null==(n=e.chunks)?void 0:n.slice();this.sorter=new pc,this.sorter.init(this.orderTexture,s,a),this.sorter.on("updated",function(e){r.meshInstance.instancingCount=Math.ceil(e/d9.instanceSize),r.material.setParameter("numSplats",e);}),this.setHighQualitySH(null!=(i=t.highQualitySH)&&i);}var t,n=e.prototype;return n.destroy=function(){var e,t,n,i;null==(e=this.resolveSH)||e.destroy(),null==(t=this.material)||t.destroy(),null==(n=this.meshInstance)||n.destroy(),null==(i=this.sorter)||i.destroy();},n.configureMaterial=function(e,t){ void 0===t&&(t={}),this.resource.configureMaterial(e),e.setParameter("numSplats",0),e.setParameter("splatOrder",this.orderTexture),e.setParameter("alphaClip",.3),e.setDefine("DITHER_"+(t.dither?"BLUENOISE":"NONE"),""),e.cull=0,e.blendType=t.dither?3:4,e.depthWrite=!!t.dither;},n.updateViewport=function(e){var t,n=null==e?void 0:e.camera,i=null==n?void 0:n.renderTarget,r=null!=i?i:this.resource.device,s=r.width,a=r.height;pT[0]=s,pT[1]=a;var o=null==n||null==(t=n.camera)?void 0:t.xr;(null==o?void 0:o.active)&&2===o.views.list.length&&(pT[0]*=.5),this.material.setParameter("viewport",pT);},n.sort=function(e){if(this.sorter){var t=e.getWorldTransform();t.getTranslation(px),t.getZ(pb);var n=this.meshInstance.node.getWorldTransform(),i=pS.invert(n);i.transformPoint(px,px),i.transformVector(pb,pb),px.equalsApprox(this.lastCameraPosition)&&pb.equalsApprox(this.lastCameraDirection)||(this.lastCameraPosition.copy(px),this.lastCameraDirection.copy(pb),this.sorter.setCamera(px,pb));}this.updateViewport(e);},n.update=function(){if(this.cameras.length>0){var e,t=this.cameras[0];this.sort(t._node),null==(e=this.resolveSH)||e.render(t._node,this.meshInstance.node.getWorldTransform()),this.cameras.length=0;}},n.setHighQualitySH=function(e){var t=this.resource,n=t.gsplatData;(null!=py&&"undefined"!=typeof Symbol&&py[Symbol.hasInstance]?!!py[Symbol.hasInstance](n):i(n,py))&&n.shBands>0&&!!this.resolveSH===e&&(this.resolveSH?(this.resolveSH.destroy(),this.resolveSH=null):this.resolveSH=new po(t.device,this));},t=[{key:"material",get:function(){return this._material},set:function(e){this._material!==e&&(this._material=e,this._material.setParameter("splatOrder",this.orderTexture),this.meshInstance&&(this.meshInstance.material=e));}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function pw(e,t){return (pw=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var pA=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){return e.apply(this,arguments)||this}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&pw(t,e);var n=t.prototype;return n.destroy=function(){this.gsplatData.destroy(),e.prototype.destroy.call(this);},n.configureMaterialDefines=function(e){e.set("GSPLAT_SOGS_DATA",true),e.set("SH_BANDS",this.gsplatData.shBands);},n.configureMaterial=function(e){var t=this.gsplatData,n=t.meta;this.configureMaterialDefines(e.defines),["packedTexture","packedSh0","packedShN"].forEach(function(n){t[n]&&e.setParameter(n,t[n]);}),["means"].forEach(function(t){var i=n[t];i&&(e.setParameter(""+t+"_mins",i.mins),e.setParameter(""+t+"_maxs",i.maxs));}),2===n.version?["scales","sh0","shN"].forEach(function(t){var i=n[t];i&&(e.setParameter(""+t+"_mins",i.codebook[0]),e.setParameter(""+t+"_maxs",i.codebook[255]));}):(["scales","sh0"].forEach(function(t){var i,r,s=n[t];s&&(e.setParameter(""+t+"_mins",(i=Math).min.apply(i,[].concat(s.mins.slice(0,3)))),e.setParameter(""+t+"_maxs",(r=Math).max.apply(r,[].concat(s.maxs.slice(0,3)))));}),["shN"].forEach(function(t){var i=n[t];i&&(e.setParameter(""+t+"_mins",i.mins),e.setParameter(""+t+"_maxs",i.maxs));}));},n.evalTextureSize=function(e){return new eX(this.gsplatData.means_l.width,this.gsplatData.means_l.height)},t}(d9),pC="FILL_WINDOW",pP="KEEP_ASPECT",pI="AUTO",pL="FIXED",pD=false,pM={app:null,createLoadingScreen:function(e){pD||(pD=true,e(A));}},pR=function(){function e(){this.renderPasses=[],this.renderTargetMap=new Map;}var t=e.prototype;return t.addRenderPass=function(e){e.frameUpdate();for(var t=e.beforePasses,n=0;n<t.length;n++){var i=t[n];i.enabled&&this.addRenderPass(i);}e.enabled&&this.renderPasses.push(e);for(var r=e.afterPasses,s=0;s<r.length;s++){var a=r[s];a.enabled&&this.addRenderPass(a);}},t.reset=function(){this.renderPasses.length=0;},t.compile=function(){for(var e=this.renderTargetMap,t=this.renderPasses,n=0;n<t.length;n++){var i=t[n],r=i.renderTarget;if(void 0!==r){var s=e.get(r);if(s){for(var a=i.colorArrayOps.length,o=0;o<a;o++)i.colorArrayOps[o].clear||(s.colorArrayOps[o].store=true);i.depthStencilOps.clearDepth||(s.depthStencilOps.storeDepth=true),i.depthStencilOps.clearStencil||(s.depthStencilOps.storeStencil=true);}e.set(r,i);}}for(var l=0;l<t.length-1;l++){var u=t[l],c=u.renderTarget,h=t[l+1];c!==h.renderTarget||void 0===c||h.depthStencilOps.clearDepth||h.depthStencilOps.clearStencil||h.colorArrayOps.some(function(e){return e.clear})||u.afterPasses.length>0||h.beforePasses.length>0||(u._skipEnd=true,h._skipStart=true);}for(var f=null,d=null,p=0;p<t.length;p++){var m=t[p],_=m.renderTarget,v=null==_?void 0:_.colorBuffer;if(null==v?void 0:v.cubemap){if(f===v)for(var g=d.colorArrayOps.length,y=0;y<g;y++)d.colorArrayOps[y].mipmaps=false;f=_.colorBuffer,d=m;}else m.requiresCubemaps&&(f=null,d=null);}e.clear();},t.render=function(e){this.compile();for(var t=this.renderPasses,n=0;n<t.length;n++)t[n].render();},e}(),pO=function(){function e(e,t){this.texture0=e,this.texture1=t;}return e.prototype.destroy=function(){var e,t;null==(e=this.texture0)||e.destroy(),null==(t=this.texture1)||t.destroy();},e}(),pk=new nD,pN=function(){function e(){}return e.createTexture=function(e,t,n,i){return void 0===i&&(i=""),new nO(e,{name:"AreaLightLUT"+i,width:n,height:n,format:t,addressU:1,addressV:1,type:t0,magFilter:1,minFilter:0,anisotropy:1,mipmaps:false})},e.applyTextures=function(e,t,n){pk.remove(e),pk.get(e,function(){return new pO(t,t===n?null:n)}),e.scope.resolve("areaLightsLutTex1").setValue(t),e.scope.resolve("areaLightsLutTex2").setValue(n);},e.createPlaceholder=function(t){var n=e.createTexture(t,12,2,"placeholder");n.lock().fill(0),n.unlock(),e.applyTextures(t,n,n);},e.set=function(t,n,i){function r(t,n,i){var r=e.createTexture(t,i,64);return r.lock().set(n),r.unlock(),r}function s(e){for(var t=e.length,n=new Uint16Array(t),i=eG.float2Half,r=0;r<t;r++)n[r]=i(e[r]);return n}var a=s(n),o=s(i),l=r(t,a,12),u=r(t,o,12);e.applyTextures(t,l,u);},e}(),pF="en-US",pB={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},pU={};function pz(e,t){for(var n=0,i=e.length;n<i;n++)pU[e[n]]=t;}function pV(e){var t=e.indexOf("-");return -1!==t?e.substring(0,t):e}function pG(e,t){if(t[e])return e;var n=pB[e];if(n&&t[n])return n;var i=pV(e);return t[n=pB[i]]?n:t[i]?i:pF}pz(["ja","ko","th","vi","zh","id"],function(e){return 0}),pz(["fa","hi"],function(e){return e>=0&&e<=1?0:1}),pz(["fr","pt"],function(e){return e>=0&&e<2?0:1}),pz(["da"],function(e){return 1===e||!Number.isInteger(e)&&e>=0&&e<=1?0:1}),pz(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],function(e){return +(1!==e)}),pz(["ru","uk"],function(e){if(Number.isInteger(e)){var t=e%10,n=e%100;if(1===t&&11!==n)return 0;if(t>=2&&t<=4&&(n<12||n>14))return 1;if(0===t||t>=5&&t<=9||n>=11&&n<=14)return 2}return 3}),pz(["pl"],function(e){if(Number.isInteger(e)){if(1===e)return 0;var t=e%10,n=e%100;if(t>=2&&t<=4&&(n<12||n>14))return 1;if(t>=0&&t<=1||t>=5&&t<=9||n>=12&&n<=14)return 2}return 3}),pz(["ar"],function(e){if(0===e)return 0;if(1===e)return 1;if(2===e)return 2;if(Number.isInteger(e)){var t=e%100;if(t>=3&&t<=10)return 3;if(t>=11&&t<=99)return 4}return 5});var pH=pU[pV(pF)],pW=RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-+.]*:)?//|data:|blob:)","i"),pj=function(){function e(e,t,n,i,r,s){ void 0===e&&(e=""),void 0===t&&(t=""),void 0===n&&(n=null),void 0===i&&(i=null),void 0===r&&(r=null),void 0===s&&(s=null),this.url=e,this.filename=t,this.hash=n,this.size=i,this.opt=r,this.contents=s;}return e.prototype.equals=function(e){return this.url===e.url&&this.filename===e.filename&&this.hash===e.hash&&this.size===e.size&&this.opt===e.opt&&this.contents===e.contents},e}();function pX(e,t){return (pX=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var pY=-1,pq={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},pK=["pvr","dxt","etc2","etc1","basis"],pZ=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i,r,s){var a;return void 0===r&&(r={}),void 0===s&&(s={}),(a=e.call(this)||this)._file=null,a._i18n={},a._preload=false,a._resources=[],a.id=pY--,a.loaded=false,a.loading=false,a.options={},a.registry=null,a.tags=new eI(a),a.urlObject=null,a._name=t||"",a.type=n,a._data=r||{},a.options=s||{},i&&(a.file=i),a}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&pX(t,e);var n,i=t.prototype;return i.getFileUrl=function(){var e=this.file;if(!e||!e.url)return null;var t=e.url;if(this.registry&&this.registry.prefix&&!pW.test(t)&&(t=this.registry.prefix+t),"script"!==this.type&&e.hash){var n=-1!==t.indexOf("?")?"&":"?";t+=n+"t="+e.hash;}return t},i.getAbsoluteUrl=function(e){if(e.startsWith("blob:")||e.startsWith("data:"))return e;var t=en.getDirectory(this.file.url);return en.join(t,e)},i.getLocalizedAssetId=function(e){return e=pG(e,this._i18n),this._i18n[e]||null},i.addLocalizedAssetId=function(e,t){this._i18n[e]=t,this.fire("add:localized",e,t);},i.removeLocalizedAssetId=function(e){var t=this._i18n[e];t&&(delete this._i18n[e],this.fire("remove:localized",e,t));},i.ready=function(e,t){t=t||this,this.loaded?e.call(t,this):this.once("load",function(n){e.call(t,n);});},i.reload=function(){this.loaded&&(this.loaded=false,this.registry.load(this));},i.unload=function(){if(this.loaded||0!==this._resources.length){this.fire("unload",this),this.registry.fire("unload:"+this.id,this);var e=this._resources;this.urlObject&&(URL.revokeObjectURL(this.urlObject),this.urlObject=null),this.resources=[],this.loaded=false,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(var t=0;t<e.length;++t){var n=e[t];n&&n.destroy&&n.destroy();}}},t.fetchArrayBuffer=function(e,t,n,i){var r;void 0===i&&(i=0),(null==n||null==(r=n.file)?void 0:r.contents)?setTimeout(function(){t(null,n.file.contents);}):aq.get(e,{cache:true,responseType:"arraybuffer",retry:i>0,maxRetries:i,progress:n},t);},n=[{key:"name",get:function(){return this._name},set:function(e){if(this._name!==e){var t=this._name;this._name=e,this.fire("name",this,this._name,t);}}},{key:"file",get:function(){return this._file},set:function(e){if(e&&e.variants&&-1!==["texture","textureatlas","bundle"].indexOf(this.type)){var t=(null==(r=this.registry)||null==(i=r._loader)?void 0:i._app)||A,n=null==t?void 0:t.graphicsDevice;if(n)for(var i,r,s,a=0,o=pK.length;a<o&&"break"!==(s=this,function(i,r){var a=pK[i];if(e.variants[a]&&n[pq[a]])return e=e.variants[a],"break";if(t.enableBundles){var o=t.bundles.listBundlesForAsset(s);if(o&&o.find(function(e){var t;return null==e||null==(t=e.file)?void 0:t.variants[a]}))return "break"}}(a));a++);}var l=this._file,u=e?new pj(e.url,e.filename,e.hash,e.size,e.opt,e.contents):null;(!!u!=!!l||u&&!u.equals(l))&&(this._file=u,this.fire("change",this,"file",u,l),this.reload());}},{key:"data",get:function(){return this._data},set:function(e){var t=this._data;this._data=e,e!==t&&(this.fire("change",this,"data",e,t),this.loaded&&this.registry._loader.patch(this,this.registry));}},{key:"resource",get:function(){return this._resources[0]},set:function(e){var t=this._resources[0];this._resources[0]=e,this.fire("change",this,"resource",e,t);}},{key:"resources",get:function(){return this._resources},set:function(e){var t=this._resources;this._resources=e,this.fire("change",this,"resources",e,t);}},{key:"preload",get:function(){return this._preload},set:function(e){e=!!e,this._preload!==e&&(this._preload=e,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this));}},{key:"loadFaces",get:function(){return this._loadFaces},set:function(e){e=!!e,(!this.hasOwnProperty("_loadFaces")||e!==this._loadFaces)&&(this._loadFaces=e,this.loaded&&this.registry._loader.patch(this,this.registry));}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function pQ(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function pJ(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return pQ(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return pQ(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}pZ.EVENT_LOAD="load",pZ.EVENT_UNLOAD="unload",pZ.EVENT_REMOVE="remove",pZ.EVENT_ERROR="error",pZ.EVENT_CHANGE="change",pZ.EVENT_PROGRESS="progress",pZ.EVENT_ADDLOCALIZED="add:localized",pZ.EVENT_REMOVELOCALIZED="remove:localized";var p$=function(){function e(e){ void 0===e&&(e=null),this._index={},this._key=e;}var t=e.prototype;return t.addItem=function(e){for(var t,n=e.tags._list,i=pJ(n);!(t=i()).done;){var r=t.value;this.add(r,e);}},t.removeItem=function(e){for(var t,n=e.tags._list,i=pJ(n);!(t=i()).done;){var r=t.value;this.remove(r,e);}},t.add=function(e,t){(!this._index[e]||-1===this._index[e].list.indexOf(t))&&(!this._index[e]&&(this._index[e]={list:[]},this._key&&(this._index[e].keys={})),this._index[e].list.push(t),this._key&&(this._index[e].keys[t[this._key]]=t));},t.remove=function(e,t){if(this._index[e]&&(!this._key||this._index[e].keys[t[this._key]])){var n=this._index[e].list.indexOf(t);-1!==n&&(this._index[e].list.splice(n,1),this._key&&delete this._index[e].keys[t[this._key]],0===this._index[e].list.length&&delete this._index[e]);}},t.find=function(e){for(var t,n,r,s,a,o,l,u=this,c={},h=[],f=function(e,t){return u._index[e].list.length-u._index[t].list.length},d=0;d<e.length;d++){if(t=s=e[d],null!=(n=Array)&&"undefined"!=typeof Symbol&&n[Symbol.hasInstance]?!!n[Symbol.hasInstance](t):i(t,n)){if(0===s.length)continue;if(1===s.length)s=s[0];else {l=false;for(var p=0;p<s.length;p++)if(!this._index[s[p]]){l=true;break}if(l)continue;1===(o=(a=s.slice(0).sort(f)).slice(1)).length&&(o=o[0]);for(var m=0;m<this._index[a[0]].list.length;m++)r=this._index[a[0]].list[m],(this._key?!c[r[this._key]]:-1===h.indexOf(r))&&r.tags.has(o)&&(this._key&&(c[r[this._key]]=true),h.push(r));continue}}if(s&&"string"==typeof s&&this._index[s])for(var _=0;_<this._index[s].list.length;_++)r=this._index[s].list[_],this._key?c[r[this._key]]||(c[r[this._key]]=true,h.push(r)):-1===h.indexOf(r)&&h.push(r);}return h},e}();function p0(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function p1(e,t){return (p1=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p2=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this)._assets=new Set,n._idToAsset=new Map,n._urlToAsset=new Map,n._nameToAsset=new Map,n._tags=new p$("id"),n.prefix=null,n.bundles=null,n._loader=t,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&p1(t,e);var n=t.prototype;return n.list=function(e){ void 0===e&&(e={});var t=Array.from(this._assets);return void 0!==e.preload?t.filter(function(t){return t.preload===e.preload}):t},n.add=function(e){var t,n;!this._assets.has(e)&&(this._assets.add(e),this._idToAsset.set(e.id,e),(null==(t=e.file)?void 0:t.url)&&this._urlToAsset.set(e.file.url,e),this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e),e.on("name",this._onNameChange,this),e.registry=this,this._tags.addItem(e),e.tags.on("add",this._onTagAdd,this),e.tags.on("remove",this._onTagRemove,this),this.fire("add",e),this.fire("add:"+e.id,e),(null==(n=e.file)?void 0:n.url)&&this.fire("add:url:"+e.file.url,e),e.preload&&this.load(e));},n.remove=function(e){var t,n;if(!this._assets.has(e))return  false;if(this._assets.delete(e),this._idToAsset.delete(e.id),(null==(t=e.file)?void 0:t.url)&&this._urlToAsset.delete(e.file.url),e.off("name",this._onNameChange,this),this._nameToAsset.has(e.name)){var i=this._nameToAsset.get(e.name);i.delete(e),0===i.size&&this._nameToAsset.delete(e.name);}return this._tags.removeItem(e),e.tags.off("add",this._onTagAdd,this),e.tags.off("remove",this._onTagRemove,this),e.fire("remove",e),this.fire("remove",e),this.fire("remove:"+e.id,e),(null==(n=e.file)?void 0:n.url)&&this.fire("remove:url:"+e.file.url,e),true},n.get=function(e){return this._idToAsset.get(Number(e))},n.getByUrl=function(e){return this._urlToAsset.get(e)},n.load=function(e,t){var n=this;if(!e.loading&&!e.loaded||(null==t?void 0:t.force)){var r=e.file,s=function(){n.fire("load",e),n.fire("load:"+e.id,e),r&&r.url&&n.fire("load:url:"+r.url,e),e.fire("load",e);},a=function(t){var a;if((null!=(a=Array)&&"undefined"!=typeof Symbol&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](t):i(t,a))?e.resources=t:e.resource=t,n._loader.patch(e,n),"bundle"===e.type){for(var o=e.data.assets,l=0;l<o.length;l++){var u=n._idToAsset.get(o[l]);u&&!u.loaded&&n.load(u,{force:true});}e.resource.loaded?s():(n.fire("load:start",e),n.fire("load:start:"+e.id,e),r&&r.url&&n.fire("load:start:url:"+r.url,e),e.fire("load:start",e),e.resource.on("load",s));}else s();};if(r||"cubemap"===e.type){this.fire("load:start",e),this.fire("load:"+e.id+":start",e),e.loading=true;var o=e.getFileUrl();if("bundle"===e.type)for(var l=e.data.assets,u=0;u<l.length;u++){var c=this._idToAsset.get(l[u]);c&&(c.loaded||c.resource||c.loading||(c.loading=true));}this._loader.load(o,e.type,function(t,i,r){if(e.loaded=true,e.loading=false,t)n.fire("error",t,e),n.fire("error:"+e.id,t,e),e.fire("error",t,e);else {if("script"===e.type){var s=n._loader.getHandler("script");s._cache[e.id]&&s._cache[e.id].parentNode===document.head&&document.head.removeChild(s._cache[e.id]),s._cache[e.id]=r;}a(i);}},e,t);}else {var h=this._loader.open(e.type,e.data);e.loaded=true,a(h);}}},n.loadFromUrl=function(e,t,n){this.loadFromUrlAndFilename(e,null,t,n);},n.loadFromUrlAndFilename=function(e,t,n,i){var r=this,s=en.getBasename(t||e),a=this.getByUrl(e);if(a){if(a.loaded)return void i(a.loadFromUrlError||null,a)}else a=new pZ(s,n,{filename:t||s,url:e}),this.add(a);var o=function(e){e.once("load",function(e){"material"===n?r._loadTextures(e,function(t,n){i(t,e);}):i(null,e);}),e.once("error",function(t){t&&(r.loadFromUrlError=t),i(t,e);}),r.load(e);};a.resource?i(null,a):"model"===n?this._loadModel(a,o):o(a);},n._loadModel=function(e,t){var n=this,i=e.getFileUrl(),r=en.getExtension(i);if(".json"===r||".glb"===r){var s=en.getDirectory(i),a=en.getBasename(i),o=en.join(s,a.replace(r,".mapping.json"));this._loader.load(o,"json",function(i,r){i?(e.data={mapping:[]},t(e)):n._loadMaterials(e,r,function(n,i){e.data=r,t(e);});});}else t(e);},n._loadMaterials=function(e,t,n){for(var i=this,r=[],s=0,a=function(e,t){i._loadTextures(t,function(e,i){r.push(t),r.length===s&&n(null,r);});},o=0;o<t.mapping.length;o++){var l=t.mapping[o].path;if(l){s++;var u=e.getAbsoluteUrl(l);this.loadFromUrl(u,"material",a);}}0===s&&n(null,r);},n._loadTextures=function(e,t){var n=[],i=0,r=e.data;if("path"!==r.mappingFormat)return void t(null,n);for(var s=function(e,r){n.push(r),n.length===i&&t(null,n);},a=0;a<dm.length;a++){var o=r[dm[a]];if(o&&"string"==typeof o){i++;var l=e.getAbsoluteUrl(o);this.loadFromUrl(l,"texture",s);}}0===i&&t(null,n);},n._onTagAdd=function(e,t){this._tags.add(e,t);},n._onTagRemove=function(e,t){this._tags.remove(e,t);},n._onNameChange=function(e,t,n){if(this._nameToAsset.has(n)){var i=this._nameToAsset.get(n);i.delete(e),0===i.size&&this._nameToAsset.delete(n);}this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e);},n.findByTag=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return this._tags.find(t)},n.filter=function(e){return Array.from(this._assets).filter(function(t){return e(t)})},n.find=function(e,t){var n=this._nameToAsset.get(e);if(!n)return null;for(var i,r=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return p0(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return p0(e,void 0)}}(e))){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(n);!(i=r()).done;){var s=i.value;if(!t||s.type===t)return s}return null},n.findAll=function(e,t){var n=this._nameToAsset.get(e);if(!n)return [];var i=Array.from(n);return t?i.filter(function(e){return e.type===t}):i},t}(ex);function p3(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function p4(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return p3(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return p3(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}p2.EVENT_LOAD="load",p2.EVENT_ADD="add",p2.EVENT_REMOVE="remove",p2.EVENT_ERROR="error";var p5=function(){function e(e){this._idToBundle=new Map,this._assetToBundles=new Map,this._urlsToBundles=new Map,this._fileRequests=new Map,this._assets=e,this._assets.bundles=this,this._assets.on("add",this._onAssetAdd,this),this._assets.on("remove",this._onAssetRemove,this);}var t=e.prototype;return t._onAssetAdd=function(e){if("bundle"===e.type){this._idToBundle.set(e.id,e),this._assets.on("load:start:"+e.id,this._onBundleLoadStart,this),this._assets.on("load:"+e.id,this._onBundleLoad,this),this._assets.on("error:"+e.id,this._onBundleError,this);for(var t=e.data.assets,n=0;n<t.length;n++)this._indexAssetInBundle(t[n],e);}else this._assetToBundles.has(e.id)&&this._indexAssetFileUrls(e);},t._unbindAssetEvents=function(e){this._assets.off("load:start:"+e,this._onBundleLoadStart,this),this._assets.off("load:"+e,this._onBundleLoad,this),this._assets.off("error:"+e,this._onBundleError,this);},t._indexAssetInBundle=function(e,t){var n=this._assetToBundles.get(e);n||(n=new Set,this._assetToBundles.set(e,n)),n.add(t);var i=this._assets.get(e);i&&this._indexAssetFileUrls(i);},t._indexAssetFileUrls=function(e){var t=this._getAssetFileUrls(e);if(t)for(var n=0;n<t.length;n++){var i=this._assetToBundles.get(e.id);i&&this._urlsToBundles.set(t[n],i);}},t._getAssetFileUrls=function(e){var t=e.getFileUrl();if(!t)return null;var n=[t=t.split("?")[0]];if("font"===e.type)for(var i=e.data.info.maps.length,r=1;r<i;r++)n.push(t.replace(".png",""+r+".png"));return n},t._onAssetRemove=function(e){if("bundle"===e.type){this._idToBundle.delete(e.id),this._unbindAssetEvents(e.id);for(var t=e.data.assets,n=0;n<t.length;n++){var i=this._assetToBundles.get(t[n]);if(i&&(i.delete(e),0===i.size)){this._assetToBundles.delete(t[n]);for(var r,s=p4(this._urlsToBundles);!(r=s()).done;){var a=r.value,o=a[0];a[1]===i&&this._urlsToBundles.delete(o);}}}this._onBundleError("Bundle "+e.id+" was removed");}else {if(!this._assetToBundles.get(e.id))return;this._assetToBundles.delete(e.id);var l=this._getAssetFileUrls(e);if(!l)return;for(var u=0;u<l.length;u++)this._urlsToBundles.delete(l[u]);}},t._onBundleLoadStart=function(e){var t=this;e.resource.on("add",function(e,n){var i=t._fileRequests.get(e);if(i){for(var r=0;r<i.length;r++)i[r](null,n);t._fileRequests.delete(e);}});},t._onBundleLoad=function(e){if(!e.resource)return void this._onBundleError("Bundle "+e.id+" failed to load");if(this._fileRequests)for(var t,n=p4(this._fileRequests);!(t=n()).done;){var i=t.value,r=i[0],s=i[1],a=this._urlsToBundles.get(r);if(a&&a.has(e)){var o=decodeURIComponent(r),l=void 0,u=void 0;if(e.resource.has(o))u=e.resource.get(o);else {if(!e.resource.loaded)continue;l="Bundle "+e.id+" does not contain URL "+r;}for(var c=0;c<s.length;c++)s[c](l,l||u);this._fileRequests.delete(r);}}},t._onBundleError=function(e){for(var t,n=p4(this._fileRequests);!(t=n()).done;){var i=t.value,r=i[0],s=i[1];if(!this._findLoadedOrLoadingBundleForUrl(r)){for(var a=0;a<s.length;a++)s[a](e);this._fileRequests.delete(r);}}},t._findLoadedOrLoadingBundleForUrl=function(e){var t=this._urlsToBundles.get(e);if(!t)return null;for(var n,i=null,r=p4(t);!(n=r()).done;){var s=n.value;if(s.loaded&&s.resource)return s;s.loading&&(i=s);}return i},t.listBundlesForAsset=function(e){var t=this._assetToBundles.get(e.id);return t?Array.from(t):null},t.list=function(){return Array.from(this._idToBundle.values())},t.hasUrl=function(e){return this._urlsToBundles.has(e)},t.urlIsLoadedOrLoading=function(e){return !!this._findLoadedOrLoadingBundleForUrl(e)},t.loadUrl=function(e,t){var n=this._findLoadedOrLoadingBundleForUrl(e);if(!n)return void t("URL "+e+" not found in any bundles");if(n.loaded){var i=decodeURIComponent(e);if(n.resource.has(i))return void t(null,n.resource.get(i));if(n.resource.loaded)return void t("Bundle "+n.id+" does not contain URL "+e)}var r=this._fileRequests.get(e);r||(r=[],this._fileRequests.set(e,r)),r.push(t);},t.destroy=function(){this._assets.off("add",this._onAssetAdd,this),this._assets.off("remove",this._onAssetRemove,this);for(var e,t=p4(this._idToBundle.keys());!(e=t()).done;){var n=e.value;this._unbindAssetEvents(n);}this._assets=null,this._idToBundle.clear(),this._idToBundle=null,this._assetToBundles.clear(),this._assetToBundles=null,this._urlsToBundles.clear(),this._urlsToBundles=null,this._fileRequests.clear(),this._fileRequests=null;},e}();function p8(e,t){return (p8=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p6=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return (t=e.call(this)||this).list=[],t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&p8(t,e);var n=t.prototype;return n.add=function(e){var t=e.id;if(this[t])throw Error("ComponentSystem name '"+t+"' already registered or not allowed");this[t]=e,this.list.push(e);},n.remove=function(e){var t=e.id;if(!this[t])throw Error("No ComponentSystem named '"+t+"' registered");delete this[t];var n=this.list.indexOf(this[t]);-1!==n&&this.list.splice(n,1);},n.destroy=function(){this.off();for(var e=0;e<this.list.length;e++)this.list[e].destroy();},t}(ex);function p9(e,t){return (p9=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p7=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return t=e.apply(this,arguments)||this,t._index=new Map,t._loaded=false,t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&p9(t,e);var n,i=t.prototype;return i.addFile=function(e,t){this._index.has(e)||(this._index.set(e,t),this.fire("add",e,t));},i.has=function(e){return this._index.has(e)},i.get=function(e){return this._index.get(e)||null},i.destroy=function(){this._index.clear();},n=[{key:"loaded",get:function(){return this._loaded},set:function(e){e&&!this._loaded&&(this._loaded=true,this.fire("load"));}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function me(e,t){return (me=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}p7.EVENT_ADD="add",p7.EVENT_LOAD="load";var mt=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return void 0===n&&(n=""),(i=e.call(this)||this).headerSize=512,i.paddingSize=512,i.bytesRead=0,i.bytesReceived=0,i.headerRead=false,i.reader=null,i.data=new Uint8Array(0),i.decoder=null,i.prefix="",i.fileName="",i.fileSize=0,i.fileType="",i.ustarFormat="",i.prefix=n||"",i.reader=t.body.getReader(),i.reader.read().then(function(e){i.pump(e.done,e.value);}).catch(function(e){i.fire("error",e);}),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&me(t,e);var n=t.prototype;return n.pump=function(e,t){var n=this;if(e)return this.fire("done"),null;this.bytesReceived+=t.byteLength;var i=new Uint8Array(this.data.length+t.length);for(i.set(this.data),i.set(t,this.data.length),this.data=i;this.readFile(););return this.reader.read().then(function(e){n.pump(e.done,e.value);}).catch(function(e){n.fire("error",e);})},n.readFile=function(){if(!this.headerRead&&this.bytesReceived>this.bytesRead+this.headerSize){this.headerRead=true;var e=new DataView(this.data.buffer,this.bytesRead,this.headerSize);null!=this.decoder||(this.decoder=new TextDecoder("windows-1252"));var t=this.decoder.decode(e);if(this.fileName=t.substring(0,100).replace(/\0/g,""),this.fileSize=parseInt(t.substring(124,136),8),this.fileType=t.substring(156,157),this.ustarFormat=t.substring(257,263),-1!==this.ustarFormat.indexOf("ustar")){var n=t.substring(345,500).replace(/\0/g,"");n.length>0&&(this.fileName=n.trim()+this.fileName.trim());}this.bytesRead+=512;}if(this.headerRead){if(this.bytesReceived<this.bytesRead+this.fileSize)return  false;if(""===this.fileType||"0"===this.fileType){var i=new DataView(this.data.buffer,this.bytesRead,this.fileSize),r={name:this.prefix+this.fileName,size:this.fileSize,data:i};this.fire("file",r);}this.bytesRead+=this.fileSize,this.headerRead=false;var s=this.bytesRead%this.paddingSize;return 0!==s&&(this.bytesRead+=this.paddingSize-s),true}return  false},t}(ex),mn=function(){function e(e,t){this.handlerType="",this._maxRetries=0,this._app=e,this.handlerType=t;}var t,n=e.prototype;return n.load=function(e,t,n){},n.open=function(e,t,n){return t},n.patch=function(e,t){},t=[{key:"maxRetries",get:function(){return this._maxRetries},set:function(e){this._maxRetries=e;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function mi(e,t){return (mi=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var mr=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"bundle")||this)._assets=t.assets,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&mi(t,e);var n=t.prototype;return n._fetchRetries=function(e,t,n){var i=this;return void 0===n&&(n=0),new Promise(function(r,s){var a=function(){fetch(e,t).then(r).catch(function(e){++n<i.maxRetries?a():s(e);});};a();})},n.load=function(e,t){var n=this;"string"==typeof e&&(e={load:e,original:e}),this._fetchRetries(e.load,{mode:"cors"},this.maxRetries).then(function(e){var i=new p7;t(null,i);var r=new mt(e,n._assets.prefix);r.on("file",function(e){i.addFile(e.name,e.data);}),r.on("done",function(){i.loaded=true;}),r.on("error",function(e){t(e);});}).catch(function(e){t(e);});},n.open=function(e,t){return t},t}(mn),ms=function(){function e(e){this._handlers={},this._requests={},this._cache={},this._app=e;}var t=e.prototype;return t.addHandler=function(e,t){this._handlers[e]=t,t._loader=this;},t.removeHandler=function(e){delete this._handlers[e];},t.getHandler=function(e){return this._handlers[e]},t.load=function(t,n,r,s,a){var o=this._handlers[n];if(!o)return void r("No resource handler for asset type: '"+n+"' when loading ["+t+"]");if(!t)return void this._loadNull(o,r,s);var l=e.makeKey(t,n);if(void 0!==this._cache[l])r(null,this._cache[l]);else if(this._requests[l])this._requests[l].push(r);else {this._requests[l]=[r];var u=this,c=function(e,t){if(e)return void u._onFailure(l,e);if(n=t.load,null!=(r=DataView)&&"undefined"!=typeof Symbol&&r[Symbol.hasInstance]?!!r[Symbol.hasInstance](n):i(n,r)){if(o.openBinary){if(!u._requests[l])return;try{var n,r,a=o.openBinary(t.load);u._onSuccess(l,a);}catch(e){u._onFailure(l,e);}return}t.load=URL.createObjectURL(new Blob([t.load])),s&&(s.urlObject&&URL.revokeObjectURL(s.urlObject),s.urlObject=t.load);}o.load(t,function(e,n,i){if(u._requests[l]){if(e)return void u._onFailure(l,e);try{u._onSuccess(l,o.open(t.original,n,s),i);}catch(e){u._onFailure(l,e);}}},s);},h=t.split("?")[0];if(this._app.enableBundles&&this._app.bundles.hasUrl(h)&&!(a&&a.bundlesIgnore)){if(!this._app.bundles.urlIsLoadedOrLoading(h)){var f,d,p=this._app.bundles.listBundlesForAsset(s);a&&a.bundlesFilter&&(d=a.bundlesFilter(p)),d||(null==p||p.sort(function(e,t){return e.file.size-t.file.size}),d=null==p?void 0:p[0]),d&&(null==(f=this._app.assets)||f.load(d));}this._app.bundles.loadUrl(h,function(e,t){c(e,{load:t,original:h});});}else c(null,{load:t,original:s&&s.file.filename||t});}},t._loadNull=function(e,t,n){e.load(null,function(i,r,s){if(i)t(i);else try{t(null,e.open(null,r,n),s);}catch(e){t(e);}},n);},t._onSuccess=function(e,t,n){null!==t?this._cache[e]=t:delete this._cache[e];for(var i=0;i<this._requests[e].length;i++)this._requests[e][i](null,t,n);delete this._requests[e];},t._onFailure=function(e,t){if(this._requests[e]){for(var n=0;n<this._requests[e].length;n++)this._requests[e][n](t);delete this._requests[e];}},t.open=function(e,t){var n=this._handlers[e];return n?n.open(null,t):t},t.patch=function(e,t){var n=this._handlers[e.type];n&&n.patch&&n.patch(e,t);},t.clearCache=function(t,n){var i=e.makeKey(t,n);delete this._cache[i];},t.getFromCache=function(t,n){var i=e.makeKey(t,n);if(this._cache[i])return this._cache[i]},t.enableRetry=function(e){for(var t in void 0===e&&(e=5),e=Math.max(0,e)||0,this._handlers)this._handlers[t].maxRetries=e;},t.disableRetry=function(){for(var e in this._handlers)this._handlers[e].maxRetries=0;},t.destroy=function(){this._handlers={},this._requests={},this._cache={};},e.makeKey=function(e,t){return e+"-"+t},e}(),ma=function(){function e(){}var t=e.prototype;return t._validate=function(e){if(!e.header)throw Error('pc.I18n#addData: Missing "header" field');if(!e.header.version)throw Error('pc.I18n#addData: Missing "header.version" field');if(1!==e.header.version)throw Error('pc.I18n#addData: Invalid "header.version" field');if(e.data){if(!Array.isArray(e.data))throw Error('pc.I18n#addData: "data" field must be an array')}else throw Error('pc.I18n#addData: Missing "data" field');for(var t=0,n=e.data.length;t<n;t++){var i=e.data[t];if(!i.info)throw Error('pc.I18n#addData: missing "data['+t+'].info" field');if(!i.info.locale)throw Error('pc.I18n#addData: missing "data['+t+'].info.locale" field');if("string"!=typeof i.info.locale)throw Error('pc.I18n#addData: "data['+t+'].info.locale" must be a string');if(!i.messages)throw Error('pc.I18n#addData: missing "data['+t+'].messages" field')}},t.parse=function(e){return e.data},e}();function mo(e,t){return (mo=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ml=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this).locale=pF,n._translations={},n._availableLangs={},n._app=t,n._assets=[],n._parser=new ma,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&mo(t,e);var n,r=t.prototype;return r.findAvailableLocale=function(e){if(this._translations[e])return e;var t=pV(e);return this._findFallbackLocale(e,t)},r.getText=function(e,t){var n,i=e;t||(t=this._locale,n=this._lang);var r=this._translations[t];return r||(n||(n=pV(t)),t=this._findFallbackLocale(t,n),r=this._translations[t]),r&&r.hasOwnProperty(e)&&(Array.isArray(i=r[e])&&(i=i[0]),null==i&&(i=e)),i},r.getPluralText=function(e,t,n){var i,r,s=e;n?r=pU[i=pV(n)]||pH:(n=this._locale,i=this._lang,r=this._pluralFn);var a=this._translations[n];if(a||(r=pU[i=pV(n=this._findFallbackLocale(n,i))]||pH,a=this._translations[n]),a&&a[e]&&r){var o=r(t);null==(s=a[e][o])&&(s=e);}return s},r.addData=function(e){var t;try{t=this._parser.parse(e);}catch(e){return}for(var n=0,i=t.length;n<i;n++){var r=t[n],s=r.info.locale,a=r.messages;if(!this._translations[s]){this._translations[s]={};var o=pV(s);this._availableLangs[o]||(this._availableLangs[o]=s);}Object.assign(this._translations[s],a),this.fire("data:add",s,a);}},r.removeData=function(e){var t;try{t=this._parser.parse(e);}catch(e){return}for(var n=0,i=t.length;n<i;n++){var r=t[n],s=r.info.locale,a=this._translations[s];if(a){var o=r.messages;for(var l in o)delete a[l];0===Object.keys(a).length&&(delete this._translations[s],delete this._availableLangs[pV(s)]),this.fire("data:remove",s,o);}}},r.destroy=function(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off();},r._findFallbackLocale=function(e,t){var n=pB[e];return n&&this._translations[n]||(n=pB[t])&&this._translations[n]||(n=this._availableLangs[t])&&this._translations[n]?n:pF},r._onAssetAdd=function(e){e.on("load",this._onAssetLoad,this),e.on("change",this._onAssetChange,this),e.on("remove",this._onAssetRemove,this),e.on("unload",this._onAssetUnload,this),e.resource&&this._onAssetLoad(e);},r._onAssetLoad=function(e){this.addData(e.resource);},r._onAssetChange=function(e){e.resource&&this.addData(e.resource);},r._onAssetRemove=function(e){e.off("load",this._onAssetLoad,this),e.off("change",this._onAssetChange,this),e.off("remove",this._onAssetRemove,this),e.off("unload",this._onAssetUnload,this),e.resource&&this.removeData(e.resource),this._app.assets.once("add:"+e.id,this._onAssetAdd,this);},r._onAssetUnload=function(e){e.resource&&this.removeData(e.resource);},t.findAvailableLocale=function(e,t){return pG(e,t)},n=[{key:"assets",get:function(){return this._assets},set:function(e){for(var t,n={},r=0,s=e.length;r<s;r++)n[(t=e[r],null!=pZ&&"undefined"!=typeof Symbol&&pZ[Symbol.hasInstance]?!!pZ[Symbol.hasInstance](t):i(t,pZ))?e[r].id:e[r]]=true;for(var a=this._assets.length;a--;){var o=this._assets[a];if(!n[o]){this._app.assets.off("add:"+o,this._onAssetAdd,this);var l=this._app.assets.get(o);l&&this._onAssetRemove(l),this._assets.splice(a,1);}}for(var u in n){var c=parseInt(u,10);if(-1===this._assets.indexOf(c)){this._assets.push(c);var h=this._app.assets.get(c);h?this._onAssetAdd(h):this._app.assets.once("add:"+c,this._onAssetAdd,this);}}}},{key:"locale",get:function(){return this._locale},set:function(e){if(this._locale!==e){var n,i,r,s=pV(e);if("in"!==s||(s="id",n=e,i=s,e=-1!==(r=n.indexOf("-"))?i+n.substring(r):i,this._locale!==e)){var a=this._locale;this._locale=e,this._lang=s,this._pluralFn=pU[this._lang]||pH,this.fire(t.EVENT_CHANGE,e,a);}}}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function mu(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function mc(e,t){return (mc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}ml.EVENT_CHANGE="change";var mh=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this)._scripts={},n._list=[],n._scriptSchemas=new Map,n.app=t,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&mc(t,e);var n=t.prototype;return n.destroy=function(){this.app=null,this.off();},n.addSchema=function(e,t){t&&this._scriptSchemas.set(e,t);},n.getSchema=function(e){return this._scriptSchemas.get(e)},n.add=function(e){var t=this,n=e.__name;return this._scripts.hasOwnProperty(n)?(setTimeout(function(){if(e.prototype.swap){var i=t._scripts[n],r=t._list.indexOf(i);t._list[r]=e,t._scripts[n]=e,t.fire("swap",n,e),t.fire("swap:"+n,e);}}),false):(this._scripts[n]=e,this._list.push(e),this.fire("add",n,e),this.fire("add:"+n,e),setTimeout(function(){if(t._scripts.hasOwnProperty(n)&&t.app&&t.app.systems&&t.app.systems.script){var e=t.app.systems.script._components,i=[],r=[];for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){var s=e.items[e.loopIndex];if(s._scriptsIndex[n]&&s._scriptsIndex[n].awaiting){s._scriptsData&&s._scriptsData[n]&&(o=s._scriptsData[n].attributes);var a=s.create(n,{preloading:true,ind:s._scriptsIndex[n].ind,attributes:o});a&&i.push(a);for(var o,l,u=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return mu(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return mu(e,void 0)}}(e))){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(s.scripts);!(l=u()).done;){var c=l.value;s.initializeAttributes(c);}}}for(var h=0;h<i.length;h++)i[h].enabled&&(i[h]._initialized=true,r.push(i[h]),i[h].initialize&&i[h].initialize());for(var f=0;f<r.length;f++)r[f].enabled&&!r[f]._postInitialized&&(r[f]._postInitialized=true,r[f].postInitialize&&r[f].postInitialize());}}),true)},n.remove=function(e){var t=e,n=e;if("string"!=typeof n?n=t.__name:t=this.get(n),this.get(n)!==t)return  false;delete this._scripts[n];var i=this._list.indexOf(t);return this._list.splice(i,1),this.fire("remove",n,t),this.fire("remove:"+n,t),true},n.get=function(e){return this._scripts[e]||null},n.has=function(e){if("string"==typeof e)return this._scripts.hasOwnProperty(e);if(!e)return  false;var t=e.__name;return this._scripts[t]===e},n.list=function(){return this._list},t}(ex);function mf(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function md(e,t){return (md=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var mp=function(e,t){return e.constructor.order-t.constructor.order},mm=[],m_=[],mv=function(){var e;return null!=(e=m_.pop())?e:[]},mg=function(e){e.length=0,m_.push(e);},my=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return void 0===n&&(n=A),(i=e.call(this,t)||this).c={},i._destroying=false,i._guid=null,i._template=false,i._app=n,i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&md(t,e);var n=t.prototype;return n.addComponent=function(e,t){var n=this._app.systems[e];return !n||this.c[e]?null:n.addComponent(this,t)},n.removeComponent=function(e){var t=this._app.systems[e];t&&this.c[e]&&t.removeComponent(this);},n.findComponent=function(e){var t=this.findOne(function(t){var n;return null==(n=t.c)?void 0:n[e]});return t&&t.c[e]},n.findComponents=function(e){return this.find(function(t){var n;return null==(n=t.c)?void 0:n[e]}).map(function(t){return t.c[e]})},n.findScript=function(e){var t=this.findOne(function(t){var n,i;return null==(i=t.c)||null==(n=i.script)?void 0:n.has(e)});return null==t?void 0:t.c.script.get(e)},n.findScripts=function(e){return this.find(function(t){var n,i;return null==(i=t.c)||null==(n=i.script)?void 0:n.has(e)}).map(function(t){return t.c.script.get(e)})},n.getGuid=function(){return this._guid||this.setGuid(et.create()),this._guid},n.setGuid=function(e){var t=this._app._entityIndex;this._guid&&delete t[this._guid],this._guid=e,t[this._guid]=this;},n._notifyHierarchyStateChanged=function(e,t){var n=false;e===this&&0===mm.length&&(n=true),e._beingEnabled=true,e._onHierarchyStateChanged(t),e._onHierarchyStatePostChanged&&mm.push(e);for(var i=e._children,r=0,s=i.length;r<s;r++)i[r]._enabled&&this._notifyHierarchyStateChanged(i[r],t);if(e._beingEnabled=false,n){for(var a=0;a<mm.length;a++)mm[a]._onHierarchyStatePostChanged();mm.length=0;}},n._onHierarchyStateChanged=function(t){e.prototype._onHierarchyStateChanged.call(this,t);for(var n=this._getSortedComponents(),i=0;i<n.length;i++){var r=n[i];r.enabled&&(t?r.onEnable():r.onDisable());}mg(n);},n._onHierarchyStatePostChanged=function(){for(var e=this._getSortedComponents(),t=0;t<e.length;t++)e[t].onPostStateChange();mg(e);},n.findByGuid=function(e){if(this._guid===e)return this;var t=this._app._entityIndex[e];return t&&(t===this||t.isDescendantOf(this))?t:null},n.destroy=function(){for(var t in this._destroying=true,this.c)this.c[t].enabled=false;for(var n in this.c)this.c[n].system.removeComponent(this);e.prototype.destroy.call(this),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=false;},n.clone=function(){var e={},t=this._cloneRecursively(e);return e[this.getGuid()]=t,function e(t,n,i,r){if(mf(n,my)){var s=n.c;for(var a in s)for(var o=s[a],l=o.system.getPropertiesOfType("entity"),u=0,c=l.length;u<c;u++){var h=l[u].name,f=o[h];if(t.findByGuid(f)){var d=r[f].getGuid();d&&(i.c[a][h]=d);}}s.script&&i.script.resolveDuplicatedEntityReferenceProperties(s.script,r),s.render&&i.render.resolveDuplicatedEntityReferenceProperties(s.render,r),s.button&&i.button.resolveDuplicatedEntityReferenceProperties(s.button,r),s.scrollview&&i.scrollview.resolveDuplicatedEntityReferenceProperties(s.scrollview,r),s.scrollbar&&i.scrollbar.resolveDuplicatedEntityReferenceProperties(s.scrollbar,r),s.anim&&i.anim.resolveDuplicatedEntityReferenceProperties(s.anim,r);for(var p=n.children.filter(function(e){return mf(e,my)}),m=i.children.filter(function(e){return mf(e,my)}),_=0,v=p.length;_<v;_++)e(t,p[_],m[_],r);}}(this,this,t,e),t},n._getSortedComponents=function(){var e=this.c,t=mv(),n=0;for(var i in e)if(e.hasOwnProperty(i)){var r=e[i];n|=0!==r.constructor.order,t.push(r);}return n&&t.length>1&&t.sort(mp),t},n._cloneRecursively=function(n){var i=new this.constructor(void 0,this._app);for(var r in e.prototype._cloneInternal.call(this,i),this.c)this.c[r].system.cloneComponent(this,i);for(var s=0;s<this._children.length;s++){var a=this._children[s];if(mf(a,t)){var o=a._cloneRecursively(n);i.addChild(o),n[a.getGuid()]=o;}}return i},t}(us);my.EVENT_DESTROY="destroy";var mS=function(){var e;function t(e,t){this.data=null,this._loading=false,this._onLoadedCallbacks=[],this.name=e,this.url=t;}return e=[{key:"loaded",get:function(){return !!this.data}},{key:"loading",get:function(){return this._loading}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}(),mx=function(){function e(e){this._list=[],this._index={},this._urlIndex={},this._app=e;}var t=e.prototype;return t.destroy=function(){this._app=null;},t.list=function(){return this._list},t.add=function(e,t){if(this._index.hasOwnProperty(e))return  false;var n=new mS(e,t),i=this._list.push(n);return this._index[n.name]=i-1,this._urlIndex[n.url]=i-1,true},t.find=function(e){return this._index.hasOwnProperty(e)?this._list[this._index[e]]:null},t.findByUrl=function(e){return this._urlIndex.hasOwnProperty(e)?this._list[this._urlIndex[e]]:null},t.remove=function(e){if(this._index.hasOwnProperty(e)){var t=this._index[e],n=this._list[t];delete this._urlIndex[n.url],delete this._index[e],this._list.splice(t,1);for(var i=0;i<this._list.length;i++)n=this._list[i],this._index[n.name]=i,this._urlIndex[n.url]=i;}},t._loadSceneData=function(e,t,n){var i=this._app,r=e;return ("string"==typeof e&&(e=this.findByUrl(r)||this.find(r)||new mS("Untitled",r)),r=e.url)?e.loaded?void n(null,e):void(i.assets&&i.assets.prefix&&!pW.test(r)&&(r=en.join(i.assets.prefix,r)),e._onLoadedCallbacks.push(n),!e._loading&&i.loader.getHandler("hierarchy").load(r,function(n,i){e.data=i,e._loading=false;for(var r=0;r<e._onLoadedCallbacks.length;r++)e._onLoadedCallbacks[r](n,e);t||(e.data=null),e._onLoadedCallbacks.length=0;}),e._loading=true):void n("Cannot find scene to load")},t.loadSceneData=function(e,t){this._loadSceneData(e,true,t);},t.unloadSceneData=function(e){"string"==typeof e&&(e=this.findByUrl(e)),e&&(e.data=null);},t._loadSceneHierarchy=function(e,t,n){var i=this;this._loadSceneData(e,false,function(e,r){if(e){n&&n(e);return}t&&t(r);var s=i._app;s._preloadScripts(r.data,function(){var e=s.loader.getHandler("hierarchy");s.systems.script.preloading=true;var t=e.open(r.url,r.data);s.systems.script.preloading=false,s.loader.clearCache(r.url,"hierarchy"),s.root.addChild(t),s.systems.fire("initialize",t),s.systems.fire("postInitialize",t),s.systems.fire("postPostInitialize",t),n&&n(null,t);});});},t.loadSceneHierarchy=function(e,t){this._loadSceneHierarchy(e,null,t);},t.loadSceneSettings=function(e,t){var n=this;this._loadSceneData(e,false,function(e,i){e?t&&t(e):(n._app.applySceneSettings(i.data.settings),t&&t(null));});},t.changeScene=function(e,t){var n=this._app;this._loadSceneHierarchy(e,function(e){for(var t=n.root.children;t.length;)t[0].destroy();n.applySceneSettings(e.data.settings);},t);},t.loadScene=function(e,t){var n=this,i=this._app,r=i.loader.getHandler("scene");i.assets&&i.assets.prefix&&!pW.test(e)&&(e=en.join(i.assets.prefix,e)),r.load(e,function(s,a){s?t&&t(s):i._preloadScripts(a,function(){i.systems.script.preloading=true;var s=r.open(e,a),o=n.findByUrl(e);o&&!o.loaded&&(o.data=a),i.systems.script.preloading=false,i.loader.clearCache(e,"scene"),i.loader.patch({resource:s,type:"scene"},i.assets),i.root.addChild(s.root),i.systems.rigidbody&&"undefined"!=typeof Ammo&&i.systems.rigidbody.gravity.set(s._gravity.x,s._gravity.y,s._gravity.z),t&&t(null,s);});});},e}(),mb=function(){var e;function t(e){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=e._shaderStats,this.vram=e._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}});}return e=[{key:"scene",get:function(){return A.scene._stats}},{key:"lightmapper",get:function(){var e;return null==(e=A.lightmapper)?void 0:e.stats}},{key:"batcher",get:function(){var e=A._batcher;return e?e._stats:null}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}(),mT={alphaTestPS:"\nuniform float alpha_ref;\nvoid alphaTest(float a) {\n	if (a < alpha_ref) discard;\n}\n",ambientPS:'\n#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH\n	uniform vec3 ambientSH[9];\n#endif\n#if LIT_AMBIENT_SOURCE == ENVALATLAS\n	#include "envAtlasPS"\n	#ifndef ENV_ATLAS\n	#define ENV_ATLAS\n		uniform sampler2D texture_envAtlas;\n	#endif\n#endif\nvoid addAmbient(vec3 worldNormal) {\n	#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH\n		vec3 n = cubeMapRotate(worldNormal);\n		vec3 color =\n			ambientSH[0] +\n			ambientSH[1] * n.x +\n			ambientSH[2] * n.y +\n			ambientSH[3] * n.z +\n			ambientSH[4] * n.x * n.z +\n			ambientSH[5] * n.z * n.y +\n			ambientSH[6] * n.y * n.x +\n			ambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n			ambientSH[8] * (n.x * n.x - n.y * n.y);\n		dDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n	#endif\n	#if LIT_AMBIENT_SOURCE == ENVALATLAS\n		vec3 dir = normalize(cubeMapRotate(worldNormal) * vec3(-1.0, 1.0, 1.0));\n		vec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);\n		vec4 raw = texture2D(texture_envAtlas, uv);\n		vec3 linear = {ambientDecode}(raw);\n		dDiffuseLight += processEnvironment(linear);\n	#endif\n	#if LIT_AMBIENT_SOURCE == CONSTANT\n		dDiffuseLight += light_globalAmbient;\n	#endif\n}\n',anisotropyPS:"\n#ifdef LIT_GGX_SPECULAR\n	uniform float material_anisotropyIntensity;\n	uniform vec2 material_anisotropyRotation;\n#endif\nvoid getAnisotropy() {\n	dAnisotropy = 0.0;\n	dAnisotropyRotation = vec2(1.0, 0.0);\n#ifdef LIT_GGX_SPECULAR\n	dAnisotropy = material_anisotropyIntensity;\n	dAnisotropyRotation = material_anisotropyRotation;\n#endif\n	#ifdef STD_ANISOTROPY_TEXTURE\n	vec3 anisotropyTex = texture2DBias({STD_ANISOTROPY_TEXTURE_NAME}, {STD_ANISOTROPY_TEXTURE_UV}, textureBias).rgb;\n	dAnisotropy *= anisotropyTex.b;\n	vec2 anisotropyRotationFromTex = anisotropyTex.rg * 2.0 - vec2(1.0);\n	mat2 rotationMatrix = mat2(dAnisotropyRotation.x, dAnisotropyRotation.y, -dAnisotropyRotation.y, dAnisotropyRotation.x);\n	dAnisotropyRotation = rotationMatrix * anisotropyRotationFromTex;\n	#endif\n	\n	dAnisotropy = clamp(dAnisotropy, 0.0, 1.0);\n}\n",aoPS:'\n#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)\n	uniform float material_aoIntensity;\n#endif\n#ifdef STD_AODETAIL_TEXTURE\n	#include "detailModesPS"\n#endif\nvoid getAO() {\n	dAo = 1.0;\n	#ifdef STD_AO_TEXTURE\n		float aoBase = texture2DBias({STD_AO_TEXTURE_NAME}, {STD_AO_TEXTURE_UV}, textureBias).{STD_AO_TEXTURE_CHANNEL};\n		#ifdef STD_AODETAIL_TEXTURE\n			float aoDetail = texture2DBias({STD_AODETAIL_TEXTURE_NAME}, {STD_AODETAIL_TEXTURE_UV}, textureBias).{STD_AODETAIL_TEXTURE_CHANNEL};\n			aoBase = detailMode_{STD_AODETAIL_DETAILMODE}(vec3(aoBase), vec3(aoDetail)).r;\n		#endif\n		dAo *= aoBase;\n	#endif\n	#ifdef STD_AO_VERTEX\n		dAo *= saturate(vVertexColor.{STD_AO_VERTEX_CHANNEL});\n	#endif\n	#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)\n		dAo = mix(1.0, dAo, material_aoIntensity);\n	#endif\n}\n',aoDiffuseOccPS:"\nvoid occludeDiffuse(float ao) {\n	dDiffuseLight *= ao;\n}\n",aoSpecOccPS:"\n#if LIT_OCCLUDE_SPECULAR != NONE\n	#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n		uniform float material_occludeSpecularIntensity;\n	#endif\n#endif\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n	#if LIT_OCCLUDE_SPECULAR == AO\n		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n			float specOcc = mix(1.0, ao, material_occludeSpecularIntensity);\n		#else\n			float specOcc = ao;\n		#endif\n	#endif\n	#if LIT_OCCLUDE_SPECULAR == GLOSSDEPENDENT\n		float specPow = exp2(gloss * 11.0);\n		float specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01 * specPow) - 1.0 + ao);\n		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n			specOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n		#endif\n	#endif\n	#if LIT_OCCLUDE_SPECULAR != NONE\n		dSpecularLight *= specOcc;\n		dReflection *= specOcc;\n		#ifdef LIT_SHEEN\n			sSpecularLight *= specOcc;\n			sReflection *= specOcc;\n		#endif\n	#endif\n}\n",bakeDirLmEndPS:"\n	vec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n	if (bakeDir > 0.5) {\n		if (dAtten > 0.00001) {\n			dirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n			dAtten = saturate(dAtten);\n			gl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n			gl_FragColor.a = dirLm.w + dAtten;\n			gl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n		} else {\n			gl_FragColor = dirLm;\n		}\n	} else {\n		gl_FragColor.rgb = dirLm.xyz;\n		gl_FragColor.a = max(dirLm.w, dAtten > 0.00001 ? (1.0/255.0) : 0.0);\n	}\n",bakeLmEndPS:"\n#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT\n	dDiffuseLight = ((dDiffuseLight - 0.5) * max(ambientBakeOcclusionContrast + 1.0, 0.0)) + 0.5;\n	dDiffuseLight += vec3(ambientBakeOcclusionBrightness);\n	dDiffuseLight = saturate(dDiffuseLight);\n	dDiffuseLight *= dAmbientLight;\n#endif\n#ifdef LIGHTMAP_RGBM\n	gl_FragColor.rgb = dDiffuseLight;\n	gl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\n	gl_FragColor.rgb /= 8.0;\n	gl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\n	gl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\n	gl_FragColor.rgb /= gl_FragColor.a;\n#else\n	gl_FragColor = vec4(dDiffuseLight, 1.0);\n#endif\n",basePS:"\nuniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n	return x*x;\n}\nfloat saturate(float x) {\n	return clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n	return clamp(x, vec3(0.0), vec3(1.0));\n}\n",baseNineSlicedPS:"\n#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",baseNineSlicedTiledPS:"\n#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",bayerPS:"\nfloat bayer2(vec2 p) {\n	return mod(2.0 * p.y + p.x + 1.0, 4.0);\n}\nfloat bayer4(vec2 p) {\n	vec2 p1 = mod(p, 2.0);\n	vec2 p2 = floor(0.5 * mod(p, 4.0));\n	return 4.0 * bayer2(p1) + bayer2(p2);\n}\nfloat bayer8(vec2 p) {\n	vec2 p1 = mod(p, 2.0);\n	vec2 p2 = floor(0.5 * mod(p, 4.0));\n	vec2 p4 = floor(0.25 * mod(p, 8.0));\n	return 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);\n}\n",blurVSMPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\n	uniform float weight[{SAMPLES}];\n#endif\nvoid main(void) {\n	vec3 moments = vec3(0.0);\n	vec2 uv = vUv0 - pixelOffset * (float({SAMPLES}) * 0.5);\n	for (int i = 0; i < {SAMPLES}; i++) {\n		vec4 c = texture2D(source, uv + pixelOffset * float(i));\n		#ifdef GAUSS\n			moments += c.xyz * weight[i];\n		#else\n			moments += c.xyz;\n		#endif\n	}\n	#ifndef GAUSS\n		moments *= 1.0 / float({SAMPLES});\n	#endif\n	gl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n}\n",clearCoatPS:"\nuniform float material_clearCoat;\nvoid getClearCoat() {\n	ccSpecularity = material_clearCoat;\n	#ifdef STD_CLEARCOAT_TEXTURE\n	ccSpecularity *= texture2DBias({STD_CLEARCOAT_TEXTURE_NAME}, {STD_CLEARCOAT_TEXTURE_UV}, textureBias).{STD_CLEARCOAT_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_CLEARCOAT_VERTEX\n	ccSpecularity *= saturate(vVertexColor.{STD_CLEARCOAT_VERTEX_CHANNEL});\n	#endif\n}\n",clearCoatGlossPS:"\nuniform float material_clearCoatGloss;\nvoid getClearCoatGlossiness() {\n	ccGlossiness = material_clearCoatGloss;\n	#ifdef STD_CLEARCOATGLOSS_TEXTURE\n	ccGlossiness *= texture2DBias({STD_CLEARCOATGLOSS_TEXTURE_NAME}, {STD_CLEARCOATGLOSS_TEXTURE_UV}, textureBias).{STD_CLEARCOATGLOSS_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_CLEARCOATGLOSS_VERTEX\n	ccGlossiness *= saturate(vVertexColor.{STD_CLEARCOATGLOSS_VERTEX_CHANNEL});\n	#endif\n	#ifdef STD_CLEARCOATGLOSS_INVERT\n	ccGlossiness = 1.0 - ccGlossiness;\n	#endif\n	ccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"\n#ifdef STD_CLEARCOATNORMAL_TEXTURE\nuniform float material_clearCoatBumpiness;\n#endif\nvoid getClearCoatNormal() {\n#ifdef STD_CLEARCOATNORMAL_TEXTURE\n	vec3 normalMap = {STD_CLEARCOATNORMAL_TEXTURE_DECODE}(texture2DBias({STD_CLEARCOATNORMAL_TEXTURE_NAME}, {STD_CLEARCOATNORMAL_TEXTURE_UV}, textureBias));\n	normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness);\n	ccNormalW = normalize(dTBN * normalMap);\n#else\n	ccNormalW = dVertexNormalW;\n#endif\n}\n",clusteredLightCookiesPS:"\nvec3 _getCookieClustered(TEXTURE_ACCEPT(tex), vec2 uv, float intensity, vec4 cookieChannel) {\n	vec4 pixel = mix(vec4(1.0), texture2DLod(tex, uv, 0.0), intensity);\n	bool isRgb = dot(cookieChannel.rgb, vec3(1.0)) == 3.0;\n	return isRgb ? pixel.rgb : vec3(dot(pixel, cookieChannel));\n}\nvec3 getCookie2DClustered(TEXTURE_ACCEPT(tex), mat4 transform, vec3 worldPosition, float intensity, vec4 cookieChannel) {\n	vec4 projPos = transform * vec4(worldPosition, 1.0);\n	return _getCookieClustered(TEXTURE_PASS(tex), projPos.xy / projPos.w, intensity, cookieChannel);\n}\nvec3 getCookieCubeClustered(TEXTURE_ACCEPT(tex), vec3 dir, float intensity, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {\n	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n	return _getCookieClustered(TEXTURE_PASS(tex), uv, intensity, cookieChannel);\n}\n",clusteredLightShadowsPS:"\nvec3 _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n	vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n	projPos.xyz /= projPos.w;\n	return projPos.xyz;\n}\nvec3 getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams, vec3 normal) {\n	vec3 wPos = vPositionW + normal * shadowParams.y;\n	return _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvec3 normalOffsetPointShadow(vec4 shadowParams, vec3 lightPos, vec3 lightDir, vec3 lightDirNorm, vec3 normal) {\n	float distScale = length(lightDir);\n	vec3 wPos = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n	vec3 dir = wPos - lightPos;\n	return dir;\n}\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\nfloat getShadowOmniClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n	float shadowTextureResolution = shadowParams.x;\n	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n	return textureShadow(shadowMap, vec3(uv, shadowZ));\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF3)\nfloat getShadowOmniClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n	float shadowTextureResolution = shadowParams.x;\n	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n	vec3 shadowCoord = vec3(uv, shadowZ);\n	return getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF5)\nfloat getShadowOmniClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n	float shadowTextureResolution = shadowParams.x;\n	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n	vec3 shadowCoord = vec3(uv, shadowZ);\n	return getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\nfloat getShadowSpotClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n	return textureShadow(shadowMap, shadowCoord);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF3)\nfloat getShadowSpotClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n	return getShadowSpotPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF5)\nfloat getShadowSpotClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n	return getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n",clusteredLightUtilsPS:"\nvec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)\n{\n	vec3 vAbs = abs(dir);\n	float ma;\n	vec2 uv;\n	if (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {\n		faceIndex = dir.z < 0.0 ? 5.0 : 4.0;\n		ma = 0.5 / vAbs.z;\n		uv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);\n		tileOffset.x = 2.0;\n		tileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;\n	} else if(vAbs.y >= vAbs.x) {\n		faceIndex = dir.y < 0.0 ? 3.0 : 2.0;\n		ma = 0.5 / vAbs.y;\n		uv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);\n		tileOffset.x = 1.0;\n		tileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;\n	} else {\n		faceIndex = dir.x < 0.0 ? 1.0 : 0.0;\n		ma = 0.5 / vAbs.x;\n		uv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);\n		tileOffset.x = 0.0;\n		tileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;\n	}\n	return uv * ma + 0.5;\n}\nvec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {\n	float faceIndex;\n	vec2 tileOffset;\n	vec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);\n	float atlasFaceSize = omniAtlasViewport.z;\n	float tileSize = shadowTextureResolution * atlasFaceSize;\n	float offset = shadowEdgePixels / tileSize;\n	uv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);\n	uv *= atlasFaceSize;\n	uv += tileOffset * atlasFaceSize;\n	uv += omniAtlasViewport.xy;\n	return uv;\n}\n",clusteredLightPS:'\n#include "lightBufferDefinesPS"\n#include "clusteredLightUtilsPS"\n#ifdef CLUSTER_COOKIES\n	#include "clusteredLightCookiesPS"\n#endif\n#ifdef CLUSTER_SHADOWS\n	#include "clusteredLightShadowsPS"\n#endif\nuniform highp sampler2D clusterWorldTexture;\nuniform highp sampler2D lightsTexture;\n#ifdef CLUSTER_SHADOWS\n	uniform sampler2DShadow shadowAtlasTexture;\n#endif\n#ifdef CLUSTER_COOKIES\n	uniform sampler2D cookieAtlasTexture;\n#endif\nuniform int clusterMaxCells;\nuniform float clusterSkip;\nuniform vec3 clusterCellsCountByBoundsSize;\nuniform vec3 clusterTextureSize;\nuniform vec3 clusterBoundsMin;\nuniform vec3 clusterBoundsDelta;\nuniform vec3 clusterCellsDot;\nuniform vec3 clusterCellsMax;\nuniform vec2 shadowAtlasParams;\nstruct ClusterLightData {\n	uint flags;\n	vec3 halfWidth;\n	bool isSpot;\n	vec3 halfHeight;\n	int lightIndex;\n	vec3 position;\n	uint shape;\n	vec3 direction;\n	bool falloffModeLinear;\n	vec3 color;\n	float shadowIntensity;\n	vec3 omniAtlasViewport;\n	float range;\n	vec4 cookieChannelMask;\n	float biasesData;\n	float shadowBias;\n	float shadowNormalBias;\n	float anglesData;\n	float innerConeAngleCos;\n	float outerConeAngleCos;\n	float cookieIntensity;\n	bool isDynamic;\n	bool isLightmapped;\n};\nmat4 lightProjectionMatrix;\nvec4 sampleLightTextureF(const ClusterLightData clusterLightData, int index) {\n	return texelFetch(lightsTexture, ivec2(index, clusterLightData.lightIndex), 0);\n}\nvoid decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {\n	clusterLightData.lightIndex = int(lightIndex);\n	vec4 halfData = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_COLOR_ANGLES_BIAS});\n	clusterLightData.anglesData = halfData.z;\n	clusterLightData.biasesData = halfData.w;\n	vec2 colorRG = unpackHalf2x16(floatBitsToUint(halfData.x));\n	vec2 colorB_ = unpackHalf2x16(floatBitsToUint(halfData.y));\n	clusterLightData.color = vec3(colorRG, colorB_.x) * {LIGHT_COLOR_DIVIDER};\n	vec4 lightPosRange = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_POSITION_RANGE});\n	clusterLightData.position = lightPosRange.xyz;\n	clusterLightData.range = lightPosRange.w;\n	vec4 lightDir_Flags = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_DIRECTION_FLAGS});\n	clusterLightData.direction = lightDir_Flags.xyz;\n	clusterLightData.flags = floatBitsToUint(lightDir_Flags.w);\n	clusterLightData.isSpot = (clusterLightData.flags & (1u << 30u)) != 0u;\n	clusterLightData.shape = (clusterLightData.flags >> 28u) & 0x3u;\n	clusterLightData.falloffModeLinear = (clusterLightData.flags & (1u << 27u)) == 0u;\n	clusterLightData.shadowIntensity = float((clusterLightData.flags >> 0u) & 0xFFu) / 255.0;\n	clusterLightData.cookieIntensity = float((clusterLightData.flags >> 8u) & 0xFFu) / 255.0;\n	clusterLightData.isDynamic = (clusterLightData.flags & (1u << 22u)) != 0u;\n	clusterLightData.isLightmapped = (clusterLightData.flags & (1u << 21u)) != 0u;\n}\nvoid decodeClusterLightSpot(inout ClusterLightData clusterLightData) {\n	vec2 angles = unpackHalf2x16(floatBitsToUint(clusterLightData.anglesData));\n	clusterLightData.innerConeAngleCos = angles.x;\n	clusterLightData.outerConeAngleCos = angles.y;\n}\nvoid decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {\n	clusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_0}).xyz;\n}\nvoid decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {\n	clusterLightData.halfWidth = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_AREA_DATA_WIDTH}).xyz;\n	clusterLightData.halfHeight = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_AREA_DATA_HEIGHT}).xyz;\n}\nvoid decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {\n	\n	vec4 m0 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_0});\n	vec4 m1 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_1});\n	vec4 m2 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_2});\n	vec4 m3 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_3});\n	lightProjectionMatrix = mat4(m0, m1, m2, m3);\n}\nvoid decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {\n	\n	vec2 biases = unpackHalf2x16(floatBitsToUint(clusterLightData.biasesData));\n	clusterLightData.shadowBias = biases.x;\n	clusterLightData.shadowNormalBias = biases.y;\n}\nvoid decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {\n	uint cookieFlags = (clusterLightData.flags >> 23u) & 0x0Fu;\n	clusterLightData.cookieChannelMask = vec4(uvec4(cookieFlags) & uvec4(1u, 2u, 4u, 8u));\n	clusterLightData.cookieChannelMask = step(1.0, clusterLightData.cookieChannelMask);\n}\nvoid evaluateLight(\n	ClusterLightData light, \n	vec3 worldNormal, \n	vec3 viewDir, \n	vec3 reflectionDir,\n#if defined(LIT_CLEARCOAT)\n	vec3 clearcoatReflectionDir,\n#endif\n	float gloss, \n	vec3 specularity, \n	vec3 geometricNormal, \n	mat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n	vec3 iridescenceFresnel,\n#endif\n	vec3 clearcoat_worldNormal,\n	float clearcoat_gloss,\n	float sheen_gloss,\n	float iridescence_intensity\n) {\n	vec3 cookieAttenuation = vec3(1.0);\n	float diffuseAttenuation = 1.0;\n	float falloffAttenuation = 1.0;\n	vec3 lightDirW = evalOmniLight(light.position);\n	vec3 lightDirNormW = normalize(lightDirW);\n	#ifdef CLUSTER_AREALIGHTS\n	if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n		decodeClusterLightAreaData(light);\n		if (light.shape == {LIGHTSHAPE_RECT}) {\n			calcRectLightValues(light.position, light.halfWidth, light.halfHeight);\n		} else if (light.shape == {LIGHTSHAPE_DISK}) {\n			calcDiskLightValues(light.position, light.halfWidth, light.halfHeight);\n		} else {\n			calcSphereLightValues(light.position, light.halfWidth, light.halfHeight);\n		}\n		falloffAttenuation = getFalloffWindow(light.range, lightDirW);\n	} else\n	#endif\n	{\n		if (light.falloffModeLinear)\n			falloffAttenuation = getFalloffLinear(light.range, lightDirW);\n		else\n			falloffAttenuation = getFalloffInvSquared(light.range, lightDirW);\n	}\n	if (falloffAttenuation > 0.00001) {\n		#ifdef CLUSTER_AREALIGHTS\n		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n			if (light.shape == {LIGHTSHAPE_RECT}) {\n				diffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n			} else if (light.shape == {LIGHTSHAPE_DISK}) {\n				diffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n			} else {\n				diffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n			}\n		} else\n		#endif\n		{\n			falloffAttenuation *= getLightDiffuse(worldNormal, viewDir, lightDirNormW); \n		}\n		if (light.isSpot) {\n			decodeClusterLightSpot(light);\n			falloffAttenuation *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, lightDirNormW);\n		}\n		#if defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)\n		if (falloffAttenuation > 0.00001) {\n			if (light.shadowIntensity > 0.0 || light.cookieIntensity > 0.0) {\n				if (light.isSpot) {\n					decodeClusterLightProjectionMatrixData(light);\n				} else {\n					decodeClusterLightOmniAtlasViewport(light);\n				}\n				float shadowTextureResolution = shadowAtlasParams.x;\n				float shadowEdgePixels = shadowAtlasParams.y;\n				#ifdef CLUSTER_COOKIES\n				if (light.cookieIntensity > 0.0) {\n					decodeClusterLightCookieData(light);\n					if (light.isSpot) {\n						cookieAttenuation = getCookie2DClustered(TEXTURE_PASS(cookieAtlasTexture), lightProjectionMatrix, vPositionW, light.cookieIntensity, light.cookieChannelMask);\n					} else {\n						cookieAttenuation = getCookieCubeClustered(TEXTURE_PASS(cookieAtlasTexture), lightDirW, light.cookieIntensity, light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);\n					}\n				}\n				#endif\n				#ifdef CLUSTER_SHADOWS\n				if (light.shadowIntensity > 0.0) {\n					decodeClusterLightShadowData(light);\n					vec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);\n					if (light.isSpot) {\n						vec3 shadowCoord = getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);\n						\n						#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n							float shadow = getShadowSpotClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n							float shadow = getShadowSpotClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n							float shadow = getShadowSpotClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n						#elif defined(CLUSTER_SHADOW_TYPE_PCSS)\n							float shadow = getShadowSpotClusteredPCSS(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n						#endif\n						falloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);\n					} else {\n						vec3 dir = normalOffsetPointShadow(shadowParams, light.position, lightDirW, lightDirNormW, geometricNormal);\n						#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n							float shadow = getShadowOmniClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n							float shadow = getShadowOmniClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n							float shadow = getShadowOmniClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n						#endif\n						falloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);\n					}\n				}\n				#endif\n			}\n		}\n		#endif\n		#ifdef CLUSTER_AREALIGHTS\n		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n			{\n				vec3 areaDiffuse = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;\n				#if defined(LIT_SPECULAR)\n					areaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);\n				#endif\n				dDiffuseLight += areaDiffuse;\n			}\n			#ifdef LIT_SPECULAR\n				float areaLightSpecular;\n				if (light.shape == {LIGHTSHAPE_RECT}) {\n					areaLightSpecular = getRectLightSpecular(worldNormal, viewDir);\n				} else if (light.shape == {LIGHTSHAPE_DISK}) {\n					areaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);\n				} else {\n					areaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);\n				}\n				dSpecularLight += dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;\n				#ifdef LIT_CLEARCOAT\n					float areaLightSpecularCC;\n					if (light.shape == {LIGHTSHAPE_RECT}) {\n						areaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);\n					} else if (light.shape == {LIGHTSHAPE_DISK}) {\n						areaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);\n					} else {\n						areaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);\n					}\n					ccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;\n				#endif\n			#endif\n		} else\n		#endif\n		{\n			{\n				vec3 punctualDiffuse = falloffAttenuation * light.color * cookieAttenuation;\n				#if defined(CLUSTER_AREALIGHTS)\n				#if defined(LIT_SPECULAR)\n					punctualDiffuse = mix(punctualDiffuse, vec3(0), specularity);\n				#endif\n				#endif\n				dDiffuseLight += punctualDiffuse;\n			}\n   \n			#ifdef LIT_SPECULAR\n				vec3 halfDir = normalize(-lightDirNormW + viewDir);\n				\n				#ifdef LIT_SPECULAR_FRESNEL\n					dSpecularLight += \n						getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * \n						getFresnel(\n							dot(viewDir, halfDir), \n							gloss, \n							specularity\n						#if defined(LIT_IRIDESCENCE)\n							, iridescenceFresnel,\n							iridescence_intensity\n						#endif\n							);\n				#else\n					dSpecularLight += getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;\n				#endif\n				#ifdef LIT_CLEARCOAT\n					#ifdef LIT_SPECULAR_FRESNEL\n						ccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));\n					#else\n						ccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation; \n					#endif\n				#endif\n				#ifdef LIT_SHEEN\n					sSpecularLight += getLightSpecularSheen(halfDir, worldNormal, viewDir, lightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;\n				#endif\n			#endif\n		}\n	}\n	dAtten = falloffAttenuation;\n	dLightDirNormW = lightDirNormW;\n}\nvoid evaluateClusterLight(\n	float lightIndex, \n	vec3 worldNormal, \n	vec3 viewDir, \n	vec3 reflectionDir, \n#if defined(LIT_CLEARCOAT)\n	vec3 clearcoatReflectionDir,\n#endif\n	float gloss, \n	vec3 specularity, \n	vec3 geometricNormal, \n	mat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n	vec3 iridescenceFresnel,\n#endif\n	vec3 clearcoat_worldNormal,\n	float clearcoat_gloss,\n	float sheen_gloss,\n	float iridescence_intensity\n) {\n	ClusterLightData clusterLightData;\n	decodeClusterLightCore(clusterLightData, lightIndex);\n	#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS\n		bool acceptLightMask = clusterLightData.isDynamic;\n	#else\n		bool acceptLightMask = clusterLightData.isLightmapped;\n	#endif\n	if (acceptLightMask)\n		evaluateLight(\n			clusterLightData, \n			worldNormal, \n			viewDir, \n			reflectionDir, \n#if defined(LIT_CLEARCOAT)\n			clearcoatReflectionDir, \n#endif\n			gloss, \n			specularity, \n			geometricNormal, \n			tbn, \n#if defined(LIT_IRIDESCENCE)\n			iridescenceFresnel,\n#endif\n			clearcoat_worldNormal,\n			clearcoat_gloss,\n			sheen_gloss,\n			iridescence_intensity\n		);\n}\nvoid addClusteredLights(\n	vec3 worldNormal, \n	vec3 viewDir, \n	vec3 reflectionDir, \n#if defined(LIT_CLEARCOAT)\n	vec3 clearcoatReflectionDir,\n#endif\n	float gloss, \n	vec3 specularity, \n	vec3 geometricNormal, \n	mat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n	vec3 iridescenceFresnel,\n#endif\n	vec3 clearcoat_worldNormal,\n	float clearcoat_gloss,\n	float sheen_gloss,\n	float iridescence_intensity\n) {\n	if (clusterSkip > 0.5)\n		return;\n	vec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);\n	if (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {\n		float cellIndex = dot(clusterCellsDot, cellCoords);\n		float clusterV = floor(cellIndex * clusterTextureSize.y);\n		float clusterU = cellIndex - (clusterV * clusterTextureSize.x);\n		for (int lightCellIndex = 0; lightCellIndex < clusterMaxCells; lightCellIndex++) {\n			float lightIndex = texelFetch(clusterWorldTexture, ivec2(int(clusterU) + lightCellIndex, clusterV), 0).x;\n			if (lightIndex <= 0.0)\n				break;\n			evaluateClusterLight(\n				lightIndex * 255.0, \n				worldNormal, \n				viewDir, \n				reflectionDir,\n#if defined(LIT_CLEARCOAT)\n				clearcoatReflectionDir,\n#endif\n				gloss, \n				specularity, \n				geometricNormal, \n				tbn, \n#if defined(LIT_IRIDESCENCE)\n				iridescenceFresnel,\n#endif\n				clearcoat_worldNormal,\n				clearcoat_gloss,\n				sheen_gloss,\n				iridescence_intensity\n			); \n		}\n	}\n}\n',combinePS:"\nvec3 combineColor(vec3 albedo, vec3 sheenSpecularity, float clearcoatSpecularity) {\n	vec3 ret = vec3(0);\n#ifdef LIT_OLD_AMBIENT\n	ret += (dDiffuseLight - light_globalAmbient) * albedo + material_ambient * light_globalAmbient;\n#else\n	ret += albedo * dDiffuseLight;\n#endif\n#ifdef LIT_SPECULAR\n	ret += dSpecularLight;\n#endif\n#ifdef LIT_REFLECTIONS\n	ret += dReflection.rgb * dReflection.a;\n#endif\n#ifdef LIT_SHEEN\n	float sheenScaling = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;\n	ret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;\n#endif\n#ifdef LIT_CLEARCOAT\n	float clearCoatScaling = 1.0 - ccFresnel * clearcoatSpecularity;\n	ret = ret * clearCoatScaling + (ccSpecularLight + ccReflection) * clearcoatSpecularity;\n#endif\n	return ret;\n}\n",cookieBlit2DPS:"\n	varying vec2 uv0;\n	uniform sampler2D blitTexture;\n	void main(void) {\n		gl_FragColor = texture2D(blitTexture, uv0);\n	}\n",cookieBlitCubePS:"\n	varying vec2 uv0;\n	uniform samplerCube blitTexture;\n	uniform mat4 invViewProj;\n	void main(void) {\n		vec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);\n		vec4 worldPos = invViewProj * projPos;\n		gl_FragColor = textureCube(blitTexture, worldPos.xyz);\n	}\n",cookieBlitVS:"\n	attribute vec2 vertex_position;\n	varying vec2 uv0;\n	void main(void) {\n		gl_Position = vec4(vertex_position, 0.5, 1.0);\n		uv0 = vertex_position.xy * 0.5 + 0.5;\n		#ifndef WEBGPU\n			uv0.y = 1.0 - uv0.y;\n		#endif\n	}\n",cookiePS:"\nvec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n	vec4 projPos = transform * vec4(vPositionW, 1.0);\n	projPos.xy /= projPos.w;\n	return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n	vec4 projPos = transform * vec4(vPositionW, 1.0);\n	projPos.xy /= projPos.w;\n	if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n	return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n	vec4 projPos = transform * vec4(vPositionW, 1.0);\n	projPos.xy /= projPos.w;\n	projPos.xy += cookieOffset;\n	vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n	return mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n	vec4 projPos = transform * vec4(vPositionW, 1.0);\n	projPos.xy /= projPos.w;\n	projPos.xy += cookieOffset;\n	if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n	vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n	return mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n	return mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",cubeMapProjectPS:"\n#if LIT_CUBEMAP_PROJECTION == BOX\n	uniform vec3 envBoxMin;\n	uniform vec3 envBoxMax;\n#endif\nvec3 cubeMapProject(vec3 nrdir) {\n	#if LIT_CUBEMAP_PROJECTION == NONE\n		return cubeMapRotate(nrdir);\n	#endif\n	#if LIT_CUBEMAP_PROJECTION == BOX\n		nrdir = cubeMapRotate(nrdir);\n		vec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n		vec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n		vec3 rbminmax = mix(rbmin, rbmax, vec3(greaterThan(nrdir, vec3(0.0))));\n		float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n		vec3 posonbox = vPositionW + nrdir * fa;\n		vec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n		return normalize(posonbox - envBoxPos);\n	#endif\n}\n",cubeMapRotatePS:"\n#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvec3 cubeMapRotate(vec3 refDir) {\n#ifdef CUBEMAP_ROTATION\n	return refDir * cubeMapRotationMatrix;\n#else\n	return refDir;\n#endif\n}\n",debugOutputPS:"\n#ifdef DEBUG_ALBEDO_PASS\ngl_FragColor = vec4(gammaCorrectOutput(dAlbedo), 1.0);\n#endif\n#ifdef DEBUG_UV0_PASS\ngl_FragColor = vec4(litArgs_albedo , 1.0);\n#endif\n#ifdef DEBUG_WORLD_NORMAL_PASS\ngl_FragColor = vec4(litArgs_worldNormal * 0.5 + 0.5, 1.0);\n#endif\n#ifdef DEBUG_OPACITY_PASS\ngl_FragColor = vec4(vec3(litArgs_opacity) , 1.0);\n#endif\n#ifdef DEBUG_SPECULARITY_PASS\ngl_FragColor = vec4(litArgs_specularity, 1.0);\n#endif\n#ifdef DEBUG_GLOSS_PASS\ngl_FragColor = vec4(vec3(litArgs_gloss) , 1.0);\n#endif\n#ifdef DEBUG_METALNESS_PASS\ngl_FragColor = vec4(vec3(litArgs_metalness) , 1.0);\n#endif\n#ifdef DEBUG_AO_PASS\ngl_FragColor = vec4(vec3(litArgs_ao) , 1.0);\n#endif\n#ifdef DEBUG_EMISSION_PASS\ngl_FragColor = vec4(gammaCorrectOutput(litArgs_emission), 1.0);\n#endif\n",debugProcessFrontendPS:"\n#ifdef DEBUG_LIGHTING_PASS\nlitArgs_albedo = vec3(0.5);\n#endif\n#ifdef DEBUG_UV0_PASS\n#ifdef VARYING_VUV0\nlitArgs_albedo = vec3(vUv0, 0);\n#else\nlitArgs_albedo = vec3(0);\n#endif\n#endif\n",detailModesPS:"\n#ifndef _DETAILMODES_INCLUDED_\n#define _DETAILMODES_INCLUDED_\nvec3 detailMode_mul(vec3 c1, vec3 c2) {\n	return c1 * c2;\n}\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n	return c1 + c2;\n}\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n	return 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n	return mix(1.0 - 2.0 * (1.0 - c1)*(1.0 - c2), 2.0 * c1 * c2, step(c1, vec3(0.5)));\n}\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n	return min(c1, c2);\n}\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n	return max(c1, c2);\n}\n#endif\n",diffusePS:'\nuniform vec3 material_diffuse;\n#ifdef STD_DIFFUSEDETAIL_TEXTURE\n	#include "detailModesPS"\n#endif\nvoid getAlbedo() {\n	dAlbedo = material_diffuse.rgb;\n	#ifdef STD_DIFFUSE_TEXTURE\n		vec3 albedoTexture = {STD_DIFFUSE_TEXTURE_DECODE}(texture2DBias({STD_DIFFUSE_TEXTURE_NAME}, {STD_DIFFUSE_TEXTURE_UV}, textureBias)).{STD_DIFFUSE_TEXTURE_CHANNEL};\n		#ifdef STD_DIFFUSEDETAIL_TEXTURE\n			vec3 albedoDetail = {STD_DIFFUSEDETAIL_TEXTURE_DECODE}(texture2DBias({STD_DIFFUSEDETAIL_TEXTURE_NAME}, {STD_DIFFUSEDETAIL_TEXTURE_UV}, textureBias)).{STD_DIFFUSEDETAIL_TEXTURE_CHANNEL};\n			albedoTexture = detailMode_{STD_DIFFUSEDETAIL_DETAILMODE}(albedoTexture, albedoDetail);\n		#endif\n		dAlbedo *= albedoTexture;\n	#endif\n	#ifdef STD_DIFFUSE_VERTEX\n		dAlbedo *= gammaCorrectInput(saturate(vVertexColor.{STD_DIFFUSE_VERTEX_CHANNEL}));\n	#endif\n}\n',decodePS:"\n#ifndef _DECODE_INCLUDED_\n#define _DECODE_INCLUDED_\nvec3 decodeLinear(vec4 raw) {\n	return raw.rgb;\n}\nfloat decodeGamma(float raw) {\n	return pow(raw, 2.2);\n}\nvec3 decodeGamma(vec3 raw) {\n	return pow(raw, vec3(2.2));\n}\nvec3 decodeGamma(vec4 raw) {\n	return pow(raw.xyz, vec3(2.2));\n}\nvec3 decodeRGBM(vec4 raw) {\n	vec3 color = (8.0 * raw.a) * raw.rgb;\n	return color * color;\n}\nvec3 decodeRGBP(vec4 raw) {\n	vec3 color = raw.rgb * (-raw.a * 7.0 + 8.0);\n	return color * color;\n}\nvec3 decodeRGBE(vec4 raw) {\n	if (raw.a == 0.0) {\n		return vec3(0.0, 0.0, 0.0);\n	} else {\n		return raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);\n	}\n}\nvec4 passThrough(vec4 raw) {\n	return raw;\n}\nvec3 unpackNormalXYZ(vec4 nmap) {\n	return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackNormalXY(vec4 nmap) {\n	vec3 normal;\n	normal.xy = nmap.wy * 2.0 - 1.0;\n	normal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));\n	return normal;\n}\n#endif\n",emissivePS:"\nuniform vec3 material_emissive;\nuniform float material_emissiveIntensity;\nvoid getEmission() {\n	dEmission = material_emissive * material_emissiveIntensity;\n	#ifdef STD_EMISSIVE_TEXTURE\n	dEmission *= {STD_EMISSIVE_TEXTURE_DECODE}(texture2DBias({STD_EMISSIVE_TEXTURE_NAME}, {STD_EMISSIVE_TEXTURE_UV}, textureBias)).{STD_EMISSIVE_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_EMISSIVE_VERTEX\n	dEmission *= gammaCorrectInput(saturate(vVertexColor.{STD_EMISSIVE_VERTEX_CHANNEL}));\n	#endif\n}\n",encodePS:"\nvec4 encodeLinear(vec3 source) {\n	return vec4(source, 1.0);\n}\nvec4 encodeGamma(vec3 source) {\n	return vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\nvec4 encodeRGBM(vec3 source) {\n	vec4 result;\n	result.rgb = pow(source.rgb, vec3(0.5));\n	result.rgb *= 1.0 / 8.0;\n	result.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n	result.a = ceil(result.a * 255.0) / 255.0;\n	result.rgb /= result.a;\n	return result;\n}\nvec4 encodeRGBP(vec3 source) {\n	vec3 gamma = pow(source, vec3(0.5));\n	float maxVal = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));\n	float v = 1.0 - ((maxVal - 1.0) / 7.0);\n	v = ceil(v * 255.0) / 255.0;\n	return vec4(gamma / (-v * 7.0 + 8.0), v);	\n}\nvec4 encodeRGBE(vec3 source) {\n	float maxVal = max(source.x, max(source.y, source.z));\n	if (maxVal < 1e-32) {\n		return vec4(0, 0, 0, 0);\n	} else {\n		float e = ceil(log2(maxVal));\n		return vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n	}\n}\n",endPS:"\n	gl_FragColor.rgb = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);\n	gl_FragColor.rgb += litArgs_emission;\n	gl_FragColor.rgb = addFog(gl_FragColor.rgb);\n	gl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n	gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n",envAtlasPS:"\n#ifndef _ENVATLAS_INCLUDED_\n#define _ENVATLAS_INCLUDED_\nconst float atlasSize = 512.0;\nconst float seamSize = 1.0 / atlasSize;\nvec2 mapUv(vec2 uv, vec4 rect) {\n	return vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),\n				mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));\n}\nvec2 mapRoughnessUv(vec2 uv, float level) {\n	float t = 1.0 / exp2(level);\n	return mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));\n}\nvec2 mapShinyUv(vec2 uv, float level) {\n	float t = 1.0 / exp2(level);\n	return mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));\n}\n#endif\n",envProcPS:"\n#ifdef LIT_SKYBOX_INTENSITY\n	uniform float skyboxIntensity;\n#endif\nvec3 processEnvironment(vec3 color) {\n	#ifdef LIT_SKYBOX_INTENSITY\n		return color * skyboxIntensity;\n	#else\n		return color;\n	#endif\n}\n",falloffInvSquaredPS:"\nfloat getFalloffWindow(float lightRadius, vec3 lightDir) {\n	float sqrDist = dot(lightDir, lightDir);\n	float invRadius = 1.0 / lightRadius;\n	return square(saturate(1.0 - square(sqrDist * square(invRadius))));\n}\nfloat getFalloffInvSquared(float lightRadius, vec3 lightDir) {\n	float sqrDist = dot(lightDir, lightDir);\n	float falloff = 1.0 / (sqrDist + 1.0);\n	float invRadius = 1.0 / lightRadius;\n	falloff *= 16.0;\n	falloff *= square(saturate(1.0 - square(sqrDist * square(invRadius))));\n	return falloff;\n}\n",falloffLinearPS:"\nfloat getFalloffLinear(float lightRadius, vec3 lightDir) {\n	float d = length(lightDir);\n	return max(((lightRadius - d) / lightRadius), 0.0);\n}\n",floatAsUintPS:"\n#ifndef FLOAT_AS_UINT\n#define FLOAT_AS_UINT\nvec4 float2uint(float value) {\n	uint intBits = floatBitsToUint(value);\n	return vec4(\n		float((intBits >> 24u) & 0xFFu) / 255.0,\n		float((intBits >> 16u) & 0xFFu) / 255.0,\n		float((intBits >> 8u) & 0xFFu) / 255.0,\n		float(intBits & 0xFFu) / 255.0\n	);\n}\nfloat uint2float(vec4 value) {\n	uint intBits = \n		(uint(value.r * 255.0) << 24u) |\n		(uint(value.g * 255.0) << 16u) |\n		(uint(value.b * 255.0) << 8u) |\n		uint(value.a * 255.0);\n	return uintBitsToFloat(intBits);\n}\nvec4 float2vec4(float value) {\n	#if defined(CAPS_TEXTURE_FLOAT_RENDERABLE)\n		return vec4(value, 1.0, 1.0, 1.0);\n	#else\n		return float2uint(value);\n	#endif\n}\n#endif\n",fogPS:"\nfloat dBlendModeFogFactor = 1.0;\n#if (FOG != NONE)\n	uniform vec3 fog_color;\n	#if (FOG == LINEAR)\n		uniform float fog_start;\n		uniform float fog_end;\n	#else\n		uniform float fog_density;\n	#endif\n#endif\nfloat getFogFactor() {\n	float depth = gl_FragCoord.z / gl_FragCoord.w;\n	float fogFactor = 0.0;\n	#if (FOG == LINEAR)\n		fogFactor = (fog_end - depth) / (fog_end - fog_start);\n	#elif (FOG == EXP)\n		fogFactor = exp(-depth * fog_density);\n	#elif (FOG == EXP2)\n		fogFactor = exp(-depth * depth * fog_density * fog_density);\n	#endif\n	return clamp(fogFactor, 0.0, 1.0);\n}\nvec3 addFog(vec3 color) {\n	#if (FOG != NONE)\n		return mix(fog_color * dBlendModeFogFactor, color, getFogFactor());\n	#endif\n	return color;\n}\n",fresnelSchlickPS:"\nvec3 getFresnel(\n		float cosTheta, \n		float gloss, \n		vec3 specularity\n#if defined(LIT_IRIDESCENCE)\n		, vec3 iridescenceFresnel, \n		float iridescenceIntensity\n#endif\n	) {\n	float fresnel = pow(1.0 - saturate(cosTheta), 5.0);\n	float glossSq = gloss * gloss;\n	vec3 ret = specularity + (max(vec3(glossSq), specularity) - specularity) * fresnel;\n#if defined(LIT_IRIDESCENCE)\n	return mix(ret, iridescenceFresnel, iridescenceIntensity);\n#else\n	return ret;\n#endif	\n}\nfloat getFresnelCC(float cosTheta) {\n	float fresnel = pow(1.0 - saturate(cosTheta), 5.0);\n	return 0.04 + (1.0 - 0.04) * fresnel;\n}\n",frontendCodePS:"",frontendDeclPS:"",fullscreenQuadVS:"\nattribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n	gl_Position = vec4(vertex_position, 0.5, 1.0);\n	vUv0 = vertex_position.xy * 0.5 + 0.5;\n}\n",gammaPS:'\n#include "decodePS"\n#if (GAMMA == SRGB)\n	float gammaCorrectInput(float color) {\n		return decodeGamma(color);\n	}\n	vec3 gammaCorrectInput(vec3 color) {\n		return decodeGamma(color);\n	}\n	vec4 gammaCorrectInput(vec4 color) {\n		return vec4(decodeGamma(color.xyz), color.w);\n	}\n	vec3 gammaCorrectOutput(vec3 color) {\n		return pow(color + 0.0000001, vec3(1.0 / 2.2));\n	}\n#else\n	float gammaCorrectInput(float color) {\n		return color;\n	}\n	vec3 gammaCorrectInput(vec3 color) {\n		return color;\n	}\n	vec4 gammaCorrectInput(vec4 color) {\n		return color;\n	}\n	vec3 gammaCorrectOutput(vec3 color) {\n		return color;\n	}\n#endif\n',gles3PS:rH,gles3VS:rW,glossPS:"\n#ifdef STD_GLOSS_CONSTANT\nuniform float material_gloss;\n#endif\nvoid getGlossiness() {\n	dGlossiness = 1.0;\n	#ifdef STD_GLOSS_CONSTANT\n	dGlossiness *= material_gloss;\n	#endif\n	#ifdef STD_GLOSS_TEXTURE\n	dGlossiness *= texture2DBias({STD_GLOSS_TEXTURE_NAME}, {STD_GLOSS_TEXTURE_UV}, textureBias).{STD_GLOSS_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_GLOSS_VERTEX\n	dGlossiness *= saturate(vVertexColor.{STD_GLOSS_VERTEX_CHANNEL});\n	#endif\n	#ifdef STD_GLOSS_INVERT\n	dGlossiness = 1.0 - dGlossiness;\n	#endif\n	dGlossiness += 0.0000001;\n}\n",gsplatCenterVS:"\nuniform mat4 matrix_model;\nuniform mat4 matrix_view;\n#ifndef GSPLAT_CENTER_NOPROJ\n	uniform mat4 matrix_projection;\n#endif\nbool initCenter(vec3 modelCenter, out SplatCenter center) {\n	mat4 modelView = matrix_view * matrix_model;\n	vec4 centerView = modelView * vec4(modelCenter, 1.0);\n	#ifndef GSPLAT_CENTER_NOPROJ\n		if (centerView.z > 0.0) {\n			return false;\n		}\n		vec4 centerProj = matrix_projection * centerView;\n		#if WEBGPU\n			centerProj.z = clamp(centerProj.z, 0, abs(centerProj.w));\n		#else\n			centerProj.z = clamp(centerProj.z, -abs(centerProj.w), abs(centerProj.w));\n		#endif\n		center.proj = centerProj;\n		center.projMat00 = matrix_projection[0][0];\n	#endif\n	center.view = centerView.xyz / centerView.w;\n	center.modelView = modelView;\n	return true;\n}\n",gsplatCornerVS:"\nuniform vec2 viewport;\nuniform vec4 camera_params;\nbool initCornerCov(SplatSource source, SplatCenter center, out SplatCorner corner, vec3 covA, vec3 covB) {\n	mat3 Vrk = mat3(\n		covA.x, covA.y, covA.z, \n		covA.y, covB.x, covB.y,\n		covA.z, covB.y, covB.z\n	);\n	float focal = viewport.x * center.projMat00;\n	vec3 v = camera_params.w == 1.0 ? vec3(0.0, 0.0, 1.0) : center.view.xyz;\n	float J1 = focal / v.z;\n	vec2 J2 = -J1 / v.z * v.xy;\n	mat3 J = mat3(\n		J1, 0.0, J2.x, \n		0.0, J1, J2.y, \n		0.0, 0.0, 0.0\n	);\n	mat3 W = transpose(mat3(center.modelView));\n	mat3 T = W * J;\n	mat3 cov = transpose(T) * Vrk * T;\n	#if GSPLAT_AA\n		float detOrig = cov[0][0] * cov[1][1] - cov[0][1] * cov[0][1];\n		float detBlur = (cov[0][0] + 0.3) * (cov[1][1] + 0.3) - cov[0][1] * cov[0][1];\n		corner.aaFactor = sqrt(max(detOrig / detBlur, 0.0));\n	#endif\n	float diagonal1 = cov[0][0] + 0.3;\n	float offDiagonal = cov[0][1];\n	float diagonal2 = cov[1][1] + 0.3;\n	float mid = 0.5 * (diagonal1 + diagonal2);\n	float radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));\n	float lambda1 = mid + radius;\n	float lambda2 = max(mid - radius, 0.1);\n	float vmin = min(1024.0, min(viewport.x, viewport.y));\n	float l1 = 2.0 * min(sqrt(2.0 * lambda1), vmin);\n	float l2 = 2.0 * min(sqrt(2.0 * lambda2), vmin);\n	if (l1 < 2.0 && l2 < 2.0) {\n		return false;\n	}\n	vec2 c = center.proj.ww / viewport;\n	if (any(greaterThan(abs(center.proj.xy) - vec2(max(l1, l2)) * c, center.proj.ww))) {\n		return false;\n	}\n	vec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));\n	vec2 v1 = l1 * diagonalVector;\n	vec2 v2 = l2 * vec2(diagonalVector.y, -diagonalVector.x);\n	corner.offset = (source.cornerUV.x * v1 + source.cornerUV.y * v2) * c;\n	corner.uv = source.cornerUV;\n	return true;\n}\nbool initCorner(SplatSource source, SplatCenter center, out SplatCorner corner) {\n	vec3 covA, covB;\n	readCovariance(source, covA, covB);\n	return initCornerCov(source, center, corner, covA, covB);\n}\n",gsplatColorVS:"\nuniform mediump sampler2D splatColor;\nvec4 readColor(in SplatSource source) {\n	return texelFetch(splatColor, source.uv, 0);\n}\n",gsplatCommonVS:'\n#include "gsplatStructsVS"\n#include "gsplatEvalSHVS"\n#include "gsplatQuatToMat3VS"\n#include "gsplatSourceFormatVS"\n#include "gsplatSourceVS"\n#include "gsplatCenterVS"\n#include "gsplatCornerVS"\n#include "gsplatOutputVS"\nvoid clipCorner(inout SplatCorner corner, float alpha) {\n	float clip = min(1.0, sqrt(-log(1.0 / 255.0 / alpha)) / 2.0);\n	corner.offset *= clip;\n	corner.uv *= clip;\n}\n',gsplatCompressedDataVS:"\nuniform highp usampler2D packedTexture;\nuniform highp sampler2D chunkTexture;\nvec4 chunkDataA;\nvec4 chunkDataB;\nvec4 chunkDataC;\nvec4 chunkDataD;\nvec4 chunkDataE;\nuvec4 packedData;\nvec3 unpack111011(uint bits) {\n	return vec3(\n		float(bits >> 21u) / 2047.0,\n		float((bits >> 11u) & 0x3ffu) / 1023.0,\n		float(bits & 0x7ffu) / 2047.0\n	);\n}\nvec4 unpack8888(uint bits) {\n	return vec4(\n		float(bits >> 24u) / 255.0,\n		float((bits >> 16u) & 0xffu) / 255.0,\n		float((bits >> 8u) & 0xffu) / 255.0,\n		float(bits & 0xffu) / 255.0\n	);\n}\nconst float norm = 1.0 / (sqrt(2.0) * 0.5);\nvec4 unpackRotation(uint bits) {\n	float a = (float((bits >> 20u) & 0x3ffu) / 1023.0 - 0.5) * norm;\n	float b = (float((bits >> 10u) & 0x3ffu) / 1023.0 - 0.5) * norm;\n	float c = (float(bits & 0x3ffu) / 1023.0 - 0.5) * norm;\n	float m = sqrt(1.0 - (a * a + b * b + c * c));\n	uint mode = bits >> 30u;\n	if (mode == 0u) return vec4(m, a, b, c);\n	if (mode == 1u) return vec4(a, m, b, c);\n	if (mode == 2u) return vec4(a, b, m, c);\n	return vec4(a, b, c, m);\n}\nvec3 readCenter(SplatSource source) {\n	uint w = uint(textureSize(chunkTexture, 0).x) / 5u;\n	uint chunkId = source.id / 256u;\n	ivec2 chunkUV = ivec2((chunkId % w) * 5u, chunkId / w);\n	chunkDataA = texelFetch(chunkTexture, chunkUV, 0);\n	chunkDataB = texelFetch(chunkTexture, chunkUV + ivec2(1, 0), 0);\n	chunkDataC = texelFetch(chunkTexture, chunkUV + ivec2(2, 0), 0);\n	chunkDataD = texelFetch(chunkTexture, chunkUV + ivec2(3, 0), 0);\n	chunkDataE = texelFetch(chunkTexture, chunkUV + ivec2(4, 0), 0);\n	packedData = texelFetch(packedTexture, source.uv, 0);\n	return mix(chunkDataA.xyz, vec3(chunkDataA.w, chunkDataB.xy), unpack111011(packedData.x));\n}\nvec4 readColor(in SplatSource source) {\n	vec4 r = unpack8888(packedData.w);\n	return vec4(mix(chunkDataD.xyz, vec3(chunkDataD.w, chunkDataE.xy), r.rgb), r.w);\n}\nvec4 getRotation() {\n	return unpackRotation(packedData.y);\n}\nvec3 getScale() {\n	return exp(mix(vec3(chunkDataB.zw, chunkDataC.x), chunkDataC.yzw, unpack111011(packedData.z)));\n}\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n	mat3 rot = quatToMat3(getRotation());\n	vec3 scale = getScale();\n	mat3 M = transpose(mat3(\n		scale.x * rot[0],\n		scale.y * rot[1],\n		scale.z * rot[2]\n	));\n	covA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n	covB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatCompressedSHVS:"\n#if SH_BANDS > 0\nuniform highp usampler2D shTexture0;\nuniform highp usampler2D shTexture1;\nuniform highp usampler2D shTexture2;\nvec4 unpack8888s(in uint bits) {\n	return vec4((uvec4(bits) >> uvec4(0u, 8u, 16u, 24u)) & 0xffu) * (8.0 / 255.0) - 4.0;\n}\nvoid readSHData(in SplatSource source, out vec3 sh[15], out float scale) {\n	uvec4 shData0 = texelFetch(shTexture0, source.uv, 0);\n	uvec4 shData1 = texelFetch(shTexture1, source.uv, 0);\n	uvec4 shData2 = texelFetch(shTexture2, source.uv, 0);\n	vec4 r0 = unpack8888s(shData0.x);\n	vec4 r1 = unpack8888s(shData0.y);\n	vec4 r2 = unpack8888s(shData0.z);\n	vec4 r3 = unpack8888s(shData0.w);\n	vec4 g0 = unpack8888s(shData1.x);\n	vec4 g1 = unpack8888s(shData1.y);\n	vec4 g2 = unpack8888s(shData1.z);\n	vec4 g3 = unpack8888s(shData1.w);\n	vec4 b0 = unpack8888s(shData2.x);\n	vec4 b1 = unpack8888s(shData2.y);\n	vec4 b2 = unpack8888s(shData2.z);\n	vec4 b3 = unpack8888s(shData2.w);\n	sh[0] =  vec3(r0.x, g0.x, b0.x);\n	sh[1] =  vec3(r0.y, g0.y, b0.y);\n	sh[2] =  vec3(r0.z, g0.z, b0.z);\n	sh[3] =  vec3(r0.w, g0.w, b0.w);\n	sh[4] =  vec3(r1.x, g1.x, b1.x);\n	sh[5] =  vec3(r1.y, g1.y, b1.y);\n	sh[6] =  vec3(r1.z, g1.z, b1.z);\n	sh[7] =  vec3(r1.w, g1.w, b1.w);\n	sh[8] =  vec3(r2.x, g2.x, b2.x);\n	sh[9] =  vec3(r2.y, g2.y, b2.y);\n	sh[10] = vec3(r2.z, g2.z, b2.z);\n	sh[11] = vec3(r2.w, g2.w, b2.w);\n	sh[12] = vec3(r3.x, g3.x, b3.x);\n	sh[13] = vec3(r3.y, g3.y, b3.y);\n	sh[14] = vec3(r3.z, g3.z, b3.z);\n	scale = 1.0;\n}\n#endif\n",gsplatEvalSHVS:"\n	#if SH_BANDS == 1\n		#define SH_COEFFS 3\n	#elif SH_BANDS == 2\n		#define SH_COEFFS 8\n	#elif SH_BANDS == 3\n		#define SH_COEFFS 15\n	#else\n		#define SH_COEFFS 0\n	#endif\n	#if SH_BANDS > 0\n	const float SH_C1 = 0.4886025119029199f;\n	#if SH_BANDS > 1\n		const float SH_C2_0 = 1.0925484305920792f;\n		const float SH_C2_1 = -1.0925484305920792f;\n		const float SH_C2_2 = 0.31539156525252005f;\n		const float SH_C2_3 = -1.0925484305920792f;\n		const float SH_C2_4 = 0.5462742152960396f;\n	#endif\n	#if SH_BANDS > 2\n		const float SH_C3_0 = -0.5900435899266435f;\n		const float SH_C3_1 = 2.890611442640554f;\n		const float SH_C3_2 = -0.4570457994644658f;\n		const float SH_C3_3 = 0.3731763325901154f;\n		const float SH_C3_4 = -0.4570457994644658f;\n		const float SH_C3_5 = 1.445305721320277f;\n		const float SH_C3_6 = -0.5900435899266435f;\n	#endif\n	vec3 evalSH(in vec3 sh[SH_COEFFS], in vec3 dir) {\n		float x = dir.x;\n		float y = dir.y;\n		float z = dir.z;\n		vec3 result = SH_C1 * (-sh[0] * y + sh[1] * z - sh[2] * x);\n		#if SH_BANDS > 1\n			float xx = x * x;\n			float yy = y * y;\n			float zz = z * z;\n			float xy = x * y;\n			float yz = y * z;\n			float xz = x * z;\n			result +=\n				sh[3] * (SH_C2_0 * xy) +\n				sh[4] * (SH_C2_1 * yz) +\n				sh[5] * (SH_C2_2 * (2.0 * zz - xx - yy)) +\n				sh[6] * (SH_C2_3 * xz) +\n				sh[7] * (SH_C2_4 * (xx - yy));\n		#endif\n		#if SH_BANDS > 2\n			result +=\n				sh[8]  * (SH_C3_0 * y * (3.0 * xx - yy)) +\n				sh[9]  * (SH_C3_1 * xy * z) +\n				sh[10] * (SH_C3_2 * y * (4.0 * zz - xx - yy)) +\n				sh[11] * (SH_C3_3 * z * (2.0 * zz - 3.0 * xx - 3.0 * yy)) +\n				sh[12] * (SH_C3_4 * x * (4.0 * zz - xx - yy)) +\n				sh[13] * (SH_C3_5 * z * (xx - yy)) +\n				sh[14] * (SH_C3_6 * x * (xx - 3.0 * yy));\n		#endif\n		return result;\n	}\n	#endif\n",gsplatQuatToMat3VS:"\nmat3 quatToMat3(vec4 R) {\n	vec4 R2 = R + R;\n	float X = R2.x * R.w;\n	vec4 Y  = R2.y * R;\n	vec4 Z  = R2.z * R;\n	float W = R2.w * R.w;\n	return mat3(\n		1.0 - Z.z - W,\n			  Y.z + X,\n			  Y.w - Z.x,\n			  Y.z - X,\n		1.0 - Y.y - W,\n			  Z.w + Y.x,\n			  Y.w + Z.x,\n			  Z.w - Y.x,\n		1.0 - Y.y - Z.z\n	);\n}\n",gsplatSogsColorVS:"\nuniform highp sampler2D packedSh0;\nuniform float sh0_mins;\nuniform float sh0_maxs;\nfloat SH_C0 = 0.28209479177387814;\nvec4 readColor(in SplatSource source) {\n	vec3 clr = mix(vec3(sh0_mins), vec3(sh0_maxs), unpack111110(pack8888(texelFetch(packedSh0, source.uv, 0))));\n	float alpha = float(packedSample.z & 0xffu) / 255.0;\n	return vec4(vec3(0.5) + clr.xyz * SH_C0, alpha);\n}\n",gsplatSogsDataVS:'\n#include "gsplatPackingPS"\nuniform highp usampler2D packedTexture;\nuniform vec3 means_mins;\nuniform vec3 means_maxs;\nuniform float scales_mins;\nuniform float scales_maxs;\nuvec4 packedSample;\nvec3 readCenter(SplatSource source) {\n	packedSample = texelFetch(packedTexture, source.uv, 0);\n	vec3 l = unpack8888(packedSample.x).xyz;\n	vec3 u = unpack8888(packedSample.y).xyz;\n	vec3 n = (l * 255.0 + u * 255.0 * 256.0) / 65535.0;\n	vec3 v = mix(means_mins, means_maxs, n);\n	return sign(v) * (exp(abs(v)) - 1.0);\n}\nconst float norm = 2.0 / sqrt(2.0);\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n	vec3 qdata = unpack8888(packedSample.z).xyz;\n	vec3 sdata = unpack101010(packedSample.w >> 2u);\n	uint qmode = packedSample.w & 0x3u;\n	vec3 abc = (qdata - 0.5) * norm;\n	float d = sqrt(max(0.0, 1.0 - dot(abc, abc)));\n	vec4 quat = (qmode == 0u) ? vec4(d, abc) :\n				((qmode == 1u) ? vec4(abc.x, d, abc.yz) :\n				((qmode == 2u) ? vec4(abc.xy, d, abc.z) : vec4(abc, d)));\n	mat3 rot = quatToMat3(quat);\n	vec3 scale = exp(mix(vec3(scales_mins), vec3(scales_maxs), sdata));\n	mat3 M = transpose(mat3(\n		scale.x * rot[0],\n		scale.y * rot[1],\n		scale.z * rot[2]\n	));\n	covA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n	covB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n',gsplatSogsSHVS:"\nuniform highp sampler2D packedShN;\nuniform float shN_mins;\nuniform float shN_maxs;\nvoid readSHData(in SplatSource source, out vec3 sh[SH_COEFFS], out float scale) {\n	ivec2 t = ivec2(packedSample.xy & 255u);\n	int n = t.x + t.y * 256;\n	int u = (n % 64) * SH_COEFFS;\n	int v = n / 64;\n	for (int i = 0; i < SH_COEFFS; i++) {\n		sh[i] = mix(vec3(shN_mins), vec3(shN_maxs), unpack111110(pack8888(texelFetch(packedShN, ivec2(u + i, v), 0))));\n	}\n	scale = 1.0;\n}\n",gsplatSourceFormatVS:'\n#if defined(GSPLAT_WORKBUFFER_DATA)\n	#include "gsplatWorkBufferVS"\n#elif GSPLAT_COMPRESSED_DATA == true\n	#include "gsplatCompressedDataVS"\n	#if SH_COEFFS > 0\n		#include "gsplatCompressedSHVS"\n	#endif\n#elif GSPLAT_SOGS_DATA == true\n	#include "gsplatSogsDataVS"\n	#include "gsplatSogsColorVS"\n	#if SH_COEFFS > 0\n		#include "gsplatSogsSHVS"\n	#endif\n#else\n	#include "gsplatDataVS"\n	#include "gsplatColorVS"\n	#if SH_COEFFS > 0\n		#include "gsplatSHVS"\n	#endif\n#endif\n',gsplatStructsVS:"\nstruct SplatSource {\n	uint order;\n	uint id;\n	ivec2 uv;\n	vec2 cornerUV;\n};\nstruct SplatCenter {\n	vec3 view;\n	vec4 proj;\n	mat4 modelView;\n	float projMat00;\n};\nstruct SplatCorner {\n	vec2 offset;\n	vec2 uv;\n	#if GSPLAT_AA\n		float aaFactor;\n	#endif\n	vec2 v;\n	float dlen;\n};\n",gsplatDataVS:"\nuniform highp usampler2D transformA;\nuniform highp sampler2D transformB;\nuint tAw;\nvec3 readCenter(SplatSource source) {\n	uvec4 tA = texelFetch(transformA, source.uv, 0);\n	tAw = tA.w;\n	return uintBitsToFloat(tA.xyz);\n}\nvec4 unpackRotation(vec3 packed) {\n	return vec4(packed.xyz, sqrt(max(0.0, 1.0 - dot(packed, packed))));\n}\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n	vec4 tB = texelFetch(transformB, source.uv, 0);\n	mat3 rot = quatToMat3(unpackRotation(vec3(unpackHalf2x16(tAw), tB.w)).wxyz);\n	vec3 scale = tB.xyz;\n	\n	mat3 M = transpose(mat3(\n		scale.x * rot[0],\n		scale.y * rot[1],\n		scale.z * rot[2]\n	));\n	covA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n	covB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatOutputVS:'\n#include "tonemappingPS"\n#include "decodePS"\n#include "gammaPS"\nvec3 prepareOutputFromGamma(vec3 gammaColor) {\n	#if TONEMAP == NONE\n		#if GAMMA == NONE\n			return decodeGamma(gammaColor);\n		#else\n			return gammaColor;\n		#endif\n	#else\n		return gammaCorrectOutput(toneMap(decodeGamma(gammaColor)));\n	#endif\n}\n',gsplatPS:'\n#ifndef DITHER_NONE\n	#include "bayerPS"\n	#include "opacityDitherPS"\n	varying float id;\n#endif\n#ifdef PICK_PASS\n	#include "pickPS"\n#endif\n#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)\n	uniform float alphaClip;\n#endif\n#ifdef PREPASS_PASS\n	varying float vLinearDepth;\n	#include "floatAsUintPS"\n#endif\nconst float  EXP_A	  = 12102203.0;\nconst int	EXP_BC_RMS = 1064866808;\nfloat fastExp(float x) {\n	int i = int(EXP_A * x) + EXP_BC_RMS;\n	return intBitsToFloat(i);\n}\nvarying mediump vec2 gaussianUV;\nvarying mediump vec4 gaussianColor;\nvoid main(void) {\n	mediump float A = dot(gaussianUV, gaussianUV);\n	if (A > 1.0) {\n		discard;\n	}\n	mediump float alpha = fastExp(-A * 4.0) * gaussianColor.a;\n	#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)\n		if (alpha < alphaClip) {\n			discard;\n		}\n	#endif\n	#ifdef PICK_PASS\n		gl_FragColor = getPickOutput();\n	#elif SHADOW_PASS\n		gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n	#elif PREPASS_PASS\n		gl_FragColor = float2vec4(vLinearDepth);\n	#else\n		if (alpha < 1.0 / 255.0) {\n			discard;\n		}\n		#ifndef DITHER_NONE\n			opacityDither(alpha, id * 0.013);\n		#endif\n		gl_FragColor = vec4(gaussianColor.xyz * alpha, alpha);\n	#endif\n}\n',gsplatSHVS:"\n#if SH_BANDS > 0\nvec3 unpack111011s(uint bits) {\n	return vec3((uvec3(bits) >> uvec3(21u, 11u, 0u)) & uvec3(0x7ffu, 0x3ffu, 0x7ffu)) / vec3(2047.0, 1023.0, 2047.0) * 2.0 - 1.0;\n}\nvoid fetchScale(in uvec4 t, out float scale, out vec3 a, out vec3 b, out vec3 c) {\n	scale = uintBitsToFloat(t.x);\n	a = unpack111011s(t.y);\n	b = unpack111011s(t.z);\n	c = unpack111011s(t.w);\n}\nvoid fetch(in uvec4 t, out vec3 a, out vec3 b, out vec3 c, out vec3 d) {\n	a = unpack111011s(t.x);\n	b = unpack111011s(t.y);\n	c = unpack111011s(t.z);\n	d = unpack111011s(t.w);\n}\nvoid fetch(in uint t, out vec3 a) {\n	a = unpack111011s(t);\n}\n#if SH_BANDS == 1\n	uniform highp usampler2D splatSH_1to3;\n	void readSHData(in SplatSource source, out vec3 sh[3], out float scale) {\n		fetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n	}\n#elif SH_BANDS == 2\n	uniform highp usampler2D splatSH_1to3;\n	uniform highp usampler2D splatSH_4to7;\n	uniform highp usampler2D splatSH_8to11;\n	void readSHData(in SplatSource source, out vec3 sh[8], out float scale) {\n		fetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n		fetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);\n		fetch(texelFetch(splatSH_8to11, source.uv, 0).x, sh[7]);\n	}\n#else\n	uniform highp usampler2D splatSH_1to3;\n	uniform highp usampler2D splatSH_4to7;\n	uniform highp usampler2D splatSH_8to11;\n	uniform highp usampler2D splatSH_12to15;\n	void readSHData(in SplatSource source, out vec3 sh[15], out float scale) {\n		fetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n		fetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);\n		fetch(texelFetch(splatSH_8to11, source.uv, 0), sh[7], sh[8], sh[9], sh[10]);\n		fetch(texelFetch(splatSH_12to15, source.uv, 0), sh[11], sh[12], sh[13], sh[14]);\n	}\n#endif\n#endif\n",gsplatSourceVS:"\nattribute vec3 vertex_position;\nattribute uint vertex_id_attrib;\nuniform uint numSplats;\nuniform highp usampler2D splatOrder;\nbool initSource(out SplatSource source) {\n	uint w = uint(textureSize(splatOrder, 0).x);\n	source.order = vertex_id_attrib + uint(vertex_position.z);\n	if (source.order >= numSplats) {\n		return false;\n	}\n	ivec2 orderUV = ivec2(source.order % w, source.order / w);\n	source.id = texelFetch(splatOrder, orderUV, 0).r;\n	source.uv = ivec2(source.id % w, source.id / w);\n	source.cornerUV = vertex_position.xy;\n	return true;\n}\n",gsplatVS:'\n#include "gsplatCommonVS"\nvarying mediump vec2 gaussianUV;\nvarying mediump vec4 gaussianColor;\n#ifndef DITHER_NONE\n	varying float id;\n#endif\nmediump vec4 discardVec = vec4(0.0, 0.0, 2.0, 1.0);\n#ifdef PREPASS_PASS\n	varying float vLinearDepth;\n#endif\nvoid main(void) {\n	SplatSource source;\n	if (!initSource(source)) {\n		gl_Position = discardVec;\n		return;\n	}\n	vec3 modelCenter = readCenter(source);\n	SplatCenter center;\n	if (!initCenter(modelCenter, center)) {\n		gl_Position = discardVec;\n		return;\n	}\n	SplatCorner corner;\n	if (!initCorner(source, center, corner)) {\n		gl_Position = discardVec;\n		return;\n	}\n	vec4 clr = readColor(source);\n	#if GSPLAT_AA\n		clr.a *= corner.aaFactor;\n	#endif\n	#if SH_BANDS > 0\n		vec3 dir = normalize(center.view * mat3(center.modelView));\n		vec3 sh[SH_COEFFS];\n		float scale;\n		readSHData(source, sh, scale);\n		clr.xyz += evalSH(sh, dir) * scale;\n	#endif\n	clipCorner(corner, clr.w);\n	gl_Position = center.proj + vec4(corner.offset, 0, 0);\n	gaussianUV = corner.uv;\n	gaussianColor = vec4(prepareOutputFromGamma(max(clr.xyz, 0.0)), clr.w);\n	#ifndef DITHER_NONE\n		id = float(source.id);\n	#endif\n	#ifdef PREPASS_PASS\n		vLinearDepth = -center.view.z;\n	#endif\n}\n',gsplatWorkBufferVS:"\nuniform highp sampler2D center;\nuniform highp sampler2D covA;\nuniform highp sampler2D covB;\nuniform mediump sampler2D splatColor;\nvec3 readCenter(SplatSource source) {\n	return texelFetch(center, source.uv, 0).xyz;\n}\nvoid readCovariance(in SplatSource source, out vec3 cov_A, out vec3 cov_B) {\n	cov_A = texelFetch(covA, source.uv, 0).xyz;\n	cov_B = texelFetch(covB, source.uv, 0).xyz;\n}\nvec4 readColor(in SplatSource source) {\n	return texelFetch(splatColor, source.uv, 0);\n}\n",gsplatPackingPS:ph,quadVS:"\n	attribute vec2 aPosition;\n	varying vec2 uv0;\n	void main(void)\n	{\n		gl_Position = vec4(aPosition, 0.0, 1.0);\n		uv0 = getImageEffectUV((aPosition.xy + 1.0) * 0.5);\n	}\n",immediateLinePS:'\n		#include "gammaPS"\n		varying vec4 color;\n		void main(void) {\n			gl_FragColor = vec4(gammaCorrectOutput(decodeGamma(color.rgb)), color.a);\n		}\n',immediateLineVS:"\n	attribute vec4 vertex_position;\n	attribute vec4 vertex_color;\n	uniform mat4 matrix_model;\n	uniform mat4 matrix_viewProjection;\n	varying vec4 color;\n	void main(void) {\n		color = vertex_color;\n		gl_Position = matrix_viewProjection * matrix_model * vertex_position;\n	}\n",iridescenceDiffractionPS:"\nuniform float material_iridescenceRefractionIndex;\nfloat iridescence_iorToFresnel(float transmittedIor, float incidentIor) {\n	return pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);\n}\nvec3 iridescence_iorToFresnel(vec3 transmittedIor, float incidentIor) {\n	return pow((transmittedIor - vec3(incidentIor)) / (transmittedIor + vec3(incidentIor)), vec3(2.0));\n}\nvec3 iridescence_fresnelToIor(vec3 f0) {\n	vec3 sqrtF0 = sqrt(f0);\n	return (vec3(1.0) + sqrtF0) / (vec3(1.0) - sqrtF0);\n}\nvec3 iridescence_sensitivity(float opd, vec3 shift) {\n	float PI = 3.141592653589793;\n	float phase = 2.0 * PI * opd * 1.0e-9;\n	const vec3 val = vec3(5.4856e-13, 4.4201e-13, 5.2481e-13);\n	const vec3 pos = vec3(1.6810e+06, 1.7953e+06, 2.2084e+06);\n	const vec3 var = vec3(4.3278e+09, 9.3046e+09, 6.6121e+09);\n	vec3 xyz = val * sqrt(2.0 * PI * var) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var);\n	xyz.x += 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));\n	xyz /= vec3(1.0685e-07);\n	const mat3 XYZ_TO_REC709 = mat3(\n		3.2404542, -0.9692660,  0.0556434,\n	   -1.5371385,  1.8760108, -0.2040259,\n	   -0.4985314,  0.0415560,  1.0572252\n	);\n	return XYZ_TO_REC709 * xyz;\n}\nfloat iridescence_fresnel(float cosTheta, float f0) {\n	float x = clamp(1.0 - cosTheta, 0.0, 1.0);\n	float x2 = x * x;\n	float x5 = x * x2 * x2;\n	return f0 + (1.0 - f0) * x5;\n} \nvec3 iridescence_fresnel(float cosTheta, vec3 f0) {\n	float x = clamp(1.0 - cosTheta, 0.0, 1.0);\n	float x2 = x * x;\n	float x5 = x * x2 * x2; \n	return f0 + (vec3(1.0) - f0) * x5;\n}\nvec3 calcIridescence(float outsideIor, float cosTheta, vec3 base_f0, float iridescenceThickness) {\n	float PI = 3.141592653589793;\n	float iridescenceIor = mix(outsideIor, material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));\n	float sinTheta2Sq = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));\n	float cosTheta2Sq = 1.0 - sinTheta2Sq;\n	if (cosTheta2Sq < 0.0) {\n		return vec3(1.0);\n	}\n	float cosTheta2 = sqrt(cosTheta2Sq);\n	float r0 = iridescence_iorToFresnel(iridescenceIor, outsideIor);\n	float r12 = iridescence_fresnel(cosTheta, r0);\n	float r21 = r12;\n	float t121 = 1.0 - r12;\n	float phi12 = iridescenceIor < outsideIor ? PI : 0.0;\n	float phi21 = PI - phi12;\n	vec3 baseIor = iridescence_fresnelToIor(base_f0 + vec3(0.0001));\n	vec3 r1 = iridescence_iorToFresnel(baseIor, iridescenceIor);\n	vec3 r23 = iridescence_fresnel(cosTheta2, r1);\n	vec3 phi23 = vec3(0.0);\n	if (baseIor[0] < iridescenceIor) phi23[0] = PI;\n	if (baseIor[1] < iridescenceIor) phi23[1] = PI;\n	if (baseIor[2] < iridescenceIor) phi23[2] = PI;\n	float opd = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;\n	vec3 phi = vec3(phi21) + phi23; \n	vec3 r123Sq = clamp(r12 * r23, 1e-5, 0.9999);\n	vec3 r123 = sqrt(r123Sq);\n	vec3 rs = pow(t121, 2.0) * r23 / (1.0 - r123Sq);\n	vec3 c0 = r12 + rs;\n	vec3 i = c0;\n	vec3 cm = rs - t121;\n	for (int m = 1; m <= 2; m++) {\n		cm *= r123;\n		vec3 sm = 2.0 * iridescence_sensitivity(float(m) * opd, float(m) * phi);\n		i += cm * sm;\n	}\n	return max(i, vec3(0.0));\n}\nvec3 getIridescence(float cosTheta, vec3 specularity, float iridescenceThickness) {\n	return calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);\n}\n",iridescencePS:"\n#ifdef STD_IRIDESCENCE_CONSTANT\nuniform float material_iridescence;\n#endif\nvoid getIridescence() {\n	float iridescence = 1.0;\n	#ifdef STD_IRIDESCENCE_CONSTANT\n	iridescence *= material_iridescence;\n	#endif\n	#ifdef STD_IRIDESCENCE_TEXTURE\n	iridescence *= texture2DBias({STD_IRIDESCENCE_TEXTURE_NAME}, {STD_IRIDESCENCE_TEXTURE_UV}, textureBias).{STD_IRIDESCENCE_TEXTURE_CHANNEL};\n	#endif\n	dIridescence = iridescence; \n}\n",iridescenceThicknessPS:"\nuniform float material_iridescenceThicknessMax;\n#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE\nuniform float material_iridescenceThicknessMin;\n#endif\nvoid getIridescenceThickness() {\n	#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE\n		float blend = texture2DBias({STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}, {STD_IRIDESCENCETHICKNESS_TEXTURE_UV}, textureBias).{STD_IRIDESCENCETHICKNESS_TEXTURE_CHANNEL};\n		float iridescenceThickness = mix(material_iridescenceThicknessMin, material_iridescenceThicknessMax, blend);\n	#else\n		float iridescenceThickness = material_iridescenceThicknessMax;\n	#endif\n	dIridescenceThickness = iridescenceThickness; \n}\n",iorPS:"\n#ifdef STD_IOR_CONSTANT\nuniform float material_refractionIndex;\n#endif\nvoid getIor() {\n#ifdef STD_IOR_CONSTANT\n	dIor = material_refractionIndex;\n#else\n	dIor = 1.0 / 1.5;\n#endif\n}\n",lightDeclarationPS:"\n#if defined(LIGHT{i})\n	uniform vec3 light{i}_color;\n	#if LIGHT{i}TYPE == DIRECTIONAL\n		uniform vec3 light{i}_direction;\n	#else\n		#define LIT_CODE_LIGHTS_POINT\n		uniform vec3 light{i}_position;\n		uniform float light{i}_radius;\n		#if LIGHT{i}TYPE == SPOT\n			#define LIT_CODE_LIGHTS_SPOT\n			uniform vec3 light{i}_direction;\n			uniform float light{i}_innerConeAngle;\n			uniform float light{i}_outerConeAngle;\n		#endif\n	#endif\n	#if LIGHT{i}SHAPE != PUNCTUAL\n		#define LIT_CODE_FALLOFF_SQUARED\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			uniform vec3 light{i}_position;\n		#endif\n		uniform vec3 light{i}_halfWidth;\n		uniform vec3 light{i}_halfHeight;\n	#else\n		#if LIGHT{i}FALLOFF == LINEAR\n			#define LIT_CODE_FALLOFF_LINEAR\n		#endif\n		#if LIGHT{i}FALLOFF == INVERSESQUARED\n			#define LIT_CODE_FALLOFF_SQUARED\n		#endif\n	#endif\n	#if defined(LIGHT{i}CASTSHADOW)\n		uniform mat4 light{i}_shadowMatrix;\n		uniform float light{i}_shadowIntensity;\n		uniform vec4 light{i}_shadowParams;\n		#if LIGHT{i}SHADOWTYPE == PCSS_32F\n			uniform float light{i}_shadowSearchArea;\n			uniform vec4 light{i}_cameraParams;\n			#if LIGHT{i}TYPE == DIRECTIONAL\n				uniform vec4 light{i}_softShadowParams;\n			#endif\n		#endif\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			uniform mat4 light{i}_shadowMatrixPalette[4];\n			uniform vec4 light{i}_shadowCascadeDistances;\n			uniform int light{i}_shadowCascadeCount;\n			uniform float light{i}_shadowCascadeBlend;\n		#endif\n		#if LIGHT{i}TYPE == OMNI\n			#if defined(LIGHT{i}SHADOW_PCF)\n				uniform samplerCubeShadow light{i}_shadowMap;\n			#else\n				uniform samplerCube light{i}_shadowMap;\n			#endif\n		#else\n			#if defined(LIGHT{i}SHADOW_PCF)\n				uniform sampler2DShadow light{i}_shadowMap;\n			#else\n				uniform sampler2D light{i}_shadowMap;\n			#endif\n		#endif\n	#endif\n	#if defined(LIGHT{i}COOKIE)\n		#define LIT_CODE_COOKIE\n		#if LIGHT{i}TYPE == OMNI\n			uniform samplerCube light{i}_cookie;\n			uniform float light{i}_cookieIntensity;\n			#if !defined(LIGHT{i}CASTSHADOW)\n				uniform mat4 light{i}_shadowMatrix;\n			#endif\n		#endif\n		#if LIGHT{i}TYPE == SPOT\n			uniform sampler2D light{i}_cookie;\n			uniform float light{i}_cookieIntensity;\n			#if !defined(LIGHT{i}CASTSHADOW)\n				uniform mat4 light{i}_shadowMatrix;\n			#endif\n			#if defined(LIGHT{i}COOKIE_TRANSFORM)\n				uniform vec4 light{i}_cookieMatrix;\n				uniform vec2 light{i}_cookieOffset;\n			#endif\n		#endif\n	#endif\n#endif\n",lightDiffuseLambertPS:"\nfloat getLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm) {\n	return max(dot(worldNormal, -lightDirNorm), 0.0);\n}\n",lightDirPointPS:"\nvec3 evalOmniLight(vec3 lightPosW) {\n	return vPositionW - lightPosW;\n}\n",lightEvaluationPS:"\n#if defined(LIGHT{i})\n	evaluateLight{i}(\n		#if defined(LIT_IRIDESCENCE)\n			iridescenceFresnel\n		#endif\n	);\n#endif\n",lightFunctionLightPS:"\n#if defined(LIGHT{i})\nvoid evaluateLight{i}(\n	#if defined(LIT_IRIDESCENCE)\n		vec3 iridescenceFresnel\n	#endif\n) {\n	vec3 lightColor = light{i}_color;\n	#if LIGHT{i}TYPE == DIRECTIONAL && !defined(LIT_SHADOW_CATCHER)\n		if (all(equal(lightColor, vec3(0.0)))) {\n			return;\n		}\n	#endif\n	#if LIGHT{i}TYPE == DIRECTIONAL\n		dLightDirNormW = light{i}_direction;\n		dAtten = 1.0;\n	#else\n		\n		vec3 lightDirW = evalOmniLight(light{i}_position);\n		dLightDirNormW = normalize(lightDirW);\n		#if defined(LIGHT{i}COOKIE)\n			#if LIGHT{i}TYPE == SPOT\n				#ifdef LIGHT{i}COOKIE_FALLOFF\n					#ifdef LIGHT{i}COOKIE_TRANSFORM\n						vec3 cookieAttenuation = getCookie2DXform(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity, light{i}_cookieMatrix, light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};\n					#else\n						vec3 cookieAttenuation = getCookie2D(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n					#endif\n				#else\n					#ifdef LIGHT{i}COOKIE_TRANSFORM\n						vec3 cookieAttenuation = getCookie2DClipXform(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity, light{i}_cookieMatrix, light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};\n					#else\n						vec3 cookieAttenuation = getCookie2DClip(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n					#endif\n				#endif\n			#endif\n			#if LIGHT{i}TYPE == OMNI\n				vec3 cookieAttenuation = getCookieCube(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n			#endif\n			lightColor *= cookieAttenuation;\n		#endif\n		#if LIGHT{i}SHAPE == PUNCTUAL\n			#if LIGHT{i}FALLOFF == LINEAR\n				dAtten = getFalloffLinear(light{i}_radius, lightDirW);\n			#else\n				dAtten = getFalloffInvSquared(light{i}_radius, lightDirW);\n			#endif\n		#else\n			dAtten = getFalloffWindow(light{i}_radius, lightDirW);\n		#endif\n		#if LIGHT{i}TYPE == SPOT\n			#if !defined(LIGHT{i}COOKIE) || defined(LIGHT{i}COOKIE_FALLOFF)\n				dAtten *= getSpotEffect(light{i}_direction, light{i}_innerConeAngle, light{i}_outerConeAngle, dLightDirNormW);\n			#endif\n		#endif\n	#endif\n	if (dAtten < 0.00001) {\n		return;\n	}\n	#if LIGHT{i}SHAPE != PUNCTUAL\n		#if LIGHT{i}SHAPE == RECT\n			calcRectLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);\n		#elif LIGHT{i}SHAPE == DISK\n			calcDiskLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);\n		#elif LIGHT{i}SHAPE == SPHERE\n			calcSphereLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);\n		#endif\n	#endif\n	#if LIGHT{i}SHAPE != PUNCTUAL\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			float attenDiffuse = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirNormW);\n		#else\n			#if LIGHT{i}SHAPE == RECT\n				float attenDiffuse = getRectLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n			#elif LIGHT{i}SHAPE == DISK\n				float attenDiffuse = getDiskLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n			#elif LIGHT{i}SHAPE == SPHERE\n				float attenDiffuse = getSphereLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n			#endif\n		#endif\n	#else\n		dAtten *= getLightDiffuse(litArgs_worldNormal, vec3(0.0), dLightDirNormW);\n	#endif\n	#ifdef LIGHT{i}CASTSHADOW\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			float shadow = getShadow{i}(vec3(0.0));\n		#else\n			float shadow = getShadow{i}(lightDirW);\n		#endif\n		shadow = mix(1.0, shadow, light{i}_shadowIntensity);\n		dAtten *= shadow;\n		#if defined(LIT_SHADOW_CATCHER) && LIGHT{i}TYPE == DIRECTIONAL\n			dShadowCatcher *= shadow;\n		#endif			\n	#endif\n	#if LIGHT{i}SHAPE != PUNCTUAL\n		#ifdef LIT_SPECULAR\n			dDiffuseLight += ((attenDiffuse * dAtten) * lightColor) * (1.0 - dLTCSpecFres);\n		#else\n			dDiffuseLight += (attenDiffuse * dAtten) * lightColor;\n		#endif						\n	#else\n		#if defined(AREA_LIGHTS) && defined(LIT_SPECULAR)\n			dDiffuseLight += (dAtten * lightColor) * (1.0 - litArgs_specularity);\n		#else\n			dDiffuseLight += dAtten * lightColor;\n		#endif\n	#endif\n	#ifdef LIGHT{i}AFFECT_SPECULARITY\n		#if LIGHT{i}SHAPE != PUNCTUAL\n			#ifdef LIT_CLEARCOAT\n				#if LIGHT{i}SHAPE == RECT\n					ccSpecularLight += ccLTCSpecFres * getRectLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;\n				#elif LIGHT{i}SHAPE == DISK\n					ccSpecularLight += ccLTCSpecFres * getDiskLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;\n				#elif LIGHT{i}SHAPE == SPHERE\n					ccSpecularLight += ccLTCSpecFres * getSphereLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;\n				#endif\n			#endif\n			#ifdef LIT_SPECULAR\n				#if LIGHT{i}SHAPE == RECT\n					dSpecularLight += dLTCSpecFres * getRectLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;\n				#elif LIGHT{i}SHAPE == DISK\n					dSpecularLight += dLTCSpecFres * getDiskLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;\n				#elif LIGHT{i}SHAPE == SPHERE\n					dSpecularLight += dLTCSpecFres * getSphereLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;\n				#endif\n			#endif\n		#else\n			#if LIGHT{i}TYPE == DIRECTIONAL && LIT_FRESNEL_MODEL != NONE\n				#define LIGHT{i}FRESNEL\n			#endif\n			#ifdef LIT_SPECULAR\n				vec3 halfDirW = normalize(-dLightDirNormW + dViewDirW);\n			#endif\n			#ifdef LIT_CLEARCOAT\n				vec3 lightspecularCC = getLightSpecular(halfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * lightColor;\n				#ifdef LIGHT{i}FRESNEL\n					lightspecularCC *= getFresnelCC(dot(dViewDirW, halfDirW));\n				#endif\n				ccSpecularLight += lightspecularCC;\n			#endif\n			#ifdef LIT_SHEEN\n				sSpecularLight += getLightSpecularSheen(halfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * lightColor;\n			#endif\n			#ifdef LIT_SPECULAR\n				vec3 lightSpecular = getLightSpecular(halfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * lightColor;\n				#ifdef LIGHT{i}FRESNEL\n					#if defined(LIT_IRIDESCENCE)\n						lightSpecular *= getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity, iridescenceFresnel, litArgs_iridescence_intensity);\n					#else\n						lightSpecular *= getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity);\n					#endif\n				#else\n					lightSpecular *= litArgs_specularity;\n				#endif\n				\n				dSpecularLight += lightSpecular;\n			#endif\n		#endif\n	#endif\n}\n#endif\n",lightFunctionShadowPS:"\n#ifdef LIGHT{i}CASTSHADOW\n	vec3 getShadowSampleCoord{i}(mat4 shadowTransform, vec4 shadowParams, vec3 worldPosition, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {\n		vec3 surfacePosition = worldPosition;\n		#ifdef LIGHT{i}_SHADOW_SAMPLE_POINT\n			#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n				float distScale = length(lightDir);\n				surfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n				lightDir = surfacePosition - lightPos;\n				return lightDir;\n			#endif\n		#else\n			#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER\n				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n					surfacePosition = surfacePosition + normal * shadowParams.y;\n				#endif\n			#else\n				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n					#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO\n						float distScale = 1.0;\n					#else\n						float distScale = abs(dot(vPositionW - lightPos, lightDirNorm));\n					#endif\n					surfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n				#endif\n			#endif\n			vec4 positionInShadowSpace = shadowTransform * vec4(surfacePosition, 1.0);\n			#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO\n				positionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;\n			#else\n				#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER\n					positionInShadowSpace.xyz /= positionInShadowSpace.w;\n				#else\n					positionInShadowSpace.xy /= positionInShadowSpace.w;\n					positionInShadowSpace.z = length(lightDir) * shadowParams.w;\n				#endif\n			#endif\n			#ifdef SHADOW_SAMPLE_Z_BIAS\n			#endif\n			surfacePosition = positionInShadowSpace.xyz;\n		#endif\n		return surfacePosition;\n	}\n	float getShadow{i}(vec3 lightDirW) {\n		#ifdef LIGHT{i}_SHADOW_CASCADES\n			int cascadeIndex = getShadowCascadeIndex(light{i}_shadowCascadeDistances, light{i}_shadowCascadeCount);\n			#ifdef LIGHT{i}_SHADOW_CASCADE_BLEND\n				cascadeIndex = ditherShadowCascadeIndex(cascadeIndex, light{i}_shadowCascadeDistances, light{i}_shadowCascadeCount, light{i}_shadowCascadeBlend);\n			#endif\n			mat4 shadowMatrix = light{i}_shadowMatrixPalette[cascadeIndex];\n		#else\n			mat4 shadowMatrix = light{i}_shadowMatrix;\n		#endif\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			vec3 shadowCoord = getShadowSampleCoord{i}(shadowMatrix, light{i}_shadowParams, vPositionW, vec3(0.0), lightDirW, dLightDirNormW, dVertexNormalW);\n		#else\n			vec3 shadowCoord = getShadowSampleCoord{i}(shadowMatrix, light{i}_shadowParams, vPositionW, light{i}_position, lightDirW, dLightDirNormW, dVertexNormalW);\n		#endif\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			shadowCoord = fadeShadow(shadowCoord, light{i}_shadowCascadeDistances);\n		#endif\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			#if LIGHT{i}SHADOWTYPE == VSM_16F\n				return getShadowVSM16(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 5.54);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == VSM_32F\n				return getShadowVSM32(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 15.0);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCSS_32F\n				#if LIGHT{i}SHAPE != PUNCTUAL\n					vec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;\n					return getShadowPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);\n				#else\n					return getShadowPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, light{i}_softShadowParams, lightDirW);\n				#endif\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n				return getShadowPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n				return getShadowPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F\n				return getShadowPCF5x5(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n			#endif\n		#endif\n		#if LIGHT{i}TYPE == SPOT\n			#if LIGHT{i}SHADOWTYPE == VSM_16F\n				return getShadowSpotVSM16(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 5.54, lightDirW);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == VSM_32F\n				return getShadowSpotVSM32(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 15.0, lightDirW);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCSS_32F\n				#if LIGHT{i}SHAPE != PUNCTUAL\n					vec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;\n				#else\n					vec2 shadowSearchArea = vec2(light{i}_shadowSearchArea);\n				#endif\n				return getShadowSpotPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n				return getShadowSpotPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n				return getShadowSpotPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F\n				return getShadowSpotPCF5x5(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n			#endif\n		#endif\n		#if LIGHT{i}TYPE == OMNI\n			#if LIGHT{i}SHADOWTYPE == PCSS_32F\n				#if LIGHT{i}SHAPE != PUNCTUAL\n					vec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;\n				#else\n					vec2 shadowSearchArea = vec2(light{i}_shadowSearchArea);\n				#endif\n				return getShadowOmniPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n				return getShadowOmniPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, lightDirW);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n				return getShadowOmniPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, lightDirW);\n			#endif\n		#endif\n	}\n#endif\n",lightingPS:'\n#ifdef LIT_CLUSTERED_LIGHTS\n	#define LIT_CODE_FALLOFF_LINEAR\n	#define LIT_CODE_FALLOFF_SQUARED\n	#define LIT_CODE_LIGHTS_POINT\n	#define LIT_CODE_LIGHTS_SPOT\n#endif\n#ifdef AREA_LIGHTS\n	uniform highp sampler2D areaLightsLutTex1;\n	uniform highp sampler2D areaLightsLutTex2;\n#endif\n#ifdef LIT_LIGHTING\n	#include "lightDiffuseLambertPS"\n	#if defined(AREA_LIGHTS) || defined(LIT_CLUSTERED_AREA_LIGHTS)\n		#include "ltcPS"\n	#endif\n#endif\n#ifdef SHADOW_DIRECTIONAL\n	#include "shadowCascadesPS"\n#endif\n#if defined(SHADOW_KIND_PCF1)\n	#include "shadowPCF1PS"\n#endif\n#if defined(SHADOW_KIND_PCF3)\n	#include "shadowPCF3PS"\n#endif\n#if defined(SHADOW_KIND_PCF5)\n	#include "shadowPCF5PS"\n#endif\n#if defined(SHADOW_KIND_PCSS)\n	#include "linearizeDepthPS"\n	#include "shadowPCSSPS"\n	#include "shadowSoftPS"\n#endif\n#if defined(SHADOW_KIND_VSM)\n	#include "shadowEVSMPS"\n#endif\n#ifdef LIT_CODE_FALLOFF_LINEAR\n	#include "falloffLinearPS"\n#endif\n#ifdef LIT_CODE_FALLOFF_SQUARED\n	#include "falloffInvSquaredPS"\n#endif\n#ifdef LIT_CODE_LIGHTS_POINT\n	#include "lightDirPointPS"\n#endif\n#ifdef LIT_CODE_LIGHTS_SPOT\n	#include "spotPS"\n#endif\n#ifdef LIT_CODE_COOKIE\n	#include "cookiePS"\n#endif\n#ifdef LIT_CLUSTERED_LIGHTS\n	#include "clusteredLightPS"\n#endif\n#ifdef LIGHT_COUNT > 0\n	#include "lightFunctionShadowPS, LIGHT_COUNT"\n	#include "lightFunctionLightPS, LIGHT_COUNT"\n#endif\n',lightmapAddPS:"\nvoid addLightMap(\n	vec3 lightmap, \n	vec3 dir, \n	vec3 worldNormal, \n	vec3 viewDir, \n	vec3 reflectionDir, \n	float gloss, \n	vec3 specularity, \n	vec3 vertexNormal, \n	mat3 tbn\n#if defined(LIT_IRIDESCENCE)\n	vec3 iridescenceFresnel, \n	float iridescenceIntensity\n#endif\n) {\n	#if defined(LIT_SPECULAR) && defined(LIT_DIR_LIGHTMAP)\n		if (dot(dir, dir) < 0.0001) {\n				dDiffuseLight += lightmap;\n		} else {\n			float vlight = saturate(dot(dir, -vertexNormal));\n			float flight = saturate(dot(dir, -worldNormal));\n			float nlight = (flight / max(vlight, 0.01)) * 0.5;\n			dDiffuseLight += lightmap * nlight * 2.0;\n			vec3 halfDir = normalize(-dir + viewDir);\n			vec3 specularLight = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);\n			#ifdef LIT_SPECULAR_FRESNEL\n				specularLight *= \n					getFresnel(dot(viewDir, halfDir), \n					gloss, \n					specularity\n				#if defined(LIT_IRIDESCENCE)\n					, iridescenceFresnel,\n					iridescenceIntensity\n				#endif\n					);\n			#endif\n			dSpecularLight += specularLight;\n		}\n	#else\n		dDiffuseLight += lightmap;\n	#endif\n}\n",lightmapPS:"\n#ifdef STD_LIGHTMAP_DIR\n	vec3 dLightmapDir;\n	uniform sampler2D texture_dirLightMap;\n#endif\nvoid getLightMap() {\n	dLightmap = vec3(1.0);\n	#ifdef STD_LIGHT_TEXTURE\n		dLightmap *= {STD_LIGHT_TEXTURE_DECODE}(texture2DBias({STD_LIGHT_TEXTURE_NAME}, {STD_LIGHT_TEXTURE_UV}, textureBias)).{STD_LIGHT_TEXTURE_CHANNEL};\n		#ifdef STD_LIGHTMAP_DIR\n			vec3 dir = texture2DBias(texture_dirLightMap, {STD_LIGHT_TEXTURE_UV}, textureBias).xyz * 2.0 - 1.0;\n			float dirDot = dot(dir, dir);\n			dLightmapDir = (dirDot > 0.001) ? dir / sqrt(dirDot) : vec3(0.0);\n		#endif\n	#endif\n	#ifdef STD_LIGHT_VERTEX\n		dLightmap *= saturate(vVertexColor.{STD_LIGHT_VERTEX_CHANNEL});\n	#endif\n}\n",lightSpecularAnisoGGXPS:"\nfloat calcLightSpecular(float gloss, vec3 worldNormal, vec3 viewDir, vec3 h, vec3 lightDirNorm, mat3 tbn) {\n	float PI = 3.141592653589793;\n	float roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n	float alphaRoughness = roughness * roughness;\n	float anisotropy = dAnisotropy;\n	vec2 direction = dAnisotropyRotation;\n	float at = mix(alphaRoughness, 1.0, anisotropy * anisotropy);\n	float ab = clamp(alphaRoughness, 0.001, 1.0);\n	vec3 anisotropicT = normalize(tbn * vec3(direction, 0.0));\n	vec3 anisotropicB = normalize(cross(tbn[2], anisotropicT));\n	float NoH = dot(worldNormal, h);\n	float ToH = dot(anisotropicT, h);\n	float BoH = dot(anisotropicB, h);\n	float a2 = at * ab;\n	vec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n	float v2 = dot(v, v);\n	float w2 = a2 / v2;\n	float D = a2 * w2 * w2 * (1.0 / PI);\n	float ToV = dot(anisotropicT, viewDir);\n	float BoV = dot(anisotropicB, viewDir);\n	float ToL = dot(anisotropicT, -lightDirNorm);\n	float BoL = dot(anisotropicB, -lightDirNorm);\n	float NoV = dot(worldNormal, viewDir);\n	float NoL = dot(worldNormal, -lightDirNorm);\n	float lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n	float lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n	float G = 0.5 / (lambdaV + lambdaL);\n	return D * G;\n}\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n	return calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);\n}\n",lightSpecularBlinnPS:"\nfloat calcLightSpecular(float gloss, vec3 worldNormal, vec3 h) {\n	float nh = max( dot( h, worldNormal ), 0.0 );\n	float specPow = exp2(gloss * 11.0);\n	specPow = max(specPow, 0.0001);\n	return pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n	return calcLightSpecular(gloss, worldNormal, h);\n}\n",lightSheenPS:"\nfloat sheenD(vec3 normal, vec3 h, float roughness) {\n	const float PI = 3.141592653589793;\n	float invR = 1.0 / (roughness * roughness);\n	float cos2h = max(dot(normal, h), 0.0);\n	cos2h *= cos2h;\n	float sin2h = max(1.0 - cos2h, 0.0078125);\n	return (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);\n}\nfloat sheenV(vec3 normal, vec3 viewDir, vec3 light) {\n	float NoV = max(dot(normal, viewDir), 0.000001);\n	float NoL = max(dot(normal, light), 0.000001);\n	return 1.0 / (4.0 * (NoL + NoV - NoL * NoV));\n}\nfloat getLightSpecularSheen(vec3 h, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float sheenGloss) {\n	float D = sheenD(worldNormal, h, sheenGloss);\n	float V = sheenV(worldNormal, viewDir, -lightDirNorm);\n	return D * V;\n}\n",linearizeDepthPS:"\n#ifndef LINEARIZE_DEPTH\n#define LINEARIZE_DEPTH\nfloat linearizeDepthWithParams(float z, vec4 cameraParams) {\n	if (cameraParams.w == 0.0)\n		return (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));\n	else\n		return cameraParams.z + z * (cameraParams.y - cameraParams.z);\n}\n#ifndef CAMERAPLANES\n	#define CAMERAPLANES\n	uniform vec4 camera_params;\n#endif\nfloat linearizeDepth(float z) {\n	return linearizeDepthWithParams(z, camera_params);\n}\n#endif\n",litForwardBackendPS:'\nvoid evaluateBackend() {\n	#ifdef LIT_SSAO\n		litArgs_ao *= texture2DLod(ssaoTexture, gl_FragCoord.xy * ssaoTextureSizeInv, 0.0).r;\n	#endif\n	#ifdef LIT_NEEDS_NORMAL\n		#ifdef LIT_SPECULAR\n			getReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);\n		#endif\n		#ifdef LIT_CLEARCOAT\n			ccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));\n		#endif\n	#endif\n	#ifdef LIT_SPECULAR_OR_REFLECTION\n		#ifdef LIT_METALNESS\n			float f0 = 1.0 / litArgs_ior;\n			f0 = (f0 - 1.0) / (f0 + 1.0);\n			f0 *= f0;\n			litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);\n			litArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);\n		#endif\n		#ifdef LIT_IRIDESCENCE\n			vec3 iridescenceFresnel = getIridescence(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);\n		#endif\n	#endif\n	#ifdef LIT_ADD_AMBIENT\n		addAmbient(litArgs_worldNormal);\n		#ifdef LIT_SPECULAR\n			dDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);\n		#endif\n		#ifdef LIT_SEPARATE_AMBIENT\n			vec3 dAmbientLight = dDiffuseLight;\n			dDiffuseLight = vec3(0);\n		#endif\n	#endif\n	#ifndef LIT_OLD_AMBIENT\n		dDiffuseLight *= material_ambient;\n	#endif\n	#ifdef LIT_AO\n		#ifndef LIT_OCCLUDE_DIRECT\n			occludeDiffuse(litArgs_ao);\n		#endif\n	#endif\n	#ifdef LIT_LIGHTMAP\n		addLightMap(\n			litArgs_lightmap, \n			litArgs_lightmapDir, \n			litArgs_worldNormal, \n			dViewDirW, \n			dReflDirW, \n			litArgs_gloss, \n			litArgs_specularity, \n			dVertexNormalW,\n			dTBN\n		#if defined(LIT_IRIDESCENCE)\n			, iridescenceFresnel,\n			litArgs_iridescence_intensity\n		#endif\n		);\n	#endif\n	#ifdef LIT_LIGHTING || LIT_REFLECTIONS\n		#ifdef LIT_REFLECTIONS\n			#ifdef LIT_CLEARCOAT\n				addReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);\n			\n				#ifdef LIT_SPECULAR_FRESNEL\n					ccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));\n					ccReflection *= ccFresnel;\n				#else\n					ccFresnel = 0.0;\n				#endif\n			#endif\n			#ifdef LIT_SPECULARITY_FACTOR\n				ccReflection *= litArgs_specularityFactor;\n			#endif\n			#ifdef LIT_SHEEN\n				addReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);\n			#endif\n			addReflection(dReflDirW, litArgs_gloss);\n			#ifdef LIT_FRESNEL_MODEL\n				dReflection.rgb *= getFresnel(\n					dot(dViewDirW, litArgs_worldNormal), \n					litArgs_gloss, \n					litArgs_specularity\n				#if defined(LIT_IRIDESCENCE)\n					, iridescenceFresnel,\n					litArgs_iridescence_intensity\n				#endif\n					);\n			#else\n				dReflection.rgb *= litArgs_specularity;\n			#endif\n			#ifdef LIT_SPECULARITY_FACTOR\n				dReflection.rgb *= litArgs_specularityFactor;\n			#endif\n		#endif\n		#ifdef AREA_LIGHTS\n			dSpecularLight *= litArgs_specularity;\n			#ifdef LIT_SPECULAR\n				calcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);\n			#endif\n		#endif\n		\n		#ifdef LIGHT_COUNT > 0\n			#include "lightEvaluationPS, LIGHT_COUNT"\n		#endif\n		#ifdef LIT_CLUSTERED_LIGHTS\n			addClusteredLights(litArgs_worldNormal, dViewDirW, dReflDirW,\n				#if defined(LIT_CLEARCOAT)\n						ccReflDirW,\n				#endif\n						litArgs_gloss, litArgs_specularity, dVertexNormalW, dTBN, \n				#if defined(LIT_IRIDESCENCE)\n						iridescenceFresnel,\n				#endif\n						litArgs_clearcoat_worldNormal, litArgs_clearcoat_gloss, litArgs_sheen_gloss, litArgs_iridescence_intensity\n			);\n		#endif\n		#ifdef AREA_LIGHTS\n			#ifdef LIT_CLEARCOAT\n				litArgs_clearcoat_specularity = 1.0;\n			#endif\n			#ifdef LIT_SPECULAR\n				litArgs_specularity = vec3(1);\n			#endif\n		#endif\n		#ifdef LIT_REFRACTION\n			addRefraction(\n				litArgs_worldNormal, \n				dViewDirW, \n				litArgs_thickness, \n				litArgs_gloss, \n				litArgs_specularity, \n				litArgs_albedo, \n				litArgs_transmission,\n				litArgs_ior,\n				litArgs_dispersion\n				#if defined(LIT_IRIDESCENCE)\n					, iridescenceFresnel, \n					litArgs_iridescence_intensity\n				#endif\n			);\n		#endif\n	#endif\n	#ifdef LIT_AO\n		#ifdef LIT_OCCLUDE_DIRECT\n			occludeDiffuse(litArgs_ao);\n		#endif\n		#if LIT_OCCLUDE_SPECULAR != NONE\n			occludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);\n		#endif\n	#endif\n	#ifdef LIT_SPECULARITY_FACTOR\n		dSpecularLight *= litArgs_specularityFactor;\n	#endif\n	#if !defined(LIT_OPACITY_FADES_SPECULAR)\n		#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == PREMULTIPLIED\n			float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3( 0.2126, 0.7152, 0.0722 ));\n			#ifdef LIT_CLEARCOAT\n				specLum += dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection * litArgs_clearcoat_specularity, vec3( 0.2126, 0.7152, 0.0722 ));\n			#endif\n			litArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);\n		#endif\n		litArgs_opacity *= material_alphaFade;\n	#endif\n	#ifdef LIT_LIGHTMAP_BAKING\n		#ifdef LIT_LIGHTMAP_BAKING_COLOR\n			#include "bakeLmEndPS"\n		#endif\n		#ifdef LIT_LIGHTMAP_BAKING_DIR\n			#include "bakeDirLmEndPS"\n		#endif\n	#else\n		#include "endPS"\n		#include "outputAlphaPS"\n	#endif\n	#ifdef LIT_MSDF\n		gl_FragColor = applyMsdf(gl_FragColor);\n	#endif\n	#include "outputPS"\n	#include "debugOutputPS"\n	#ifdef LIT_SHADOW_CATCHER\n		gl_FragColor.rgb = vec3(dShadowCatcher);\n	#endif\n}\n',litForwardDeclarationPS:'\nvec3 sReflection;\nvec3 dVertexNormalW;\nvec3 dTangentW;\nvec3 dBinormalW;\nvec3 dViewDirW;\nvec3 dReflDirW;\nvec3 ccReflDirW;\nvec3 dLightDirNormW;\nfloat dAtten;\nmat3 dTBN;\nvec4 dReflection;\nvec3 dDiffuseLight;\nvec3 dSpecularLight;\nfloat ccFresnel;\nvec3 ccReflection;\nvec3 ccSpecularLight;\nfloat ccSpecularityNoFres;\nvec3 sSpecularLight;\n#ifdef LIT_DISPERSION\n	uniform float material_dispersion;\n#endif\n#ifndef LIT_OPACITY_FADES_SPECULAR\n	uniform float material_alphaFade;\n#endif\n#ifdef LIT_SSAO\n	uniform sampler2D ssaoTexture;\n	uniform vec2 ssaoTextureSizeInv;\n#endif\n#ifdef LIT_SHADOW_CATCHER\n	float dShadowCatcher = 1.0;\n#endif\n#if LIGHT_COUNT > 0\n	#include "lightDeclarationPS, LIGHT_COUNT"\n#endif\n#ifdef LIT_SPECULAR\n	#if LIT_FRESNEL_MODEL == NONE && !defined(LIT_REFLECTIONS) && !defined(LIT_DIFFUSE_MAP) \n		#define LIT_OLD_AMBIENT\n	#endif\n#endif\n#ifdef STD_LIGHTMAP_DIR\n	uniform float bakeDir;\n#endif\n#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT\n	uniform float ambientBakeOcclusionContrast;\n	uniform float ambientBakeOcclusionBrightness;\n#endif\n',litForwardMainPS:'\nvoid main(void) {\n	#include "litUserMainStartPS"\n	dReflection = vec4(0);\n	#ifdef LIT_CLEARCOAT\n		ccSpecularLight = vec3(0);\n		ccReflection = vec3(0);\n	#endif\n	#if LIT_NONE_SLICE_MODE == SLICED\n		#include "startNineSlicedPS"\n	#elif LIT_NONE_SLICE_MODE == TILED\n		#include "startNineSlicedTiledPS"\n	#endif\n	#ifdef LIT_NEEDS_NORMAL\n		dVertexNormalW = normalize(vNormalW);\n		#ifdef LIT_TANGENTS\n			#if defined(LIT_HEIGHTS) || defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS) || defined(LIT_GGX_SPECULAR)\n				dTangentW = vTangentW;\n				dBinormalW = vBinormalW;\n			#endif\n		#endif\n		getViewDir();\n		#ifdef LIT_TBN\n			getTBN(dTangentW, dBinormalW, dVertexNormalW);\n			#ifdef LIT_TWO_SIDED_LIGHTING\n				handleTwoSidedLighting();\n			#endif\n		#endif\n	#endif\n	evaluateFrontend();\n	#include "debugProcessFrontendPS"\n	evaluateBackend();\n	#include "litUserMainEndPS"\n}\n',litForwardPostCodePS:'\n#ifdef LIT_NEEDS_NORMAL\n	#include "cubeMapRotatePS"\n	#include "cubeMapProjectPS"\n	#include "envProcPS"\n#endif\n#ifdef LIT_SPECULAR_OR_REFLECTION\n	#ifdef LIT_METALNESS\n		#include "metalnessModulatePS"\n	#endif\n	#if LIT_FRESNEL_MODEL == SCHLICK\n		#include "fresnelSchlickPS"\n	#endif\n	#ifdef LIT_IRIDESCENCE\n		#include "iridescenceDiffractionPS"\n	#endif\n#endif\n#ifdef LIT_AO\n	#include "aoDiffuseOccPS"\n	#include "aoSpecOccPS"\n#endif\n#if LIT_REFLECTION_SOURCE == ENVATLASHQ\n	#include "envAtlasPS"\n	#include "reflectionEnvHQPS"\n#elif LIT_REFLECTION_SOURCE == ENVATLAS\n	#include "envAtlasPS"\n	#include "reflectionEnvPS"\n#elif LIT_REFLECTION_SOURCE == CUBEMAP\n	#include "reflectionCubePS"\n#elif LIT_REFLECTION_SOURCE == SPHEREMAP\n	#include "reflectionSpherePS"\n#endif\n#ifdef LIT_REFLECTIONS\n	#ifdef LIT_CLEARCOAT\n		#include "reflectionCCPS"\n	#endif\n	#ifdef LIT_SHEEN\n		#include "reflectionSheenPS"\n	#endif\n#endif\n#ifdef LIT_REFRACTION\n	#if defined(LIT_DYNAMIC_REFRACTION)\n		#include "refractionDynamicPS"\n	#elif defined(LIT_REFLECTIONS)\n		#include "refractionCubePS"\n	#endif\n#endif\n#ifdef LIT_SHEEN\n	#include "lightSheenPS"\n#endif\nuniform vec3 material_ambient;\n#ifdef LIT_SPECULAR\n	#ifdef LIT_LIGHTING\n		#ifdef LIT_GGX_SPECULAR\n			#include "lightSpecularAnisoGGXPS"\n		#else\n			#include "lightSpecularBlinnPS"\n		#endif\n	#endif\n#endif\n#include "combinePS"\n#ifdef LIT_LIGHTMAP\n	#include "lightmapAddPS"\n#endif\n#ifdef LIT_ADD_AMBIENT\n	#include "ambientPS"\n#endif\n#ifdef LIT_MSDF\n	#include "msdfPS"\n#endif\n#ifdef LIT_NEEDS_NORMAL\n	#include "viewDirPS"\n	#ifdef LIT_SPECULAR\n		#ifdef LIT_GGX_SPECULAR\n			#include "reflDirAnisoPS"\n		#else\n			#include "reflDirPS"\n		#endif\n	#endif\n#endif\n#include "lightingPS"\n',litForwardPreCodePS:'\n#include "basePS"\n#include "sphericalPS"\n#include "decodePS"\n#include "gammaPS"\n#include "tonemappingPS"\n#include "fogPS"\n#if LIT_NONE_SLICE_MODE == SLICED\n	#include "baseNineSlicedPS"\n#elif LIT_NONE_SLICE_MODE == TILED\n	#include "baseNineSlicedTiledPS"\n#endif\n#ifdef LIT_TBN\n	#include "TBNPS"\n	#ifdef LIT_TWO_SIDED_LIGHTING\n		#include "twoSidedLightingPS"\n	#endif\n#endif\n',litMainPS:'\n#include "varyingsPS"\n#include "litUserDeclarationPS"\n#include "frontendDeclPS"\n#if defined(PICK_PASS) || defined(PREPASS_PASS)\n	#include "frontendCodePS"\n	#include "litUserCodePS"\n	#include "litOtherMainPS"\n#elif defined(SHADOW_PASS)\n	#include "frontendCodePS"\n	#include "litUserCodePS"\n	#include "litShadowMainPS"\n#else\n	#include "litForwardDeclarationPS"\n	#include "litForwardPreCodePS"\n	#include "frontendCodePS"\n	#include "litForwardPostCodePS"\n	#include "litForwardBackendPS"\n	#include "litUserCodePS"\n	#include "litForwardMainPS"\n#endif\n',litMainVS:'\n#include "varyingsVS"\n#include  "litUserDeclarationVS"\n#ifdef VERTEX_COLOR\n	attribute vec4 vertex_color;\n#endif\n#ifdef NINESLICED\n	varying vec2 vMask;\n	varying vec2 vTiledUv;\n	uniform mediump vec4 innerOffset;\n	uniform mediump vec2 outerScale;\n	uniform mediump vec4 atlasRect;\n#endif\nvec3 dPositionW;\nmat4 dModelMatrix;\n#include "transformCoreVS"\n#ifdef UV0\n	attribute vec2 vertex_texCoord0;\n	#include "uv0VS"\n#endif\n#ifdef UV1\n	attribute vec2 vertex_texCoord1;\n	#include "uv1VS"\n#endif\n#ifdef LINEAR_DEPTH\n	#ifndef VIEWMATRIX\n	#define VIEWMATRIX\n		uniform mat4 matrix_view;\n	#endif\n#endif\n#include "transformVS"\n#ifdef NORMALS\n	#include "normalCoreVS"\n	#include "normalVS"\n#endif\n#ifdef TANGENTS\n	attribute vec4 vertex_tangent;\n#endif\n#include "uvTransformUniformsPS, UV_TRANSFORMS_COUNT"\n#ifdef MSDF\n	#include "msdfVS"\n#endif\n#include  "litUserCodeVS"\nvoid main(void) {\n	#include "litUserMainStartVS"\n	gl_PointSize = 1.0;\n	gl_Position = getPosition();\n	vPositionW = getWorldPosition();\n	#ifdef NORMALS\n		vNormalW = getNormal();\n	#endif\n	#ifdef TANGENTS\n		vTangentW = normalize(dNormalMatrix * vertex_tangent.xyz);\n		vBinormalW = cross(vNormalW, vTangentW) * vertex_tangent.w;\n	#elif defined(GGX_SPECULAR)\n		vObjectSpaceUpW = normalize(dNormalMatrix * vec3(0, 1, 0));\n	#endif\n	#ifdef UV0\n		vec2 uv0 = getUv0();\n		#ifdef UV0_UNMODIFIED\n			vUv0 = uv0;\n		#endif\n	#endif\n	#ifdef UV1\n		vec2 uv1 = getUv1();\n		#ifdef UV1_UNMODIFIED\n			vUv1 = uv1;\n		#endif\n	#endif\n	#include "uvTransformVS, UV_TRANSFORMS_COUNT"\n	#ifdef VERTEX_COLOR\n		vVertexColor = vertex_color;\n	#endif\n	#ifdef LINEAR_DEPTH\n		vLinearDepth = -(matrix_view * vec4(vPositionW, 1.0)).z;\n	#endif\n	#ifdef MSDF\n		unpackMsdfParams();\n	#endif\n	#include "litUserMainEndVS"\n}\n',litOtherMainPS:'\n#ifdef PICK_PASS\n	#include "pickPS"\n#endif\n#ifdef PREPASS_PASS\n	#include "floatAsUintPS"\n#endif\nvoid main(void) {\n	#include "litUserMainStartPS"\n	evaluateFrontend();\n	#ifdef PICK_PASS\n		gl_FragColor = getPickOutput();\n	#endif\n	#ifdef PREPASS_PASS\n		gl_FragColor = float2vec4(vLinearDepth);\n	#endif\n	#include "litUserMainEndPS"\n}\n',litShaderArgsPS:"\nvec3 litArgs_albedo;\nfloat litArgs_opacity;\nvec3 litArgs_emission;\nvec3 litArgs_worldNormal;\nfloat litArgs_ao;\nvec3 litArgs_lightmap;\nvec3 litArgs_lightmapDir;\nfloat litArgs_metalness;\nvec3 litArgs_specularity;\nfloat litArgs_specularityFactor;\nfloat litArgs_gloss;\nfloat litArgs_sheen_gloss;\nvec3 litArgs_sheen_specularity;\nfloat litArgs_transmission;\nfloat litArgs_thickness;\nfloat litArgs_ior;\nfloat litArgs_dispersion;\nfloat litArgs_iridescence_intensity;\nfloat litArgs_iridescence_thickness;\nvec3 litArgs_clearcoat_worldNormal;\nfloat litArgs_clearcoat_specularity;\nfloat litArgs_clearcoat_gloss;\n",litShaderCorePS:'\n	#if LIT_NONE_SLICE_MODE == TILED\n		const float textureBias = -1000.0;\n	#else\n		uniform float textureBias;\n	#endif\n	#include "litShaderArgsPS"\n',litShadowMainPS:'\n#if LIGHT_TYPE != DIRECTIONAL\n	uniform vec3 view_position;\n	uniform float light_radius;\n#endif\n#if SHADOW_TYPE == PCSS_32F\n	#include "linearizeDepthPS"\n#endif\nvoid main(void) {\n	#include "litUserMainStartPS"\n	evaluateFrontend();\n	#ifdef PERSPECTIVE_DEPTH\n		float depth = gl_FragCoord.z;\n		#if SHADOW_TYPE == PCSS_32F\n			#if LIGHT_TYPE != DIRECTIONAL\n				depth = linearizeDepthWithParams(depth, camera_params);\n			#endif\n		#endif\n	#else\n		float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n		#define MODIFIED_DEPTH\n	#endif\n	#if SHADOW_TYPE == VSM_16F || SHADOW_TYPE == VSM_32F\n		#if SHADOW_TYPE == VSM_32F\n			float exponent = 15.0;\n		#else\n			float exponent = 5.54;\n		#endif\n		depth = 2.0 * depth - 1.0;\n		depth =  exp(exponent * depth);\n		gl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n	#else\n		#if SHADOW_TYPE == PCSS_32F\n			gl_FragColor.r = depth;\n		#else\n			#ifdef MODIFIED_DEPTH\n				gl_FragDepth = depth;\n			#endif\n			gl_FragColor = vec4(1.0);\n		#endif\n	#endif\n	#include "litUserMainEndPS"\n}\n',litUserDeclarationPS:"",litUserDeclarationVS:"",litUserCodePS:"",litUserCodeVS:"",litUserMainStartPS:"",litUserMainStartVS:"",litUserMainEndPS:"",litUserMainEndVS:"",ltcPS:"\nmat3 transposeMat3( const in mat3 m ) {\n	mat3 tmp;\n	tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n	tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n	tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n	return tmp;\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n	const float LUT_SIZE = 64.0;\n	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n	const float LUT_BIAS = 0.5 / LUT_SIZE;\n	float dotNV = saturate( dot( N, V ) );\n	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n	uv = uv * LUT_SCALE + LUT_BIAS;\n	return uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n	float l = length( f );\n	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n	float x = dot( v1, v2 );\n	float y = abs( x );\n	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n	float b = 3.4175940 + ( 4.1616724 + y ) * y;\n	float v = a / b;\n	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n	return cross( v1, v2 ) * theta_sintheta;\n}\nstruct Coords {\n	vec3 coord0;\n	vec3 coord1;\n	vec3 coord2;\n	vec3 coord3;\n};\nfloat LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {\n	vec3 v1 = rectCoords.coord1 - rectCoords.coord0;\n	vec3 v2 = rectCoords.coord3 - rectCoords.coord0;\n	\n	vec3 lightNormal = cross( v1, v2 );\n	float factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n	vec3 T1, T2;\n	T1 = normalize( V - N * dot( V, N ) );\n	T2 =  factor * cross( N, T1 );\n	mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n	vec3 coords[ 4 ];\n	coords[ 0 ] = mat * ( rectCoords.coord0 - P );\n	coords[ 1 ] = mat * ( rectCoords.coord1 - P );\n	coords[ 2 ] = mat * ( rectCoords.coord2 - P );\n	coords[ 3 ] = mat * ( rectCoords.coord3 - P );\n	coords[ 0 ] = normalize( coords[ 0 ] );\n	coords[ 1 ] = normalize( coords[ 1 ] );\n	coords[ 2 ] = normalize( coords[ 2 ] );\n	coords[ 3 ] = normalize( coords[ 3 ] );\n	vec3 vectorFormFactor = vec3( 0.0 );\n	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n	return result;\n}\nCoords dLTCCoords;\nCoords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n	Coords coords;\n	coords.coord0 = lightPos + halfWidth - halfHeight;\n	coords.coord1 = lightPos - halfWidth - halfHeight;\n	coords.coord2 = lightPos - halfWidth + halfHeight;\n	coords.coord3 = lightPos + halfWidth + halfHeight;\n	return coords;\n}\nfloat dSphereRadius;\nCoords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n	dSphereRadius = max(length(halfWidth), length(halfHeight));\n	vec3 f = reflect(normalize(lightPos - view_position), vNormalW);\n	vec3 w = normalize(cross(f, halfHeight));\n	vec3 h = normalize(cross(f, w));\n	return getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);\n}\nvec2 dLTCUV;\n#ifdef LIT_CLEARCOAT\n	vec2 ccLTCUV;\n#endif\nvec2 getLTCLightUV(float gloss, vec3 worldNormal, vec3 viewDir)\n{\n	float roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n	return LTC_Uv( worldNormal, viewDir, roughness );\n}\nvec3 dLTCSpecFres;\n#ifdef LIT_CLEARCOAT\n	vec3 ccLTCSpecFres;\n#endif\nvec3 getLTCLightSpecFres(vec2 uv, vec3 specularity)\n{\n	vec4 t2 = texture2DLod(areaLightsLutTex2, uv, 0.0);\n	return specularity * t2.x + ( vec3( 1.0 ) - specularity) * t2.y;\n}\nvoid calcLTCLightValues(float gloss, vec3 worldNormal, vec3 viewDir, vec3 specularity, float clearcoatGloss, vec3 clearcoatWorldNormal, float clearcoatSpecularity)\n{\n	dLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);\n	dLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity); \n#ifdef LIT_CLEARCOAT\n	ccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);\n	ccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(clearcoatSpecularity));\n#endif\n}\nvoid calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight) {\n	dLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n}\nvoid calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight) {\n	calcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nvoid calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight) {\n	dLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n}\nvec3 SolveCubic(vec4 Coefficient)\n{\n	float pi = 3.14159;\n	Coefficient.xyz /= Coefficient.w;\n	Coefficient.yz /= 3.0;\n	float A = Coefficient.w;\n	float B = Coefficient.z;\n	float C = Coefficient.y;\n	float D = Coefficient.x;\n	vec3 Delta = vec3(\n		-Coefficient.z * Coefficient.z + Coefficient.y,\n		-Coefficient.y * Coefficient.z + Coefficient.x,\n		dot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)\n	);\n	float Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);\n	vec2 xlc, xsc;\n	{\n		float A_a = 1.0;\n		float C_a = Delta.x;\n		float D_a = -2.0 * B * Delta.x + Delta.y;\n		float Theta = atan(sqrt(Discriminant), -D_a) / 3.0;\n		float x_1a = 2.0 * sqrt(-C_a) * cos(Theta);\n		float x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);\n		float xl;\n		if ((x_1a + x_3a) > 2.0 * B)\n			xl = x_1a;\n		else\n			xl = x_3a;\n		xlc = vec2(xl - B, A);\n	}\n	{\n		float A_d = D;\n		float C_d = Delta.z;\n		float D_d = -D * Delta.y + 2.0 * C * Delta.z;\n		float Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;\n		float x_1d = 2.0 * sqrt(-C_d) * cos(Theta);\n		float x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);\n		float xs;\n		if (x_1d + x_3d < 2.0 * C)\n			xs = x_1d;\n		else\n			xs = x_3d;\n		xsc = vec2(-D, xs + C);\n	}\n	float E =  xlc.y * xsc.y;\n	float F = -xlc.x * xsc.y - xlc.y * xsc.x;\n	float G =  xlc.x * xsc.x;\n	vec2 xmc = vec2(C * F - B * G, -B * F + C * E);\n	vec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n	if (Root.x < Root.y && Root.x < Root.z)\n		Root.xyz = Root.yxz;\n	else if (Root.z < Root.x && Root.z < Root.y)\n		Root.xyz = Root.xzy;\n	return Root;\n}\nfloat LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)\n{\n	vec3 T1 = normalize(V - N * dot(V, N));\n	vec3 T2 = cross(N, T1);\n	mat3 R = transposeMat3( mat3( T1, T2, N ) );\n	vec3 L_[ 3 ];\n	L_[ 0 ] = R * ( points.coord0 - P );\n	L_[ 1 ] = R * ( points.coord1 - P );\n	L_[ 2 ] = R * ( points.coord2 - P );\n	vec3 C  = 0.5 * (L_[0] + L_[2]);\n	vec3 V1 = 0.5 * (L_[1] - L_[2]);\n	vec3 V2 = 0.5 * (L_[1] - L_[0]);\n	C  = Minv * C;\n	V1 = Minv * V1;\n	V2 = Minv * V2;\n	float a, b;\n	float d11 = dot(V1, V1);\n	float d22 = dot(V2, V2);\n	float d12 = dot(V1, V2);\n	if (abs(d12) / sqrt(d11 * d22) > 0.0001)\n	{\n		float tr = d11 + d22;\n		float det = -d12 * d12 + d11 * d22;\n		det = sqrt(det);\n		float u = 0.5 * sqrt(tr - 2.0 * det);\n		float v = 0.5 * sqrt(tr + 2.0 * det);\n		float e_max = (u + v) * (u + v);\n		float e_min = (u - v) * (u - v);\n		vec3 V1_, V2_;\n		if (d11 > d22)\n		{\n			V1_ = d12 * V1 + (e_max - d11) * V2;\n			V2_ = d12 * V1 + (e_min - d11) * V2;\n		}\n		else\n		{\n			V1_ = d12*V2 + (e_max - d22)*V1;\n			V2_ = d12*V2 + (e_min - d22)*V1;\n		}\n		a = 1.0 / e_max;\n		b = 1.0 / e_min;\n		V1 = normalize(V1_);\n		V2 = normalize(V2_);\n	}\n	else\n	{\n		a = 1.0 / dot(V1, V1);\n		b = 1.0 / dot(V2, V2);\n		V1 *= sqrt(a);\n		V2 *= sqrt(b);\n	}\n	vec3 V3 = normalize(cross(V1, V2));\n	if (dot(C, V3) < 0.0)\n		V3 *= -1.0;\n	float L  = dot(V3, C);\n	float x0 = dot(V1, C) / L;\n	float y0 = dot(V2, C) / L;\n	float E1 = inversesqrt(a);\n	float E2 = inversesqrt(b);\n	a *= L * L;\n	b *= L * L;\n	float c0 = a * b;\n	float c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;\n	float c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);\n	float c3 = 1.0;\n	vec3 roots = SolveCubic(vec4(c0, c1, c2, c3));\n	float e1 = roots.x;\n	float e2 = roots.y;\n	float e3 = roots.z;\n	vec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);\n	mat3 rotate = mat3(V1, V2, V3);\n	avgDir = rotate * avgDir;\n	avgDir = normalize(avgDir);\n	float L1 = sqrt(-e2 / e3);\n	float L2 = sqrt(-e2 / e1);\n	float formFactor = max(0.0, L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2)));\n	\n	const float LUT_SIZE = 64.0;\n	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n	const float LUT_BIAS = 0.5 / LUT_SIZE;\n	vec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);\n	uv = uv*LUT_SCALE + LUT_BIAS;\n	float scale = texture2DLod(areaLightsLutTex2, uv, 0.0).w;\n	return formFactor*scale;\n}\nfloat FixNan(float value) {\n	#ifdef WEBGPU\n		return value != value ? 0.0 : value;\n	#else\n		return isnan(value) ? 0.0 : value;\n	#endif\n}\nfloat getRectLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getDiskLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n	return FixNan(LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords ));\n}\nfloat getSphereLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n	float falloff = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);\n	return FixNan(getLightDiffuse(worldNormal, viewDir, lightDirNorm) * falloff);\n}\nmat3 getLTCLightInvMat(vec2 uv)\n{\n	vec4 t1 = texture2DLod(areaLightsLutTex1, uv, 0.0);\n	return mat3(\n		vec3( t1.x, 0, t1.y ),\n		vec3(	0, 1,	0 ),\n		vec3( t1.z, 0, t1.w )\n	);\n}\nfloat calcRectLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {\n	mat3 mInv = getLTCLightInvMat(uv);\n	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfloat getRectLightSpecular(vec3 worldNormal, vec3 viewDir) {\n	return calcRectLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfloat calcDiskLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {\n	mat3 mInv = getLTCLightInvMat(uv);\n	return LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfloat getDiskLightSpecular(vec3 worldNormal, vec3 viewDir) {\n	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfloat getSphereLightSpecular(vec3 worldNormal, vec3 viewDir) {\n	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\n",metalnessPS:"\n#ifdef STD_METALNESS_CONSTANT\nuniform float material_metalness;\n#endif\nvoid getMetalness() {\n	float metalness = 1.0;\n	#ifdef STD_METALNESS_CONSTANT\n	metalness *= material_metalness;\n	#endif\n	#ifdef STD_METALNESS_TEXTURE\n	metalness *= texture2DBias({STD_METALNESS_TEXTURE_NAME}, {STD_METALNESS_TEXTURE_UV}, textureBias).{STD_METALNESS_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_METALNESS_VERTEX\n	metalness *= saturate(vVertexColor.{STD_METALNESS_VERTEX_CHANNEL});\n	#endif\n	dMetalness = metalness;\n}\n",metalnessModulatePS:"\nvec3 getSpecularModulate(in vec3 specularity, in vec3 albedo, in float metalness, in float f0) {\n	vec3 dielectricF0 = f0 * specularity;\n	return mix(dielectricF0, albedo, metalness);\n}\nvec3 getAlbedoModulate(in vec3 albedo, in float metalness) {\n	return albedo * (1.0 - metalness);\n}\n",morphPS:"\n	varying vec2 uv0;\n	uniform sampler2DArray morphTexture;\n	uniform highp float morphFactor[{MORPH_TEXTURE_MAX_COUNT}];\n	uniform highp uint morphIndex[{MORPH_TEXTURE_MAX_COUNT}];\n	uniform int count;\n	#ifdef MORPH_INT\n		uniform vec3 aabbSize;\n		uniform vec3 aabbMin;\n	#endif\n	void main (void) {\n		highp vec3 color = vec3(0, 0, 0);\n		ivec2 pixelCoords = ivec2(uv0 * vec2(textureSize(morphTexture, 0).xy));\n		\n		for (int i = 0; i < count; i++) {\n			uint textureIndex = morphIndex[i];\n			vec3 delta = texelFetch(morphTexture, ivec3(pixelCoords, int(textureIndex)), 0).xyz;\n			color += morphFactor[i] * delta;\n		}\n		#ifdef MORPH_INT\n			color = (color - aabbMin) / aabbSize * 65535.0;\n			gl_FragColor = uvec4(color, 1u);\n		#else\n			gl_FragColor = vec4(color, 1.0);\n		#endif\n	}\n",morphVS:"\n	attribute vec2 vertex_position;\n	varying vec2 uv0;\n	void main(void) {\n		gl_Position = vec4(vertex_position, 0.5, 1.0);\n		uv0 = vertex_position.xy * 0.5 + 0.5;\n	}\n",msdfPS:"\nuniform sampler2D texture_msdfMap;\nfloat median(float r, float g, float b) {\n	return max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n	return (v - min) / (max - min);\n}\nuniform float font_sdfIntensity;\nuniform float font_pxrange;\nuniform float font_textureWidth;\n#ifndef LIT_MSDF_TEXT_ATTRIBUTE\n	uniform vec4 outline_color;\n	uniform float outline_thickness;\n	uniform vec4 shadow_color;\n	uniform vec2 shadow_offset;\n#else\n	varying vec4 outline_color;\n	varying float outline_thickness;\n	varying vec4 shadow_color;\n	varying vec2 shadow_offset;\n#endif\nvec4 applyMsdf(vec4 color) {\n	color.rgb = gammaCorrectInput(color.rgb);\n	vec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n	vec2 uvShdw = vUv0 - shadow_offset;\n	vec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n	float sigDist = median(tsample.r, tsample.g, tsample.b);\n	float sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n	float smoothingMax = 0.2;\n	vec2 w = fwidth(vUv0);\n	float smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);\n	float mapMin = 0.05;\n	float mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n	float sigDistInner = map(mapMin, mapMax, sigDist);\n	float sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n	sigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n	float center = 0.5;\n	float inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n	float outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n	float shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n	vec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n	tcolor = mix(tcolor, color, inside);\n	vec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n	tcolor = mix(scolor, tcolor, outline);\n	tcolor.rgb = gammaCorrectOutput(tcolor.rgb);\n	\n	return tcolor;\n}\n",msdfVS:"\nattribute vec3 vertex_outlineParameters;\nattribute vec3 vertex_shadowParameters;\nvarying vec4 outline_color;\nvarying float outline_thickness;\nvarying vec4 shadow_color;\nvarying vec2 shadow_offset;\nvoid unpackMsdfParams() {\n	vec3 little = mod(vertex_outlineParameters, 256.);\n	vec3 big = (vertex_outlineParameters - little) / 256.;\n	outline_color.rb = little.xy / 255.;\n	outline_color.ga = big.xy / 255.;\n	outline_thickness = little.z / 255. * 0.2;\n	little = mod(vertex_shadowParameters, 256.);\n	big = (vertex_shadowParameters - little) / 256.;\n	shadow_color.rb = little.xy / 255.;\n	shadow_color.ga = big.xy / 255.;\n	shadow_offset = (vec2(little.z, big.z) / 127. - 1.) * 0.005;\n}\n",normalVS:"\nmat3 dNormalMatrix;\nvec3 getNormal() {\n	dNormalMatrix = getNormalMatrix(dModelMatrix);\n	vec3 localNormal = getLocalNormal(vertex_normal);\n	return normalize(dNormalMatrix * localNormal);\n}\n",normalCoreVS:"\nattribute vec3 vertex_normal;\nuniform mat3 matrix_normal;\n#ifdef MORPHING_NORMAL\n	#ifdef MORPHING_INT\n		uniform highp usampler2D morphNormalTex;\n	#else\n		uniform highp sampler2D morphNormalTex;\n	#endif\n#endif\nvec3 getLocalNormal(vec3 vertexNormal) {\n	vec3 localNormal = vertex_normal;\n	#ifdef MORPHING_NORMAL\n		ivec2 morphUV = getTextureMorphCoords();\n		#ifdef MORPHING_INT\n			vec3 morphNormal = vec3(texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz) / 65535.0 * 2.0 - 1.0;\n		#else\n			vec3 morphNormal = texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz;\n		#endif\n		localNormal += morphNormal;\n	#endif\n	return localNormal;\n}\n#if defined(SKIN) || defined(BATCH)\n	mat3 getNormalMatrix(mat4 modelMatrix) {\n		return mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n	}\n#elif defined(INSTANCING)\n	mat3 getNormalMatrix(mat4 modelMatrix) {\n		return mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n	}\n#else\n	mat3 getNormalMatrix(mat4 modelMatrix) {\n		return matrix_normal;\n	}\n#endif\n",normalMapPS:"\n#ifdef STD_NORMAL_TEXTURE\n	uniform float material_bumpiness;\n#endif\n#ifdef STD_NORMALDETAIL_TEXTURE\n	uniform float material_normalDetailMapBumpiness;\n	vec3 blendNormals(vec3 n1, vec3 n2) {\n		n1 += vec3(0, 0, 1);\n		n2 *= vec3(-1, -1, 1);\n		return n1 * dot(n1, n2) / n1.z - n2;\n	}\n#endif\nvoid getNormal() {\n#ifdef STD_NORMAL_TEXTURE\n	vec3 normalMap = {STD_NORMAL_TEXTURE_DECODE}(texture2DBias({STD_NORMAL_TEXTURE_NAME}, {STD_NORMAL_TEXTURE_UV}, textureBias));\n	normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);\n	#ifdef STD_NORMALDETAIL_TEXTURE\n		vec3 normalDetailMap = {STD_NORMALDETAIL_TEXTURE_DECODE}(texture2DBias({STD_NORMALDETAIL_TEXTURE_NAME}, {STD_NORMALDETAIL_TEXTURE_UV}, textureBias));\n		normalDetailMap = mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness);\n		normalMap = blendNormals(normalMap, normalDetailMap);\n	#endif\n	dNormalW = normalize(dTBN * normalMap);\n#else\n	dNormalW = dVertexNormalW;\n#endif\n}\n",opacityPS:"\nuniform float material_opacity;\nvoid getOpacity() {\n	dAlpha = material_opacity;\n	#ifdef STD_OPACITY_TEXTURE\n	dAlpha *= texture2DBias({STD_OPACITY_TEXTURE_NAME}, {STD_OPACITY_TEXTURE_UV}, textureBias).{STD_OPACITY_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_OPACITY_VERTEX\n	dAlpha *= clamp(vVertexColor.{STD_OPACITY_VERTEX_CHANNEL}, 0.0, 1.0);\n	#endif\n}\n",opacityDitherPS:'\n#if STD_OPACITY_DITHER == BAYER8\n	#include "bayerPS"\n#endif\nuniform vec4 blueNoiseJitter;\n#if STD_OPACITY_DITHER == BLUENOISE\n	uniform sampler2D blueNoiseTex32;\n#endif\nvoid opacityDither(float alpha, float id) {\n	#if STD_OPACITY_DITHER == BAYER8\n		float noise = bayer8(floor(mod(gl_FragCoord.xy + blueNoiseJitter.xy + id, 8.0))) / 64.0;\n	#else\n		#if STD_OPACITY_DITHER == BLUENOISE\n			vec2 uv = fract(gl_FragCoord.xy / 32.0 + blueNoiseJitter.xy + id);\n			float noise = texture2DLod(blueNoiseTex32, uv, 0.0).y;\n		#endif\n		#if STD_OPACITY_DITHER == IGNNOISE\n			vec3 magic = vec3(0.06711056, 0.00583715, 52.9829189);\n			float noise = fract(magic.z * fract(dot(gl_FragCoord.xy + blueNoiseJitter.xy + id, magic.xy)));\n		#endif\n	#endif\n	noise = pow(noise, 2.2);\n	if (alpha < noise)\n		discard;\n}\n',outputPS:"\n",outputAlphaPS:"\n#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == ADDITIVEALPHA || defined(LIT_ALPHA_TO_COVERAGE)\n	gl_FragColor.a = litArgs_opacity;\n#elif LIT_BLEND_TYPE == PREMULTIPLIED\n	gl_FragColor.rgb *= litArgs_opacity;\n	gl_FragColor.a = litArgs_opacity;\n#else\n	gl_FragColor.a = 1.0;\n#endif\n",outputTex2DPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n	gl_FragColor = texture2D(source, vUv0);\n}\n",sheenPS:"\nuniform vec3 material_sheen;\nvoid getSheen() {\n	vec3 sheenColor = material_sheen;\n	#ifdef STD_SHEEN_TEXTURE\n	sheenColor *= {STD_SHEEN_TEXTURE_DECODE}(texture2DBias({STD_SHEEN_TEXTURE_NAME}, {STD_SHEEN_TEXTURE_UV}, textureBias)).{STD_SHEEN_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_SHEEN_VERTEX\n	sheenColor *= saturate(vVertexColor.{STD_SHEEN_VERTEX_CHANNEL});\n	#endif\n	sSpecularity = sheenColor;\n}\n",sheenGlossPS:"\nuniform float material_sheenGloss;\nvoid getSheenGlossiness() {\n	float sheenGlossiness = material_sheenGloss;\n	#ifdef STD_SHEENGLOSS_TEXTURE\n	sheenGlossiness *= texture2DBias({STD_SHEENGLOSS_TEXTURE_NAME}, {STD_SHEENGLOSS_TEXTURE_UV}, textureBias).{STD_SHEENGLOSS_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_SHEENGLOSS_VERTEX\n	sheenGlossiness *= saturate(vVertexColor.{STD_SHEENGLOSS_VERTEX_CHANNEL});\n	#endif\n	#ifdef STD_SHEENGLOSS_INVERT\n	sheenGlossiness = 1.0 - sheenGlossiness;\n	#endif\n	sGlossiness = sheenGlossiness + 0.0000001;\n}\n",parallaxPS:"\nuniform float material_heightMapFactor;\nvoid getParallax() {\n	float parallaxScale = material_heightMapFactor;\n	float height = texture2DBias({STD_HEIGHT_TEXTURE_NAME}, {STD_HEIGHT_TEXTURE_UV}, textureBias).{STD_HEIGHT_TEXTURE_CHANNEL};\n	height = height * parallaxScale - parallaxScale * 0.5;\n	vec3 viewDirT = dViewDirW * dTBN;\n	viewDirT.z += 0.42;\n	dUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",pickPS:"\nuniform uint meshInstanceId;\nvec4 getPickOutput() {\n	const vec4 inv = vec4(1.0 / 255.0);\n	const uvec4 shifts = uvec4(16, 8, 0, 24);\n	uvec4 col = (uvec4(meshInstanceId) >> shifts) & uvec4(0xff);\n	return vec4(col) * inv;\n}\n",reflDirPS:"\nvoid getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {\n	dReflDirW = normalize(-reflect(viewDir, worldNormal));\n}\n",reflDirAnisoPS:"\nvoid getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {\n	float roughness = sqrt(1.0 - min(gloss, 1.0));\n	vec2 direction = dAnisotropyRotation;\n	vec3 anisotropicT = normalize(tbn * vec3(direction, 0.0));\n	vec3 anisotropicB = normalize(cross(tbn[2], anisotropicT));\n	float anisotropy = dAnisotropy;\n	vec3 anisotropicDirection = anisotropicB;\n	vec3 anisotropicTangent = cross(anisotropicDirection, viewDir);\n	vec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n	float bendFactor = 1.0 - anisotropy * (1.0 - roughness);\n	float bendFactor4 = bendFactor * bendFactor * bendFactor * bendFactor;\n	vec3 bentNormal = normalize(mix(normalize(anisotropicNormal), normalize(worldNormal), bendFactor4));\n	dReflDirW = reflect(-viewDir, bentNormal);\n}\n",reflectionCCPS:"\n#ifdef LIT_CLEARCOAT\nvoid addReflectionCC(vec3 reflDir, float gloss) {\n	ccReflection += calcReflection(reflDir, gloss);\n}\n#endif\n",reflectionCubePS:"\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n	vec3 lookupVec = cubeMapProject(reflDir);\n	lookupVec.x *= -1.0;\n	return {reflectionDecode}(textureCube(texture_cubeMap, lookupVec));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionEnvHQPS:"\n#ifndef ENV_ATLAS\n	#define ENV_ATLAS\n	uniform sampler2D texture_envAtlas;\n#endif\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n	vec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);\n	vec2 uv = toSphericalUv(dir);\n	float level = saturate(1.0 - gloss) * 5.0;\n	float ilevel = floor(level);\n	float flevel = level - ilevel;\n	vec3 sharp = {reflectionCubemapDecode}(textureCube(texture_cubeMap, dir));\n	vec3 roughA = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel)));\n	vec3 roughB = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n	return processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\n	uniform sampler2D texture_envAtlas;\n#endif\nuniform float material_reflectivity;\nfloat shinyMipLevel(vec2 uv) {\n	vec2 dx = dFdx(uv);\n	vec2 dy = dFdy(uv);\n	vec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);\n	vec2 dx2 = dFdx(uv2);\n	vec2 dy2 = dFdy(uv2);\n	float maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));\n	return clamp(0.5 * log2(maxd) - 1.0 + textureBias, 0.0, 5.0);\n}\nvec3 calcReflection(vec3 reflDir, float gloss) {\n	vec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);\n	vec2 uv = toSphericalUv(dir);\n	float level = saturate(1.0 - gloss) * 5.0;\n	float ilevel = floor(level);\n	float level2 = shinyMipLevel(uv * atlasSize);\n	float ilevel2 = floor(level2);\n	vec2 uv0, uv1;\n	float weight;\n	if (ilevel == 0.0) {\n		uv0 = mapShinyUv(uv, ilevel2);\n		uv1 = mapShinyUv(uv, ilevel2 + 1.0);\n		weight = level2 - ilevel2;\n	} else {\n		uv0 = uv1 = mapRoughnessUv(uv, ilevel);\n		weight = 0.0;\n	}\n	vec3 linearA = {reflectionDecode}(texture2D(texture_envAtlas, uv0));\n	vec3 linearB = {reflectionDecode}(texture2D(texture_envAtlas, uv1));\n	vec3 linear0 = mix(linearA, linearB, weight);\n	vec3 linear1 = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n	return processEnvironment(mix(linear0, linear1, level - ilevel));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSpherePS:"\n#ifndef VIEWMATRIX\n	#define VIEWMATRIX\n	uniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n	vec3 reflDirV = (mat3(matrix_view) * reflDir);\n	float m = 2.0 * sqrt(dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z + 1.0) * (reflDirV.z + 1.0));\n	vec2 sphereMapUv = reflDirV.xy / m + 0.5;\n	return {reflectionDecode}(texture2D(texture_sphereMap, sphereMapUv));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSheenPS:"\nvoid addReflectionSheen(vec3 worldNormal, vec3 viewDir, float gloss) {\n	float NoV = dot(worldNormal, viewDir);\n	float alphaG = gloss * gloss;\n	float a = gloss < 0.25 ? -339.2 * alphaG + 161.4 * gloss - 25.9 : -8.48 * alphaG + 14.3 * gloss - 9.95;\n	float b = gloss < 0.25 ? 44.0 * alphaG - 23.7 * gloss + 3.26 : 1.97 * alphaG - 3.27 * gloss + 0.72;\n	float DG = exp( a * NoV + b ) + ( gloss < 0.25 ? 0.0 : 0.1 * ( gloss - 0.25 ) );\n	sReflection += calcReflection(worldNormal, 0.0) * saturate(DG);\n}\n",refractionCubePS:"\nvec3 refract2(vec3 viewVec, vec3 normal, float IOR) {\n	float vn = dot(viewVec, normal);\n	float k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n	vec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;\n	return refrVec;\n}\nvoid addRefraction(\n	vec3 worldNormal, \n	vec3 viewDir, \n	float thickness, \n	float gloss, \n	vec3 specularity, \n	vec3 albedo, \n	float transmission,\n	float refractionIndex,\n	float dispersion\n#if defined(LIT_IRIDESCENCE)\n	, vec3 iridescenceFresnel,\n	float iridescenceIntensity\n#endif \n) {\n	vec4 tmpRefl = dReflection;\n	vec3 reflectionDir = refract2(-viewDir, worldNormal, refractionIndex);\n	dReflection = vec4(0);\n	addReflection(reflectionDir, gloss);\n	dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);\n	dReflection = tmpRefl;\n}\n",refractionDynamicPS:"\nuniform float material_invAttenuationDistance;\nuniform vec3 material_attenuation;\nvec3 evalRefractionColor(vec3 refractionVector, float gloss, float refractionIndex) {\n	vec4 pointOfRefraction = vec4(vPositionW + refractionVector, 1.0);\n	vec4 projectionPoint = matrix_viewProjection * pointOfRefraction;\n	vec2 uv = getGrabScreenPos(projectionPoint);\n	float iorToRoughness = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);\n	float refractionLod = log2(uScreenSize.x) * iorToRoughness;\n	vec3 refraction = texture2DLod(uSceneColorMap, uv, refractionLod).rgb;\n	return refraction;\n}\nvoid addRefraction(\n	vec3 worldNormal, \n	vec3 viewDir, \n	float thickness, \n	float gloss, \n	vec3 specularity, \n	vec3 albedo, \n	float transmission,\n	float refractionIndex,\n	float dispersion\n#if defined(LIT_IRIDESCENCE)\n	, vec3 iridescenceFresnel,\n	float iridescenceIntensity\n#endif\n) {\n	vec3 modelScale;\n	modelScale.x = length(vec3(matrix_model[0].xyz));\n	modelScale.y = length(vec3(matrix_model[1].xyz));\n	modelScale.z = length(vec3(matrix_model[2].xyz));\n	vec3 scale = thickness * modelScale;\n	vec3 refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * scale;\n	vec3 refraction = evalRefractionColor(refractionVector, gloss, refractionIndex);\n	#ifdef LIT_DISPERSION\n		float halfSpread = (1.0 / refractionIndex - 1.0) * 0.025 * dispersion;\n		float refractionIndexR = refractionIndex - halfSpread;\n		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexR)) * scale;\n		refraction.r = evalRefractionColor(refractionVector, gloss, refractionIndexR).r;\n		float refractionIndexB = refractionIndex + halfSpread;\n		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexB)) * scale;\n		refraction.b = evalRefractionColor(refractionVector, gloss, refractionIndexB).b;\n	#endif\n	vec3 transmittance;\n	if (material_invAttenuationDistance != 0.0)\n	{\n		vec3 attenuation = -log(material_attenuation) * material_invAttenuationDistance;\n		transmittance = exp(-attenuation * length(refractionVector));\n	}\n	else\n	{\n		transmittance = refraction;\n	}\n	vec3 fresnel = vec3(1.0) - \n		getFresnel(\n			dot(viewDir, worldNormal), \n			gloss, \n			specularity\n		#if defined(LIT_IRIDESCENCE)\n			, iridescenceFresnel,\n			iridescenceIntensity\n		#endif\n		);\n	dDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);\n}\n",reprojectPS:'\nvarying vec2 vUv0;\n#ifdef CUBEMAP_SOURCE\n	uniform samplerCube sourceCube;\n#else\n	uniform sampler2D sourceTex;\n#endif\n#ifdef USE_SAMPLES_TEX\n	uniform sampler2D samplesTex;\n	uniform vec2 samplesTexInverseSize;\n#endif\nuniform vec3 params;\nfloat targetFace() { return params.x; }\nfloat targetTotalPixels() { return params.y; }\nfloat sourceTotalPixels() { return params.z; }\nfloat PI = 3.141592653589793;\nfloat saturate(float x) {\n	return clamp(x, 0.0, 1.0);\n}\n#include "decodePS"\n#include "encodePS"\nvec3 modifySeams(vec3 dir, float scale) {\n	vec3 adir = abs(dir);\n	float M = max(max(adir.x, adir.y), adir.z);\n	return dir / M * vec3(\n		adir.x == M ? 1.0 : scale,\n		adir.y == M ? 1.0 : scale,\n		adir.z == M ? 1.0 : scale\n	);\n}\nvec2 toSpherical(vec3 dir) {\n	return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec3 fromSpherical(vec2 uv) {\n	return vec3(cos(uv.y) * sin(uv.x),\n				sin(uv.y),\n				cos(uv.y) * cos(uv.x));\n}\nvec3 getDirectionEquirect() {\n	return fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\nfloat signNotZero(float k){\n	return(k >= 0.0) ? 1.0 : -1.0;\n}\nvec2 signNotZero(vec2 v) {\n	return vec2(signNotZero(v.x), signNotZero(v.y));\n}\nvec3 octDecode(vec2 o) {\n	vec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n	if (v.y < 0.0) {\n		v.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);\n	}\n	return normalize(v);\n}\nvec3 getDirectionOctahedral() {\n	return octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);\n}\nvec2 octEncode(in vec3 v) {\n	float l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n	vec2 result = v.xz * (1.0 / l1norm);\n	if (v.y < 0.0) {\n		result = (1.0 - abs(result.yx)) * signNotZero(result.xy);\n	}\n	return result;\n}\n#ifdef CUBEMAP_SOURCE\n	vec4 sampleCubemap(vec3 dir) {\n		return textureCube(sourceCube, modifySeams(dir, 1.0));\n	}\n	vec4 sampleCubemap(vec2 sph) {\n		return sampleCubemap(fromSpherical(sph));\n	}\n	vec4 sampleCubemap(vec3 dir, float mipLevel) {\n		return textureCubeLod(sourceCube, modifySeams(dir, 1.0), mipLevel);\n	}\n	vec4 sampleCubemap(vec2 sph, float mipLevel) {\n		return sampleCubemap(fromSpherical(sph), mipLevel);\n	}\n#else\n	vec4 sampleEquirect(vec2 sph) {\n		vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n		return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n	}\n	vec4 sampleEquirect(vec3 dir) {\n		return sampleEquirect(toSpherical(dir));\n	}\n	vec4 sampleEquirect(vec2 sph, float mipLevel) {\n		vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n		return texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n	}\n	vec4 sampleEquirect(vec3 dir, float mipLevel) {\n		return sampleEquirect(toSpherical(dir), mipLevel);\n	}\n	vec4 sampleOctahedral(vec3 dir) {\n		vec2 uv = octEncode(dir) * 0.5 + 0.5;\n		return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n	}\n	vec4 sampleOctahedral(vec2 sph) {\n		return sampleOctahedral(fromSpherical(sph));\n	}\n	vec4 sampleOctahedral(vec3 dir, float mipLevel) {\n		vec2 uv = octEncode(dir) * 0.5 + 0.5;\n		return texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n	}\n	vec4 sampleOctahedral(vec2 sph, float mipLevel) {\n		return sampleOctahedral(fromSpherical(sph), mipLevel);\n	}\n#endif\nvec3 getDirectionCubemap() {\n	vec2 st = vUv0 * 2.0 - 1.0;\n	float face = targetFace();\n	vec3 vec;\n	if (face == 0.0) {\n		vec = vec3(1, -st.y, -st.x);\n	} else if (face == 1.0) {\n		vec = vec3(-1, -st.y, st.x);\n	} else if (face == 2.0) {\n		vec = vec3(st.x, 1, st.y);\n	} else if (face == 3.0) {\n		vec = vec3(st.x, -1, -st.y);\n	} else if (face == 4.0) {\n		vec = vec3(st.x, -st.y, 1);\n	} else {\n		vec = vec3(-st.x, -st.y, -1);\n	}\n	return normalize(modifySeams(vec, 1.0));\n}\nmat3 matrixFromVector(vec3 n) {\n	float a = 1.0 / (1.0 + n.z);\n	float b = -n.x * n.y * a;\n	vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n	vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n	return mat3(b1, b2, n);\n}\nmat3 matrixFromVectorSlow(vec3 n) {\n	vec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);\n	vec3 x = normalize(cross(up, n));\n	vec3 y = cross(n, x);\n	return mat3(x, y, n);\n}\nvec4 reproject() {\n	if ({NUM_SAMPLES} <= 1) {\n		return {ENCODE_FUNC}({DECODE_FUNC}({SOURCE_FUNC}({TARGET_FUNC}())));\n	} else {\n		vec3 t = {TARGET_FUNC}();\n		vec3 tu = dFdx(t);\n		vec3 tv = dFdy(t);\n		vec3 result = vec3(0.0);\n		for (float u = 0.0; u < {NUM_SAMPLES_SQRT}; ++u) {\n			for (float v = 0.0; v < {NUM_SAMPLES_SQRT}; ++v) {\n				result += {DECODE_FUNC}({SOURCE_FUNC}(normalize(t +\n															tu * (u / {NUM_SAMPLES_SQRT} - 0.5) +\n															tv * (v / {NUM_SAMPLES_SQRT} - 0.5))));\n			}\n		}\n		return {ENCODE_FUNC}(result / ({NUM_SAMPLES_SQRT} * {NUM_SAMPLES_SQRT}));\n	}\n}\nvec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);\n#ifdef USE_SAMPLES_TEX\n	void unpackSample(int i, out vec3 L, out float mipLevel) {\n		float u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;\n		float v = (floor(u) + 0.5) * samplesTexInverseSize.y;\n		vec4 raw;\n		raw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n		raw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n		raw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n		raw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);\n		L.xyz = raw.xyz * 2.0 - 1.0;\n		mipLevel = raw.w * 8.0;\n	}\n	vec4 prefilterSamples() {\n		mat3 vecSpace = matrixFromVectorSlow({TARGET_FUNC}());\n		vec3 L;\n		float mipLevel;\n		vec3 result = vec3(0.0);\n		float totalWeight = 0.0;\n		for (int i = 0; i < {NUM_SAMPLES}; ++i) {\n			unpackSample(i, L, mipLevel);\n			result += {DECODE_FUNC}({SOURCE_FUNC}(vecSpace * L, mipLevel)) * L.z;\n			totalWeight += L.z;\n		}\n		return {ENCODE_FUNC}(result / totalWeight);\n	}\n	vec4 prefilterSamplesUnweighted() {\n		mat3 vecSpace = matrixFromVectorSlow({TARGET_FUNC}());\n		vec3 L;\n		float mipLevel;\n		vec3 result = vec3(0.0);\n		float totalWeight = 0.0;\n		for (int i = 0; i < {NUM_SAMPLES}; ++i) {\n			unpackSample(i, L, mipLevel);\n			result += {DECODE_FUNC}({SOURCE_FUNC}(vecSpace * L, mipLevel));\n		}\n		return {ENCODE_FUNC}(result / float({NUM_SAMPLES}));\n	}\n#endif\nvoid main(void) {\n	gl_FragColor = {PROCESS_FUNC}();\n}\n',reprojectVS:"\nattribute vec2 vertex_position;\nuniform vec4 uvMod;\nvarying vec2 vUv0;\nvoid main(void) {\n	gl_Position = vec4(vertex_position, 0.5, 1.0);\n	vUv0 = getImageEffectUV((vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw);\n}\n",screenDepthPS:"\nuniform highp sampler2D uSceneDepthMap;\n#ifndef SCREENSIZE\n	#define SCREENSIZE\n	uniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n	#define VIEWMATRIX\n	uniform mat4 matrix_view;\n#endif\n#ifndef LINEARIZE_DEPTH\n	#define LINEARIZE_DEPTH\n	\n	#ifndef CAMERAPLANES\n		#define CAMERAPLANES\n		uniform vec4 camera_params;\n	#endif\n	float linearizeDepth(float z) {\n		if (camera_params.w == 0.0)\n			return (camera_params.z * camera_params.y) / (camera_params.y + z * (camera_params.z - camera_params.y));\n		else\n			return camera_params.z + z * (camera_params.y - camera_params.z);\n	}\n#endif\nfloat delinearizeDepth(float linearDepth) {\n	if (camera_params.w == 0.0) {\n		return (camera_params.y * (camera_params.z - linearDepth)) / (linearDepth * (camera_params.z - camera_params.y));\n	} else {\n		return (linearDepth - camera_params.z) / (camera_params.y - camera_params.z);\n	}\n}\nfloat getLinearScreenDepth(vec2 uv) {\n	#ifdef SCENE_DEPTHMAP_LINEAR\n		#ifdef SCENE_DEPTHMAP_FLOAT\n			return texture2D(uSceneDepthMap, uv).r;\n		#else\n			ivec2 textureSize = textureSize(uSceneDepthMap, 0);\n			ivec2 texel = ivec2(uv * vec2(textureSize));\n			vec4 data = texelFetch(uSceneDepthMap, texel, 0);\n			uint intBits = \n				(uint(data.r * 255.0) << 24u) |\n				(uint(data.g * 255.0) << 16u) |\n				(uint(data.b * 255.0) << 8u) |\n				uint(data.a * 255.0);\n			return uintBitsToFloat(intBits);\n		#endif\n	#else\n		return linearizeDepth(texture2D(uSceneDepthMap, uv).r);\n	#endif\n}\n#ifndef VERTEXSHADER\n	float getLinearScreenDepth() {\n		vec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n		return getLinearScreenDepth(uv);\n	}\n#endif\nfloat getLinearDepth(vec3 pos) {\n	return -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCascadesPS:"\nint getShadowCascadeIndex(vec4 shadowCascadeDistances, int shadowCascadeCount) {\n	float depth = 1.0 / gl_FragCoord.w;\n	vec4 comparisons = step(shadowCascadeDistances, vec4(depth));\n	int cascadeIndex = int(dot(comparisons, vec4(1.0)));\n	return min(cascadeIndex, shadowCascadeCount - 1);\n}\nint ditherShadowCascadeIndex(int cascadeIndex, vec4 shadowCascadeDistances, int shadowCascadeCount, float blendFactor) {\n \n	if (cascadeIndex < shadowCascadeCount - 1) {\n		float currentRangeEnd = shadowCascadeDistances[cascadeIndex];\n		float transitionStart = blendFactor * currentRangeEnd;\n		float depth = 1.0 / gl_FragCoord.w;\n		if (depth > transitionStart) {\n			float transitionFactor = smoothstep(transitionStart, currentRangeEnd, depth);\n			float dither = fract(sin(dot(gl_FragCoord.xy, vec2(12.9898, 78.233))) * 43758.5453);\n			if (dither < transitionFactor) {\n				cascadeIndex += 1;\n			}\n		}\n	}\n	return cascadeIndex;\n}\nvec3 fadeShadow(vec3 shadowCoord, vec4 shadowCascadeDistances) {				  \n	float depth = 1.0 / gl_FragCoord.w;\n	if (depth > shadowCascadeDistances.w) {\n		shadowCoord.z = -9999999.0;\n	}\n	return shadowCoord;\n}\n",shadowEVSMPS:"\nfloat linstep(float a, float b, float v) {\n	return saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n   return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n	float variance = moments.y - (moments.x * moments.x);\n	variance = max(variance, minVariance);\n	float d = mean - moments.x;\n	float pMax = variance / (variance + (d * d));\n	pMax = reduceLightBleeding(pMax, lightBleedingReduction);\n	return (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n	Z = 2.0 * Z - 1.0;\n	float warpedDepth = exp(exponent * Z);\n	moments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n	float VSMBias = vsmBias;\n	float depthScale = VSMBias * exponent * warpedDepth;\n	float minVariance1 = depthScale * depthScale;\n	return chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\nfloat VSM16(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n	vec3 moments = texture2DLod(tex, texCoords, 0.0).xyz;\n	return calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM16(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent) {\n	return VSM16(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM16(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n	return VSM16(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\nfloat VSM32(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n	#ifdef CAPS_TEXTURE_FLOAT_FILTERABLE\n		vec3 moments = texture2DLod(tex, texCoords, 0.0).xyz;\n	#else\n		float pixelSize = 1.0 / resolution;\n		texCoords -= vec2(pixelSize);\n		vec3 s00 = texture2DLod(tex, texCoords, 0.0).xyz;\n		vec3 s10 = texture2DLod(tex, texCoords + vec2(pixelSize, 0), 0.0).xyz;\n		vec3 s01 = texture2DLod(tex, texCoords + vec2(0, pixelSize), 0.0).xyz;\n		vec3 s11 = texture2DLod(tex, texCoords + vec2(pixelSize), 0.0).xyz;\n		vec2 fr = fract(texCoords * resolution);\n		vec3 h0 = mix(s00, s10, fr.x);\n		vec3 h1 = mix(s01, s11, fr.x);\n		vec3 moments = mix(h0, h1, fr.y);\n	#endif\n	return calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM32(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent) {\n	return VSM32(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM32(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n	float Z = length(lightDir) * shadowParams.w + shadowParams.z;\n	return VSM32(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, Z, shadowParams.y, exponent);\n}\n",shadowPCF1PS:"\nfloat getShadowPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n	return textureShadow(shadowMap, shadowCoord);\n}\nfloat getShadowSpotPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n	return textureShadow(shadowMap, shadowCoord);\n}\n#ifndef WEBGPU\nfloat getShadowOmniPCF1x1(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {\n	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n	return texture(shadowMap, vec4(lightDir, shadowZ));\n}\n#endif\n",shadowPCF3PS:"\nfloat _getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {\n	float z = shadowCoord.z;\n	vec2 uv = shadowCoord.xy * shadowParams.x;\n	float shadowMapSizeInv = 1.0 / shadowParams.x;\n	vec2 base_uv = floor(uv + 0.5);\n	float s = (uv.x + 0.5 - base_uv.x);\n	float t = (uv.y + 0.5 - base_uv.y); \n	base_uv -= vec2(0.5);\n	base_uv *= shadowMapSizeInv;\n	float sum = 0.0;\n	float uw0 = (3.0 - 2.0 * s);\n	float uw1 = (1.0 + 2.0 * s);\n	float u0 = (2.0 - s) / uw0 - 1.0;\n	float u1 = s / uw1 + 1.0;\n	float vw0 = (3.0 - 2.0 * t);\n	float vw1 = (1.0 + 2.0 * t);\n	float v0 = (2.0 - t) / vw0 - 1.0;\n	float v1 = t / vw1 + 1.0;\n	u0 = u0 * shadowMapSizeInv + base_uv.x;\n	v0 = v0 * shadowMapSizeInv + base_uv.y;\n	u1 = u1 * shadowMapSizeInv + base_uv.x;\n	v1 = v1 * shadowMapSizeInv + base_uv.y;\n	sum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));\n	sum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));\n	sum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));\n	sum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));\n	sum *= 1.0f / 16.0;\n	return sum;\n}\nfloat getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n	return _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowSpotPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n	return _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\n#ifndef WEBGPU\nfloat getShadowOmniPCF3x3(samplerCubeShadow shadowMap, vec4 shadowParams, vec3 dir) {\n	\n	float shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n	float z = 1.0 / float(textureSize(shadowMap, 0));\n	vec3 tc = normalize(dir);\n	mediump vec4 shadows;\n	shadows.x = texture(shadowMap, vec4(tc + vec3( z, z, z), shadowZ));\n	shadows.y = texture(shadowMap, vec4(tc + vec3(-z,-z, z), shadowZ));\n	shadows.z = texture(shadowMap, vec4(tc + vec3(-z, z,-z), shadowZ));\n	shadows.w = texture(shadowMap, vec4(tc + vec3( z,-z,-z), shadowZ));\n	return dot(shadows, vec4(0.25));\n}\nfloat getShadowOmniPCF3x3(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {\n	return getShadowOmniPCF3x3(shadowMap, shadowParams, lightDir);\n}\n#endif\n",shadowPCF5PS:"\nfloat _getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {\n	float z = shadowCoord.z;\n	vec2 uv = shadowCoord.xy * shadowParams.x;\n	float shadowMapSizeInv = 1.0 / shadowParams.x;\n	vec2 base_uv = floor(uv + 0.5);\n	float s = (uv.x + 0.5 - base_uv.x);\n	float t = (uv.y + 0.5 - base_uv.y);\n	base_uv -= vec2(0.5);\n	base_uv *= shadowMapSizeInv;\n	float uw0 = (4.0 - 3.0 * s);\n	float uw1 = 7.0;\n	float uw2 = (1.0 + 3.0 * s);\n	float u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n	float u1 = (3.0 + s) / uw1;\n	float u2 = s / uw2 + 2.0;\n	float vw0 = (4.0 - 3.0 * t);\n	float vw1 = 7.0;\n	float vw2 = (1.0 + 3.0 * t);\n	float v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n	float v1 = (3.0 + t) / vw1;\n	float v2 = t / vw2 + 2.0;\n	float sum = 0.0;\n	u0 = u0 * shadowMapSizeInv + base_uv.x;\n	v0 = v0 * shadowMapSizeInv + base_uv.y;\n	u1 = u1 * shadowMapSizeInv + base_uv.x;\n	v1 = v1 * shadowMapSizeInv + base_uv.y;\n	u2 = u2 * shadowMapSizeInv + base_uv.x;\n	v2 = v2 * shadowMapSizeInv + base_uv.y;\n	sum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));\n	sum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));\n	sum += uw2 * vw0 * textureShadow(shadowMap, vec3(u2, v0, z));\n	sum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));\n	sum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));\n	sum += uw2 * vw1 * textureShadow(shadowMap, vec3(u2, v1, z));\n	sum += uw0 * vw2 * textureShadow(shadowMap, vec3(u0, v2, z));\n	sum += uw1 * vw2 * textureShadow(shadowMap, vec3(u1, v2, z));\n	sum += uw2 * vw2 * textureShadow(shadowMap, vec3(u2, v2, z));\n	sum *= 1.0f / 144.0;\n	sum = saturate(sum);\n	return sum;\n}\nfloat getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n	return _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowSpotPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n	return _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\n",shadowPCSSPS:"\n#define PCSS_SAMPLE_COUNT 16\nuniform float pcssDiskSamples[PCSS_SAMPLE_COUNT];\nuniform float pcssSphereSamples[PCSS_SAMPLE_COUNT];\nvec2 vogelDisk(int sampleIndex, float count, float phi, float r) {\n	const float GoldenAngle = 2.4;\n	float theta = float(sampleIndex) * GoldenAngle + phi;\n	float sine = sin(theta);\n	float cosine = cos(theta);\n	return vec2(r * cosine, r * sine);\n}\nvec3 vogelSphere(int sampleIndex, float count, float phi, float r) {\n	const float GoldenAngle = 2.4;\n	float theta = float(sampleIndex) * GoldenAngle + phi;\n	float weight = float(sampleIndex) / count;\n	return vec3(cos(theta) * r, weight, sin(theta) * r);\n}\nfloat noise(vec2 screenPos) {\n	const float PHI = 1.61803398874989484820459;\n	return fract(sin(dot(screenPos * PHI, screenPos)) * screenPos.x);\n}\nfloat viewSpaceDepth(float depth, mat4 invProjection) {\n	float z = depth * 2.0 - 1.0;\n	vec4 clipSpace = vec4(0.0, 0.0, z, 1.0);\n	vec4 viewSpace = invProjection * clipSpace;\n	return viewSpace.z;\n}\nfloat PCSSBlockerDistance(TEXTURE_ACCEPT(shadowMap), vec2 sampleCoords[PCSS_SAMPLE_COUNT], vec2 shadowCoords, vec2 searchSize, float z, vec4 cameraParams) {\n	float blockers = 0.0;\n	float averageBlocker = 0.0;\n	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n		vec2 offset = sampleCoords[i] * searchSize;\n		vec2 sampleUV = shadowCoords + offset;\n		float blocker = texture2DLod(shadowMap, sampleUV, 0.0).r;\n		float isBlocking = step(blocker, z);\n		blockers += isBlocking;\n		averageBlocker += blocker * isBlocking;\n	}\n	if (blockers > 0.0)\n		return averageBlocker / blockers;\n	return -1.0;\n}\nfloat PCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec2 shadowSearchArea) {\n	float receiverDepth = linearizeDepthWithParams(shadowCoords.z, cameraParams);\n	vec2 samplePoints[PCSS_SAMPLE_COUNT];\n	const float PI = 3.141592653589793;\n	float noise = noise( gl_FragCoord.xy ) * 2.0 * PI;\n	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n		float pcssPresample = pcssDiskSamples[i];\n		samplePoints[i] = vogelDisk(i, float(PCSS_SAMPLE_COUNT), noise, pcssPresample);\n	}\n	float averageBlocker = PCSSBlockerDistance(TEXTURE_PASS(shadowMap), samplePoints, shadowCoords.xy, shadowSearchArea, receiverDepth, cameraParams);\n	if (averageBlocker == -1.0) {\n		return 1.0;\n	} else {\n		float depthDifference = (receiverDepth - averageBlocker) / 3.0;\n		vec2 filterRadius = depthDifference * shadowSearchArea;\n		float shadow = 0.0;\n		for (int i = 0; i < PCSS_SAMPLE_COUNT; i ++)\n		{\n			vec2 sampleUV = samplePoints[i] * filterRadius;\n			sampleUV = shadowCoords.xy + sampleUV;\n			float depth = texture2DLod(shadowMap, sampleUV, 0.0).r;\n			shadow += step(receiverDepth, depth);\n		}\n		return shadow / float(PCSS_SAMPLE_COUNT);\n	} \n}\n#ifndef WEBGPU\nfloat PCSSCubeBlockerDistance(samplerCube shadowMap, vec3 lightDirNorm, vec3 samplePoints[PCSS_SAMPLE_COUNT], float z, float shadowSearchArea) {\n	float blockers = 0.0;\n	float averageBlocker = 0.0;\n	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n		vec3 sampleDir = lightDirNorm + samplePoints[i] * shadowSearchArea;\n		sampleDir = normalize(sampleDir);\n		float blocker = textureCubeLod(shadowMap, sampleDir, 0.0).r;\n		float isBlocking = step(blocker, z);\n		blockers += isBlocking;\n		averageBlocker += blocker * isBlocking;\n	}\n	if (blockers > 0.0)\n		return averageBlocker / blockers;\n	return -1.0;\n}\nfloat PCSSCube(samplerCube shadowMap, vec4 shadowParams, vec3 shadowCoords, vec4 cameraParams, float shadowSearchArea, vec3 lightDir) {\n	\n	vec3 samplePoints[PCSS_SAMPLE_COUNT];\n	const float PI = 3.141592653589793;\n	float noise = noise( gl_FragCoord.xy ) * 2.0 * PI;\n	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n		float r = pcssSphereSamples[i];\n		samplePoints[i] = vogelSphere(i, float(PCSS_SAMPLE_COUNT), noise, r);\n	}\n	float receiverDepth = length(lightDir) * shadowParams.w + shadowParams.z;\n	vec3 lightDirNorm = normalize(lightDir);\n	\n	float averageBlocker = PCSSCubeBlockerDistance(shadowMap, lightDirNorm, samplePoints, receiverDepth, shadowSearchArea);\n	if (averageBlocker == -1.0) {\n		return 1.0;\n	} else {\n		float filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea;\n		float shadow = 0.0;\n		for (int i = 0; i < PCSS_SAMPLE_COUNT; i++)\n		{\n			vec3 offset = samplePoints[i] * filterRadius;\n			vec3 sampleDir = lightDirNorm + offset;\n			sampleDir = normalize(sampleDir);\n			float depth = textureCubeLod(shadowMap, sampleDir, 0.0).r;\n			shadow += step(receiverDepth, depth);\n		}\n		return shadow / float(PCSS_SAMPLE_COUNT);\n	}\n}\nfloat getShadowOmniPCSS(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n	return PCSSCube(shadowMap, shadowParams, shadowCoord, cameraParams, shadowSearchArea.x, lightDir);\n}\n#endif\nfloat getShadowSpotPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n	return PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);\n}\n",shadowSoftPS:"\nhighp float fractSinRand(const in vec2 uv) {\n	const float PI = 3.141592653589793;\n	const highp float a = 12.9898, b = 78.233, c = 43758.5453;\n	highp float dt = dot(uv.xy, vec2(a, b)), sn = mod(dt, PI);\n	return fract(sin(sn) * c);\n}\nstruct VogelDiskData {\n	float invNumSamples;\n	float initialAngle;\n	float currentPointId;\n};\nvoid prepareDiskConstants(out VogelDiskData data, int sampleCount, float randomSeed) {\n	const float pi2 = 6.28318530718;\n	data.invNumSamples = 1.0 / float(sampleCount);\n	data.initialAngle = randomSeed * pi2;\n	data.currentPointId = 0.0;\n}\nvec2 generateDiskSample(inout VogelDiskData data) {\n	const float GOLDEN_ANGLE = 2.399963;\n	float r = sqrt((data.currentPointId + 0.5) * data.invNumSamples);\n	float theta = data.currentPointId * GOLDEN_ANGLE + data.initialAngle;\n	vec2 offset = vec2(cos(theta), sin(theta)) * pow(r, 1.33);\n	data.currentPointId += 1.0;\n	return offset;\n}\nvoid PCSSFindBlocker(TEXTURE_ACCEPT(shadowMap), out float avgBlockerDepth, out int numBlockers,\n	vec2 shadowCoords, float z, int shadowBlockerSamples, float penumbraSize, float invShadowMapSize, float randomSeed) {\n	VogelDiskData diskData;\n	prepareDiskConstants(diskData, shadowBlockerSamples, randomSeed);\n	float searchWidth = penumbraSize * invShadowMapSize;\n	float blockerSum = 0.0;\n	numBlockers = 0;\n	for( int i = 0; i < shadowBlockerSamples; ++i ) {\n		vec2 diskUV = generateDiskSample(diskData);\n		vec2 sampleUV = shadowCoords + diskUV * searchWidth;\n		float shadowMapDepth = texture2DLod(shadowMap, sampleUV, 0.0).r;\n		if ( shadowMapDepth < z ) {\n			blockerSum += shadowMapDepth;\n			numBlockers++;\n		}\n	}\n	avgBlockerDepth = blockerSum / float(numBlockers);\n}\nfloat PCSSFilter(TEXTURE_ACCEPT(shadowMap), vec2 uv, float receiverDepth, int shadowSamples, float filterRadius, float randomSeed) {\n	VogelDiskData diskData;\n	prepareDiskConstants(diskData, shadowSamples, randomSeed);\n	float sum = 0.0;\n	for (int i = 0; i < shadowSamples; i++) {\n		vec2 offsetUV = generateDiskSample(diskData) * filterRadius;\n		float depth = texture2DLod(shadowMap, uv + offsetUV, 0.0).r;\n		sum += step(receiverDepth, depth);\n	}\n	return sum / float(shadowSamples);\n}\nfloat getPenumbra(float dblocker, float dreceiver, float penumbraSize, float penumbraFalloff) {\n	float dist = dreceiver - dblocker;\n	float penumbra = 1.0 - pow(1.0 - dist, penumbraFalloff);\n	return penumbra * penumbraSize;\n}\nfloat PCSSDirectional(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec4 softShadowParams) {\n	float receiverDepth = shadowCoords.z;\n	float randomSeed = fractSinRand(gl_FragCoord.xy);\n	int shadowSamples = int(softShadowParams.x);\n	int shadowBlockerSamples = int(softShadowParams.y);\n	float penumbraSize = softShadowParams.z;\n	float penumbraFalloff = softShadowParams.w;\n	int shadowMapSize = textureSize(shadowMap, 0).x;\n	float invShadowMapSize = 1.0 / float(shadowMapSize);\n	invShadowMapSize *= float(shadowMapSize) / 2048.0;\n	float penumbra;\n	if (shadowBlockerSamples > 0) {\n		float avgBlockerDepth = 0.0;\n		int numBlockers = 0;\n		PCSSFindBlocker(TEXTURE_PASS(shadowMap), avgBlockerDepth, numBlockers, shadowCoords.xy, receiverDepth, shadowBlockerSamples, penumbraSize, invShadowMapSize, randomSeed);\n		if (numBlockers < 1)\n			return 1.0f;\n		penumbra = getPenumbra(avgBlockerDepth, shadowCoords.z, penumbraSize, penumbraFalloff);\n	} else {\n		penumbra = penumbraSize;\n	}\n	float filterRadius = penumbra * invShadowMapSize;\n	return PCSSFilter(TEXTURE_PASS(shadowMap), shadowCoords.xy, receiverDepth, shadowSamples, filterRadius, randomSeed);\n}\nfloat getShadowPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec4 softShadowParams, vec3 lightDir) {\n	return PCSSDirectional(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, softShadowParams);\n}\n",skinBatchVS:"\nattribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nmat4 getBoneMatrix(const in float indexFloat) {\n	int width = textureSize(texture_poseMap, 0).x;\n	int index = int(indexFloat + 0.5) * 3;\n	int iy = index / width;\n	int ix = index % width;\n	vec4 v1 = texelFetch(texture_poseMap, ivec2(ix + 0, iy), 0);\n	vec4 v2 = texelFetch(texture_poseMap, ivec2(ix + 1, iy), 0);\n	vec4 v3 = texelFetch(texture_poseMap, ivec2(ix + 2, iy), 0);\n	return mat4(\n		v1.x, v2.x, v3.x, 0,\n		v1.y, v2.y, v3.y, 0,\n		v1.z, v2.z, v3.z, 0,\n		v1.w, v2.w, v3.w, 1\n	);\n}\n",skinVS:"\nattribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nvoid getBoneMatrix(const in int width, const in int index, out vec4 v1, out vec4 v2, out vec4 v3) {\n	int v = index / width;\n	int u = index % width;\n	v1 = texelFetch(texture_poseMap, ivec2(u + 0, v), 0);\n	v2 = texelFetch(texture_poseMap, ivec2(u + 1, v), 0);\n	v3 = texelFetch(texture_poseMap, ivec2(u + 2, v), 0);\n}\nmat4 getSkinMatrix(const in vec4 indicesFloat, const in vec4 weights) {\n	int width = textureSize(texture_poseMap, 0).x;\n	ivec4 indices = ivec4(indicesFloat + 0.5) * 3;\n	vec4 a1, a2, a3;\n	getBoneMatrix(width, indices.x, a1, a2, a3);\n	vec4 b1, b2, b3;\n	getBoneMatrix(width, indices.y, b1, b2, b3);\n	vec4 c1, c2, c3;\n	getBoneMatrix(width, indices.z, c1, c2, c3);\n	vec4 d1, d2, d3;\n	getBoneMatrix(width, indices.w, d1, d2, d3);\n	vec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n	vec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n	vec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n	float one = dot(weights, vec4(1.0));\n	return mat4(\n		v1.x, v2.x, v3.x, 0,\n		v1.y, v2.y, v3.y, 0,\n		v1.z, v2.z, v3.z, 0,\n		v1.w, v2.w, v3.w, one\n	);\n}\n",skyboxPS:'\n	#define LIT_SKYBOX_INTENSITY\n	#include "envProcPS"\n	#include "gammaPS"\n	#include "tonemappingPS"\n	#ifdef PREPASS_PASS\n		varying float vLinearDepth;\n		#include "floatAsUintPS"\n	#endif\n	varying vec3 vViewDir;\n	uniform float skyboxHighlightMultiplier;\n	#ifdef SKY_CUBEMAP\n		uniform samplerCube texture_cubeMap;\n		#ifdef SKYMESH\n			varying vec3 vWorldPos;\n			uniform mat3 cubeMapRotationMatrix;\n			uniform vec3 projectedSkydomeCenter;\n		#endif\n	#else\n		#include "sphericalPS"\n		#include "envAtlasPS"\n		uniform sampler2D texture_envAtlas;\n		uniform float mipLevel;\n	#endif\n	void main(void) {\n		#ifdef PREPASS_PASS\n			gl_FragColor = float2vec4(vLinearDepth);\n		#else\n			#ifdef SKY_CUBEMAP\n				#ifdef SKYMESH\n					vec3 envDir = normalize(vWorldPos - projectedSkydomeCenter);\n					vec3 dir = envDir * cubeMapRotationMatrix;\n				#else\n					vec3 dir = vViewDir;\n				#endif\n				dir.x *= -1.0;\n				vec3 linear = {SKYBOX_DECODE_FNC}(textureCube(texture_cubeMap, dir));\n			#else\n				vec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);\n				vec2 uv = toSphericalUv(normalize(dir));\n				vec3 linear = {SKYBOX_DECODE_FNC}(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));\n			#endif\n			if (any(greaterThanEqual(linear, vec3(64.0)))) {\n				linear *= skyboxHighlightMultiplier;\n			}\n			gl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n		#endif\n	}\n',skyboxVS:"\nattribute vec4 aPosition;\nuniform mat4 matrix_view;\nuniform mat4 matrix_projectionSkybox;\nuniform mat3 cubeMapRotationMatrix;\nvarying vec3 vViewDir;\n#ifdef PREPASS_PASS\n	varying float vLinearDepth;\n#endif\n#ifdef SKYMESH\n	uniform mat4 matrix_model;\n	varying vec3 vWorldPos;\n#endif\nvoid main(void) {\n	mat4 view = matrix_view;\n	#ifdef SKYMESH\n		vec4 worldPos = matrix_model * aPosition;\n		vWorldPos = worldPos.xyz;\n		gl_Position = matrix_projectionSkybox * (view * worldPos);\n		#ifdef PREPASS_PASS\n			vLinearDepth = -(matrix_view * vec4(vWorldPos, 1.0)).z;\n		#endif\n	#else\n		view[3][0] = view[3][1] = view[3][2] = 0.0;\n		gl_Position = matrix_projectionSkybox * (view * aPosition);\n		vViewDir = aPosition.xyz * cubeMapRotationMatrix;\n		#ifdef PREPASS_PASS\n			vLinearDepth = -gl_Position.w;\n		#endif\n	#endif\n	gl_Position.z = gl_Position.w - 1.0e-7;\n}\n",specularPS:"\n#ifdef STD_SPECULAR_CONSTANT\nuniform vec3 material_specular;\n#endif\nvoid getSpecularity() {\n	vec3 specularColor = vec3(1,1,1);\n	#ifdef STD_SPECULAR_CONSTANT\n	specularColor *= material_specular;\n	#endif\n	#ifdef STD_SPECULAR_TEXTURE\n	specularColor *= {STD_SPECULAR_TEXTURE_DECODE}(texture2DBias({STD_SPECULAR_TEXTURE_NAME}, {STD_SPECULAR_TEXTURE_UV}, textureBias)).{STD_SPECULAR_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_SPECULAR_VERTEX\n	specularColor *= saturate(vVertexColor.{STD_SPECULAR_VERTEX_CHANNEL});\n	#endif\n	dSpecularity = specularColor;\n}\n",sphericalPS:"\nvec2 toSpherical(vec3 dir) {\n	return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec2 toSphericalUv(vec3 dir) {\n	const float PI = 3.141592653589793;\n	vec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;\n	return vec2(uv.x, 1.0 - uv.y);\n}\n",specularityFactorPS:"\n#ifdef STD_SPECULARITYFACTOR_CONSTANT\nuniform float material_specularityFactor;\n#endif\nvoid getSpecularityFactor() {\n	float specularityFactor = 1.0;\n	#ifdef STD_SPECULARITYFACTOR_CONSTANT\n	specularityFactor *= material_specularityFactor;\n	#endif\n	#ifdef STD_SPECULARITYFACTOR_TEXTURE\n	specularityFactor *= texture2DBias({STD_SPECULARITYFACTOR_TEXTURE_NAME}, {STD_SPECULARITYFACTOR_TEXTURE_UV}, textureBias).{STD_SPECULARITYFACTOR_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_SPECULARITYFACTOR_VERTEX\n	specularityFactor *= saturate(vVertexColor.{STD_SPECULARITYFACTOR_VERTEX_CHANNEL});\n	#endif\n	dSpecularityFactor = specularityFactor;\n}\n",spotPS:"\nfloat getSpotEffect(vec3 lightSpotDir, float lightInnerConeAngle, float lightOuterConeAngle, vec3 lightDirNorm) {\n	float cosAngle = dot(lightDirNorm, lightSpotDir);\n	return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startNineSlicedPS:"\n	nineSlicedUv = vec2(vUv0.x, 1.0 - vUv0.y);\n",startNineSlicedTiledPS:"\n	vec2 tileMask = step(vMask, vec2(0.99999));\n	vec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);\n	vec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);\n	vec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n	clampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n	nineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n	nineSlicedUv.y = 1.0 - nineSlicedUv.y;\n	\n",stdDeclarationPS:'\n	float dAlpha = 1.0;\n	#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n		#ifdef STD_OPACITY_TEXTURE_ALLOCATE\n			uniform sampler2D texture_opacityMap;\n		#endif\n	#endif\n	#ifdef FORWARD_PASS\n		vec3 dAlbedo;\n		vec3 dNormalW;\n		vec3 dSpecularity = vec3(0.0);\n		float dGlossiness = 0.0;\n		#ifdef LIT_REFRACTION\n			float dTransmission;\n			float dThickness;\n		#endif\n		#ifdef LIT_SCENE_COLOR\n			uniform sampler2D uSceneColorMap;\n		#endif\n		#ifdef LIT_SCREEN_SIZE\n			uniform vec4 uScreenSize;\n		#endif\n		#ifdef LIT_TRANSFORMS\n			uniform mat4 matrix_viewProjection;\n			uniform mat4 matrix_model;\n		#endif\n		#ifdef STD_HEIGHT_MAP\n			vec2 dUvOffset;\n			#ifdef STD_HEIGHT_TEXTURE_ALLOCATE\n				uniform sampler2D texture_heightMap;\n			#endif\n		#endif\n		#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE\n			uniform sampler2D texture_diffuseMap;\n		#endif\n		#ifdef STD_DIFFUSEDETAIL_TEXTURE_ALLOCATE\n			uniform sampler2D texture_diffuseDetailMap;\n		#endif\n		#ifdef STD_NORMAL_TEXTURE_ALLOCATE\n			uniform sampler2D texture_normalMap;\n		#endif\n		#ifdef STD_NORMALDETAIL_TEXTURE_ALLOCATE\n			uniform sampler2D texture_normalDetailMap;\n		#endif\n		#ifdef STD_THICKNESS_TEXTURE_ALLOCATE\n			uniform sampler2D texture_thicknessMap;\n		#endif\n		#ifdef STD_REFRACTION_TEXTURE_ALLOCATE\n			uniform sampler2D texture_refractionMap;\n		#endif\n		#ifdef LIT_IRIDESCENCE\n			float dIridescence;\n			float dIridescenceThickness;\n			#ifdef STD_IRIDESCENCE_THICKNESS_TEXTURE_ALLOCATE\n				uniform sampler2D texture_iridescenceThicknessMap;\n			#endif\n			#ifdef STD_IRIDESCENCE_TEXTURE_ALLOCATE\n				uniform sampler2D texture_iridescenceMap;\n			#endif\n		#endif\n		#ifdef LIT_CLEARCOAT\n			float ccSpecularity;\n			float ccGlossiness;\n			vec3 ccNormalW;\n		#endif\n		#ifdef LIT_GGX_SPECULAR\n			float dAnisotropy;\n			vec2 dAnisotropyRotation;\n		#endif\n		#ifdef LIT_SPECULAR_OR_REFLECTION\n			#ifdef LIT_SHEEN\n				vec3 sSpecularity;\n				float sGlossiness;\n				#ifdef STD_SHEEN_TEXTURE_ALLOCATE\n					uniform sampler2D texture_sheenMap;\n				#endif\n				#ifdef STD_SHEENGLOSS_TEXTURE_ALLOCATE\n					uniform sampler2D texture_sheenGlossMap;\n				#endif\n			#endif\n			#ifdef LIT_METALNESS\n				float dMetalness;\n				float dIor;\n				#ifdef STD_METALNESS_TEXTURE_ALLOCATE\n					uniform sampler2D texture_metalnessMap;\n				#endif\n			#endif\n			#ifdef LIT_SPECULARITY_FACTOR\n				float dSpecularityFactor;\n				#ifdef STD_SPECULARITYFACTOR_TEXTURE_ALLOCATE\n					uniform sampler2D texture_specularityFactorMap;\n				#endif\n			#endif\n			#ifdef STD_SPECULAR_COLOR\n				#ifdef STD_SPECULAR_TEXTURE_ALLOCATE\n					uniform sampler2D texture_specularMap;\n				#endif\n			#endif\n			#ifdef STD_GLOSS_TEXTURE_ALLOCATE\n				uniform sampler2D texture_glossMap;\n			#endif\n		#endif\n		#ifdef STD_AO\n			float dAo;\n			#ifdef STD_AO_TEXTURE_ALLOCATE\n				uniform sampler2D texture_aoMap;\n			#endif\n			#ifdef STD_AODETAIL_TEXTURE_ALLOCATE\n				uniform sampler2D texture_aoDetailMap;\n			#endif\n		#endif\n		vec3 dEmission;\n		#ifdef STD_EMISSIVE_TEXTURE_ALLOCATE\n			uniform sampler2D texture_emissiveMap;\n		#endif\n		#ifdef LIT_CLEARCOAT\n			#ifdef STD_CLEARCOAT_TEXTURE_ALLOCATE\n				uniform sampler2D texture_clearCoatMap;\n			#endif\n			#ifdef STD_CLEARCOATGLOSS_TEXTURE_ALLOCATE\n				uniform sampler2D texture_clearCoatGlossMap;\n			#endif\n			#ifdef STD_CLEARCOATNORMAL_TEXTURE_ALLOCATE\n				uniform sampler2D texture_clearCoatNormalMap;\n			#endif\n		#endif\n		\n		#ifdef LIT_GGX_SPECULAR\n			#ifdef STD_ANISOTROPY_TEXTURE_ALLOCATE\n				uniform sampler2D texture_anisotropyMap;\n			#endif\n		#endif\n		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n			vec3 dLightmap;\n			#ifdef STD_LIGHT_TEXTURE_ALLOCATE\n				uniform sampler2D texture_lightMap;\n			#endif\n		#endif\n	#endif\n	#include "litShaderCorePS"\n',stdFrontEndPS:'\n	#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n		#include "opacityPS"\n		#if defined(LIT_ALPHA_TEST)\n			#include "alphaTestPS"\n		#endif\n		#if STD_OPACITY_DITHER != NONE\n			#include "opacityDitherPS"\n		#endif\n	#endif\n	#ifdef FORWARD_PASS\n		#ifdef STD_HEIGHT_MAP\n			#include "parallaxPS"\n		#endif\n		#include  "diffusePS"\n		#ifdef LIT_NEEDS_NORMAL\n			#include "normalMapPS"\n		#endif\n		#ifdef LIT_REFRACTION\n			#include "transmissionPS"\n			#include "thicknessPS"\n		#endif\n		#ifdef LIT_IRIDESCENCE\n			#include "iridescencePS"\n			#include "iridescenceThicknessPS"\n		#endif\n		#ifdef LIT_SPECULAR_OR_REFLECTION\n			#ifdef LIT_SHEEN\n				#include "sheenPS"\n				#include "sheenGlossPS"\n			#endif\n			#ifdef LIT_METALNESS\n				#include "metalnessPS"\n				#include "iorPS"\n			#endif\n			#ifdef LIT_SPECULARITY_FACTOR\n				#include "specularityFactorPS"\n			#endif\n			#ifdef STD_SPECULAR_COLOR\n				#include "specularPS"\n			#else\n				void getSpecularity() { \n					dSpecularity = vec3(1);\n				}\n			#endif\n			#include "glossPS"\n		#endif\n		#ifdef STD_AO\n			#include "aoPS"\n		#endif\n		#include "emissivePS"\n		#ifdef LIT_CLEARCOAT\n			#include "clearCoatPS"\n			#include "clearCoatGlossPS"\n			#include "clearCoatNormalPS"\n		#endif\n		#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)\n			#include "anisotropyPS"\n		#endif\n		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n			#include "lightmapPS"\n		#endif\n	#endif\n	void evaluateFrontend() {\n		#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n			getOpacity();\n			#if defined(LIT_ALPHA_TEST)\n				alphaTest(dAlpha);\n			#endif\n			#if STD_OPACITY_DITHER != NONE\n				opacityDither(dAlpha, 0.0);\n			#endif\n			litArgs_opacity = dAlpha;\n		#endif\n		#ifdef FORWARD_PASS\n			#ifdef STD_HEIGHT_MAP\n				getParallax();\n			#endif\n			getAlbedo();\n			litArgs_albedo = dAlbedo;\n			#ifdef LIT_NEEDS_NORMAL\n				getNormal();\n				litArgs_worldNormal = dNormalW;\n			#endif\n			#ifdef LIT_REFRACTION\n				getRefraction();\n				litArgs_transmission = dTransmission;\n				getThickness();\n				litArgs_thickness = dThickness;\n				#ifdef LIT_DISPERSION\n					litArgs_dispersion = material_dispersion;\n				#endif\n			#endif\n			#ifdef LIT_IRIDESCENCE\n				getIridescence();\n				getIridescenceThickness();\n				litArgs_iridescence_intensity = dIridescence;\n				litArgs_iridescence_thickness = dIridescenceThickness;\n			#endif\n			#ifdef LIT_SPECULAR_OR_REFLECTION\n				#ifdef LIT_SHEEN\n					getSheen();\n					litArgs_sheen_specularity = sSpecularity;\n					getSheenGlossiness();\n					litArgs_sheen_gloss = sGlossiness;\n				#endif\n				#ifdef LIT_METALNESS\n					getMetalness();\n					litArgs_metalness = dMetalness;\n					getIor();\n					litArgs_ior = dIor;\n				#endif\n				#ifdef LIT_SPECULARITY_FACTOR\n					getSpecularityFactor();\n					litArgs_specularityFactor = dSpecularityFactor;\n				#endif\n				getGlossiness();\n				getSpecularity();\n				litArgs_specularity = dSpecularity;\n				litArgs_gloss = dGlossiness;\n			#endif\n			#ifdef STD_AO\n				getAO();\n				litArgs_ao = dAo;\n			#endif\n			getEmission();\n			litArgs_emission = dEmission;\n			#ifdef LIT_CLEARCOAT\n				getClearCoat();\n				getClearCoatGlossiness();\n				getClearCoatNormal();\n				litArgs_clearcoat_specularity = ccSpecularity;\n				litArgs_clearcoat_gloss = ccGlossiness;\n				litArgs_clearcoat_worldNormal = ccNormalW;\n			#endif\n			#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)\n				getAnisotropy();\n			#endif\n			#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n				getLightMap();\n				litArgs_lightmap = dLightmap;\n				#ifdef STD_LIGHTMAP_DIR\n					litArgs_lightmapDir = dLightmapDir;\n				#endif\n			#endif\n		#endif\n	}\n',TBNPS:"\n#ifdef LIT_TANGENTS\n	#define TBN_TANGENTS\n#else\n	#if defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)\n		#define TBN_DERIVATIVES\n	#endif\n#endif\n#if defined(TBN_DERIVATIVES)\n	uniform float tbnBasis;\n#endif\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n	#ifdef TBN_TANGENTS\n		dTBN = mat3(normalize(tangent), normalize(binormal), normalize(normal));\n	#elif defined(TBN_DERIVATIVES)\n		vec2 uv = {lightingUv};\n		vec3 dp1 = dFdx( vPositionW );\n		vec3 dp2 = dFdy( vPositionW );\n		vec2 duv1 = dFdx( uv );\n		vec2 duv2 = dFdy( uv );\n		vec3 dp2perp = cross( dp2, normal );\n		vec3 dp1perp = cross( normal, dp1 );\n		vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n		vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n		float denom = max( dot(T,T), dot(B,B) );\n		float invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );\n		dTBN = mat3(T * invmax, -B * invmax, normal );\n	#else\n		vec3 B = cross(normal, vObjectSpaceUpW);\n		vec3 T = cross(normal, B);\n		if (dot(B,B)==0.0)\n		{\n			float major=max(max(normal.x, normal.y), normal.z);\n			if (normal.x == major)\n			{\n				B = cross(normal, vec3(0,1,0));\n				T = cross(normal, B);\n			}\n			else if (normal.y == major)\n			{\n				B = cross(normal, vec3(0,0,1));\n				T = cross(normal, B);\n			}\n			else if (normal.z == major)\n			{\n				B = cross(normal, vec3(1,0,0));\n				T = cross(normal, B);\n			}\n		}\n		dTBN = mat3(normalize(T), normalize(B), normalize(normal));\n	#endif\n}\n",thicknessPS:"\n#ifdef STD_THICKNESS_CONSTANT\nuniform float material_thickness;\n#endif\nvoid getThickness() {\n	dThickness = 1.0;\n	#ifdef STD_THICKNESS_CONSTANT\n	dThickness *= material_thickness;\n	#endif\n	#ifdef STD_THICKNESS_TEXTURE\n	dThickness *= texture2DBias({STD_THICKNESS_TEXTURE_NAME}, {STD_THICKNESS_TEXTURE_UV}, textureBias).{STD_THICKNESS_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_THICKNESS_VERTEX\n	dThickness *= saturate(vVertexColor.{STD_THICKNESS_VERTEX_CHANNEL});\n	#endif\n}\n",tonemappingPS:'\n#if (TONEMAP == NONE)\n	#include "tonemappingNonePS"\n#elif TONEMAP == FILMIC\n	#include "tonemappingFilmicPS"\n#elif TONEMAP == LINEAR\n	#include "tonemappingLinearPS"\n#elif TONEMAP == HEJL\n	#include "tonemappingHejlPS"\n#elif TONEMAP == ACES\n	#include "tonemappingAcesPS"\n#elif TONEMAP == ACES2\n	#include "tonemappingAces2PS"\n#elif TONEMAP == NEUTRAL\n	#include "tonemappingNeutralPS"\n#endif\n',tonemappingAcesPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n	float tA = 2.51;\n	float tB = 0.03;\n	float tC = 2.43;\n	float tD = 0.59;\n	float tE = 0.14;\n	vec3 x = color * exposure;\n	return (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"\nuniform float exposure;\nconst mat3 ACESInputMat = mat3(\n	0.59719, 0.35458, 0.04823,\n	0.07600, 0.90834, 0.01566,\n	0.02840, 0.13383, 0.83777\n);\nconst mat3 ACESOutputMat = mat3(\n	 1.60475, -0.53108, -0.07367,\n	-0.10208,  1.10813, -0.00605,\n	-0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n	vec3 a = v * (v + 0.0245786) - 0.000090537;\n	vec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n	return a / b;\n}\nvec3 toneMap(vec3 color) {\n	color *= exposure / 0.6;\n	color = color * ACESInputMat;\n	color = RRTAndODTFit(color);\n	color = color * ACESOutputMat;\n	color = clamp(color, 0.0, 1.0);\n	return color;\n}\n",tonemappingFilmicPS:"\nconst float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n	color = uncharted2Tonemap(color * exposure);\n	vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n	color = color * whiteScale;\n	return color;\n}\n",tonemappingHejlPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n	color *= exposure;\n	const float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n	const float Scl = 1.25;\n	vec3 h = max( vec3(0.0), color - vec3(0.004) );\n	return (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",tonemappingLinearPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n	return color * exposure;\n}\n",tonemappingNeutralPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n	color *= exposure;\n	float startCompression = 0.8 - 0.04;\n	float desaturation = 0.15;\n	float x = min(color.r, min(color.g, color.b));\n	float offset = x < 0.08 ? x - 6.25 * x * x : 0.04;\n	color -= offset;\n	float peak = max(color.r, max(color.g, color.b));\n	if (peak < startCompression) return color;\n	float d = 1. - startCompression;\n	float newPeak = 1. - d * d / (peak + d - startCompression);\n	color *= newPeak / peak;\n	float g = 1. - 1. / (desaturation * (peak - newPeak) + 1.);\n	return mix(color, newPeak * vec3(1, 1, 1), g);\n}\n",tonemappingNonePS:"\nvec3 toneMap(vec3 color) {\n	return color;\n}\n",transformVS:"\n#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n#ifdef SCREENSPACE\nuniform float projectionFlipY;\n#endif\nvec4 evalWorldPosition(vec3 vertexPosition, mat4 modelMatrix) {\n	vec3 localPos = getLocalPosition(vertexPosition);\n	#ifdef NINESLICED\n		localPos.xz *= outerScale;\n		vec2 positiveUnitOffset = clamp(vertexPosition.xz, vec2(0.0), vec2(1.0));\n		vec2 negativeUnitOffset = clamp(-vertexPosition.xz, vec2(0.0), vec2(1.0));\n		localPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n		vTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;\n		localPos.xz *= -0.5;\n		localPos = localPos.xzy;\n	#endif\n	vec4 posW = modelMatrix * vec4(localPos, 1.0);\n	#ifdef SCREENSPACE\n		posW.zw = vec2(0.0, 1.0);\n	#endif\n	return posW;\n}\nvec4 getPosition() {\n	dModelMatrix = getModelMatrix();\n	vec4 posW = evalWorldPosition(vertex_position.xyz, dModelMatrix);\n	dPositionW = posW.xyz;\n	vec4 screenPos;\n	#ifdef UV1LAYOUT\n		screenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n		#ifdef WEBGPU\n			screenPos.y *= -1.0;\n		#endif\n	#else\n		#ifdef SCREENSPACE\n			screenPos = posW;\n			screenPos.y *= projectionFlipY;\n		#else\n			screenPos = matrix_viewProjection * posW;\n		#endif\n		#ifdef PIXELSNAP\n			screenPos.xy = (screenPos.xy * 0.5) + 0.5;\n			screenPos.xy *= uScreenSize.xy;\n			screenPos.xy = floor(screenPos.xy);\n			screenPos.xy *= uScreenSize.zw;\n			screenPos.xy = (screenPos.xy * 2.0) - 1.0;\n		#endif\n	#endif\n	return screenPos;\n}\nvec3 getWorldPosition() {\n	return dPositionW;\n}\n",transformCoreVS:'\nattribute vec4 vertex_position;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifdef MORPHING\n	uniform vec2 morph_tex_params;\n	attribute uint morph_vertex_id;\n	ivec2 getTextureMorphCoords() {\n		ivec2 textureSize = ivec2(morph_tex_params);\n		int morphGridV = int(morph_vertex_id) / textureSize.x;\n		int morphGridU = int(morph_vertex_id) - (morphGridV * textureSize.x);\n		#ifdef WEBGPU\n			morphGridV = textureSize.y - morphGridV - 1;\n		#endif\n		return ivec2(morphGridU, morphGridV);\n	}\n	#ifdef MORPHING_POSITION\n		#ifdef MORPHING_INT\n			uniform vec3 aabbSize;\n			uniform vec3 aabbMin;\n			uniform usampler2D morphPositionTex;\n		#else\n			uniform highp sampler2D morphPositionTex;\n		#endif\n	#endif\n#endif\n#ifdef defined(BATCH)\n	#include "skinBatchVS"\n	mat4 getModelMatrix() {\n		return getBoneMatrix(vertex_boneIndices);\n	}\n#elif defined(SKIN)\n	#include "skinVS"\n	mat4 getModelMatrix() {\n		return matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n	}\n#elif defined(INSTANCING)\n	#include "transformInstancingVS"\n#else\n	mat4 getModelMatrix() {\n		return matrix_model;\n	}\n#endif\nvec3 getLocalPosition(vec3 vertexPosition) {\n	vec3 localPos = vertexPosition;\n	#ifdef MORPHING_POSITION\n		ivec2 morphUV = getTextureMorphCoords();\n		#ifdef MORPHING_INT\n			vec3 morphPos = vec3(texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz) / 65535.0 * aabbSize + aabbMin;\n		#else\n			vec3 morphPos = texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz;\n		#endif\n		localPos += morphPos;\n	#endif\n	return localPos;\n}\n',transformInstancingVS:"\nattribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\nmat4 getModelMatrix() {\n	return matrix_model * mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n}\n",transmissionPS:"\n#ifdef STD_REFRACTION_CONSTANT\nuniform float material_refraction;\n#endif\nvoid getRefraction() {\n	float refraction = 1.0;\n	#ifdef STD_REFRACTION_CONSTANT\n	refraction = material_refraction;\n	#endif\n	#ifdef STD_REFRACTION_TEXTURE\n	refraction *= texture2DBias({STD_REFRACTION_TEXTURE_NAME}, {STD_REFRACTION_TEXTURE_UV}, textureBias).{STD_REFRACTION_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_REFRACTION_VERTEX\n	refraction *= saturate(vVertexColor.{STD_REFRACTION_VERTEX_CHANNEL});\n	#endif\n	dTransmission = refraction;\n}\n",twoSidedLightingPS:"\nuniform float twoSidedLightingNegScaleFactor;\nvoid handleTwoSidedLighting() {\n	dTBN[2] *= gl_FrontFacing ? twoSidedLightingNegScaleFactor : -twoSidedLightingNegScaleFactor;\n}\n",uv0VS:"\n#ifdef NINESLICED\n	vec2 getUv0() {\n		vec2 uv = vertex_position.xz;\n		vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n		vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n		uv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n		uv = uv * -0.5 + 0.5;\n		uv = uv * atlasRect.zw + atlasRect.xy;\n		vMask = vertex_texCoord0.xy;\n		return uv;\n	}\n#else\n	vec2 getUv0() {\n		return vertex_texCoord0;\n	}\n#endif\n",uv1VS:"\nvec2 getUv1() {\n	return vertex_texCoord1;\n}\n",uvTransformVS:"\nvUV{TRANSFORM_UV_{i}}_{TRANSFORM_ID_{i}} = vec2(\n	dot(vec3(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}0),\n	dot(vec3(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}1)\n);\n",uvTransformUniformsPS:"\n	uniform vec3 {TRANSFORM_NAME_{i}}0;\n	uniform vec3 {TRANSFORM_NAME_{i}}1;\n",viewDirPS:"\nvoid getViewDir() {\n	dViewDirW = normalize(view_position - vPositionW);\n}\n",webgpuPS:rj,webgpuVS:rX},mE={alphaTestPS:"\nuniform alpha_ref: f32;\nfn alphaTest(a: f32) {\n	if (a < uniform.alpha_ref) {\n		discard;\n	}\n}\n",ambientPS:'\n#if LIT_AMBIENT_SOURCE == AMBIENTSH\n	uniform ambientSH: array<vec3f, 9>;\n#endif\n#if LIT_AMBIENT_SOURCE == ENVALATLAS\n	#include "envAtlasPS"\n	#ifndef ENV_ATLAS\n		#define ENV_ATLAS\n		var texture_envAtlas: texture_2d<f32>;\n		var texture_envAtlasSampler: sampler;\n	#endif\n#endif\nfn addAmbient(worldNormal: vec3f) {\n	#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH\n		let n: vec3f = cubeMapRotate(worldNormal);\n		let color: vec3f =\n			uniform.ambientSH[0] +\n			uniform.ambientSH[1] * n.x +\n			uniform.ambientSH[2] * n.y +\n			uniform.ambientSH[3] * n.z +\n			uniform.ambientSH[4] * n.x * n.z +\n			uniform.ambientSH[5] * n.z * n.y +\n			uniform.ambientSH[6] * n.y * n.x +\n			uniform.ambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n			uniform.ambientSH[8] * (n.x * n.x - n.y * n.y);\n		dDiffuseLight += processEnvironment(max(color, vec3f(0.0)));\n	#endif\n	#if LIT_AMBIENT_SOURCE == ENVALATLAS\n		let dir: vec3f = normalize(cubeMapRotate(worldNormal) * vec3f(-1.0, 1.0, 1.0));\n		let uv: vec2f = mapUv(toSphericalUv(dir), vec4f(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);\n		let raw: vec4f = textureSample(texture_envAtlas, texture_envAtlasSampler, uv);\n		let linear: vec3f = {ambientDecode}(raw);\n		dDiffuseLight += processEnvironment(linear);\n	#endif\n	#if LIT_AMBIENT_SOURCE == CONSTANT\n		dDiffuseLight += uniform.light_globalAmbient;\n	#endif\n}\n',anisotropyPS:"\n#ifdef LIT_GGX_SPECULAR\n	uniform material_anisotropyIntensity: f32;\n	uniform material_anisotropyRotation: vec2f;\n#endif\nfn getAnisotropy() {\n	dAnisotropy = 0.0;\n	dAnisotropyRotation = vec2f(1.0, 0.0);\n#ifdef LIT_GGX_SPECULAR\n	dAnisotropy = uniform.material_anisotropyIntensity;\n	dAnisotropyRotation = uniform.material_anisotropyRotation;\n#endif\n#ifdef STD_ANISOTROPY_TEXTURE\n	let anisotropyTex: vec3f = textureSampleBias({STD_ANISOTROPY_TEXTURE_NAME}, {STD_ANISOTROPY_TEXTURE_NAME}Sampler, {STD_ANISOTROPY_TEXTURE_UV}, uniform.textureBias).rgb;\n	dAnisotropy *= anisotropyTex.b;\n	let anisotropyRotationFromTex: vec2f = anisotropyTex.rg * 2.0 - vec2f(1.0);\n	let rotationMatrix: mat2x2f = mat2x2f(dAnisotropyRotation.x, dAnisotropyRotation.y, -dAnisotropyRotation.y, dAnisotropyRotation.x);\n	dAnisotropyRotation = rotationMatrix * anisotropyRotationFromTex;\n#endif\n	dAnisotropy = clamp(dAnisotropy, 0.0, 1.0);\n}\n",aoPS:'\n#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)\n	uniform material_aoIntensity: f32;\n#endif\n#ifdef STD_AODETAIL_TEXTURE\n	#include "detailModesPS"\n#endif\nfn getAO() {\n	dAo = 1.0;\n	#ifdef STD_AO_TEXTURE\n		var aoBase: f32 = textureSampleBias({STD_AO_TEXTURE_NAME}, {STD_AO_TEXTURE_NAME}Sampler, {STD_AO_TEXTURE_UV}, uniform.textureBias).{STD_AO_TEXTURE_CHANNEL};\n		#ifdef STD_AODETAIL_TEXTURE\n			var aoDetail: f32 = textureSampleBias({STD_AODETAIL_TEXTURE_NAME}, {STD_AODETAIL_TEXTURE_NAME}Sampler, {STD_AODETAIL_TEXTURE_UV}, uniform.textureBias).{STD_AODETAIL_TEXTURE_CHANNEL};\n			aoBase = detailMode_{STD_AODETAIL_DETAILMODE}(vec3f(aoBase), vec3f(aoDetail)).r;\n		#endif\n		dAo = dAo * aoBase;\n	#endif\n	#ifdef STD_AO_VERTEX\n		dAo = dAo * saturate(vVertexColor.{STD_AO_VERTEX_CHANNEL});\n	#endif\n	#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)\n		dAo = mix(1.0, dAo, uniform.material_aoIntensity);\n	#endif\n}\n',aoDiffuseOccPS:"\nfn occludeDiffuse(ao: f32) {\n	dDiffuseLight = dDiffuseLight * ao;\n}\n",aoSpecOccPS:"\n#if LIT_OCCLUDE_SPECULAR != NONE\n	#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n		uniform material_occludeSpecularIntensity: f32;\n	#endif\n#endif\nfn occludeSpecular(gloss: f32, ao: f32, worldNormal: vec3f, viewDir: vec3f) {\n	#if LIT_OCCLUDE_SPECULAR == AO\n		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n			var specOcc: f32 = mix(1.0, ao, uniform.material_occludeSpecularIntensity);\n		#else\n			var specOcc: f32 = ao;\n		#endif\n	#endif\n	#if LIT_OCCLUDE_SPECULAR == GLOSSDEPENDENT\n		var specPow: f32 = exp2(gloss * 11.0);\n		var specOcc: f32 = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01 * specPow) - 1.0 + ao);\n		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n			specOcc = mix(1.0, specOcc, uniform.material_occludeSpecularIntensity);\n		#endif\n	#endif\n	#if LIT_OCCLUDE_SPECULAR != NONE\n		dSpecularLight = dSpecularLight * specOcc;\n		dReflection = dReflection * specOcc;\n		#ifdef LIT_SHEEN\n			sSpecularLight = sSpecularLight * specOcc;\n			sReflection = sReflection * specOcc;\n		#endif\n	#endif\n}\n",bakeDirLmEndPS:"\n	let dirLm = textureSample(texture_dirLightMap, texture_dirLightMapSampler, vUv1);\n	if (uniform.bakeDir > 0.5) {\n		if (dAtten > 0.00001) {\n			let unpacked_dir = dirLm.xyz * 2.0 - vec3f(1.0);\n			dAtten = clamp(dAtten, 0.0, 1.0);\n			let combined_dir = dLightDirNormW.xyz * dAtten + unpacked_dir * dirLm.w;\n			let finalRgb = normalize(combined_dir) * 0.5 + vec3f(0.5);\n			let finalA = max(dirLm.w + dAtten, 1.0 / 255.0);\n			output.color = vec4f(finalRgb, finalA);\n		} else {\n			output.color = dirLm;\n		}\n	} else {\n		let alpha_min = select(0.0, 1.0 / 255.0, dAtten > 0.00001);\n		let finalA = max(dirLm.w, alpha_min);\n		output.color = vec4f(dirLm.rgb, finalA);\n	}\n",bakeLmEndPS:"\n#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT\n	dDiffuseLight = ((dDiffuseLight - 0.5) * max(uniform.ambientBakeOcclusionContrast + 1.0, 0.0)) + 0.5;\n	dDiffuseLight = dDiffuseLight + vec3f(uniform.ambientBakeOcclusionBrightness);\n	dDiffuseLight = saturate3(dDiffuseLight);\n	dDiffuseLight = dDiffuseLight * dAmbientLight;\n#endif\n#ifdef LIGHTMAP_RGBM\n	var temp_color_rgbm = vec4f(dDiffuseLight, 1.0);\n	temp_color_rgbm = vec4f(pow(temp_color_rgbm.rgb, vec3f(0.5)), temp_color_rgbm.a);\n	temp_color_rgbm = vec4f(temp_color_rgbm.rgb / 8.0, temp_color_rgbm.a);\n	let max_g_b = max(temp_color_rgbm.g, max(temp_color_rgbm.b, 1.0 / 255.0));\n	let max_rgb = max(temp_color_rgbm.r, max_g_b);\n	temp_color_rgbm.a = clamp(max_rgb, 0.0, 1.0);\n	temp_color_rgbm.a = ceil(temp_color_rgbm.a * 255.0) / 255.0;\n	temp_color_rgbm = vec4f(temp_color_rgbm.rgb / temp_color_rgbm.a, temp_color_rgbm.a);\n	output.color = temp_color_rgbm;\n#else\n	output.color = vec4f(dDiffuseLight, 1.0);\n#endif\n",basePS:"\nuniform view_position: vec3f;\nuniform light_globalAmbient: vec3f;\nfn square(x: f32) -> f32 {\n	return x*x;\n}\nfn saturate(x: f32) -> f32 {\n	return clamp(x, 0.0, 1.0);\n}\nfn saturate3(x: vec3f) -> vec3f {\n	return clamp(x, vec3f(0.0), vec3f(1.0));\n}\n",baseNineSlicedPS:"\n#define NINESLICED\nvarying vMask: vec2f;\nvarying vTiledUv: vec2f;\nuniform innerOffset: vec4f;\nuniform outerScale: vec2f;\nuniform atlasRect: vec4f;\nvar<private> nineSlicedUv: vec2f;\n",baseNineSlicedTiledPS:"\n#define NINESLICED\n#define NINESLICETILED\nvarying vMask: vec2f;\nvarying vTiledUv: vec2f;\nuniform innerOffset: vec4f;\nuniform outerScale: vec2f;\nuniform atlasRect: vec4f;\nvar<private> nineSlicedUv: vec2f;\n",bayerPS:"\nfn bayer2(p: vec2f) -> f32 {\n	return (2.0 * p.y + p.x + 1.0) % 4.0;\n}\nfn bayer4(p: vec2f) -> f32 {\n	let p1: vec2f = p % vec2f(2.0);\n	let p2: vec2f = floor(0.5 * (p % vec2f(4.0)));\n	return 4.0 * bayer2(p1) + bayer2(p2);\n}\nfn bayer8(p: vec2f) -> f32 {\n	let p1: vec2f = p % vec2f(2.0);\n	let p2: vec2f = floor(0.5 * (p % vec2f(4.0)));\n	let p4: vec2f = floor(0.25 * (p % vec2f(8.0)));\n	return 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);\n}\n",blurVSMPS:"\nvarying vUv0: vec2f;\nvar source: texture_2d<f32>;\nvar sourceSampler: sampler;\n#ifdef GAUSS\n	uniform weight: array<f32, {SAMPLES}>;\n#endif\nuniform pixelOffset: vec2f;\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n	var output: FragmentOutput;\n	var moments: vec3f = vec3f(0.0);\n	let uv: vec2f = input.vUv0 - uniform.pixelOffset * (f32({SAMPLES}) * 0.5);\n	for (var i: i32 = 0; i < {SAMPLES}; i = i + 1) {\n		let c: vec4f = textureSample(source, sourceSampler, uv + uniform.pixelOffset * f32(i));\n		#ifdef GAUSS\n			moments = moments + c.xyz * uniform.weight[i].element;\n		#else\n			moments = moments + c.xyz;\n		#endif\n	}\n	#ifndef GAUSS\n		moments = moments * (1.0 / f32({SAMPLES}));\n	#endif\n	output.color = vec4f(moments, 1.0);\n	return output;\n}\n",clearCoatPS:"\nuniform material_clearCoat: f32;\nfn getClearCoat() {\n	ccSpecularity = uniform.material_clearCoat;\n	#ifdef STD_CLEARCOAT_TEXTURE\n	ccSpecularity = ccSpecularity * textureSampleBias({STD_CLEARCOAT_TEXTURE_NAME}, {STD_CLEARCOAT_TEXTURE_NAME}Sampler, {STD_CLEARCOAT_TEXTURE_UV}, uniform.textureBias).{STD_CLEARCOAT_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_CLEARCOAT_VERTEX\n	ccSpecularity = ccSpecularity * saturate(vVertexColor.{STD_CLEARCOAT_VERTEX_CHANNEL});\n	#endif\n}\n",clearCoatGlossPS:"\n	uniform material_clearCoatGloss: f32;\nfn getClearCoatGlossiness() {\n	ccGlossiness = uniform.material_clearCoatGloss;\n	#ifdef STD_CLEARCOATGLOSS_TEXTURE\n	ccGlossiness = ccGlossiness * textureSampleBias({STD_CLEARCOATGLOSS_TEXTURE_NAME}, {STD_CLEARCOATGLOSS_TEXTURE_NAME}Sampler, {STD_CLEARCOATGLOSS_TEXTURE_UV}, uniform.textureBias).{STD_CLEARCOATGLOSS_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_CLEARCOATGLOSS_VERTEX\n	ccGlossiness = ccGlossiness * saturate(vVertexColor.{STD_CLEARCOATGLOSS_VERTEX_CHANNEL});\n	#endif\n	#ifdef STD_CLEARCOATGLOSS_INVERT\n	ccGlossiness = 1.0 - ccGlossiness;\n	#endif\n	ccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"\n#ifdef STD_CLEARCOATNORMAL_TEXTURE\n	uniform material_clearCoatBumpiness: f32;\n#endif\nfn getClearCoatNormal() {\n#ifdef STD_CLEARCOATNORMAL_TEXTURE\n	var normalMap: vec3f = {STD_CLEARCOATNORMAL_TEXTURE_DECODE}(textureSampleBias({STD_CLEARCOATNORMAL_TEXTURE_NAME}, {STD_CLEARCOATNORMAL_TEXTURE_NAME}Sampler, {STD_CLEARCOATNORMAL_TEXTURE_UV}, uniform.textureBias));\n	normalMap = mix(vec3f(0.0, 0.0, 1.0), normalMap, uniform.material_clearCoatBumpiness);\n	ccNormalW = normalize(dTBN * normalMap);\n#else\n	ccNormalW = dVertexNormalW;\n#endif\n}\n",clusteredLightCookiesPS:"\nfn _getCookieClustered(tex: texture_2d<f32>, texSampler: sampler, uv: vec2f, intensity: f32, cookieChannel: vec4f) -> vec3f {\n	let pixel: vec4f = mix(vec4f(1.0), textureSampleLevel(tex, texSampler, uv, 0.0), intensity);\n	let isRgb: bool = dot(cookieChannel.rgb, vec3f(1.0)) == 3.0;\n	return select(vec3f(dot(pixel, cookieChannel)), pixel.rgb, isRgb);\n}\nfn getCookie2DClustered(tex: texture_2d<f32>, texSampler: sampler, transform: mat4x4f, worldPosition: vec3f, intensity: f32, cookieChannel: vec4f) -> vec3f {\n	let projPos: vec4f = transform * vec4f(worldPosition, 1.0);\n	return _getCookieClustered(tex, texSampler, projPos.xy / projPos.w, intensity, cookieChannel);\n}\nfn getCookieCubeClustered(tex: texture_2d<f32>, texSampler: sampler, dir: vec3f, intensity: f32, cookieChannel: vec4f, shadowTextureResolution: f32, shadowEdgePixels: f32, omniAtlasViewport: vec3f) -> vec3f {\n	let uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n	return _getCookieClustered(tex, texSampler, uv, intensity, cookieChannel);\n}\n",clusteredLightShadowsPS:"\nfn _getShadowCoordPerspZbuffer(shadowMatrix: mat4x4f, shadowParams: vec4f, wPos: vec3f) -> vec3f {\n	var projPos = shadowMatrix * vec4f(wPos, 1.0);\n	return projPos.xyz / projPos.w;\n}\nfn getShadowCoordPerspZbufferNormalOffset(shadowMatrix: mat4x4f, shadowParams: vec4f, normal: vec3f) -> vec3f {\n	let wPos: vec3f = vPositionW + normal * shadowParams.y;\n	return _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nfn normalOffsetPointShadow(shadowParams: vec4f, lightPos: vec3f, lightDir: vec3f, lightDirNorm: vec3f, normal: vec3f) -> vec3f {\n	let distScale: f32 = length(lightDir);\n	let wPos: vec3f = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n	let dir: vec3f = wPos - lightPos;\n	return dir;\n}\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n	fn getShadowOmniClusteredPCF1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowParams: vec4f, omniAtlasViewport: vec3f, shadowEdgePixels: f32, lightDir: vec3f) -> f32 {\n		let shadowTextureResolution: f32 = shadowParams.x;\n		let uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n		let shadowZ: f32 = length(lightDir) * shadowParams.w + shadowParams.z;\n		return textureSampleCompareLevel(shadowMap, shadowMapSampler, uv, shadowZ);\n	}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n	fn getShadowOmniClusteredPCF3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowParams: vec4f, omniAtlasViewport: vec3f, shadowEdgePixels: f32, lightDir: vec3f) -> f32 {\n		let shadowTextureResolution: f32 = shadowParams.x;\n		let uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n		let shadowZ: f32 = length(lightDir) * shadowParams.w + shadowParams.z;\n		let shadowCoord: vec3f = vec3f(uv, shadowZ);\n		return getShadowPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams);\n	}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n	fn getShadowOmniClusteredPCF5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowParams: vec4f, omniAtlasViewport: vec3f, shadowEdgePixels: f32, lightDir: vec3f) -> f32 {\n		let shadowTextureResolution: f32 = shadowParams.x;\n		let uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n		let shadowZ: f32 = length(lightDir) * shadowParams.w + shadowParams.z;\n		let shadowCoord: vec3f = vec3f(uv, shadowZ);\n		return getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams);\n	}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n	fn getShadowSpotClusteredPCF1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n		return textureSampleCompareLevel(shadowMap, shadowMapSampler, shadowCoord.xy, shadowCoord.z);\n	}\n#endif\n	#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n	fn getShadowSpotClusteredPCF3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n		return getShadowSpotPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams);\n	}\n#endif\n	#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n	fn getShadowSpotClusteredPCF5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n		return getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams);\n	}\n#endif\n",clusteredLightUtilsPS:"\nstruct FaceCoords {\n	uv: vec2f,\n	faceIndex: f32,\n	tileOffset: vec2f,\n}\nfn getCubemapFaceCoordinates(dir: vec3f) -> FaceCoords {\n	var faceIndex: f32;\n	var tileOffset: vec2f;\n	var uv: vec2f;\n	let vAbs: vec3f = abs(dir);\n	var ma: f32;\n	if (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {\n		let is_neg_z = dir.z < 0.0;\n		faceIndex = select(4.0, 5.0, is_neg_z);\n		ma = 0.5 / vAbs.z;\n		uv = vec2f(select(dir.x, -dir.x, is_neg_z), -dir.y);\n		tileOffset = vec2f(2.0, select(0.0, 1.0, is_neg_z));\n	} else if (vAbs.y >= vAbs.x) {\n		let is_neg_y = dir.y < 0.0;\n		faceIndex = select(2.0, 3.0, is_neg_y);\n		ma = 0.5 / vAbs.y;\n		uv = vec2f(dir.x, select(dir.z, -dir.z, is_neg_y));\n		tileOffset = vec2f(1.0, select(0.0, 1.0, is_neg_y));\n	} else {\n		let is_neg_x = dir.x < 0.0;\n		faceIndex = select(0.0, 1.0, is_neg_x);\n		ma = 0.5 / vAbs.x;\n		uv = vec2f(select(-dir.z, dir.z, is_neg_x), -dir.y);\n		tileOffset = vec2f(0.0, select(0.0, 1.0, is_neg_x));\n	}\n	uv = uv * ma + 0.5;\n	return FaceCoords(uv, faceIndex, tileOffset);\n}\nfn getCubemapAtlasCoordinates(omniAtlasViewport: vec3f, shadowEdgePixels: f32, shadowTextureResolution: f32, dir: vec3f) -> vec2f {\n	let faceData: FaceCoords = getCubemapFaceCoordinates(dir);\n	var uv: vec2f = faceData.uv;\n	let tileOffset: vec2f = faceData.tileOffset;\n	let atlasFaceSize: f32 = omniAtlasViewport.z;\n	let tileSize: f32 = shadowTextureResolution * atlasFaceSize;\n	var offset: f32 = shadowEdgePixels / tileSize;\n	uv = uv * (1.0 - offset * 2.0) + offset;\n	uv = uv * atlasFaceSize;\n	uv = uv + tileOffset * atlasFaceSize;\n	uv = uv + omniAtlasViewport.xy;\n	return uv;\n}\n",clusteredLightPS:'\n#include "lightBufferDefinesPS"\n#include "clusteredLightUtilsPS"\n#ifdef CLUSTER_COOKIES\n	#include "clusteredLightCookiesPS"\n#endif\n#ifdef CLUSTER_SHADOWS\n	#include "clusteredLightShadowsPS"\n#endif\nvar clusterWorldTexture: texture_2d<f32>;\nvar lightsTexture: texture_2d<f32>;\n#ifdef CLUSTER_SHADOWS\n	var shadowAtlasTexture: texture_depth_2d;\n	var shadowAtlasTextureSampler: sampler_comparison;\n#endif\n#ifdef CLUSTER_COOKIES\n	var cookieAtlasTexture: texture_2d<f32>;\n	var cookieAtlasTextureSampler: sampler;\n#endif\nuniform clusterMaxCells: i32;\nuniform clusterSkip: f32;\nuniform clusterCellsCountByBoundsSize: vec3f;\nuniform clusterTextureSize: vec3f;\nuniform clusterBoundsMin: vec3f;\nuniform clusterBoundsDelta: vec3f;\nuniform clusterCellsDot: vec3f;\nuniform clusterCellsMax: vec3f;\nuniform shadowAtlasParams: vec2f;\nstruct ClusterLightData {\n	flags: u32,\n	halfWidth: vec3f,\n	isSpot: bool,\n	halfHeight: vec3f,\n	lightIndex: i32,\n	position: vec3f,\n	shape: u32,\n	direction: vec3f,\n	falloffModeLinear: bool,\n	color: vec3f,\n	shadowIntensity: f32,\n	omniAtlasViewport: vec3f,\n	range: f32,\n	cookieChannelMask: vec4f,\n	biasesData: f32,\n	shadowBias: f32,\n	shadowNormalBias: f32,\n	anglesData: f32,\n	innerConeAngleCos: f32,\n	outerConeAngleCos: f32,\n	cookieIntensity: f32,\n	isDynamic: bool,\n	isLightmapped: bool\n}\nvar<private> lightProjectionMatrix: mat4x4f;\nfn sampleLightTextureF(lightIndex: i32, index: i32) -> vec4f {\n	return textureLoad(lightsTexture, vec2<i32>(index, lightIndex), 0);\n}\nfn decodeClusterLightCore(clusterLightData: ptr<function, ClusterLightData>, lightIndex: f32) {\n	clusterLightData.lightIndex = i32(lightIndex);\n	let halfData: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_COLOR_ANGLES_BIAS});\n	clusterLightData.anglesData = halfData.z;\n	clusterLightData.biasesData = halfData.w;\n	let colorRG: vec2f = unpack2x16float(bitcast<u32>(halfData.x));\n	let colorB_: vec2f = unpack2x16float(bitcast<u32>(halfData.y));\n	clusterLightData.color = vec3f(colorRG, colorB_.x) * {LIGHT_COLOR_DIVIDER};\n	let lightPosRange: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_POSITION_RANGE});\n	clusterLightData.position = lightPosRange.xyz;\n	clusterLightData.range = lightPosRange.w;\n	let lightDir_Flags: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_DIRECTION_FLAGS});\n	clusterLightData.direction = lightDir_Flags.xyz;\n	let flags_uint: u32 = bitcast<u32>(lightDir_Flags.w);\n	clusterLightData.flags = flags_uint;\n	clusterLightData.isSpot = (flags_uint & (1u << 30u)) != 0u;\n	clusterLightData.shape = (flags_uint >> 28u) & 0x3u;\n	clusterLightData.falloffModeLinear = (flags_uint & (1u << 27u)) == 0u;\n	clusterLightData.shadowIntensity = f32((flags_uint >> 0u) & 0xFFu) / 255.0;\n	clusterLightData.cookieIntensity = f32((flags_uint >> 8u) & 0xFFu) / 255.0;\n	clusterLightData.isDynamic = (flags_uint & (1u << 22u)) != 0u;\n	clusterLightData.isLightmapped = (flags_uint & (1u << 21u)) != 0u;\n}\nfn decodeClusterLightSpot(clusterLightData: ptr<function, ClusterLightData>) {\n	let angles: vec2f = unpack2x16float(bitcast<u32>(clusterLightData.anglesData));\n	clusterLightData.innerConeAngleCos = angles.x;\n	clusterLightData.outerConeAngleCos = angles.y;\n}\nfn decodeClusterLightOmniAtlasViewport(clusterLightData: ptr<function, ClusterLightData>) {\n	clusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_0}).xyz;\n}\nfn decodeClusterLightAreaData(clusterLightData: ptr<function, ClusterLightData>) {\n	clusterLightData.halfWidth = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_AREA_DATA_WIDTH}).xyz;\n	clusterLightData.halfHeight = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_AREA_DATA_HEIGHT}).xyz;\n}\nfn decodeClusterLightProjectionMatrixData(clusterLightData: ptr<function, ClusterLightData>) {\n	let m0: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_0});\n	let m1: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_1});\n	let m2: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_2});\n	let m3: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_3});\n	lightProjectionMatrix = mat4x4f(m0, m1, m2, m3);\n}\nfn decodeClusterLightShadowData(clusterLightData: ptr<function, ClusterLightData>) {\n	let biases: vec2f = unpack2x16float(bitcast<u32>(clusterLightData.biasesData));\n	clusterLightData.shadowBias = biases.x;\n	clusterLightData.shadowNormalBias = biases.y;\n}\nfn decodeClusterLightCookieData(clusterLightData: ptr<function, ClusterLightData>) {\n	let cookieFlags: u32 = (clusterLightData.flags >> 23u) & 0x0Fu;\n	let mask_uvec: vec4<u32> = vec4<u32>(cookieFlags) & vec4<u32>(1u, 2u, 4u, 8u);\n	clusterLightData.cookieChannelMask = step(vec4f(1.0), vec4f(mask_uvec));\n}\nfn evaluateLight(\n	light: ptr<function, ClusterLightData>,\n	worldNormal: vec3f,\n	viewDir: vec3f,\n	reflectionDir: vec3f,\n#if defined(LIT_CLEARCOAT)\n	clearcoatReflectionDir: vec3f,\n#endif\n	gloss: f32,\n	specularity: vec3f,\n	geometricNormal: vec3f,\n	tbn: mat3x3f,\n#if defined(LIT_IRIDESCENCE)\n	iridescenceFresnel: vec3f,\n#endif\n	clearcoat_worldNormal: vec3f,\n	clearcoat_gloss: f32,\n	sheen_gloss: f32,\n	iridescence_intensity: f32\n) {\n	var cookieAttenuation: vec3f = vec3f(1.0);\n	var diffuseAttenuation: f32 = 1.0;\n	var falloffAttenuation: f32 = 1.0;\n	let lightDirW: vec3f = evalOmniLight(light.position);\n	let lightDirNormW: vec3f = normalize(lightDirW);\n	#ifdef CLUSTER_AREALIGHTS\n	if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n		decodeClusterLightAreaData(light);\n		if (light.shape == {LIGHTSHAPE_RECT}) {\n			calcRectLightValues(light.position, light.halfWidth, light.halfHeight);\n		} else if (light.shape == {LIGHTSHAPE_DISK}) {\n			calcDiskLightValues(light.position, light.halfWidth, light.halfHeight);\n		} else {\n			calcSphereLightValues(light.position, light.halfWidth, light.halfHeight);\n		}\n		falloffAttenuation = getFalloffWindow(light.range, lightDirW);\n	} else\n	#endif\n	{\n		if (light.falloffModeLinear) {\n			falloffAttenuation = getFalloffLinear(light.range, lightDirW);\n		} else {\n			falloffAttenuation = getFalloffInvSquared(light.range, lightDirW);\n		}\n	}\n	if (falloffAttenuation > 0.00001) {\n		#ifdef CLUSTER_AREALIGHTS\n		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n			if (light.shape == {LIGHTSHAPE_RECT}) {\n				diffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n			} else if (light.shape == {LIGHTSHAPE_DISK}) {\n				diffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n			} else {\n				diffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n			}\n		} else\n		#endif\n		{\n			falloffAttenuation = falloffAttenuation * getLightDiffuse(worldNormal, viewDir, lightDirNormW);\n		}\n		if (light.isSpot) {\n			decodeClusterLightSpot(light);\n			falloffAttenuation = falloffAttenuation * getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, lightDirNormW);\n		}\n		#if defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)\n		if (falloffAttenuation > 0.00001) {\n			if (light.shadowIntensity > 0.0 || light.cookieIntensity > 0.0) {\n				if (light.isSpot) {\n					decodeClusterLightProjectionMatrixData(light);\n				} else {\n					decodeClusterLightOmniAtlasViewport(light);\n				}\n				let shadowTextureResolution: f32 = uniform.shadowAtlasParams.x;\n				let shadowEdgePixels: f32 = uniform.shadowAtlasParams.y;\n				#ifdef CLUSTER_COOKIES\n				if (light.cookieIntensity > 0.0) {\n					decodeClusterLightCookieData(light);\n					if (light.isSpot) {\n						cookieAttenuation = getCookie2DClustered(cookieAtlasTexture, cookieAtlasTextureSampler, lightProjectionMatrix, vPositionW, light.cookieIntensity, light.cookieChannelMask);\n					} else {\n						cookieAttenuation = getCookieCubeClustered(cookieAtlasTexture, cookieAtlasTextureSampler, lightDirW, light.cookieIntensity, light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);\n					}\n				}\n				#endif\n				#ifdef CLUSTER_SHADOWS\n				if (light.shadowIntensity > 0.0) {\n					decodeClusterLightShadowData(light);\n					let shadowParams: vec4f = vec4f(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);\n					if (light.isSpot) {\n						let shadowCoord: vec3f = getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);\n						#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n							let shadow: f32 = getShadowSpotClusteredPCF1(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);\n						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n							let shadow: f32 = getShadowSpotClusteredPCF3(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);\n						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n							let shadow: f32 = getShadowSpotClusteredPCF5(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);\n						#elif defined(CLUSTER_SHADOW_TYPE_PCSS)\n							let shadow: f32 = getShadowSpotClusteredPCSS(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);\n						#endif\n						falloffAttenuation = falloffAttenuation * mix(1.0, shadow, light.shadowIntensity);\n					} else {\n						let dir: vec3f = normalOffsetPointShadow(shadowParams, light.position, lightDirW, lightDirNormW, geometricNormal);\n						#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n							let shadow: f32 = getShadowOmniClusteredPCF1(shadowAtlasTexture, shadowAtlasTextureSampler, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n							let shadow: f32 = getShadowOmniClusteredPCF3(shadowAtlasTexture, shadowAtlasTextureSampler, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n							let shadow: f32 = getShadowOmniClusteredPCF5(shadowAtlasTexture, shadowAtlasTextureSampler, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n						#endif\n						falloffAttenuation = falloffAttenuation * mix(1.0, shadow, light.shadowIntensity);\n					}\n				}\n				#endif\n			}\n		}\n		#endif\n		#ifdef CLUSTER_AREALIGHTS\n		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n			{\n				var areaDiffuse: vec3f = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;\n				#if defined(LIT_SPECULAR)\n					areaDiffuse = mix(areaDiffuse, vec3f(0.0), dLTCSpecFres);\n				#endif\n				dDiffuseLight = dDiffuseLight + areaDiffuse;\n			}\n			#ifdef LIT_SPECULAR\n				var areaLightSpecular: f32;\n				if (light.shape == {LIGHTSHAPE_RECT}) {\n					areaLightSpecular = getRectLightSpecular(worldNormal, viewDir);\n				} else if (light.shape == {LIGHTSHAPE_DISK}) {\n					areaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);\n				} else {\n					areaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);\n				}\n				dSpecularLight = dSpecularLight + dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;\n				#ifdef LIT_CLEARCOAT\n					var areaLightSpecularCC: f32;\n					if (light.shape == {LIGHTSHAPE_RECT}) {\n						areaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);\n					} else if (light.shape == {LIGHTSHAPE_DISK}) {\n						areaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);\n					} else {\n						areaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);\n					}\n					ccSpecularLight = ccSpecularLight + ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;\n				#endif\n			#endif\n		} else\n		#endif\n		{\n			{\n				var punctualDiffuse: vec3f = falloffAttenuation * light.color * cookieAttenuation;\n				#if defined(CLUSTER_AREALIGHTS)\n				#if defined(LIT_SPECULAR)\n					punctualDiffuse = mix(punctualDiffuse, vec3f(0.0), specularity);\n				#endif\n				#endif\n				dDiffuseLight = dDiffuseLight + punctualDiffuse;\n			}\n			#ifdef LIT_SPECULAR\n				let halfDir: vec3f = normalize(-lightDirNormW + viewDir);\n				#ifdef LIT_SPECULAR_FRESNEL\n					dSpecularLight = dSpecularLight +\n						getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation *\n						getFresnel(\n							dot(viewDir, halfDir),\n							gloss,\n							specularity\n						#if defined(LIT_IRIDESCENCE)\n							, iridescenceFresnel,\n							iridescence_intensity\n						#endif\n							);\n				#else\n					dSpecularLight = dSpecularLight + getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;\n				#endif\n				#ifdef LIT_CLEARCOAT\n					#ifdef LIT_SPECULAR_FRESNEL\n						ccSpecularLight = ccSpecularLight + getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));\n					#else\n						ccSpecularLight = ccSpecularLight + getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation;\n					#endif\n				#endif\n				#ifdef LIT_SHEEN\n					sSpecularLight = sSpecularLight + getLightSpecularSheen(halfDir, worldNormal, viewDir, lightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;\n				#endif\n			#endif\n		}\n	}\n	dAtten = falloffAttenuation;\n	dLightDirNormW = lightDirNormW;\n}\nfn evaluateClusterLight(\n	lightIndex: f32,\n	worldNormal: vec3f,\n	viewDir: vec3f,\n	reflectionDir: vec3f,\n#if defined(LIT_CLEARCOAT)\n	clearcoatReflectionDir: vec3f,\n#endif\n	gloss: f32,\n	specularity: vec3f,\n	geometricNormal: vec3f,\n	tbn: mat3x3f,\n#if defined(LIT_IRIDESCENCE)\n	iridescenceFresnel: vec3f,\n#endif\n	clearcoat_worldNormal: vec3f,\n	clearcoat_gloss: f32,\n	sheen_gloss: f32,\n	iridescence_intensity: f32\n) {\n	var clusterLightData: ClusterLightData;\n	decodeClusterLightCore(&clusterLightData, lightIndex);\n	#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS\n		let acceptLightMask: bool = clusterLightData.isDynamic;\n	#else\n		let acceptLightMask: bool = clusterLightData.isLightmapped;\n	#endif\n	if (acceptLightMask) {\n		evaluateLight(\n			&clusterLightData,\n			worldNormal,\n			viewDir,\n			reflectionDir,\n#if defined(LIT_CLEARCOAT)\n			clearcoatReflectionDir,\n#endif\n			gloss,\n			specularity,\n			geometricNormal,\n			tbn,\n#if defined(LIT_IRIDESCENCE)\n			iridescenceFresnel,\n#endif\n			clearcoat_worldNormal,\n			clearcoat_gloss,\n			sheen_gloss,\n			iridescence_intensity\n		);\n	}\n}\nfn addClusteredLights(\n	worldNormal: vec3f,\n	viewDir: vec3f,\n	reflectionDir: vec3f,\n#if defined(LIT_CLEARCOAT)\n	clearcoatReflectionDir: vec3f,\n#endif\n	gloss: f32,\n	specularity: vec3f,\n	geometricNormal: vec3f,\n	tbn: mat3x3f,\n#if defined(LIT_IRIDESCENCE)\n	iridescenceFresnel: vec3f,\n#endif\n	clearcoat_worldNormal: vec3f,\n	clearcoat_gloss: f32,\n	sheen_gloss: f32,\n	iridescence_intensity: f32\n) {\n	if (uniform.clusterSkip > 0.5) {\n		return;\n	}\n	let cellCoords: vec3f = floor((vPositionW - uniform.clusterBoundsMin) * uniform.clusterCellsCountByBoundsSize);\n	if (!(any(cellCoords < vec3f(0.0)) || any(cellCoords >= uniform.clusterCellsMax))) {\n		let cellIndex: f32 = dot(uniform.clusterCellsDot, cellCoords);\n		let clusterV: f32 = floor(cellIndex * uniform.clusterTextureSize.y);\n		let clusterU: f32 = cellIndex - (clusterV * uniform.clusterTextureSize.x);\n		for (var lightCellIndex: i32 = 0; lightCellIndex < uniform.clusterMaxCells; lightCellIndex = lightCellIndex + 1) {\n			let lightIndexPacked: f32 = textureLoad(clusterWorldTexture, vec2<i32>(i32(clusterU) + lightCellIndex, i32(clusterV)), 0).r;\n			if (lightIndexPacked <= 0.0) {\n				break;\n			}\n			evaluateClusterLight(\n				lightIndexPacked * 255.0,\n				worldNormal,\n				viewDir,\n				reflectionDir,\n#if defined(LIT_CLEARCOAT)\n				clearcoatReflectionDir,\n#endif\n				gloss,\n				specularity,\n				geometricNormal,\n				tbn,\n#if defined(LIT_IRIDESCENCE)\n				iridescenceFresnel,\n#endif\n				clearcoat_worldNormal,\n				clearcoat_gloss,\n				sheen_gloss,\n				iridescence_intensity\n			);\n		}\n	}\n}',combinePS:"\nfn combineColor(albedo: vec3f, sheenSpecularity: vec3f, clearcoatSpecularity: f32) -> vec3f {\n	var ret: vec3f = vec3f(0.0);\n	#ifdef LIT_OLD_AMBIENT\n		ret = ret + ((dDiffuseLight - uniform.light_globalAmbient) * albedo + uniform.material_ambient * uniform.light_globalAmbient);\n	#else\n		ret = ret + (albedo * dDiffuseLight);\n	#endif\n	#ifdef LIT_SPECULAR\n		ret = ret + dSpecularLight;\n	#endif\n	#ifdef LIT_REFLECTIONS\n		ret = ret + (dReflection.rgb * dReflection.a);\n	#endif\n	#ifdef LIT_SHEEN\n		let sheenScaling: f32 = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;\n		ret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;\n	#endif\n	#ifdef LIT_CLEARCOAT\n		let clearCoatScaling: f32 = 1.0 - ccFresnel * clearcoatSpecularity;\n		ret = ret * clearCoatScaling + (ccSpecularLight + ccReflection) * clearcoatSpecularity;\n	#endif\n	return ret;\n}\n",cookieBlit2DPS:"\n	varying uv0: vec2f;\n	var blitTexture: texture_2d<f32>;\n	var blitTextureSampler : sampler;\n	@fragment\n	fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n		var output: FragmentOutput;\n		output.color = textureSample(blitTexture, blitTextureSampler, input.uv0);\n		return output;\n	}\n",cookieBlitCubePS:"\n	varying uv0: vec2f;\n	uniform invViewProj: mat4x4<f32>;\n	var blitTexture: texture_cube<f32>;\n	var blitTextureSampler : sampler;\n	@fragment\n	fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n		var output: FragmentOutput;\n		var projPos = vec4f(input.uv0 * 2.0 - 1.0, 0.5, 1.0);\n		var worldPos = uniform.invViewProj * projPos;\n		output.color = textureSample(blitTexture, blitTextureSampler, worldPos.xyz);\n		return output;\n	}\n",cookieBlitVS:"\n	attribute vertex_position: vec2f;\n	varying uv0: vec2f;\n	@vertex\n	fn vertexMain(input: VertexInput) -> VertexOutput {\n		var output: VertexOutput;\n		output.position = vec4f(input.vertex_position, 0.5, 1.0);\n		output.uv0 = input.vertex_position * 0.5 + vec2f(0.5, 0.5);\n		output.uv0.y = 1.0 - output.uv0.y;\n		return output;\n	}\n",cubeMapProjectPS:"\n#if LIT_CUBEMAP_PROJECTION == BOX\n	uniform envBoxMin: vec3f;\n	uniform envBoxMax: vec3f;\n#endif\nfn cubeMapProject(nrdir: vec3f) -> vec3f {\n	#if LIT_CUBEMAP_PROJECTION == NONE\n		return cubeMapRotate(nrdir);\n	#endif\n	#if LIT_CUBEMAP_PROJECTION == BOX\n		let nrdir_rotated: vec3f = cubeMapRotate(nrdir);\n		let rbmax: vec3f = (uniform.envBoxMax - vPositionW) / nrdir_rotated;\n		let rbmin: vec3f = (uniform.envBoxMin - vPositionW) / nrdir_rotated;\n		let rbminmax: vec3f = select(rbmin, rbmax, nrdir_rotated > vec3f(0.0));\n		let fa: f32 = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n		let posonbox: vec3f = vPositionW + nrdir_rotated * fa;\n		let envBoxPos: vec3f = (uniform.envBoxMin + uniform.envBoxMax) * 0.5;\n		return normalize(posonbox - envBoxPos);\n	#endif\n}\n",cubeMapRotatePS:"\n#ifdef CUBEMAP_ROTATION\nuniform cubeMapRotationMatrix: mat3x3f;\n#endif\nfn cubeMapRotate(refDir: vec3f) -> vec3f {\n#ifdef CUBEMAP_ROTATION\n	return refDir * uniform.cubeMapRotationMatrix;\n#else\n	return refDir;\n#endif\n}\n",debugOutputPS:"\n#ifdef DEBUG_ALBEDO_PASS\noutput.color = vec4(gammaCorrectOutput(dAlbedo), 1.0);\n#endif\n#ifdef DEBUG_UV0_PASS\noutput.color = vec4f(litArgs_albedo , 1.0);\n#endif\n#ifdef DEBUG_WORLD_NORMAL_PASS\noutput.color = vec4f(litArgs_worldNormal * 0.5 + 0.5, 1.0);\n#endif\n#ifdef DEBUG_OPACITY_PASS\noutput.color = vec4f(vec3f(litArgs_opacity) , 1.0);\n#endif\n#ifdef DEBUG_SPECULARITY_PASS\noutput.color = vec4f(litArgs_specularity, 1.0);\n#endif\n#ifdef DEBUG_GLOSS_PASS\noutput.color = vec4f(vec3f(litArgs_gloss) , 1.0);\n#endif\n#ifdef DEBUG_METALNESS_PASS\noutput.color = vec4f(vec3f(litArgs_metalness) , 1.0);\n#endif\n#ifdef DEBUG_AO_PASS\noutput.color = vec4f(vec3f(litArgs_ao) , 1.0);\n#endif\n#ifdef DEBUG_EMISSION_PASS\noutput.color = vec4f(gammaCorrectOutput(litArgs_emission), 1.0);\n#endif\n",debugProcessFrontendPS:"\n#ifdef DEBUG_LIGHTING_PASS\n	litArgs_albedo = vec3f(0.5);\n#endif\n#ifdef DEBUG_UV0_PASS\n#ifdef VARYING_VUV0\n	litArgs_albedo = vec3f(vUv0, 0.0);\n#else\n	litArgs_albedo = vec3f(0.0);\n#endif\n#endif\n",detailModesPS:"\n#ifndef _DETAILMODES_INCLUDED_\n#define _DETAILMODES_INCLUDED_\nfn detailMode_mul(c1: vec3f, c2: vec3f) -> vec3f {\n	return c1 * c2;\n}\nfn detailMode_add(c1: vec3f, c2: vec3f) -> vec3f {\n	return c1 + c2;\n}\nfn detailMode_screen(c1: vec3f, c2: vec3f) -> vec3f {\n	return 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nfn detailMode_overlay(c1: vec3f, c2: vec3f) -> vec3f {\n	return mix(1.0 - 2.0 * (1.0 - c1)*(1.0 - c2), 2.0 * c1 * c2, step(c1, vec3f(0.5)));\n}\nfn detailMode_min(c1: vec3f, c2: vec3f) -> vec3f {\n	return min(c1, c2);\n}\nfn detailMode_max(c1: vec3f, c2: vec3f) -> vec3f {\n	return max(c1, c2);\n}\n#endif\n",diffusePS:'\nuniform material_diffuse: vec3f;\n#ifdef STD_DIFFUSEDETAIL_TEXTURE\n	#include "detailModesPS"\n#endif\nfn getAlbedo() {\n	dAlbedo = uniform.material_diffuse.rgb;\n	#ifdef STD_DIFFUSE_TEXTURE\n		var albedoTexture: vec3f = {STD_DIFFUSE_TEXTURE_DECODE}(textureSampleBias({STD_DIFFUSE_TEXTURE_NAME}, {STD_DIFFUSE_TEXTURE_NAME}Sampler, {STD_DIFFUSE_TEXTURE_UV}, uniform.textureBias)).{STD_DIFFUSE_TEXTURE_CHANNEL};\n		#ifdef STD_DIFFUSEDETAIL_TEXTURE\n			var albedoDetail: vec3f = {STD_DIFFUSEDETAIL_TEXTURE_DECODE}(textureSampleBias({STD_DIFFUSEDETAIL_TEXTURE_NAME}, {STD_DIFFUSEDETAIL_TEXTURE_NAME}Sampler, {STD_DIFFUSEDETAIL_TEXTURE_UV}, uniform.textureBias)).{STD_DIFFUSEDETAIL_TEXTURE_CHANNEL};\n			albedoTexture = detailMode_{STD_DIFFUSEDETAIL_DETAILMODE}(albedoTexture, albedoDetail);\n		#endif\n		dAlbedo = dAlbedo * albedoTexture;\n	#endif\n	#ifdef STD_DIFFUSE_VERTEX\n		dAlbedo = dAlbedo * gammaCorrectInputVec3(saturate3(vVertexColor.{STD_DIFFUSE_VERTEX_CHANNEL}));\n	#endif\n}\n',decodePS:"\n#ifndef _DECODE_INCLUDED_\n#define _DECODE_INCLUDED_\nfn decodeLinear(raw: vec4f) -> vec3f {\n	return raw.rgb;\n}\nfn decodeGammaFloat(raw: f32) -> f32 {\n	return pow(raw, 2.2);\n}\nfn decodeGamma3(raw: vec3f) -> vec3f {\n	return pow(raw, vec3f(2.2));\n}\nfn decodeGamma(raw: vec4f) -> vec3f {\n	return pow(raw.xyz, vec3f(2.2));\n}\nfn decodeRGBM(raw: vec4f) -> vec3f {\n	let color = (8.0 * raw.a) * raw.rgb;\n	return color * color;\n}\nfn decodeRGBP(raw: vec4f) -> vec3f {\n	let color = raw.rgb * (-raw.a * 7.0 + 8.0);\n	return color * color;\n}\nfn decodeRGBE(raw: vec4f) -> vec3f {\n	return select(vec3f(0.0), raw.xyz * pow(2.0, raw.w * 255.0 - 128.0), raw.a != 0.0);\n}\nfn passThrough(raw: vec4f) -> vec4f {\n	return raw;\n}\nfn unpackNormalXYZ(nmap: vec4f) -> vec3f {\n	return nmap.xyz * 2.0 - 1.0;\n}\nfn unpackNormalXY(nmap: vec4f) -> vec3f {\n	var xy = nmap.wy * 2.0 - 1.0;\n	return vec3f(xy, sqrt(1.0 - clamp(dot(xy, xy), 0.0, 1.0)));\n}\n#endif\n",emissivePS:"\nuniform material_emissive: vec3f;\nuniform material_emissiveIntensity: f32;\nfn getEmission() {\n	dEmission = uniform.material_emissive * uniform.material_emissiveIntensity;\n	#ifdef STD_EMISSIVE_TEXTURE\n	dEmission *= {STD_EMISSIVE_TEXTURE_DECODE}(textureSampleBias({STD_EMISSIVE_TEXTURE_NAME}, {STD_EMISSIVE_TEXTURE_NAME}Sampler, {STD_EMISSIVE_TEXTURE_UV}, uniform.textureBias)).{STD_EMISSIVE_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_EMISSIVE_VERTEX\n	dEmission = dEmission * gammaCorrectInputVec3(saturate3(vVertexColor.{STD_EMISSIVE_VERTEX_CHANNEL}));\n	#endif\n}\n",encodePS:"\nfn encodeLinear(source: vec3f) -> vec4f {\n	return vec4f(source, 1.0);\n}\nfn encodeGamma(source: vec3f) -> vec4f {\n	return vec4f(pow(source + vec3f(0.0000001), vec3f(1.0 / 2.2)), 1.0);\n}\nfn encodeRGBM(source: vec3f) -> vec4f {\n	var color: vec3f = pow(source, vec3f(0.5));\n	color *= 1.0 / 8.0;\n	var a: f32 = saturate(max(max(color.r, color.g), max(color.b, 1.0 / 255.0)));\n	a = ceil(a * 255.0) / 255.0;\n	color /= a;\n	return vec4f(color, a);\n}\nfn encodeRGBP(source: vec3f) -> vec4f {\n	var gamma: vec3f = pow(source, vec3f(0.5));\n	var maxVal: f32 = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));\n	var v: f32 = 1.0 - ((maxVal - 1.0) / 7.0);\n	v = ceil(v * 255.0) / 255.0;\n	return vec4f(gamma / (-v * 7.0 + 8.0), v);\n}\nfn encodeRGBE(source: vec3f) -> vec4f {\n	var maxVal: f32 = max(source.x, max(source.y, source.z));\n	if (maxVal < 1e-32) {\n		return vec4f(0.0, 0.0, 0.0, 0.0);\n	} else {\n		var e: f32 = ceil(log2(maxVal));\n		return vec4f(source / pow(2.0, e), (e + 128.0) / 255.0);\n	}\n}\n",endPS:"\n	var finalRgb: vec3f = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);\n	finalRgb = finalRgb + litArgs_emission;\n	finalRgb = addFog(finalRgb);\n	finalRgb = toneMap(finalRgb);\n	finalRgb = gammaCorrectOutput(finalRgb);\n	output.color = vec4f(finalRgb, output.color.a);\n",envAtlasPS:"\n#ifndef _ENVATLAS_INCLUDED_\n#define _ENVATLAS_INCLUDED_\nconst atlasSize : f32 = 512.0;\nconst seamSize : f32 = 1.0 / atlasSize;\nfn mapUv(uv : vec2f, rect : vec4f) -> vec2f {\n	return vec2f(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),\n				 mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));\n}\nfn mapRoughnessUv(uv : vec2f, level : f32) -> vec2f {\n	let t : f32 = 1.0 / exp2(level);\n	return mapUv(uv, vec4f(0.0, 1.0 - t, t, t * 0.5));\n}\nfn mapShinyUv(uv : vec2f, level : f32) -> vec2f {\n	let t : f32 = 1.0 / exp2(level);\n	return mapUv(uv, vec4f(1.0 - t, 1.0 - t, t, t * 0.5));\n}\n#endif\n",envProcPS:"\n#ifdef LIT_SKYBOX_INTENSITY\n	uniform skyboxIntensity : f32;\n#endif\nfn processEnvironment(color : vec3f) -> vec3f {\n	#ifdef LIT_SKYBOX_INTENSITY\n		return color * uniform.skyboxIntensity;\n	#else\n		return color;\n	#endif\n}\n",falloffInvSquaredPS:"\nfn getFalloffWindow(lightRadius: f32, lightDir: vec3f) -> f32 {\n	let sqrDist: f32 = dot(lightDir, lightDir);\n	let invRadius: f32 = 1.0 / lightRadius;\n	return square(saturate(1.0 - square(sqrDist * square(invRadius))));\n}\nfn getFalloffInvSquared(lightRadius: f32, lightDir: vec3f) -> f32 {\n	let sqrDist: f32 = dot(lightDir, lightDir);\n	var falloff: f32 = 1.0 / (sqrDist + 1.0);\n	let invRadius: f32 = 1.0 / lightRadius;\n	falloff = falloff * 16.0;\n	falloff = falloff * square(saturate(1.0 - square(sqrDist * square(invRadius))));\n	return falloff;\n}\n",falloffLinearPS:"\nfn getFalloffLinear(lightRadius: f32, lightDir: vec3f) -> f32 {\n	let d: f32 = length(lightDir);\n	return max(((lightRadius - d) / lightRadius), 0.0);\n}\n",floatAsUintPS:"\n#ifndef FLOAT_AS_UINT\n#define FLOAT_AS_UINT\nfn float2uint(value: f32) -> vec4f {\n	let intBits = bitcast<u32>(value);\n	return vec4f(\n		f32((intBits >> 24u) & 0xffu),\n		f32((intBits >> 16u) & 0xffu),\n		f32((intBits >> 8u) & 0xffu),\n		f32(intBits & 0xffu)\n	) / 255.0;\n}\nfn uint2float(value: vec4f) -> f32 {\n	let rgba_u32 = vec4<u32>(value * 255.0);\n	let intBits: u32 =\n		(rgba_u32.r << 24u) |\n		(rgba_u32.g << 16u) |\n		(rgba_u32.b << 8u)  |\n		 rgba_u32.a;\n	return bitcast<f32>(intBits);\n}\nfn float2vec4(value: f32) -> vec4f {\n	#if defined(CAPS_TEXTURE_FLOAT_RENDERABLE)\n		return vec4f(value, 1.0, 1.0, 1.0);\n	#else\n		return float2uint(value);\n	#endif\n}\n#endif\n",fogPS:"\nvar<private> dBlendModeFogFactor : f32 = 1.0;\n#if (FOG != NONE)\n	uniform fog_color : vec3f;\n	\n	#if (FOG == LINEAR)\n		uniform fog_start : f32;\n		uniform fog_end : f32;\n	#else\n		uniform fog_density : f32;\n	#endif\n#endif\nfn getFogFactor() -> f32 {\n	let depth = pcPosition.z / pcPosition.w;\n	var fogFactor : f32 = 0.0;\n	#if (FOG == LINEAR)\n		fogFactor = (uniform.fog_end - depth) / (uniform.fog_end - uniform.fog_start);\n	#elif (FOG == EXP)\n		fogFactor = exp(-depth * uniform.fog_density);\n	#elif (FOG == EXP2)\n		fogFactor = exp(-depth * depth * uniform.fog_density * uniform.fog_density);\n	#endif\n	return clamp(fogFactor, 0.0, 1.0);\n}\nfn addFog(color : vec3f) -> vec3f {\n	#if (FOG != NONE)\n		return mix(uniform.fog_color * dBlendModeFogFactor, color, getFogFactor());\n	#else\n		return color;\n	#endif\n}\n",fresnelSchlickPS:"\nfn getFresnel(\n		cosTheta: f32,\n		gloss: f32,\n		specularity: vec3f\n	#if defined(LIT_IRIDESCENCE)\n		, iridescenceFresnel: vec3f,\n		iridescenceIntensity: f32\n	#endif\n) -> vec3f {\n	let fresnel: f32 = pow(1.0 - saturate(cosTheta), 5.0);\n	let glossSq: f32 = gloss * gloss;\n	let ret: vec3f = specularity + (max(vec3f(glossSq), specularity) - specularity) * fresnel;\n	#if defined(LIT_IRIDESCENCE)\n		return mix(ret, iridescenceFresnel, iridescenceIntensity);\n	#else\n		return ret;\n	#endif\n}\nfn getFresnelCC(cosTheta: f32) -> f32 {\n	let fresnel: f32 = pow(1.0 - saturate(cosTheta), 5.0);\n	return 0.04 + (1.0 - 0.04) * fresnel;\n}",frontendCodePS:"",frontendDeclPS:"",fullscreenQuadVS:"\nattribute vertex_position: vec2f;\nvarying vUv0: vec2f;\n@vertex\nfn vertexMain(input: VertexInput) -> VertexOutput {\n	var output: VertexOutput;\n	output.position = vec4f(input.vertex_position, 0.5, 1.0);\n	output.vUv0 = input.vertex_position.xy * 0.5 + vec2f(0.5);\n	return output;\n}\n",gammaPS:'\n#include "decodePS"\n#if (GAMMA == SRGB)\n	fn gammaCorrectInput(color: f32) -> f32 {\n		return decodeGammaFloat(color);\n	}\n	fn gammaCorrectInputVec3(color: vec3f) -> vec3f {\n		return decodeGamma3(color);\n	}\n	fn gammaCorrectInputVec4(color: vec4f) -> vec4f {\n		return vec4f(decodeGamma3(color.xyz), color.w);\n	}\n	fn gammaCorrectOutput(color: vec3f) -> vec3f {\n		return pow(color + 0.0000001, vec3f(1.0 / 2.2));\n	}\n#else\n	fn gammaCorrectInput(color: f32) -> f32 {\n		return color;\n	}\n	fn gammaCorrectInputVec3(color: vec3f) -> vec3f {\n		return color;\n	}\n	fn gammaCorrectInputVec4(color: vec4f) -> vec4f {\n		return color;\n	}\n	fn gammaCorrectOutput(color: vec3f) -> vec3f {\n		return color;\n	}\n#endif\n',glossPS:"\n#ifdef STD_GLOSS_CONSTANT\n	uniform material_gloss: f32;\n#endif\nfn getGlossiness() {\n	dGlossiness = 1.0;\n	#ifdef STD_GLOSS_CONSTANT\n	dGlossiness = dGlossiness * uniform.material_gloss;\n	#endif\n	#ifdef STD_GLOSS_TEXTURE\n	dGlossiness = dGlossiness * textureSampleBias({STD_GLOSS_TEXTURE_NAME}, {STD_GLOSS_TEXTURE_NAME}Sampler, {STD_GLOSS_TEXTURE_UV}, uniform.textureBias).{STD_GLOSS_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_GLOSS_VERTEX\n	dGlossiness = dGlossiness * saturate(vVertexColor.{STD_GLOSS_VERTEX_CHANNEL});\n	#endif\n	#ifdef STD_GLOSS_INVERT\n	dGlossiness = 1.0 - dGlossiness;\n	#endif\n	dGlossiness = dGlossiness + 0.0000001;\n}\n",gsplatCenterVS:"\nuniform matrix_model: mat4x4f;\nuniform matrix_view: mat4x4f;\n#ifndef GSPLAT_CENTER_NOPROJ\n	uniform matrix_projection: mat4x4f;\n#endif\nfn initCenter(modelCenter: vec3f, center: ptr<function, SplatCenter>) -> bool {\n	let modelView: mat4x4f = uniform.matrix_view * uniform.matrix_model;\n	let centerView: vec4f = modelView * vec4f(modelCenter, 1.0);\n	#ifndef GSPLAT_CENTER_NOPROJ\n		if (centerView.z > 0.0) {\n			return false;\n		}\n		var centerProj: vec4f = uniform.matrix_projection * centerView;\n		centerProj.z = clamp(centerProj.z, 0.0, abs(centerProj.w));\n		center.proj = centerProj;\n		center.projMat00 = uniform.matrix_projection[0][0];\n	#endif\n	center.view = centerView.xyz / centerView.w;\n	center.modelView = modelView;\n	return true;\n}\n",gsplatCornerVS:"\nuniform viewport: vec2f;\nuniform camera_params: vec4f;\nfn initCornerCov(source: ptr<function, SplatSource>, center: ptr<function, SplatCenter>, corner: ptr<function, SplatCorner>, covA: vec3f, covB: vec3f) -> bool {\n	let Vrk = mat3x3f(\n		vec3f(covA.x, covA.y, covA.z),\n		vec3f(covA.y, covB.x, covB.y),\n		vec3f(covA.z, covB.y, covB.z)\n	);\n	let focal = uniform.viewport.x * center.projMat00;\n	let v = select(center.view.xyz, vec3f(0.0, 0.0, 1.0), uniform.camera_params.w == 1.0);\n	let J1 = focal / v.z;\n	let J2 = -J1 / v.z * v.xy;\n	let J = mat3x3f(\n		vec3f(J1, 0.0, J2.x),\n		vec3f(0.0, J1, J2.y),\n		vec3f(0.0, 0.0, 0.0)\n	);\n	let W = transpose(mat3x3f(center.modelView[0].xyz, center.modelView[1].xyz, center.modelView[2].xyz));\n	let T = W * J;\n	let cov = transpose(T) * Vrk * T;\n	#if GSPLAT_AA\n		let detOrig = cov[0][0] * cov[1][1] - cov[0][1] * cov[1][0];\n		let detBlur = (cov[0][0] + 0.3) * (cov[1][1] + 0.3) - cov[0][1] * cov[1][0];\n		corner.aaFactor = sqrt(detOrig / detBlur);\n	#endif\n	let diagonal1 = cov[0][0] + 0.3;\n	let offDiagonal = cov[0][1];\n	let diagonal2 = cov[1][1] + 0.3;\n	let mid = 0.5 * (diagonal1 + diagonal2);\n	let radius = length(vec2f((diagonal1 - diagonal2) / 2.0, offDiagonal));\n	let lambda1 = mid + radius;\n	let lambda2 = max(mid - radius, 0.1);\n	let vmin = min(1024.0, min(uniform.viewport.x, uniform.viewport.y));\n	let l1 = 2.0 * min(sqrt(2.0 * lambda1), vmin);\n	let l2 = 2.0 * min(sqrt(2.0 * lambda2), vmin);\n	if (l1 < 2.0 && l2 < 2.0) {\n		return false;\n	}\n	let c = center.proj.ww / uniform.viewport;\n	if (any((abs(center.proj.xy) - vec2f(max(l1, l2)) * c) > center.proj.ww)) {\n		return false;\n	}\n	let diagonalVector = normalize(vec2f(offDiagonal, lambda1 - diagonal1));\n	let v1 = l1 * diagonalVector;\n	let v2 = l2 * vec2f(diagonalVector.y, -diagonalVector.x);\n	corner.offset = (source.cornerUV.x * v1 + source.cornerUV.y * v2) * c;\n	corner.uv = source.cornerUV;\n	return true;\n}\nfn initCorner(source: ptr<function, SplatSource>, center: ptr<function, SplatCenter>, corner: ptr<function, SplatCorner>) -> bool {\n	var covA: vec3f;\n	var covB: vec3f;\n	readCovariance(source, &covA, &covB);\n	return initCornerCov(source, center, corner, covA, covB);\n}\n",gsplatColorVS:"\nvar splatColor: texture_2d<f32>;\nfn readColor(source: ptr<function, SplatSource>) -> vec4f {\n	return textureLoad(splatColor, source.uv, 0);\n}\n",gsplatCommonVS:'\n#include "gsplatStructsVS"\n#include "gsplatEvalSHVS"\n#include "gsplatQuatToMat3VS"\n#include "gsplatSourceFormatVS"\n#include "gsplatSourceVS"\n#include "gsplatCenterVS"\n#include "gsplatCornerVS"\n#include "gsplatOutputVS"\nfn clipCorner(corner: ptr<function, SplatCorner>, alpha: f32) {\n	let clip: f32 = min(1.0, sqrt(-log(1.0 / (255.0 * alpha))) / 2.0);\n	corner.offset = corner.offset * clip;\n	corner.uv = corner.uv * clip;\n}\n',gsplatCompressedDataVS:"\nvar packedTexture: texture_2d<u32>;\nvar chunkTexture: texture_2d<f32>;\nvar<private> chunkDataA: vec4f;\nvar<private> chunkDataB: vec4f;\nvar<private> chunkDataC: vec4f;\nvar<private> chunkDataD: vec4f;\nvar<private> chunkDataE: vec4f;\nvar<private> packedData: vec4u;\nfn unpack111011(bits: u32) -> vec3f {\n	return (vec3f((vec3<u32>(bits) >> vec3<u32>(21u, 11u, 0u)) & vec3<u32>(0x7ffu, 0x3ffu, 0x7ffu))) / vec3f(2047.0, 1023.0, 2047.0);\n}\nfn unpack8888(bits: u32) -> vec4f {\n	return vec4f(\n		f32((bits >> 24u) & 0xffu),\n		f32((bits >> 16u) & 0xffu),\n		f32((bits >> 8u)  & 0xffu),\n		f32(bits		 & 0xffu)\n	) / 255.0;\n}\nconst norm_const: f32 = 1.0 / (sqrt(2.0) * 0.5);\nfn unpackRotation(bits: u32) -> vec4f {\n	let a = (f32((bits >> 20u) & 0x3ffu) / 1023.0 - 0.5) * norm_const;\n	let b = (f32((bits >> 10u) & 0x3ffu) / 1023.0 - 0.5) * norm_const;\n	let c = (f32(bits & 0x3ffu) / 1023.0 - 0.5) * norm_const;\n	let m = sqrt(1.0 - (a * a + b * b + c * c));\n	let mode = bits >> 30u;\n	if (mode == 0u) { return vec4f(m, a, b, c); }\n	if (mode == 1u) { return vec4f(a, m, b, c); }\n	if (mode == 2u) { return vec4f(a, b, m, c); }\n	return vec4f(a, b, c, m);\n}\nfn readCenter(source: ptr<function, SplatSource>) -> vec3f {\n	let tex_size_u = textureDimensions(chunkTexture, 0);\n	let w: u32 = tex_size_u.x / 5u;\n	let chunkId: u32 = source.id / 256u;\n	let chunkUV: vec2<i32> = vec2<i32>(i32((chunkId % w) * 5u), i32(chunkId / w));\n	chunkDataA = textureLoad(chunkTexture, chunkUV + vec2<i32>(0, 0), 0);\n	chunkDataB = textureLoad(chunkTexture, chunkUV + vec2<i32>(1, 0), 0);\n	chunkDataC = textureLoad(chunkTexture, chunkUV + vec2<i32>(2, 0), 0);\n	chunkDataD = textureLoad(chunkTexture, chunkUV + vec2<i32>(3, 0), 0);\n	chunkDataE = textureLoad(chunkTexture, chunkUV + vec2<i32>(4, 0), 0);\n	packedData = textureLoad(packedTexture, source.uv, 0);\n	return mix(chunkDataA.xyz, vec3f(chunkDataA.w, chunkDataB.xy), unpack111011(packedData.x));\n}\nfn readColor(source: ptr<function, SplatSource>) -> vec4f {\n	let r = unpack8888(packedData.w);\n	return vec4f(mix(chunkDataD.xyz, vec3f(chunkDataD.w, chunkDataE.xy), r.rgb), r.w);\n}\nfn getRotation() -> vec4f {\n	return unpackRotation(packedData.y);\n}\nfn getScale() -> vec3f {\n	return exp(mix(vec3f(chunkDataB.zw, chunkDataC.x), chunkDataC.yzw, unpack111011(packedData.z)));\n}\nfn readCovariance(source: ptr<function, SplatSource>, covA_ptr: ptr<function, vec3f>, covB_ptr: ptr<function, vec3f>) {\n	let rot = quatToMat3(getRotation());\n	let scale = getScale();\n	let M = transpose(mat3x3f(\n		scale.x * rot[0],\n		scale.y * rot[1],\n		scale.z * rot[2]\n	));\n	*covA_ptr = vec3f(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n	*covB_ptr = vec3f(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatCompressedSHVS:"\n#if SH_BANDS > 0\nvar shTexture0: texture_2d<u32>;\nvar shTexture1: texture_2d<u32>;\nvar shTexture2: texture_2d<u32>;\nfn unpack8888s(bits: u32) -> vec4f {\n	let unpacked_u = (vec4<u32>(bits) >> vec4<u32>(0u, 8u, 16u, 24u)) & vec4<u32>(0xffu);\n	return vec4f(unpacked_u) * (8.0 / 255.0) - 4.0;\n}\nfn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 15>>, scale: ptr<function, f32>) {\n	let shData0: vec4<u32> = textureLoad(shTexture0, source.uv, 0);\n	let shData1: vec4<u32> = textureLoad(shTexture1, source.uv, 0);\n	let shData2: vec4<u32> = textureLoad(shTexture2, source.uv, 0);\n	let r0 = unpack8888s(shData0.x);\n	let r1 = unpack8888s(shData0.y);\n	let r2 = unpack8888s(shData0.z);\n	let r3 = unpack8888s(shData0.w);\n	let g0 = unpack8888s(shData1.x);\n	let g1 = unpack8888s(shData1.y);\n	let g2 = unpack8888s(shData1.z);\n	let g3 = unpack8888s(shData1.w);\n	let b0 = unpack8888s(shData2.x);\n	let b1 = unpack8888s(shData2.y);\n	let b2 = unpack8888s(shData2.z);\n	let b3 = unpack8888s(shData2.w);\n	sh[0] =  vec3f(r0.x, g0.x, b0.x);\n	sh[1] =  vec3f(r0.y, g0.y, b0.y);\n	sh[2] =  vec3f(r0.z, g0.z, b0.z);\n	sh[3] =  vec3f(r0.w, g0.w, b0.w);\n	sh[4] =  vec3f(r1.x, g1.x, b1.x);\n	sh[5] =  vec3f(r1.y, g1.y, b1.y);\n	sh[6] =  vec3f(r1.z, g1.z, b1.z);\n	sh[7] =  vec3f(r1.w, g1.w, b1.w);\n	sh[8] =  vec3f(r2.x, g2.x, b2.x);\n	sh[9] =  vec3f(r2.y, g2.y, b2.y);\n	sh[10] = vec3f(r2.z, g2.z, b2.z);\n	sh[11] = vec3f(r2.w, g2.w, b2.w);\n	sh[12] = vec3f(r3.x, g3.x, b3.x);\n	sh[13] = vec3f(r3.y, g3.y, b3.y);\n	sh[14] = vec3f(r3.z, g3.z, b3.z);\n	*scale = 1.0;\n}\n#endif\n",gsplatEvalSHVS:"\n	#if SH_BANDS == 1\n		const SH_COEFFS: i32 = 3;\n	#elif SH_BANDS == 2\n		const SH_COEFFS: i32 = 8;\n	#elif SH_BANDS == 3\n		const SH_COEFFS: i32 = 15;\n	#else\n		const SH_COEFFS: i32 = 0;\n	#endif\n	#if SH_BANDS > 0\n	const SH_C1: f32 = 0.4886025119029199;\n	#if SH_BANDS > 1\n		const SH_C2_0: f32 = 1.0925484305920792;\n		const SH_C2_1: f32 = -1.0925484305920792;\n		const SH_C2_2: f32 = 0.31539156525252005;\n		const SH_C2_3: f32 = -1.0925484305920792;\n		const SH_C2_4: f32 = 0.5462742152960396;\n	#endif\n	#if SH_BANDS > 2\n		const SH_C3_0: f32 = -0.5900435899266435;\n		const SH_C3_1: f32 = 2.890611442640554;\n		const SH_C3_2: f32 = -0.4570457994644658;\n		const SH_C3_3: f32 = 0.3731763325901154;\n		const SH_C3_4: f32 = -0.4570457994644658;\n		const SH_C3_5: f32 = 1.445305721320277;\n		const SH_C3_6: f32 = -0.5900435899266435;\n	#endif\n	fn evalSH(sh: ptr<function, array<vec3f, SH_COEFFS>>, dir: vec3f) -> vec3f {\n		let x = dir.x;\n		let y = dir.y;\n		let z = dir.z;\n		var result = SH_C1 * (-sh[0] * y + sh[1] * z - sh[2] * x);\n		#if SH_BANDS > 1\n			let xx = x * x;\n			let yy = y * y;\n			let zz = z * z;\n			let xy = x * y;\n			let yz = y * z;\n			let xz = x * z;\n			result = result + (\n				sh[3] * (SH_C2_0 * xy) +\n				sh[4] * (SH_C2_1 * yz) +\n				sh[5] * (SH_C2_2 * (2.0 * zz - xx - yy)) +\n				sh[6] * (SH_C2_3 * xz) +\n				sh[7] * (SH_C2_4 * (xx - yy))\n			);\n		#endif\n		#if SH_BANDS > 2\n			result = result + (\n				sh[8]  * (SH_C3_0 * y * (3.0 * xx - yy)) +\n				sh[9]  * (SH_C3_1 * xy * z) +\n				sh[10] * (SH_C3_2 * y * (4.0 * zz - xx - yy)) +\n				sh[11] * (SH_C3_3 * z * (2.0 * zz - 3.0 * xx - 3.0 * yy)) +\n				sh[12] * (SH_C3_4 * x * (4.0 * zz - xx - yy)) +\n				sh[13] * (SH_C3_5 * z * (xx - yy)) +\n				sh[14] * (SH_C3_6 * x * (xx - 3.0 * yy))\n			);\n		#endif\n		return result;\n	}\n	#endif\n",gsplatSourceFormatVS:'\n#if defined(GSPLAT_WORKBUFFER_DATA)\n	#include "gsplatWorkBufferVS"\n#elif GSPLAT_COMPRESSED_DATA == true\n	#include "gsplatCompressedDataVS"\n	#if SH_BANDS > 0\n		#include "gsplatCompressedSHVS"\n	#endif\n#elif GSPLAT_SOGS_DATA\n	#include "gsplatSogsDataVS"\n	#include "gsplatSogsColorVS"\n	#if SH_BANDS > 0\n		#include "gsplatSogsSHVS"\n	#endif\n#else\n	#include "gsplatDataVS"\n	#include "gsplatColorVS"\n	#if SH_BANDS > 0\n		#include "gsplatSHVS"\n	#endif\n#endif\n',gsplatStructsVS:"\nstruct SplatSource {\n	order: u32,\n	id: u32,\n	uv: vec2<i32>,\n	cornerUV: vec2f,\n}\nstruct SplatCenter {\n	view: vec3f,\n	proj: vec4f,\n	modelView: mat4x4f,\n	projMat00: f32,\n}\nstruct SplatCorner {\n	offset: vec2f,\n	uv: vec2f,\n	#if GSPLAT_AA\n		aaFactor: f32,\n	#endif\n}\n",gsplatQuatToMat3VS:"\nfn quatToMat3(R: vec4<f32>) -> mat3x3<f32> {\n	let R2: vec4<f32> = R + R;\n	let X: f32	   = R2.x * R.w;\n	let Y: vec4<f32> = R2.y * R;\n	let Z: vec4<f32> = R2.z * R;\n	let W: f32	   = R2.w * R.w;\n	return mat3x3<f32>(\n		1.0 - Z.z - W,  Y.z + X,	  Y.w - Z.x,\n		Y.z - X,		1.0 - Y.y - W, Z.w + Y.x,\n		Y.w + Z.x,	  Z.w - Y.x,	 1.0 - Y.y - Z.z\n	);\n}\n",gsplatSogsColorVS:"\nvar packedSh0: texture_2d<f32>;\nuniform sh0_mins: f32;\nuniform sh0_maxs: f32;\nconst SH_C0: f32 = 0.28209479177387814;\nfn readColor(source: ptr<function, SplatSource>) -> vec4f {\n	let clr = mix(vec3f(uniform.sh0_mins), vec3f(uniform.sh0_maxs), unpack111110(pack8888(textureLoad(packedSh0, source.uv, 0))));\n	let alpha = f32(packedSample.z & 0xffu) / 255.0;\n	return vec4f(vec3f(0.5) + clr.xyz * SH_C0, alpha);\n}\n",gsplatSogsDataVS:'\n#include "gsplatPackingPS"\nvar packedTexture: texture_2d<u32>;\nuniform means_mins: vec3f;\nuniform means_maxs: vec3f;\nuniform scales_mins: f32;\nuniform scales_maxs: f32;\nvar<private> packedSample: vec4<u32>;\nfn readCenter(source: ptr<function, SplatSource>) -> vec3f {\n	packedSample = textureLoad(packedTexture, source.uv, 0);\n	let l = unpack8888(packedSample.x).xyz;\n	let u = unpack8888(packedSample.y).xyz;\n	let n = (l * 255.0 + u * 255.0 * 256.0) / 65535.0;\n	let v = mix(uniform.means_mins, uniform.means_maxs, n);\n	return sign(v) * (exp(abs(v)) - 1.0);\n}\nconst norm: f32 = 2.0 / sqrt(2.0);\nfn readCovariance(source: ptr<function, SplatSource>, covA_ptr: ptr<function, vec3f>, covB_ptr: ptr<function, vec3f>) {\n	let qdata = unpack8888(packedSample.z).xyz;\n	let sdata = unpack101010(packedSample.w >> 2u);\n	let qmode = packedSample.w & 0x3u;\n	let abc = (qdata - 0.5) * norm;\n	let d = sqrt(max(0.0, 1.0 - dot(abc, abc)));\n	var quat: vec4f;\n	if (qmode == 0u) {\n		quat = vec4f(d, abc);\n	} else if (qmode == 1u) {\n		quat = vec4f(abc.x, d, abc.y, abc.z);\n	} else if (qmode == 2u) {\n		quat = vec4f(abc.x, abc.y, d, abc.z);\n	} else {\n		quat = vec4f(abc.x, abc.y, abc.z, d);\n	}\n	let rot = quatToMat3(quat);\n	let scale = exp(mix(vec3f(uniform.scales_mins), vec3f(uniform.scales_maxs), sdata));\n	let M = transpose(mat3x3f(\n		scale.x * rot[0],\n		scale.y * rot[1],\n		scale.z * rot[2]\n	));\n	*covA_ptr = vec3f(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n	*covB_ptr = vec3f(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n',gsplatSogsSHVS:"\nvar packedShN: texture_2d<f32>;\nuniform shN_mins: f32;\nuniform shN_maxs: f32;\nfn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, SH_COEFFS>>, scale: ptr<function, f32>) {\n	let t = vec2i(packedSample.xy & vec2u(255u));\n	let n = t.x + t.y * 256;\n	let u = (n % 64) * SH_COEFFS;\n	let v = n / 64;\n	for (var i: i32 = 0; i < SH_COEFFS; i = i + 1) {\n		sh[i] = mix(vec3f(uniform.shN_mins), vec3f(uniform.shN_maxs), unpack111110(pack8888(textureLoad(packedShN, vec2i(u + i, v), 0))));\n	}\n	*scale = 1.0;\n}\n",gsplatDataVS:"\nvar transformA: texture_2d<u32>;\nvar transformB: texture_2d<f32>;\nvar<private> tAw: u32;\nfn readCenter(source: ptr<function, SplatSource>) -> vec3f {\n	let tA: vec4<u32> = textureLoad(transformA, source.uv, 0);\n	tAw = tA.w;\n	return bitcast<vec3f>(tA.xyz);\n}\nfn unpackRotation(packed: vec3f) -> vec4f {\n	return vec4f(packed.xyz, sqrt(max(0.0, 1.0 - dot(packed, packed))));\n}\nfn readCovariance(source: ptr<function, SplatSource>, covA_ptr: ptr<function, vec3f>, covB_ptr: ptr<function, vec3f>) {\n	let tB: vec4f = textureLoad(transformB, source.uv, 0);\n	let rot: mat3x3f = quatToMat3(unpackRotation(vec3f(unpack2x16float(bitcast<u32>(tAw)), tB.w)).wxyz);\n	let scale: vec3f = tB.xyz;\n	let M = transpose(mat3x3f(\n		scale.x * rot[0],\n		scale.y * rot[1],\n		scale.z * rot[2]\n	));\n	*covA_ptr = vec3f(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n	*covB_ptr = vec3f(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatOutputVS:'\n#include "tonemappingPS"\n#include "decodePS"\n#include "gammaPS"\nfn prepareOutputFromGamma(gammaColor: vec3f) -> vec3f {\n	#if TONEMAP == NONE\n		#if GAMMA == NONE\n			return decodeGamma3(gammaColor);\n		#else \n			return gammaColor;\n		#endif\n	#else\n		return gammaCorrectOutput(toneMap(decodeGamma3(gammaColor)));\n	#endif\n}\n',gsplatPS:'\n#ifndef DITHER_NONE\n	#include "bayerPS"\n	#include "opacityDitherPS"\n	varying id: f32;\n#endif\n#ifdef PICK_PASS\n	#include "pickPS"\n#endif\n#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)\n	uniform alphaClip: f32;\n#endif\n#ifdef PREPASS_PASS\n	varying vLinearDepth: f32;\n	#include "floatAsUintPS"\n#endif\nconst EXP_A: f32	  = 12102203.0;\nconst EXP_BC_RMS: i32 = 1064866808;\nfn fastExp(x: f32) -> f32 {\n	var i: i32 = i32(EXP_A * x) + EXP_BC_RMS;\n	return bitcast<f32>(i);\n}\nvarying gaussianUV: vec2f;\nvarying gaussianColor: vec4f;\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n	var output: FragmentOutput;\n	let A: f32 = dot(gaussianUV, gaussianUV);\n	if (A > 1.0) {\n		discard;\n		return output;\n	}\n	var alpha: f32 = fastExp(-A * 4.0) * gaussianColor.a;\n	#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)\n		if (alpha < uniform.alphaClip) {\n			discard;\n			return output;\n		}\n	#endif\n	#ifdef PICK_PASS\n		output.color = getPickOutput();\n	#elif SHADOW_PASS\n		output.color = vec4f(0.0, 0.0, 0.0, 1.0);\n	#elif PREPASS_PASS\n		output.color = float2vec4(vLinearDepth);\n	#else\n		if (alpha < (1.0 / 255.0)) {\n			discard;\n			return output;\n		}\n		#ifndef DITHER_NONE\n			opacityDither(&alpha, id * 0.013);\n		#endif\n		output.color = vec4f(input.gaussianColor.xyz * alpha, alpha);\n	#endif\n	return output;\n}',gsplatSHVS:"\n#if SH_BANDS > 0\nfn unpack111011s(bits: u32) -> vec3f {\n	return (vec3f((vec3<u32>(bits) >> vec3<u32>(21u, 11u, 0u)) & vec3<u32>(0x7ffu, 0x3ffu, 0x7ffu)) / vec3f(2047.0, 1023.0, 2047.0)) * 2.0 - 1.0;\n}\nstruct ScaleAndSH {\n	scale: f32,\n	a: vec3f,\n	b: vec3f,\n	c: vec3f\n};\nfn fetchScale(t_in: vec4<u32>) -> ScaleAndSH {\n	var result: ScaleAndSH;\n	result.scale = bitcast<f32>(t_in.x);\n	result.a = unpack111011s(t_in.y);\n	result.b = unpack111011s(t_in.z);\n	result.c = unpack111011s(t_in.w);\n	return result;\n}\nstruct SH {\n	a: vec3f,\n	b: vec3f,\n	c: vec3f,\n	d: vec3f\n};\nfn fetch4(t_in: vec4<u32>) -> SH {\n	var result: SH;\n	result.a = unpack111011s(t_in.x);\n	result.b = unpack111011s(t_in.y);\n	result.c = unpack111011s(t_in.z);\n	result.d = unpack111011s(t_in.w);\n	return result;\n}\nfn fetch1(t_in: u32) -> vec3f {\n	return unpack111011s(t_in);\n}\n#if SH_BANDS == 1\n	var splatSH_1to3: texture_2d<u32>;\n	fn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 3>>, scale: ptr<function, f32>) {\n		let result = fetchScale(textureLoad(splatSH_1to3, source.uv, 0));\n		*scale = result.scale;\n		sh[0] = result.a;\n		sh[1] = result.b;\n		sh[2] = result.c;\n	}\n#elif SH_BANDS == 2\n	var splatSH_1to3: texture_2d<u32>;\n	var splatSH_4to7: texture_2d<u32>;\n	var splatSH_8to11: texture_2d<u32>;\n	fn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 8>>, scale: ptr<function, f32>) {\n		let first: ScaleAndSH = fetchScale(textureLoad(splatSH_1to3, source.uv, 0));\n		*scale = first.scale;\n		sh[0] = first.a;\n		sh[1] = first.b;\n		sh[2] = first.c;\n		let second: SH = fetch4(textureLoad(splatSH_4to7, source.uv, 0));\n		sh[3] = second.a;\n		sh[4] = second.b;\n		sh[5] = second.c;\n		sh[6] = second.d;\n		sh[7] = fetch1(textureLoad(splatSH_8to11, source.uv, 0).x);\n	}\n#else\n	var splatSH_1to3: texture_2d<u32>;\n	var splatSH_4to7: texture_2d<u32>;\n	var splatSH_8to11: texture_2d<u32>;\n	var splatSH_12to15: texture_2d<u32>;\n	fn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 15>>, scale: ptr<function, f32>) {\n		let first: ScaleAndSH = fetchScale(textureLoad(splatSH_1to3, source.uv, 0));\n		*scale = first.scale;\n		sh[0] = first.a;\n		sh[1] = first.b;\n		sh[2] = first.c;\n		let second: SH = fetch4(textureLoad(splatSH_4to7, source.uv, 0));\n		sh[3] = second.a;\n		sh[4] = second.b;\n		sh[5] = second.c;\n		sh[6] = second.d;\n		let third: SH = fetch4(textureLoad(splatSH_8to11, source.uv, 0));\n		sh[7] = third.a;\n		sh[8] = third.b;\n		sh[9] = third.c;\n		sh[10] = third.d;\n		let fourth: SH = fetch4(textureLoad(splatSH_12to15, source.uv, 0));\n		sh[11] = fourth.a;\n		sh[12] = fourth.b;\n		sh[13] = fourth.c;\n		sh[14] = fourth.d;\n	}\n#endif\n#endif\n",gsplatSourceVS:"\nattribute vertex_position: vec3f;\nattribute vertex_id_attrib: u32;\nuniform numSplats: u32;\nvar splatOrder: texture_2d<u32>;\nfn initSource(source: ptr<function, SplatSource>) -> bool {\n	let w: u32 = textureDimensions(splatOrder, 0).x;\n	source.order = vertex_id_attrib + u32(vertex_position.z);\n	if (source.order >= uniform.numSplats) {\n		return false;\n	}\n	let orderUV = vec2i(vec2u(source.order % w, source.order / w));\n	source.id = textureLoad(splatOrder, orderUV, 0).r;\n	source.uv = vec2i(vec2u(source.id % w, source.id / w));\n	source.cornerUV = vertex_position.xy;\n	return true;\n}\n",gsplatVS:'\n#include "gsplatCommonVS"\nvarying gaussianUV: vec2f;\nvarying gaussianColor: vec4f;\n#ifndef DITHER_NONE\n	varying id: f32;\n#endif\nconst discardVec: vec4f = vec4f(0.0, 0.0, 2.0, 1.0);\n#ifdef PREPASS_PASS\n	varying vLinearDepth: f32;\n#endif\n@vertex\nfn vertexMain(input: VertexInput) -> VertexOutput {\n	var output: VertexOutput;\n	var source: SplatSource;\n	if (!initSource(&source)) {\n		output.position = discardVec;\n		return output;\n	}\n	let modelCenter: vec3f = readCenter(&source);\n	var center: SplatCenter;\n	if (!initCenter(modelCenter, &center)) {\n		output.position = discardVec;\n		return output;\n	}\n	var corner: SplatCorner;\n	if (!initCorner(&source, &center, &corner)) {\n		output.position = discardVec;\n		return output;\n	}\n	var clr: vec4f = readColor(&source);\n	#if GSPLAT_AA\n		clr.a = clr.a * corner.aaFactor;\n	#endif\n	#if SH_BANDS > 0\n		let modelView3x3 = mat3x3f(center.modelView[0].xyz, center.modelView[1].xyz, center.modelView[2].xyz);\n		let dir = normalize(center.view * modelView3x3);\n		var sh: array<vec3f, SH_COEFFS>;\n		var scale: f32;\n		readSHData(&source, &sh, &scale);\n		clr = vec4f(clr.xyz + evalSH(&sh, dir) * scale, clr.a);\n	#endif\n	clipCorner(&corner, clr.w);\n	output.position = center.proj + vec4f(corner.offset, 0.0, 0.0);\n	output.gaussianUV = corner.uv;\n	output.gaussianColor = vec4f(prepareOutputFromGamma(max(clr.xyz, vec3f(0.0))), clr.w);\n	#ifndef DITHER_NONE\n		output.id = f32(source.id);\n	#endif\n	#ifdef PREPASS_PASS\n		output.vLinearDepth = -center.view.z;\n	#endif\n	return output;\n}\n',gsplatWorkBufferVS:"\nvar center: texture_2d<f32>;\nvar covA: texture_2d<f32>;\nvar covB: texture_2d<f32>;\nvar splatColor: texture_2d<f32>;\nfn readCenter(source: ptr<function, SplatSource>) -> vec3f {\n	return textureLoad(center, source.uv, 0).xyz;\n}\nfn readCovariance(source: ptr<function, SplatSource>, cov_A: ptr<function, vec3f>, cov_B: ptr<function, vec3f>) {\n	*cov_A = textureLoad(covA, source.uv, 0).xyz;\n	*cov_B = textureLoad(covB, source.uv, 0).xyz;\n}\nfn readColor(source: ptr<function, SplatSource>) -> vec4f {\n	return textureLoad(splatColor, source.uv, 0);\n}   \n",gsplatPackingPS:pf,quadVS:"\n	attribute aPosition: vec2f;\n	varying uv0: vec2f;\n	@vertex fn vertexMain(input: VertexInput) -> VertexOutput {\n		var output: VertexOutput;\n		output.position = vec4f(input.aPosition, 0.0, 1.0);\n		output.uv0 = getImageEffectUV((input.aPosition + 1.0) * 0.5);\n		return output;\n	}\n",indirectCoreCS:"\nstruct DrawIndexedIndirectArgs {\n	indexCount: u32,\n	instanceCount: u32,\n	firstIndex: u32,\n	baseVertex: i32,\n	firstInstance: u32\n};\nstruct DrawIndirectArgs {\n	vertexCount: u32,\n	instanceCount: u32,\n	firstVertex: u32,\n	firstInstance: u32,\n	_pad: u32\n};\n",immediateLinePS:'\n	#include "gammaPS"\n	varying color: vec4f;\n	@fragment\n	fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n		var output: FragmentOutput;\n		output.color = vec4f(gammaCorrectOutput(decodeGamma3(input.color.rgb)), input.color.a);\n		return output;\n	}\n',immediateLineVS:"\n	attribute vertex_position: vec4f;\n	attribute vertex_color: vec4f;\n	uniform matrix_model: mat4x4f;\n	uniform matrix_viewProjection: mat4x4f;\n	varying color: vec4f;\n	@vertex\n	fn vertexMain(input : VertexInput) -> VertexOutput {\n		var output : VertexOutput;\n		output.color = input.vertex_color;\n		output.position = uniform.matrix_viewProjection * uniform.matrix_model * input.vertex_position;\n		return output;\n	}\n",iridescenceDiffractionPS:"\nuniform material_iridescenceRefractionIndex: f32;\nfn iridescence_iorToFresnelScalar(transmittedIor: f32, incidentIor: f32) -> f32 {\n	return pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);\n}\nfn iridescence_iorToFresnelVec3(transmittedIor: vec3f, incidentIor: f32) -> vec3f {\n	return pow((transmittedIor - vec3f(incidentIor)) / (transmittedIor + vec3f(incidentIor)), vec3f(2.0));\n}\nfn iridescence_fresnelToIor(f0: vec3f) -> vec3f {\n	let sqrtF0: vec3f = sqrt(f0);\n	return (vec3f(1.0) + sqrtF0) / (vec3f(1.0) - sqrtF0);\n}\nconst XYZ_TO_REC709: mat3x3f = mat3x3f(\n	vec3f(3.2404542, -1.5371385, -0.4985314),\n	vec3f(-0.9692660,  1.8760108,  0.0415560),\n	vec3f(0.0556434, -0.2040259,  1.0572252)\n);\nfn iridescence_sensitivity(opd: f32, shift: vec3f) -> vec3f {\n	let PI: f32 = 3.141592653589793;\n	let phase: f32 = 2.0 * PI * opd * 1.0e-9;\n	const val: vec3f = vec3f(5.4856e-13, 4.4201e-13, 5.2481e-13);\n	const pos: vec3f = vec3f(1.6810e+06, 1.7953e+06, 2.2084e+06);\n	const var_: vec3f = vec3f(4.3278e+09, 9.3046e+09, 6.6121e+09);\n	var xyz: vec3f = val * sqrt(2.0 * PI * var_) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var_);\n	xyz.x = xyz.x + 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));\n	xyz = xyz / vec3f(1.0685e-07);\n	return XYZ_TO_REC709 * xyz;\n}\nfn iridescence_fresnelScalar(cosTheta: f32, f0: f32) -> f32 {\n	let x: f32 = clamp(1.0 - cosTheta, 0.0, 1.0);\n	let x2: f32 = x * x;\n	let x5: f32 = x * x2 * x2;\n	return f0 + (1.0 - f0) * x5;\n}\nfn iridescence_fresnelVec3(cosTheta: f32, f0: vec3f) -> vec3f {\n	let x: f32 = clamp(1.0 - cosTheta, 0.0, 1.0);\n	let x2: f32 = x * x;\n	let x5: f32 = x * x2 * x2;\n	return f0 + (vec3f(1.0) - f0) * x5;\n}\nfn calcIridescence(outsideIor: f32, cosTheta: f32, base_f0: vec3f, iridescenceThickness: f32) -> vec3f {\n	let PI: f32 = 3.141592653589793;\n	let iridescenceIor: f32 = mix(outsideIor, uniform.material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));\n	let sinTheta2Sq: f32 = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));\n	let cosTheta2Sq: f32 = 1.0 - sinTheta2Sq;\n	if (cosTheta2Sq < 0.0) {\n		return vec3f(1.0);\n	}\n	let cosTheta2: f32 = sqrt(cosTheta2Sq);\n	let r0: f32 = iridescence_iorToFresnelScalar(iridescenceIor, outsideIor);\n	let r12: f32 = iridescence_fresnelScalar(cosTheta, r0);\n	let r21: f32 = r12;\n	let t121: f32 = 1.0 - r12;\n	let phi12: f32 = select(0.0, PI, iridescenceIor < outsideIor);\n	let phi21: f32 = PI - phi12;\n	let baseIor: vec3f = iridescence_fresnelToIor(base_f0 + vec3f(0.0001));\n	let r1: vec3f = iridescence_iorToFresnelVec3(baseIor, iridescenceIor);\n	let r23: vec3f = iridescence_fresnelVec3(cosTheta2, r1);\n	let phi23: vec3f = select(vec3f(0.0), vec3f(PI), baseIor < vec3f(iridescenceIor));\n	let opd: f32 = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;\n	let phi: vec3f = vec3f(phi21) + phi23;\n	let r123Sq: vec3f = clamp(vec3f(r12) * r23, vec3f(1e-5), vec3f(0.9999));\n	let r123: vec3f = sqrt(r123Sq);\n	let rs: vec3f = pow(vec3f(t121), vec3f(2.0)) * r23 / (vec3f(1.0) - r123Sq);\n	let c0: vec3f = vec3f(r12) + rs;\n	var i_irid: vec3f = c0;\n	var cm: vec3f = rs - vec3f(t121);\n	cm = cm * r123;\n	let sm1: vec3f = 2.0 * iridescence_sensitivity(1.0 * opd, 1.0 * phi);\n	i_irid = i_irid + cm * sm1;\n	cm = cm * r123;\n	let sm2: vec3f = 2.0 * iridescence_sensitivity(2.0 * opd, 2.0 * phi);\n	i_irid = i_irid + cm * sm2;\n	return max(i_irid, vec3f(0.0));\n}\nfn getIridescenceDiffraction(cosTheta: f32, specularity: vec3f, iridescenceThickness: f32) -> vec3f {\n	return calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);\n}\n",iridescencePS:"\n#ifdef STD_IRIDESCENCE_CONSTANT\n	uniform material_iridescence: f32;\n#endif\nfn getIridescence() {\n	var iridescence = 1.0;\n	#ifdef STD_IRIDESCENCE_CONSTANT\n	iridescence = iridescence * uniform.material_iridescence;\n	#endif\n	#ifdef STD_IRIDESCENCE_TEXTURE\n	iridescence = iridescence * textureSampleBias({STD_IRIDESCENCE_TEXTURE_NAME}, {STD_IRIDESCENCE_TEXTURE_NAME}Sampler, {STD_IRIDESCENCE_TEXTURE_UV}, uniform.textureBias).{STD_IRIDESCENCE_TEXTURE_CHANNEL};\n	#endif\n	dIridescence = iridescence; \n}\n",iridescenceThicknessPS:"\nuniform material_iridescenceThicknessMax: f32;\n#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE\n	uniform material_iridescenceThicknessMin: f32;\n#endif\nfn getIridescenceThickness() {\n	#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE\n		var blend: f32 = textureSampleBias({STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}, {STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}Sampler, {STD_IRIDESCENCETHICKNESS_TEXTURE_UV}, uniform.textureBias).{STD_IRIDESCENCETHICKNESS_TEXTURE_CHANNEL};\n		var iridescenceThickness: f32 = mix(uniform.material_iridescenceThicknessMin, uniform.material_iridescenceThicknessMax, blend);\n	#else\n		var iridescenceThickness: f32 = uniform.material_iridescenceThicknessMax;\n	#endif\n	dIridescenceThickness = iridescenceThickness; \n}\n",iorPS:"\n#ifdef STD_IOR_CONSTANT\n	uniform material_refractionIndex: f32;\n#endif\nfn getIor() {\n#ifdef STD_IOR_CONSTANT\n	dIor = uniform.material_refractionIndex;\n#else\n	dIor = 1.0 / 1.5;\n#endif\n}\n",lightDeclarationPS:"\n#if defined(LIGHT{i})\n	uniform light{i}_color: vec3f;\n	#if LIGHT{i}TYPE == DIRECTIONAL\n		uniform light{i}_direction: vec3f;\n	#else\n		#define LIT_CODE_LIGHTS_POINT\n		uniform light{i}_position: vec3f;\n		uniform light{i}_radius: f32;\n		#if LIGHT{i}TYPE == SPOT\n			#define LIT_CODE_LIGHTS_SPOT\n			uniform light{i}_direction: vec3f;\n			uniform light{i}_innerConeAngle: f32;\n			uniform light{i}_outerConeAngle: f32;\n		#endif\n	#endif\n	#if LIGHT{i}SHAPE != PUNCTUAL\n		#define LIT_CODE_FALLOFF_SQUARED\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			uniform light{i}_position: vec3f;\n		#endif\n		uniform light{i}_halfWidth: vec3f;\n		uniform light{i}_halfHeight: vec3f;\n	#else\n		#if LIGHT{i}FALLOFF == LINEAR\n			#define LIT_CODE_FALLOFF_LINEAR\n		#endif\n		#if LIGHT{i}FALLOFF == INVERSESQUARED\n			#define LIT_CODE_FALLOFF_SQUARED\n		#endif\n	#endif\n	#if defined(LIGHT{i}CASTSHADOW)\n		uniform light{i}_shadowMatrix: mat4x4f;\n		uniform light{i}_shadowIntensity: f32;\n		uniform light{i}_shadowParams: vec4f;\n		#if LIGHT{i}SHADOWTYPE == PCSS_32F\n			uniform light{i}_shadowSearchArea: f32;\n			uniform light{i}_cameraParams: vec4f;\n			#if LIGHT{i}TYPE == DIRECTIONAL\n				uniform light{i}_softShadowParams: vec4f;\n			#endif\n		#endif\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			uniform light{i}_shadowMatrixPalette: array<mat4x4f, 4>;\n			uniform light{i}_shadowCascadeDistances: vec4f;\n			uniform light{i}_shadowCascadeCount: i32;\n			uniform light{i}_shadowCascadeBlend: f32;\n		#endif\n		#if LIGHT{i}TYPE == OMNI\n			NOT SUPPORTED\n			\n		#else\n			#if defined(LIGHT{i}SHADOW_PCF)\n				var light{i}_shadowMap: texture_depth_2d;\n				var light{i}_shadowMapSampler: sampler_comparison;\n			#else\n				var light{i}_shadowMap: texture_2d<f32>;\n				var light{i}_shadowMapSampler: sampler;\n			#endif\n		#endif\n	#endif\n	#if defined(LIGHT{i}COOKIE)\n		#define LIT_CODE_COOKIE\n		#if LIGHT{i}TYPE == OMNI\n			NOT SUPPORTED\n		#endif\n		#if LIGHT{i}TYPE == SPOT\n			NOT SUPPORTED\n		#endif\n	#endif\n#endif\n",lightDiffuseLambertPS:"\nfn getLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f) -> f32 {\n	return max(dot(worldNormal, -lightDirNorm), 0.0);\n}\n",lightDirPointPS:"\nfn evalOmniLight(lightPosW: vec3f) -> vec3f {\n	return vPositionW - lightPosW;\n}\n",lightEvaluationPS:"\n#if defined(LIGHT{i})\n	evaluateLight{i}(\n		#if defined(LIT_IRIDESCENCE)\n			iridescenceFresnel\n		#endif\n	);\n#endif\n",lightFunctionLightPS:"\n#if defined(LIGHT{i})\nfn evaluateLight{i}(\n	#if defined(LIT_IRIDESCENCE)\n		iridescenceFresnel: vec3f\n	#endif\n) {\n	var lightColor: vec3f = uniform.light{i}_color;\n	#if LIGHT{i}TYPE == DIRECTIONAL && !defined(LIT_SHADOW_CATCHER)\n		if (all(lightColor == vec3f(0.0, 0.0, 0.0))) {\n			return;\n		}\n	#endif\n	#if LIGHT{i}TYPE == DIRECTIONAL\n		dLightDirNormW = uniform.light{i}_direction;\n		dAtten = 1.0;\n	#else\n		var lightDirW: vec3f = evalOmniLight(uniform.light{i}_position);\n		dLightDirNormW = normalize(lightDirW);\n		#if defined(LIGHT{i}COOKIE)\n			#if LIGHT{i}TYPE == SPOT\n				#ifdef LIGHT{i}COOKIE_FALLOFF\n					#ifdef LIGHT{i}COOKIE_TRANSFORM\n						var cookieAttenuation: vec3f = getCookie2DXform(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity, uniform.light{i}_cookieMatrix, uniform.light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};\n					#else\n						var cookieAttenuation: vec3f = getCookie2D(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n					#endif\n				#else\n					#ifdef LIGHT{i}COOKIE_TRANSFORM\n						var cookieAttenuation: vec3f = getCookie2DClipXform(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity, uniform.light{i}_cookieMatrix, uniform.light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};\n					#else\n						var cookieAttenuation: vec3f = getCookie2DClip(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n					#endif\n				#endif\n			#endif\n			#if LIGHT{i}TYPE == OMNI\n				var cookieAttenuation: vec3f = getCookieCube(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n			#endif\n			lightColor = lightColor * cookieAttenuation;\n		#endif\n		#if LIGHT{i}SHAPE == PUNCTUAL\n			#if LIGHT{i}FALLOFF == LINEAR\n				dAtten = getFalloffLinear(uniform.light{i}_radius, lightDirW);\n			#else\n				dAtten = getFalloffInvSquared(uniform.light{i}_radius, lightDirW);\n			#endif\n		#else\n			dAtten = getFalloffWindow(uniform.light{i}_radius, lightDirW);\n		#endif\n		#if LIGHT{i}TYPE == SPOT\n			#if !defined(LIGHT{i}COOKIE) || defined(LIGHT{i}COOKIE_FALLOFF)\n				dAtten = dAtten * getSpotEffect(uniform.light{i}_direction, uniform.light{i}_innerConeAngle, uniform.light{i}_outerConeAngle, dLightDirNormW);\n			#endif\n		#endif\n	#endif\n	if (dAtten < 0.00001) {\n		return;\n	}\n	#if LIGHT{i}SHAPE != PUNCTUAL\n		#if LIGHT{i}SHAPE == RECT\n			calcRectLightValues(uniform.light{i}_position, uniform.light{i}_halfWidth, uniform.light{i}_halfHeight);\n		#elif LIGHT{i}SHAPE == DISK\n			calcDiskLightValues(uniform.light{i}_position, uniform.light{i}_halfWidth, uniform.light{i}_halfHeight);\n		#elif LIGHT{i}SHAPE == SPHERE\n			calcSphereLightValues(uniform.light{i}_position, uniform.light{i}_halfWidth, uniform.light{i}_halfHeight);\n		#endif\n	#endif\n	#if LIGHT{i}SHAPE != PUNCTUAL\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			var attenDiffuse: f32 = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirNormW);\n		#else\n			#if LIGHT{i}SHAPE == RECT\n				var attenDiffuse: f32 = getRectLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n			#elif LIGHT{i}SHAPE == DISK\n				var attenDiffuse: f32 = getDiskLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n			#elif LIGHT{i}SHAPE == SPHERE\n				var attenDiffuse: f32 = getSphereLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n			#endif\n		#endif\n	#else\n		dAtten = dAtten * getLightDiffuse(litArgs_worldNormal, vec3(0.0), dLightDirNormW);\n	#endif\n	#ifdef LIGHT{i}CASTSHADOW\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			var shadow: f32 = getShadow{i}(vec3(0.0));\n		#else\n			var shadow: f32 = getShadow{i}(lightDirW);\n		#endif\n		shadow = mix(1.0, shadow, uniform.light{i}_shadowIntensity);\n		dAtten = dAtten * shadow;\n		#if defined(LIT_SHADOW_CATCHER) && LIGHT{i}TYPE == DIRECTIONAL\n			dShadowCatcher = dShadowCatcher * shadow;\n		#endif			\n	#endif\n	#if LIGHT{i}SHAPE != PUNCTUAL\n		#ifdef LIT_SPECULAR\n			dDiffuseLight = dDiffuseLight + (((attenDiffuse * dAtten) * lightColor) * (1.0 - dLTCSpecFres));\n		#else\n			dDiffuseLight = dDiffuseLight + ((attenDiffuse * dAtten) * lightColor);\n		#endif						\n	#else\n		#if defined(AREA_LIGHTS) && defined(LIT_SPECULAR)\n			dDiffuseLight = dDiffuseLight + ((dAtten * lightColor) * (1.0 - litArgs_specularity));\n		#else\n			dDiffuseLight = dDiffuseLight + (dAtten * lightColor);\n		#endif\n	#endif\n	#ifdef LIGHT{i}AFFECT_SPECULARITY\n		#if LIGHT{i}SHAPE != PUNCTUAL\n			#ifdef LIT_CLEARCOAT\n				#if LIGHT{i}SHAPE == RECT\n					ccSpecularLight = ccSpecularLight + (ccLTCSpecFres * getRectLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor);\n				#elif LIGHT{i}SHAPE == DISK\n					ccSpecularLight = ccSpecularLight + (ccLTCSpecFres * getDiskLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor);\n				#elif LIGHT{i}SHAPE == SPHERE\n					ccSpecularLight = ccSpecularLight + (ccLTCSpecFres * getSphereLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor);\n				#endif\n			#endif\n			#ifdef LIT_SPECULAR\n				#if LIGHT{i}SHAPE == RECT\n					dSpecularLight = dSpecularLight + (dLTCSpecFres * getRectLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor);\n				#elif LIGHT{i}SHAPE == DISK\n					dSpecularLight = dSpecularLight + (dLTCSpecFres * getDiskLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor);\n				#elif LIGHT{i}SHAPE == SPHERE\n					dSpecularLight = dSpecularLight + (dLTCSpecFres * getSphereLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor);\n				#endif\n			#endif\n		#else\n			#if LIGHT{i}TYPE == DIRECTIONAL && LIT_FRESNEL_MODEL != NONE\n				#define LIGHT{i}FRESNEL\n			#endif\n			#ifdef LIT_SPECULAR\n				var halfDirW: vec3f = normalize(-dLightDirNormW + dViewDirW);\n			#endif\n			#ifdef LIT_CLEARCOAT\n				var lightspecularCC: vec3f = getLightSpecular(halfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * lightColor;\n				#ifdef LIGHT{i}FRESNEL\n					lightspecularCC = lightspecularCC * getFresnelCC(dot(dViewDirW, halfDirW));\n				#endif\n				ccSpecularLight = ccSpecularLight + lightspecularCC;\n			#endif\n			#ifdef LIT_SHEEN\n				sSpecularLight = sSpecularLight + (getLightSpecularSheen(halfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * lightColor);\n			#endif\n			#ifdef LIT_SPECULAR\n				var lightSpecular: vec3f = getLightSpecular(halfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * lightColor;\n				#ifdef LIGHT{i}FRESNEL\n					#if defined(LIT_IRIDESCENCE)\n						lightSpecular = lightSpecular * getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity, iridescenceFresnel, litArgs_iridescence_intensity);\n					#else\n						lightSpecular = lightSpecular * getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity);\n					#endif\n				#else\n					lightSpecular = lightSpecular * litArgs_specularity;\n				#endif\n				\n				dSpecularLight = dSpecularLight + lightSpecular;\n			#endif\n		#endif\n	#endif\n}\n#endif\n",lightFunctionShadowPS:"\n#ifdef LIGHT{i}CASTSHADOW\n	fn getShadowSampleCoord{i}(shadowTransform: mat4x4f, shadowParams: vec4f, worldPosition: vec3f, lightPos: vec3f, lightDir: ptr<function, vec3f>, lightDirNorm: vec3f, normal: vec3f) -> vec3f {\n		var surfacePosition = worldPosition;\n		#ifdef LIGHT{i}_SHADOW_SAMPLE_POINT\n			#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n				let distScale: f32 = length(*lightDir);\n				surfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n				*lightDir = surfacePosition - lightPos;\n				return *lightDir;\n			#endif\n		#else\n			#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER\n				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n					surfacePosition = surfacePosition + normal * shadowParams.y;\n				#endif\n			#else\n				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n					#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO\n						var distScale: f32 = 1.0;\n					#else\n						var distScale: f32 = abs(dot(vPositionW - lightPos, lightDirNorm));\n					#endif\n					surfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n				#endif\n			#endif\n			var positionInShadowSpace: vec4f = shadowTransform * vec4f(surfacePosition, 1.0);\n			#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO\n				positionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;\n			#else\n				#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER\n					positionInShadowSpace.xyz = positionInShadowSpace.xyz / positionInShadowSpace.w;\n				#else\n					positionInShadowSpace.xy = positionInShadowSpace.xy / positionInShadowSpace.w;\n					positionInShadowSpace.z = length(*lightDir) * shadowParams.w;\n				#endif\n			#endif\n			#ifdef SHADOW_SAMPLE_Z_BIAS\n			#endif\n			surfacePosition = positionInShadowSpace.xyz;\n		#endif\n		return surfacePosition;\n	}\n	fn getShadow{i}(lightDirW_in: vec3f) -> f32 {\n		#ifdef LIGHT{i}_SHADOW_CASCADES\n			var cascadeIndex: i32 = getShadowCascadeIndex(uniform.light{i}_shadowCascadeDistances, uniform.light{i}_shadowCascadeCount);\n			#ifdef LIGHT{i}_SHADOW_CASCADE_BLEND\n				cascadeIndex = ditherShadowCascadeIndex(cascadeIndex, uniform.light{i}_shadowCascadeDistances, uniform.light{i}_shadowCascadeCount, uniform.light{i}_shadowCascadeBlend);\n			#endif\n			var shadowMatrix: mat4x4f = uniform.light{i}_shadowMatrixPalette[cascadeIndex];\n		#else\n			var shadowMatrix: mat4x4f = uniform.light{i}_shadowMatrix;\n		#endif\n		var lightDirArg = lightDirW_in;\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			var shadowCoord: vec3f = getShadowSampleCoord{i}(shadowMatrix, uniform.light{i}_shadowParams, vPositionW, vec3f(0.0), &lightDirArg, dLightDirNormW, dVertexNormalW);\n		#else\n			 var shadowCoord: vec3f = getShadowSampleCoord{i}(shadowMatrix, uniform.light{i}_shadowParams, vPositionW, uniform.light{i}_position, &lightDirArg, dLightDirNormW, dVertexNormalW);\n		#endif\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			shadowCoord = fadeShadow(shadowCoord, uniform.light{i}_shadowCascadeDistances);\n		#endif\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			#if LIGHT{i}SHADOWTYPE == VSM_16F\n				return getShadowVSM16(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 5.54);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == VSM_32F\n				return getShadowVSM32(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 15.0);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCSS_32F\n				#if LIGHT{i}SHAPE != PUNCTUAL\n					let shadowSearchArea = vec2f(length(uniform.light{i}_halfWidth), length(uniform.light{i}_halfHeight)) * uniform.light{i}_shadowSearchArea;\n					return getShadowPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, shadowSearchArea, lightDirW_in);\n				#else\n					return getShadowPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, uniform.light{i}_softShadowParams, lightDirW_in);\n				#endif\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n				return getShadowPCF1x1(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n				return getShadowPCF3x3(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F\n				return getShadowPCF5x5(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);\n			#endif\n		#endif\n		#if LIGHT{i}TYPE == SPOT\n			#if LIGHT{i}SHADOWTYPE == VSM_16F\n				return getShadowSpotVSM16(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 5.54, lightDirW_in);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == VSM_32F\n				return getShadowSpotVSM32(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 15.0, lightDirW_in);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCSS_32F\n				#if LIGHT{i}SHAPE != PUNCTUAL\n					var shadowSearchArea: vec2f = vec2f(length(uniform.light{i}_halfWidth), length(uniform.light{i}_halfHeight)) * uniform.light{i}_shadowSearchArea;\n				#else\n					var shadowSearchArea: vec2f = vec2f(uniform.light{i}_shadowSearchArea);\n				#endif\n				return getShadowSpotPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, shadowSearchArea, lightDirW_in);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n				return getShadowSpotPCF1x1(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n				return getShadowSpotPCF3x3(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F\n				return getShadowSpotPCF5x5(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);\n			#endif\n		#endif\n		#if LIGHT{i}TYPE == OMNI\n			#if LIGHT{i}SHADOWTYPE == PCSS_32F\n				 var shadowSearchArea: vec2f;\n				 #if LIGHT{i}SHAPE != PUNCTUAL\n					var shadowSearchArea: vec2f = vec2f(length(uniform.light{i}_halfWidth), length(uniform.light{i}_halfHeight)) * uniform.light{i}_shadowSearchArea;\n				#else\n					var shadowSearchArea: vec2f = vec2f(uniform.light{i}_shadowSearchArea);\n				#endif\n				return getShadowOmniPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, shadowSearchArea, lightDirW_in);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n				return getShadowOmniPCF1x1(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, lightDirW_in);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n				return getShadowOmniPCF3x3(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, lightDirW_in);\n			#endif\n		#endif\n	}\n#endif\n",lightingPS:'\n#ifdef LIT_CLUSTERED_LIGHTS\n	#define LIT_CODE_FALLOFF_LINEAR\n	#define LIT_CODE_FALLOFF_SQUARED\n	#define LIT_CODE_LIGHTS_POINT\n	#define LIT_CODE_LIGHTS_SPOT\n#endif\n#ifdef AREA_LIGHTS\n	var areaLightsLutTex1: texture_2d<f32>;\n	var areaLightsLutTex1Sampler: sampler;\n	var areaLightsLutTex2: texture_2d<f32>;\n	var areaLightsLutTex2Sampler: sampler;\n#endif\n#ifdef LIT_LIGHTING\n	#include "lightDiffuseLambertPS"\n	#if defined(AREA_LIGHTS) || defined(LIT_CLUSTERED_AREA_LIGHTS)\n		#include "ltcPS"\n	#endif\n#endif\n#ifdef SHADOW_DIRECTIONAL\n	#include "shadowCascadesPS"\n#endif\n#if defined(SHADOW_KIND_PCF1)\n	#include "shadowPCF1PS"\n#endif\n#if defined(SHADOW_KIND_PCF3)\n	#include "shadowPCF3PS"\n#endif\n#if defined(SHADOW_KIND_PCF5)\n	#include "shadowPCF5PS"\n#endif\n#if defined(SHADOW_KIND_PCSS)\n	#include "linearizeDepthPS"\n	#include "shadowSoftPS"\n#endif\n#if defined(SHADOW_KIND_VSM)\n	#include "shadowEVSMPS"\n#endif\n#ifdef LIT_CODE_FALLOFF_LINEAR\n	#include "falloffLinearPS"\n#endif\n#ifdef LIT_CODE_FALLOFF_SQUARED\n	#include "falloffInvSquaredPS"\n#endif\n#ifdef LIT_CODE_LIGHTS_POINT\n	#include "lightDirPointPS"\n#endif\n#ifdef LIT_CODE_LIGHTS_SPOT\n	#include "spotPS"\n#endif\n#ifdef LIT_CODE_COOKIE\n	#include "cookiePS"\n#endif\n#ifdef LIT_CLUSTERED_LIGHTS\n	#include "clusteredLightPS"\n#endif\n#ifdef LIGHT_COUNT > 0\n	#include "lightFunctionShadowPS, LIGHT_COUNT"\n	#include "lightFunctionLightPS, LIGHT_COUNT"\n#endif\n',lightmapAddPS:"\nfn addLightMap(\n	lightmap: vec3f,\n	dir: vec3f,\n	worldNormal: vec3f,\n	viewDir: vec3f,\n	reflectionDir: vec3f,\n	gloss: f32,\n	specularity: vec3f,\n	vertexNormal: vec3f,\n	tbn: mat3x3f\n#if defined(LIT_IRIDESCENCE)\n	, iridescenceFresnel: vec3f,\n	iridescenceIntensity: f32\n#endif\n) {\n	#if defined(LIT_SPECULAR) && defined(LIT_DIR_LIGHTMAP)\n		if (dot(dir, dir) < 0.0001) {\n				dDiffuseLight = dDiffuseLight + lightmap;\n		} else {\n			let vlight: f32 = saturate(dot(dir, -vertexNormal));\n			let flight: f32 = saturate(dot(dir, -worldNormal));\n			let nlight: f32 = (flight / max(vlight, 0.01)) * 0.5;\n			dDiffuseLight = dDiffuseLight + lightmap * nlight * 2.0;\n			let halfDir: vec3f = normalize(-dir + viewDir);\n			var specularLight: vec3f = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);\n			#ifdef LIT_SPECULAR_FRESNEL\n				specularLight = specularLight *\n					getFresnel(dot(viewDir, halfDir),\n					gloss,\n					specularity\n				#if defined(LIT_IRIDESCENCE)\n					, iridescenceFresnel,\n					iridescenceIntensity\n				#endif\n					);\n			#endif\n			dSpecularLight = dSpecularLight + specularLight;\n		}\n	#else\n		dDiffuseLight = dDiffuseLight + lightmap;\n	#endif\n}\n",lightmapPS:"\n#ifdef STD_LIGHTMAP_DIR\n	var<private> dLightmapDir: vec3f;\n	var texture_dirLightMap: texture_2d<f32>;\n	var texture_dirLightMapSampler: sampler;\n#endif\nfn getLightMap() {\n	dLightmap = vec3f(1.0);\n	#ifdef STD_LIGHT_TEXTURE\n		dLightmap = dLightmap * {STD_LIGHT_TEXTURE_DECODE}(textureSampleBias({STD_LIGHT_TEXTURE_NAME}, {STD_LIGHT_TEXTURE_NAME}Sampler, {STD_LIGHT_TEXTURE_UV}, uniform.textureBias)).{STD_LIGHT_TEXTURE_CHANNEL};\n		#ifdef STD_LIGHTMAP_DIR\n			var dir: vec3f = textureSampleBias(texture_dirLightMap, texture_dirLightMapSampler, {STD_LIGHT_TEXTURE_UV}, uniform.textureBias).xyz * 2.0 - 1.0;\n			var dirDot = dot(dir, dir);\n			dLightmapDir = select(vec3(0.0), dir / sqrt(dirDot), dirDot > 0.001);\n		#endif\n	#endif\n	#ifdef STD_LIGHT_VERTEX\n		dLightmap = dLightmap * saturate(vVertexColor.{STD_LIGHT_VERTEX_CHANNEL});\n	#endif\n}\n",lightSpecularAnisoGGXPS:"\nfn calcLightSpecular(gloss: f32, worldNormal: vec3f, viewDir: vec3f, h: vec3f, lightDirNorm: vec3f, tbn: mat3x3f) -> f32 {\n	let PI: f32 = 3.141592653589793;\n	let roughness: f32 = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n	let alphaRoughness: f32 = roughness * roughness;\n	let anisotropy: f32 = dAnisotropy;\n	let direction: vec2f = dAnisotropyRotation;\n	let at: f32 = mix(alphaRoughness, 1.0, anisotropy * anisotropy);\n	let ab: f32 = clamp(alphaRoughness, 0.001, 1.0);\n	let anisotropicT: vec3f = normalize(tbn * vec3f(direction, 0.0));\n	let anisotropicB: vec3f = normalize(cross(tbn[2], anisotropicT));\n	let NoH: f32 = dot(worldNormal, h);\n	let ToH: f32 = dot(anisotropicT, h);\n	let BoH: f32 = dot(anisotropicB, h);\n	let a2: f32 = at * ab;\n	let v: vec3f = vec3f(ab * ToH, at * BoH, a2 * NoH);\n	let v2: f32 = dot(v, v);\n	let w2: f32 = a2 / v2;\n	let D: f32 = a2 * w2 * w2 * (1.0 / PI);\n	let ToV: f32 = dot(anisotropicT, viewDir);\n	let BoV: f32 = dot(anisotropicB, viewDir);\n	let ToL: f32 = dot(anisotropicT, -lightDirNorm);\n	let BoL: f32 = dot(anisotropicB, -lightDirNorm);\n	let NoV: f32 = dot(worldNormal, viewDir);\n	let NoL: f32 = dot(worldNormal, -lightDirNorm);\n	let lambdaV: f32 = NoL * length(vec3f(at * ToV, ab * BoV, NoV));\n	let lambdaL: f32 = NoV * length(vec3f(at * ToL, ab * BoL, NoL));\n	let G: f32 = 0.5 / (lambdaV + lambdaL);\n	return D * G;\n}\nfn getLightSpecular(h: vec3f, reflDir: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, gloss: f32, tbn: mat3x3f) -> f32 {\n	return calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);\n}\n",lightSpecularBlinnPS:"\nfn calcLightSpecular(gloss: f32, worldNormal: vec3f, h: vec3f) -> f32 {\n	let nh: f32 = max( dot( h, worldNormal ), 0.0 );\n	var specPow: f32 = exp2(gloss * 11.0);\n	specPow = max(specPow, 0.0001);\n	return pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfn getLightSpecular(h: vec3f, reflDir: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, gloss: f32, tbn: mat3x3f) -> f32 {\n	return calcLightSpecular(gloss, worldNormal, h);\n}\n",lightSheenPS:"\nfn sheenD(normal: vec3f, h: vec3f, roughness: f32) -> f32 {\n	let PI: f32 = 3.141592653589793;\n	let invR: f32 = 1.0 / (roughness * roughness);\n	var cos2h: f32 = max(dot(normal, h), 0.0);\n	cos2h = cos2h * cos2h;\n	let sin2h: f32 = max(1.0 - cos2h, 0.0078125);\n	return (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);\n}\nfn sheenV(normal: vec3f, viewDir: vec3f, light: vec3f) -> f32 {\n	let NoV: f32 = max(dot(normal, viewDir), 0.000001);\n	let NoL: f32 = max(dot(normal, light), 0.000001);\n	return 1.0 / (4.0 * (NoL + NoV - NoL * NoV));\n}\nfn getLightSpecularSheen(h: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, sheenGloss: f32) -> f32 {\n	let D: f32 = sheenD(worldNormal, h, sheenGloss);\n	let V: f32 = sheenV(worldNormal, viewDir, -lightDirNorm);\n	return D * V;\n}",linearizeDepthPS:"\n#ifndef LINEARIZE_DEPTH\n#define LINEARIZE_DEPTH\nfn linearizeDepthWithParams(z: f32, cameraParams: vec4f) -> f32 {\n	if (cameraParams.w == 0.0) {\n		return (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));\n	} else {\n		return cameraParams.z + z * (cameraParams.y - cameraParams.z);\n	}\n}\n#ifndef CAMERAPLANES\n	#define CAMERAPLANES\n	uniform camera_params: vec4f;\n#endif\nfn linearizeDepth(z: f32) -> f32 {\n	return linearizeDepthWithParams(z, uniform.camera_params);\n}\n#endif\n",litForwardBackendPS:'\nfn evaluateBackend() -> FragmentOutput {\n	var output: FragmentOutput;\n	#ifdef LIT_SSAO\n		litArgs_ao = litArgs_ao * textureSampleLevel(ssaoTexture, ssaoTextureSampler, pcPosition.xy * uniform.ssaoTextureSizeInv, 0.0).r;\n	#endif\n	#ifdef LIT_NEEDS_NORMAL\n		#ifdef LIT_SPECULAR\n			getReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);\n		#endif\n		#ifdef LIT_CLEARCOAT\n			ccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));\n		#endif\n	#endif\n	#ifdef LIT_SPECULAR_OR_REFLECTION\n		#ifdef LIT_METALNESS\n			var f0: f32 = 1.0 / litArgs_ior;\n			f0 = (f0 - 1.0) / (f0 + 1.0);\n			f0 = f0 * f0;\n			litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);\n			litArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);\n		#endif\n		#ifdef LIT_IRIDESCENCE\n			var iridescenceFresnel: vec3f = getIridescenceDiffraction(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);\n		#endif\n	#endif\n	#ifdef LIT_ADD_AMBIENT\n		addAmbient(litArgs_worldNormal);\n		#ifdef LIT_SPECULAR\n			dDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);\n		#endif\n		#ifdef LIT_SEPARATE_AMBIENT\n			var dAmbientLight: vec3f = dDiffuseLight;\n			dDiffuseLight = vec3(0.0);\n		#endif\n	#endif\n	#ifndef LIT_OLD_AMBIENT\n		dDiffuseLight = dDiffuseLight * uniform.material_ambient;\n	#endif\n	#ifdef LIT_AO\n		#ifndef LIT_OCCLUDE_DIRECT\n			occludeDiffuse(litArgs_ao);\n		#endif\n	#endif\n	#ifdef LIT_LIGHTMAP\n		addLightMap(\n			litArgs_lightmap, \n			litArgs_lightmapDir, \n			litArgs_worldNormal, \n			dViewDirW, \n			dReflDirW, \n			litArgs_gloss, \n			litArgs_specularity, \n			dVertexNormalW,\n			dTBN\n		#if defined(LIT_IRIDESCENCE)\n			, iridescenceFresnel,\n			litArgs_iridescence_intensity\n		#endif\n		);\n	#endif\n	#ifdef LIT_LIGHTING || LIT_REFLECTIONS\n		#ifdef LIT_REFLECTIONS\n			#ifdef LIT_CLEARCOAT\n				addReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);\n			\n				#ifdef LIT_SPECULAR_FRESNEL\n					ccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));\n					ccReflection = ccReflection * ccFresnel;\n				#else\n					ccFresnel = 0.0;\n				#endif\n			#endif\n			#ifdef LIT_SPECULARITY_FACTOR\n				ccReflection = ccReflection * litArgs_specularityFactor;\n			#endif\n			#ifdef LIT_SHEEN\n				addReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);\n			#endif\n			addReflection(dReflDirW, litArgs_gloss);\n			#ifdef LIT_FRESNEL_MODEL\n				dReflection = vec4f(\n					dReflection.rgb * getFresnel(\n						dot(dViewDirW, litArgs_worldNormal),\n						litArgs_gloss,\n						litArgs_specularity\n					#if defined(LIT_IRIDESCENCE)\n						, iridescenceFresnel,\n						litArgs_iridescence_intensity\n					#endif\n						),\n					dReflection.a\n				);\n			#else\n				dReflection = vec4f(dReflection.rgb * litArgs_specularity, dReflection.a);\n			#endif\n			#ifdef LIT_SPECULARITY_FACTOR\n				dReflection = vec4f(dReflection.rgb * litArgs_specularityFactor, dReflection.a);\n			#endif\n		#endif\n		#ifdef AREA_LIGHTS\n			dSpecularLight = dSpecularLight * litArgs_specularity;\n			#ifdef LIT_SPECULAR\n				calcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);\n			#endif\n		#endif\n		\n		#ifdef LIGHT_COUNT > 0\n			#include "lightEvaluationPS, LIGHT_COUNT"\n		#endif\n		#ifdef LIT_CLUSTERED_LIGHTS\n			addClusteredLights(litArgs_worldNormal, dViewDirW, dReflDirW,\n				#if defined(LIT_CLEARCOAT)\n						ccReflDirW,\n				#endif\n						litArgs_gloss, litArgs_specularity, dVertexNormalW, dTBN, \n				#if defined(LIT_IRIDESCENCE)\n						iridescenceFresnel,\n				#endif\n						litArgs_clearcoat_worldNormal, litArgs_clearcoat_gloss, litArgs_sheen_gloss, litArgs_iridescence_intensity\n			);\n		#endif\n		#ifdef AREA_LIGHTS\n			#ifdef LIT_CLEARCOAT\n				litArgs_clearcoat_specularity = 1.0;\n			#endif\n			#ifdef LIT_SPECULAR\n				litArgs_specularity = vec3(1.0);\n			#endif\n		#endif\n		#ifdef LIT_REFRACTION\n			addRefraction(\n				litArgs_worldNormal, \n				dViewDirW, \n				litArgs_thickness, \n				litArgs_gloss, \n				litArgs_specularity, \n				litArgs_albedo, \n				litArgs_transmission,\n				litArgs_ior,\n				litArgs_dispersion\n				#if defined(LIT_IRIDESCENCE)\n					, iridescenceFresnel, \n					litArgs_iridescence_intensity\n				#endif\n			);\n		#endif\n	#endif\n	#ifdef LIT_AO\n		#ifdef LIT_OCCLUDE_DIRECT\n			occludeDiffuse(litArgs_ao);\n		#endif\n		#if LIT_OCCLUDE_SPECULAR != NONE\n			occludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);\n		#endif\n	#endif\n	#ifdef LIT_SPECULARITY_FACTOR\n		dSpecularLight = dSpecularLight * litArgs_specularityFactor;\n	#endif\n	#if !defined(LIT_OPACITY_FADES_SPECULAR)\n		#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == PREMULTIPLIED\n			var specLum: f32 = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3f( 0.2126, 0.7152, 0.0722 ));\n			#ifdef LIT_CLEARCOAT\n				specLum = specLum + dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection * litArgs_clearcoat_specularity, vec3f( 0.2126, 0.7152, 0.0722 ));\n			#endif\n			litArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);\n		#endif\n		litArgs_opacity = litArgs_opacity * uniform.material_alphaFade;\n	#endif\n	#ifdef LIT_LIGHTMAP_BAKING\n		#ifdef LIT_LIGHTMAP_BAKING_COLOR\n			#include "bakeLmEndPS"\n		#endif\n		#ifdef LIT_LIGHTMAP_BAKING_DIR\n			#include "bakeDirLmEndPS"\n		#endif\n	#else\n		#include "endPS"\n		#include "outputAlphaPS"\n	#endif\n	#ifdef LIT_MSDF\n		output.color = applyMsdf(output.color);\n	#endif\n	#include "outputPS"\n	#include "debugOutputPS"\n	#ifdef LIT_SHADOW_CATCHER\n		output.color = vec4f(vec3f(dShadowCatcher), output.color.a);\n	#endif\n	return output;\n}\n',litForwardDeclarationPS:'\nvar<private> sReflection: vec3f;\nvar<private> dVertexNormalW: vec3f;\nvar<private> dTangentW: vec3f;\nvar<private> dBinormalW: vec3f;\nvar<private> dViewDirW: vec3f;\nvar<private> dReflDirW: vec3f;\nvar<private> ccReflDirW: vec3f;\nvar<private> dLightDirNormW: vec3f;\nvar<private> dAtten: f32;\nvar<private> dTBN: mat3x3f;\nvar<private> dReflection: vec4f;\nvar<private> dDiffuseLight: vec3f;\nvar<private> dSpecularLight: vec3f;\nvar<private> ccFresnel: f32;\nvar<private> ccReflection: vec3f;\nvar<private> ccSpecularLight: vec3f;\nvar<private> ccSpecularityNoFres: f32;\nvar<private> sSpecularLight: vec3f;\n#ifdef LIT_DISPERSION\n	uniform material_dispersion: f32;\n#endif\n#ifndef LIT_OPACITY_FADES_SPECULAR\n	uniform material_alphaFade: f32;\n#endif\n#ifdef LIT_SSAO\n	var ssaoTexture : texture_2d<f32>;\n	var ssaoTextureSampler : sampler;\n	uniform ssaoTextureSizeInv: vec2f;\n#endif\n#ifdef LIT_SHADOW_CATCHER\n	var<private> dShadowCatcher: f32 = 1.0;\n#endif\n#if LIGHT_COUNT > 0\n	#include "lightDeclarationPS, LIGHT_COUNT"\n#endif\n#ifdef LIT_SPECULAR\n	#if LIT_FRESNEL_MODEL == NONE && !defined(LIT_REFLECTIONS) && !defined(LIT_DIFFUSE_MAP) \n		#define LIT_OLD_AMBIENT\n	#endif\n#endif\n#ifdef STD_LIGHTMAP_DIR\n	uniform bakeDir: f32;\n#endif\n#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT\n	uniform ambientBakeOcclusionContrast: f32;\n	uniform ambientBakeOcclusionBrightness: f32;\n#endif\n',litForwardMainPS:'\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n	#include "litUserMainStartPS"\n	dReflection = vec4f(0.0);\n	#ifdef LIT_CLEARCOAT\n		ccSpecularLight = vec3f(0.0);\n		ccReflection = vec3f(0.0);\n	#endif\n	#if LIT_NONE_SLICE_MODE == SLICED\n		#include "startNineSlicedPS"\n	#elif LIT_NONE_SLICE_MODE == TILED\n		#include "startNineSlicedTiledPS"\n	#endif\n	#ifdef LIT_NEEDS_NORMAL\n		dVertexNormalW = normalize(vNormalW);\n		#ifdef LIT_TANGENTS\n			#if defined(LIT_HEIGHTS) || defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS) || defined(LIT_GGX_SPECULAR)\n				dTangentW = vTangentW;\n				dBinormalW = vBinormalW;\n			#endif\n		#endif\n		getViewDir();\n		#ifdef LIT_TBN\n			getTBN(dTangentW, dBinormalW, dVertexNormalW);\n			#ifdef LIT_TWO_SIDED_LIGHTING\n				handleTwoSidedLighting();\n			#endif\n		#endif\n	#endif\n	evaluateFrontend();\n	#include "debugProcessFrontendPS"\n	var output: FragmentOutput = evaluateBackend();\n	#include "litUserMainEndPS"\n	return output;\n}\n',litForwardPostCodePS:'\n#ifdef LIT_NEEDS_NORMAL\n	#include "cubeMapRotatePS"\n	#include "cubeMapProjectPS"\n	#include "envProcPS"\n#endif\n#ifdef LIT_SPECULAR_OR_REFLECTION\n	#ifdef LIT_METALNESS\n		#include "metalnessModulatePS"\n	#endif\n	#if LIT_FRESNEL_MODEL == SCHLICK\n		#include "fresnelSchlickPS"\n	#endif\n	#ifdef LIT_IRIDESCENCE\n		#include "iridescenceDiffractionPS"\n	#endif\n#endif\n#ifdef LIT_AO\n	#include "aoDiffuseOccPS"\n	#include "aoSpecOccPS"\n#endif\n#if LIT_REFLECTION_SOURCE == ENVATLASHQ\n	#include "envAtlasPS"\n	#include "reflectionEnvHQPS"\n#elif LIT_REFLECTION_SOURCE == ENVATLAS\n	#include "envAtlasPS"\n	#include "reflectionEnvPS"\n#elif LIT_REFLECTION_SOURCE == CUBEMAP\n	#include "reflectionCubePS"\n#elif LIT_REFLECTION_SOURCE == SPHEREMAP\n	#include "reflectionSpherePS"\n#endif\n#ifdef LIT_REFLECTIONS\n	#ifdef LIT_CLEARCOAT\n		#include "reflectionCCPS"\n	#endif\n	#ifdef LIT_SHEEN\n		#include "reflectionSheenPS"\n	#endif\n#endif\n#ifdef LIT_REFRACTION\n	#if defined(LIT_DYNAMIC_REFRACTION)\n		#include "refractionDynamicPS"\n	#elif defined(LIT_REFLECTIONS)\n		#include "refractionCubePS"\n	#endif\n#endif\n#ifdef LIT_SHEEN\n	#include "lightSheenPS"\n#endif\nuniform material_ambient: vec3f;\n#ifdef LIT_SPECULAR\n	#ifdef LIT_LIGHTING\n		#ifdef LIT_GGX_SPECULAR\n			#include "lightSpecularAnisoGGXPS"\n		#else\n			#include "lightSpecularBlinnPS"\n		#endif\n	#endif\n#endif\n#include "combinePS"\n#ifdef LIT_LIGHTMAP\n	#include "lightmapAddPS"\n#endif\n#ifdef LIT_ADD_AMBIENT\n	#include "ambientPS"\n#endif\n#ifdef LIT_MSDF\n	#include "msdfPS"\n#endif\n#ifdef LIT_NEEDS_NORMAL\n	#include "viewDirPS"\n	#ifdef LIT_SPECULAR\n		#ifdef LIT_GGX_SPECULAR\n			#include "reflDirAnisoPS"\n		#else\n			#include "reflDirPS"\n		#endif\n	#endif\n#endif\n#include "lightingPS"\n',litForwardPreCodePS:'\n#include "basePS"\n#include "sphericalPS"\n#include "decodePS"\n#include "gammaPS"\n#include "tonemappingPS"\n#include "fogPS"\n#if LIT_NONE_SLICE_MODE == SLICED\n	#include "baseNineSlicedPS"\n#elif LIT_NONE_SLICE_MODE == TILED\n	#include "baseNineSlicedTiledPS"\n#endif\n#ifdef LIT_TBN\n	#include "TBNPS"\n	#ifdef LIT_TWO_SIDED_LIGHTING\n		#include "twoSidedLightingPS"\n	#endif\n#endif\n',litMainPS:'\n#include "varyingsPS"\n#include "litUserDeclarationPS"\n#include "frontendDeclPS"\n#if defined(PICK_PASS) || defined(PREPASS_PASS)\n	#include "frontendCodePS"\n	#include "litUserCodePS"\n	#include "litOtherMainPS"\n#elif defined(SHADOW_PASS)\n	#include "frontendCodePS"\n	#include "litUserCodePS"\n	#include "litShadowMainPS"\n#else\n	#include "litForwardDeclarationPS"\n	#include "litForwardPreCodePS"\n	#include "frontendCodePS"\n	#include "litForwardPostCodePS"\n	#include "litForwardBackendPS"\n	#include "litUserCodePS"\n	#include "litForwardMainPS"\n#endif\n',litMainVS:'\n#include "varyingsVS"\n#include  "litUserDeclarationVS"\n#ifdef VERTEX_COLOR\n	attribute vertex_color: vec4f;\n#endif\n#ifdef NINESLICED\n	varying vMask: vec2f;\n	varying vTiledUv: vec2f;\n	var<private> dMaskGlobal: vec2f;\n	var<private> dTiledUvGlobal: vec2f;\n	uniform innerOffset: vec4f;\n	uniform outerScale: vec2f;\n	uniform atlasRect: vec4f;\n#endif\nvar<private> dPositionW: vec3f;\nvar<private> dModelMatrix: mat4x4f;\n#include "transformCoreVS"\n#ifdef UV0\n	attribute vertex_texCoord0: vec2f;\n	#include "uv0VS"\n#endif\n#ifdef UV1\n	attribute vertex_texCoord1: vec2f;\n	#include "uv1VS"\n#endif\n#ifdef LINEAR_DEPTH\n	#ifndef VIEWMATRIX\n	#define VIEWMATRIX\n		uniform matrix_view: mat4x4f;\n	#endif\n#endif\n#include "transformVS"\n#ifdef NORMALS\n	#include "normalCoreVS"\n	#include "normalVS"\n#endif\n#ifdef TANGENTS\n	attribute vertex_tangent: vec4f;\n#endif\n#include "uvTransformUniformsPS, UV_TRANSFORMS_COUNT"\n#ifdef MSDF\n	#include "msdfVS"\n#endif\n#include  "litUserCodeVS"\n@vertex\nfn vertexMain(input : VertexInput) -> VertexOutput {\n	#include "litUserMainStartVS"\n	var output : VertexOutput;\n	output.position = getPosition();\n	output.vPositionW = getWorldPosition();\n	#ifdef NORMALS\n		output.vNormalW = getNormal();\n	#endif\n	#ifdef TANGENTS\n		output.vTangentW = normalize(dNormalMatrix * vertex_tangent.xyz);\n		output.vBinormalW = cross(output.vNormalW, output.vTangentW) * vertex_tangent.w;\n	#elif defined(GGX_SPECULAR)\n		output.vObjectSpaceUpW = normalize(dNormalMatrix * vec3f(0.0, 1.0, 0.0));\n	#endif\n	#ifdef UV0\n		var uv0: vec2f = getUv0();\n		#ifdef UV0_UNMODIFIED\n			output.vUv0 = uv0;\n		#endif\n	#endif\n	#ifdef UV1\n		var uv1: vec2f = getUv1();\n		#ifdef UV1_UNMODIFIED\n			output.vUv1 = uv1;\n		#endif\n	#endif\n	#include "uvTransformVS, UV_TRANSFORMS_COUNT"\n	#ifdef VERTEX_COLOR\n		output.vVertexColor = vertex_color;\n	#endif\n	#ifdef LINEAR_DEPTH\n		output.vLinearDepth = -(uniform.matrix_view * vec4f(output.vPositionW, 1.0)).z;\n	#endif\n	#ifdef MSDF\n		unpackMsdfParams();\n		output.outline_color = dOutlineColor;\n		output.outline_thickness = dOutlineThickness;\n		output.shadow_color = dShadowColor;\n		output.shadow_offset = dShadowOffset;\n	#endif\n	#ifdef NINESLICED\n		output.vMask = dMaskGlobal;\n		output.vTiledUv = dTiledUvGlobal;\n	#endif\n	#include "litUserMainEndVS"\n	return output;\n}\n',litOtherMainPS:'\n#ifdef PICK_PASS\n	#include "pickPS"\n#endif\n#ifdef PREPASS_PASS\n	#include "floatAsUintPS"\n#endif\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n	#include "litUserMainStartPS"\n	var output: FragmentOutput;\n	\n	evaluateFrontend();\n	#ifdef PICK_PASS\n		output.color = getPickOutput();\n	#endif\n	#ifdef PREPASS_PASS\n		output.color = float2vec4(vLinearDepth);\n	#endif\n	#include "litUserMainEndPS"\n	return output;\n}\n',litShaderArgsPS:"\nvar<private> litArgs_albedo: vec3f;\nvar<private> litArgs_opacity: f32;\nvar<private> litArgs_emission: vec3f;\nvar<private> litArgs_worldNormal: vec3f;\nvar<private> litArgs_ao: f32;\nvar<private> litArgs_lightmap: vec3f;\nvar<private> litArgs_lightmapDir: vec3f;\nvar<private> litArgs_metalness: f32;\nvar<private> litArgs_specularity: vec3f;\nvar<private> litArgs_specularityFactor: f32;\nvar<private> litArgs_gloss: f32;\nvar<private> litArgs_sheen_gloss: f32;\nvar<private> litArgs_sheen_specularity: vec3f;\nvar<private> litArgs_transmission: f32;\nvar<private> litArgs_thickness: f32;\nvar<private> litArgs_ior: f32;\nvar<private> litArgs_dispersion: f32;\nvar<private> litArgs_iridescence_intensity: f32;\nvar<private> litArgs_iridescence_thickness: f32;\nvar<private> litArgs_clearcoat_worldNormal: vec3f;\nvar<private> litArgs_clearcoat_specularity: f32;\nvar<private> litArgs_clearcoat_gloss: f32;\n",litShaderCorePS:'\n	#if LIT_NONE_SLICE_MODE == TILED\n		var<private> textureBias: f32 = -1000.0;\n	#else\n		uniform textureBias: f32;\n	#endif\n	#include "litShaderArgsPS"\n',litShadowMainPS:'\n#if LIGHT_TYPE != DIRECTIONAL\n	uniform view_position: vec3f;\n	uniform light_radius: f32;\n#endif\n#if SHADOW_TYPE == PCSS_32F\n	#include "linearizeDepthPS"\n#endif\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n	#include "litUserMainStartPS"\n	var output: FragmentOutput;\n	evaluateFrontend();\n	#ifdef PERSPECTIVE_DEPTH\n		var depth: f32 = input.position.z;\n		#if SHADOW_TYPE == PCSS_32F\n			#if LIGHT_TYPE != DIRECTIONAL\n				depth = linearizeDepthWithParams(depth, camera_params);\n			#endif\n		#endif\n	#else\n		var depth: f32 = min(distance(uniform.view_position, input.vPositionW) / uniform.light_radius, 0.99999);\n		#define MODIFIED_DEPTH\n	#endif\n	#if SHADOW_TYPE == VSM_16F || SHADOW_TYPE == VSM_32F\n		#if SHADOW_TYPE == VSM_32F\n			var exponent: f32 = 15.0;\n		#else\n			var exponent: f32 = 5.54;\n		#endif\n		var depth_vsm = 2.0 * depth - 1.0;\n		depth_vsm = exp(exponent * depth_vsm);\n		output.color = vec4f(depth_vsm, depth_vsm * depth_vsm, 1.0, 1.0);\n	#else\n		#if SHADOW_TYPE == PCSS_32F\n			output.color = vec4f(depth, 0.0, 0.0, 1.0);\n		#else\n			#ifdef MODIFIED_DEPTH\n				output.fragDepth = depth;\n			#endif\n			output.color = vec4f(1.0);\n		#endif\n	#endif\n	#include "litUserMainEndPS"\n	\n	return output;\n}\n',litUserDeclarationPS:"",litUserDeclarationVS:"",litUserCodePS:"",litUserCodeVS:"",litUserMainStartPS:"",litUserMainStartVS:"",litUserMainEndPS:"",litUserMainEndVS:"",ltcPS:"\nfn LTC_Uv(N: vec3f, V: vec3f, roughness: f32) -> vec2f {\n	const LUT_SIZE: f32 = 64.0;\n	const LUT_SCALE: f32 = (LUT_SIZE - 1.0) / LUT_SIZE;\n	const LUT_BIAS: f32 = 0.5 / LUT_SIZE;\n	let dotNV: f32 = saturate(dot( N, V ));\n	let uv: vec2f = vec2f( roughness, sqrt( 1.0 - dotNV ) );\n	return uv * LUT_SCALE + LUT_BIAS;\n}\nfn LTC_ClippedSphereFormFactor( f: vec3f ) -> f32 {\n	let l: f32 = length( f );\n	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nfn LTC_EdgeVectorFormFactor( v1: vec3f, v2: vec3f ) -> vec3f {\n	let x: f32 = dot( v1, v2 );\n	let y: f32 = abs( x );\n	let a: f32 = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n	let b: f32 = 3.4175940 + ( 4.1616724 + y ) * y;\n	let v: f32 = a / b;\n	let inv_sqrt_term = inverseSqrt( max( 1.0 - x * x, 1e-7f ) );\n	let theta_sintheta: f32 = select( (0.5 * inv_sqrt_term - v), v, x > 0.0 );\n	return cross( v1, v2 ) * theta_sintheta;\n}\nstruct Coords {\n	coord0: vec3f,\n	coord1: vec3f,\n	coord2: vec3f,\n	coord3: vec3f,\n}\nfn LTC_EvaluateRect( N: vec3f, V: vec3f, P: vec3f, mInv: mat3x3f, rectCoords: Coords) -> f32 {\n	let v1: vec3f = rectCoords.coord1 - rectCoords.coord0;\n	let v2: vec3f = rectCoords.coord3 - rectCoords.coord0;\n	let lightNormal: vec3f = cross( v1, v2 );\n	let factor: f32 = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n	let T1: vec3f = normalize( V - N * dot( V, N ) );\n	let T2: vec3f = factor * cross( N, T1 );\n	let mat: mat3x3f = mInv * transpose( mat3x3f( T1, T2, N ) );\n	var coords: array<vec3f, 4>;\n	coords[0] = mat * ( rectCoords.coord0 - P );\n	coords[1] = mat * ( rectCoords.coord1 - P );\n	coords[2] = mat * ( rectCoords.coord2 - P );\n	coords[3] = mat * ( rectCoords.coord3 - P );\n	coords[0] = normalize( coords[0] );\n	coords[1] = normalize( coords[1] );\n	coords[2] = normalize( coords[2] );\n	coords[3] = normalize( coords[3] );\n	var vectorFormFactor: vec3f = vec3f( 0.0 );\n	vectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[0], coords[1] );\n	vectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[1], coords[2] );\n	vectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[2], coords[3] );\n	vectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[3], coords[0] );\n	let result: f32 = LTC_ClippedSphereFormFactor( vectorFormFactor );\n	return result;\n}\nvar<private> dLTCCoords: Coords;\nfn getLTCLightCoords(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) -> Coords {\n	var coords: Coords;\n	coords.coord0 = lightPos + halfWidth - halfHeight;\n	coords.coord1 = lightPos - halfWidth - halfHeight;\n	coords.coord2 = lightPos - halfWidth + halfHeight;\n	coords.coord3 = lightPos + halfWidth + halfHeight;\n	return coords;\n}\nvar<private> dSphereRadius: f32;\nfn getSphereLightCoords(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) -> Coords {\n	dSphereRadius = max(length(halfWidth), length(halfHeight));\n	let f: vec3f = reflect(normalize(lightPos - uniform.view_position), vNormalW);\n	let w: vec3f = normalize(cross(f, halfHeight));\n	let h: vec3f = normalize(cross(f, w));\n	return getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);\n}\nvar<private> dLTCUV: vec2f;\n#ifdef LIT_CLEARCOAT\n	var<private> ccLTCUV: vec2f;\n#endif\nfn getLTCLightUV(gloss: f32, worldNormal: vec3f, viewDir: vec3f) -> vec2f {\n	let roughness: f32 = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n	return LTC_Uv( worldNormal, viewDir, roughness );\n}\nvar<private> dLTCSpecFres: vec3f;\n#ifdef LIT_CLEARCOAT\n	var<private> ccLTCSpecFres: vec3f;\n#endif\nfn getLTCLightSpecFres(uv: vec2f, specularity: vec3f) -> vec3f {\n	let t2: vec4f = textureSampleLevel(areaLightsLutTex2, areaLightsLutTex2Sampler, uv, 0.0);\n	return specularity * t2.x + ( vec3f( 1.0 ) - specularity) * t2.y;\n}\nfn calcLTCLightValues(gloss: f32, worldNormal: vec3f, viewDir: vec3f, specularity: vec3f, clearcoatGloss: f32, clearcoatWorldNormal: vec3f, clearcoatSpecularity: f32) {\n	dLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);\n	dLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity);\n	#ifdef LIT_CLEARCOAT\n		ccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);\n		ccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3f(clearcoatSpecularity));\n	#endif\n}\nfn calcRectLightValues(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) {\n	dLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n}\nfn calcDiskLightValues(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) {\n	calcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nfn calcSphereLightValues(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) {\n	dLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n}\nfn SolveCubic(Coefficient_in: vec4f) -> vec3f {\n	let pi: f32 = 3.14159;\n	var Coefficient = Coefficient_in;\n	Coefficient = vec4f(Coefficient.xyz / Coefficient.w, Coefficient.w);\n	let new_yz: vec2f = Coefficient.yz / 3.0;\n	Coefficient = vec4f(Coefficient.x, new_yz.x, new_yz.y, Coefficient.w);\n	\n	let A: f32 = Coefficient.w;\n	let B: f32 = Coefficient.z;\n	let C: f32 = Coefficient.y;\n	let D: f32 = Coefficient.x;\n	let Delta: vec3f = vec3f(\n		-Coefficient.z * Coefficient.z + Coefficient.y,\n		-Coefficient.y * Coefficient.z + Coefficient.x,\n		dot(vec2f(Coefficient.z, -Coefficient.y), Coefficient.xy)\n	);\n	let Discriminant: f32 = dot(vec2f(4.0 * Delta.x, -Delta.y), Delta.zy);\n	var xlc: vec2f;\n	var xsc: vec2f;\n	{\n		let A_a: f32 = 1.0;\n		let C_a: f32 = Delta.x;\n		let D_a: f32 = -2.0 * B * Delta.x + Delta.y;\n		let Theta: f32 = atan2(sqrt(Discriminant), -D_a) / 3.0;\n		let sqrt_neg_Ca = sqrt(-C_a);\n		let x_1a: f32 = 2.0 * sqrt_neg_Ca * cos(Theta);\n		let x_3a: f32 = 2.0 * sqrt_neg_Ca * cos(Theta + (2.0 / 3.0) * pi);\n		let xl: f32 = select(x_3a, x_1a, (x_1a + x_3a) > 2.0 * B);\n		xlc = vec2f(xl - B, A);\n	}\n	{\n		let A_d: f32 = D;\n		let C_d: f32 = Delta.z;\n		let D_d: f32 = -D * Delta.y + 2.0 * C * Delta.z;\n		let Theta: f32 = atan2(D * sqrt(Discriminant), -D_d) / 3.0;\n		let sqrt_neg_Cd = sqrt(-C_d);\n		let x_1d: f32 = 2.0 * sqrt_neg_Cd * cos(Theta);\n		let x_3d: f32 = 2.0 * sqrt_neg_Cd * cos(Theta + (2.0 / 3.0) * pi);\n		let xs: f32 = select(x_3d, x_1d, x_1d + x_3d < 2.0 * C);\n		xsc = vec2f(-D, xs + C);\n	}\n	let E: f32 =  xlc.y * xsc.y;\n	let F: f32 = -xlc.x * xsc.y - xlc.y * xsc.x;\n	let G: f32 =  xlc.x * xsc.x;\n	let xmc: vec2f = vec2f(C * F - B * G, -B * F + C * E);\n	var Root: vec3f = vec3f(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n	if (Root.x < Root.y && Root.x < Root.z) {\n		Root = Root.yxz;\n	} else if (Root.z < Root.x && Root.z < Root.y) {\n		Root = Root.xzy;\n	}\n	return Root;\n}\nfn LTC_EvaluateDisk(N: vec3f, V: vec3f, P: vec3f, Minv: mat3x3f, points: Coords) -> f32 {\n	let T1: vec3f = normalize(V - N * dot(V, N));\n	let T2: vec3f = cross(N, T1);\n	let R: mat3x3f = transpose( mat3x3f( T1, T2, N ) );\n	var L_: array<vec3f, 3>;\n	L_[0] = R * ( points.coord0 - P );\n	L_[1] = R * ( points.coord1 - P );\n	L_[2] = R * ( points.coord2 - P );\n	let C: vec3f  = 0.5 * (L_[0] + L_[2]);\n	var V1: vec3f = 0.5 * (L_[1] - L_[2]);\n	var V2: vec3f = 0.5 * (L_[1] - L_[0]);\n	let C_Minv: vec3f  = Minv * C;\n	let V1_Minv: vec3f = Minv * V1;\n	let V2_Minv: vec3f = Minv * V2;\n	var a: f32;\n	var b: f32;\n	let d11: f32 = dot(V1_Minv, V1_Minv);\n	let d22: f32 = dot(V2_Minv, V2_Minv);\n	let d12: f32 = dot(V1_Minv, V2_Minv);\n	if (abs(d12) / sqrt(d11 * d22) > 0.0001) {\n		let tr: f32 = d11 + d22;\n		let det_inner: f32 = -d12 * d12 + d11 * d22;\n		let det: f32 = sqrt(det_inner);\n		let u: f32 = 0.5 * sqrt(tr - 2.0 * det);\n		let v: f32 = 0.5 * sqrt(tr + 2.0 * det);\n		let e_max: f32 = (u + v) * (u + v);\n		let e_min: f32 = (u - v) * (u - v);\n		var V1_: vec3f;\n		var V2_: vec3f;\n		if (d11 > d22) {\n			V1_ = d12 * V1_Minv + (e_max - d11) * V2_Minv;\n			V2_ = d12 * V1_Minv + (e_min - d11) * V2_Minv;\n		} else {\n			V1_ = d12*V2_Minv + (e_max - d22)*V1_Minv;\n			V2_ = d12*V2_Minv + (e_min - d22)*V1_Minv;\n		}\n		a = 1.0 / e_max;\n		b = 1.0 / e_min;\n		V1 = normalize(V1_);\n		V2 = normalize(V2_);\n	} else {\n		a = 1.0 / dot(V1_Minv, V1_Minv);\n		b = 1.0 / dot(V2_Minv, V2_Minv);\n		V1 = V1_Minv * sqrt(a);\n		V2 = V2_Minv * sqrt(b);\n	}\n	var V3: vec3f = normalize(cross(V1, V2));\n	if (dot(C_Minv, V3) < 0.0) {\n		V3 = V3 * -1.0;\n	}\n	let L: f32  = dot(V3, C_Minv);\n	let x0: f32 = dot(V1, C_Minv) / L;\n	let y0: f32 = dot(V2, C_Minv) / L;\n	let E1: f32 = inverseSqrt(a);\n	let E2: f32 = inverseSqrt(b);\n	let a_scaled = a * L * L;\n	let b_scaled = b * L * L;\n	let c0: f32 = a_scaled * b_scaled;\n	let c1: f32 = a_scaled * b_scaled * (1.0 + x0 * x0 + y0 * y0) - a_scaled - b_scaled;\n	let c2: f32 = 1.0 - a_scaled * (1.0 + x0 * x0) - b_scaled * (1.0 + y0 * y0);\n	let c3: f32 = 1.0;\n	let roots: vec3f = SolveCubic(vec4f(c0, c1, c2, c3));\n	let e1: f32 = roots.x;\n	let e2: f32 = roots.y;\n	let e3: f32 = roots.z;\n	var avgDir: vec3f = vec3f(a_scaled * x0 / (a_scaled - e2), b_scaled * y0 / (b_scaled - e2), 1.0);\n	let rotate: mat3x3f = mat3x3f(V1, V2, V3);\n	avgDir = rotate * avgDir;\n	avgDir = normalize(avgDir);\n	let L1: f32 = sqrt(-e2 / e3);\n	let L2: f32 = sqrt(-e2 / e1);\n	let formFactor: f32 = max(0.0, L1 * L2 * inverseSqrt((1.0 + L1 * L1) * (1.0 + L2 * L2)));\n	const LUT_SIZE_disk: f32 = 64.0;\n	const LUT_SCALE_disk: f32 = ( LUT_SIZE_disk - 1.0 ) / LUT_SIZE_disk;\n	const LUT_BIAS_disk: f32 = 0.5 / LUT_SIZE_disk;\n	var uv: vec2f = vec2f(avgDir.z * 0.5 + 0.5, formFactor);\n	uv = uv * LUT_SCALE_disk + LUT_BIAS_disk;\n	let scale: f32 = textureSampleLevel(areaLightsLutTex2, areaLightsLutTex2Sampler, uv, 0.0).w;\n	return formFactor * scale;\n}\nfn FixNan(value: f32) -> f32 {\n	return select(value, 0.0, value != value);\n}\nfn getRectLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDir: vec3f, lightDirNorm: vec3f) -> f32 {\n	let identityMat = mat3x3f(vec3f(1.0, 0.0, 0.0), vec3f(0.0, 1.0, 0.0), vec3f(0.0, 0.0, 1.0));\n	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, identityMat, dLTCCoords );\n}\nfn getDiskLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDir: vec3f, lightDirNorm: vec3f) -> f32 {\n	let identityMat = mat3x3f(vec3f(1.0, 0.0, 0.0), vec3f(0.0, 1.0, 0.0), vec3f(0.0, 0.0, 1.0));\n	return FixNan(LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, identityMat, dLTCCoords ));\n}\nfn getSphereLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDir: vec3f, lightDirNorm: vec3f) -> f32 {\n	let falloff: f32 = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);\n	return FixNan(getLightDiffuse(worldNormal, viewDir, lightDirNorm) * falloff);\n}\nfn getLTCLightInvMat(uv: vec2f) -> mat3x3f {\n	let t1: vec4f = textureSampleLevel(areaLightsLutTex1, areaLightsLutTex1Sampler, uv, 0.0);\n	return mat3x3f(\n		vec3f( t1.x, 0.0, t1.y ),\n		vec3f( 0.0, 1.0, 0.0 ),\n		vec3f( t1.z, 0.0, t1.w )\n	);\n}\nfn calcRectLightSpecular(worldNormal: vec3f, viewDir: vec3f, uv: vec2f) -> f32 {\n	let mInv: mat3x3f = getLTCLightInvMat(uv);\n	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfn getRectLightSpecular(worldNormal: vec3f, viewDir: vec3f) -> f32 {\n	return calcRectLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfn calcDiskLightSpecular(worldNormal: vec3f, viewDir: vec3f, uv: vec2f) -> f32 {\n	let mInv: mat3x3f = getLTCLightInvMat(uv);\n	return LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfn getDiskLightSpecular(worldNormal: vec3f, viewDir: vec3f) -> f32 {\n	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfn getSphereLightSpecular(worldNormal: vec3f, viewDir: vec3f) -> f32 {\n	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\n",metalnessPS:"\n#ifdef STD_METALNESS_CONSTANT\nuniform material_metalness: f32;\n#endif\nfn getMetalness() {\n	var metalness: f32 = 1.0;\n	#ifdef STD_METALNESS_CONSTANT\n		metalness = metalness * uniform.material_metalness;\n	#endif\n	#ifdef STD_METALNESS_TEXTURE\n		metalness = metalness * textureSampleBias({STD_METALNESS_TEXTURE_NAME}, {STD_METALNESS_TEXTURE_NAME}Sampler, {STD_METALNESS_TEXTURE_UV}, uniform.textureBias).{STD_METALNESS_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_METALNESS_VERTEX\n	metalness = metalness * saturate(vVertexColor.{STD_METALNESS_VERTEX_CHANNEL});\n	#endif\n	dMetalness = metalness;\n}\n",metalnessModulatePS:"\nfn getSpecularModulate(specularity: vec3f, albedo: vec3f, metalness: f32, f0: f32) -> vec3f {\n	let dielectricF0: vec3f = f0 * specularity;\n	return mix(dielectricF0, albedo, metalness);\n}\nfn getAlbedoModulate(albedo: vec3f, metalness: f32) -> vec3f {\n	return albedo * (1.0 - metalness);\n}\n",morphPS:"\n	varying uv0: vec2f;\n	var morphTexture: texture_2d_array<f32>;\n	uniform morphFactor: array<f32, {MORPH_TEXTURE_MAX_COUNT}>;\n	uniform morphIndex: array<u32, {MORPH_TEXTURE_MAX_COUNT}>;\n	uniform count: u32;\n	@fragment\n	fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n		var color = vec3f(0, 0, 0);\n		let textureDims = textureDimensions(morphTexture);\n		let pixelCoords = vec2i(input.uv0 * vec2f(textureDims));\n		\n		for (var i: u32 = 0; i < uniform.count; i = i + 1) {\n			var textureIndex: u32 = uniform.morphIndex[i].element;\n			var delta = textureLoad(morphTexture, pixelCoords, textureIndex, 0).xyz;\n			color += uniform.morphFactor[i].element * delta;\n		}\n		var output: FragmentOutput;\n		output.color = vec4f(color, 1.0);\n		return output;\n	}\n",morphVS:"\n	attribute vertex_position: vec2f;\n	varying uv0: vec2f;\n	@vertex\n	fn vertexMain(input: VertexInput) -> VertexOutput {\n		var output: VertexOutput;\n		output.position = vec4f(input.vertex_position, 0.5, 1.0);\n		output.uv0 = input.vertex_position * 0.5 + vec2f(0.5, 0.5);\n		return output;\n	}\n",msdfPS:"\nvar texture_msdfMap: texture_2d<f32>;\nvar texture_msdfMapSampler: sampler;\nfn median(r: f32, g: f32, b: f32) -> f32 {\n	return max(min(r, g), min(max(r, g), b));\n}\nfn map(min: f32, max: f32, v: f32) -> f32 {\n	return (v - min) / (max - min);\n}\nuniform font_sdfIntensity: f32;\nuniform font_pxrange: f32;\nuniform font_textureWidth: f32;\n#ifndef LIT_MSDF_TEXT_ATTRIBUTE\n	uniform outline_color: vec4f;\n	uniform outline_thickness: f32;\n	uniform shadow_color: vec4f;\n	uniform shadow_offset: vec2f;\n#else\n	varying outline_color: vec4f;\n	varying outline_thickness: f32;\n	varying shadow_color: vec4f;\n	varying shadow_offset: vec2f;\n#endif\nfn applyMsdf(color_in: vec4f) -> vec4f {\n	#ifndef LIT_MSDF_TEXT_ATTRIBUTE\n		var outline_colorValue = uniform.outline_color;\n		var outline_thicknessValue = uniform.outline_thickness;\n		var shadow_colorValue = uniform.shadow_color;\n		var shadow_offsetValue = uniform.shadow_offset;\n	#else\n		var outline_colorValue = outline_color;\n		var outline_thicknessValue = outline_thickness;\n		var shadow_colorValue = shadow_color;\n		var shadow_offsetValue = shadow_offset;\n	#endif\n	var color = vec4f(gammaCorrectInputVec3(color_in.rgb), color_in.a);\n	let tsample: vec3f = textureSample(texture_msdfMap, texture_msdfMapSampler, vUv0).rgb;\n	let uvShdw: vec2f = vUv0 - shadow_offsetValue;\n	let ssample: vec3f = textureSample(texture_msdfMap, texture_msdfMapSampler, uvShdw).rgb;\n	let sigDist: f32 = median(tsample.r, tsample.g, tsample.b);\n	var sigDistShdw: f32 = median(ssample.r, ssample.g, ssample.b);\n	let smoothingMax: f32 = 0.2;\n	let w: vec2f = abs(dpdx(vUv0)) + abs(dpdy(vUv0));\n	let smoothing: f32 = clamp(w.x * uniform.font_textureWidth / uniform.font_pxrange, 0.0, smoothingMax);\n	let mapMin: f32 = 0.05;\n	let mapMax: f32 = clamp(1.0 - uniform.font_sdfIntensity, mapMin, 1.0);\n	let sigDistInner: f32 = map(mapMin, mapMax, sigDist);\n	let sigDistOutline: f32 = map(mapMin, mapMax, sigDist + outline_thicknessValue);\n	sigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thicknessValue);\n	let center: f32 = 0.5;\n	let inside: f32 = smoothstep(center - smoothing, center + smoothing, sigDistInner);\n	let outline: f32 = smoothstep(center - smoothing, center + smoothing, sigDistOutline);\n	let shadow: f32 = smoothstep(center - smoothing, center + smoothing, sigDistShdw);\n	let tcolor_outline: vec4f = outline * vec4f(outline_colorValue.a * outline_colorValue.rgb, outline_colorValue.a);\n	var tcolor: vec4f = select(vec4f(0.0), tcolor_outline, outline > inside);\n	tcolor = mix(tcolor, color, inside);\n	let scolor_shadow: vec4f = shadow * vec4f(shadow_colorValue.a * shadow_colorValue.rgb, shadow_colorValue.a);\n	let scolor: vec4f = select(tcolor, scolor_shadow, shadow > outline);\n	tcolor = mix(scolor, tcolor, outline);\n	tcolor = vec4f(gammaCorrectOutput(tcolor.rgb), tcolor.a);\n	return tcolor;\n}\n",msdfVS:"\nattribute vertex_outlineParameters: vec3f;\nattribute vertex_shadowParameters: vec3f;\nvarying outline_color: vec4f;\nvarying outline_thickness: f32;\nvarying shadow_color: vec4f;\nvarying shadow_offset: vec2f;\nvar<private> dOutlineColor: vec4f;\nvar<private> dOutlineThickness: f32;\nvar<private> dShadowColor: vec4f;\nvar<private> dShadowOffset: vec2f;\nfn unpackMsdfParams() {\n	let little: vec3f = vertex_outlineParameters % vec3f(256.0);\n	let big: vec3f = (vertex_outlineParameters - little) / 256.0;\n	dOutlineColor = vec4f(little.x, big.x, little.y, big.y) / 255.0;\n	dOutlineThickness = little.z / 255.0 * 0.2;\n	let little_shadow = vertex_shadowParameters % vec3f(256.0);\n	let big_shadow = (vertex_shadowParameters - little_shadow) / 256.0;\n	dShadowColor = vec4f(little_shadow.x, big_shadow.x, little_shadow.y, big_shadow.y) / 255.0;\n	dShadowOffset = (vec2f(little_shadow.z, big_shadow.z) / 127.0 - 1.0) * 0.005;\n}\n",normalVS:"\nvar<private> dNormalMatrix: mat3x3f;\nfn getNormal() -> vec3f {\n	dNormalMatrix = getNormalMatrix(dModelMatrix);\n	let localNormal: vec3f = getLocalNormal(vertex_normal);\n	return normalize(dNormalMatrix * localNormal);\n}",normalCoreVS:"\nattribute vertex_normal: vec3f;\nuniform matrix_normal: mat3x3f;\n#ifdef MORPHING_NORMAL\n	#ifdef MORPHING_INT\n		var morphNormalTex: texture_2d<u32>;\n		var morphNormalTexSampler: sampler;\n	#else\n		var morphNormalTex: texture_2d<f32>;\n		var morphNormalTexSampler: sampler;\n	#endif\n#endif\nfn getLocalNormal(vertexNormal: vec3f) -> vec3f {\n	var localNormal: vec3f = vertexNormal;\n	#ifdef MORPHING_NORMAL\n		let morphUV: vec2i = getTextureMorphCoords();\n		#ifdef MORPHING_INT\n			let morphNormalInt: vec4u = textureLoad(morphNormalTex, morphUV, 0);\n			let morphNormalF: vec3f = vec3f(morphNormalInt.xyz) / 65535.0 * 2.0 - 1.0;\n			localNormal = localNormal + morphNormalF;\n		#else\n			let morphNormal: vec3f = textureLoad(morphNormalTex, morphUV, 0).xyz;\n			localNormal = localNormal + morphNormal;\n		#endif\n	#endif\n	return localNormal;\n}\n#if defined(SKIN) || defined(BATCH)\n	fn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {\n		return mat3x3f(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n	}\n#elif defined(INSTANCING)\n	fn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {\n		return mat3x3f(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n	}\n#else\n	fn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {\n		return uniform.matrix_normal;\n	}\n#endif\n",normalMapPS:"\n#ifdef STD_NORMAL_TEXTURE\n	uniform material_bumpiness: f32;\n#endif\n#ifdef STD_NORMALDETAIL_TEXTURE\n	uniform material_normalDetailMapBumpiness: f32;\n	fn blendNormals(inN1: vec3f, inN2: vec3f) -> vec3f {\n		let n1: vec3f = inN1 + vec3f(0.0, 0.0, 1.0);\n		let n2: vec3f = inN2 * vec3f(-1.0, -1.0, 1.0);\n		return n1 * dot(n1, n2) / n1.z - n2;\n	}\n#endif\nfn getNormal() {\n#ifdef STD_NORMAL_TEXTURE\n	var normalMap: vec3f = {STD_NORMAL_TEXTURE_DECODE}(textureSampleBias({STD_NORMAL_TEXTURE_NAME}, {STD_NORMAL_TEXTURE_NAME}Sampler, {STD_NORMAL_TEXTURE_UV}, uniform.textureBias));\n	normalMap = mix(vec3f(0.0, 0.0, 1.0), normalMap, uniform.material_bumpiness);\n	#ifdef STD_NORMALDETAIL_TEXTURE\n		var normalDetailMap: vec3f = {STD_NORMALDETAIL_TEXTURE_DECODE}(textureSampleBias({STD_NORMALDETAIL_TEXTURE_NAME}, {STD_NORMALDETAIL_TEXTURE_NAME}Sampler, {STD_NORMALDETAIL_TEXTURE_UV}, uniform.textureBias));\n		normalDetailMap = mix(vec3f(0.0, 0.0, 1.0), normalDetailMap, uniform.material_normalDetailMapBumpiness);\n		normalMap = blendNormals(normalMap, normalDetailMap);\n	#endif\n	dNormalW = normalize(dTBN * normalMap);\n#else\n	dNormalW = dVertexNormalW;\n#endif\n}\n",opacityPS:"\nuniform material_opacity: f32;\nfn getOpacity() {\n	dAlpha = uniform.material_opacity;\n	#ifdef STD_OPACITY_TEXTURE\n	dAlpha = dAlpha * textureSampleBias({STD_OPACITY_TEXTURE_NAME}, {STD_OPACITY_TEXTURE_NAME}Sampler, {STD_OPACITY_TEXTURE_UV}, uniform.textureBias).{STD_OPACITY_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_OPACITY_VERTEX\n	dAlpha = dAlpha * clamp(vVertexColor.{STD_OPACITY_VERTEX_CHANNEL}, 0.0, 1.0);\n	#endif\n}\n",opacityDitherPS:'\n#if STD_OPACITY_DITHER == BAYER8\n	#include "bayerPS"\n#endif\nuniform blueNoiseJitter: vec4f;\n#if STD_OPACITY_DITHER == BLUENOISE\n	var blueNoiseTex32 : texture_2d<f32>;\n	var blueNoiseTex32Sampler : sampler;\n#endif\nfn opacityDither(alpha: f32, id: f32) {\n	#if STD_OPACITY_DITHER == BAYER8\n		var noise: f32 = bayer8(floor((pcPosition.xy + uniform.blueNoiseJitter.xy + id) % vec2f(8.0))) / 64.0;\n	#else\n		#if STD_OPACITY_DITHER == BLUENOISE\n			var uv = fract(pcPosition.xy / 32.0 + uniform.blueNoiseJitter.xy + id);\n			var noise: f32 = textureSampleLevel(blueNoiseTex32, blueNoiseTex32Sampler, uv, 0.0).y;\n		#endif\n		#if STD_OPACITY_DITHER == IGNNOISE\n			var magic = vec3f(0.06711056, 0.00583715, 52.9829189);\n			var noise: f32 = fract(magic.z * fract(dot(pcPosition.xy + uniform.blueNoiseJitter.xy + id, magic.xy)));\n		#endif\n	#endif\n	noise = pow(noise, 2.2);\n	if (alpha < noise) {\n		discard;\n	}\n}\n',outputPS:"\n",outputAlphaPS:"\n#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == ADDITIVEALPHA || defined(LIT_ALPHA_TO_COVERAGE)\n	output.color = vec4f(output.color.rgb, litArgs_opacity);\n#elif LIT_BLEND_TYPE == PREMULTIPLIED\n	output.color = vec4f(output.color.rgb * litArgs_opacity, litArgs_opacity);\n#else\n	output.color = vec4f(output.color.rgb, 1.0);\n#endif\n",outputTex2DPS:"\nvarying vUv0: vec2f;\nvar source: texture_2d<f32>;\nvar sourceSampler: sampler;\n@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n	var output: FragmentOutput;\n	output.color = textureSample(source, sourceSampler, input.vUv0);\n	return output;\n}\n",sheenPS:"\nuniform material_sheen: vec3f;\nfn getSheen() {\n	var sheenColor = uniform.material_sheen;\n	#ifdef STD_SHEEN_TEXTURE\n	sheenColor = sheenColor * {STD_SHEEN_TEXTURE_DECODE}(textureSampleBias({STD_SHEEN_TEXTURE_NAME}, {STD_SHEEN_TEXTURE_NAME}Sampler, {STD_SHEEN_TEXTURE_UV}, uniform.textureBias)).{STD_SHEEN_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_SHEEN_VERTEX\n	sheenColor = sheenColor * saturate3(vVertexColor.{STD_SHEEN_VERTEX_CHANNEL});\n	#endif\n	sSpecularity = sheenColor;\n}\n",sheenGlossPS:"\nuniform material_sheenGloss: f32;\nfn getSheenGlossiness() {\n	var sheenGlossiness = uniform.material_sheenGloss;\n	#ifdef STD_SHEENGLOSS_TEXTURE\n	sheenGlossiness = sheenGlossiness * textureSampleBias({STD_SHEENGLOSS_TEXTURE_NAME}, {STD_SHEENGLOSS_TEXTURE_NAME}Sampler, {STD_SHEENGLOSS_TEXTURE_UV}, uniform.textureBias).{STD_SHEENGLOSS_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_SHEENGLOSS_VERTEX\n	sheenGlossiness = sheenGlossiness * saturate(vVertexColor.{STD_SHEENGLOSS_VERTEX_CHANNEL});\n	#endif\n	#ifdef STD_SHEENGLOSS_INVERT\n	sheenGlossiness = 1.0 - sheenGlossiness;\n	#endif\n	sGlossiness = sheenGlossiness + 0.0000001;\n}\n",parallaxPS:"\nuniform material_heightMapFactor: f32;\nfn getParallax() {\n	var parallaxScale = uniform.material_heightMapFactor;\n	var height: f32 = textureSampleBias({STD_HEIGHT_TEXTURE_NAME}, {STD_HEIGHT_TEXTURE_NAME}Sampler, {STD_HEIGHT_TEXTURE_UV}, uniform.textureBias).{STD_HEIGHT_TEXTURE_CHANNEL};\n	height = height * parallaxScale - parallaxScale * 0.5;\n	var viewDirT: vec3f = dViewDirW * dTBN;\n	viewDirT.z = viewDirT.z + 0.42;\n	dUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",pickPS:"\nuniform meshInstanceId: u32;\nfn getPickOutput() -> vec4f {\n	let inv: vec4f = vec4f(1.0 / 255.0);\n	let shifts: vec4u = vec4u(16u, 8u, 0u, 24u);\n	let col: vec4u = (vec4u(uniform.meshInstanceId) >> shifts) & vec4u(0xffu);\n	return vec4f(col) * inv;\n}",reflDirPS:"\nfn getReflDir(worldNormal: vec3f, viewDir: vec3f, gloss: f32, tbn: mat3x3f) {\n	dReflDirW = normalize(-reflect(viewDir, worldNormal));\n}\n",reflDirAnisoPS:"\nfn getReflDir(worldNormal: vec3f, viewDir: vec3f, gloss: f32, tbn: mat3x3f) {\n	let roughness: f32 = sqrt(1.0 - min(gloss, 1.0));\n	let direction: vec2f = dAnisotropyRotation;\n	let anisotropicT: vec3f = normalize(tbn * vec3f(direction, 0.0));\n	let anisotropicB: vec3f = normalize(cross(tbn[2], anisotropicT));\n	let anisotropy: f32 = dAnisotropy;\n	let anisotropicDirection: vec3f = anisotropicB;\n	let anisotropicTangent: vec3f = cross(anisotropicDirection, viewDir);\n	let anisotropicNormal: vec3f = cross(anisotropicTangent, anisotropicDirection);\n	let bendFactor: f32 = 1.0 - anisotropy * (1.0 - roughness);\n	let bendFactor4: f32 = bendFactor * bendFactor * bendFactor * bendFactor;\n	let bentNormal: vec3f = normalize(mix(normalize(anisotropicNormal), normalize(worldNormal), bendFactor4));\n	dReflDirW = reflect(-viewDir, bentNormal);\n}",reflectionCCPS:"\n#ifdef LIT_CLEARCOAT\nfn addReflectionCC(reflDir: vec3f, gloss: f32) {\n	ccReflection = ccReflection + calcReflection(reflDir, gloss);\n}\n#endif\n",reflectionCubePS:"\nvar texture_cubeMap: texture_cube<f32>;\nvar texture_cubeMapSampler: sampler;\nuniform material_reflectivity: f32;\nfn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {\n	var lookupVec: vec3f = cubeMapProject(reflDir);\n	lookupVec.x = lookupVec.x * -1.0;\n	return {reflectionDecode}(textureSample(texture_cubeMap, texture_cubeMapSampler, lookupVec));\n}\nfn addReflection(reflDir: vec3f, gloss: f32) {\n	dReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);\n}\n",reflectionEnvHQPS:"\n#ifndef ENV_ATLAS\n	#define ENV_ATLAS\n	var texture_envAtlas: texture_2d<f32>;\n	var texture_envAtlasSampler: sampler;\n#endif\nvar texture_cubeMap: texture_cube<f32>;\nvar texture_cubeMapSampler: sampler;\nuniform material_reflectivity: f32;\nfn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {\n	let dir: vec3f = cubeMapProject(reflDir) * vec3f(-1.0, 1.0, 1.0);\n	let uv: vec2f = toSphericalUv(dir);\n	let level: f32 = saturate(1.0 - gloss) * 5.0;\n	let ilevel: f32 = floor(level);\n	let flevel: f32 = level - ilevel;\n	let sharp: vec3f = {reflectionCubemapDecode}(textureSample(texture_cubeMap, texture_cubeMapSampler, dir));\n	let roughA: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, mapRoughnessUv(uv, ilevel)));\n	let roughB: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, mapRoughnessUv(uv, ilevel + 1.0)));\n	return processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));\n}\nfn addReflection(reflDir: vec3f, gloss: f32) {\n	dReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);\n}\n",reflectionEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\n	var texture_envAtlas: texture_2d<f32>;\n	var texture_envAtlasSampler: sampler;\n#endif\nuniform material_reflectivity: f32;\nfn shinyMipLevel(uv: vec2f) -> f32 {\n	let dx: vec2f = dpdx(uv);\n	let dy: vec2f = dpdy(uv);\n	let uv2: vec2f = vec2f(fract(uv.x + 0.5), uv.y);\n	let dx2: vec2f = dpdx(uv2);\n	let dy2: vec2f = dpdy(uv2);\n	let maxd: f32 = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));\n	return clamp(0.5 * log2(maxd) - 1.0 + uniform.textureBias, 0.0, 5.0);\n}\nfn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {\n	let dir: vec3f = cubeMapProject(reflDir) * vec3f(-1.0, 1.0, 1.0);\n	let uv: vec2f = toSphericalUv(dir);\n	let level: f32 = saturate(1.0 - gloss) * 5.0;\n	let ilevel: f32 = floor(level);\n	let level2: f32 = shinyMipLevel(uv * atlasSize);\n	let ilevel2: f32 = floor(level2);\n	var uv0: vec2f;\n	var uv1: vec2f;\n	var weight: f32;\n	if (ilevel == 0.0) {\n		uv0 = mapShinyUv(uv, ilevel2);\n		uv1 = mapShinyUv(uv, ilevel2 + 1.0);\n		weight = level2 - ilevel2;\n	} else {\n		uv0 = mapRoughnessUv(uv, ilevel);\n		uv1 = uv0;\n		weight = 0.0;\n	}\n	let linearA: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, uv0));\n	let linearB: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, uv1));\n	let linear0: vec3f = mix(linearA, linearB, weight);\n	let linear1: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, mapRoughnessUv(uv, ilevel + 1.0)));\n	return processEnvironment(mix(linear0, linear1, level - ilevel));\n}\nfn addReflection(reflDir: vec3f, gloss: f32) {\n	dReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);\n}\n",reflectionSpherePS:"\n#ifndef VIEWMATRIX\n	#define VIEWMATRIX\n	uniform matrix_view: mat4x4f;\n#endif\nvar texture_sphereMap: texture_2d<f32>;\nvar texture_sphereMapSampler: sampler;\nuniform material_reflectivity: f32;\nfn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {\n	let viewRotationMatrix = mat3x3f(uniform.matrix_view[0].xyz, uniform.matrix_view[1].xyz, uniform.matrix_view[2].xyz);\n	let reflDirV: vec3f = viewRotationMatrix * reflDir;\n	let m: f32 = 2.0 * sqrt(dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z + 1.0) * (reflDirV.z + 1.0));\n	let sphereMapUv: vec2f = reflDirV.xy / m + 0.5;\n	return {reflectionDecode}(textureSample(texture_sphereMap, texture_sphereMapSampler, sphereMapUv));\n}\nfn addReflection(reflDir: vec3f, gloss: f32) {\n	dReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);\n}\n",reflectionSheenPS:"\nfn addReflectionSheen(worldNormal: vec3f, viewDir: vec3f, gloss: f32) {\n	let NoV: f32 = dot(worldNormal, viewDir);\n	let alphaG: f32 = gloss * gloss;\n	let a: f32 = select(\n		-8.48 * alphaG + 14.3 * gloss - 9.95,\n		-339.2 * alphaG + 161.4 * gloss - 25.9,\n		gloss < 0.25\n	);\n	let b: f32 = select(\n		1.97 * alphaG - 3.27 * gloss + 0.72,\n		44.0 * alphaG - 23.7 * gloss + 3.26,\n		gloss < 0.25\n	);\n	let dg_add: f32 = select(\n		0.1 * ( gloss - 0.25 ),\n		0.0,\n		gloss < 0.25\n	);\n	let dg: f32 = exp( a * NoV + b ) + dg_add;\n	sReflection = sReflection + (calcReflection(worldNormal, 0.0) * saturate(dg));\n}",refractionCubePS:"\nfn refract2(viewVec: vec3f, normal: vec3f, IOR: f32) -> vec3f {\n	let vn: f32 = dot(viewVec, normal);\n	let k: f32 = 1.0 - IOR * IOR * (1.0 - vn * vn);\n	let refrVec: vec3f = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;\n	return refrVec;\n}\nfn addRefraction(\n	worldNormal: vec3f,\n	viewDir: vec3f,\n	thickness: f32,\n	gloss: f32,\n	specularity: vec3f,\n	albedo: vec3f,\n	transmission: f32,\n	refractionIndex: f32,\n	dispersion: f32\n#if defined(LIT_IRIDESCENCE)\n	, iridescenceFresnel: vec3f,\n	iridescenceIntensity: f32\n#endif\n) {\n	let tmpRefl: vec4f = dReflection;\n	let reflectionDir: vec3f = refract2(-viewDir, worldNormal, refractionIndex);\n	dReflection = vec4f(0.0);\n	addReflection(reflectionDir, gloss);\n	dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);\n	dReflection = tmpRefl;\n}\n",refractionDynamicPS:"\nuniform material_invAttenuationDistance: f32;\nuniform material_attenuation: vec3f;\nfn evalRefractionColor(refractionVector: vec3f, gloss: f32, refractionIndex: f32) -> vec3f {\n	let pointOfRefraction: vec4f = vec4f(vPositionW + refractionVector, 1.0);\n	let projectionPoint: vec4f = uniform.matrix_viewProjection * pointOfRefraction;\n	let uv: vec2f = getGrabScreenPos(projectionPoint);\n	let iorToRoughness: f32 = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);\n	let refractionLod: f32 = log2(uniform.uScreenSize.x) * iorToRoughness;\n	let refraction: vec3f = textureSampleLevel(uSceneColorMap, uSceneColorMapSampler, uv, refractionLod).rgb;\n	return refraction;\n}\nfn addRefraction(\n	worldNormal: vec3f,\n	viewDir: vec3f,\n	thickness: f32,\n	gloss: f32,\n	specularity: vec3f,\n	albedo: vec3f,\n	transmission: f32,\n	refractionIndex: f32,\n	dispersion: f32,\n#if defined(LIT_IRIDESCENCE)\n	iridescenceFresnel: vec3f,\n	iridescenceIntensity: f32\n#endif\n) {\n	var modelScale: vec3f;\n	modelScale.x = length(uniform.matrix_model[0].xyz);\n	modelScale.y = length(uniform.matrix_model[1].xyz);\n	modelScale.z = length(uniform.matrix_model[2].xyz);\n	let scale: vec3f = thickness * modelScale;\n	var refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * scale;\n	var refraction = evalRefractionColor(refractionVector, gloss, refractionIndex);\n	#ifdef LIT_DISPERSION\n		let halfSpread: f32 = (1.0 / refractionIndex - 1.0) * 0.025 * dispersion;\n		let refractionIndexR: f32 = refractionIndex - halfSpread;\n		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexR)) * scale;\n		refraction.r = evalRefractionColor(refractionVector, gloss, refractionIndexR).r;\n		let refractionIndexB: f32 = refractionIndex + halfSpread;\n		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexB)) * scale;\n		refraction.b = evalRefractionColor(refractionVector, gloss, refractionIndexB).b;\n	#endif\n	var transmittance: vec3f;\n	if (uniform.material_invAttenuationDistance != 0.0)\n	{\n		let attenuation: vec3f = -log(uniform.material_attenuation) * uniform.material_invAttenuationDistance;\n		transmittance = exp(-attenuation * length(refractionVector));\n	}\n	else\n	{\n		transmittance = refraction;\n	}\n	let fresnel: vec3f = vec3f(1.0) -\n		getFresnel(\n			dot(viewDir, worldNormal),\n			gloss,\n			specularity\n		#if defined(LIT_IRIDESCENCE)\n			, iridescenceFresnel,\n			iridescenceIntensity\n		#endif\n		);\n	dDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);\n}\n",reprojectPS:'\nvarying vUv0: vec2f;\n#ifdef CUBEMAP_SOURCE\n	var sourceCube: texture_cube<f32>;\n	var sourceCubeSampler : sampler;\n#else\n	var sourceTex: texture_2d<f32>;\n	var sourceTexSampler : sampler;\n#endif\n#ifdef USE_SAMPLES_TEX\n	var samplesTex: texture_2d<f32>;\n	var samplesTexSampler : sampler;\n	uniform samplesTexInverseSize: vec2f;\n#endif\nuniform params: vec3f;\nfn targetFace() -> f32 { return uniform.params.x; }\nfn targetTotalPixels() -> f32 { return uniform.params.y; }\nfn sourceTotalPixels() -> f32 { return uniform.params.z; }\nconst PI: f32 = 3.141592653589793;\nfn saturate(x: f32) -> f32 {\n	return clamp(x, 0.0, 1.0);\n}\n#include "decodePS"\n#include "encodePS"\nfn modifySeams(dir: vec3f, scale: f32) -> vec3f {\n	let adir = abs(dir);\n	let M = max(max(adir.x, adir.y), adir.z);\n	return dir / M * vec3f(\n		select(scale, 1.0, adir.x == M),\n		select(scale, 1.0, adir.y == M),\n		select(scale, 1.0, adir.z == M)\n	);\n}\nfn toSpherical(dir: vec3f) -> vec2f {\n	let nonZeroXZ = any(dir.xz != vec2f(0.0, 0.0));\n	return vec2f(select(0.0, atan2(dir.x, dir.z), nonZeroXZ), asin(dir.y));\n}\nfn fromSpherical(uv: vec2f) -> vec3f {\n	return vec3f(cos(uv.y) * sin(uv.x),\n				sin(uv.y),\n				cos(uv.y) * cos(uv.x));\n}\nfn getDirectionEquirect(uv: vec2f) -> vec3f {\n	return fromSpherical((vec2f(uv.x, 1.0 - uv.y) * 2.0 - 1.0) * vec2f(PI, PI * 0.5));\n}\nfn signNotZero(k: f32) -> f32 {\n	return select(-1.0, 1.0, k >= 0.0);\n}\nfn signNotZeroVec2(v: vec2f) -> vec2f {\n	return vec2f(signNotZero(v.x), signNotZero(v.y));\n}\nfn octDecode(o: vec2f) -> vec3f {\n	var v = vec3f(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n	if (v.y < 0.0) {\n		var temp: vec2f = (1.0 - abs(v.zx)) * signNotZeroVec2(v.xz);\n		v = vec3f(temp.x, v.y, temp.y);\n	}\n	return normalize(v);\n}\nfn getDirectionOctahedral(uv: vec2f) -> vec3f {\n	return octDecode(vec2f(uv.x, 1.0 - uv.y) * 2.0 - 1.0);\n}\nfn octEncode(v: vec3f) -> vec2f {\n	let l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n	var result = v.xz * (1.0 / l1norm);\n	if (v.y < 0.0) {\n		result = (1.0 - abs(result.yx)) * signNotZeroVec2(result.xy);\n	}\n	return result;\n}\n#ifdef CUBEMAP_SOURCE\n	fn sampleCubemapDir(dir: vec3f) -> vec4f {\n		return textureSample(sourceCube, sourceCubeSampler, modifySeams(dir, 1.0));\n	}\n	fn sampleCubemapSph(sph: vec2f) -> vec4f {\n		return sampleCubemapDir(fromSpherical(sph));\n	}\n	fn sampleCubemapDirLod(dir: vec3f, mipLevel: f32) -> vec4f {\n		return textureSampleLevel(sourceCube, sourceCubeSampler, modifySeams(dir, 1.0), mipLevel);\n	}\n	fn sampleCubemapSphLod(sph: vec2f, mipLevel: f32) -> vec4f {\n		return sampleCubemapDirLod(fromSpherical(sph), mipLevel);\n	}\n#else\n	fn sampleEquirectSph(sph: vec2f) -> vec4f {\n		let uv = sph / vec2f(PI * 2.0, PI) + 0.5;\n		return textureSample(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y));\n	}\n	fn sampleEquirectDir(dir: vec3f) -> vec4f {\n		return sampleEquirectSph(toSpherical(dir));\n	}\n	fn sampleEquirectSphLod(sph: vec2f, mipLevel: f32) -> vec4f {\n		let uv = sph / vec2f(PI * 2.0, PI) + 0.5;\n		return textureSampleLevel(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y), mipLevel);\n	}\n	fn sampleEquirectDirLod(dir: vec3f, mipLevel: f32) -> vec4f {\n		return sampleEquirectSphLod(toSpherical(dir), mipLevel);\n	}\n	fn sampleOctahedralDir(dir: vec3f) -> vec4f {\n		let uv = octEncode(dir) * 0.5 + 0.5;\n		return textureSample(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y));\n	}\n	fn sampleOctahedralSph(sph: vec2f) -> vec4f {\n		return sampleOctahedralDir(fromSpherical(sph));\n	}\n	fn sampleOctahedralDirLod(dir: vec3f, mipLevel: f32) -> vec4f {\n		let uv = octEncode(dir) * 0.5 + 0.5;\n		return textureSampleLevel(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y), mipLevel);\n	}\n	fn sampleOctahedralSphLod(sph: vec2f, mipLevel: f32) -> vec4f {\n		return sampleOctahedralDirLod(fromSpherical(sph), mipLevel);\n	}\n#endif\nfn getDirectionCubemap(uv: vec2f) -> vec3f {\n	let st = uv * 2.0 - 1.0;\n	let face = targetFace();\n	var vec: vec3f;\n	if (face == 0.0) {\n		vec = vec3f(1, -st.y, -st.x);\n	} else if (face == 1.0) {\n		vec = vec3f(-1, -st.y, st.x);\n	} else if (face == 2.0) {\n		vec = vec3f(st.x, 1, st.y);\n	} else if (face == 3.0) {\n		vec = vec3f(st.x, -1, -st.y);\n	} else if (face == 4.0) {\n		vec = vec3f(st.x, -st.y, 1);\n	} else {\n		vec = vec3f(-st.x, -st.y, -1);\n	}\n	return normalize(modifySeams(vec, 1.0));\n}\nfn matrixFromVector(n: vec3f) -> mat3x3f {\n	let a = 1.0 / (1.0 + n.z);\n	let b = -n.x * n.y * a;\n	let b1 = vec3f(1.0 - n.x * n.x * a, b, -n.x);\n	let b2 = vec3f(b, 1.0 - n.y * n.y * a, -n.y);\n	return mat3x3f(b1, b2, n);\n}\nfn matrixFromVectorSlow(n: vec3f) -> mat3x3f {\n	let up = select(vec3f(0.0, 0.0, select(-1.0, 1.0, n.y > 0.0)), vec3f(0.0, 1.0, 0.0), abs(n.y) > 0.0000001);\n	let x = normalize(cross(up, n));\n	let y = cross(n, x);\n	return mat3x3f(x, y, n);\n}\nfn reproject(uv: vec2f) -> vec4f {\n	if ({NUM_SAMPLES} <= 1) {\n		return {ENCODE_FUNC}({DECODE_FUNC}({SOURCE_FUNC}Dir({TARGET_FUNC}(uv))));\n	} else {\n		let t = {TARGET_FUNC}(uv);\n		let tu = dpdx(t);\n		let tv = dpdy(t);\n		var result = vec3f(0.0);\n		for (var u = 0.0; u < {NUM_SAMPLES_SQRT}; u += 1.0) {\n			for (var v = 0.0; v < {NUM_SAMPLES_SQRT}; v += 1.0) {\n				result += {DECODE_FUNC}({SOURCE_FUNC}Dir(normalize(t +\n															tu * (u / {NUM_SAMPLES_SQRT} - 0.5) +\n															tv * (v / {NUM_SAMPLES_SQRT} - 0.5))));\n			}\n		}\n		return {ENCODE_FUNC}(result / ({NUM_SAMPLES_SQRT} * {NUM_SAMPLES_SQRT}));\n	}\n}\nconst unpackFloat: vec4f = vec4f(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);\n#ifdef USE_SAMPLES_TEX\n	fn unpackSample(i: i32, L: ptr<function, vec3f>, mipLevel: ptr<function, f32>) {\n		var u = (f32(i * 4) + 0.5) * uniform.samplesTexInverseSize.x;\n		var v = (floor(u) + 0.5) * uniform.samplesTexInverseSize.y;\n		var raw: vec4f;\n		raw.x = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;\n		raw.y = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;\n		raw.z = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;\n		raw.w = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat);\n		*L = raw.xyz * 2.0 - 1.0;\n		*mipLevel = raw.w * 8.0;\n	}\n	fn prefilterSamples(uv: vec2f) -> vec4f {\n		let vecSpace = matrixFromVectorSlow({TARGET_FUNC}(uv));\n		var L: vec3f;\n		var mipLevel: f32;\n		var result = vec3f(0.0);\n		var totalWeight = 0.0;\n		for (var i = 0; i < {NUM_SAMPLES}; i += 1) {\n			unpackSample(i, &L, &mipLevel);\n			result += {DECODE_FUNC}({SOURCE_FUNC}DirLod(vecSpace * L, mipLevel)) * L.z;\n			totalWeight += L.z;\n		}\n		return {ENCODE_FUNC}(result / totalWeight);\n	}\n	fn prefilterSamplesUnweighted(uv: vec2f) -> vec4f {\n		let vecSpace = matrixFromVectorSlow({TARGET_FUNC}(uv));\n		var L: vec3f;\n		var mipLevel: f32;\n		var result = vec3f(0.0);\n		for (var i = 0; i < {NUM_SAMPLES}; i += 1) {\n			unpackSample(i, &L, &mipLevel);\n			result += {DECODE_FUNC}({SOURCE_FUNC}DirLod(vecSpace * L, mipLevel));\n		}\n		return {ENCODE_FUNC}(result / f32({NUM_SAMPLES}));\n	}\n#endif\n@fragment\nfn fragmentMain(input : FragmentInput) -> FragmentOutput {\n	var output: FragmentOutput;\n	output.color = {PROCESS_FUNC}(input.vUv0);\n	return output;\n}\n',reprojectVS:"\nattribute vertex_position: vec2f;\nuniform uvMod: vec4f;\nvarying vUv0: vec2f;\n@vertex\nfn vertexMain(input: VertexInput) -> VertexOutput {\n  var output: VertexOutput;\n  output.position = vec4f(input.vertex_position, 0.5, 1.0);\n  output.vUv0 = getImageEffectUV((input.vertex_position * 0.5 + vec2f(0.5, 0.5)) * uniform.uvMod.xy + uniform.uvMod.zw);\n  return output;\n}\n",screenDepthPS:"\nvar uSceneDepthMap: texture_2d<f32>;\nvar uSceneDepthMapSampler: sampler;\n#ifndef SCREENSIZE\n	#define SCREENSIZE\n	uniform uScreenSize: vec4f;\n#endif\n#ifndef VIEWMATRIX\n	#define VIEWMATRIX\n	uniform matrix_view: mat4x4f;\n#endif\n#ifndef LINEARIZE_DEPTH\n	#define LINEARIZE_DEPTH\n	#ifndef CAMERAPLANES\n		#define CAMERAPLANES\n		uniform camera_params: vec4f;\n	#endif\n	fn linearizeDepth(z: f32) -> f32 {\n		if (uniform.camera_params.w == 0.0) {\n			return (uniform.camera_params.z * uniform.camera_params.y) / (uniform.camera_params.y + z * (uniform.camera_params.z - uniform.camera_params.y));\n		} else {\n			return uniform.camera_params.z + z * (uniform.camera_params.y - uniform.camera_params.z);\n		}\n	}\n#endif\nfn delinearizeDepth(linearDepth: f32) -> f32 {\n	if (uniform.camera_params.w == 0.0) {\n		return (uniform.camera_params.y * (uniform.camera_params.z - linearDepth)) / (linearDepth * (uniform.camera_params.z - uniform.camera_params.y));\n	} else {\n		return (linearDepth - uniform.camera_params.z) / (uniform.camera_params.y - uniform.camera_params.z);\n	}\n}\nfn getLinearScreenDepth(uv: vec2f) -> f32 {\n	#ifdef SCENE_DEPTHMAP_LINEAR\n		#ifdef SCENE_DEPTHMAP_FLOAT\n			return textureSample(uSceneDepthMap, uSceneDepthMapSampler, uv).r;\n		#else\n			let textureSize = textureDimensions(uSceneDepthMap, 0);\n			let texel: vec2i = vec2i(uv * vec2f(textureSize));\n			let data: vec4f = textureLoad(uSceneDepthMap, texel, 0);\n			let data_u32: vec4u = vec4u(data * 255.0);\n			let intBits: u32 = (data_u32.r << 24u) | (data_u32.g << 16u) | (data_u32.b << 8u) | data_u32.a;\n			return bitcast<f32>(intBits);\n		#endif\n	#else\n		return linearizeDepth(textureSample(uSceneDepthMap, uSceneDepthMapSampler, uv).r);\n	#endif\n}\n#ifndef VERTEXSHADER\n	fn getLinearScreenDepthFrag() -> f32 {\n		let uv: vec2f = pcPosition.xy * uniform.uScreenSize.zw;\n		return getLinearScreenDepth(uv);\n	}\n#endif\nfn getLinearDepth(pos: vec3f) -> f32 {\n	return -(uniform.matrix_view * vec4f(pos, 1.0)).z;\n}\n",shadowCascadesPS:"\nfn getShadowCascadeIndex(shadowCascadeDistances: vec4f, shadowCascadeCount: i32) -> i32 {\n	let depth: f32 = 1.0 / pcPosition.w;\n	let comparisons: vec4f = step(shadowCascadeDistances, vec4f(depth));\n	let cascadeIndex: i32 = i32(dot(comparisons, vec4f(1.0)));\n	return min(cascadeIndex, shadowCascadeCount - 1);\n}\nfn ditherShadowCascadeIndex(cascadeIndex_in: i32, shadowCascadeDistances: vec4f, shadowCascadeCount: i32, blendFactor: f32) -> i32 {\n	var cascadeIndex: i32 = cascadeIndex_in;\n	if (cascadeIndex < shadowCascadeCount - 1) {\n		let currentRangeEnd: f32 = shadowCascadeDistances[cascadeIndex];\n		let transitionStart: f32 = blendFactor * currentRangeEnd;\n		let depth: f32 = 1.0 / pcPosition.w;\n		if (depth > transitionStart) {\n			let transitionFactor: f32 = smoothstep(transitionStart, currentRangeEnd, depth);\n			let dither: f32 = fract(sin(dot(pcPosition.xy, vec2f(12.9898, 78.233))) * 43758.5453);\n			if (dither < transitionFactor) {\n				cascadeIndex = cascadeIndex + 1;\n			}\n		}\n	}\n	return cascadeIndex;\n}\nfn fadeShadow(shadowCoord_in: vec3f, shadowCascadeDistances: vec4f) -> vec3f {\n	var shadowCoord: vec3f = shadowCoord_in;\n	let depth: f32 = 1.0 / pcPosition.w;\n	if (depth > shadowCascadeDistances.w) {\n		shadowCoord.z = -9999999.0;\n	}\n	return shadowCoord;\n}\n",shadowEVSMPS:"\nfn linstep(a: f32, b: f32, v: f32) -> f32 {\n	return clamp((v - a) / (b - a), 0.0, 1.0);\n}\nfn reduceLightBleeding(pMax: f32, amount: f32) -> f32 {\n   return linstep(amount, 1.0, pMax);\n}\nfn chebyshevUpperBound(moments: vec2f, mean: f32, minVariance: f32, lightBleedingReduction: f32) -> f32 {\n	var variance: f32 = moments.y - (moments.x * moments.x);\n	variance = max(variance, minVariance);\n	let d: f32 = mean - moments.x;\n	var pMax: f32 = variance / (variance + (d * d));\n	pMax = reduceLightBleeding(pMax, lightBleedingReduction);\n	return select(pMax, 1.0, mean <= moments.x);\n}\nfn calculateEVSM(moments_in: vec3f, Z_in: f32, vsmBias: f32, exponent: f32) -> f32 {\n	let Z: f32 = 2.0 * Z_in - 1.0;\n	let warpedDepth: f32 = exp(exponent * Z);\n	let moments: vec2f = moments_in.xy + vec2f(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments_in.z);\n	let VSMBias: f32 = vsmBias;\n	let depthScale: f32 = VSMBias * exponent * warpedDepth;\n	let minVariance1: f32 = depthScale * depthScale;\n	return chebyshevUpperBound(moments, warpedDepth, minVariance1, 0.1);\n}\nfn VSM16(tex: texture_2d<f32>, texSampler: sampler, texCoords: vec2f, resolution: f32, Z: f32, vsmBias: f32, exponent: f32) -> f32 {\n	let moments: vec3f = textureSampleLevel(tex, texSampler, texCoords, 0.0).xyz;\n	return calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfn getShadowVSM16(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32) -> f32 {\n	return VSM16(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfn getShadowSpotVSM16(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32, lightDir: vec3f) -> f32 {\n	let Z: f32 = length(lightDir) * shadowParams.w + shadowParams.z;\n	return VSM16(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, Z, shadowParams.y, exponent);\n}\nfn VSM32(tex: texture_2d<f32>, texSampler: sampler, texCoords_in: vec2f, resolution: f32, Z: f32, vsmBias: f32, exponent: f32) -> f32 {\n	#ifdef CAPS_TEXTURE_FLOAT_FILTERABLE\n		var moments: vec3f = textureSampleLevel(tex, texSampler, texCoords_in, 0.0).xyz;\n	#else\n		var pixelSize : f32 = 1.0 / resolution;\n		let texCoords: vec2f = texCoords_in - vec2f(pixelSize);\n		let s00: vec3f = textureSampleLevel(tex, texSampler, texCoords, 0.0).xyz;\n		let s10: vec3f = textureSampleLevel(tex, texSampler, texCoords + vec2f(pixelSize, 0.0), 0.0).xyz;\n		let s01: vec3f = textureSampleLevel(tex, texSampler, texCoords + vec2f(0.0, pixelSize), 0.0).xyz;\n		let s11: vec3f = textureSampleLevel(tex, texSampler, texCoords + vec2f(pixelSize), 0.0).xyz;\n		let fr: vec2f = fract(texCoords * resolution);\n		let h0: vec3f = mix(s00, s10, fr.x);\n		let h1: vec3f = mix(s01, s11, fr.x);\n		var moments: vec3f = mix(h0, h1, fr.y);\n	#endif\n	return calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfn getShadowVSM32(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32) -> f32 {\n	return VSM32(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfn getShadowSpotVSM32(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32, lightDir: vec3f) -> f32 {\n	let Z: f32 = length(lightDir) * shadowParams.w + shadowParams.z;\n	return VSM32(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, Z, shadowParams.y, exponent);\n}\n",shadowPCF1PS:"\nfn getShadowPCF1x1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n	return textureSampleCompareLevel(shadowMap, shadowMapSampler, shadowCoord.xy, shadowCoord.z);\n}\nfn getShadowSpotPCF1x1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n	return textureSampleCompareLevel(shadowMap, shadowMapSampler, shadowCoord.xy, shadowCoord.z);\n}\n",shadowPCF3PS:"\nfn _getShadowPCF3x3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec3f) -> f32 {\n	let z: f32 = shadowCoord.z;\n	let uv: vec2f = shadowCoord.xy * shadowParams.x;\n	let shadowMapSizeInv: f32 = 1.0 / shadowParams.x;\n	let base_uv_temp: vec2f = floor(uv + 0.5);\n	let s: f32 = (uv.x + 0.5 - base_uv_temp.x);\n	let t: f32 = (uv.y + 0.5 - base_uv_temp.y);\n	let base_uv: vec2f = (base_uv_temp - vec2f(0.5)) * shadowMapSizeInv;\n	var sum: f32 = 0.0;\n	let uw0: f32 = (3.0 - 2.0 * s);\n	let uw1: f32 = (1.0 + 2.0 * s);\n	let u0_offset: f32 = (2.0 - s) / uw0 - 1.0;\n	let u1_offset: f32 = s / uw1 + 1.0;\n	let vw0: f32 = (3.0 - 2.0 * t);\n	let vw1: f32 = (1.0 + 2.0 * t);\n	let v0_offset: f32 = (2.0 - t) / vw0 - 1.0;\n	let v1_offset: f32 = t / vw1 + 1.0;\n	let u0: f32 = u0_offset * shadowMapSizeInv + base_uv.x;\n	let v0: f32 = v0_offset * shadowMapSizeInv + base_uv.y;\n	let u1: f32 = u1_offset * shadowMapSizeInv + base_uv.x;\n	let v1: f32 = v1_offset * shadowMapSizeInv + base_uv.y;\n	sum = sum + uw0 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v0), z);\n	sum = sum + uw1 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v0), z);\n	sum = sum + uw0 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v1), z);\n	sum = sum + uw1 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v1), z);\n	sum = sum * (1.0 / 16.0);\n	return sum;\n}\nfn getShadowPCF3x3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n	return _getShadowPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);\n}\nfn getShadowSpotPCF3x3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n	return _getShadowPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);\n}\n",shadowPCF5PS:"\nfn _getShadowPCF5x5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec3f) -> f32 {\n	let z: f32 = shadowCoord.z;\n	let uv: vec2f = shadowCoord.xy * shadowParams.x;\n	let shadowMapSizeInv: f32 = 1.0 / shadowParams.x;\n	let base_uv_temp: vec2f = floor(uv + 0.5);\n	let s: f32 = (uv.x + 0.5 - base_uv_temp.x);\n	let t: f32 = (uv.y + 0.5 - base_uv_temp.y);\n	let base_uv: vec2f = (base_uv_temp - vec2f(0.5)) * shadowMapSizeInv;\n	let uw0: f32 = (4.0 - 3.0 * s);\n	let uw1: f32 = 7.0;\n	let uw2: f32 = (1.0 + 3.0 * s);\n	let u0_offset: f32 = (3.0 - 2.0 * s) / uw0 - 2.0;\n	let u1_offset: f32 = (3.0 + s) / uw1;\n	let u2_offset: f32 = s / uw2 + 2.0;\n	let vw0: f32 = (4.0 - 3.0 * t);\n	let vw1: f32 = 7.0;\n	let vw2: f32 = (1.0 + 3.0 * t);\n	let v0_offset: f32 = (3.0 - 2.0 * t) / vw0 - 2.0;\n	let v1_offset: f32 = (3.0 + t) / vw1;\n	let v2_offset: f32 = t / vw2 + 2.0;\n	var sum: f32 = 0.0;\n	let u0: f32 = u0_offset * shadowMapSizeInv + base_uv.x;\n	let v0: f32 = v0_offset * shadowMapSizeInv + base_uv.y;\n	let u1: f32 = u1_offset * shadowMapSizeInv + base_uv.x;\n	let v1: f32 = v1_offset * shadowMapSizeInv + base_uv.y;\n	let u2: f32 = u2_offset * shadowMapSizeInv + base_uv.x;\n	let v2: f32 = v2_offset * shadowMapSizeInv + base_uv.y;\n	sum = sum + uw0 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v0), z);\n	sum = sum + uw1 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v0), z);\n	sum = sum + uw2 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u2, v0), z);\n	sum = sum + uw0 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v1), z);\n	sum = sum + uw1 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v1), z);\n	sum = sum + uw2 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u2, v1), z);\n	sum = sum + uw0 * vw2 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v2), z);\n	sum = sum + uw1 * vw2 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v2), z);\n	sum = sum + uw2 * vw2 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u2, v2), z);\n	sum = sum * (1.0 / 144.0);\n	sum = saturate(sum);\n	return sum;\n}\nfn getShadowPCF5x5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n	return _getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);\n}\nfn getShadowSpotPCF5x5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n	return _getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);\n}\n",shadowSoftPS:"\nfn fractSinRand(uv: vec2f) -> f32 {\n	let PI: f32 = 3.141592653589793;\n	let a: f32 = 12.9898; let b: f32 = 78.233; let c: f32 = 43758.5453;\n	let dt: f32 = dot(uv.xy, vec2f(a, b));\n	let sn: f32 = dt % PI;\n	return fract(sin(sn) * c);\n}\nstruct VogelDiskData {\n	invNumSamples: f32,\n	initialAngle: f32,\n	currentPointId: f32,\n}\nfn prepareDiskConstants(data: ptr<function, VogelDiskData>, sampleCount: i32, randomSeed: f32) {\n	let pi2: f32 = 6.28318530718;\n	data.invNumSamples = 1.0 / f32(sampleCount);\n	data.initialAngle = randomSeed * pi2;\n	data.currentPointId = 0.0;\n}\nfn generateDiskSample(data: ptr<function, VogelDiskData>) -> vec2f {\n	let GOLDEN_ANGLE: f32 = 2.399963;\n	let r: f32 = sqrt((data.currentPointId + 0.5) * data.invNumSamples);\n	let theta: f32 = data.currentPointId * GOLDEN_ANGLE + data.initialAngle;\n	let offset: vec2f = vec2f(cos(theta), sin(theta)) * pow(r, 1.33);\n	data.currentPointId = data.currentPointId + 1.0;\n	return offset;\n}\nfn PCSSFindBlocker(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, avgBlockerDepth: ptr<function, f32>, numBlockers: ptr<function, i32>,\n	shadowCoords: vec2f, z: f32, shadowBlockerSamples: i32, penumbraSize: f32, invShadowMapSize: f32, randomSeed: f32) {\n	var diskData: VogelDiskData;\n	prepareDiskConstants(&diskData, shadowBlockerSamples, randomSeed);\n	let searchWidth: f32 = penumbraSize * invShadowMapSize;\n	var blockerSum: f32 = 0.0;\n	var numBlockers_local: i32 = 0;\n	for( var i: i32 = 0; i < shadowBlockerSamples; i = i + 1 ) {\n		let diskUV: vec2f = generateDiskSample(&diskData);\n		let sampleUV: vec2f = shadowCoords + diskUV * searchWidth;\n		let shadowMapDepth: f32 = textureSampleLevel(shadowMap, shadowMapSampler, sampleUV, 0.0).r;\n		if ( shadowMapDepth < z ) {\n			blockerSum = blockerSum + shadowMapDepth;\n			numBlockers_local = numBlockers_local + 1;\n		}\n	}\n	*avgBlockerDepth = blockerSum / f32(numBlockers_local);\n	*numBlockers = numBlockers_local;\n}\nfn PCSSFilter(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, uv: vec2f, receiverDepth: f32, shadowSamples: i32, filterRadius: f32, randomSeed: f32) -> f32 {\n	var diskData: VogelDiskData;\n	prepareDiskConstants(&diskData, shadowSamples, randomSeed);\n	var sum: f32 = 0.0;\n	for (var i: i32 = 0; i < shadowSamples; i = i + 1) {\n		let offsetUV: vec2f = generateDiskSample(&diskData) * filterRadius;\n		let depth: f32 = textureSampleLevel(shadowMap, shadowMapSampler, uv + offsetUV, 0.0).r;\n		sum = sum + step(receiverDepth, depth);\n	}\n	return sum / f32(shadowSamples);\n}\nfn getPenumbra(dblocker: f32, dreceiver: f32, penumbraSize: f32, penumbraFalloff: f32) -> f32 {\n	let dist: f32 = dreceiver - dblocker;\n	let penumbra: f32 = 1.0 - pow(1.0 - dist, penumbraFalloff);\n	return penumbra * penumbraSize;\n}\nfn PCSSDirectional(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoords: vec3f, cameraParams: vec4f, softShadowParams: vec4f) -> f32 {\n	let receiverDepth: f32 = shadowCoords.z;\n	let randomSeed: f32 = fractSinRand(pcPosition.xy);\n	let shadowSamples: i32 = i32(softShadowParams.x);\n	let shadowBlockerSamples: i32 = i32(softShadowParams.y);\n	let penumbraSize: f32 = softShadowParams.z;\n	let penumbraFalloff: f32 = softShadowParams.w;\n	let shadowMapSize: i32 = i32(textureDimensions(shadowMap, 0).x);\n	var invShadowMapSize: f32 = 1.0 / f32(shadowMapSize);\n	invShadowMapSize = invShadowMapSize * (f32(shadowMapSize) / 2048.0);\n	var penumbra: f32;\n	if (shadowBlockerSamples > 0) {\n		var avgBlockerDepth: f32 = 0.0;\n		var numBlockers: i32 = 0;\n		PCSSFindBlocker(shadowMap, shadowMapSampler, &avgBlockerDepth, &numBlockers, shadowCoords.xy, receiverDepth, shadowBlockerSamples, penumbraSize, invShadowMapSize, randomSeed);\n		if (numBlockers < 1) {\n			return 1.0;\n		}\n		penumbra = getPenumbra(avgBlockerDepth, shadowCoords.z, penumbraSize, penumbraFalloff);\n	} else {\n		penumbra = penumbraSize;\n	}\n	let filterRadius: f32 = penumbra * invShadowMapSize;\n	return PCSSFilter(shadowMap, shadowMapSampler, shadowCoords.xy, receiverDepth, shadowSamples, filterRadius, randomSeed);\n}\nfn getShadowPCSS(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, cameraParams: vec4f, softShadowParams: vec4f, lightDir: vec3f) -> f32 {\n	return PCSSDirectional(shadowMap, shadowMapSampler, shadowCoord, cameraParams, softShadowParams);\n}\n",skinBatchVS:"\nattribute vertex_boneIndices: f32;\nvar texture_poseMap: texture_2d<f32>;\nfn getBoneMatrix(indexFloat: f32) -> mat4x4f {\n	let width = i32(textureDimensions(texture_poseMap).x);\n	let index: i32 = i32(indexFloat + 0.5) * 3;\n	let iy: i32 = index / width;\n	let ix: i32 = index % width;\n	let v1: vec4f = textureLoad(texture_poseMap, vec2i(ix + 0, iy), 0);\n	let v2: vec4f = textureLoad(texture_poseMap, vec2i(ix + 1, iy), 0);\n	let v3: vec4f = textureLoad(texture_poseMap, vec2i(ix + 2, iy), 0);\n	return mat4x4f(\n		v1.x, v2.x, v3.x, 0,\n		v1.y, v2.y, v3.y, 0,\n		v1.z, v2.z, v3.z, 0,\n		v1.w, v2.w, v3.w, 1.0\n	);\n}\n",skinVS:"\nattribute vertex_boneWeights: vec4f;\nattribute vertex_boneIndices: vec4f;\nvar texture_poseMap: texture_2d<f32>;\nstruct BoneMatrix {\n	v1: vec4f,\n	v2: vec4f,\n	v3: vec4f,\n}\nfn getBoneMatrix(width: i32, index: i32) -> BoneMatrix {\n	let v = index / width;\n	let u = index % width;\n	var result: BoneMatrix;\n	result.v1 = textureLoad(texture_poseMap, vec2i(u + 0, v), 0);\n	result.v2 = textureLoad(texture_poseMap, vec2i(u + 1, v), 0);\n	result.v3 = textureLoad(texture_poseMap, vec2i(u + 2, v), 0);\n	return result;\n}\nfn getSkinMatrix(indicesFloat: vec4f, weights: vec4f) -> mat4x4f {\n	let width = i32(textureDimensions(texture_poseMap).x);\n	var indices = vec4i(indicesFloat + 0.5) * 3;\n	let boneA = getBoneMatrix(width, indices.x);\n	let boneB = getBoneMatrix(width, indices.y);\n	let boneC = getBoneMatrix(width, indices.z);\n	let boneD = getBoneMatrix(width, indices.w);\n	let v1 = boneA.v1 * weights.x + boneB.v1 * weights.y + boneC.v1 * weights.z + boneD.v1 * weights.w;\n	let v2 = boneA.v2 * weights.x + boneB.v2 * weights.y + boneC.v2 * weights.z + boneD.v2 * weights.w;\n	let v3 = boneA.v3 * weights.x + boneB.v3 * weights.y + boneC.v3 * weights.z + boneD.v3 * weights.w;\n	let one = dot(weights, vec4f(1.0, 1.0, 1.0, 1.0));\n	return mat4x4f(\n		v1.x, v2.x, v3.x, 0,\n		v1.y, v2.y, v3.y, 0,\n		v1.z, v2.z, v3.z, 0,\n		v1.w, v2.w, v3.w, one\n	);\n}\n",skyboxPS:'\n	#define LIT_SKYBOX_INTENSITY\n	#include "envProcPS"\n	#include "gammaPS"\n	#include "tonemappingPS"\n	#ifdef PREPASS_PASS\n		varying vLinearDepth: f32;\n		#include "floatAsUintPS"\n	#endif\n	varying vViewDir : vec3f;\n	uniform skyboxHighlightMultiplier : f32;\n	#ifdef SKY_CUBEMAP\n		var texture_cubeMap : texture_cube<f32>;\n		var texture_cubeMap_sampler : sampler;\n		#ifdef SKYMESH\n			varying vWorldPos : vec3f;\n			uniform cubeMapRotationMatrix : mat3x3f;\n			uniform projectedSkydomeCenter : vec3f;\n		#endif\n	#else\n		#include "sphericalPS"\n		#include "envAtlasPS"\n		var texture_envAtlas : texture_2d<f32>;\n		var texture_envAtlas_sampler : sampler;\n		uniform mipLevel : f32;\n	#endif\n	@fragment\n	fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n		var output: FragmentOutput;\n		#ifdef PREPASS_PASS\n			output.color = float2vec4(vLinearDepth);\n		#else\n			var linear : vec3f;\n			var dir : vec3f;\n			#ifdef SKY_CUBEMAP\n				#ifdef SKYMESH\n					var envDir : vec3f = normalize(input.vWorldPos - uniform.projectedSkydomeCenter);\n					dir = envDir * uniform.cubeMapRotationMatrix;\n				#else\n					dir = input.vViewDir;\n				#endif\n				dir.x *= -1.0;\n				linear = {SKYBOX_DECODE_FNC}(textureSample(texture_cubeMap, texture_cubeMap_sampler, dir));\n			#else\n				dir = input.vViewDir * vec3f(-1.0, 1.0, 1.0);\n				let uv : vec2f = toSphericalUv(normalize(dir));\n				linear = {SKYBOX_DECODE_FNC}(textureSample(texture_envAtlas, texture_envAtlas_sampler, mapRoughnessUv(uv, uniform.mipLevel)));\n			#endif\n			if (any(linear >= vec3f(64.0))) {\n				linear *= uniform.skyboxHighlightMultiplier;\n			}\n			\n			output.color = vec4f(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n		#endif\n		return output;\n	}\n',skyboxVS:"\n	attribute aPosition : vec4f;\n	uniform matrix_view : mat4x4f;\n	uniform matrix_projectionSkybox : mat4x4f;\n	uniform cubeMapRotationMatrix : mat3x3f;\n	varying vViewDir : vec3f;\n	#ifdef PREPASS_PASS\n		varying vLinearDepth: f32;\n	#endif\n	#ifdef SKYMESH\n		uniform matrix_model : mat4x4f;\n		varying vWorldPos : vec3f;\n	#endif\n	@vertex\n	fn vertexMain(input : VertexInput) -> VertexOutput {\n		var output : VertexOutput;\n		var view : mat4x4f = uniform.matrix_view;\n		#ifdef SKYMESH\n			var worldPos : vec4f = uniform.matrix_model * input.aPosition;\n			output.vWorldPos = worldPos.xyz;\n			output.position = uniform.matrix_projectionSkybox * (view * worldPos);\n			#ifdef PREPASS_PASS\n				output.vLinearDepth = -(uniform.matrix_view * vec4f(worldPos.xyz, 1.0)).z;\n			#endif\n		#else\n			view[3][0] = 0.0;\n			view[3][1] = 0.0;\n			view[3][2] = 0.0;\n			output.position = uniform.matrix_projectionSkybox * (view * input.aPosition);\n			output.vViewDir = input.aPosition.xyz * uniform.cubeMapRotationMatrix;\n			#ifdef PREPASS_PASS\n				output.vLinearDepth = -pcPosition.w;\n			#endif\n		#endif\n		output.position.z = output.position.w - 1.0e-7;\n		return output;\n	}\n",specularPS:"\n#ifdef STD_SPECULAR_CONSTANT\n	uniform material_specular: vec3f;\n#endif\nfn getSpecularity() {\n	var specularColor = vec3f(1.0, 1.0, 1.0);\n	#ifdef STD_SPECULAR_CONSTANT\n	specularColor = specularColor * uniform.material_specular;\n	#endif\n	#ifdef STD_SPECULAR_TEXTURE\n	specularColor = specularColor * {STD_SPECULAR_TEXTURE_DECODE}(textureSampleBias({STD_SPECULAR_TEXTURE_NAME}, {STD_SPECULAR_TEXTURE_NAME}Sampler, {STD_SPECULAR_TEXTURE_UV}, uniform.textureBias)).{STD_SPECULAR_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_SPECULAR_VERTEX\n	specularColor = specularColor * saturate3(vVertexColor.{STD_SPECULAR_VERTEX_CHANNEL});\n	#endif\n	dSpecularity = specularColor;\n}\n",sphericalPS:"\nfn toSpherical(dir: vec3f) -> vec2f {\n	let angle_xz = select(0.0, atan2(dir.x, dir.z), any(dir.xz != vec2f(0.0)));\n	return vec2f(angle_xz, asin(dir.y));\n}\nfn toSphericalUv(dir : vec3f) -> vec2f {\n	const PI : f32 = 3.141592653589793;\n	let uv : vec2f = toSpherical(dir) / vec2f(PI * 2.0, PI) + vec2f(0.5, 0.5);\n	return vec2f(uv.x, 1.0 - uv.y);\n}\n",specularityFactorPS:"\n#ifdef STD_SPECULARITYFACTOR_CONSTANT\n	uniform material_specularityFactor: f32;\n#endif\nfn getSpecularityFactor() {\n	var specularityFactor = 1.0;\n	#ifdef STD_SPECULARITYFACTOR_CONSTANT\n	specularityFactor = specularityFactor * uniform.material_specularityFactor;\n	#endif\n	#ifdef STD_SPECULARITYFACTOR_TEXTURE\n	specularityFactor = specularityFactor * textureSampleBias({STD_SPECULARITYFACTOR_TEXTURE_NAME}, {STD_SPECULARITYFACTOR_TEXTURE_NAME}Sampler, {STD_SPECULARITYFACTOR_TEXTURE_UV}, uniform.textureBias).{STD_SPECULARITYFACTOR_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_SPECULARITYFACTOR_VERTEX\n	specularityFactor = specularityFactor * saturate(vVertexColor.{STD_SPECULARITYFACTOR_VERTEX_CHANNEL});\n	#endif\n	dSpecularityFactor = specularityFactor;\n}\n",spotPS:"\nfn getSpotEffect(lightSpotDir: vec3f, lightInnerConeAngle: f32, lightOuterConeAngle: f32, lightDirNorm: vec3f) -> f32 {\n	let cosAngle: f32 = dot(lightDirNorm, lightSpotDir);\n	return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}",startNineSlicedPS:"\n	nineSlicedUv = vec2f(vUv0.x, 1.0 - vUv0.y);\n",startNineSlicedTiledPS:"\n	let tileMask: vec2f = step(vMask, vec2f(0.99999));\n	let tileSize: vec2f = 0.5 * (innerOffset.xy + innerOffset.zw);\n	let tileScale: vec2f = vec2f(1.0) / (vec2f(1.0) - tileSize);\n	var clampedUv: vec2f = mix(innerOffset.xy * 0.5, vec2f(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n	clampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n	var nineSlicedUv: vec2f = vUv0 * tileMask + clampedUv * (vec2f(1.0) - tileMask);\n	nineSlicedUv.y = 1.0 - nineSlicedUv.y;\n",stdDeclarationPS:'\n	var<private> dAlpha: f32 = 1.0;\n	#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n		#ifdef STD_OPACITY_TEXTURE_ALLOCATE\n			var texture_opacityMap : texture_2d<f32>;\n			var texture_opacityMapSampler : sampler;\n		#endif\n	#endif\n	#ifdef FORWARD_PASS\n		var<private> dAlbedo: vec3f;\n		var<private> dNormalW: vec3f;\n		var<private> dSpecularity: vec3f = vec3f(0.0, 0.0, 0.0);\n		var<private> dGlossiness: f32 = 0.0;\n		#ifdef LIT_REFRACTION\n			var<private> dTransmission: f32;\n			var<private> dThickness: f32;\n		#endif\n		#ifdef LIT_SCENE_COLOR\n			var uSceneColorMap : texture_2d<f32>;\n			var uSceneColorMapSampler : sampler;\n		#endif\n		#ifdef LIT_SCREEN_SIZE\n			uniform uScreenSize: vec4f;\n		#endif\n		#ifdef LIT_TRANSFORMS\n			var<private> matrix_viewProjection: mat4x4f;\n			var<private> matrix_model: mat4x4f;\n		#endif\n		#ifdef STD_HEIGHT_MAP\n			var<private> dUvOffset: vec2f;\n			#ifdef STD_HEIGHT_TEXTURE_ALLOCATE\n				var texture_heightMap : texture_2d<f32>;\n				var texture_heightMapSampler : sampler;\n			#endif\n		#endif\n		#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE\n			var texture_diffuseMap : texture_2d<f32>;\n			var texture_diffuseMapSampler : sampler;\n		#endif\n		#ifdef STD_DIFFUSEDETAIL_TEXTURE_ALLOCATE\n			var texture_diffuseDetailMap : texture_2d<f32>;\n			var texture_diffuseDetailMapSampler : sampler;\n		#endif\n		#ifdef STD_NORMAL_TEXTURE_ALLOCATE\n			var texture_normalMap : texture_2d<f32>;\n			var texture_normalMapSampler : sampler;\n		#endif\n		#ifdef STD_NORMALDETAIL_TEXTURE_ALLOCATE\n			var texture_normalDetailMap : texture_2d<f32>;\n			var texture_normalDetailMapSampler : sampler;\n		#endif\n		#ifdef STD_THICKNESS_TEXTURE_ALLOCATE\n			var texture_thicknessMap : texture_2d<f32>;\n			var texture_thicknessMapSampler : sampler;\n		#endif\n		#ifdef STD_REFRACTION_TEXTURE_ALLOCATE\n			var texture_refractionMap : texture_2d<f32>;\n			var texture_refractionMapSampler : sampler;\n		#endif\n		#ifdef LIT_IRIDESCENCE\n			var<private> dIridescence: f32;\n			var<private> dIridescenceThickness: f32;\n			#ifdef STD_IRIDESCENCE_THICKNESS_TEXTURE_ALLOCATE\n				var texture_iridescenceThicknessMap : texture_2d<f32>;\n				var texture_iridescenceThicknessMapSampler : sampler;\n			#endif\n			#ifdef STD_IRIDESCENCE_TEXTURE_ALLOCATE\n				var texture_iridescenceMap : texture_2d<f32>;\n				var texture_iridescenceMapSampler : sampler;\n			#endif\n		#endif\n		#ifdef LIT_CLEARCOAT\n			var<private> ccSpecularity: f32;\n			var<private> ccGlossiness: f32;\n			var<private> ccNormalW: vec3f;\n		#endif\n		#ifdef LIT_GGX_SPECULAR\n			var<private> dAnisotropy: f32;\n			var<private> dAnisotropyRotation: vec2f;\n		#endif\n		#ifdef LIT_SPECULAR_OR_REFLECTION\n			#ifdef LIT_SHEEN\n				var<private> sSpecularity: vec3f;\n				var<private> sGlossiness: f32;\n				#ifdef STD_SHEEN_TEXTURE_ALLOCATE\n					var texture_sheenMap : texture_2d<f32>;\n					var texture_sheenMapSampler : sampler;\n				#endif\n				#ifdef STD_SHEENGLOSS_TEXTURE_ALLOCATE\n					var texture_sheenGlossMap : texture_2d<f32>;\n					var texture_sheenGlossMapSampler : sampler;\n				#endif\n			#endif\n			#ifdef LIT_METALNESS\n				var<private> dMetalness: f32;\n				var<private> dIor: f32;\n				#ifdef STD_METALNESS_TEXTURE_ALLOCATE\n					var texture_metalnessMap : texture_2d<f32>;\n					var texture_metalnessMapSampler : sampler;\n				#endif\n			#endif\n			#ifdef LIT_SPECULARITY_FACTOR\n				var<private> dSpecularityFactor: f32;\n				#ifdef STD_SPECULARITYFACTOR_TEXTURE_ALLOCATE\n					var texture_specularityFactorMap : texture_2d<f32>;\n					var texture_specularityFactorMapSampler : sampler;\n				#endif\n			#endif\n			#ifdef STD_SPECULAR_COLOR\n				#ifdef STD_SPECULAR_TEXTURE_ALLOCATE\n					var texture_specularMap : texture_2d<f32>;\n					var texture_specularMapSampler : sampler;\n				#endif\n			#endif\n			#ifdef STD_GLOSS_TEXTURE_ALLOCATE\n				var texture_glossMap : texture_2d<f32>;\n				var texture_glossMapSampler : sampler;\n			#endif\n		#endif\n		#ifdef STD_AO\n			var <private> dAo: f32;\n			#ifdef STD_AO_TEXTURE_ALLOCATE\n				var texture_aoMap : texture_2d<f32>;\n				var texture_aoMapSampler : sampler;\n			#endif\n			#ifdef STD_AODETAIL_TEXTURE_ALLOCATE\n				var texture_aoDetailMap : texture_2d<f32>;\n				var texture_aoDetailMapSampler : sampler;\n			#endif\n		#endif\n		var <private> dEmission: vec3f;\n		#ifdef STD_EMISSIVE_TEXTURE_ALLOCATE\n			var texture_emissiveMap : texture_2d<f32>;\n			var texture_emissiveMapSampler : sampler;\n		#endif\n		#ifdef LIT_CLEARCOAT\n			#ifdef STD_CLEARCOAT_TEXTURE_ALLOCATE\n				var texture_clearCoatMap : texture_2d<f32>;\n				var texture_clearCoatMapSampler : sampler;\n			#endif\n			#ifdef STD_CLEARCOATGLOSS_TEXTURE_ALLOCATE\n				var texture_clearCoatGlossMap : texture_2d<f32>;\n				var texture_clearCoatGlossMapSampler : sampler;\n			#endif\n			#ifdef STD_CLEARCOATNORMAL_TEXTURE_ALLOCATE\n				var texture_clearCoatNormalMap : texture_2d<f32>;\n				var texture_clearCoatNormalMapSampler : sampler;\n			#endif\n		#endif\n		#ifdef LIT_GGX_SPECULAR\n			#ifdef STD_ANISOTROPY_TEXTURE_ALLOCATE\n				var texture_anisotropyMap : texture_2d<f32>;\n				var texture_anisotropyMapSampler : sampler;\n			#endif\n		#endif\n		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n			var<private> dLightmap: vec3f;\n			#ifdef STD_LIGHT_TEXTURE_ALLOCATE\n				var texture_lightMap : texture_2d<f32>;\n				var texture_lightMapSampler : sampler;\n			#endif\n		#endif\n	#endif\n	#include "litShaderCorePS"\n',stdFrontEndPS:'\n	#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n		#include "opacityPS"\n		#if defined(LIT_ALPHA_TEST)\n			#include "alphaTestPS"\n		#endif\n		#if STD_OPACITY_DITHER != NONE\n			#include "opacityDitherPS"\n		#endif\n	#endif\n	#ifdef FORWARD_PASS\n		#ifdef STD_HEIGHT_MAP\n			#include "parallaxPS"\n		#endif\n		#include  "diffusePS"\n		#ifdef LIT_NEEDS_NORMAL\n			#include "normalMapPS"\n		#endif\n		#ifdef LIT_REFRACTION\n			#include "transmissionPS"\n			#include "thicknessPS"\n		#endif\n		#ifdef LIT_IRIDESCENCE\n			#include "iridescencePS"\n			#include "iridescenceThicknessPS"\n		#endif\n		#ifdef LIT_SPECULAR_OR_REFLECTION\n			#ifdef LIT_SHEEN\n				#include "sheenPS"\n				#include "sheenGlossPS"\n			#endif\n			#ifdef LIT_METALNESS\n				#include "metalnessPS"\n				#include "iorPS"\n			#endif\n			#ifdef LIT_SPECULARITY_FACTOR\n				#include "specularityFactorPS"\n			#endif\n			#ifdef STD_SPECULAR_COLOR\n				#include "specularPS"\n			#else\n				fn getSpecularity() { \n					dSpecularity = vec3f(1.0, 1.0, 1.0);\n				}\n			#endif\n			#include "glossPS"\n		#endif\n		#ifdef STD_AO\n			#include "aoPS"\n		#endif\n		#include "emissivePS"\n		#ifdef LIT_CLEARCOAT\n			#include "clearCoatPS"\n			#include "clearCoatGlossPS"\n			#include "clearCoatNormalPS"\n		#endif\n		#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)\n			#include "anisotropyPS"\n		#endif\n		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n			#include "lightmapPS"\n		#endif\n	#endif\n	fn evaluateFrontend() {\n		#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n			getOpacity();\n			#if defined(LIT_ALPHA_TEST)\n				alphaTest(dAlpha);\n			#endif\n			#if STD_OPACITY_DITHER != NONE\n				opacityDither(dAlpha, 0.0);\n			#endif\n			litArgs_opacity = dAlpha;\n		#endif\n		#ifdef FORWARD_PASS\n			#ifdef STD_HEIGHT_MAP\n				getParallax();\n			#endif\n			getAlbedo();\n			litArgs_albedo = dAlbedo;\n			#ifdef LIT_NEEDS_NORMAL\n				getNormal();\n				litArgs_worldNormal = dNormalW;\n			#endif\n			#ifdef LIT_REFRACTION\n				getRefraction();\n				litArgs_transmission = dTransmission;\n				getThickness();\n				litArgs_thickness = dThickness;\n				#ifdef LIT_DISPERSION\n					litArgs_dispersion = uniform.material_dispersion;\n				#endif\n			#endif\n			#ifdef LIT_IRIDESCENCE\n				getIridescence();\n				getIridescenceThickness();\n				litArgs_iridescence_intensity = dIridescence;\n				litArgs_iridescence_thickness = dIridescenceThickness;\n			#endif\n			#ifdef LIT_SPECULAR_OR_REFLECTION\n				#ifdef LIT_SHEEN\n					getSheen();\n					litArgs_sheen_specularity = sSpecularity;\n					getSheenGlossiness();\n					litArgs_sheen_gloss = sGlossiness;\n				#endif\n				#ifdef LIT_METALNESS\n					getMetalness();\n					litArgs_metalness = dMetalness;\n					getIor();\n					litArgs_ior = dIor;\n				#endif\n				#ifdef LIT_SPECULARITY_FACTOR\n					getSpecularityFactor();\n					litArgs_specularityFactor = dSpecularityFactor;\n				#endif\n				getGlossiness();\n				getSpecularity();\n				litArgs_specularity = dSpecularity;\n				litArgs_gloss = dGlossiness;\n			#endif\n			#ifdef STD_AO\n				getAO();\n				litArgs_ao = dAo;\n			#endif\n			getEmission();\n			litArgs_emission = dEmission;\n			#ifdef LIT_CLEARCOAT\n				getClearCoat();\n				getClearCoatGlossiness();\n				getClearCoatNormal();\n				litArgs_clearcoat_specularity = ccSpecularity;\n				litArgs_clearcoat_gloss = ccGlossiness;\n				litArgs_clearcoat_worldNormal = ccNormalW;\n			#endif\n			#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)\n				getAnisotropy();\n			#endif\n			#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n				getLightMap();\n				litArgs_lightmap = dLightmap;\n				#ifdef STD_LIGHTMAP_DIR\n					litArgs_lightmapDir = dLightmapDir;\n				#endif\n			#endif\n		#endif\n	}\n',TBNPS:"\n#ifdef LIT_TANGENTS\n	#define TBN_TANGENTS\n#else\n	#if defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)\n		#define TBN_DERIVATIVES\n	#endif\n#endif\n#if defined(TBN_DERIVATIVES)\n	uniform tbnBasis: f32;\n#endif\nfn getTBN(tangent: vec3f, binormal: vec3f, normal: vec3f) {\n	#ifdef TBN_TANGENTS\n		dTBN = mat3x3f(normalize(tangent), normalize(binormal), normalize(normal));\n	#elif defined(TBN_DERIVATIVES)\n		let uv: vec2f = {lightingUv};\n		let dp1: vec3f = dpdx( vPositionW );\n		let dp2: vec3f = dpdy( vPositionW );\n		let duv1: vec2f = dpdx( uv );\n		let duv2: vec2f = dpdy( uv );\n		let dp2perp: vec3f = cross( dp2, normal );\n		let dp1perp: vec3f = cross( normal, dp1 );\n		let T: vec3f = dp2perp * duv1.x + dp1perp * duv2.x;\n		let B: vec3f = dp2perp * duv1.y + dp1perp * duv2.y;\n		let denom: f32 = max( dot(T, T), dot(B, B) );\n		let invmax: f32 = select(uniform.tbnBasis / sqrt( denom ), 0.0, denom == 0.0);\n		dTBN = mat3x3f(T * invmax, -B * invmax, normal );\n	#else\n		var B: vec3f = cross(normal, vObjectSpaceUpW);\n		var T: vec3f = cross(normal, B);\n		if (dot(B,B) == 0.0)\n		{\n			let major: f32 = max(max(normal.x, normal.y), normal.z);\n			if (normal.x == major)\n			{\n				B = cross(normal, vec3f(0.0, 1.0, 0.0));\n				T = cross(normal, B);\n			}\n			else if (normal.y == major)\n			{\n				B = cross(normal, vec3f(0.0, 0.0, 1.0));\n				T = cross(normal, B);\n			}\n			else\n			{\n				B = cross(normal, vec3f(1.0, 0.0, 0.0));\n				T = cross(normal, B);\n			}\n		}\n		dTBN = mat3x3f(normalize(T), normalize(B), normalize(normal));\n	#endif\n}",thicknessPS:"\n#ifdef STD_THICKNESS_CONSTANT\nuniform material_thickness: f32;\n#endif\nfn getThickness() {\n	dThickness = 1.0;\n	#ifdef STD_THICKNESS_CONSTANT\n	dThickness = dThickness * uniform.material_thickness;\n	#endif\n	#ifdef STD_THICKNESS_TEXTURE\n	dThickness = dThickness * textureSampleBias({STD_THICKNESS_TEXTURE_NAME}, {STD_THICKNESS_TEXTURE_NAME}Sampler, {STD_THICKNESS_TEXTURE_UV}, uniform.textureBias).{STD_THICKNESS_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_THICKNESS_VERTEX\n	dThickness = dThickness * saturate(vVertexColor.{STD_THICKNESS_VERTEX_CHANNEL});\n	#endif\n}\n",tonemappingPS:'\n#if (TONEMAP == NONE)\n	#include "tonemappingNonePS"\n#elif TONEMAP == FILMIC\n	#include "tonemappingFilmicPS"\n#elif TONEMAP == LINEAR\n	#include "tonemappingLinearPS"\n#elif TONEMAP == HEJL\n	#include "tonemappingHejlPS"\n#elif TONEMAP == ACES\n	#include "tonemappingAcesPS"\n#elif TONEMAP == ACES2\n	#include "tonemappingAces2PS"\n#elif TONEMAP == NEUTRAL\n	#include "tonemappingNeutralPS"\n#endif\n',tonemappingAcesPS:"\nuniform exposure: f32;\nfn toneMap(color: vec3f) -> vec3f {\n	let tA: f32 = 2.51;\n	let tB: f32 = 0.03;\n	let tC: f32 = 2.43;\n	let tD: f32 = 0.59;\n	let tE: f32 = 0.14;\n	let x: vec3f = color * uniform.exposure;\n	return (x * (tA * x + tB)) / (x * (tC * x + tD) + tE);\n}\n",tonemappingAces2PS:"\nuniform exposure: f32;\nconst ACESInputMat: mat3x3f = mat3x3f(\n	vec3f(0.59719, 0.35458, 0.04823),\n	vec3f(0.07600, 0.90834, 0.01566),\n	vec3f(0.02840, 0.13383, 0.83777)\n);\nconst ACESOutputMat: mat3x3f = mat3x3f(\n	vec3f( 1.60475, -0.53108, -0.07367),\n	vec3f(-0.10208,  1.10813, -0.00605),\n	vec3f(-0.00327, -0.07276,  1.07602)\n);\nfn RRTAndODTFit(v: vec3f) -> vec3f {\n	let a: vec3f = v * (v + vec3f(0.0245786)) - vec3f(0.000090537);\n	let b: vec3f = v * (vec3f(0.983729) * v + vec3f(0.4329510)) + vec3f(0.238081);\n	return a / b;\n}\nfn toneMap(color: vec3f) -> vec3f {\n	var c: vec3f = color * (uniform.exposure / 0.6);\n	c = c * ACESInputMat;\n	c = RRTAndODTFit(c);\n	c = c * ACESOutputMat;\n	return clamp(c, vec3f(0.0), vec3f(1.0));\n}\n",tonemappingFilmicPS:"\nconst A: f32 = 0.15;\nconst B: f32 = 0.50;\nconst C: f32 = 0.10;\nconst D: f32 = 0.20;\nconst E: f32 = 0.02;\nconst F: f32 = 0.30;\nconst W: f32 = 11.2;\nuniform exposure: f32;\nfn uncharted2Tonemap(x: vec3f) -> vec3f {\n	return ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - vec3f(E / F);\n}\nfn toneMap(color: vec3f) -> vec3f {\n	var c: vec3f = uncharted2Tonemap(color * uniform.exposure);\n	let whiteScale: vec3f = vec3f(1.0) / uncharted2Tonemap(vec3f(W, W, W));\n	c *= whiteScale;\n	return c;\n}\n",tonemappingHejlPS:"\nuniform exposure: f32;\nfn toneMap(color: vec3f) -> vec3f {\n	let A: f32 = 0.22;\n	let B: f32 = 0.3;\n	let C: f32 = 0.1;\n	let D: f32 = 0.2;\n	let E: f32 = 0.01;\n	let F: f32 = 0.3;\n	let Scl: f32 = 1.25;\n	let adjusted_color = color * uniform.exposure;\n	let h = max(vec3f(0.0), adjusted_color - vec3f(0.004));\n	return (h * ((Scl * A) * h + Scl * vec3f(C * B)) + Scl * vec3f(D * E)) /\n		   (h * (A * h + vec3f(B)) + vec3f(D * F)) -\n		   Scl * vec3f(E / F);\n}\n",tonemappingLinearPS:"\nuniform exposure: f32;\nfn toneMap(color: vec3f) -> vec3f {\n	return color * uniform.exposure;\n}\n",tonemappingNeutralPS:"\nuniform exposure: f32;\nfn toneMap(col: vec3f) -> vec3f {\n	var color = col * uniform.exposure;\n	let startCompression = 0.8 - 0.04;\n	let desaturation = 0.15;\n	let x = min(color.r, min(color.g, color.b));\n	let offset = select(0.04, x - 6.25 * x * x, x < 0.08);\n	color -= vec3f(offset);\n	let peak = max(color.r, max(color.g, color.b));\n	if (peak < startCompression) {\n		return color;\n	}\n	let d = 1.0 - startCompression;\n	let newPeak = 1.0 - d * d / (peak + d - startCompression);\n	color *= newPeak / peak;\n	let g = 1.0 - 1.0 / (desaturation * (peak - newPeak) + 1.0);\n	return mix(color, vec3f(newPeak), vec3f(g));\n}\n",tonemappingNonePS:"\nfn toneMap(color: vec3f) -> vec3f {\n	return color;\n}\n",transformVS:"\n#ifdef PIXELSNAP\n	uniform uScreenSize: vec4f;\n#endif\n#ifdef SCREENSPACE\n	uniform projectionFlipY: f32;\n#endif\nfn evalWorldPosition(vertexPosition: vec3f, modelMatrix: mat4x4f) -> vec4f {\n	var localPos: vec3f = getLocalPosition(vertexPosition);\n	#ifdef NINESLICED\n		var localPosXZ: vec2f = localPos.xz;\n		localPosXZ = localPosXZ * uniform.outerScale;\n		let positiveUnitOffset: vec2f = clamp(vertexPosition.xz, vec2f(0.0), vec2f(1.0));\n		let negativeUnitOffset: vec2f = clamp(-vertexPosition.xz, vec2f(0.0), vec2f(1.0));\n		localPosXZ = localPosXZ + (-positiveUnitOffset * uniform.innerOffset.xy + negativeUnitOffset * uniform.innerOffset.zw) * vertex_texCoord0.xy;\n		dTiledUvGlobal = (localPosXZ - uniform.outerScale + uniform.innerOffset.xy) * -0.5 + 1.0;\n		localPosXZ = localPosXZ * -0.5;\n		localPos = vec3f(localPosXZ.x, localPosXZ.y, localPos.y);\n	#endif\n	var posW: vec4f = modelMatrix * vec4f(localPos, 1.0);\n	#ifdef SCREENSPACE\n		posW = vec4f(posW.xy, 0.0, 1.0);\n	#endif\n	return posW;\n}\nfn getPosition() -> vec4f {\n	dModelMatrix = getModelMatrix();\n	let posW: vec4f = evalWorldPosition(vertex_position.xyz, dModelMatrix);\n	dPositionW = posW.xyz;\n	var screenPos: vec4f;\n	#ifdef UV1LAYOUT\n		screenPos = vec4f(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1.0);\n		screenPos.y *= -1.0;\n	#else\n		#ifdef SCREENSPACE\n			screenPos = posW;\n			screenPos.y *= uniform.projectionFlipY;\n		#else\n			screenPos = uniform.matrix_viewProjection * posW;\n		#endif\n		#ifdef PIXELSNAP\n			screenPos.xy = (screenPos.xy * 0.5) + 0.5;\n			screenPos.xy *= uniforms.uScreenSize.xy;\n			screenPos.xy = floor(screenPos.xy);\n			screenPos.xy *= uniforms.uScreenSize.zw;\n			screenPos.xy = (screenPos.xy * 2.0) - 1.0;\n		#endif\n	#endif\n	return screenPos;\n}\nfn getWorldPosition() -> vec3f {\n	return dPositionW;\n}\n",transformCoreVS:'\n	attribute vertex_position: vec4f;\n	uniform matrix_viewProjection: mat4x4f;\n	uniform matrix_model: mat4x4f;\n	\n	#ifdef MORPHING\n		uniform morph_tex_params: vec2f;\n		attribute morph_vertex_id: u32;\n		fn getTextureMorphCoords() -> vec2i {\n			var textureSize: vec2i = vec2i(uniform.morph_tex_params);\n			var morphGridV: i32 = i32(morph_vertex_id) / textureSize.x;\n			var morphGridU: i32 = i32(morph_vertex_id) - (morphGridV * textureSize.x);\n			morphGridV = textureSize.y - morphGridV - 1;\n			return vec2i(morphGridU, morphGridV);\n		}\n		#ifdef MORPHING_POSITION\n			#ifdef MORPHING_INT\n				uniform aabbSize: vec3f;\n				uniform aabbMin: vec3f;\n				var morphPositionTex: texture_2d<u32>;\n			#else\n				var morphPositionTex: texture_2d<f32>;\n			#endif\n		#endif\n	#endif\n	#ifdef defined(BATCH)\n		#include "skinBatchVS"\n		fn getModelMatrix() -> mat4x4f {\n			return getBoneMatrix(vertex_boneIndices);\n		}\n	#elif defined(SKIN)\n		#include "skinVS"\n		fn getModelMatrix() -> mat4x4f {\n			return uniform.matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n		}\n	#elif defined(INSTANCING)\n		#include "transformInstancingVS"\n	#else\n		fn getModelMatrix() -> mat4x4f {\n			return uniform.matrix_model;\n		}\n	#endif\n	fn getLocalPosition(vertexPosition: vec3f) -> vec3f {\n		var localPos: vec3f = vertexPosition;\n		#ifdef MORPHING_POSITION\n			var morphUV: vec2i = getTextureMorphCoords();\n			#ifdef MORPHING_INT\n				var morphPos: vec3f = vec3f(textureLoad(morphPositionTex, morphUV, 0).xyz) / 65535.0 * uniform.aabbSize + uniform.aabbMin;\n			#else\n				var morphPos: vec3f = textureLoad(morphPositionTex, morphUV, 0).xyz;\n			#endif\n			localPos += morphPos;\n		#endif\n		return localPos;\n	}\n',transformInstancingVS:"\nattribute instance_line1: vec4f;\nattribute instance_line2: vec4f;\nattribute instance_line3: vec4f;\nattribute instance_line4: vec4f;\nfn getModelMatrix() -> mat4x4f {\n	return uniform.matrix_model * mat4x4f(instance_line1, instance_line2, instance_line3, instance_line4);\n}\n",transmissionPS:"\n#ifdef STD_REFRACTION_CONSTANT\n	uniform material_refraction: f32;\n#endif\nfn getRefraction() {\n	var refraction: f32 = 1.0;\n	#ifdef STD_REFRACTION_CONSTANT\n	refraction = uniform.material_refraction;\n	#endif\n	#ifdef STD_REFRACTION_TEXTURE\n	refraction = refraction * textureSampleBias({STD_REFRACTION_TEXTURE_NAME}, {STD_REFRACTION_TEXTURE_NAME}Sampler, {STD_REFRACTION_TEXTURE_UV}, uniform.textureBias).{STD_REFRACTION_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_REFRACTION_VERTEX\n	refraction = refraction * saturate(vVertexColor.{STD_REFRACTION_VERTEX_CHANNEL});\n	#endif\n	dTransmission = refraction;\n}\n",twoSidedLightingPS:"\nuniform twoSidedLightingNegScaleFactor: f32;\nfn handleTwoSidedLighting() {\n	dTBN[2] = dTBN[2] * select(-uniform.twoSidedLightingNegScaleFactor, uniform.twoSidedLightingNegScaleFactor, pcFrontFacing);\n}\n",uv0VS:"\n#ifdef NINESLICED\n	fn getUv0() -> vec2f {\n		var uv = vertex_position.xz;\n		let positiveUnitOffset = clamp(vertex_position.xz, vec2f(0.0, 0.0), vec2f(1.0, 1.0));\n		let negativeUnitOffset = clamp(-vertex_position.xz, vec2f(0.0, 0.0), vec2f(1.0, 1.0));\n		uv = uv + ((-positiveUnitOffset * uniform.innerOffset.xy) + (negativeUnitOffset * uniform.innerOffset.zw)) * vertex_texCoord0.xy;\n		uv = uv * -0.5 + vec2f(0.5, 0.5);\n		uv = uv * uniform.atlasRect.zw + uniform.atlasRect.xy;\n		dMaskGlobal = vertex_texCoord0.xy;\n		return uv;\n	}\n#else\n	fn getUv0() -> vec2f {\n		return vertex_texCoord0;\n	}\n#endif\n",uv1VS:"\nfn getUv1() -> vec2f {\n	return vertex_texCoord1;\n}\n",uvTransformVS:"\noutput.vUV{TRANSFORM_UV_{i}}_{TRANSFORM_ID_{i}} = vec2f(\n	dot(vec3f(uv{TRANSFORM_UV_{i}}, 1), uniform.{TRANSFORM_NAME_{i}}0),\n	dot(vec3f(uv{TRANSFORM_UV_{i}}, 1), uniform.{TRANSFORM_NAME_{i}}1)\n);\n",uvTransformUniformsPS:"\n	uniform {TRANSFORM_NAME_{i}}0: vec3f;\n	uniform {TRANSFORM_NAME_{i}}1: vec3f;\n",viewDirPS:"\nfn getViewDir() {\n	dViewDirW = normalize(uniform.view_position - vPositionW);\n}\n",webgpuPS:"\n",webgpuVS:rY};function mw(e,t){return (mw=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}e.app=null;var mA=function(t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");function n(i){var r;return (r=t.call(this)||this)._batcher=null,r._destroyRequested=false,r._inFrameUpdate=false,r._librariesLoaded=false,r._fillMode=pP,r._resolutionMode=pL,r._allowResize=true,r._skyboxAsset=null,r._entityIndex={},r._inTools=false,r._scriptPrefix="",r._time=0,r.enableBundles="undefined"!=typeof TextDecoder,r.timeScale=1,r.maxDeltaTime=.1,r.frame=0,r.frameGraph=new pR,r.scriptsOrder=[],r.autoRender=true,r.renderNextFrame=false,r.lightmapper=null,r.loader=new ms(r),r.scenes=new mx(r),r.scripts=new mh(r),r.systems=new p6,r.i18n=new ml(r),r.keyboard=null,r.mouse=null,r.touch=null,r.gamepads=null,r.elementInput=null,r.xr=null,n._applications[i.id]=r,A=r,e.app=r,r.root=new my,r.root._enabledInHierarchy=true,r}n.prototype=Object.create(t&&t.prototype,{constructor:{value:n,writable:true,configurable:true}}),t&&mw(n,t);var i,r=n.prototype;return r.init=function(e){var t=this,n=e.assetPrefix,i=e.batchManager,r=e.componentSystems,s=e.elementInput,a=e.gamepads,o=e.graphicsDevice,l=e.keyboard,u=e.lightmapper,c=e.mouse,h=e.resourceHandlers,f=e.scriptsOrder,d=e.scriptPrefix,p=e.soundManager,m=e.touch,_=e.xr;this.graphicsDevice=o,o0.get(o,nn).add(mT),o0.get(o,ni).add(mE),this._initDefaultMaterial(),this._initProgramLibrary(),this.stats=new mb(o),this._soundManager=p,this.scene=new fB(o),this._registerSceneImmediate(this.scene),this.assets=new p2(this.loader),n&&(this.assets.prefix=n),this.bundles=new p5(this.assets),this.scriptsOrder=f||[],this.defaultLayerWorld=new cX({name:"World",id:0}),this.defaultLayerDepth=new cX({name:"Depth",id:1,enabled:false,opaqueSortMode:0}),this.defaultLayerSkybox=new cX({name:"Skybox",id:2,opaqueSortMode:0}),this.defaultLayerUi=new cX({name:"UI",id:4,transparentSortMode:1}),this.defaultLayerImmediate=new cX({name:"Immediate",id:3,opaqueSortMode:0});var v=new cZ("default");v.pushOpaque(this.defaultLayerWorld),v.pushOpaque(this.defaultLayerDepth),v.pushOpaque(this.defaultLayerSkybox),v.pushTransparent(this.defaultLayerWorld),v.pushOpaque(this.defaultLayerImmediate),v.pushTransparent(this.defaultLayerImmediate),v.pushTransparent(this.defaultLayerUi),this.scene.layers=v,pN.createPlaceholder(o),this.renderer=new cz(o,this.scene),u&&(this.lightmapper=new u(o,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this)),i&&(this._batcher=new i(o,this.root,this.scene),this.once("prerender",this._firstBatch,this)),this.keyboard=l||null,this.mouse=c||null,this.touch=m||null,this.gamepads=a||null,s&&(this.elementInput=s,this.elementInput.app=this),this.xr=_?new _(this):null,this.elementInput&&this.elementInput.attachSelectEvents(),this._scriptPrefix=d||"",this.enableBundles&&this.loader.addHandler("bundle",new mr(this)),h.forEach(function(e){var n=new e(t);t.loader.addHandler(n.handlerType,n);}),r.forEach(function(e){t.systems.add(new e(t));}),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),"undefined"!=typeof document&&(void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,false)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,false)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,false)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,false))),this.tick=mC(this);},r._initDefaultMaterial=function(){var e,t=new dw;t.name="Default Material",e=this.graphicsDevice,lv.get(e,function(){return t});},r._initProgramLibrary=function(){var e,t=new dq(this.graphicsDevice,new dw);e=this.graphicsDevice,oU.get(e,function(){return t});},r.configure=function(e,t){var n=this;aq.get(e,function(e,i){if(e)return void t(e);var r=i.application_properties,s=i.scenes,a=i.assets;n._parseApplicationProperties(r,function(e){n._parseScenes(s),n._parseAssets(a),e?t(e):t(null);});});},r.preload=function(e){var t=this;this.fire("preload:start");var n=this.assets.list({preload:true});if(0===n.length){this.fire("preload:end"),e();return}var i=0,r=function(){i++,t.fire("preload:progress",i/n.length),i===n.length&&(t.fire("preload:end"),e());};n.forEach(function(e){e.loaded?r():(e.once("load",r),e.once("error",r),t.assets.load(e));});},r._preloadScripts=function(e,t){t();},r._parseApplicationProperties=function(e,t){if("number"==typeof e.maxAssetRetries&&e.maxAssetRetries>0&&this.loader.enableRetry(e.maxAssetRetries),e.useDevicePixelRatio||(e.useDevicePixelRatio=e.use_device_pixel_ratio),e.resolutionMode||(e.resolutionMode=e.resolution_mode),e.fillMode||(e.fillMode=e.fill_mode),this._width=e.width,this._height=e.height,e.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(e.resolutionMode,this._width,this._height),this.setCanvasFillMode(e.fillMode,this._width,this._height),e.layers&&e.layerOrder){var n=new cZ("application"),i={};for(var r in e.layers){var s=e.layers[r];s.id=parseInt(r,10),s.enabled=1!==s.id,i[r]=new cX(s);}for(var a=0,o=e.layerOrder.length;a<o;a++){var l=e.layerOrder[a],u=i[l.layer];u&&(l.transparent?n.pushTransparent(u):n.pushOpaque(u),n.subLayerEnabled[a]=l.enabled);}this.scene.layers=n;}if(e.batchGroups){var c=this.batcher;if(c)for(var h=0,f=e.batchGroups.length;h<f;h++){var d=e.batchGroups[h];c.addGroup(d.name,d.dynamic,d.maxAabbSize,d.id,d.layers);}}e.i18nAssets&&(this.i18n.assets=e.i18nAssets),this._loadLibraries(e.libraries,t);},r._loadLibraries=function(e,t){var n=this,i=e.length,r=i,s=/^https?:\/\//;if(i)for(var a=function(e,i){r--,e?t(e):0===r&&(n.onLibrariesLoaded(),t(null));},o=0;o<i;++o){var l=e[o];!s.test(l.toLowerCase())&&this._scriptPrefix&&(l=en.join(this._scriptPrefix,l)),this.loader.load(l,"script",a);}else this.onLibrariesLoaded(),t(null);},r._parseScenes=function(e){if(e)for(var t=0;t<e.length;t++)this.scenes.add(e[t].name,e[t].url);},r._parseAssets=function(e){for(var t=[],n={},i={},r=0;r<this.scriptsOrder.length;r++){var s=this.scriptsOrder[r];e[s]&&(n[s]=true,t.push(e[s]));}if(this.enableBundles)for(var a in e)"bundle"===e[a].type&&(i[a]=true,t.push(e[a]));for(var o in e)n[o]||i[o]||t.push(e[o]);for(var l=0;l<t.length;l++){var u=t[l],c=new pZ(u.name,u.type,u.file,u.data);if(c.id=parseInt(u.id,10),c.preload=!!u.preload&&u.preload,c.loaded="script"===u.type&&u.data&&u.data.loadingType>0,c.tags.add(u.tags),u.i18n)for(var h in u.i18n)c.addLocalizedAssetId(h,u.i18n[h]);this.assets.add(c);}},r.start=function(){this.frame=0,this.fire("start",{timestamp:eL(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick();},r.inputUpdate=function(e){this.controller&&this.controller.update(e),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update();},r.update=function(e){this.frame++,this.graphicsDevice.update(),this.systems.fire(this._inTools?"toolsUpdate":"update",e),this.systems.fire("animationUpdate",e),this.systems.fire("postUpdate",e),this.fire("update",e),this.inputUpdate(e);},r.render=function(){this.updateCanvasSize(),this.graphicsDevice.frameStart(),this.fire("prerender"),this.root.syncHierarchy(),this._batcher&&this._batcher.updateAll(),this.renderComposition(this.scene.layers),this.fire("postrender"),this.graphicsDevice.frameEnd();},r.renderComposition=function(e){this.renderer.update(e),this.renderer.buildFrameGraph(this.frameGraph,e),this.frameGraph.render(this.graphicsDevice);},r._fillFrameStatsBasic=function(e,t,n){var i=this.stats.frame;i.dt=t,i.ms=n,e>i._timeToCountFrames?(i.fps=i._fpsAccum,i._fpsAccum=0,i._timeToCountFrames=e+1e3):i._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0;},r._fillFrameStats=function(){var e=this.stats.frame;e.cameras=this.renderer._camerasRendered,e.materials=this.renderer._materialSwitches,e.shaders=this.graphicsDevice._shaderSwitchesPerFrame,e.shadowMapUpdates=this.renderer._shadowMapUpdates,e.shadowMapTime=this.renderer._shadowMapTime,e.depthMapTime=this.renderer._depthMapTime,e.forwardTime=this.renderer._forwardTime;var t=this.graphicsDevice._primsPerFrame;e.triangles=t[4]/3+Math.max(t[5]-2,0)+Math.max(t[6]-2,0),e.cullTime=this.renderer._cullTime,e.sortTime=this.renderer._sortTime,e.skinTime=this.renderer._skinTime,e.morphTime=this.renderer._morphTime,e.lightClusters=this.renderer._lightClusters,e.lightClustersTime=this.renderer._lightClustersTime,e.otherPrimitives=0;for(var n=0;n<t.length;n++)n<4&&(e.otherPrimitives+=t[n]),t[n]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,(e=this.stats.drawCalls).forward=this.renderer._forwardDrawCalls,e.culled=this.renderer._numDrawCallsCulled,e.depth=0,e.shadow=this.renderer._shadowDrawCalls,e.skinned=this.renderer._skinDrawCalls,e.immediate=0,e.instanced=0,e.removedByInstancing=0,e.misc=e.total-(e.forward+e.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,(e=this.stats.particles).updatesPerFrame=e._updatesPerFrame,e.frameTime=e._frameTime,e._updatesPerFrame=0,e._frameTime=0;},r.setCanvasFillMode=function(e,t,n){this._fillMode=e,this.resizeCanvas(t,n);},r.setCanvasResolution=function(e,t,n){this._resolutionMode=e,e===pI&&void 0===t&&(t=this.graphicsDevice.canvas.clientWidth,n=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(t,n);},r.isHidden=function(){return document[this._hiddenAttr]},r.onVisibilityChange=function(){this.isHidden()?this._soundManager&&this._soundManager.suspend():this._soundManager&&this._soundManager.resume();},r.resizeCanvas=function(e,t){if(this._allowResize&&(!this.xr||!this.xr.session)){var n=window.innerWidth,i=window.innerHeight;if(this._fillMode===pP){var r=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;r>n/i?t=(e=n)/r:e=(t=i)*r;}else this._fillMode===pC&&(e=n,t=i);return this.graphicsDevice.canvas.style.width=""+e+"px",this.graphicsDevice.canvas.style.height=""+t+"px",this.updateCanvasSize(),{width:e,height:t}}},r.updateCanvasSize=function(){var e;if(this._allowResize&&(null==(e=this.xr)||!e.active)&&this._resolutionMode===pI){var t=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(t.clientWidth,t.clientHeight);}},r.onLibrariesLoaded=function(){this._librariesLoaded=true,this.systems.rigidbody&&this.systems.rigidbody.onLibraryLoaded();},r.applySceneSettings=function(e){var t;if(this.systems.rigidbody&&"undefined"!=typeof Ammo){var n=e.physics.gravity,i=n[0],r=n[1],s=n[2];this.systems.rigidbody.gravity.set(i,r,s);}this.scene.applySettings(e),e.render.hasOwnProperty("skybox")&&(e.render.skybox?(t=this.assets.get(e.render.skybox))?this.setSkybox(t):this.assets.once("add:"+e.render.skybox,this.setSkybox,this):this.setSkybox(null));},r.setAreaLightLuts=function(e,t){e&&t&&pN.set(this.graphicsDevice,e,t);},r.setSkybox=function(e){var t=this;if(e!==this._skyboxAsset){var n=function(){t.setSkybox(null);},i=function(){t.scene.setSkybox(t._skyboxAsset?t._skyboxAsset.resources:null);};this._skyboxAsset&&(this.assets.off("load:"+this._skyboxAsset.id,i,this),this.assets.off("remove:"+this._skyboxAsset.id,n,this),this._skyboxAsset.off("change",i,this)),this._skyboxAsset=e,this._skyboxAsset&&(this.assets.on("load:"+this._skyboxAsset.id,i,this),this.assets.once("remove:"+this._skyboxAsset.id,n,this),this._skyboxAsset.on("change",i,this),0!==this.scene.skyboxMip||this._skyboxAsset.loadFaces||(this._skyboxAsset.loadFaces=true),this.assets.load(this._skyboxAsset)),i();}},r._firstBake=function(){var e;null==(e=this.lightmapper)||e.bake(null,this.scene.lightmapMode);},r._firstBatch=function(){var e;null==(e=this.batcher)||e.generate();},r._processTimestamp=function(e){return e},r.drawLine=function(e,t,n,i,r){this.scene.drawLine(e,t,n,i,r);},r.drawLines=function(e,t,n,i){ void 0===n&&(n=true),void 0===i&&(i=this.scene.defaultDrawLayer),this.scene.drawLines(e,t,n,i);},r.drawLineArrays=function(e,t,n,i){ void 0===n&&(n=true),void 0===i&&(i=this.scene.defaultDrawLayer),this.scene.drawLineArrays(e,t,n,i);},r.drawWireSphere=function(e,t,n,i,r,s){ void 0===n&&(n=eN.WHITE),void 0===i&&(i=20),void 0===r&&(r=true),void 0===s&&(s=this.scene.defaultDrawLayer),this.scene.immediate.drawWireSphere(e,t,n,i,r,s);},r.drawWireAlignedBox=function(e,t,n,i,r,s){ void 0===n&&(n=eN.WHITE),void 0===i&&(i=true),void 0===r&&(r=this.scene.defaultDrawLayer),this.scene.immediate.drawWireAlignedBox(e,t,n,i,r,s);},r.drawMeshInstance=function(e,t){ void 0===t&&(t=this.scene.defaultDrawLayer),this.scene.immediate.drawMesh(null,null,null,e,t);},r.drawMesh=function(e,t,n,i){ void 0===i&&(i=this.scene.defaultDrawLayer),this.scene.immediate.drawMesh(t,n,e,null,i);},r.drawQuad=function(e,t,n){ void 0===n&&(n=this.scene.defaultDrawLayer),this.scene.immediate.drawMesh(t,e,this.scene.immediate.getQuadMesh(),null,n);},r.drawTexture=function(e,t,n,i,r,s,a,o){if(void 0===a&&(a=this.scene.defaultDrawLayer),void 0===o&&(o=true),false!==o||this.graphicsDevice.isWebGPU){var l=new e$;l.setTRS(new eW(e,t,0),e0.IDENTITY,new eW(n,-i,0)),s||((s=new h3).cull=0,s.setParameter("colorMap",r),s.shaderDesc=o?this.scene.immediate.getTextureShaderDesc(r.encoding):this.scene.immediate.getUnfilterableTextureShaderDesc(),s.update()),this.drawQuad(l,s,a);}},r.drawDepthTexture=function(e,t,n,i,r){ void 0===r&&(r=this.scene.defaultDrawLayer);var s=new h3;s.cull=0,s.shaderDesc=this.scene.immediate.getDepthTextureShaderDesc(),s.update(),this.drawTexture(e,t,n,i,null,s,r);},r.destroy=function(){if(this._inFrameUpdate){this._destroyRequested=true;return}var e,t,i,r,s=this.graphicsDevice.canvas.id;this.fire("destroy",this),this.off("librariesloaded"),"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,false),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,false),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,false),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,false)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.gamepads&&(this.gamepads.destroy(),this.gamepads=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();for(var a=this.assets.list(),o=0;o<a.length;o++)a[o].unload(),a[o].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;var l=this.loader.getHandler("script");null==l||l.clearCache(),this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,null==(e=this.lightmapper)||e.destroy(),this.lightmapper=null,this._batcher&&(this._batcher.destroy(),this._batcher=null),this._entityIndex={},this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,null==(t=this.xr)||t.end(),null==(i=this.xr)||i.destroy(),this.renderer.destroy(),this.renderer=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),null==(r=this._soundManager)||r.destroy(),this._soundManager=null,pM.app=null,n._applications[s]=null,A===this&&(A=null),n.cancelTick(this);},r.getEntityFromIndex=function(e){return this._entityIndex[e]},r._registerSceneImmediate=function(e){this.on("postrender",e.immediate.onPostRender,e.immediate);},n.getApplication=function(e){return e?n._applications[e]:A},n.cancelTick=function(e){e.frameRequestId&&(window.cancelAnimationFrame(e.frameRequestId),e.frameRequestId=void 0);},i=[{key:"soundManager",get:function(){return this._soundManager}},{key:"batcher",get:function(){return this._batcher}},{key:"fillMode",get:function(){return this._fillMode}},{key:"resolutionMode",get:function(){return this._resolutionMode}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(n.prototype,i),n}(ex);mA._applications={};var mC=function(t){return function(n,i){if(t.graphicsDevice){t.frameRequestId&&(null==(a=t.xr)||null==(s=a.session)||s.cancelAnimationFrame(t.frameRequestId),cancelAnimationFrame(t.frameRequestId),t.frameRequestId=null),t._inFrameUpdate=true,A=t,e.app=t;var r,s,a,o,l=t._processTimestamp(n)||eL(),u=l-(t._time||l),c=u/1e3;if(c=ek.clamp(c,0,t.maxDeltaTime)*t.timeScale,t._time=l,(null==(r=t.xr)?void 0:r.session)?t.frameRequestId=t.xr.session.requestAnimationFrame(t.tick):t.frameRequestId=ef.browser||ef.worker?requestAnimationFrame(t.tick):null,!t.graphicsDevice.contextLost){t._fillFrameStatsBasic(l,c,u),t.fire("frameupdate",u);var h=false;i?(h=!(null==(o=t.xr)?void 0:o.update(i)),t.graphicsDevice.defaultFramebuffer=i.session.renderState.baseLayer.framebuffer):t.graphicsDevice.defaultFramebuffer=null,h||(t.update(c),t.fire("framerender"),(t.autoRender||t.renderNextFrame)&&(t.render(),t.renderNextFrame=false),t.fire("frameend")),t._inFrameUpdate=false,t._destroyRequested&&t.destroy();}}}},mP=function(){this.componentSystems=[],this.resourceHandlers=[];},mI=new e7,mL=function(){function e(e,t,n){this.scene=e,this.light=t,this.store(),t.numCascades=1,this.scene.clusteredLightingEnabled&&!n.shadowsEnabled&&(t.castShadows=false),0!==t.type&&(t._node.getWorldTransform(),t.getBoundingSphere(mI),this.lightBounds=new e8,this.lightBounds.center.copy(mI.center),this.lightBounds.halfExtents.set(mI.radius,mI.radius,mI.radius));}var t=e.prototype;return t.store=function(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.intensity=this.light.intensity,this.rotation=this.light._node.getLocalRotation().clone(),this.numCascades=this.light.numCascades,this.castShadows=this.light._castShadows;},t.restore=function(){var e=this.light;e.mask=this.mask,e.shadowUpdateMode=this.shadowUpdateMode,e.enabled=this.enabled,e.intensity=this.intensity,e._node.setLocalRotation(this.rotation),e.numCascades=this.numCascades,e._castShadows=this.castShadows;},t.startBake=function(){this.light.enabled=true,this.light._destroyShadowMap(),this.light.beginFrame();},t.endBake=function(e){var t=this.light;t.enabled=false,t.shadowMap&&(t.shadowMap.cached&&e.add(t,t.shadowMap),t.shadowMap=null);},e}();function mD(e,t){return (mD=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var mM=new eX,mR=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(t,n){return e.call(this,t.scene,n,t.lightingParams)||this}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:true,configurable:true}}),e&&mD(n,e),n.prototype.prepareVirtualLight=function(e,t){var n=this.light;if(n._node.setLocalRotation(this.rotation),e>0){var i=n.bakeArea;fm.circlePointDeterministic(mM,e,t),mM.mulScalar(.5*i),n._node.rotateLocal(mM.x,0,mM.y);}n._node.getWorldTransform(),n.intensity=Math.pow(Math.pow(this.intensity,2.2)/t,.45454545454545453);},t=[{key:"numVirtualLights",get:function(){return 0===this.light.type?this.light.bakeNumSamples:1}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(n.prototype,t),n}(mL);function mO(e,t){return (mO=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var mk=new eW,mN=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(t){var n=t.scene,i=new my("AmbientLight");return i.addComponent("light",{type:"directional",affectDynamic:true,affectLightmapped:false,bake:true,bakeNumSamples:n.ambientBakeNumSamples,castShadows:true,normalOffsetBias:.05,shadowBias:.2,shadowDistance:1,shadowResolution:2048,shadowType:0,color:eN.WHITE,intensity:1,bakeDir:false}),e.call(this,n,i.light.light,t.lightingParams)||this}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:true,configurable:true}}),e&&mO(n,e),n.prototype.prepareVirtualLight=function(e,t){fm.spherePointDeterministic(mk,e,t,0,this.scene.ambientBakeSpherePart),this.light._node.lookAt(mk.mulScalar(-1)),this.light._node.rotateLocal(90,0,0);var n=Math.pow(2*Math.PI*this.scene.ambientBakeSpherePart,2.2);this.light.intensity=Math.pow(n/t,.45454545454545453);},t=[{key:"numVirtualLights",get:function(){return this.light.bakeNumSamples}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(n.prototype,t),n}(mL),mF=function(){function e(e,t){ void 0===t&&(t=null),this.node=e,this.component=e.render||e.model,t=t||this.component.meshInstances,this.store(),this.meshInstances=t,this.bounds=null,this.renderTargets=[];}var t=e.prototype;return t.store=function(){this.castShadows=this.component.castShadows;},t.restore=function(){this.component.castShadows=this.castShadows;},e}(),mB={glslBilateralDeNoisePS:"\nfloat normpdf3(in vec3 v, in float sigma) {\n	return 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;\n}\nvec3 decodeRGBM(vec4 rgbm) {\n	vec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n	return color * color;\n}\nfloat saturate(float x) {\n	return clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec3 color) {\n	vec4 encoded;\n	encoded.rgb = pow(color.rgb, vec3(0.5));\n	encoded.rgb *= 1.0 / 8.0;\n	encoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n	encoded.a = ceil(encoded.a * 255.0) / 255.0;\n	encoded.rgb /= encoded.a;\n	return encoded;\n}\nvec3 decode(vec4 pixel) {\n	#if HDR\n		return pixel.rgb;\n	#else\n		return decodeRGBM(pixel);\n	#endif\n}\nbool isUsed(vec4 pixel) {\n	#if HDR\n		return any(greaterThan(pixel.rgb, vec3(0.0)));\n	#else\n		return pixel.a > 0.0;\n	#endif\n}\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nuniform vec2 sigmas;\nuniform float bZnorm;\nuniform float kernel[{MSIZE}];\nvoid main(void) {\n	\n	vec4 pixel = texture2DLod(source, vUv0, 0.0);\n	if (!isUsed(pixel)) {\n		gl_FragColor = pixel;\n		return ;\n	}\n	float sigma = sigmas.x;\n	float bSigma = sigmas.y;\n	vec3 pixelHdr = decode(pixel);\n	vec3 accumulatedHdr = vec3(0.0);\n	float accumulatedFactor = 0.000001;\n	const int kSize = ({MSIZE} - 1) / 2;\n	for (int i = -kSize; i <= kSize; ++i) {\n		for (int j = -kSize; j <= kSize; ++j) {\n			\n			vec2 coord = vUv0 + vec2(float(i), float(j)) * pixelOffset;\n			vec4 pix = texture2DLod(source, coord, 0.0);\n			if (isUsed(pix)) {\n				vec3 hdr = decode(pix);\n				float factor = kernel[kSize + j] * kernel[kSize + i];\n				factor *= normpdf3(hdr - pixelHdr, bSigma) * bZnorm;\n				accumulatedHdr += factor * hdr;\n				accumulatedFactor += factor;\n			}\n		}\n	}\n	vec3 finalHDR = accumulatedHdr / accumulatedFactor;\n	#if HDR\n		gl_FragColor = vec4(finalHDR, 1.0);\n	#else\n		gl_FragColor = encodeRGBM(finalHDR);\n	#endif\n}\n",glslDilatePS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nbool isUsed(vec4 pixel) {\n	#if HDR\n		return any(greaterThan(pixel.rgb, vec3(0.0)));\n	#else\n		return pixel.a > 0.0;\n	#endif\n}\nvoid main(void) {\n	vec4 c = texture2DLod(source, vUv0, 0.0);\n	c = isUsed(c) ? c : texture2DLod(source, vUv0 - pixelOffset, 0.0);\n	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(0, -pixelOffset.y), 0.0);\n	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y), 0.0);\n	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(-pixelOffset.x, 0), 0.0);\n	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(pixelOffset.x, 0), 0.0);\n	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y), 0.0);\n	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(0, pixelOffset.y), 0.0);\n	c = isUsed(c) ? c : texture2DLod(source, vUv0 + pixelOffset, 0.0);\n	gl_FragColor = c;\n}\n"},mU={wgslBilateralDeNoisePS:"\nfn normpdf3(v: vec3f, sigma: f32) -> f32 {\n	return 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;\n}\nfn decodeRGBM(rgbm: vec4f) -> vec3f {\n	let color = (8.0 * rgbm.a) * rgbm.rgb;\n	return color * color;\n}\nfn saturate(x: f32) -> f32 {\n	return clamp(x, 0.0, 1.0);\n}\nfn encodeRGBM(color: vec3f) -> vec4f {\n	var encoded: vec4f;\n	let rgb_processed = pow(color.rgb, vec3f(0.5)) * (1.0 / 8.0);\n	encoded = vec4f(rgb_processed, 0.0);\n	let max_g_b = max( encoded.g, max( encoded.b, 1.0 / 255.0 ) );\n	let max_rgb = max( encoded.r, max_g_b );\n	encoded.a = clamp(max_rgb, 0.0, 1.0);\n	encoded.a = ceil(encoded.a * 255.0) / 255.0;\n	encoded = vec4f(encoded.rgb / encoded.a, encoded.a);\n	return encoded;\n}\nfn decode(pixel: vec4f) -> vec3f {\n	#if HDR\n		return pixel.rgb;\n	#else\n		return decodeRGBM(pixel);\n	#endif\n}\nfn isUsed(pixel: vec4f) -> bool {\n	#if HDR\n		return any(pixel.rgb > vec3f(0.0));\n	#else\n		return pixel.a > 0.0;\n	#endif\n}\nvarying vUv0: vec2f;\nvar source: texture_2d<f32>;\nvar sourceSampler: sampler;\nuniform kernel: array<f32, {MSIZE}>;\nuniform pixelOffset: vec2f;\nuniform sigmas: vec2f;\nuniform bZnorm: f32;\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n	var output: FragmentOutput;\n	let pixel = textureSampleLevel(source, sourceSampler, input.vUv0, 0.0);\n	if (!isUsed(pixel)) {\n		output.color = pixel;\n		return output;\n	}\n	let sigma = uniform.sigmas.x;\n	let bSigma = uniform.sigmas.y;\n	let pixelHdr = decode(pixel);\n	var accumulatedHdr = vec3f(0.0);\n	var accumulatedFactor = 0.000001;\n	const kSize = ({MSIZE} - 1) / 2;\n	for (var i: i32 = -kSize; i <= kSize; i = i + 1) {\n		for (var j: i32 = -kSize; j <= kSize; j = j + 1) {\n			let coord = input.vUv0 + vec2f(f32(i), f32(j)) * uniform.pixelOffset;\n			let pix = textureSampleLevel(source, sourceSampler, coord, 0.0);\n			if (isUsed(pix)) {\n				let hdr = decode(pix);\n				var factor = uniform.kernel[u32(kSize + j)].element * uniform.kernel[u32(kSize + i)].element;\n				factor = factor * normpdf3(hdr - pixelHdr, bSigma) * uniform.bZnorm;\n				accumulatedHdr = accumulatedHdr + factor * hdr;\n				accumulatedFactor = accumulatedFactor + factor;\n			}\n		}\n	}\n	let finalHDR = accumulatedHdr / accumulatedFactor;\n	#if HDR\n		output.color = vec4f(finalHDR, 1.0);\n	#else\n		output.color = encodeRGBM(finalHDR);\n	#endif\n	return output;\n}\n",wgslDilatePS:"\nvarying vUv0: vec2f;\nvar source: texture_2d<f32>;\nvar sourceSampler: sampler;\nuniform pixelOffset: vec2f;\nfn isUsed(pixel: vec4f) -> bool {\n	#ifdef HDR\n		return any(pixel.rgb > vec3f(0.0));\n	#else\n		return pixel.a > 0.0;\n	#endif\n}\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n	var c: vec4f = textureSampleLevel(source, sourceSampler, input.vUv0, 0.0);\n	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 - uniform.pixelOffset, 0.0), c, isUsed(c));\n	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(0.0, -uniform.pixelOffset.y), 0.0), c, isUsed(c));\n	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(uniform.pixelOffset.x, -uniform.pixelOffset.y), 0.0), c, isUsed(c));\n	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(-uniform.pixelOffset.x, 0.0), 0.0), c, isUsed(c));\n	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(uniform.pixelOffset.x, 0.0), 0.0), c, isUsed(c));\n	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(-uniform.pixelOffset.x, uniform.pixelOffset.y), 0.0), c, isUsed(c));\n	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(0.0, uniform.pixelOffset.y), 0.0), c, isUsed(c));\n	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + uniform.pixelOffset, 0.0), c, isUsed(c));\n	var output: FragmentOutput;\n	output.color = c;\n	return output;\n}\n"},mz=function(){function e(e){this.shaderDilate=[],this.shaderDenoise=[],this.device=e,o0.get(this.device,nn).add(mB),o0.get(this.device,ni).add(mU),this.constantTexSource=e.scope.resolve("source"),this.constantPixelOffset=e.scope.resolve("pixelOffset"),this.pixelOffset=new Float32Array(2),this.sigmas=null,this.constantSigmas=null,this.kernel=null;}var t=e.prototype;return t.setSourceTexture=function(e){this.constantTexSource.setValue(e);},t.prepare=function(e,t){this.pixelOffset[0]=1/e,this.pixelOffset[1]=1/t,this.constantPixelOffset.setValue(this.pixelOffset);},t.prepareDenoise=function(e,t,n){var i=+!n;if(!this.shaderDenoise[i]){var r=new Map;r.set("{MSIZE}",15),n&&r.set("HDR",""),this.shaderDenoise[i]=o8.createShader(this.device,{uniqueName:"lmBilateralDeNoise-"+(n?"hdr":"rgbm"),attributes:{vertex_position:tT},vertexGLSL:o0.get(this.device,nn).get("fullscreenQuadVS"),vertexWGSL:o0.get(this.device,ni).get("fullscreenQuadVS"),fragmentGLSL:o0.get(this.device,nn).get("glslBilateralDeNoisePS"),fragmentWGSL:o0.get(this.device,ni).get("wgslBilateralDeNoisePS"),fragmentDefines:r}),this.sigmas=new Float32Array(2),this.constantSigmas=this.device.scope.resolve("sigmas"),this.constantKernel=this.device.scope.resolve("kernel[0]"),this.bZnorm=this.device.scope.resolve("bZnorm");}this.sigmas[0]=e,this.sigmas[1]=t,this.constantSigmas.setValue(this.sigmas),this.evaluateDenoiseUniforms(e,t);},t.getDenoise=function(e){return this.shaderDenoise[+!e]},t.getDilate=function(e,t){var n=+!t;if(!this.shaderDilate[n]){var i=t?"#define HDR\n":"";this.shaderDilate[n]=o8.createShader(e,{uniqueName:"lmDilate-"+(t?"hdr":"rgbm"),attributes:{vertex_position:tT},vertexGLSL:o0.get(this.device,nn).get("fullscreenQuadVS"),vertexWGSL:o0.get(this.device,ni).get("fullscreenQuadVS"),fragmentGLSL:i+o0.get(this.device,nn).get("glslDilatePS"),fragmentWGSL:i+o0.get(this.device,ni).get("wgslDilatePS")});}return this.shaderDilate[n]},t.evaluateDenoiseUniforms=function(e,t){function n(e,t){return .39894*Math.exp(-0.5*e*e/(t*t))/t}this.kernel=this.kernel||new Float32Array(15);for(var i=this.kernel,r=Math.floor(7),s=0;s<=r;++s){var a=n(s,e);i[r+s]=a,i[r-s]=a;}this.constantKernel.setValue(this.kernel);var o=1/n(0,t);this.bZnorm.setValue(o);},e}();function mV(e,t){return (mV=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var mG=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i,r,s,a){var o;return (o=e.call(this,t)||this).viewBindGroups=[],o.renderer=n,o.camera=i,o.worldClusters=r,o.receivers=s,o.lightArray=a,o}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&mV(t,e);var n=t.prototype;return n.destroy=function(){this.viewBindGroups.forEach(function(e){e.defaultUniformBuffer.destroy(),e.destroy();}),this.viewBindGroups.length=0;},n.execute=function(){this.device;var e=this.renderer,t=this.camera,n=this.receivers,i=this.renderTarget,r=this.worldClusters,s=this.lightArray;e.renderForwardLayer(t,i,null,void 0,0,this.viewBindGroups,{meshInstances:n,splitLights:s,lightClusters:r});},t}(s2),mH=new eW,mW=function(){function e(e,t,n,i,r){this.device=e,this.root=t,this.scene=n,this.renderer=i,this.assets=r,this.shadowMapCache=i.shadowMapCache,this._tempSet=new Set,this._initCalled=false,this.passMaterials=[],this.ambientAOMaterial=null,this.fog="",this.ambientLight=new eN,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0};}var t=e.prototype;return t.destroy=function(){var e;lS.decRef(this.blackTex),this.blackTex=null,lS.destroy(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null,null==(e=this.camera)||e.destroy(),this.camera=null;},t.initBake=function(e){if(this.bakeHDR=7!==this.scene.lightmapPixelFormat,!this._initCalled){this._initCalled=true,this.lightmapFilters=new mz(e),this.constantBakeDir=e.scope.resolve("bakeDir"),this.materials=[],this.blackTex=new nO(this.device,{width:4,height:4,format:7,type:t1,name:"lightmapBlack"}),lS.incRef(this.blackTex);var t=new lZ;t.clearColor.set(0,0,0,0),t.clearColorBuffer=true,t.clearDepthBuffer=false,t.clearStencilBuffer=false,t.frustumCulling=false,t.projection=1,t.aspectRatio=1,t.node=new us,this.camera=t,this.camera.shaderParams.gammaCorrection=0,this.camera.shaderParams.toneMapping=0;}if(this.scene.clusteredLightingEnabled){var n=new c9(e.supportsAreaLights,e.maxTextureSize,function(){});this.lightingParams=n;var i=this.scene.lighting;n.shadowsEnabled=i.shadowsEnabled,n.shadowAtlasResolution=i.shadowAtlasResolution,n.cookiesEnabled=i.cookiesEnabled,n.cookieAtlasResolution=i.cookieAtlasResolution,n.areaLightsEnabled=i.areaLightsEnabled,n.cells=new eW(3,3,3),n.maxLightsPerCell=4,this.worldClusters=new uT(e),this.worldClusters.name="ClusterLightmapper";}},t.finishBake=function(e){function t(e){lS.decRef(e.colorBuffer),e.destroy();}this.materials=[],this.renderTargets.forEach(function(e){t(e);}),this.renderTargets.clear(),e.forEach(function(e){e.renderTargets.forEach(function(e){t(e);}),e.renderTargets.length=0;}),this.ambientAOMaterial=null,this.worldClusters&&(this.worldClusters.destroy(),this.worldClusters=null);},t.createMaterialForPass=function(e,t,n){var i=new dw;return i.name="lmMaterial-pass:"+t+"-ambient:"+n,i.setDefine("UV1LAYOUT",""),i.setDefine("LIT_LIGHTMAP_BAKING",""),0===t?(i.setDefine("LIT_LIGHTMAP_BAKING_COLOR",""),n?i.setDefine("LIT_LIGHTMAP_BAKING_ADD_AMBIENT",""):i.ambient=new eN(0,0,0),this.bakeHDR||i.setDefine("LIGHTMAP_RGBM",""),i.lightMap=this.blackTex):(i.setDefine("LIT_LIGHTMAP_BAKING_DIR",""),i.setDefine("STD_LIGHTMAP_DIR","")),i.cull=0,i.forceUv1=true,i.update(),i},t.createMaterials=function(e,t,n){for(var i=0;i<n;i++)this.passMaterials[i]||(this.passMaterials[i]=this.createMaterialForPass(t,i,false));this.ambientAOMaterial||(this.ambientAOMaterial=this.createMaterialForPass(t,0,true),this.ambientAOMaterial.onUpdateShader=function(e){return e.litOptions.lightMapWithoutAmbient=true,e.litOptions.separateAmbient=true,e});},t.createTexture=function(e,t){return new nO(this.device,{width:e,height:e,format:this.scene.lightmapPixelFormat,mipmaps:false,type:this.bakeHDR?t0:t1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:t})},t.collectModels=function(e,t,n){if(e.enabled){if((null==(i=e.model)?void 0:i.model)&&(null==(r=e.model)?void 0:r.enabled)&&(n&&n.push(new mF(e)),e.model.lightmapped&&t&&(a=e.model.model.meshInstances)),(null==(s=e.render)?void 0:s.enabled)&&(n&&n.push(new mF(e)),e.render.lightmapped&&t&&(a=e.render.meshInstances)),a){for(var i,r,s,a,o=true,l=0;l<a.length;l++)if(!a[l].mesh.vertexBuffer.format.hasUv1){o=false;break}if(o){for(var u=[],c=0;c<a.length;c++){var h=a[c].mesh;this._tempSet.has(h)?t.push(new mF(e,[a[c]])):u.push(a[c]),this._tempSet.add(h);}this._tempSet.clear(),u.length>0&&t.push(new mF(e,u));}}for(var f=0;f<e._children.length;f++)this.collectModels(e._children[f],t,n);}},t.prepareShadowCasters=function(e){for(var t=[],n=0;n<e.length;n++){var i=e[n].component;if(i.castShadows=i.castShadowsLightmap,i.castShadowsLightmap)for(var r=e[n].meshInstances,s=0;s<r.length;s++)r[s].visibleThisFrame=true,t.push(r[s]);}return t},t.updateTransforms=function(e){for(var t=0;t<e.length;t++)for(var n=e[t].meshInstances,i=0;i<n.length;i++)n[i].node.getWorldTransform();},t.calculateLightmapSize=function(e){var t,n,i,r=this.scene.lightmapSizeMultiplier||16;e.model?(i=e.model.lightmapSizeMultiplier,e.model.asset?(t=this.assets.get(e.model.asset).data).area&&(n=t.area):e.model._area&&(t=e.model)._area&&(n=t._area)):e.render&&(i=e.render.lightmapSizeMultiplier,"asset"!==e.render.type&&e.render._area&&(t=e.render)._area&&(n=t._area));var s={x:1,y:1,z:1,uv:1};n&&(s.x=n.x,s.y=n.y,s.z=n.z,s.uv=n.uv);var a=i||1;s.x*=a,s.y*=a,s.z*=a;var o=e.render||e.model,l=this.computeNodeBounds(o.meshInstances);mH.copy(l.halfExtents);var u=s.x*mH.y*mH.z+s.y*mH.x*mH.z+s.z*mH.x*mH.y;return u/=s.uv,u=Math.sqrt(u),Math.min(ek.nextPowerOfTwo(u*r),this.scene.lightmapMaxResolution||2048)},t.setLightmapping=function(e,t,n,i){for(var r=0;r<e.length;r++)for(var s=e[r],a=s.meshInstances,o=0;o<a.length;o++){var l=a[o];if(l.setLightmapped(t),t){i&&(l._shaderDefs|=i),l.mask=2;for(var u=0;u<n;u++){var c=s.renderTargets[u].colorBuffer;c.minFilter=1,c.magFilter=1,l.setRealtimeLightmap(lL.lightmapParamNames[u],c);}}}},t.bake=function(e,t){ void 0===t&&(t=1);var n=this.device,i=eL();this.scene._updateSkyMesh(),this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;var r=n._shaderStats.linked,s=n._renderTargetCreationTime,a=n._shaderStats.compileTime,o=[],l=[];if(e){for(var u=0;u<e.length;u++)this.collectModels(e[u],o,null);this.collectModels(this.root,null,l);}else this.collectModels(this.root,o,l);if(o.length>0){this.renderer.shadowRenderer.frameUpdate();var c=1===t?2:1;this.setLightmapping(o,false,c),this.initBake(n),this.bakeInternal(c,o,l);var h=64;1===t&&(h|=128),this.scene.ambientBake&&(h|=4096),this.setLightmapping(o,true,c,h),this.finishBake(o);}var f=eL();this.stats.totalRenderTime=f-i,this.stats.shadersLinked=n._shaderStats.linked-r,this.stats.compileTime=n._shaderStats.compileTime-a,this.stats.fboTime=n._renderTargetCreationTime-s,this.stats.lightmapCount=o.length;},t.allocateTextures=function(e,t){for(var n=0;n<e.length;n++){for(var i=e[n],r=this.calculateLightmapSize(i.node),s=0;s<t;s++){var a=this.createTexture(r,"lightmapper_lightmap_"+n);lS.incRef(a),i.renderTargets[s]=new il({colorBuffer:a,depth:false});}if(!this.renderTargets.has(r)){var o=this.createTexture(r,"lightmapper_temp_lightmap_"+r);lS.incRef(o),this.renderTargets.set(r,new il({colorBuffer:o,depth:false}));}}},t.prepareLightsToBake=function(e,t){if(this.scene.ambientBake){var n=new mN(this);t.push(n);}for(var i=this.renderer.lights,r=0;r<i.length;r++){var s=i[r],a=new mR(this,s);e.push(a),s.enabled&&(4&s.mask)!=0&&(s.mask=7,s.shadowUpdateMode=0===s.type?2:1,t.push(a));}t.sort();},t.restoreLights=function(e){for(var t=0;t<e.length;t++)e[t].restore();},t.setupScene=function(){this.ambientLight.copy(this.scene.ambientLight),this.scene.ambientBake||this.scene.ambientLight.set(0,0,0),this.renderer.setSceneConstants(),this.device.scope.resolve("ambientBakeOcclusionContrast").setValue(this.scene.ambientBakeOcclusionContrast),this.device.scope.resolve("ambientBakeOcclusionBrightness").setValue(this.scene.ambientBakeOcclusionBrightness);},t.restoreScene=function(){this.scene.ambientLight.copy(this.ambientLight);},t.computeNodeBounds=function(e){var t=new e8;if(e.length>0){t.copy(e[0].aabb);for(var n=1;n<e.length;n++)t.add(e[n].aabb);}return t},t.computeNodesBounds=function(e){for(var t=0;t<e.length;t++){var n=e[t].meshInstances;e[t].bounds=this.computeNodeBounds(n);}},t.computeBounds=function(e){for(var t=new e8,n=0;n<e.length;n++){t.copy(e[0].aabb);for(var i=1;i<e.length;i++)t.add(e[i].aabb);}return t},t.backupMaterials=function(e){for(var t=0;t<e.length;t++)this.materials[t]=e[t].material;},t.restoreMaterials=function(e){for(var t=0;t<e.length;t++)e[t].material=this.materials[t];},t.lightCameraPrepare=function(e,t){var n,i=t.light;return 2===i.type&&((n=i.getRenderData(null,0).shadowCamera)._node.setPosition(i._node.getPosition()),n._node.setRotation(i._node.getRotation()),n._node.rotateLocal(-90,0,0),n.projection=0,n.nearClip=i.attenuationEnd/1e3,n.farClip=i.attenuationEnd,n.aspectRatio=1,n.fov=2*i._outerConeAngle,this.renderer.updateCameraFrustum(n)),n},t.lightCameraPrepareAndCull=function(e,t,n,i){var r=e.light,s=true;if(0===r.type){mH.copy(i.center),mH.y+=i.halfExtents.y,this.camera.node.setPosition(mH),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=2*i.halfExtents.y;var a=Math.max(i.halfExtents.x,i.halfExtents.z);this.camera.orthoHeight=a;}else e.lightBounds.intersects(t.bounds)||(s=false);if(2===r.type){for(var o=false,l=t.meshInstances,u=0;u<l.length;u++)if(l[u]._isVisible(n)){o=true;break}o||(s=false);}return s},t.setupLightArray=function(e,t){e[0].length=0,e[1].length=0,e[2].length=0,e[t.type][0]=t,t.visibleThisFrame=true;},t.renderShadowMap=function(e,t,n,i){var r=i.light,s=this.scene.clusteredLightingEnabled,a=r.castShadows&&(!s||this.scene.lighting.shadowsEnabled);if(!t&&a)if(r.shadowMap||s||(r.shadowMap=this.shadowMapCache.get(this.device,r)),0===r.type){this.renderer._shadowRendererDirectional.cull(r,e,this.camera,n);var o=this.renderer._shadowRendererDirectional.getLightRenderPass(r,this.camera);null==o||o.render();}else {if(this.device.isWebGPU)return  true;this.renderer._shadowRendererLocal.cull(r,e,n),this.renderer.shadowRenderer.render(r,this.camera,false);}return  true},t.postprocessTextures=function(e,t,n){var i,r=this.lightmapFilters.getDilate(e,this.bakeHDR),s=this.scene.lightmapFilterEnabled;s&&(this.lightmapFilters.prepareDenoise(this.scene.lightmapFilterRange,this.scene.lightmapFilterSmoothness,this.bakeHDR),i=this.lightmapFilters.getDenoise(this.bakeHDR)),e.setBlendState(nj.NOBLEND),e.setDepthState(nq.NODEPTH),e.setStencilState(null,null);for(var a=0;a<t.length;a++)for(var o=t[a],l=0;l<n;l++){var u=o.renderTargets[l],c=u.colorBuffer,h=this.renderTargets.get(c.width),f=h.colorBuffer;this.lightmapFilters.prepare(c.width,c.height);for(var d=0;d<1;d++)this.lightmapFilters.setSourceTexture(c),ls(e,h,s&&0===l&&0===d?i:r),this.lightmapFilters.setSourceTexture(f),ls(e,u,r);}},t.bakeInternal=function(e,t,n){var r,s,a,o,l,u,c=this.scene,h=c.layers,f=this.device,d=c.clusteredLightingEnabled;this.createMaterials(f,c,e),this.setupScene(),h._update(),this.computeNodesBounds(t),this.allocateTextures(t,e),this.renderer.collectLights(h);var p=[],m=[];this.prepareLightsToBake(p,m),this.updateTransforms(n);var _=this.prepareShadowCasters(n);this.renderer.updateCpuSkinMatrices(_),this.renderer.gpuUpdate(_);var v=this.computeBounds(_);for(r=0;r<t.length;r++)for(s=0,a=t[r].meshInstances;s<a.length;s++)(o=a[s]).setLightmapped(false),o.mask=4,o.setRealtimeLightmap(lL.lightmapParamNames[0],this.blackTex),o.setRealtimeLightmap(lL.lightmapParamNames[1],this.blackTex);for(s=0;s<m.length;s++)m[s].light.enabled=false;var g=[[],[],[]],y=false;for(r=0;r<m.length;r++){var S=m[r],x=null!=mN&&"undefined"!=typeof Symbol&&mN[Symbol.hasInstance]?!!mN[Symbol.hasInstance](S):i(S,mN),b=0===S.light.type,T=S.numVirtualLights;e>1&&T>1&&S.light.bakeDir&&(T=1);for(var E=0;E<T;E++){T>1&&S.prepareVirtualLight(E,T),S.startBake();var w=false,A=this.lightCameraPrepare(f,S);for(u=0;u<t.length;u++){var C=t[u];if(a=C.meshInstances,this.lightCameraPrepareAndCull(S,C,A,v)){this.setupLightArray(g,S.light);var P=b?[]:[S.light];for(d&&this.renderer.lightTextureAtlas.update(P,this.lightingParams),w=this.renderShadowMap(h,w,_,S),d&&this.worldClusters.update(P,this.lightingParams),this.backupMaterials(a),l=0;l<e&&(!(l>0)||!(E>0))&&(!x||!(l>0));l++){var I=C.renderTargets[l],L=C.renderTargets[l].colorBuffer.width,D=this.renderTargets.get(L),M=D.colorBuffer;0===l?y=c.updateShaders:y&&(c.updateShaders=true);var R=this.passMaterials[l];for(x&&E+1===T&&0===l&&(R=this.ambientAOMaterial),s=0;s<a.length;s++)a[s].material=R;if(this.renderer.updateShaders(a),1===l&&this.constantBakeDir.setValue(+!!S.light.bakeDir),f.isWebGPU){var O=new mG(f,this.renderer,this.camera,d?this.worldClusters:null,a,g);O.init(D),O.render(),O.destroy();}else this.renderer.setCamera(this.camera,D,true),d&&this.worldClusters.activate(),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,D,a,g,0),f.updateEnd();for(C.renderTargets[l]=D,this.renderTargets.set(L,I),s=0;s<a.length;s++)(o=a[s]).setRealtimeLightmap(lL.lightmapParamNames[l],M),o._shaderDefs|=64;}this.restoreMaterials(a);}}S.endBake(this.shadowMapCache);}}for(this.postprocessTextures(f,t,e),u=0;u<n.length;u++)n[u].restore();this.restoreLights(p),this.restoreScene(),d||this.shadowMapCache.clear();},e}();function mj(e,t){return (mj=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var mX=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this)||this).system=t,i.entity=n,i.system.schema&&!i._accessorsBuilt&&i.buildAccessors(i.system.schema),i.on("set",function(e,t,n){this.fire("set_"+e,e,t,n);}),i.on("set_enabled",i.onSetEnabled,i),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&mj(t,e);var n,i=t.prototype;return i.buildAccessors=function(e){t._buildAccessors(this,e);},i.onSetEnabled=function(e,t,n){t!==n&&this.entity.enabled&&(n?this.onEnable():this.onDisable());},i.onEnable=function(){},i.onDisable=function(){},i.onPostStateChange=function(){},t._buildAccessors=function(e,t){t.forEach(function(t){var n=(void 0===t?"undefined":t&&"undefined"!=typeof Symbol&&t.constructor===Symbol?"symbol":typeof t)=="object"?t.name:t;Object.defineProperty(e,n,{get:function(){return this.data[n]},set:function(e){var t=this.data,i=t[n];t[n]=e,this.fire("set",n,i,e);},configurable:true});}),e._accessorsBuilt=true;},n=[{key:"data",get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}},{key:"enabled",get:function(){return  true},set:function(e){}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function mY(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function mq(e,t){return (mq=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function mK(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}mX.order=0;var mZ=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this).app=t,n.store={},n.schema=[],n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&mq(t,e);var n=t.prototype;return n.addComponent=function(e,t){ void 0===t&&(t={});var n=new this.ComponentType(this,e),i=new this.DataType;return this.store[e.getGuid()]={entity:e,data:i},e[this.id]=n,e.c[this.id]=n,this.initializeComponentData(n,t,[]),this.fire("add",e,n),n},n.removeComponent=function(e){var t=this.id,n=this.store[e.getGuid()],i=e.c[t];i.fire("beforeremove"),this.fire("beforeremove",e,i),delete this.store[e.getGuid()],e[t]=void 0,delete e.c[t],this.fire("remove",e,n.data);},n.cloneComponent=function(e,t){var n=this.store[e.getGuid()];return this.addComponent(t,n.data)},n.initializeComponentData=function(e,t,n){ void 0===t&&(t={});for(var i=0,r=n.length;i<r;i++){var s=n[i],a=void 0,o=void 0;(void 0===s?"undefined":mK(s))==="object"?(a=s.name,o=s.type):(a=s,o=void 0);var l=t[a];void 0!==l?(void 0!==o&&(l=function(e,t){if(!e)return e;switch(t){case "rgb":if(mY(e,eN))return e.clone();return new eN(e[0],e[1],e[2]);case "rgba":if(mY(e,eN))return e.clone();return new eN(e[0],e[1],e[2],e[3]);case "vec2":if(mY(e,eX))return e.clone();return new eX(e[0],e[1]);case "vec3":if(mY(e,eW))return e.clone();return new eW(e[0],e[1],e[2]);case "vec4":if(mY(e,eY))return e.clone();return new eY(e[0],e[1],e[2],e[3]);case "boolean":case "number":case "string":case "entity":return e;default:throw Error("Could not convert unhandled type: "+t)}}(l,o)),e[a]=l):e[a]=e.data[a];}e.enabled&&e.entity.enabled&&e.onEnable();},n.getPropertiesOfType=function(e){var t=[];return (this.schema||[]).forEach(function(n){n&&(void 0===n?"undefined":mK(n))==="object"&&n.type===e&&t.push(n);}),t},n.destroy=function(){this.off();},t}(ex),mQ=function(){function e(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:false,p0:0,m0:0,p1:0,m1:0};}var t=e.prototype;return t.update=function(e,t){if(e<this._left||e>=this._right){var n=t.length;if(n)if(e<t[0])this._left=-1/0,this._right=t[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(e>=t[n-1])this._left=t[n-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=n-1;else {var i=this._findKey(e,t);this._left=t[i],this._right=t[i+1],this._len=this._right-this._left;var r=1/this._len;this._recip=isFinite(r)?r:0,this._p0=i,this._p1=i+1;}else this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0;}this._t=0===this._recip?0:(e-this._left)*this._recip,this._hermite.valid=false;},t._findKey=function(e,t){for(var n=0;e>=t[n+1];)n++;return n},t.eval=function(e,t,n){var i=n._data,r=n._components,s=this._p0*r;if(0===t)for(var a=0;a<r;++a)e[a]=i[s+a];else {var o=this._t,l=this._p1*r;switch(t){case 1:for(var u=0;u<r;++u)e[u]=ek.lerp(i[s+u],i[l+u],o);break;case 2:var c=this._hermite;if(!c.valid){var h=o*o,f=o+o,d=1-o,p=d*d;c.valid=true,c.p0=(1+f)*p,c.m0=o*p,c.p1=h*(3-f),c.m1=h*(o-1);}for(var m=(3*this._p0+1)*r,_=(3*this._p0+2)*r,v=(3*this._p1+1)*r,g=(3*this._p1+0)*r,y=0;y<r;++y)e[y]=c.p0*i[m+y]+c.m0*i[_+y]*this._len+c.p1*i[v+y]+c.m1*i[g+y]*this._len;}}},e}(),mJ=function(e){this._name=""+e.name+"Snapshot",this._time=-1,this._cache=[],this._results=[];for(var t=0;t<e._inputs.length;++t)this._cache[t]=new mQ;for(var n=e._curves,i=e._outputs,r=0;r<n.length;++r){for(var s=i[n[r]._output],a=[],o=0;o<s._components;++o)a[o]=0;this._results[r]=a;}};function m$(){return (m$=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);}return e}).apply(this,arguments)}var m0=function(){function e(e,t,n,i,r,s){this._name=e.name,this._track=e,this._snapshot=new mJ(e),this._playing=i,this._time=t,this._speed=n,this._loop=r,this._blendWeight=1,this._blendOrder=0,this._eventHandler=s,this.alignCursorToCurrentTime();}var t,n=e.prototype;return n.nextEventAheadOfTime=function(e){return !!this.nextEvent&&(this.isReverse?this.nextEvent.time<=e:this.nextEvent.time>=e)},n.nextEventBehindTime=function(e){return !!this.nextEvent&&(e===this.track.duration?this.isReverse?this.nextEvent.time>=e:this.nextEvent.time<=e:this.isReverse?this.nextEvent.time>e:this.nextEvent.time<e)},n.resetEventCursor=function(){this._eventCursor=this.isReverse?this._track.events.length-1:0;},n.moveEventCursor=function(){this._eventCursor+=this.isReverse?-1:1,this._eventCursor>=this.track.events.length?this._eventCursor=0:this._eventCursor<0&&(this._eventCursor=this.track.events.length-1);},n.clipFrameTime=function(t){var n=e.eventFrame;n.start=0,n.end=t,n.residual=0,this.isReverse?t<0&&(n.start=this.track.duration,n.end=0,n.residual=t+this.track.duration):t>this.track.duration&&(n.start=0,n.end=this.track.duration,n.residual=t-this.track.duration);},n.alignCursorToCurrentTime=function(){for(this.resetEventCursor();this.nextEventBehindTime(this._time)&&this._eventCursor!==this.eventCursorEnd;)this.moveEventCursor();},n.fireNextEvent=function(){this._eventHandler.fire(this.nextEvent.name,m$({track:this.track},this.nextEvent)),this.moveEventCursor();},n.fireNextEventInFrame=function(e,t){return !!(this.nextEventAheadOfTime(e)&&this.nextEventBehindTime(t))&&(this.fireNextEvent(),true)},n.activeEventsForFrame=function(t,n){var i=e.eventFrame;this.clipFrameTime(n);for(var r=this.eventCursor;this.fireNextEventInFrame(t,i.end)&&r!==this.eventCursor;);this.loop&&Math.abs(i.residual)>0&&this.activeEventsForFrame(i.start,i.residual);},n.progressForTime=function(e){return e*this._speed/this._track.duration},n._update=function(e){if(this._playing){var t=this._time,n=this._track.duration,i=this._speed,r=this._loop;this._track.events.length>0&&n>0&&this.activeEventsForFrame(t,t+i*e),t+=i*e,i>=0?t>n&&(r?t=t%n||0:(t=this._track.duration,this.pause())):t<0&&(r?t=n+(t%n||0):(t=0,this.pause())),this._time=t;}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot);},n.play=function(){this._playing=true,this._time=0;},n.stop=function(){this._playing=false,this._time=0;},n.pause=function(){this._playing=false;},n.resume=function(){this._playing=true;},n.reset=function(){this._time=0;},t=[{key:"name",get:function(){return this._name},set:function(e){this._name=e;}},{key:"track",get:function(){return this._track},set:function(e){this._track=e,this._snapshot=new mJ(e);}},{key:"snapshot",get:function(){return this._snapshot}},{key:"time",get:function(){return this._time},set:function(e){this._time=e,this.alignCursorToCurrentTime();}},{key:"speed",get:function(){return this._speed},set:function(e){var t=Math.sign(e)!==Math.sign(this._speed);this._speed=e,t&&this.alignCursorToCurrentTime();}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e;}},{key:"blendWeight",get:function(){return this._blendWeight},set:function(e){this._blendWeight=e;}},{key:"blendOrder",get:function(){return this._blendOrder},set:function(e){this._blendOrder=e;}},{key:"eventCursor",get:function(){return this._eventCursor},set:function(e){this._eventCursor=e;}},{key:"eventCursorEnd",get:function(){return this.isReverse?0:this._track.events.length-1}},{key:"nextEvent",get:function(){return this._track.events[this._eventCursor]}},{key:"isReverse",get:function(){return this._speed<0}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();m0.eventFrame={start:0,end:0,residual:0};var m1="NONE",m2="PREV_STATE",m3="NEXT_STATE",m4="PREV_STATE_NEXT_STATE",m5="NEXT_STATE_PREV_STATE",m8="GREATER_THAN",m6="LESS_THAN",m9="GREATER_THAN_EQUAL_TO",m7="LESS_THAN_EQUAL_TO",_e="EQUAL_TO",_t="NOT_EQUAL_TO",_n="INTEGER",_i="FLOAT",_r="BOOLEAN",_s="TRIGGER",_a="2D_DIRECTIONAL",_o="2D_CARTESIAN",_l="DIRECT",_u="START",_c=[_u,"END","ANY"],_h="OVERWRITE",_f="ADDITIVE",_d=function(){function e(){}return e.dot=function(e,t){for(var n=e.length,i=0,r=0;r<n;++r)i+=e[r]*t[r];return i},e.normalize=function(t){var n=e.dot(t,t);if(n>0){n=1/Math.sqrt(n);for(var i=t.length,r=0;r<i;++r)t[r]*=n;}},e.set=function(t,n,i){var r=t.length;if("quaternion"===i){var s=e.dot(n,n);s>0&&(s=1/Math.sqrt(s));for(var a=0;a<r;++a)t[a]=n[a]*s;}else for(var o=0;o<r;++o)t[o]=n[o];},e.blendVec=function(e,t,n,i){for(var r=i?1:1-n,s=e.length,a=0;a<s;++a)e[a]=e[a]*r+t[a]*n;},e.blendQuat=function(t,n,i,r){var s=t.length,a=r?1:1-i;0>e.dot(t,n)&&(i=-i);for(var o=0;o<s;++o)t[o]=t[o]*a+n[o]*i;r||e.normalize(t);},e.blend=function(t,n,i,r,s){"quaternion"===r?e.blendQuat(t,n,i,s):e.blendVec(t,n,i,s);},e.stableSort=function(e,t){for(var n=e.length,i=0;i<n-1;++i)for(var r=i+1;r<n;++r)if(t(e[r],e[i])){var s=e[i];e[i]=e[r],e[r]=s;}},e}(),_p=function(){function e(t,n){this._component=t,this.mask=new Int8Array(t.layers.length),this.weights=new Float32Array(t.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=n,this.dirty=true,this.value=n===e.TYPE_QUAT?[0,0,0,1]:[0,0,0],this.baseValue=null,this.setter=null;}var t,n=e.prototype;return n.getWeight=function(e){return (this.dirty&&this.updateWeights(),this._normalizeWeights&&0===this.totalWeight||!this.mask[e])?0:this._normalizeWeights?this.weights[e]/this.totalWeight:ek.clamp(this.weights[e],0,1)},n._layerBlendType=function(e){return this._component.layers[e].blendType},n.setMask=function(e,t){this.mask[e]=t,this._normalizeWeights&&(this._component.layers[e].blendType===_h&&(this.mask=this.mask.fill(0,0,e)),this.dirty=true);},n.updateWeights=function(){this.totalWeight=0;for(var e=0;e<this.weights.length;e++)this.weights[e]=this._component.layers[e].weight,this.totalWeight+=this.mask[e]*this.weights[e];this.dirty=false;},n.updateValue=function(t,n){if(0===this.counter&&(_d.set(this.value,e.IDENTITY_QUAT_ARR,this.valueType),this._normalizeWeights||_d.blend(this.value,this.baseValue,1,this.valueType)),this.mask[t]&&0!==this.getWeight(t)){if(this._layerBlendType(t)!==_f||this._normalizeWeights)_d.blend(this.value,n,this.getWeight(t),this.valueType);else if(this.valueType===e.TYPE_QUAT){var i=e.q1.set(this.value[0],this.value[1],this.value[2],this.value[3]),r=e.q2.set(this.baseValue[0],this.baseValue[1],this.baseValue[2],this.baseValue[3]),s=e.q3.set(n[0],n[1],n[2],n[3]),a=r.invert().mul(s);a.slerp(e0.IDENTITY,a,this.getWeight(t)),i.mul(a),e.quatArr[0]=i.x,e.quatArr[1]=i.y,e.quatArr[2]=i.z,e.quatArr[3]=i.w,_d.set(this.value,e.quatArr,this.valueType);}else e.vecArr[0]=n[0]-this.baseValue[0],e.vecArr[1]=n[1]-this.baseValue[1],e.vecArr[2]=n[2]-this.baseValue[2],_d.blend(this.value,e.vecArr,this.getWeight(t),this.valueType,true);this.setter&&this.setter(this.value);}},n.unbind=function(){this.setter&&this.setter(this.baseValue);},t=[{key:"_normalizeWeights",get:function(){return this._component.normalizeWeights}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();_p.TYPE_QUAT="quaternion",_p.TYPE_VEC3="vector3",_p.q1=new e0,_p.q2=new e0,_p.q3=new e0,_p.quatArr=[0,0,0,1],_p.vecArr=[0,0,0],_p.IDENTITY_QUAT_ARR=[0,0,0,1];var _m=function(){function e(e){this._binder=e,this._clips=[],this._inputs=[],this._outputs=[],this._targets={};}var t,n=e.prototype;return n.addClip=function(e){for(var t=this._targets,n=this._binder,i=e.track.curves,r=e.snapshot,s=[],a=[],o=0;o<i.length;++o)for(var l=i[o].paths,u=0;u<l.length;++u){var c=l[u],h=n.resolve(c),f=t[h&&h.targetPath||null];if(!f&&h){f={target:h,value:[],curves:0,blendCounter:0};for(var d=0;d<f.target.components;++d)f.value.push(0);if(t[h.targetPath]=f,n.animComponent){if(!n.animComponent.targets[h.targetPath]){var p=void 0;p="localRotation"===h.targetPath.substring(h.targetPath.length-13)?_p.TYPE_QUAT:_p.TYPE_VEC3,n.animComponent.targets[h.targetPath]=new _p(n.animComponent,p);}n.animComponent.targets[h.targetPath].layerCounter++,n.animComponent.targets[h.targetPath].setMask(n.layerIndex,1);}}f&&(f.curves++,s.push(r._results[o]),a.push(f));}this._clips.push(e),this._inputs.push(s),this._outputs.push(a);},n.removeClip=function(e){for(var t=this._targets,n=this._binder,i=this._clips,r=i[e].track.curves,s=0;s<r.length;++s)for(var a=r[s].paths,o=0;o<a.length;++o){var l=a[o],u=this._binder.resolve(l);u&&(u.curves--,0===u.curves&&(n.unresolve(l),delete t[u.targetPath],n.animComponent&&n.animComponent.targets[u.targetPath].layerCounter--));}i.splice(e,1),this._inputs.splice(e,1),this._outputs.splice(e,1);},n.removeClips=function(){for(;this._clips.length>0;)this.removeClip(0);},n.updateClipTrack=function(e,t){this._clips.forEach(function(n){n.name.includes(e)&&(n.track=t);}),this.rebind();},n.findClip=function(e){for(var t=this._clips,n=0;n<t.length;++n){var i=t[n];if(i.name===e)return i}return null},n.rebind=function(){var e=this;this._binder.rebind(),this._targets={};var t=[].concat(this.clips);this.removeClips(),t.forEach(function(t){e.addClip(t);});},n.assignMask=function(e){return this._binder.assignMask(e)},n.update=function(e,t){ void 0===t&&(t=true);var n=this._clips,i=n.map(function(e,t){return t});_d.stableSort(i,function(e,t){return n[e].blendOrder<n[t].blendOrder});for(var r=0;r<i.length;++r){var s=i[r],a=n[s],o=this._inputs[s],l=this._outputs[s],u=a.blendWeight;if(u>0&&a._update(e),!t)break;var c=void 0,h=void 0,f=void 0;if(u>=1)for(var d=0;d<o.length;++d)c=o[d],f=(h=l[d]).value,_d.set(f,c,h.target.type),h.blendCounter++;else if(u>0)for(var p=0;p<o.length;++p)c=o[p],f=(h=l[p]).value,0===h.blendCounter?_d.set(f,c,h.target.type):_d.blend(f,c,u,h.target.type),h.blendCounter++;}var m=this._targets,_=this._binder;for(var v in m)if(m.hasOwnProperty(v)){var g=m[v];if(_.animComponent&&g.target.isTransform){var y=_.animComponent.targets[v];y.counter===y.layerCounter&&(y.counter=0),y.path||(y.path=v,y.baseValue=g.target.get(),y.setter=g.target.set),y.updateValue(_.layerIndex,g.value),y.counter++;}else g.target.set(g.value);g.blendCounter=0;}this._binder.update(e);},t=[{key:"clips",get:function(){return this._clips}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),__=function(){var e;function t(e){this._events=[].concat(e),this._events.sort(function(e,t){return e.time-t.time});}return e=[{key:"events",get:function(){return this._events}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}(),_v=function(){var e;function t(e,t,n,i,r,s){ void 0===s&&(s=new __([])),this._name=e,this._duration=t,this._inputs=n,this._outputs=i,this._curves=r,this._animEvents=s;}return t.prototype.eval=function(e,t){t._time=e;for(var n=this._inputs,i=this._outputs,r=this._curves,s=t._cache,a=t._results,o=0;o<n.length;++o)s[o].update(e,n[o]._data);for(var l=0;l<r.length;++l){var u=r[l],c=i[u._output],h=a[l];s[u._input].eval(h,u._interpolation,c);}},e=[{key:"name",get:function(){return this._name}},{key:"duration",get:function(){return this._duration}},{key:"inputs",get:function(){return this._inputs}},{key:"outputs",get:function(){return this._outputs}},{key:"curves",get:function(){return this._curves}},{key:"events",get:function(){return this._animEvents.events},set:function(e){this._animEvents=e;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}();_v.EMPTY=Object.freeze(new _v("empty",Number.MAX_VALUE,[],[],[]));var _g=function(){function e(){}var t=e.prototype;return t.resolve=function(e){return null},t.unresolve=function(e){},t.update=function(e){},e.joinPath=function(e,t){return t=t||".",e.map(function(e){return e.replace(/\\/g,"\\\\").replace(RegExp("\\"+t,"g"),"\\"+t)}).join(t)},e.splitPath=function(e,t){t=t||".";for(var n=[],i="",r=0;r<e.length;){var s=e[r++];"\\"===s&&r<e.length?"\\"===(s=e[r++])||s===t?i+=s:i+="\\"+s:s===t?(n.push(i),i=""):i+=s;}return i.length>0&&n.push(i),n},e.encode=function(e,t,n){return (Array.isArray(e)?e.join("/"):e)+"/"+t+"/"+(Array.isArray(n)?n.join("/"):n)},e}(),_y=function(){var e;function t(e,t,n,i){e.set?(this._set=e.set,this._get=e.get):this._set=e,this._type=t,this._components=n,this._targetPath=i,this._isTransform="localRotation"===this._targetPath.substring(this._targetPath.length-13)||"localPosition"===this._targetPath.substring(this._targetPath.length-13)||"localScale"===this._targetPath.substring(this._targetPath.length-10);}return e=[{key:"set",get:function(){return this._set}},{key:"get",get:function(){return this._get}},{key:"type",get:function(){return this._type}},{key:"components",get:function(){return this._components}},{key:"targetPath",get:function(){return this._targetPath}},{key:"isTransform",get:function(){return this._isTransform}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}(),_S=function(){function e(t){var n=this;if(this._isPathInMask=function(e,t){var i=n._mask[e];if(i&&(i.children||t&&false!==i.value))return  true;return  false},this.graph=t,t){this._mask=null;var r={},s=function(e){r[e.name]=e;for(var t=0;t<e.children.length;++t)s(e.children[t]);};s(t),this.nodes=r,this.targetCache={};var a=function(e){for(var t,n,r=e;r&&(t=r,null!=my&&"undefined"!=typeof Symbol&&my[Symbol.hasInstance]?!my[Symbol.hasInstance](t):!i(t,my));)r=r.parent;return r&&(r.render?n=r.render.meshInstances:r.model&&(n=r.model.meshInstances)),n};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(t){var n=t.localPosition;return e.createAnimTarget(function(e){n.set.apply(n,[].concat(e));},"vector",3,t,"localPosition")},localRotation:function(t){var n=t.localRotation;return e.createAnimTarget(function(e){n.set.apply(n,[].concat(e));},"quaternion",4,t,"localRotation")},localScale:function(t){var n=t.localScale;return e.createAnimTarget(function(e){n.set.apply(n,[].concat(e));},"vector",3,t,"localScale")},weight:function(t,n){n=0===n.indexOf("name.")?n.replace("name.",""):Number(n);var i,r=a(t);if(r)for(var s=0;s<r.length;++s){var o=s;if(r[o].node.name===t.name&&r[o].morphInstance){var l=r[o].morphInstance;i||(i=[]),i.push(function(e){l.setWeight(n,e[0]);});}}return i?e.createAnimTarget(function(e){for(var t=0;t<i.length;++t)i[t](e);},"number",1,t,"weight."+n):null},materialTexture:function(t,i){var r,s=a(t);if(s){for(var o=0;o<s.length;++o)if(s[o].node.name===t.name){r=s[o];break}if(r)return e.createAnimTarget(function(e){var t=n.animComponent.system.app.assets.get(e[0]);t&&t.resource&&"texture"===t.type&&(r.material[i]=t.resource,r.material.update());},"vector",1,t,"materialTexture","material")}return null}};}}var t=e.prototype;return t._isPathActive=function(e){if(!this._mask)return  true;for(var t=[e.entityPath[0],this.graph.name],n=0;n<t.length;++n){var i=t[n];if(this._isPathInMask(i,1===e.entityPath.length))return  true;for(var r=1;r<e.entityPath.length;r++)if(i+="/"+e.entityPath[r],this._isPathInMask(i,r===e.entityPath.length-1))return  true}return  false},t.findNode=function(e){var t;return this._isPathActive(e)?(this.graph&&((t=this.graph.findByPath(e.entityPath))||(t=this.graph.findByPath(e.entityPath.slice(1)))),t||(t=this.nodes[e.entityPath[e.entityPath.length-1]||""]),t):null},t.resolve=function(e){var t=_g.encode(e.entityPath,e.component,e.propertyPath),n=this.targetCache[t];if(n)return n;var i=this.findNode(e);if(!i)return null;var r=this.handlers[e.propertyPath];return r&&(n=r(i))?(this.targetCache[t]=n,this.nodeCounts[i.path]?this.nodeCounts[i.path]++:(this.activeNodes.push(i),this.nodeCounts[i.path]=1),n):null},t.unresolve=function(e){if("graph"===e.component){var t=this.nodes[e.entityPath[e.entityPath.length-1]||""];if(this.nodeCounts[t.path]--,0===this.nodeCounts[t.path]){var n=this.activeNodes,i=n.indexOf(t.node),r=n.length;i<r-1&&(n[i]=n[r-1]),n.pop();}}},t.update=function(e){for(var t=this.activeNodes,n=0;n<t.length;++n)t[n]._dirtifyLocal();},t.assignMask=function(e){return e!==this._mask&&(this._mask=e,true)},e.createAnimTarget=function(e,t,n,i,r,s){return new _y(e,t,n,_g.encode(i.path,s||"entity",r))},e}();function _x(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function _b(e,t){return (_b=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var _T=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return t=e.apply(this,arguments)||this,t._animations={},t._assets=[],t._loop=true,t.animEvaluator=null,t.model=null,t.skeleton=null,t.fromSkel=null,t.toSkel=null,t.animationsIndex={},t.prevAnim=null,t.currAnim=null,t.blend=0,t.blending=false,t.blendSpeed=0,t.activate=true,t.speed=1,t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&_b(t,e);var n,i=t.prototype;return i.play=function(e,t){if((void 0===t&&(t=0),this.enabled&&this.entity.enabled)&&this.animations[e]){if(this.prevAnim=this.currAnim,this.currAnim=e,this.model){this.skeleton||this.animEvaluator||this._createAnimationController();var n=this.animations[this.prevAnim],i=this.animations[this.currAnim];if(this.blending=t>0&&!!this.prevAnim,this.blending&&(this.blend=0,this.blendSpeed=1/t),this.skeleton&&(this.blending?(this.fromSkel.animation=n,this.fromSkel.addTime(this.skeleton._time),this.toSkel.animation=i):this.skeleton.animation=i),this.animEvaluator){var r=this.animEvaluator;if(this.blending)for(;r.clips.length>1;)r.removeClip(0);else this.animEvaluator.removeClips();var s=new m0(this.animations[this.currAnim],0,1,true,this.loop);s.name=this.currAnim,s.blendWeight=+!this.blending,s.reset(),this.animEvaluator.addClip(s);}}this.playing=true;}},i.getAnimation=function(e){return this.animations[e]},i.setModel=function(e){e!==this.model&&(this._resetAnimationController(),this.model=e,this.animations&&this.currAnim&&this.animations[this.currAnim]&&this.play(this.currAnim));},i.onSetAnimations=function(){var e=this.entity.model;if(e){var t=e.model;t&&t!==this.model&&this.setModel(t);}if(!this.currAnim&&this.activate&&this.enabled&&this.entity.enabled){var n=Object.keys(this._animations);n.length>0&&this.play(n[0]);}},i._resetAnimationController=function(){this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null;},i._createAnimationController=function(){var e=this.model,t=this.animations,n=false,i=false;for(var r in t)t.hasOwnProperty(r)&&(t[r].constructor===_v?i=true:n=true);var s=e.getGraph();n?(this.fromSkel=new fQ(s),this.toSkel=new fQ(s),this.skeleton=new fQ(s),this.skeleton.looping=this.loop,this.skeleton.setGraph(s)):i&&(this.animEvaluator=new _m(new _S(this.entity)));},i.loadAnimationAssets=function(e){var t=this;if(e&&e.length)for(var n=this.system.app.assets,i=function(e){if(e.resources.length>1)for(var n=0;n<e.resources.length;n++)t.animations[e.resources[n].name]=e.resources[n],t.animationsIndex[e.id]=e.resources[n].name;else t.animations[e.name]=e.resource,t.animationsIndex[e.id]=e.name;t.animations=t.animations;},r=function(e){e.off("change",t.onAssetChanged,t),e.on("change",t.onAssetChanged,t),e.off("remove",t.onAssetRemoved,t),e.on("remove",t.onAssetRemoved,t),e.resource?i(e):(e.once("load",i,t),t.enabled&&t.entity.enabled&&n.load(e));},s=0,a=e.length;s<a;s++){var o=n.get(e[s]);o?r(o):n.on("add:"+e[s],r);}},i.onAssetChanged=function(e,t,n,i){if("resource"===t||"resources"===t)if("resources"===t&&n&&0===n.length&&(n=null),n){var r=false;if(n.length>1){if(i&&i.length>1)for(var s=0;s<i.length;s++)delete this.animations[i[s].name];else delete this.animations[e.name];r=false;for(var a=0;a<n.length;a++)this.animations[n[a].name]=n[a],!r&&this.currAnim===n[a].name&&this.playing&&this.enabled&&this.entity.enabled&&(r=true,this.play(n[a].name));r||(this._stopCurrentAnimation(),this.onSetAnimations());}else {if(i&&i.length>1)for(var o=0;o<i.length;o++)delete this.animations[i[o].name];this.animations[e.name]=n[0]||n,r=false,this.currAnim===e.name&&this.playing&&this.enabled&&this.entity.enabled&&(r=true,this.play(e.name)),r||(this._stopCurrentAnimation(),this.onSetAnimations());}this.animationsIndex[e.id]=e.name;}else {if(i.length>1)for(var l=0;l<i.length;l++)delete this.animations[i[l].name],this.currAnim===i[l].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id];}},i.onAssetRemoved=function(e){if(e.off("remove",this.onAssetRemoved,this),this.animations){if(e.resources.length>1)for(var t=0;t<e.resources.length;t++)delete this.animations[e.resources[t].name],this.currAnim===e.resources[t].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id];}},i._stopCurrentAnimation=function(){if(this.currAnim=null,this.playing=false,this.skeleton&&(this.skeleton.currentTime=0,this.skeleton.animation=null),this.animEvaluator){for(var e=0;e<this.animEvaluator.clips.length;++e)this.animEvaluator.clips[e].stop();this.animEvaluator.update(0),this.animEvaluator.removeClips();}},i.onEnable=function(){e.prototype.onEnable.call(this);var t=this.assets,n=this.system.app.assets;if(t)for(var i=0,r=t.length;i<r;i++){var s=t[i];_x(s,pZ)||(s=n.get(s)),s&&!s.resource&&n.load(s);}if(this.activate&&!this.currAnim){var a=Object.keys(this.animations);a.length>0&&this.play(a[0]);}},i.onBeforeRemove=function(){for(var e=0;e<this.assets.length;e++){var t=this.assets[e];"number"==typeof t&&(t=this.system.app.assets.get(t)),t&&(t.off("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this));}this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null;},i.update=function(e){if(this.blending&&(this.blend+=e*this.blendSpeed,this.blend>=1&&(this.blend=1)),this.playing){var t=this.skeleton;if(null!==t&&null!==this.model){if(this.blending)t.blend(this.fromSkel,this.toSkel,this.blend);else {var n=e*this.speed;t.addTime(n),this.speed>0&&t._time===t.animation.duration&&!this.loop?this.playing=false:this.speed<0&&0===t._time&&!this.loop&&(this.playing=false);}this.blending&&1===this.blend&&(t.animation=this.toSkel.animation),t.updateGraph();}}var i=this.animEvaluator;if(i){for(var r=0;r<i.clips.length;++r){var s=i.clips[r];s.speed=this.speed,this.playing?s.resume():s.pause();}this.blending&&i.clips.length>1&&(i.clips[1].blendWeight=this.blend),i.update(e);}this.blending&&1===this.blend&&(this.blending=false);},n=[{key:"animations",get:function(){return this._animations},set:function(e){this._animations=e,this.onSetAnimations();}},{key:"assets",get:function(){return this._assets},set:function(e){var t=this._assets;if(t&&t.length){for(var n=0;n<t.length;n++)if(t[n]){var i=this.system.app.assets.get(t[n]);if(i){i.off("change",this.onAssetChanged,this),i.off("remove",this.onAssetRemoved,this);var r=this.animationsIndex[i.id];this.currAnim===r&&this._stopCurrentAnimation(),delete this.animations[r],delete this.animationsIndex[i.id];}}}this._assets=e;var s=e.map(function(e){return _x(e,pZ)?e.id:e});this.loadAnimationAssets(s);}},{key:"currentTime",get:function(){if(this.skeleton)return this.skeleton._time;if(this.animEvaluator){var e=this.animEvaluator.clips;if(e.length>0)return e[e.length-1].time}return 0},set:function(e){if(this.skeleton&&(this.skeleton.currentTime=e,this.skeleton.addTime(0),this.skeleton.updateGraph()),this.animEvaluator)for(var t=this.animEvaluator.clips,n=0;n<t.length;++n)t[n].time=e;}},{key:"duration",get:function(){return this.currAnim?this.animations[this.currAnim].duration:0}},{key:"loop",get:function(){return this._loop},set:function(e){if(this._loop=e,this.skeleton&&(this.skeleton.looping=e),this.animEvaluator)for(var t=0;t<this.animEvaluator.clips.length;++t)this.animEvaluator.clips[t].loop=e;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX),_E=function(){this.enabled=true;};function _w(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function _A(e,t){return (_A=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var _C=["enabled"],_P=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).id="animation",n.ComponentType=_T,n.DataType=_E,n.schema=_C,n.on("beforeremove",n.onBeforeRemove,n),n.app.systems.on("update",n.onUpdate,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&_A(t,e);var n=t.prototype;return n.initializeComponentData=function(t,n,i){i=["activate","enabled","loop","speed","assets"];for(var r,s=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return _w(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _w(e,void 0)}}(e))){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(i);!(r=s()).done;){var a=r.value;n.hasOwnProperty(a)&&(t[a]=n[a]);}e.prototype.initializeComponentData.call(this,t,n,_C);},n.cloneComponent=function(e,t){this.addComponent(t,{}),t.animation.assets=e.animation.assets.slice(),t.animation.speed=e.animation.speed,t.animation.loop=e.animation.loop,t.animation.activate=e.animation.activate,t.animation.enabled=e.animation.enabled;var n={},i=e.animation.animations;for(var r in i)i.hasOwnProperty(r)&&(n[r]=i[r]);t.animation.animations=n;var s={},a=e.animation.animationsIndex;for(var o in a)a.hasOwnProperty(o)&&(s[o]=a[o]);return t.animation.animationsIndex=s,t.animation},n.onBeforeRemove=function(e,t){t.onBeforeRemove();},n.onUpdate=function(e){var t=this.store;for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];i.data.enabled&&i.entity.enabled&&i.entity.animation.update(e);}},n.destroy=function(){e.prototype.destroy.call(this),this.app.systems.off("update",this.onUpdate,this);},t}(mZ);mX._buildAccessors(_T.prototype,_C);var _I=function(){var e;function t(e,t,n,i,r){ void 0===r&&(r=1),this._state=e,this._parent=t,this._name=n,Array.isArray(i)?(this._point=new eX(i[0],i[1]),this._pointLength=this._point.length()):(this._point=i,this._pointLength=i),this._speed=r,this._weightedSpeed=1,this._weight=1,this._animTrack=null;}return e=[{key:"parent",get:function(){return this._parent}},{key:"name",get:function(){return this._name}},{key:"path",get:function(){return this._parent?this._parent.path+"."+this._name:this._name}},{key:"point",get:function(){return this._point}},{key:"pointLength",get:function(){return this._pointLength}},{key:"weight",get:function(){return this._parent?this._parent.weight*this._weight:this._weight},set:function(e){this._weight=e;}},{key:"normalizedWeight",get:function(){var e=this._state.totalWeight;return 0===e?0:this.weight/e}},{key:"speed",get:function(){return this._weightedSpeed*this._speed}},{key:"absoluteSpeed",get:function(){return Math.abs(this._speed)}},{key:"weightedSpeed",get:function(){return this._weightedSpeed},set:function(e){this._weightedSpeed=e;}},{key:"animTrack",get:function(){return this._animTrack},set:function(e){this._animTrack=e;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}();function _L(e,t){return (_L=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var _D=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i,r,s,a,o,l,u){var c;(c=e.call(this,t,n,i,r)||this)._parameters=s,c._parameterValues=Array(s.length),c._children=[],c._findParameter=u,c._syncAnimations=false!==o,c._pointCache={};for(var h=0;h<a.length;h++){var f=a[h];f.children?c._children.push(l(f.type,t,c,f.name,1,f.parameter?[f.parameter]:f.parameters,f.children,f.syncAnimations,l,u)):c._children.push(new _I(t,c,f.name,f.point,f.speed));}return c}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&_L(t,e);var n,i=t.prototype;return i.getChild=function(e){for(var t=0;t<this._children.length;t++)if(this._children[t].name===e)return this._children[t];return null},i.updateParameterValues=function(){for(var e=true,t=0;t<this._parameterValues.length;t++){var n=this._findParameter(this._parameters[t]).value;this._parameterValues[t]!==n&&(this._parameterValues[t]=n,e=false);}return e},i.getNodeWeightedDuration=function(e){return this._children[e].animTrack.duration/this._children[e].speedMultiplier*this._children[e].weight},i.getNodeCount=function(){for(var e=0,n=0;n<this._children.length;n++)this._children[n].constructor===t?e+=this._children[n].getNodeCount():e++;return e},n=[{key:"weight",get:function(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}},{key:"syncAnimations",get:function(){return this._syncAnimations}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(_I);function _M(e,t){return (_M=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var _R=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i,r,s,a,o,l,u){return a.sort(function(e,t){return e.point-t.point}),e.call(this,t,n,i,r,s,a,o,l,u)||this}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&_M(t,e),t.prototype.calculateWeights=function(){if(!this.updateParameterValues()){var e=0;this._children[0].weight=0;for(var t=0;t<this._children.length;t++){var n=this._children[t];if(t!==this._children.length-1){var i=this._children[t+1];if(n.point===i.point)n.weight=.5,i.weight=.5;else if(ek.between(this._parameterValues[0],n.point,i.point,true)){var r=Math.abs(n.point-i.point),s=(r-Math.abs(n.point-this._parameterValues[0]))/r;n.weight=s,i.weight=1-s;}else i.weight=0;}this._syncAnimations&&(e+=n.animTrack.duration/n.absoluteSpeed*n.weight);}if(this._syncAnimations)for(var a=0;a<this._children.length;a++){var o=this._children[a];o.weightedSpeed=o.animTrack.duration/o.absoluteSpeed/e;}}},t}(_D);function _O(e,t){return (_O=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var _k=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){return e.apply(this,arguments)||this}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&_O(t,e);var n=t.prototype;return n.pointDistanceCache=function(e,t){var n=""+e+t;return this._pointCache[n]||(this._pointCache[n]=this._children[t].point.clone().sub(this._children[e].point)),this._pointCache[n]},n.calculateWeights=function(){if(!this.updateParameterValues()){(e=t._p).set.apply(e,[].concat(this._parameterValues)),n=0,i=0;for(var e,n,i,r=0;r<this._children.length;r++){var s=this._children[r],a=s.point;t._pip.set(t._p.x,t._p.y).sub(a);for(var o=Number.MAX_VALUE,l=0;l<this._children.length;l++)if(r!==l){var u=this.pointDistanceCache(r,l),c=ek.clamp(1-t._pip.dot(u)/u.lengthSq(),0,1);c<o&&(o=c);}s.weight=o,n+=o,this._syncAnimations&&(i+=s.animTrack.duration/s.absoluteSpeed*s.weight);}for(var h=0;h<this._children.length;h++){var f=this._children[h];f.weight=f._weight/n,this._syncAnimations&&(f.weightedSpeed=f.animTrack.duration/f.absoluteSpeed/i);}}},t}(_D);function _N(e,t){return (_N=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}_k._p=new eX,_k._pip=new eX;var _F=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){return e.apply(this,arguments)||this}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&_N(t,e);var n=t.prototype;return n.pointCache=function(e,t){var n=""+e+t;return this._pointCache[n]||(this._pointCache[n]=new eX((this._children[t].pointLength-this._children[e].pointLength)/((this._children[t].pointLength+this._children[e].pointLength)/2),2*eX.angleRad(this._children[e].point,this._children[t].point))),this._pointCache[n]},n.calculateWeights=function(){if(!this.updateParameterValues()){(e=t._p).set.apply(e,[].concat(this._parameterValues));var e,n,i,r=t._p.length();n=0,i=0;for(var s=0;s<this._children.length;s++){for(var a=this._children[s],o=a.point,l=a.pointLength,u=Number.MAX_VALUE,c=0;c<this._children.length;c++)if(s!==c){var h=this.pointCache(s,c),f=this._children[c].pointLength;t._pip.set((r-l)/((f+l)/2),2*eX.angleRad(o,t._p));var d=ek.clamp(1-Math.abs(t._pip.dot(h)/h.lengthSq()),0,1);d<u&&(u=d);}a.weight=u,n+=u,this._syncAnimations&&(i+=a.animTrack.duration/a.absoluteSpeed*a.weight);}for(var p=0;p<this._children.length;p++){var m=this._children[p];if(m.weight=m._weight/n,this._syncAnimations){var _=m.animTrack.duration/i*n;m.weightedSpeed=m.absoluteSpeed*_;}}}},t}(_D);function _B(e,t){return (_B=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}_F._p=new eX,_F._pip=new eX;var _U=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){return e.apply(this,arguments)||this}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&_B(t,e),t.prototype.calculateWeights=function(){if(!this.updateParameterValues()){for(var e=0,t=0,n=0;n<this._children.length;n++)if(e+=Math.max(this._parameterValues[n],0),this._syncAnimations){var i=this._children[n];t+=i.animTrack.duration/i.absoluteSpeed*i.weight;}for(var r=0;r<this._children.length;r++){var s=this._children[r],a=Math.max(this._parameterValues[r],0);e?(s.weight=a/e,this._syncAnimations&&(s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/t)):(s.weight=0,this._syncAnimations&&(s.weightedSpeed=0));}}},t}(_D),_z=function(){function e(e,t,n,i,r){ void 0===n&&(n=1),void 0===i&&(i=true),this._animations={},this._animationList=[],this._controller=e,this._name=t,this._speed=n,this._loop=i,this._hasAnimations=false,r?this._blendTree=this._createTree(r.type,this,null,t,1,r.parameter?[r.parameter]:r.parameters,r.children,r.syncAnimations,this._createTree,this._controller.findParameter):this._blendTree=new _I(this,null,t,1,n);}var t,n=e.prototype;return n._createTree=function(e,t,n,i,r,s,a,o,l,u){switch(e){case "1D":return new _R(t,n,i,r,s,a,o,l,u);case _o:return new _k(t,n,i,r,s,a,o,l,u);case _a:return new _F(t,n,i,r,s,a,o,l,u);case _l:return new _U(t,n,i,r,s,a,o,l,u)}},n._getNodeFromPath=function(e){for(var t=this._blendTree,n=1;n<e.length;n++)t=t.getChild(e[n]);return t},n.addAnimation=function(e,t){var n=e.join("."),i=this._animationList.findIndex(function(e){return e.path===n});if(i>=0)this._animationList[i].animTrack=t;else {var r=this._getNodeFromPath(e);r.animTrack=t,this._animationList.push(r);}this._updateHasAnimations();},n._updateHasAnimations=function(){this._hasAnimations=this._animationList.length>0&&this._animationList.every(function(e){return e.animTrack&&e.animTrack!==_v.EMPTY});},t=[{key:"name",get:function(){return this._name}},{key:"animations",get:function(){return this._animationList},set:function(e){this._animationList=e,this._updateHasAnimations();}},{key:"hasAnimations",get:function(){return this._hasAnimations}},{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e;}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e;}},{key:"nodeCount",get:function(){return this._blendTree&&this._blendTree.constructor!==_I?this._blendTree.getNodeCount():1}},{key:"playable",get:function(){return -1!==_c.indexOf(this.name)||this.animations.length===this.nodeCount}},{key:"looping",get:function(){if(this.animations.length>0){var e=this.name+"."+this.animations[0].animTrack.name,t=this._controller.animEvaluator.findClip(e);if(t)return t.loop}return  false}},{key:"totalWeight",get:function(){for(var e=0,t=0;t<this.animations.length;t++)e+=this.animations[t].weight;return e}},{key:"timelineDuration",get:function(){for(var e=0,t=0;t<this.animations.length;t++){var n=this.animations[t];n.animTrack.duration>e&&(e=n.animTrack.duration);}return e}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),_V=function(){var e;function t(e){var t=e.from,n=e.to,i=e.time,r=e.priority,s=e.conditions,a=e.exitTime,o=e.transitionOffset,l=e.interruptionSource,u=void 0===l?m1:l;this._from=t,this._to=n,this._time=void 0===i?0:i,this._priority=void 0===r?0:r,this._conditions=void 0===s?[]:s,this._exitTime=void 0===a?null:a,this._transitionOffset=void 0===o?null:o,this._interruptionSource=u;}return e=[{key:"from",get:function(){return this._from}},{key:"to",get:function(){return this._to},set:function(e){this._to=e;}},{key:"time",get:function(){return this._time}},{key:"priority",get:function(){return this._priority}},{key:"conditions",get:function(){return this._conditions}},{key:"exitTime",get:function(){return this._exitTime}},{key:"transitionOffset",get:function(){return this._transitionOffset}},{key:"interruptionSource",get:function(){return this._interruptionSource}},{key:"hasExitTime",get:function(){return !!this.exitTime}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}();function _G(){return (_G=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);}return e}).apply(this,arguments)}var _H=function(){function e(e,t,n,i,r,s,a){var o=this;this._states={},this._stateNames=[],this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._previousStateName=null,this._activeStateName=_u,this._activeStateDuration=0,this._activeStateDurationDirty=true,this._playing=false,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=false,this._transitionInterruptionSource=m1,this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0,this.findParameter=function(e){return o._findParameter(e)},this._animEvaluator=e,this._eventHandler=r,this._findParameter=s,this._consumeTrigger=a;for(var l=0;l<t.length;l++)this._states[t[l].name]=new _z(this,t[l].name,t[l].speed,t[l].loop,t[l].blendTree),this._stateNames.push(t[l].name);this._transitions=n.map(function(e){return new _V(_G({},e))}),this._activate=i;}var t,n=e.prototype;return n.assignMask=function(e){return this._animEvaluator.assignMask(e)},n._findState=function(e){return this._states[e]},n._getActiveStateProgressForTime=function(e){if(this.activeStateName===_u||"END"===this.activeStateName||"ANY"===this.activeStateName)return 1;var t=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return t?t.progressForTime(e):null},n._findTransitionsFromState=function(e){var t=this._findTransitionsFromStateCache[e];return t||(cq(t=this._transitions.filter(function(t){return t.from===e})),this._findTransitionsFromStateCache[e]=t),t},n._findTransitionsBetweenStates=function(e,t){var n=this._findTransitionsBetweenStatesCache[e+"->"+t];return n||(cq(n=this._transitions.filter(function(n){return n.from===e&&n.to===t})),this._findTransitionsBetweenStatesCache[e+"->"+t]=n),n},n._transitionHasConditionsMet=function(e){for(var t=e.conditions,n=0;n<t.length;n++){var i=t[n],r=this._findParameter(i.parameterName);switch(i.predicate){case m8:if(!(r.value>i.value))return  false;break;case m6:if(!(r.value<i.value))return  false;break;case m9:if(!(r.value>=i.value))return  false;break;case m7:if(!(r.value<=i.value))return  false;break;case _e:if(r.value!==i.value)return  false;break;case _t:if(r.value===i.value)return  false}}return  true},n._findTransition=function(e,t){var n=this,i=[];if(e&&t)i=i.concat(this._findTransitionsBetweenStates(e,t));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case m2:i=(i=i.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState("ANY"));break;case m3:i=(i=i.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState("ANY"));break;case m4:i=(i=(i=i.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState("ANY"));break;case m5:i=(i=(i=i.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState("ANY"));}else i=(i=i.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState("ANY"));if((i=i.filter(function(e){if(e.to===n.activeStateName)return  false;if(e.hasExitTime){var t=n._getActiveStateProgressForTime(n._timeInStateBefore),i=n._getActiveStateProgressForTime(n._timeInState);if(e.exitTime<1&&n.activeState.loop&&(t-=Math.floor(t),i-=Math.floor(i)),i===t){if(i!==e.exitTime)return null}else if(!(e.exitTime>t&&e.exitTime<=i))return null}return n._transitionHasConditionsMet(e)})).length>0){var r=i[0];return "END"===r.to&&(r.to=this._findTransitionsFromState(_u)[0].to),r}return null},n.updateStateFromTransition=function(e){this.previousState=e.from?this.activeStateName:null,this.activeState=e.to,this._activeStateDurationDirty=true;for(var t,n,i,r=0;r<e.conditions.length;r++){var s=e.conditions[r];this._findParameter(s.parameterName).type===_s&&this._consumeTrigger(s.parameterName);}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});for(var a=Math.min(0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1,1),o=0;o<this._transitionPreviousStates.length;o++){this._isTransitioning?o!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[o].weight*=1-a:this._transitionPreviousStates[o].weight=a:this._transitionPreviousStates[o].weight=1,t=this._findState(this._transitionPreviousStates[o].name);for(var l=0;l<t.animations.length;l++)n=t.animations[l],(i=this._animEvaluator.findClip(n.name+".previous."+o))||((i=this._animEvaluator.findClip(n.name)).name=n.name+".previous."+o),o!==this._transitionPreviousStates.length-1&&i.pause();}}this._isTransitioning=true,this._totalTransitionTime=e.time,this._currTransitionTime=0,this._transitionInterruptionSource=e.interruptionSource;var u=this.activeState,c=e.transitionOffset&&e.transitionOffset>0&&e.transitionOffset<1,h=0,f=0;if(c){var d=u.timelineDuration*e.transitionOffset;h=d,f=d;}this._timeInState=h,this._timeInStateBefore=f;for(var p=0;p<u.animations.length;p++){if(i=this._animEvaluator.findClip(u.animations[p].name))i.reset();else {var m=Number.isFinite(u.animations[p].speed)?u.animations[p].speed:u.speed;(i=new m0(u.animations[p].animTrack,this._timeInState,m,true,u.loop,this._eventHandler)).name=u.animations[p].name,this._animEvaluator.addClip(i);}if(e.time>0?i.blendWeight=0:i.blendWeight=u.animations[p].normalizedWeight,i.play(),c)i.time=u.timelineDuration*e.transitionOffset;else {var _=u.speed>=0?0:this.activeStateDuration;i.time=_;}}},n._transitionToState=function(e){if(this._findState(e)){var t=this._findTransition(this._activeStateName,e);t||(this._animEvaluator.removeClips(),t=new _V({from:null,to:e})),this.updateStateFromTransition(t);}},n.assignAnimation=function(e,t,n,i){var r=e.split("."),s=this._findState(r[0]);s||(s=new _z(this,r[0],n),this._states[r[0]]=s,this._stateNames.push(r[0])),s.addAnimation(r,t),this._animEvaluator.updateClipTrack(s.name,t),void 0!==n&&(s.speed=n),void 0!==i&&(s.loop=i),!this._playing&&this._activate&&this.playable&&this.play(),this._activeStateDurationDirty=true;},n.removeNodeAnimations=function(e){if(-1!==_c.indexOf(e))return  false;var t=this._findState(e);return !!t&&(t.animations=[],true)},n.play=function(e){e&&this._transitionToState(e),this._playing=true;},n.pause=function(){this._playing=false;},n.reset=function(){this._previousStateName=null,this._activeStateName=_u,this._playing=false,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=false,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips();},n.rebind=function(){this._animEvaluator.rebind();},n.update=function(e){if(this._playing){(this.activeState.loop||this._timeInState<this.activeStateDuration)&&(this._timeInStateBefore=this._timeInState,this._timeInState+=e*this.activeState.speed,!this.activeState.loop&&this._timeInState>this.activeStateDuration&&(this._timeInState=this.activeStateDuration,e=this.activeStateDuration-this._timeInStateBefore));var t,n,i,r=this._findTransition(this._activeStateName);if(r&&this.updateStateFromTransition(r),this._isTransitioning)if(this._currTransitionTime+=e,this._currTransitionTime<=this._totalTransitionTime){for(var s=0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1,a=0;a<this._transitionPreviousStates.length;a++){t=this._findState(this._transitionPreviousStates[a].name);for(var o=this._transitionPreviousStates[a].weight,l=0;l<t.animations.length;l++)n=t.animations[l],(i=this._animEvaluator.findClip(n.name+".previous."+a))&&(i.blendWeight=(1-s)*n.normalizedWeight*o);}t=this.activeState;for(var u=0;u<t.animations.length;u++)n=t.animations[u],this._animEvaluator.findClip(n.name).blendWeight=s*n.normalizedWeight;}else {this._isTransitioning=false;for(var c=this.activeStateAnimations.length,h=this._animEvaluator.clips.length,f=0;f<h-c;f++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],t=this.activeState;for(var d=0;d<t.animations.length;d++)n=t.animations[d],(i=this._animEvaluator.findClip(n.name))&&(i.blendWeight=n.normalizedWeight);}else if(this.activeState._blendTree.constructor!==_I){t=this.activeState;for(var p=0;p<t.animations.length;p++)n=t.animations[p],(i=this._animEvaluator.findClip(n.name))&&(i.blendWeight=n.normalizedWeight,n.parent.syncAnimations&&(i.speed=n.speed));}this._animEvaluator.update(e,this.activeState.hasAnimations);}},t=[{key:"animEvaluator",get:function(){return this._animEvaluator}},{key:"activeState",get:function(){return this._findState(this._activeStateName)},set:function(e){this._activeStateName=e;}},{key:"activeStateName",get:function(){return this._activeStateName}},{key:"activeStateAnimations",get:function(){return this.activeState.animations}},{key:"previousState",get:function(){return this._findState(this._previousStateName)},set:function(e){this._previousStateName=e;}},{key:"previousStateName",get:function(){return this._previousStateName}},{key:"playable",get:function(){for(var e=true,t=0;t<this._stateNames.length;t++)this._states[this._stateNames[t]].playable||(e=false);return e}},{key:"playing",get:function(){return this._playing},set:function(e){this._playing=e;}},{key:"activeStateProgress",get:function(){return this._getActiveStateProgressForTime(this._timeInState)}},{key:"activeStateDuration",get:function(){if(this._activeStateDurationDirty){for(var e=0,t=0;t<this.activeStateAnimations.length;t++){var n=this._animEvaluator.findClip(this.activeStateAnimations[t].name);n&&(e=Math.max(e,n.track.duration));}this._activeStateDuration=e,this._activeStateDurationDirty=false;}return this._activeStateDuration}},{key:"activeStateCurrentTime",get:function(){return this._timeInState},set:function(e){this._timeInStateBefore=e,this._timeInState=e;for(var t=0;t<this.activeStateAnimations.length;t++){var n=this.animEvaluator.findClip(this.activeStateAnimations[t].name);n&&(n.time=e);}}},{key:"transitioning",get:function(){return this._isTransitioning}},{key:"transitionProgress",get:function(){return this._currTransitionTime/this._totalTransitionTime}},{key:"states",get:function(){return this._stateNames}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function _W(e,t){return (_W=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _j(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}var _X=new eX,_Y=new eW,_q=new eY,_K=new eN,_Z=new e0,_Q=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i,r,s){var a;return (a=e.call(this,n)||this).animComponent=t,a._mask=r,a.layerName=i,a.layerIndex=s,a}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&_W(t,e);var n=t.prototype;return n.resolve=function(e){var t,n,i,r=_g.encode(e.entityPath,e.component,e.propertyPath),s=this.targetCache[r];if(s)return s;switch(e.component){case "entity":t=this._getEntityFromHierarchy(e.entityPath),i=_g.encode(t.path,"entity",e.propertyPath),n=t;break;case "graph":if(!(n=this.findNode(e)))return null;i=_g.encode(n.path,"graph",e.propertyPath);break;default:if(!(n=(t=this._getEntityFromHierarchy(e.entityPath)).findComponent(e.component)))return null;i=_g.encode(t.path,e.component,e.propertyPath);}return s=this._createAnimTargetForProperty(n,e.propertyPath,i),this.targetCache[r]=s,s},n.update=function(e){var t=this.activeNodes;if(t)for(var n=0;n<t.length;n++)t[n]._dirtifyLocal();},n._getEntityFromHierarchy=function(e){if(!this.animComponent.entity.name===e[0])return null;var t=this.animComponent.entity;return 1===e.length?t:t._parent.findByPath(e)},n._resolvePath=function(e,t,n){for(var i=t.length-!n,r=0;r<i;r++)e=e[t[r]];return e},n._setter=function(e,t,n){var i=this._resolvePath(e,t),r=t[t.length-1],s="set"+r.substring(0,1).toUpperCase()+r.substring(1);if(i[s]){var a=i["get"+r.substring(0,1).toUpperCase()+r.substring(1)].bind(i)();a=[a.x,a.y,a.z,a.w];var o=i[s].bind(i);return {set:function(e){o(n(e));},get:function(){return a}}}var l=i[r];if((void 0===l?"undefined":_j(l))==="object"&&l.hasOwnProperty("copy"))return function(e){l.copy(n(e));};if(-1!==[eX,eW,eY,eN,e0].indexOf(i.constructor)&&t.length>1){var u=t.length>2?this._resolvePath(e,t.slice(0,-1)):e,c=t[t.length-2];return function(e){i[r]=n(e),u[c]=i;}}return function(e){i[r]=n(e);}},n._createAnimTargetForProperty=function(e,n,i){if(this.handlers&&n[0].startsWith("weight."))return this.handlers.weight(e,n[0].replace("weight.",""));if(this.handlers&&"material"===n[0]&&2===n.length){var r,s,a,o=n[1];if(o.endsWith("Map"))return this.handlers.materialTexture(e,o)}var l=this._resolvePath(e,n,true);if(void 0===l)return null;if("number"==typeof l)r=this._setter(e,n,t._packFloat),s="vector",a=1;else if("boolean"==typeof l)r=this._setter(e,n,t._packBoolean),s="vector",a=1;else if((void 0===l?"undefined":_j(l))==="object")switch(l.constructor){case eX:r=this._setter(e,n,t._packVec2),s="vector",a=2;break;case eW:r=this._setter(e,n,t._packVec3),s="vector",a=3;break;case eY:r=this._setter(e,n,t._packVec4),s="vector",a=4;break;case eN:r=this._setter(e,n,t._packColor),s="vector",a=4;break;case e0:r=this._setter(e,n,t._packQuat),s="quaternion",a=4;break;default:return null}return -1!==n.indexOf("material")?new _y(function(t){r(t),e.material.update();},s,a,i):new _y(r,s,a,i)},n.rebind=function(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;var e={},t=function(n){e[n.name]=n;for(var i=0;i<n.children.length;++i)t(n.children[i]);};t(this.graph),this.nodes=e;},t._packFloat=function(e){return e[0]},t._packBoolean=function(e){return !!e[0]},t._packVec2=function(e){return _X.x=e[0],_X.y=e[1],_X},t._packVec3=function(e){return _Y.x=e[0],_Y.y=e[1],_Y.z=e[2],_Y},t._packVec4=function(e){return _q.x=e[0],_q.y=e[1],_q.z=e[2],_q.w=e[3],_q},t._packColor=function(e){return _K.r=e[0],_K.g=e[1],_K.b=e[2],_K.a=e[3],_K},t._packQuat=function(e){return _Z.x=e[0],_Z.y=e[1],_Z.z=e[2],_Z.w=e[3],_Z},t}(_S),_J=function(){function e(e,t,n,i,r){ void 0===i&&(i=1),void 0===r&&(r=_h),this._mask=null,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0,this._name=e,this._controller=t,this._component=n,this._weight=i,this._blendType=r;}var t,n=e.prototype;return n.play=function(e){this._controller.play(e);},n.pause=function(){this._controller.pause();},n.reset=function(){this._controller.reset();},n.rebind=function(){this._controller.rebind();},n.update=function(e){this._blendTime&&(this._blendTimeElapsed<this._blendTime?(this.weight=ek.lerp(this._startingWeight,this._targetWeight,this._blendTimeElapsed/this._blendTime),this._blendTimeElapsed+=e):(this.weight=this._targetWeight,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0)),this._controller.update(e);},n.blendToWeight=function(e,t){this._startingWeight=this.weight,this._targetWeight=e,this._blendTime=Math.max(0,t),this._blendTimeElapsed=0;},n.assignAnimation=function(e,t,n,r){(null!=_v&&"undefined"!=typeof Symbol&&_v[Symbol.hasInstance]?!!_v[Symbol.hasInstance](t):i(t,_v))&&(this._controller.assignAnimation(e,t,n,r),0===this._controller._transitions.length&&this._controller._transitions.push(new _V({from:"START",to:e})),this._component.activate&&this._component.playable&&(this._component.playing=true));},n.removeNodeAnimations=function(e){this._controller.removeNodeAnimations(e)&&(this._component.playing=false);},n.getAnimationAsset=function(e){return this._component.animationAssets[this.name+":"+e]},n.transition=function(e,t,n){ void 0===t&&(t=0),void 0===n&&(n=null),this._controller.updateStateFromTransition(new _V({from:this._controller.activeStateName,to:e,time:t,transitionOffset:n}));},t=[{key:"name",get:function(){return this._name}},{key:"playing",get:function(){return this._controller.playing},set:function(e){this._controller.playing=e;}},{key:"playable",get:function(){return this._controller.playable}},{key:"activeState",get:function(){return this._controller.activeStateName}},{key:"previousState",get:function(){return this._controller.previousStateName}},{key:"activeStateProgress",get:function(){return this._controller.activeStateProgress}},{key:"activeStateDuration",get:function(){return this._controller.activeStateDuration}},{key:"activeStateCurrentTime",get:function(){return this._controller.activeStateCurrentTime},set:function(e){var t=this._controller,n=t.playing;t.playing=true,t.activeStateCurrentTime=e,n||t.update(0),t.playing=n;}},{key:"transitioning",get:function(){return this._controller.transitioning}},{key:"transitionProgress",get:function(){return this.transitioning?this._controller.transitionProgress:null}},{key:"states",get:function(){return this._controller.states}},{key:"weight",get:function(){return this._weight},set:function(e){this._weight=e,this._component.dirtifyTargets();}},{key:"blendType",get:function(){return this._blendType},set:function(e){e!==this._blendType&&(this._blendType=e,this._controller.normalizeWeights&&this._component.rebind());}},{key:"mask",get:function(){return this._mask},set:function(e){this._controller.assignMask(e)&&this._component.rebind(),this._mask=e;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),_$=function(){var e;function t(e){if(this._layers=[],this._parameters={},Array.isArray(e.layers))this._layers=e.layers;else for(var t in e.layers){for(var n=e.layers[t],i={name:n.name,blendType:n.blendType,weight:n.weight,states:[],transitions:[]},r=0;r<n.states.length;r++)i.states.push(e.states[n.states[r]]);for(var s=0;s<n.transitions.length;s++){var a=e.transitions[n.transitions[s]];if(a.conditions&&!Array.isArray(a.conditions)){for(var o=Object.keys(a.conditions),l=[],u=0;u<o.length;u++){var c=a.conditions[o[u]];c.parameterName&&l.push(c);}a.conditions=l;}Number.isInteger(a.from)&&(a.from=e.states[a.from].name),Number.isInteger(a.to)&&(a.to=e.states[a.to].name),i.transitions.push(a);}this._layers.push(i);}for(var h in e.parameters){var f=e.parameters[h];this._parameters[f.name]={type:f.type,value:f.value};}}return e=[{key:"parameters",get:function(){return Object.assign({},this._parameters)}},{key:"layers",get:function(){return this._layers}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}();function _0(){return (_0=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);}return e}).apply(this,arguments)}function _1(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function _2(e,t){return (_2=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var _3=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return t=e.apply(this,arguments)||this,t._stateGraphAsset=null,t._animationAssets={},t._speed=1,t._activate=true,t._playing=false,t._rootBone=null,t._stateGraph=null,t._layers=[],t._layerIndices={},t._parameters={},t._targets={},t._consumedTriggers=new Set,t._normalizeWeights=false,t.findParameter=function(e){return t._parameters[e]},t.consumeTrigger=function(e){t._consumedTriggers.add(e);},t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&_2(t,e);var n,i=t.prototype;return i._onStateGraphAssetChangeEvent=function(e){var t=this.animationAssets,n=this.layers.map(function(e){return e.mask});this.removeStateGraph(),this._stateGraph=new _$(e._data),this.loadStateGraph(this._stateGraph),this.animationAssets=t,this.loadAnimationAssets(),this.layers.forEach(function(e,t){e.mask=n[t];}),this.rebind();},i.dirtifyTargets=function(){for(var e=Object.values(this._targets),t=0;t<e.length;t++)e[t].dirty=true;},i._addLayer=function(e){var t,n=e.name,i=e.states,r=e.transitions,s=e.weight,a=e.mask,o=e.blendType;t=this.rootBone?this.rootBone:this.entity;var l=this._layers.length,u=new _H(new _m(new _Q(this,t,n,a,l)),i,r,this._activate,this,this.findParameter,this.consumeTrigger);return this._layers.push(new _J(n,u,this,s,o)),this._layerIndices[n]=l,this._layers[l]},i.addLayer=function(e,t,n,i){var r=this.findAnimationLayer(e);return r||this._addLayer({name:e,states:[{name:"START",speed:1}],transitions:[],weight:t,mask:n,blendType:i})},i._assignParameters=function(e){this._parameters={};for(var t=Object.keys(e.parameters),n=0;n<t.length;n++){var i=t[n];this._parameters[i]={type:e.parameters[i].type,value:e.parameters[i].value};}},i.loadStateGraph=function(e){this._stateGraph=e,this._assignParameters(e),this._layers=[];for(var t=false,n=0;n<e.layers.length;n++){var i=e.layers[n];this._addLayer(_0({},i)),i.states.some(function(e){return e.blendTree})&&(t=true);}t||this.setupAnimationAssets();},i.setupAnimationAssets=function(){for(var e=0;e<this._layers.length;e++)for(var t=this._layers[e],n=t.name,i=0;i<t.states.length;i++){var r=t.states[i];if(-1===_c.indexOf(r)){var s=n+":"+r;this._animationAssets[s]||(this._animationAssets[s]={asset:null});}}this.loadAnimationAssets();},i.loadAnimationAssets=function(){for(var e=0;e<this._layers.length;e++)for(var t=this._layers[e],n=0;n<t.states.length;n++){var i=t.states[n];if(-1===_c.indexOf(i)){var r=this._animationAssets[t.name+":"+i];if(!r||!r.asset){this.findAnimationLayer(t.name).assignAnimation(i,_v.EMPTY);continue}var s=r.asset,a=this.system.app.assets.get(s);a&&(a.resource?this.onAnimationAssetLoaded(t.name,i,a):(a.once("load",(function(e,t){return (function(n){this.onAnimationAssetLoaded(e,t,n);}).bind(this)}).bind(this)(t.name,i)),this.system.app.assets.load(a)));}}},i.onAnimationAssetLoaded=function(e,t,n){this.findAnimationLayer(e).assignAnimation(t,n.resource);},i.removeStateGraph=function(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=false,this.unbind(),this._targets={};},i.reset=function(){this._assignParameters(this._stateGraph);for(var e=0;e<this._layers.length;e++){var t=this._layers[e].playing;this._layers[e].reset(),this._layers[e].playing=t;}},i.unbind=function(){var e=this;this._normalizeWeights||Object.keys(this._targets).forEach(function(t){e._targets[t].unbind();});},i.rebind=function(){this._targets={};for(var e=0;e<this._layers.length;e++)this._layers[e].rebind();},i.findAnimationLayer=function(e){var t=this._layerIndices[e];return this._layers[t]||null},i.addAnimationState=function(e,t,n,i,r){ void 0===n&&(n=1),void 0===i&&(i=true),void 0===r&&(r="Base"),this._stateGraph||this.loadStateGraph(new _$({layers:[{name:r,states:[{name:"START",speed:1},{name:e,speed:n,loop:i,defaultState:true}],transitions:[{from:"START",to:e}]}],parameters:{}}));var s,a=this.findAnimationLayer(r);a?a.assignAnimation(e,t,n,i):null==(s=this.addLayer(r))||s.assignAnimation(e,t,n,i);},i.assignAnimation=function(e,t,n,i,r){if(void 0===i&&(i=1),void 0===r&&(r=true),!this._stateGraph&&-1===e.indexOf(".")){this.loadStateGraph(new _$({layers:[{name:"Base",states:[{name:"START",speed:1},{name:e,speed:i,loop:r,defaultState:true}],transitions:[{from:"START",to:e}]}],parameters:{}})),this.baseLayer.assignAnimation(e,t);return}var s=n?this.findAnimationLayer(n):this.baseLayer;s&&s.assignAnimation(e,t,i,r);},i.removeNodeAnimations=function(e,t){var n=t?this.findAnimationLayer(t):this.baseLayer;n&&n.removeNodeAnimations(e);},i.getParameterValue=function(e,t){var n=this._parameters[e];if(n&&n.type===t)return n.value},i.setParameterValue=function(e,t,n){var i=this._parameters[e];if(i&&i.type===t){i.value=n;return}},i.getFloat=function(e){return this.getParameterValue(e,_i)},i.setFloat=function(e,t){this.setParameterValue(e,_i,t);},i.getInteger=function(e){return this.getParameterValue(e,_n)},i.setInteger=function(e,t){"number"==typeof t&&t%1==0&&this.setParameterValue(e,_n,t);},i.getBoolean=function(e){return this.getParameterValue(e,_r)},i.setBoolean=function(e,t){this.setParameterValue(e,_r,!!t);},i.getTrigger=function(e){return this.getParameterValue(e,_s)},i.setTrigger=function(e,t){ void 0===t&&(t=false),this.setParameterValue(e,_s,true),t&&this._consumedTriggers.add(e);},i.resetTrigger=function(e){this.setParameterValue(e,_s,false);},i.onBeforeRemove=function(){Number.isFinite(this._stateGraphAsset)&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this);},i.update=function(e){for(var t=this,n=0;n<this.layers.length;n++)this.layers[n].update(e*this.speed);this._consumedTriggers.forEach(function(e){t.parameters[e].value=false;}),this._consumedTriggers.clear();},i.resolveDuplicatedEntityReferenceProperties=function(e,t){e.rootBone&&t[e.rootBone.getGuid()]?this.rootBone=t[e.rootBone.getGuid()]:this.rebind();},n=[{key:"stateGraphAsset",get:function(){return this._stateGraphAsset},set:function(e){var t,n,i=this;if(null===e)return void this.removeStateGraph();this._stateGraphAsset&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this),_1(e,pZ)?(t=e.id,(n=this.system.app.assets.get(t))||(this.system.app.assets.add(e),n=this.system.app.assets.get(t))):(t=e,n=this.system.app.assets.get(t)),n&&this._stateGraphAsset!==t&&(n.resource?(this._stateGraph=n.resource,this.loadStateGraph(this._stateGraph),n.on("change",this._onStateGraphAssetChangeEvent,this)):(n.once("load",function(e){i._stateGraph=e.resource,i.loadStateGraph(i._stateGraph);}),n.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(n)),this._stateGraphAsset=t);}},{key:"normalizeWeights",get:function(){return this._normalizeWeights},set:function(e){this._normalizeWeights=e,this.unbind();}},{key:"animationAssets",get:function(){return this._animationAssets},set:function(e){this._animationAssets=e,this.loadAnimationAssets();}},{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e;}},{key:"activate",get:function(){return this._activate},set:function(e){this._activate=e;}},{key:"playing",get:function(){return this._playing},set:function(e){this._playing=e;}},{key:"rootBone",get:function(){return this._rootBone},set:function(e){if("string"==typeof e){var t=this.entity.root.findByGuid(e);this._rootBone=t;}else _1(e,my)?this._rootBone=e:this._rootBone=null;this.rebind();}},{key:"stateGraph",get:function(){return this._stateGraph},set:function(e){this._stateGraph=e;}},{key:"layers",get:function(){return this._layers}},{key:"layerIndices",get:function(){return this._layerIndices},set:function(e){this._layerIndices=e;}},{key:"parameters",get:function(){return this._parameters},set:function(e){this._parameters=e;}},{key:"targets",get:function(){return this._targets},set:function(e){this._targets=e;}},{key:"playable",get:function(){for(var e=0;e<this._layers.length;e++)if(!this._layers[e].playable)return  false;return  true}},{key:"baseLayer",get:function(){return this._layers.length>0?this._layers[0]:null}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX),_4=function(){this.enabled=true;};function _5(e,t){return (_5=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var _8=["enabled"],_6=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).id="anim",n.ComponentType=_3,n.DataType=_4,n.schema=_8,n.on("beforeremove",n.onBeforeRemove,n),n.app.systems.on("animationUpdate",n.onAnimationUpdate,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&_5(t,e);var n=t.prototype;return n.initializeComponentData=function(t,n,i){var r=this;e.prototype.initializeComponentData.call(this,t,n,_8);var s=["animationAssets","stateGraph","layers","masks"];Object.keys(n).forEach(function(e){s.includes(e)||(t[e]=n[e]);}),n.stateGraph&&(t.stateGraph=n.stateGraph,t.loadStateGraph(t.stateGraph)),n.layers&&n.layers.forEach(function(e,n){e._controller.states.forEach(function(i){e._controller._states[i]._animationList.forEach(function(i){if(i.animTrack&&i.animTrack!==_v.EMPTY)t.layers[n].assignAnimation(i.name,i.animTrack);else {var s=r.app.assets.get(e._component._animationAssets[e.name+":"+i.name].asset);s&&!s.loaded&&s.once("load",function(){t.layers[n].assignAnimation(i.name,s.resource);});}});});}),n.animationAssets&&(t.animationAssets=Object.assign(t.animationAssets,n.animationAssets)),n.masks&&Object.keys(n.masks).forEach(function(e){if(t.layers[e]){var i=n.masks[e].mask,r={};Object.keys(i).forEach(function(e){r[decodeURI(e)]=i[e];}),t.layers[e].mask=r;}});},n.onAnimationUpdate=function(e){var t=this.store;for(var n in t)if(t.hasOwnProperty(n)){var i=t[n].entity.anim;i.data.enabled&&i.entity.enabled&&i.playing&&i.update(e);}},n.cloneComponent=function(e,t){e.anim.rootBone&&e.anim.rootBone!==e||(n={},e.anim.layers.forEach(function(e,i){if(e.mask){var r={};Object.keys(e.mask).forEach(function(n){var i=n.split("/");i.shift(),r[[].concat([t.name],i).join("/")]=e.mask[n];}),n[i]={mask:r};}}));var n,i={enabled:e.anim.enabled,stateGraphAsset:e.anim.stateGraphAsset,animationAssets:e.anim.animationAssets,speed:e.anim.speed,activate:e.anim.activate,playing:e.anim.playing,rootBone:e.anim.rootBone,stateGraph:e.anim.stateGraph,layers:e.anim.layers,layerIndices:e.anim.layerIndices,parameters:e.anim.parameters,normalizeWeights:e.anim.normalizeWeights,masks:n};return this.addComponent(t,i)},n.onBeforeRemove=function(e,t){t.onBeforeRemove();},n.destroy=function(){e.prototype.destroy.call(this),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this);},t}(mZ);function _9(e,t){return (_9=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}mX._buildAccessors(_3.prototype,_8);var _7=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){return e.apply(this,arguments)||this}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&_9(t,e);var n=t.prototype;return n.setCurrentListener=function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var e=this.system.current.getPosition();this.system.manager.listener.setPosition(e);}},n.onEnable=function(){this.setCurrentListener();},n.onDisable=function(){this.system.current===this.entity&&(this.system.current=null);},t}(mX),ve=function(){this.enabled=true;};function vt(e,t){return (vt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var vn=["enabled"],vi=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).id="audiolistener",n.ComponentType=_7,n.DataType=ve,n.schema=vn,n.manager=t.soundManager,n.current=null,n.app.systems.on("update",n.onUpdate,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&vt(t,e);var n=t.prototype;return n.initializeComponentData=function(t,n,i){i=["enabled"],e.prototype.initializeComponentData.call(this,t,n,i);},n.onUpdate=function(e){if(this.current){var t=this.current.getPosition();this.manager.listener.setPosition(t);var n=this.current.getWorldTransform();this.manager.listener.setOrientation(n);}},n.destroy=function(){e.prototype.destroy.call(this),this.app.systems.off("update",this.onUpdate,this);},t}(mZ);mX._buildAccessors(_7.prototype,vn);var vr="group",vs="image",va="text",vo="stretch",vl="contain",vu="cover";function vc(e,t){return (vc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var vh={DEFAULT:"DEFAULT",HOVER:"HOVER",PRESSED:"PRESSED",INACTIVE:"INACTIVE"},vf={};vf[vh.DEFAULT]="_defaultTint",vf[vh.HOVER]="hoverTint",vf[vh.PRESSED]="pressedTint",vf[vh.INACTIVE]="inactiveTint";var vd={};vd[vh.DEFAULT]="_defaultSpriteAsset",vd[vh.HOVER]="hoverSpriteAsset",vd[vh.PRESSED]="pressedSpriteAsset",vd[vh.INACTIVE]="inactiveSpriteAsset";var vp={};vp[vh.DEFAULT]="_defaultSpriteFrame",vp[vh.HOVER]="hoverSpriteFrame",vp[vh.PRESSED]="pressedSpriteFrame",vp[vh.INACTIVE]="inactiveSpriteFrame";var vm=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n)||this)._visualState=vh.DEFAULT,i._isHovering=false,i._hoveringCounter=0,i._isPressed=false,i._defaultTint=new eN(1,1,1,1),i._defaultSpriteAsset=null,i._defaultSpriteFrame=0,i._imageEntity=null,i._evtElementAdd=null,i._evtImageEntityElementAdd=null,i._evtImageEntityElementRemove=null,i._evtImageEntityElementColor=null,i._evtImageEntityElementOpacity=null,i._evtImageEntityElementSpriteAsset=null,i._evtImageEntityElementSpriteFrame=null,i._visualState=vh.DEFAULT,i._isHovering=false,i._hoveringCounter=0,i._isPressed=false,i._defaultTint=new eN(1,1,1,1),i._defaultSpriteAsset=null,i._defaultSpriteFrame=0,i._toggleLifecycleListeners("on",t),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&vc(t,e);var n,r=t.prototype;return r._setValue=function(e,t){var n=this.data,i=n[e];n[e]=t,this.fire("set",e,i,t);},r._toggleLifecycleListeners=function(e,t){if(this[e]("set_active",this._onSetActive,this),this[e]("set_transitionMode",this._onSetTransitionMode,this),this[e]("set_hoverTint",this._onSetTransitionValue,this),this[e]("set_pressedTint",this._onSetTransitionValue,this),this[e]("set_inactiveTint",this._onSetTransitionValue,this),this[e]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[e]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[e]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[e]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),"on"===e)this._evtElementAdd=this.entity.on("element:add",this._onElementComponentAdd,this);else {var n;null==(n=this._evtElementAdd)||n.off(),this._evtElementAdd=null;}},r._onSetActive=function(e,t,n){t!==n&&this._updateVisualState();},r._onSetTransitionMode=function(e,t,n){t!==n&&(this._cancelTween(),this._resetToDefaultVisualState(t),this._forceReapplyVisualState());},r._onSetTransitionValue=function(e,t,n){t!==n&&this._forceReapplyVisualState();},r._imageEntitySubscribe=function(){this._evtImageEntityElementAdd=this._imageEntity.on("element:add",this._onImageElementGain,this),this._imageEntity.element&&this._onImageElementGain();},r._imageEntityUnsubscribe=function(){var e,t;null==(e=this._evtImageEntityElementAdd)||e.off(),this._evtImageEntityElementAdd=null,(null==(t=this._imageEntity)?void 0:t.element)&&this._onImageElementLose();},r._imageEntityElementSubscribe=function(){var e=this._imageEntity.element;this._evtImageEntityElementRemove=e.once("beforeremove",this._onImageElementLose,this),this._evtImageEntityElementColor=e.on("set:color",this._onSetColor,this),this._evtImageEntityElementOpacity=e.on("set:opacity",this._onSetOpacity,this),this._evtImageEntityElementSpriteAsset=e.on("set:spriteAsset",this._onSetSpriteAsset,this),this._evtImageEntityElementSpriteFrame=e.on("set:spriteFrame",this._onSetSpriteFrame,this);},r._imageEntityElementUnsubscribe=function(){var e,t,n,i,r;null==(e=this._evtImageEntityElementRemove)||e.off(),this._evtImageEntityElementRemove=null,null==(t=this._evtImageEntityElementColor)||t.off(),this._evtImageEntityElementColor=null,null==(n=this._evtImageEntityElementOpacity)||n.off(),this._evtImageEntityElementOpacity=null,null==(i=this._evtImageEntityElementSpriteAsset)||i.off(),this._evtImageEntityElementSpriteAsset=null,null==(r=this._evtImageEntityElementSpriteFrame)||r.off(),this._evtImageEntityElementSpriteFrame=null;},r._onElementComponentRemove=function(){this._toggleHitElementListeners("off");},r._onElementComponentAdd=function(){this._toggleHitElementListeners("on");},r._onImageElementLose=function(){this._imageEntityElementUnsubscribe(),this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode);},r._onImageElementGain=function(){this._imageEntityElementSubscribe(),this._storeDefaultVisualState(),this._forceReapplyVisualState();},r._toggleHitElementListeners=function(e){if(this.entity.element){var t="on"===e;t&&this._hasHitElementListeners||(this.entity.element[e]("beforeremove",this._onElementComponentRemove,this),this.entity.element[e]("mouseenter",this._onMouseEnter,this),this.entity.element[e]("mouseleave",this._onMouseLeave,this),this.entity.element[e]("mousedown",this._onMouseDown,this),this.entity.element[e]("mouseup",this._onMouseUp,this),this.entity.element[e]("touchstart",this._onTouchStart,this),this.entity.element[e]("touchend",this._onTouchEnd,this),this.entity.element[e]("touchleave",this._onTouchLeave,this),this.entity.element[e]("touchcancel",this._onTouchCancel,this),this.entity.element[e]("selectstart",this._onSelectStart,this),this.entity.element[e]("selectend",this._onSelectEnd,this),this.entity.element[e]("selectenter",this._onSelectEnter,this),this.entity.element[e]("selectleave",this._onSelectLeave,this),this.entity.element[e]("click",this._onClick,this),this._hasHitElementListeners=t);}},r._storeDefaultVisualState=function(){var e,t=null==(e=this._imageEntity)?void 0:e.element;t&&t.type!==vr&&(this._storeDefaultColor(t.color),this._storeDefaultOpacity(t.opacity),this._storeDefaultSpriteAsset(t.spriteAsset),this._storeDefaultSpriteFrame(t.spriteFrame));},r._storeDefaultColor=function(e){this._defaultTint.r=e.r,this._defaultTint.g=e.g,this._defaultTint.b=e.b;},r._storeDefaultOpacity=function(e){this._defaultTint.a=e;},r._storeDefaultSpriteAsset=function(e){this._defaultSpriteAsset=e;},r._storeDefaultSpriteFrame=function(e){this._defaultSpriteFrame=e;},r._onSetColor=function(e){this._isApplyingTint||(this._storeDefaultColor(e),this._forceReapplyVisualState());},r._onSetOpacity=function(e){this._isApplyingTint||(this._storeDefaultOpacity(e),this._forceReapplyVisualState());},r._onSetSpriteAsset=function(e){this._isApplyingSprite||(this._storeDefaultSpriteAsset(e),this._forceReapplyVisualState());},r._onSetSpriteFrame=function(e){this._isApplyingSprite||(this._storeDefaultSpriteFrame(e),this._forceReapplyVisualState());},r._onMouseEnter=function(e){this._isHovering=true,this._updateVisualState(),this._fireIfActive("mouseenter",e);},r._onMouseLeave=function(e){this._isHovering=false,this._isPressed=false,this._updateVisualState(),this._fireIfActive("mouseleave",e);},r._onMouseDown=function(e){this._isPressed=true,this._updateVisualState(),this._fireIfActive("mousedown",e);},r._onMouseUp=function(e){this._isPressed=false,this._updateVisualState(),this._fireIfActive("mouseup",e);},r._onTouchStart=function(e){this._isPressed=true,this._updateVisualState(),this._fireIfActive("touchstart",e);},r._onTouchEnd=function(e){e.event.preventDefault(),this._isPressed=false,this._updateVisualState(),this._fireIfActive("touchend",e);},r._onTouchLeave=function(e){this._isPressed=false,this._updateVisualState(),this._fireIfActive("touchleave",e);},r._onTouchCancel=function(e){this._isPressed=false,this._updateVisualState(),this._fireIfActive("touchcancel",e);},r._onSelectStart=function(e){this._isPressed=true,this._updateVisualState(),this._fireIfActive("selectstart",e);},r._onSelectEnd=function(e){this._isPressed=false,this._updateVisualState(),this._fireIfActive("selectend",e);},r._onSelectEnter=function(e){this._hoveringCounter++,1===this._hoveringCounter&&(this._isHovering=true,this._updateVisualState()),this._fireIfActive("selectenter",e);},r._onSelectLeave=function(e){this._hoveringCounter--,0===this._hoveringCounter&&(this._isHovering=false,this._isPressed=false,this._updateVisualState()),this._fireIfActive("selectleave",e);},r._onClick=function(e){this._fireIfActive("click",e);},r._fireIfActive=function(e,t){this.data.active&&this.fire(e,t);},r._updateVisualState=function(e){var t=this._visualState,n=this._determineVisualState();if((t!==n||e)&&this.enabled)switch(this._visualState=n,t===vh.HOVER&&this._fireIfActive("hoverend"),t===vh.PRESSED&&this._fireIfActive("pressedend"),n===vh.HOVER&&this._fireIfActive("hoverstart"),n===vh.PRESSED&&this._fireIfActive("pressedstart"),this.transitionMode){case 0:var i=this[vf[this._visualState]];this._applyTint(i);break;case 1:var r=vd[this._visualState],s=vp[this._visualState],a=this[r],o=this[s];this._applySprite(a,o);}},r._forceReapplyVisualState=function(){this._updateVisualState(true);},r._resetToDefaultVisualState=function(e){var t;if(null==(t=this._imageEntity)?void 0:t.element)switch(e){case 0:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case 1:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame);}},r._determineVisualState=function(){return this.active?this._isPressed?vh.PRESSED:this._isHovering?vh.HOVER:vh.DEFAULT:vh.INACTIVE},r._applySprite=function(e,t){var n,i=null==(n=this._imageEntity)?void 0:n.element;i&&(t=t||0,this._isApplyingSprite=true,i.spriteAsset!==e&&(i.spriteAsset=e),i.spriteFrame!==t&&(i.spriteFrame=t),this._isApplyingSprite=false);},r._applyTint=function(e){this._cancelTween(),0===this.fadeDuration?this._applyTintImmediately(e):this._applyTintWithTween(e);},r._applyTintImmediately=function(e){var t,n=null==(t=this._imageEntity)?void 0:t.element;if(e&&n&&n.type!==vr){var i=v_(e);this._isApplyingTint=true,i.equals(n.color)||(n.color=i),n.opacity!==e.a&&(n.opacity=e.a),this._isApplyingTint=false;}},r._applyTintWithTween=function(e){var t,n=null==(t=this._imageEntity)?void 0:t.element;if(e&&n&&n.type!==vr){var i=v_(e),r=n.color,s=n.opacity;i.equals(r)&&e.a===s||(this._tweenInfo={startTime:eL(),from:new eN(r.r,r.g,r.b,s),to:e.clone(),lerpColor:new eN});}},r._updateTintTween=function(){var e=eL()-this._tweenInfo.startTime,t=0===this.fadeDuration?1:e/this.fadeDuration;if(Math.abs((t=ek.clamp(t,0,1))-1)>1e-5){var n=this._tweenInfo.lerpColor;n.lerp(this._tweenInfo.from,this._tweenInfo.to,t),this._applyTintImmediately(new eN(n.r,n.g,n.b,n.a));}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween();},r._cancelTween=function(){delete this._tweenInfo;},r.onUpdate=function(){this._tweenInfo&&this._updateTintTween();},r.onEnable=function(){this._isHovering=false,this._hoveringCounter=0,this._isPressed=false,this._toggleHitElementListeners("on"),this._forceReapplyVisualState();},r.onDisable=function(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode);},r.onRemove=function(){this._imageEntityUnsubscribe(),this._toggleLifecycleListeners("off",this.system),this.onDisable();},r.resolveDuplicatedEntityReferenceProperties=function(e,t){e.imageEntity&&(this.imageEntity=t[e.imageEntity.getGuid()]);},n=[{key:"data",get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}},{key:"enabled",get:function(){return this.data.enabled},set:function(e){this._setValue("enabled",e);}},{key:"active",get:function(){return this.data.active},set:function(e){this._setValue("active",e);}},{key:"imageEntity",get:function(){return this._imageEntity},set:function(e){if(this._imageEntity!==e){var t="string"==typeof e;(!this._imageEntity||!t||this._imageEntity.getGuid()!==e)&&((this._imageEntity&&this._imageEntityUnsubscribe(),null!=us&&"undefined"!=typeof Symbol&&us[Symbol.hasInstance]?!!us[Symbol.hasInstance](e):i(e,us))?this._imageEntity=e:t?this._imageEntity=this.system.app.getEntityFromIndex(e)||null:this._imageEntity=null,this._imageEntity&&this._imageEntitySubscribe(),this._imageEntity?this.data.imageEntity=this._imageEntity.getGuid():t&&e&&(this.data.imageEntity=e));}}},{key:"hitPadding",get:function(){return this.data.hitPadding},set:function(e){this._setValue("hitPadding",e);}},{key:"transitionMode",get:function(){return this.data.transitionMode},set:function(e){this._setValue("transitionMode",e);}},{key:"hoverTint",get:function(){return this.data.hoverTint},set:function(e){this._setValue("hoverTint",e);}},{key:"pressedTint",get:function(){return this.data.pressedTint},set:function(e){this._setValue("pressedTint",e);}},{key:"inactiveTint",get:function(){return this.data.inactiveTint},set:function(e){this._setValue("inactiveTint",e);}},{key:"fadeDuration",get:function(){return this.data.fadeDuration},set:function(e){this._setValue("fadeDuration",e);}},{key:"hoverSpriteAsset",get:function(){return this.data.hoverSpriteAsset},set:function(e){this._setValue("hoverSpriteAsset",e);}},{key:"hoverSpriteFrame",get:function(){return this.data.hoverSpriteFrame},set:function(e){this._setValue("hoverSpriteFrame",e);}},{key:"pressedSpriteAsset",get:function(){return this.data.pressedSpriteAsset},set:function(e){this._setValue("pressedSpriteAsset",e);}},{key:"pressedSpriteFrame",get:function(){return this.data.pressedSpriteFrame},set:function(e){this._setValue("pressedSpriteFrame",e);}},{key:"inactiveSpriteAsset",get:function(){return this.data.inactiveSpriteAsset},set:function(e){this._setValue("inactiveSpriteAsset",e);}},{key:"inactiveSpriteFrame",get:function(){return this.data.inactiveSpriteFrame},set:function(e){this._setValue("inactiveSpriteFrame",e);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX);function v_(e){return new eN(e.r,e.g,e.b)}vm.EVENT_MOUSEDOWN="mousedown",vm.EVENT_MOUSEUP="mouseup",vm.EVENT_MOUSEENTER="mouseenter",vm.EVENT_MOUSELEAVE="mouseleave",vm.EVENT_CLICK="click",vm.EVENT_TOUCHSTART="touchstart",vm.EVENT_TOUCHEND="touchend",vm.EVENT_TOUCHCANCEL="touchcancel",vm.EVENT_TOUCHLEAVE="touchleave",vm.EVENT_SELECTSTART="selectstart",vm.EVENT_SELECTEND="selectend",vm.EVENT_SELECTENTER="selectenter",vm.EVENT_SELECTLEAVE="selectleave",vm.EVENT_HOVERSTART="hoverstart",vm.EVENT_HOVEREND="hoverend",vm.EVENT_PRESSEDSTART="pressedstart",vm.EVENT_PRESSEDEND="pressedend";var vv=function(){this.enabled=true,this.active=true,this.imageEntity=null,this.hitPadding=new eY,this.transitionMode=0,this.hoverTint=new eN(.75,.75,.75),this.pressedTint=new eN(.5,.5,.5),this.inactiveTint=new eN(.25,.25,.25),this.fadeDuration=0,this.hoverSpriteAsset=null,this.hoverSpriteFrame=0,this.pressedSpriteAsset=null,this.pressedSpriteFrame=0,this.inactiveSpriteAsset=null,this.inactiveSpriteFrame=0;};function vg(e,t){return (vg=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var vy=["enabled","active",{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"],vS=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).id="button",n.ComponentType=vm,n.DataType=vv,n.schema=vy,n.on("beforeremove",n._onRemoveComponent,n),n.app.systems.on("update",n.onUpdate,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&vg(t,e);var n=t.prototype;return n.initializeComponentData=function(t,n,i){t.imageEntity=n.imageEntity,e.prototype.initializeComponentData.call(this,t,n,vy);},n.onUpdate=function(e){var t=this.store;for(var n in t){var i=t[n].entity,r=i.button;r.enabled&&i.enabled&&r.onUpdate();}},n._onRemoveComponent=function(e,t){t.onRemove();},n.destroy=function(){e.prototype.destroy.call(this),this.app.systems.off("update",this.onUpdate,this);},t}(mZ);function vx(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function vb(e,t){return (vb=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var vT=new eW,vE=new e0,vw=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n)||this)._compoundParent=null,i._hasOffset=false,i.entity.on("insert",i._onInsert,i),i.on("set_type",i.onSetType,i),i.on("set_convexHull",i.onSetModel,i),i.on("set_halfExtents",i.onSetHalfExtents,i),i.on("set_linearOffset",i.onSetOffset,i),i.on("set_angularOffset",i.onSetOffset,i),i.on("set_radius",i.onSetRadius,i),i.on("set_height",i.onSetHeight,i),i.on("set_axis",i.onSetAxis,i),i.on("set_asset",i.onSetAsset,i),i.on("set_renderAsset",i.onSetRenderAsset,i),i.on("set_model",i.onSetModel,i),i.on("set_render",i.onSetRender,i),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&vb(t,e);var n,i=t.prototype;return i._setValue=function(e,t){var n=this.data,i=n[e];n[e]=t,this.fire("set",e,i,t);},i.onSetType=function(e,t,n){t!==n&&this.system.changeType(this,t,n);},i.onSetHalfExtents=function(e,t,n){var i=this.data.type;this.data.initialized&&"box"===i&&this.system.recreatePhysicalShapes(this);},i.onSetOffset=function(e,t,n){this._hasOffset=!this.data.linearOffset.equals(eW.ZERO)||!this.data.angularOffset.equals(e0.IDENTITY),this.data.initialized&&this.system.recreatePhysicalShapes(this);},i.onSetRadius=function(e,t,n){var i=this.data.type;this.data.initialized&&("sphere"===i||"capsule"===i||"cylinder"===i||"cone"===i)&&this.system.recreatePhysicalShapes(this);},i.onSetHeight=function(e,t,n){var i=this.data.type;this.data.initialized&&("capsule"===i||"cylinder"===i||"cone"===i)&&this.system.recreatePhysicalShapes(this);},i.onSetAxis=function(e,t,n){var i=this.data.type;this.data.initialized&&("capsule"===i||"cylinder"===i||"cone"===i)&&this.system.recreatePhysicalShapes(this);},i.onSetAsset=function(e,t,n){var i=this.system.app.assets;if(t){var r=i.get(t);r&&r.off("remove",this.onAssetRemoved,this);}if(n){vx(n,pZ)&&(this.data.asset=n.id);var s=i.get(this.data.asset);s&&(s.off("remove",this.onAssetRemoved,this),s.on("remove",this.onAssetRemoved,this));}this.data.initialized&&"mesh"===this.data.type&&(n||(this.data.model=null),this.system.recreatePhysicalShapes(this));},i.onSetRenderAsset=function(e,t,n){var i=this.system.app.assets;if(t){var r=i.get(t);r&&r.off("remove",this.onRenderAssetRemoved,this);}if(n){vx(n,pZ)&&(this.data.renderAsset=n.id);var s=i.get(this.data.renderAsset);s&&(s.off("remove",this.onRenderAssetRemoved,this),s.on("remove",this.onRenderAssetRemoved,this));}this.data.initialized&&"mesh"===this.data.type&&(n||(this.data.render=null),this.system.recreatePhysicalShapes(this));},i.onSetModel=function(e,t,n){this.data.initialized&&"mesh"===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this);},i.onSetRender=function(e,t,n){this.onSetModel(e,t,n);},i.onAssetRemoved=function(e){e.off("remove",this.onAssetRemoved,this),this.data.asset===e.id&&(this.asset=null);},i.onRenderAssetRemoved=function(e){e.off("remove",this.onRenderAssetRemoved,this),this.data.renderAsset===e.id&&(this.renderAsset=null);},i.getCompoundChildShapeIndex=function(e){for(var t=this.data.shape,n=t.getNumChildShapes(),i=0;i<n;i++){var r=t.getChildShape(i);if(Ammo.getPointer(r)===Ammo.getPointer(e))return i}return null},i._onInsert=function(e){if("undefined"!=typeof Ammo){if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody)for(var t=this.entity.parent;t;){if(t.collision&&"compound"===t.collision.type){0===t.collision.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(t.collision):this.system.recreatePhysicalShapes(this);break}t=t.parent;}}},i._updateCompound=function(){var e=this.entity;if(e._dirtyWorld){for(var t=e._dirtyLocal,n=e;n&&!t&&(!n.collision||n.collision!==this._compoundParent);)n._dirtyLocal&&(t=true),n=n.parent;if(t){e.forEach(this.system.implementations.compound._updateEachDescendantTransform,e);var i=this._compoundParent.entity.rigidbody;i&&i.activate();}}},i.getShapePosition=function(){var e=this.entity.getPosition();if(this._hasOffset){var t=this.entity.getRotation(),n=this.data.linearOffset;return vE.copy(t).transformVector(n,vT),vT.add(e)}return e},i.getShapeRotation=function(){var e=this.entity.getRotation();return this._hasOffset?vE.copy(e).mul(this.data.angularOffset):e},i.onEnable=function(){if("mesh"===this.data.type&&(this.data.asset||this.data.renderAsset)&&this.data.initialized){var e=this.system.app.assets.get(this.data.asset||this.data.renderAsset);if(e&&(!e.resource||!this.data.shape))return void this.system.recreatePhysicalShapes(this)}if(this.entity.rigidbody)this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation();else if(this._compoundParent&&this!==this._compoundParent)if(0===this._compoundParent.shape.getNumChildShapes())this.system.recreatePhysicalShapes(this._compoundParent);else {var t=this.system._getNodeTransform(this.entity,this._compoundParent.entity);this._compoundParent.shape.addChildShape(t,this.data.shape),Ammo.destroy(t),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate();}else this.entity.trigger&&this.entity.trigger.enable();},i.onDisable=function(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?!this._compoundParent.entity._destroying&&(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable();},i.onBeforeRemove=function(){this.asset&&(this.asset=null),this.renderAsset&&(this.renderAsset=null),this.entity.off("insert",this._onInsert,this),this.off();},n=[{key:"data",get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}},{key:"enabled",get:function(){return this.data.enabled},set:function(e){this._setValue("enabled",e);}},{key:"type",get:function(){return this.data.type},set:function(e){this._setValue("type",e);}},{key:"halfExtents",get:function(){return this.data.halfExtents},set:function(e){this._setValue("halfExtents",e);}},{key:"linearOffset",get:function(){return this.data.linearOffset},set:function(e){this._setValue("linearOffset",e);}},{key:"angularOffset",get:function(){return this.data.angularOffset},set:function(e){this._setValue("angularOffset",e);}},{key:"radius",get:function(){return this.data.radius},set:function(e){this._setValue("radius",e);}},{key:"axis",get:function(){return this.data.axis},set:function(e){this._setValue("axis",e);}},{key:"height",get:function(){return this.data.height},set:function(e){this._setValue("height",e);}},{key:"asset",get:function(){return this.data.asset},set:function(e){this._setValue("asset",e);}},{key:"renderAsset",get:function(){return this.data.renderAsset},set:function(e){this._setValue("renderAsset",e);}},{key:"convexHull",get:function(){return this.data.convexHull},set:function(e){this._setValue("convexHull",e);}},{key:"shape",get:function(){return this.data.shape},set:function(e){this._setValue("shape",e);}},{key:"model",get:function(){return this.data.model},set:function(e){this._setValue("model",e);}},{key:"render",get:function(){return this.data.render},set:function(e){this._setValue("render",e);}},{key:"checkVertexDuplicates",get:function(){return this.data.checkVertexDuplicates},set:function(e){this._setValue("checkVertexDuplicates",e);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX);vw.EVENT_CONTACT="contact",vw.EVENT_COLLISIONSTART="collisionstart",vw.EVENT_COLLISIONEND="collisionend",vw.EVENT_TRIGGERENTER="triggerenter",vw.EVENT_TRIGGERLEAVE="triggerleave";var vA=function(){this.enabled=true,this.type="box",this.halfExtents=new eW(.5,.5,.5),this.linearOffset=new eW,this.angularOffset=new e0,this.radius=.5,this.axis=1,this.height=2,this.convexHull=false,this.asset=null,this.renderAsset=null,this.checkVertexDuplicates=true,this.shape=null,this.model=null,this.render=null,this.initialized=false;},vC="static",vP="dynamic",vI="kinematic",vL=function(){function e(e,t,n){this.entity=t.entity,this.component=t,this.app=e,"undefined"==typeof Ammo||C||(C=new Ammo.btVector3,P=new Ammo.btQuaternion,I=new Ammo.btTransform),this.initialize(n);}var t=e.prototype;return t.initialize=function(e){var t=this.entity,n=e.shape;if(n&&"undefined"!=typeof Ammo){t.trigger&&t.trigger.destroy();var i=this.component;if(i){var r=i.getShapePosition(),s=i.getShapeRotation();C.setValue(r.x,r.y,r.z),P.setValue(s.x,s.y,s.z,s.w);}else {var a=t.getPosition(),o=t.getRotation();C.setValue(a.x,a.y,a.z),P.setValue(o.x,o.y,o.z,o.w);}I.setOrigin(C),I.setRotation(P);var l=this.app.systems.rigidbody.createBody(1,n,I);l.setRestitution(0),l.setFriction(0),l.setDamping(0,0),C.setValue(0,0,0),l.setLinearFactor(C),l.setAngularFactor(C),l.setCollisionFlags(4|l.getCollisionFlags()),l.entity=t,this.body=l,this.component.enabled&&t.enabled&&this.enable();}},t.destroy=function(){this.body&&(this.disable(),this.app.systems.rigidbody.destroyBody(this.body),this.body=null);},t._getEntityTransform=function(e){var t=this.component;if(t){var n=t.getShapePosition(),i=t.getShapeRotation();C.setValue(n.x,n.y,n.z),P.setValue(i.x,i.y,i.z,i.w);}else {var r=this.entity.getPosition(),s=this.entity.getRotation();C.setValue(r.x,r.y,r.z),P.setValue(s.x,s.y,s.z,s.w);}e.setOrigin(C),e.setRotation(P);},t.updateTransform=function(){this._getEntityTransform(I);var e=this.body;e.setWorldTransform(I),e.activate();},t.enable=function(){var e=this.body;if(e){var t=this.app.systems.rigidbody;0>t._triggers.indexOf(this)&&(t.addBody(e,16,65517),t._triggers.push(this)),e.forceActivationState(1),this.updateTransform();}},t.disable=function(){var e=this.body;if(e){var t=this.app.systems.rigidbody,n=t._triggers.indexOf(this);n>-1&&(t.removeBody(e),t._triggers.splice(n,1)),e.forceActivationState(5);}},e}();function vD(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:true,configurable:true}}),t&&vM(e,t);}function vM(e,t){return (vM=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var vR=new e$,vO=new eW,vk=new eW,vN=new e0,vF=new us,vB=["enabled","type","halfExtents","linearOffset","angularOffset","radius","axis","height","convexHull","asset","renderAsset","shape","model","render","checkVertexDuplicates"],vU=function(){function e(e){this.system=e;}var t=e.prototype;return t.beforeInitialize=function(e,t){t.shape=null,t.model=new he,t.model.graph=new us;},t.afterInitialize=function(e,t){this.recreatePhysicalShapes(e),e.data.initialized=true;},t.reset=function(e,t){this.beforeInitialize(e,t),this.afterInitialize(e,t);},t.recreatePhysicalShapes=function(e){var t=e.entity,n=e.data;if("undefined"!=typeof Ammo){t.trigger&&(t.trigger.destroy(),delete t.trigger),n.shape&&(e._compoundParent&&(e!==e._compoundParent&&this.system._removeCompoundChild(e._compoundParent,n.shape),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate()),this.destroyShape(n)),n.shape=this.createPhysicalShape(e.entity,n);var i=!e._compoundParent;if("compound"!==n.type||e._compoundParent&&e!==e._compoundParent){if("compound"!==n.type&&!e.rigidbody){e._compoundParent=null;for(var r=t.parent;r;){if(r.collision&&"compound"===r.collision.type){e._compoundParent=r.collision;break}r=r.parent;}}}else e._compoundParent=e,t.forEach(this._addEachDescendant,e);e._compoundParent&&e!==e._compoundParent&&(i&&0===e._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(e._compoundParent):(this.system.updateCompoundChildTransform(t,true),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate())),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):e._compoundParent||(t.trigger?t.trigger.initialize(n):t.trigger=new vL(this.system.app,e,n));}},t.createPhysicalShape=function(e,t){},t.updateTransform=function(e,t,n,i){e.entity.trigger&&e.entity.trigger.updateTransform();},t.destroyShape=function(e){e.shape&&(Ammo.destroy(e.shape),e.shape=null);},t.beforeRemove=function(e,t){t.data.shape&&(t._compoundParent&&!t._compoundParent.entity._destroying&&(this.system._removeCompoundChild(t._compoundParent,t.data.shape),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate()),t._compoundParent=null,this.destroyShape(t.data));},t.remove=function(e,t){e.rigidbody&&e.rigidbody.body&&e.rigidbody.disableSimulation(),e.trigger&&(e.trigger.destroy(),delete e.trigger);},t.clone=function(e,t){var n=this.system.store[e.getGuid()],i={enabled:n.data.enabled,type:n.data.type,halfExtents:[n.data.halfExtents.x,n.data.halfExtents.y,n.data.halfExtents.z],linearOffset:[n.data.linearOffset.x,n.data.linearOffset.y,n.data.linearOffset.z],angularOffset:[n.data.angularOffset.x,n.data.angularOffset.y,n.data.angularOffset.z,n.data.angularOffset.w],radius:n.data.radius,axis:n.data.axis,height:n.data.height,convexHull:n.data.convexHull,asset:n.data.asset,renderAsset:n.data.renderAsset,model:n.data.model,render:n.data.render,checkVertexDuplicates:n.data.checkVertexDuplicates};return this.system.addComponent(t,i)},e}(),vz=function(e){function t(){return e.apply(this,arguments)||this}return vD(t,e),t.prototype.createPhysicalShape=function(e,t){if("undefined"!=typeof Ammo){var n=t.halfExtents,i=new Ammo.btVector3(n?n.x:.5,n?n.y:.5,n?n.z:.5),r=new Ammo.btBoxShape(i);return Ammo.destroy(i),r}},t}(vU),vV=function(e){function t(){return e.apply(this,arguments)||this}return vD(t,e),t.prototype.createPhysicalShape=function(e,t){if("undefined"!=typeof Ammo)return new Ammo.btSphereShape(t.radius)},t}(vU),vG=function(e){function t(){return e.apply(this,arguments)||this}return vD(t,e),t.prototype.createPhysicalShape=function(e,t){var n,i,r,s=null!=(n=t.axis)?n:1,a=null!=(i=t.radius)?i:.5,o=Math.max((null!=(r=t.height)?r:2)-2*a,0),l=null;if("undefined"!=typeof Ammo)switch(s){case 0:l=new Ammo.btCapsuleShapeX(a,o);break;case 1:l=new Ammo.btCapsuleShape(a,o);break;case 2:l=new Ammo.btCapsuleShapeZ(a,o);}return l},t}(vU),vH=function(e){function t(){return e.apply(this,arguments)||this}return vD(t,e),t.prototype.createPhysicalShape=function(e,t){var n,i,r,s=null!=(n=t.axis)?n:1,a=null!=(i=t.radius)?i:.5,o=null!=(r=t.height)?r:1,l=null,u=null;if("undefined"!=typeof Ammo)switch(s){case 0:l=new Ammo.btVector3(.5*o,a,a),u=new Ammo.btCylinderShapeX(l);break;case 1:l=new Ammo.btVector3(a,.5*o,a),u=new Ammo.btCylinderShape(l);break;case 2:l=new Ammo.btVector3(a,a,.5*o),u=new Ammo.btCylinderShapeZ(l);}return l&&Ammo.destroy(l),u},t}(vU),vW=function(e){function t(){return e.apply(this,arguments)||this}return vD(t,e),t.prototype.createPhysicalShape=function(e,t){var n,i,r,s=null!=(n=t.axis)?n:1,a=null!=(i=t.radius)?i:.5,o=null!=(r=t.height)?r:1,l=null;if("undefined"!=typeof Ammo)switch(s){case 0:l=new Ammo.btConeShapeX(a,o);break;case 1:l=new Ammo.btConeShape(a,o);break;case 2:l=new Ammo.btConeShapeZ(a,o);}return l},t}(vU),vj=function(e){function t(){return e.apply(this,arguments)||this}vD(t,e);var n=t.prototype;return n.beforeInitialize=function(e,t){},n.createAmmoHull=function(e,t,n,i){var r=new Ammo.btConvexHullShape,s=new Ammo.btVector3,a=[];e.getPositions(a);for(var o=0;o<a.length;o+=3)s.setValue(a[o]*i.x,a[o+1]*i.y,a[o+2]*i.z),r.addPoint(s,false);Ammo.destroy(s),r.recalcLocalAabb(),r.setMargin(.01);var l=this.system._getNodeTransform(t);n.addChildShape(l,r),Ammo.destroy(l);},n.createAmmoMesh=function(e,t,n,i,r){ void 0===r&&(r=true);var s=this.system;if(s._triMeshCache[e.id])a=s._triMeshCache[e.id];else {for(var a,o,l,u,c,h,f=e.vertexBuffer,d=f.getFormat(),p=0;p<d.elements.length;p++){var m=d.elements[p];if(m.name===tT){l=new Float32Array(f.lock(),m.offset),o=m.stride/4;break}}var _=[];e.getIndices(_);var v=e.primitive[0].count/3,g=new Ammo.btVector3,y=e.primitive[0].base;a=new Ammo.btTriangleMesh,s._triMeshCache[e.id]=a;var S=new Map;a.getIndexedMeshArray().at(0).m_numTriangles=v;for(var x=i?i.x:1,b=i?i.y:1,T=i?i.z:1,E=function(e){var t,n=l[e*o]*x,i=l[e*o+1]*b,s=l[e*o+2]*T;if(r){var u=n+":"+i+":"+s;if(void 0!==(t=S.get(u)))return t;g.setValue(n,i,s),t=a.findOrAddVertex(g,false),S.set(u,t);}else g.setValue(n,i,s),t=a.findOrAddVertex(g,false);return t},w=0;w<v;w++)u=E(_[y+3*w]),c=E(_[y+3*w+1]),h=E(_[y+3*w+2]),a.addIndex(u),a.addIndex(c),a.addIndex(h);Ammo.destroy(g);}var A=new Ammo.btBvhTriangleMeshShape(a,true);if(!i){var C=s._getNodeScaling(t);A.setLocalScaling(C),Ammo.destroy(C);}var P=s._getNodeTransform(t);n.addChildShape(P,A),Ammo.destroy(P);},n.createPhysicalShape=function(e,t){if("undefined"!=typeof Ammo&&(t.model||t.render)){var n=new Ammo.btCompoundShape,i=e.getWorldTransform().getScale();if(t.render)for(var r=t.render.meshes,s=0;s<r.length;s++)t.convexHull?this.createAmmoHull(r[s],vF,n,i):this.createAmmoMesh(r[s],vF,n,i,t.checkVertexDuplicates);else if(t.model){for(var a=t.model.meshInstances,o=0;o<a.length;o++)this.createAmmoMesh(a[o].mesh,a[o].node,n,null,t.checkVertexDuplicates);var l=new Ammo.btVector3(i.x,i.y,i.z);n.setLocalScaling(l),Ammo.destroy(l);}return n}},n.recreatePhysicalShapes=function(e){var t=e.data;if((t.renderAsset||t.asset)&&e.enabled&&e.entity.enabled)return void this.loadAsset(e,t.renderAsset||t.asset,t.renderAsset?"render":"model");this.doRecreatePhysicalShape(e);},n.loadAsset=function(e,t,n){var i=this,r=e.data,s=this.system.app.assets,a=r[n],o=function(t){r[n]===a&&(r[n]=t.resource,i.doRecreatePhysicalShape(e));},l=function(e){e.ready(function(e){if(e.data.containerAsset){var t=s.get(e.data.containerAsset);t.loaded?o(e):(t.ready(function(){o(e);}),s.load(t));}else o(e);}),s.load(e);},u=s.get(t);u?l(u):s.once("add:"+t,l);},n.doRecreatePhysicalShape=function(e){var t=e.entity,n=e.data;n.model||n.render?(this.destroyShape(n),n.shape=this.createPhysicalShape(t,n),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):t.trigger?t.trigger.initialize(n):t.trigger=new vL(this.system.app,e,n)):(this.beforeRemove(t,e),this.remove(t,n));},n.updateTransform=function(t,n,i,r){if(t.shape){var s=t.entity.getWorldTransform().getScale(),a=t.shape.getLocalScaling();(s.x!==a.x()||s.y!==a.y()||s.z!==a.z())&&this.doRecreatePhysicalShape(t);}e.prototype.updateTransform.call(this,t,n,i,r);},n.destroyShape=function(e){if(e.shape){for(var t=e.shape.getNumChildShapes(),n=0;n<t;n++){var i=e.shape.getChildShape(n);Ammo.destroy(i);}Ammo.destroy(e.shape),e.shape=null;}},t}(vU),vX=function(e){function t(){return e.apply(this,arguments)||this}vD(t,e);var n=t.prototype;return n.createPhysicalShape=function(e,t){if("undefined"!=typeof Ammo)return new Ammo.btCompoundShape},n._addEachDescendant=function(e){e.collision&&!e.rigidbody&&(e.collision._compoundParent=this,e!==this.entity&&e.collision.system.recreatePhysicalShapes(e.collision));},n._updateEachDescendant=function(e){e.collision&&e.collision._compoundParent===this&&(e.collision._compoundParent=null,e===this.entity||e.rigidbody||e.collision.system.recreatePhysicalShapes(e.collision));},n._updateEachDescendantTransform=function(e){e.collision&&e.collision._compoundParent===this.collision._compoundParent&&this.collision.system.updateCompoundChildTransform(e,false);},t}(vU),vY=function(e){function t(t){var n;return (n=e.call(this,t)||this).id="collision",n.ComponentType=vw,n.DataType=vA,n.schema=vB,n.implementations={},n._triMeshCache={},n.on("beforeremove",n.onBeforeRemove,n),n.on("remove",n.onRemove,n),n}vD(t,e);var n=t.prototype;return n.initializeComponentData=function(t,n,i){i=["type","halfExtents","radius","axis","height","convexHull","shape","model","asset","render","renderAsset","enabled","linearOffset","angularOffset","checkVertexDuplicates"];for(var r,s={},a=0,o=i.length;a<o;a++){var l=i[a];s[l]=n[l];}if(n.hasOwnProperty("asset")?(-1!==(r=i.indexOf("model"))&&i.splice(r,1),-1!==(r=i.indexOf("render"))&&i.splice(r,1)):n.hasOwnProperty("model")&&-1!==(r=i.indexOf("asset"))&&i.splice(r,1),s.type||(s.type=t.data.type),t.data.type=s.type,Array.isArray(s.halfExtents)&&(s.halfExtents=new eW(s.halfExtents)),Array.isArray(s.linearOffset)&&(s.linearOffset=new eW(s.linearOffset)),Array.isArray(s.angularOffset)){var u=s.angularOffset;3===u.length?s.angularOffset=new e0().setFromEulerAngles(u[0],u[1],u[2]):s.angularOffset=new e0(s.angularOffset);}var c=this._createImplementation(s.type);c.beforeInitialize(t,s),e.prototype.initializeComponentData.call(this,t,s,i),c.afterInitialize(t,s);},n._createImplementation=function(e){if(void 0===this.implementations[e]){var t;switch(e){case "box":t=new vz(this);break;case "sphere":t=new vV(this);break;case "capsule":t=new vG(this);break;case "cylinder":t=new vH(this);break;case "cone":t=new vW(this);break;case "mesh":t=new vj(this);break;case "compound":t=new vX(this);}this.implementations[e]=t;}return this.implementations[e]},n._getImplementation=function(e){return this.implementations[e.collision.data.type]},n.cloneComponent=function(e,t){return this._getImplementation(e).clone(e,t)},n.onBeforeRemove=function(e,t){this.implementations[t.data.type].beforeRemove(e,t),t.onBeforeRemove();},n.onRemove=function(e,t){this.implementations[t.type].remove(e,t);},n.updateCompoundChildTransform=function(e,t){var n=e.collision._compoundParent;if(n!==e.collision&&e.enabled&&e.collision.enabled&&(e._dirtyLocal||t)){var i=this._getNodeTransform(e,n.entity),r=n.getCompoundChildShapeIndex(e.collision.shape);null===r?n.shape.addChildShape(i,e.collision.data.shape):n.shape.updateChildTransform(r,i,true),Ammo.destroy(i);}},n._removeCompoundChild=function(e,t){if(0!==e.shape.getNumChildShapes())if(e.shape.removeChildShape)e.shape.removeChildShape(t);else {var n=e.getCompoundChildShapeIndex(t);null!==n&&e.shape.removeChildShapeByIndex(n);}},n.onTransformChanged=function(e,t,n,i){this.implementations[e.data.type].updateTransform(e,t,n,i);},n.changeType=function(e,t,n){this.implementations[t].beforeRemove(e.entity,e),this.implementations[t].remove(e.entity,e.data),this._createImplementation(n).reset(e,e.data);},n.recreatePhysicalShapes=function(e){this.implementations[e.data.type].recreatePhysicalShapes(e);},n._calculateNodeRelativeTransform=function(e,t){if(e===t){var n=e.getWorldTransform().getScale();vR.setScale(n.x,n.y,n.z);}else this._calculateNodeRelativeTransform(e.parent,t),vR.mul(e.getLocalTransform());},n._getNodeScaling=function(e){var t=e.getWorldTransform().getScale();return new Ammo.btVector3(t.x,t.y,t.z)},n._getNodeTransform=function(e,t){t?(this._calculateNodeRelativeTransform(e,t),n=vO,i=vN,vR.getTranslation(n),i.setFromMat4(vR)):(n=e.getPosition(),i=e.getRotation());var n,i,r=new Ammo.btQuaternion,s=new Ammo.btTransform;s.setIdentity();var a=s.getOrigin(),o=e.collision;if(o&&o._hasOffset){var l=o.data.linearOffset,u=o.data.angularOffset;vN.copy(i).transformVector(l,vk),vk.add(n),vN.copy(i).mul(u),a.setValue(vk.x,vk.y,vk.z),r.setValue(vN.x,vN.y,vN.z,vN.w);}else a.setValue(n.x,n.y,n.z),r.setValue(i.x,i.y,i.z,i.w);return s.setRotation(r),Ammo.destroy(r),s},n.destroy=function(){for(var t in this._triMeshCache)Ammo.destroy(this._triMeshCache[t]);this._triMeshCache=null,e.prototype.destroy.call(this);},t}(mZ);function vq(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}var vK=new eN,vZ=new nD,vQ=function(){function e(e,t,n){this._entity=e,this._element=e.element,this.model=new he,this.node=new us,this.model.graph=this.node,this.mesh=t,this.meshInstance=new lL(this.mesh,n,this.node),this.meshInstance.name="ImageElement: "+e.name,this.meshInstance.castShadow=false,this.meshInstance.receiveShadow=false,this._meshDirty=false,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null;}var t=e.prototype;return t.destroy=function(){var e,t;this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this.model=null,this.node=null,this.mesh=null,null==(e=this.meshInstance)||e.destroy(),this.meshInstance=null,null==(t=this.unmaskMeshInstance)||t.destroy(),this.unmaskMeshInstance=null,this._entity=null,this._element=null;},t.setMesh=function(e){this.meshInstance&&(this.mesh=e,this.meshInstance.mesh=e,this.meshInstance.visible=!!e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=e),this.forceUpdateAabb());},t.setMask=function(e){if(this.meshInstance){if(this._entity.enabled&&this._element.enabled&&this._element.removeModelFromLayers(this.model),e)for(var t in this.unmaskMeshInstance=new lL(this.mesh,this.meshInstance.material,this.node),this.unmaskMeshInstance.name="Unmask: "+this._entity.name,this.unmaskMeshInstance.castShadow=false,this.unmaskMeshInstance.receiveShadow=false,this.unmaskMeshInstance.pick=false,this.model.meshInstances.push(this.unmaskMeshInstance),this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(t,this.meshInstance.parameters[t].data);else {var n,i=this.model.meshInstances.indexOf(this.unmaskMeshInstance);i>=0&&this.model.meshInstances.splice(i,1);}this._entity.enabled&&this._element.enabled&&this._element.addModelToLayers(this.model),e||(null==(n=this.unmaskMeshInstance)||n.destroy(),this.unmaskMeshInstance=null);}},t.setMaterial=function(e){this.meshInstance&&(this.meshInstance.material=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=e));},t.setParameter=function(e,t){this.meshInstance&&(this.meshInstance.setParameter(e,t),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(e,t));},t.deleteParameter=function(e){this.meshInstance&&(this.meshInstance.deleteParameter(e),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(e));},t.setUnmaskDrawOrder=function(){if(this.meshInstance){var e=function(t){var n,i=t.children,r=i.length;if(r){for(var s=0;s<r;s++)i[s].element&&(n=i[s]);if(!n)return null;var a=e(n);return a||n}return null};if(this.unmaskMeshInstance){var t=e(this._entity);t&&t.element?this.unmaskMeshInstance.drawOrder=t.element.drawOrder+t.element.getMaskOffset():this.unmaskMeshInstance.drawOrder=this.meshInstance.drawOrder+this._element.getMaskOffset();}}},t.setDrawOrder=function(e){this.meshInstance&&(this.meshInstance.drawOrder=e);},t.setCull=function(e){if(this.meshInstance){var t=this._element,n=null;e&&t._isScreenSpace()&&(n=function(e){return t.isVisibleForCamera(e)}),this.meshInstance.cull=e,this.meshInstance.isVisibleFunc=n,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=e,this.unmaskMeshInstance.isVisibleFunc=n);}},t.setScreenSpace=function(e){this.meshInstance&&(this.meshInstance.screenSpace=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=e));},t.setLayer=function(e){this.meshInstance&&(this.meshInstance.layer=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=e));},t.forceUpdateAabb=function(e){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1));},t.setAabbFunc=function(e){this.meshInstance&&(this.meshInstance._updateAabbFunc=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=e));},e}(),vJ=function(){function e(e){this._evtSetMeshes=null,this._element=e,this._entity=e.entity,this._system=e.system,this._textureAsset=null,this._texture=null,this._materialAsset=null,this._material=null,this._spriteAsset=null,this._sprite=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._targetAspectRatio=-1,this._rect=new eY(0,0,1,1),this._mask=false,this._maskRef=0,this._outerScale=new eX,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new eY,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new eY,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new vQ(this._entity,this._defaultMesh,this._material),this._color=new eN(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._updateRenderableEmissive(),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this);}var t,n=e.prototype;return n.destroy=function(){this.textureAsset=null,this.spriteAsset=null,this.materialAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this);},n._onResolutionChange=function(e){},n._onParentResizeOrPivotChange=function(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh);},n._onScreenSpaceChange=function(e){this._updateMaterial(e);},n._onScreenChange=function(e,t){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(false);},n._onDrawOrderChange=function(e){this._renderable.setDrawOrder(e),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",function(){this._renderable.setUnmaskDrawOrder();},this);},n._hasUserMaterial=function(){return !!this._materialAsset||!!this._material&&-1===this._system.defaultImageMaterials.indexOf(this._material)},n._use9Slicing=function(){return this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)},n._updateMaterial=function(e){var t=!!this._mask,n=!!(this.sprite&&1===this.sprite.renderMode),i=!!(this.sprite&&2===this.sprite.renderMode);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(e,t,n,i)),this._renderable&&(this._renderable.setCull(!this._element._isScreenSpace()||this._element._isScreenCulled()),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(e),this._renderable.setLayer(15*!e));},n._createMesh=function(){var e=this._element,t=e.calculatedWidth,n=e.calculatedHeight,i=this._rect,r=this._system.app.graphicsDevice,s=new Float32Array([t,0,0,0,0,1,i.x+i.z,1-i.y,t,n,0,0,0,1,i.x+i.z,1-(i.y+i.w),0,0,0,0,0,1,i.x,1-i.y,0,n,0,0,0,1,i.x,1-(i.y+i.w)]),a=vZ.get(r,function(){return new n6(r,[{semantic:tT,components:3,type:6},{semantic:tE,components:3,type:6},{semantic:tL,components:2,type:6}])}),o=new n1(r,a,4,{data:s.buffer}),l=new l_(r);return l.vertexBuffer=o,l.primitive[0].type=5,l.primitive[0].base=0,l.primitive[0].count=4,l.primitive[0].indexed=false,l.aabb.setMinMax(eW.ZERO,new eW(t,n,0)),this._updateMesh(l),l},n._updateMesh=function(e){var t=this._element,n=t.calculatedWidth,i=t.calculatedHeight;if(t.fitMode!==vo&&this._targetAspectRatio>0){var r=t.calculatedWidth/t.calculatedHeight;t.fitMode===vl&&r>this._targetAspectRatio||t.fitMode===vu&&r<this._targetAspectRatio?n=t.calculatedHeight*this._targetAspectRatio:i=t.calculatedWidth/this._targetAspectRatio;}var s=t._isScreenSpace();if(this._updateMaterial(s),this._renderable&&this._renderable.forceUpdateAabb(),this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){var a=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],o=2/a.rect.z,l=2/a.rect.w;this._innerOffset.set(a.border.x*o,a.border.y*l,a.border.z*o,a.border.w*l);var u=this.sprite.atlas.texture;this._atlasRect.set(a.rect.x/u.width,a.rect.y/u.height,a.rect.z/u.width,a.rect.w/u.height);var c=null!==this._pixelsPerUnit?this._pixelsPerUnit:this.sprite.pixelsPerUnit,h=a.rect.z/c,f=a.rect.w/c;this._outerScale.set(Math.max(n,this._innerOffset.x*h),Math.max(i,this._innerOffset.y*f));var d=h,p=f;this._outerScale.x/=h,this._outerScale.y/=f,d*=ek.clamp(n/(this._innerOffset.x*h),1e-4,1),p*=ek.clamp(i/(this._innerOffset.y*f),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(d,p,1),this._renderable.node.setLocalPosition((.5-t.pivot.x)*n,(.5-t.pivot.y)*i,0));}else {var m=e.vertexBuffer,_=new Float32Array(m.lock()),v=t.pivot.x,g=t.pivot.y;_[0]=n-v*n,_[1]=0-g*i,_[8]=n-v*n,_[9]=i-g*i,_[16]=0-v*n,_[17]=0-g*i,_[24]=0-v*n,_[25]=i-g*i;var y=1,S=1,x=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){var b=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];b&&(x=b.rect,y=this._sprite.atlas.texture.width,S=this._sprite.atlas.texture.height);}_[6]=(x.x+x.z)/y,_[7]=1-x.y/S,_[14]=(x.x+x.z)/y,_[15]=1-(x.y+x.w)/S,_[22]=x.x/y,_[23]=1-x.y/S,_[30]=x.x/y,_[31]=1-(x.y+x.w)/S,m.unlock();var T=new eW(0-v*n,0-g*i,0),E=new eW(n-v*n,i-g*i,0);e.aabb.setMinMax(T,E),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null));}this._meshDirty=false;},n._updateSprite=function(){var e=false,t=null;if(this._targetAspectRatio=-1,this._sprite&&this._sprite.atlas){t=this._sprite.meshes[this.spriteFrame],e=1===this._sprite.renderMode||2===this._sprite.renderMode;var n=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];(null==n?void 0:n.rect.w)>0&&(this._targetAspectRatio=n.rect.z/n.rect.w);}this.mesh=e?t:this._defaultMesh,this.refreshMesh();},n.refreshMesh=function(){this.mesh&&(this._element._beingInitialized?this._meshDirty=true:this._updateMesh(this.mesh));},n._updateAabb=function(e){return e.center.set(0,0,0),e.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),e.setFromTransformedAabb(e,this._renderable.node.getWorldTransform()),e},n._toggleMask=function(){this._element._dirtifyMask();var e=this._element._isScreenSpace();this._updateMaterial(e),this._renderable.setMask(!!this._mask);},n._onMaterialLoad=function(e){this.material=e.resource;},n._onMaterialAdded=function(e){this._system.app.assets.off("add:"+e.id,this._onMaterialAdded,this),this._materialAsset===e.id&&this._bindMaterialAsset(e);},n._bindMaterialAsset=function(e){this._entity.enabled&&(e.on("load",this._onMaterialLoad,this),e.on("change",this._onMaterialChange,this),e.on("remove",this._onMaterialRemove,this),e.resource?this._onMaterialLoad(e):this._system.app.assets.load(e));},n._unbindMaterialAsset=function(e){e.off("load",this._onMaterialLoad,this),e.off("change",this._onMaterialChange,this),e.off("remove",this._onMaterialRemove,this);},n._onMaterialChange=function(){},n._onMaterialRemove=function(){},n._onTextureAdded=function(e){this._system.app.assets.off("add:"+e.id,this._onTextureAdded,this),this._textureAsset===e.id&&this._bindTextureAsset(e);},n._bindTextureAsset=function(e){this._entity.enabled&&(e.on("load",this._onTextureLoad,this),e.on("change",this._onTextureChange,this),e.on("remove",this._onTextureRemove,this),e.resource?this._onTextureLoad(e):this._system.app.assets.load(e));},n._unbindTextureAsset=function(e){e.off("load",this._onTextureLoad,this),e.off("change",this._onTextureChange,this),e.off("remove",this._onTextureRemove,this);},n._onTextureLoad=function(e){this.texture=e.resource;},n._onTextureChange=function(e){},n._onTextureRemove=function(e){},n._onSpriteAssetAdded=function(e){this._system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e);},n._bindSpriteAsset=function(e){this._entity.enabled&&(e.on("load",this._onSpriteAssetLoad,this),e.on("change",this._onSpriteAssetChange,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._system.app.assets.load(e));},n._unbindSpriteAsset=function(e){e.off("load",this._onSpriteAssetLoad,this),e.off("change",this._onSpriteAssetChange,this),e.off("remove",this._onSpriteAssetRemove,this),e.data.textureAtlasAsset&&this._system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this);},n._onSpriteAssetLoad=function(e){if(e&&e.resource)if(e.resource.atlas)this.sprite=e.resource;else {var t=e.data.textureAtlasAsset;if(t){var n=this._system.app.assets;n.off("load:"+t,this._onTextureAtlasLoad,this),n.once("load:"+t,this._onTextureAtlasLoad,this);}}else this.sprite=null;},n._onSpriteAssetChange=function(e){this._onSpriteAssetLoad(e);},n._onSpriteAssetRemove=function(e){},n._bindSprite=function(e){this._evtSetMeshes=e.on("set:meshes",this._onSpriteMeshesChange,this),e.on("set:pixelsPerUnit",this._onSpritePpuChange,this),e.on("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.on("set:texture",this._onAtlasTextureChange,this);},n._unbindSprite=function(e){var t;null==(t=this._evtSetMeshes)||t.off(),this._evtSetMeshes=null,e.off("set:pixelsPerUnit",this._onSpritePpuChange,this),e.off("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.off("set:texture",this._onAtlasTextureChange,this);},n._onSpriteMeshesChange=function(){this._sprite&&(this._spriteFrame=ek.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite();},n._onSpritePpuChange=function(){0!==this.sprite.renderMode&&null===this._pixelsPerUnit&&this._updateSprite();},n._onAtlasTextureChange=function(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"));},n._onTextureAtlasLoad=function(e){var t=this._spriteAsset;vq(t,pZ)?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._system.app.assets.get(t));},n.onEnable=function(){if(this._materialAsset){var e=this._system.app.assets.get(this._materialAsset);e&&e.resource!==this._material&&this._bindMaterialAsset(e);}if(this._textureAsset){var t=this._system.app.assets.get(this._textureAsset);t&&t.resource!==this._texture&&this._bindTextureAsset(t);}if(this._spriteAsset){var n=this._system.app.assets.get(this._spriteAsset);n&&n.resource!==this._sprite&&this._bindSpriteAsset(n);}this._element.addModelToLayers(this._renderable.model);},n.onDisable=function(){this._element.removeModelFromLayers(this._renderable.model);},n._setStencil=function(e){this._renderable.meshInstance.stencilFront=e,this._renderable.meshInstance.stencilBack=e;var t=0;if(this._element.maskedBy&&(t=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance){var n=new n7({ref:t+1,func:2,zpass:5});this._renderable.unmaskMeshInstance.stencilFront=n,this._renderable.unmaskMeshInstance.stencilBack=n;}},n._updateRenderableEmissive=function(){vK.linear(this._color),this._colorUniform[0]=vK.r,this._colorUniform[1]=vK.g,this._colorUniform[2]=vK.b,this._renderable.setParameter("material_emissive",this._colorUniform);},n._removeMaterialAssetEvents=function(){if(this._materialAsset){var e=this._system.app.assets;e.off("add:"+this._materialAsset,this._onMaterialAdded,this);var t=e.get(this._materialAsset);t&&(t.off("load",this._onMaterialLoad,this),t.off("change",this._onMaterialChange,this),t.off("remove",this._onMaterialRemove,this));}},t=[{key:"color",get:function(){return this._color},set:function(e){var t=e.r,n=e.g,i=e.b;(this._color.r!==t||this._color.g!==n||this._color.b!==i)&&(this._color.r=t,this._color.g=n,this._color.b=i,this._updateRenderableEmissive()),this._element&&this._element.fire("set:color",this._color);}},{key:"opacity",get:function(){return this._color.a},set:function(e){e!==this._color.a&&(this._color.a=e,this._renderable.setParameter("material_opacity",e)),this._element&&this._element.fire("set:opacity",e);}},{key:"rect",get:function(){return this._rect},set:function(e){var t,n,i,r;vq(e,eY)?(t=e.x,n=e.y,i=e.z,r=e.w):(t=e[0],n=e[1],i=e[2],r=e[3]),(t!==this._rect.x||n!==this._rect.y||i!==this._rect.z||r!==this._rect.w)&&(this._rect.set(t,n,i,r),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=true:this._updateMesh(this._renderable.mesh)));}},{key:"material",get:function(){return this._material},set:function(e){if(this._material!==e){if(!e){var t=this._element._isScreenSpace();e=this.mask?t?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:t?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial;}if(this._material=e,this._materialAsset){var n=this._system.app.assets.get(this._materialAsset);n&&n.resource===e||(this._removeMaterialAssetEvents(),this._materialAsset=null);}e&&(this._renderable.setMaterial(e),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._updateRenderableEmissive(),this._renderable.setParameter("material_opacity",this._color.a)));}}},{key:"materialAsset",get:function(){return this._materialAsset},set:function(e){var t=this._system.app.assets,n=e;if(vq(e,pZ)&&(n=e.id),this._materialAsset!==n)if(this._removeMaterialAssetEvents(),this._materialAsset=n,this._materialAsset){var i=t.get(this._materialAsset);i?this._bindMaterialAsset(i):(this._materialAsset=null,this.material=null,this._materialAsset=n,t.on("add:"+this._materialAsset,this._onMaterialAdded,this));}else this._materialAsset=null,this.material=null,this._materialAsset=n;}},{key:"texture",get:function(){return this._texture},set:function(e){if(this._texture!==e){if(this._textureAsset){var t=this._system.app.assets.get(this._textureAsset);t&&t.resource!==e&&(this.textureAsset=null);}if(this._texture=e,e){this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._updateRenderableEmissive(),this._renderable.setParameter("material_opacity",this._color.a);var n=this._texture.width/this._texture.height;n!==this._targetAspectRatio&&(this._targetAspectRatio=n,this._element.fitMode!==vo&&this.refreshMesh());}else this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"),this._targetAspectRatio=-1,this._element.fitMode!==vo&&this.refreshMesh();}}},{key:"textureAsset",get:function(){return this._textureAsset},set:function(e){var t=this._system.app.assets,n=e;if(vq(e,pZ)&&(n=e.id),this._textureAsset!==n){if(this._textureAsset){t.off("add:"+this._textureAsset,this._onTextureAdded,this);var i=t.get(this._textureAsset);i&&(i.off("load",this._onTextureLoad,this),i.off("change",this._onTextureChange,this),i.off("remove",this._onTextureRemove,this));}if(this._textureAsset=n,this._textureAsset){var r=t.get(this._textureAsset);r?this._bindTextureAsset(r):(this.texture=null,t.on("add:"+this._textureAsset,this._onTextureAdded,this));}else this.texture=null;}}},{key:"spriteAsset",get:function(){return this._spriteAsset},set:function(e){var t=this._system.app.assets,n=e;if(vq(e,pZ)&&(n=e.id),this._spriteAsset!==n){if(this._spriteAsset){t.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this);var i=t.get(this._spriteAsset);i&&this._unbindSpriteAsset(i);}if(this._spriteAsset=n,this._spriteAsset){var r=t.get(this._spriteAsset);r?this._bindSpriteAsset(r):(this.sprite=null,t.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this));}else this.sprite=null;}this._element&&this._element.fire("set:spriteAsset",n);}},{key:"sprite",get:function(){return this._sprite},set:function(e){if(this._sprite!==e){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){var t=this._system.app.assets.get(this._spriteAsset);t&&t.resource!==e&&(this.spriteAsset=null);}this._sprite=e,this._sprite&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=ek.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite();}}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){var t=this._spriteFrame;this._sprite?this._spriteFrame=ek.clamp(e,0,this._sprite.frameKeys.length-1):this._spriteFrame=e,this._spriteFrame!==t&&this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",e);}},{key:"mesh",get:function(){return this._renderable.mesh},set:function(e){this._renderable.setMesh(e),this._defaultMesh===e?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc);}},{key:"mask",get:function(){return this._mask},set:function(e){this._mask!==e&&(this._mask=e,this._toggleMask());}},{key:"pixelsPerUnit",get:function(){return this._pixelsPerUnit},set:function(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this._sprite&&(1===this._sprite.renderMode||2===this._sprite.renderMode)&&this._updateSprite());}},{key:"aabb",get:function(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function v$(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function v0(e,t){return (v0=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var v1=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this)._app=t,t.i18n.on(ml.EVENT_CHANGE,n._onSetLocale,n),n._autoLoad=false,n._disableLocalization=false,n._defaultAsset=null,n._localizedAsset=null,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&v0(t,e);var n,i=t.prototype;return i._bindDefaultAsset=function(){var e=this._app.assets.get(this._defaultAsset);e?this._onDefaultAssetAdd(e):this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);},i._unbindDefaultAsset=function(){if(this._defaultAsset){this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);var e=this._app.assets.get(this._defaultAsset);e&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleRemove,this),e.off("remove",this._onDefaultAssetRemove,this));}},i._onDefaultAssetAdd=function(e){this._defaultAsset===e.id&&(e.on("add:localized",this._onLocaleAdd,this),e.on("remove:localized",this._onLocaleRemove,this),e.once("remove",this._onDefaultAssetRemove,this));},i._onDefaultAssetRemove=function(e){this._defaultAsset===e.id&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this));},i._bindLocalizedAsset=function(){if(this._autoLoad){var e=this._app.assets.get(this._localizedAsset);e&&(e.on("load",this._onLocalizedAssetLoad,this),e.on("change",this._onLocalizedAssetChange,this),e.on("remove",this._onLocalizedAssetRemove,this),e.resource?this._onLocalizedAssetLoad(e):this._app.assets.load(e));}},i._unbindLocalizedAsset=function(){var e=this._app.assets.get(this._localizedAsset);e&&(e.off("load",this._onLocalizedAssetLoad,this),e.off("change",this._onLocalizedAssetChange,this),e.off("remove",this._onLocalizedAssetRemove,this));},i._onLocalizedAssetAdd=function(e){this._localizedAsset===e.id&&this._bindLocalizedAsset();},i._onLocalizedAssetLoad=function(e){this.fire("load",e);},i._onLocalizedAssetChange=function(e,t,n,i){this.fire("change",e,t,n,i);},i._onLocalizedAssetRemove=function(e){this._localizedAsset===e.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",e);},i._onLocaleAdd=function(e,t){this._app.i18n.locale===e&&this._onSetLocale(e);},i._onLocaleRemove=function(e,t){this._app.i18n.locale===e&&this._onSetLocale(e);},i._onSetLocale=function(e){if(!this._defaultAsset){this.localizedAsset=null;return}var t=this._app.assets.get(this._defaultAsset);if(!t||this._disableLocalization){this.localizedAsset=this._defaultAsset;return}var n=t.getLocalizedAssetId(e);if(!n){this.localizedAsset=this._defaultAsset;return}this.localizedAsset=n;},i.destroy=function(){this.defaultAsset=null,this._app.i18n.off(ml.EVENT_CHANGE,this._onSetLocale,this),this.off();},n=[{key:"defaultAsset",get:function(){return this._defaultAsset},set:function(e){var t=v$(e,pZ)?e.id:e;this._defaultAsset!==t&&(this._defaultAsset&&this._unbindDefaultAsset(),this._defaultAsset=t,this._defaultAsset&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale));}},{key:"localizedAsset",get:function(){return this._localizedAsset},set:function(e){var t=v$(e,pZ)?e.id:e;this._localizedAsset!==t&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset()),this._localizedAsset=t,this._localizedAsset&&(this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this)));}},{key:"autoLoad",get:function(){return this._autoLoad},set:function(e){this._autoLoad!==e&&(this._autoLoad=e,this._autoLoad&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset()));}},{key:"disableLocalization",get:function(){return this._disableLocalization},set:function(e){this._disableLocalization!==e&&(this._disableLocalization=e,this._onSetLocale(this._app.i18n.locale));}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex),v2="msdf",v3="bitmap",v4=/[\w|/]/,v5=function(){function e(e){this._symbols=e,this._index=0,this._last=0,this._cur=this._symbols.length>0?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null;}var t=e.prototype;return t.read=function(){for(var e=this._read();8===e;)e=this._read();return 0!==e&&1!==e&&(this._last=this._index),e},t.buf=function(){return this._buf},t.last=function(){return this._last},t.error=function(){return this._error},t.debugPrint=function(){for(var e=["EOF","ERROR","TEXT","OPEN_BRACKET","CLOSE_BRACKET","EQUALS","STRING","IDENTIFIER","WHITESPACE"],t=this.read(),n="";n+=(n.length>0?"\n":"")+e[t]+" '"+this.buf().join("")+"'",0!==t&&1!==t;)t=this.read();return n},t._read=function(){return (this._buf=[],this._eof())?0:"text"===this._mode?this._text():this._tag()},t._text=function(){for(;;)switch(this._cur){case null:return 2*(this._buf.length>0);case "[":return this._mode="tag",this._buf.length>0?2:this._tag();case "\\":this._next(),"["===this._cur?this._store():this._output("\\");break;default:this._store();}},t._tag=function(){switch(this._cur){case null:return this._error="unexpected end of input reading tag",1;case "[":return this._store(),3;case "]":return this._store(),this._mode="text",4;case "=":return this._store(),5;case " ":case "	":case "\n":case "\r":case "\v":case "\f":return this._whitespace();case '"':return this._string();default:if(!this._isIdentifierSymbol(this._cur))return this._error="unrecognized character",1;return this._identifier()}},t._whitespace=function(){for(this._store();-1!==" 	\n\r\v\f".indexOf(this._cur);)this._store();return 8},t._string=function(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",1;case '"':return this._next(),6;default:this._store();}},t._identifier=function(){for(this._store();null!==this._cur&&this._isIdentifierSymbol(this._cur);)this._store();return 7},t._isIdentifierSymbol=function(e){return 1===e.length&&null!==e.match(v4)},t._eof=function(){return null===this._cur},t._next=function(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur},t._store=function(){return this._buf.push(this._cur),this._next()},t._output=function(e){this._buf.push(e);},e}(),v8=function(){function e(e){this._scanner=new v5(e),this._error=null;}var t=e.prototype;return t.parse=function(e,t){for(;;)switch(this._scanner.read()){case 0:return  true;case 1:default:return  false;case 2:Array.prototype.push.apply(e,this._scanner.buf());break;case 3:if(!this._parseTag(e,t))return  false}},t.error=function(){return "Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"},t._parseTag=function(e,t){var n=this._scanner.read();if(7!==n)return this._error="expected identifier",false;var i=this._scanner.buf().join("");if("/"===i[0]){for(var r=t.length-1;r>=0;--r)if(i==="/"+t[r].name&&null===t[r].end){if(t[r].end=e.length,4!==(n=this._scanner.read()))return this._error="expected close bracket",false;return  true}return this._error="failed to find matching tag",false}var s={name:i,value:null,attributes:{},start:e.length,end:null};if(5===(n=this._scanner.read())){if(6!==(n=this._scanner.read()))return this._error="expected string",false;s.value=this._scanner.buf().join(""),n=this._scanner.read();}for(;;){switch(n){case 4:return t.push(s),true;case 7:var a=this._scanner.buf().join("");if(5!==(n=this._scanner.read()))return this._error="expected equals",false;if(6!==(n=this._scanner.read()))return this._error="expected string",false;var o=this._scanner.buf().join("");s.attributes[a]=o;break;default:return this._error="expected close bracket or identifier",false}n=this._scanner.read();}},e}(),v6=function(){function e(){}return e.evaluate=function(e){var t=new v8(e),n=[],r=[];if(!t.parse(n,r)||r.find(function(e){return null===e.end}))return {symbols:e,tags:null};var s=function(e,t){if(0===e.length)return null;for(var n={},r=0;r<e.length;++r){var s=e[r];n.hasOwnProperty(s.start)?null===n[s.start].open?n[s.start].open=[s]:n[s.start].open.push(s):n[s.start]={open:[s],close:null},n.hasOwnProperty(s.end)?null===n[s.end].close?n[s.end].close=[s]:n[s.end].close.push(s):n[s.end]={open:null,close:[s]};}for(var a=[],o=Object.keys(n).sort(function(e,t){return e-t}),l=[],u=0;u<o.length;++u){var c=n[o[u]];null!==c.close&&function(e){a=a.filter(function(t){return void 0===e.find(function(e){return e===t})});}(c.close),null!==c.open&&function(e){for(var t=0;t<e.length;++t)a.push(e[t]);}(c.open),l.push({start:o[u],tags:function(e){if(0===e.length)return null;for(var t={},n=0;n<e.length;++n){var r=e[n],s={};s[r.name]={value:r.value,attributes:r.attributes},function e(t,n){for(var r in n)if(n.hasOwnProperty(r)){var s,a=n[r];(null!=(s=Object)&&"undefined"!=typeof Symbol&&s[Symbol.hasInstance]?!!s[Symbol.hasInstance](a):i(a,s))?(t.hasOwnProperty(r)||(t[r]={}),e(t[r],n[r])):t[r]=a;}}(t,s);}return t}(a)});}for(var h=[],f=null,d=0;d<l.length;++d){for(var p=l[d];h.length<p.start;)h.push(f?f.tags:null);f=p;}for(;h.length<t;)h.push(null);return h}(r,n.length);return {symbols:n,tags:s}},e}();function v9(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}var v7=function(){this.count=0,this.quad=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.outlines=[],this.shadows=[],this.meshInstance=null;},ge=/^[\r\n]$/,gt=/^[ \t]$/,gn=/^[ \t\-]|\u200b$/,gi=/^[a-z0-9]$/i,gr=/^[\u1100-\u11ff]|[\u3000-\u9fff\ua960-\ua97f]|[\uac00-\ud7ff]$/,gs=/^[〕〉》」』】〙〗〟ヽヾーァィゥェォッャュョヮヵヶぁぃぅぇぉっゃゅょゎゕゖㇰㇱㇲㇳㇴㇵㇶㇷㇸㇹㇺㇻㇼㇽㇾㇿ々〻]$/,ga=["​","؜","‎","‏","‪","‫","‬","‭","‮","⁦","⁧","⁨","⁩"],go={width:0,height:0,xadvance:0,xoffset:0,yoffset:0},gl=new eN,gu=new eX,gc=new eN,gh=function(){function e(e){this._element=e,this._system=e.system,this._entity=e.entity,this._text="",this._symbols=[],this._colorPalette=[],this._outlinePalette=[],this._shadowPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null,this._i18nKey=null,this._fontAsset=new v1(this._system.app),this._fontAsset.disableLocalization=true,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new eN(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMinY=0,this._fontMaxY=0,this._originalFontSize=32,this._maxFontSize=32,this._minFontSize=8,this._autoFitWidth=false,this._autoFitHeight=false,this._maxLines=-1,this._lineHeight=32,this._scaledLineHeight=32,this._wrapLines=false,this._drawOrder=0,this._alignment=new eX(.5,.5),this._autoWidth=true,this._autoHeight=true,this.width=0,this.height=0,this._node=new us,this._model=new he,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=true,this._aabb=new e8,this._noResize=false,this._currentMaterialType=null,this._maskedMaterialSrc=null,this._rtlReorder=false,this._unicodeConverter=false,this._rtl=false,this._outlineColor=new eN(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new eN(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new eX(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=false,this._onScreenChange(this._element.screen),e.on("resize",this._onParentResize,this),e.on("set:screen",this._onScreenChange,this),e.on("screen:set:screenspace",this._onScreenSpaceChange,this),e.on("set:draworder",this._onDrawOrderChange,this),e.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on(ml.EVENT_CHANGE,this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeStart=0,this._rangeEnd=0;}var t,n=e.prototype;return n.destroy=function(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off(ml.EVENT_CHANGE,this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this);},n._onParentResize=function(e,t){!this._noResize&&this._font&&this._updateText();},n._onScreenChange=function(e){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(false);},n._onScreenSpaceChange=function(e){this._updateMaterial(e);},n._onDrawOrderChange=function(e){if(this._drawOrder=e,this._model)for(var t=0,n=this._model.meshInstances.length;t<n;t++)this._model.meshInstances[t].drawOrder=e;},n._onPivotChange=function(e){this._font&&this._updateText();},n._onLocaleSet=function(e){if(this._i18nKey){if(this.fontAsset){var t=this._system.app.assets.get(this.fontAsset);t&&t.resource&&t.resource===this._font||(this.font=null);}this._resetLocalizedText();}},n._onLocalizationData=function(e,t){this._i18nKey&&t[this._i18nKey]&&this._resetLocalizedText();},n._resetLocalizedText=function(){this._setText(this._system.app.i18n.getText(this._i18nKey));},n._setText=function(e){if(this.unicodeConverter){var t=this._system.getUnicodeConverter();t&&(e=t(e));}this._text!==e&&(this._font&&this._updateText(e),this._text=e);},n._updateText=function(e){if(void 0===e&&(e=this._text),this._symbols=ev.getSymbols(e.normalize?e.normalize("NFC"):e),0===this._symbols.length&&(this._symbols=[" "]),this._enableMarkup){var t,n=v6.evaluate(this._symbols);this._symbols=n.symbols,t=n.tags||[];}if(this._rtlReorder){var i=this._system.app.systems.element.getRtlReorder();if(i){var r=i(this._symbols);this._rtl=r.rtl,this._symbols=r.mapping.map(function(e){return this._symbols[e]},this),t&&(t=r.mapping.map(function(e){return t[e]}));}}else this._rtl=false;var s=function(e,t){return e.toString(true).toLowerCase()+":"+t.toFixed(2)},a=function(e,t){return e.toString(true).toLowerCase()+":"+t.x.toFixed(2)+":"+t.y.toFixed(2)};if(t){var o={},l={},u={};this._colorPalette=[Math.round(255*this._color.r),Math.round(255*this._color.g),Math.round(255*this._color.b)],this._outlinePalette=[Math.round(255*this._outlineColor.r),Math.round(255*this._outlineColor.g),Math.round(255*this._outlineColor.b),Math.round(255*this._outlineColor.a),Math.round(255*this._outlineThickness)],this._shadowPalette=[Math.round(255*this._shadowColor.r),Math.round(255*this._shadowColor.g),Math.round(255*this._shadowColor.b),Math.round(255*this._shadowColor.a),Math.round(127*this._shadowOffset.x),Math.round(127*this._shadowOffset.y)],this._symbolColors=[],this._symbolOutlineParams=[],this._symbolShadowParams=[],o[this._color.toString(false).toLowerCase()]=0,l[s(this._outlineColor,this._outlineThickness)]=0,u[a(this._shadowColor,this._shadowOffset)]=0;for(var c=0,h=this._symbols.length;c<h;++c){var f=t[c],d=0;if(f&&f.color&&f.color.value){var p=f.color.value;if(7===p.length&&"#"===p[0]){var m=p.substring(1).toLowerCase();o.hasOwnProperty(m)?d=o[m]:/^[0-9a-f]{6}$/.test(m)&&(d=this._colorPalette.length/3,o[m]=d,this._colorPalette.push(parseInt(m.substring(0,2),16)),this._colorPalette.push(parseInt(m.substring(2,4),16)),this._colorPalette.push(parseInt(m.substring(4,6),16)));}}this._symbolColors.push(d);var _=0;if(f&&f.outline&&(f.outline.attributes.color||f.outline.attributes.thickness)){var v=f.outline.attributes.color?gl.fromString(f.outline.attributes.color):this._outlineColor,g=Number(f.outline.attributes.thickness);(Number.isNaN(v.r)||Number.isNaN(v.g)||Number.isNaN(v.b)||Number.isNaN(v.a))&&(v=this._outlineColor),Number.isNaN(g)&&(g=this._outlineThickness);var y=s(v,g);l.hasOwnProperty(y)?_=l[y]:(_=this._outlinePalette.length/5,l[y]=_,this._outlinePalette.push(Math.round(255*v.r),Math.round(255*v.g),Math.round(255*v.b),Math.round(255*v.a),Math.round(255*g)));}this._symbolOutlineParams.push(_);var S=0;if(f&&f.shadow&&(f.shadow.attributes.color||f.shadow.attributes.offset||f.shadow.attributes.offsetX||f.shadow.attributes.offsetY)){var x=f.shadow.attributes.color?gl.fromString(f.shadow.attributes.color):this._shadowColor,b=Number(f.shadow.attributes.offset),T=Number(f.shadow.attributes.offsetX),E=Number(f.shadow.attributes.offsetY);(Number.isNaN(x.r)||Number.isNaN(x.g)||Number.isNaN(x.b)||Number.isNaN(x.a))&&(x=this._shadowColor);var w=gu.set(Number.isNaN(T)?Number.isNaN(b)?this._shadowOffset.x:b:T,Number.isNaN(E)?Number.isNaN(b)?this._shadowOffset.y:b:E),A=a(x,w);u.hasOwnProperty(A)?S=u[A]:(S=this._shadowPalette.length/6,u[A]=S,this._shadowPalette.push(Math.round(255*x.r),Math.round(255*x.g),Math.round(255*x.b),Math.round(255*x.a),Math.round(127*w.x),Math.round(127*w.y)));}this._symbolShadowParams.push(S);}}else this._colorPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null;this._updateMaterialEmissive(),this._updateMaterialOutline(),this._updateMaterialShadow();for(var C=this._calculateCharsPerTexture(),P=false,I=this._element,L=I._isScreenSpace(),D=I._isScreenCulled(),M=function(e){return I.isVisibleForCamera(e)},R=0,O=this._meshInfo.length;R<O;R++){var k=C[R]||0,N=this._meshInfo[R];if(N.count!==k){if(P||(I.removeModelFromLayers(this._model),P=true),N.count=k,N.positions.length=N.normals.length=3*k*4,N.indices.length=3*k*2,N.uvs.length=2*k*4,N.colors.length=4*k*4,N.outlines.length=4*k*3,N.shadows.length=4*k*3,N.meshInstance&&this._removeMeshInstance(N.meshInstance),0===k){N.meshInstance=null;continue}for(var F=0;F<k;F++)N.indices[3*F*2+0]=4*F,N.indices[3*F*2+1]=4*F+1,N.indices[3*F*2+2]=4*F+3,N.indices[3*F*2+3]=4*F+2,N.indices[3*F*2+4]=4*F+3,N.indices[3*F*2+5]=4*F+1,N.normals[4*F*3+0]=0,N.normals[4*F*3+1]=0,N.normals[4*F*3+2]=-1,N.normals[4*F*3+3]=0,N.normals[4*F*3+4]=0,N.normals[4*F*3+5]=-1,N.normals[4*F*3+6]=0,N.normals[4*F*3+7]=0,N.normals[4*F*3+8]=-1,N.normals[4*F*3+9]=0,N.normals[4*F*3+10]=0,N.normals[4*F*3+11]=-1;var B=new lL(function(e,t){var n=new l_(e);return n.setPositions(t.positions),n.setNormals(t.normals),n.setColors32(t.colors),n.setUvs(0,t.uvs),n.setIndices(t.indices),n.setVertexStream(tX,t.outlines,3,void 0,6,false),n.setVertexStream(tY,t.shadows,3,void 0,6,false),n.update(),n}(this._system.app.graphicsDevice,N),this._material,this._node);if(B.name="Text Element: "+this._entity.name,B.castShadow=false,B.receiveShadow=false,B.cull=!L,B.screenSpace=L,B.drawOrder=this._drawOrder,D&&(B.cull=true,B.isVisibleFunc=M),this._setTextureParams(B,this._font.textures[R]),B.setParameter("material_emissive",this._colorUniform),B.setParameter("material_opacity",this._color.a),B.setParameter("font_sdfIntensity",this._font.intensity),B.setParameter("font_pxrange",this._getPxRange(this._font)),B.setParameter("font_textureWidth",this._font.data.info.maps[R].width),B.setParameter("outline_color",this._outlineColorUniform),B.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),B.setParameter("shadow_color",this._shadowColorUniform),this._symbolShadowParams)this._shadowOffsetUniform[0]=0,this._shadowOffsetUniform[1]=0;else {var U=-this._font.data.info.maps[R].width/this._font.data.info.maps[R].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=U*this._shadowOffsetScale*this._shadowOffset.y;}B.setParameter("shadow_offset",this._shadowOffsetUniform),N.meshInstance=B,this._model.meshInstances.push(B);}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),P&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange();},n._removeMeshInstance=function(e){e.destroy();var t=this._model.meshInstances.indexOf(e);-1!==t&&this._model.meshInstances.splice(t,1);},n._setMaterial=function(e){if(this._material=e,this._model)for(var t=0,n=this._model.meshInstances.length;t<n;t++)this._model.meshInstances[t].material=e;},n._updateMaterial=function(e){var t=this._element,n=t._isScreenCulled(),i=function(e){return t.isVisibleForCamera(e)},r=this._font&&this._font.type===v2;if(this._material=this._system.getTextElementMaterial(e,r,this._enableMarkup),this._model)for(var s=0,a=this._model.meshInstances.length;s<a;s++){var o=this._model.meshInstances[s];o.cull=!e,o.material=this._material,o.screenSpace=e,n?(o.cull=true,o.isVisibleFunc=i):o.isVisibleFunc=null;}},n._updateMaterialEmissive=function(){this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(gc.linear(this._color),this._colorUniform[0]=gc.r,this._colorUniform[1]=gc.g,this._colorUniform[2]=gc.b);},n._updateMaterialOutline=function(){this._symbolOutlineParams?(this._outlineColorUniform[0]=0,this._outlineColorUniform[1]=0,this._outlineColorUniform[2]=0,this._outlineColorUniform[3]=1):(gc.linear(this._outlineColor),this._outlineColorUniform[0]=gc.r,this._outlineColorUniform[1]=gc.g,this._outlineColorUniform[2]=gc.b,this._outlineColorUniform[3]=gc.a);},n._updateMaterialShadow=function(){this._symbolOutlineParams?(this._shadowColorUniform[0]=0,this._shadowColorUniform[1]=0,this._shadowColorUniform[2]=0,this._shadowColorUniform[3]=0):(gc.linear(this._shadowColor),this._shadowColorUniform[0]=gc.r,this._shadowColorUniform[1]=gc.g,this._shadowColorUniform[2]=gc.b,this._shadowColorUniform[3]=gc.a);},n._isWordBoundary=function(e){return gn.test(e)},n._isValidNextChar=function(e){return null!==e&&!gs.test(e)},n._isNextCJKBoundary=function(e,t){return gr.test(e)&&(gn.test(t)||gi.test(t))},n._isNextCJKWholeWord=function(e){return gr.test(e)},n._updateMeshes=function(){var e,t,n,i,r=this._font.data,s=this,a=Math.min(this._minFontSize,this._maxFontSize),o=this._maxFontSize,l=this._shouldAutoFit();l&&(this._fontSize=this._maxFontSize);var u=this._symbols.length,c=0,h=0,f=0,d=0,p=1,m=0,_=0,v=0,g=0,y=0,S=0,x=Math.abs(this._element.anchor.x-this._element.anchor.z)>=1e-4,b=this._element.calculatedWidth;(!this.autoWidth||x)&&this._wrapLines||(b=Number.POSITIVE_INFINITY);var T=0,E=0;function w(e,t,n){s._lineWidths.push(Math.abs(n));var i=v>t?t+1:v,r=v>t?v+1:t,a=e.slice(i,r);if(S)for(var o=a.length;o--&&S>0;)ge.test(a[o])&&(a.splice(o,1),S--);s._lineContents.push(a.join("")),c=0,h-=s._scaledLineHeight,p++,g=0,y=0,S=0,m=0,v=t;}for(var A=true;A;){A=false,l?this._scaledLineHeight=this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._scaledLineHeight=this._lineHeight,this.width=0,this.height=0,this._lineWidths=[],this._lineContents=[],c=0,h=0,f=0,d=0,p=1,m=0,_=0,v=0,g=0,y=0,S=0;var C=this._fontSize/32;T=this._fontMinY*C,E=this._fontMaxY*C;for(var P=0;P<this._meshInfo.length;P++)this._meshInfo[P].quad=0,this._meshInfo[P].lines={};for(var I=255,L=255,D=255,M=65535,R=65535,O=0,k=65535,N=65535,F=32639,B=0;B<u;B++){if(e=this._symbols[B],i=B+1>=u?null:this._symbols[B+1],ge.test(e)){S++,(!this._wrapLines||this._maxLines<0||p<this._maxLines)&&(w(this._symbols,B,d),_=B+1,v=B+1);continue}var U=0,z=0,V=0,G=1,H=void 0;if(!(t=r.chars[e]))if(-1!==ga.indexOf(e))t=go;else if(r.chars[" "])t=r.chars[" "];else for(var j in r.chars){t=r.chars[j];break}if(t){var X=0;if(y>0){var Y=this._font.data.kerning;if(Y){var q=Y[ev.getCodePoint(this._symbols[B-1])||0];q&&(X=q[ev.getCodePoint(this._symbols[B])||0]||0);}}H=t.scale||1,G=C*((t.width+t.height)/2)/H,V=(t.xadvance+X)*C,U=(t.xoffset-X)*C,z=t.yoffset*C;}var K=gt.test(e),Z=t&&t.map||0,Q=-this._font.data.info.maps[Z].width/this._font.data.info.maps[Z].height,J=this._meshInfo[Z],$=c+this._spacing*V;if($>b&&y>0&&!K&&(this._maxLines<0||p<this._maxLines))if(0===g)_=B,w(this._symbols,B,d);else {var ee=Math.max(B-_,0);if(this._meshInfo.length<=1)J.lines[p-1]-=ee,J.quad-=ee;else for(var et=_,en=B,ei=et;ei<en;ei++){var er=this._symbols[ei],es=r.chars[er],ea=this._meshInfo[es&&es.map||0];ea.lines[p-1]-=1,ea.quad-=1;}B-=ee+1,w(this._symbols,_,m);continue}n=J.quad,J.lines[p-1]=n;var eo=c-U,el=eo+G,eu=h-z,ec=eu+G;if(this._rtl){var eh=G-U-this._spacing*V-U;eo-=eh,el-=eh;}J.positions[4*n*3+0]=eo,J.positions[4*n*3+1]=eu,J.positions[4*n*3+2]=f,J.positions[4*n*3+3]=el,J.positions[4*n*3+4]=eu,J.positions[4*n*3+5]=f,J.positions[4*n*3+6]=el,J.positions[4*n*3+7]=ec,J.positions[4*n*3+8]=f,J.positions[4*n*3+9]=eo,J.positions[4*n*3+10]=ec,J.positions[4*n*3+11]=f,this.width=Math.max(this.width,$);var ef=void 0;if(this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(ef=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),(ef=ek.clamp(ef,a,o))!==this._element.fontSize)||(this.height=Math.max(this.height,E-(h+T)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(ef=ek.clamp(this._fontSize-1,a,o))!==this._element.fontSize)){this._fontSize=ef,A=true;break}c+=this._spacing*V,K||(d=c),(this._isWordBoundary(e)||this._isValidNextChar(i)&&(this._isNextCJKBoundary(e,i)||this._isNextCJKWholeWord(i)))&&(g++,m=d,_=B+1),y++;var ed=this._getUv(e);if(J.uvs[4*n*2+0]=ed[0],J.uvs[4*n*2+1]=1-ed[1],J.uvs[4*n*2+2]=ed[2],J.uvs[4*n*2+3]=1-ed[1],J.uvs[4*n*2+4]=ed[2],J.uvs[4*n*2+5]=1-ed[3],J.uvs[4*n*2+6]=ed[0],J.uvs[4*n*2+7]=1-ed[3],this._symbolColors){var ep=3*this._symbolColors[B];I=this._colorPalette[ep],L=this._colorPalette[ep+1],D=this._colorPalette[ep+2];}if(J.colors[4*n*4+0]=I,J.colors[4*n*4+1]=L,J.colors[4*n*4+2]=D,J.colors[4*n*4+3]=255,J.colors[4*n*4+4]=I,J.colors[4*n*4+5]=L,J.colors[4*n*4+6]=D,J.colors[4*n*4+7]=255,J.colors[4*n*4+8]=I,J.colors[4*n*4+9]=L,J.colors[4*n*4+10]=D,J.colors[4*n*4+11]=255,J.colors[4*n*4+12]=I,J.colors[4*n*4+13]=L,J.colors[4*n*4+14]=D,J.colors[4*n*4+15]=255,this._symbolOutlineParams){var em=5*this._symbolOutlineParams[B];M=this._outlinePalette[em]+256*this._outlinePalette[em+1],R=this._outlinePalette[em+2]+256*this._outlinePalette[em+3],O=this._outlinePalette[em+4];}if(J.outlines[4*n*3+0]=M,J.outlines[4*n*3+1]=R,J.outlines[4*n*3+2]=O,J.outlines[4*n*3+3]=M,J.outlines[4*n*3+4]=R,J.outlines[4*n*3+5]=O,J.outlines[4*n*3+6]=M,J.outlines[4*n*3+7]=R,J.outlines[4*n*3+8]=O,J.outlines[4*n*3+9]=M,J.outlines[4*n*3+10]=R,J.outlines[4*n*3+11]=O,this._symbolShadowParams){var e_=6*this._symbolShadowParams[B];k=this._shadowPalette[e_]+256*this._shadowPalette[e_+1],N=this._shadowPalette[e_+2]+256*this._shadowPalette[e_+3],F=this._shadowPalette[e_+4]+127+256*Math.round(Q*this._shadowPalette[e_+5]+127);}J.shadows[4*n*3+0]=k,J.shadows[4*n*3+1]=N,J.shadows[4*n*3+2]=F,J.shadows[4*n*3+3]=k,J.shadows[4*n*3+4]=N,J.shadows[4*n*3+5]=F,J.shadows[4*n*3+6]=k,J.shadows[4*n*3+7]=N,J.shadows[4*n*3+8]=F,J.shadows[4*n*3+9]=k,J.shadows[4*n*3+10]=N,J.shadows[4*n*3+11]=F,J.quad++;}!A&&v<u&&w(this._symbols,u,c);}this._noResize=true,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=false;for(var eg=this._element.pivot.x,ey=this._element.pivot.y,eS=this._alignment.x,ex=this._alignment.y,eb=0;eb<this._meshInfo.length;eb++)if(0!==this._meshInfo[eb].count){var eT=0;for(var eE in this._meshInfo[eb].lines){for(var ew=this._meshInfo[eb].lines[eE],eA=this._lineWidths[parseInt(eE,10)],eC=-eg*this._element.calculatedWidth+eS*(this._element.calculatedWidth-eA)*(this._rtl?-1:1),eP=(1-ey)*this._element.calculatedHeight-E-(1-ex)*(this._element.calculatedHeight-this.height),eI=eT;eI<=ew;eI++)this._meshInfo[eb].positions[4*eI*3]+=eC,this._meshInfo[eb].positions[4*eI*3+3]+=eC,this._meshInfo[eb].positions[4*eI*3+6]+=eC,this._meshInfo[eb].positions[4*eI*3+9]+=eC,this._meshInfo[eb].positions[4*eI*3+1]+=eP,this._meshInfo[eb].positions[4*eI*3+4]+=eP,this._meshInfo[eb].positions[4*eI*3+7]+=eP,this._meshInfo[eb].positions[4*eI*3+10]+=eP;if(this._rtl)for(var eL=eT;eL<=ew;eL++){for(var eD=4*eL*3,eM=0;eM<4;++eM)this._meshInfo[eb].positions[eD+3*eM]=this._element.calculatedWidth-this._meshInfo[eb].positions[eD+3*eM]+2*eC;var eR=this._meshInfo[eb].positions[eD+3],eO=this._meshInfo[eb].positions[eD+6];this._meshInfo[eb].positions[eD+3]=this._meshInfo[eb].positions[eD+0],this._meshInfo[eb].positions[eD+6]=this._meshInfo[eb].positions[eD+9],this._meshInfo[eb].positions[eD+0]=eR,this._meshInfo[eb].positions[eD+9]=eO;}eT=ew+1;}for(var eN=4*this._meshInfo[eb].count,eF=4*this._meshInfo[eb].quad,eB=new ao(this._meshInfo[eb].meshInstance.mesh.vertexBuffer),eU=0;eU<eN;eU++)eU>=eF?(eB.element[tT].set(0,0,0),eB.element[tL].set(0,0),eB.element[tP].set(0,0,0,0),eB.element[tX].set(0,0,0,0),eB.element[tY].set(0,0,0,0)):(eB.element[tT].set(this._meshInfo[eb].positions[3*eU+0],this._meshInfo[eb].positions[3*eU+1],this._meshInfo[eb].positions[3*eU+2]),eB.element[tL].set(this._meshInfo[eb].uvs[2*eU+0],this._meshInfo[eb].uvs[2*eU+1]),eB.element[tP].set(this._meshInfo[eb].colors[4*eU+0],this._meshInfo[eb].colors[4*eU+1],this._meshInfo[eb].colors[4*eU+2],this._meshInfo[eb].colors[4*eU+3]),eB.element[tX].set(this._meshInfo[eb].outlines[3*eU+0],this._meshInfo[eb].outlines[3*eU+1],this._meshInfo[eb].outlines[3*eU+2]),eB.element[tY].set(this._meshInfo[eb].shadows[3*eU+0],this._meshInfo[eb].shadows[3*eU+1],this._meshInfo[eb].shadows[3*eU+2])),eB.next();eB.end(),this._meshInfo[eb].meshInstance.mesh.aabb.compute(this._meshInfo[eb].positions),this._meshInfo[eb].meshInstance._aabbVer=-1;}this._aabbDirty=true;},n._onFontRender=function(){this.font=this._font;},n._onFontLoad=function(e){this.font!==e.resource&&(this.font=e.resource);},n._onFontChange=function(e,t,n,i){if("data"===t){this._font.data=n;for(var r=this._font.data.info.maps.length,s=0;s<r;s++)if(this._meshInfo[s]){var a=this._meshInfo[s].meshInstance;a&&(a.setParameter("font_sdfIntensity",this._font.intensity),a.setParameter("font_pxrange",this._getPxRange(this._font)),a.setParameter("font_textureWidth",this._font.data.info.maps[s].width));}}},n._onFontRemove=function(e){},n._setTextureParams=function(e,t){this._font&&(this._font.type===v2?(e.deleteParameter("texture_emissiveMap"),e.deleteParameter("texture_opacityMap"),e.setParameter("texture_msdfMap",t)):this._font.type===v3&&(e.deleteParameter("texture_msdfMap"),e.setParameter("texture_emissiveMap",t),e.setParameter("texture_opacityMap",t)));},n._getPxRange=function(e){for(var t=Object.keys(this._font.data.chars),n=0;n<t.length;n++){var i=this._font.data.chars[t[n]];if(i.range)return (i.scale||1)*i.range}return 2},n._getUv=function(e){var t=this._font.data;if(!t.chars[e])return t.chars[" "]?this._getUv(" "):[0,0,0,0];var n=t.chars[e].map,i=t.info.maps[n].width,r=t.info.maps[n].height,s=t.chars[e].x,a=t.chars[e].y,o=s+t.chars[e].width,l=a-t.chars[e].height,u=1-t.chars[e].height/r;return [s/i,u-a/r,o/i,u-l/r]},n.onEnable=function(){this._fontAsset.autoLoad=true,this._model&&this._element.addModelToLayers(this._model);},n.onDisable=function(){this._fontAsset.autoLoad=false,this._model&&this._element.removeModelFromLayers(this._model);},n._setStencil=function(e){if(this._model)for(var t=this._model.meshInstances,n=0;n<t.length;n++)t[n].stencilFront=e,t[n].stencilBack=e;},n._shouldAutoFitWidth=function(){return this._autoFitWidth&&!this._autoWidth},n._shouldAutoFitHeight=function(){return this._autoFitHeight&&!this._autoHeight},n._shouldAutoFit=function(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight},n._calculateCharsPerTexture=function(e){var t={};void 0===e&&(e=this._symbols.length);for(var n=0,i=e;n<i;n++){var r=this._symbols[n],s=this._font.data.chars[r];!s&&((s=this._font.data.chars[" "])||(s=this._font.data.chars[Object.keys(this._font.data.chars)[0]]));var a=s.map;t[a]?t[a]++:t[a]=1;}return t},n._updateRenderRange=function(){for(var e=0===this._rangeStart?0:this._calculateCharsPerTexture(this._rangeStart),t=0===this._rangeEnd?0:this._calculateCharsPerTexture(this._rangeEnd),n=0,i=this._meshInfo.length;n<i;n++){var r=e[n]||0,s=t[n]||0,a=this._meshInfo[n].meshInstance;if(a){var o=a.mesh;o&&(o.primitive[0].base=3*r*2,o.primitive[0].count=(s-r)*6);}}},t=[{key:"text",get:function(){return this._text},set:function(e){this._i18nKey=null;var t=null!=e&&e.toString()||"";this._setText(t);}},{key:"key",get:function(){return this._i18nKey},set:function(e){var t=null!==e?e.toString():null;this._i18nKey!==t&&(this._i18nKey=t,t?(this._fontAsset.disableLocalization=false,this._resetLocalizedText()):this._fontAsset.disableLocalization=true);}},{key:"color",get:function(){return this._color},set:function(e){var t=e.r,n=e.g,i=e.b;if((this._color.r!==t||this._color.g!==n||this._color.b!==i)&&(this._color.r=t,this._color.g=n,this._color.b=i,this._model)){if(this._symbolColors)this._font&&this._updateText();else {gc.linear(this._color),this._colorUniform[0]=gc.r,this._colorUniform[1]=gc.g,this._colorUniform[2]=gc.b;for(var r=0,s=this._model.meshInstances.length;r<s;r++)this._model.meshInstances[r].setParameter("material_emissive",this._colorUniform);}this._element&&this._element.fire("set:color",this._color);}}},{key:"opacity",get:function(){return this._color.a},set:function(e){if(this._color.a!==e&&(this._color.a=e,this._model))for(var t=0,n=this._model.meshInstances.length;t<n;t++)this._model.meshInstances[t].setParameter("material_opacity",e);this._element&&this._element.fire("set:opacity",e);}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){var t=this._lineHeight;this._lineHeight=e,this._scaledLineHeight=e,t!==e&&this._font&&this._updateText();}},{key:"wrapLines",get:function(){return this._wrapLines},set:function(e){var t=this._wrapLines;this._wrapLines=e,t!==e&&this._font&&this._updateText();}},{key:"lines",get:function(){return this._lineContents}},{key:"spacing",get:function(){return this._spacing},set:function(e){var t=this._spacing;this._spacing=e,t!==e&&this._font&&this._updateText();}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){var t=this._fontSize;this._fontSize=e,this._originalFontSize=e,t!==e&&this._font&&this._updateText();}},{key:"fontAsset",get:function(){return this._fontAsset.localizedAsset},set:function(e){this._fontAsset.defaultAsset=e;}},{key:"font",get:function(){return this._font},set:function(e){if(this._font&&(t=this._font.type,this._font.off&&this._font.off("render",this._onFontRender,this)),this._font=e,this._fontMinY=0,this._fontMaxY=0,e){var t,n=this._font.data;for(var i in n.chars){var r=n.chars[i];r.bounds&&(this._fontMinY=Math.min(this._fontMinY,r.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,r.bounds[3]));}if(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset&&this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null),e.type!==t){var s=this._element._isScreenSpace();this._updateMaterial(s);}for(var a=0,o=this._font.textures.length;a<o;a++)if(this._meshInfo[a]){var l=this._meshInfo[a].meshInstance;l&&(l.setParameter("font_sdfIntensity",this._font.intensity),l.setParameter("font_pxrange",this._getPxRange(this._font)),l.setParameter("font_textureWidth",this._font.data.info.maps[a].width),this._setTextureParams(l,this._font.textures[a]));}else this._meshInfo[a]=new v7;for(var u=false,c=this._font.textures.length;c<this._meshInfo.length;c++)this._meshInfo[c].meshInstance&&(u||(this._element.removeModelFromLayers(this._model),u=true),this._removeMeshInstance(this._meshInfo[c].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText();}}},{key:"alignment",get:function(){return this._alignment},set:function(e){v9(e,eX)?this._alignment.set(e.x,e.y):this._alignment.set(e[0],e[1]),this._font&&this._updateText();}},{key:"autoWidth",get:function(){return this._autoWidth},set:function(e){var t=this._autoWidth;if(this._autoWidth=e,e&&1e-4>Math.abs(this._element.anchor.x-this._element.anchor.z)&&(this._element.width=this.width),t!==e){var n=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;n!==this._fontSize&&(this._fontSize=n,this._font&&this._updateText());}}},{key:"autoHeight",get:function(){return this._autoHeight},set:function(e){var t=this._autoHeight;if(this._autoHeight=e,e&&1e-4>Math.abs(this._element.anchor.y-this._element.anchor.w)&&(this._element.height=this.height),t!==e){var n=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;n!==this._fontSize&&(this._fontSize=n,this._font&&this._updateText());}}},{key:"rtlReorder",get:function(){return this._rtlReorder},set:function(e){this._rtlReorder!==e&&(this._rtlReorder=e,this._font&&this._updateText());}},{key:"unicodeConverter",get:function(){return this._unicodeConverter},set:function(e){this._unicodeConverter!==e&&(this._unicodeConverter=e,this._setText(this._text));}},{key:"aabb",get:function(){if(this._aabbDirty){for(var e=false,t=0;t<this._meshInfo.length;t++)this._meshInfo[t].meshInstance&&(e?this._aabb.add(this._meshInfo[t].meshInstance.aabb):(this._aabb.copy(this._meshInfo[t].meshInstance.aabb),e=true));this._aabbDirty=false;}return this._aabb}},{key:"outlineColor",get:function(){return this._outlineColor},set:function(e){var t=v9(e,eN)?e.r:e[0],n=v9(e,eN)?e.g:e[1],i=v9(e,eN)?e.b:e[2],r=v9(e,eN)?e.a:e[3];if((this._outlineColor.r!==t||this._outlineColor.g!==n||this._outlineColor.b!==i||this._outlineColor.a!==r)&&(this._outlineColor.r=t,this._outlineColor.g=n,this._outlineColor.b=i,this._outlineColor.a=r,this._model)){if(this._symbolOutlineParams)this._font&&this._updateText();else {gc.linear(this._outlineColor),this._outlineColorUniform[0]=gc.r,this._outlineColorUniform[1]=gc.g,this._outlineColorUniform[2]=gc.b,this._outlineColorUniform[3]=gc.a;for(var s=0,a=this._model.meshInstances.length;s<a;s++)this._model.meshInstances[s].setParameter("outline_color",this._outlineColorUniform);}this._element&&this._element.fire("set:outline",this._color);}}},{key:"outlineThickness",get:function(){return this._outlineThickness},set:function(e){var t=this._outlineThickness;if(this._outlineThickness=e,t!==e&&this._font){if(!this._model)return;if(this._symbolOutlineParams)this._font&&this._updateText();else for(var n=0,i=this._model.meshInstances.length;n<i;n++)this._model.meshInstances[n].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness);}}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){var t=v9(e,eN)?e.r:e[0],n=v9(e,eN)?e.g:e[1],i=v9(e,eN)?e.b:e[2],r=v9(e,eN)?e.a:e[3];if((this._shadowColor.r!==t||this._shadowColor.g!==n||this._shadowColor.b!==i||this._shadowColor.a!==r)&&(this._shadowColor.r=t,this._shadowColor.g=n,this._shadowColor.b=i,this._shadowColor.a=r,this._model))if(this._symbolShadowParams)this._font&&this._updateText();else {gc.linear(this._shadowColor),this._shadowColorUniform[0]=gc.r,this._shadowColorUniform[1]=gc.g,this._shadowColorUniform[2]=gc.b,this._shadowColorUniform[3]=gc.a;for(var s=0,a=this._model.meshInstances.length;s<a;s++)this._model.meshInstances[s].setParameter("shadow_color",this._shadowColorUniform);}}},{key:"shadowOffset",get:function(){return this._shadowOffset},set:function(e){var t=v9(e,eX)?e.x:e[0],n=v9(e,eX)?e.y:e[1];if((this._shadowOffset.x!==t||this._shadowOffset.y!==n)&&(this._shadowOffset.set(t,n),this._font&&this._model))if(this._symbolShadowParams)this._updateText();else for(var i=0,r=this._model.meshInstances.length;i<r;i++){var s=-this._font.data.info.maps[i].width/this._font.data.info.maps[i].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=s*this._shadowOffsetScale*this._shadowOffset.y,this._model.meshInstances[i].setParameter("shadow_offset",this._shadowOffsetUniform);}}},{key:"minFontSize",get:function(){return this._minFontSize},set:function(e){this._minFontSize!==e&&(this._minFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText());}},{key:"maxFontSize",get:function(){return this._maxFontSize},set:function(e){this._maxFontSize!==e&&(this._maxFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText());}},{key:"autoFitWidth",get:function(){return this._autoFitWidth},set:function(e){this._autoFitWidth!==e&&(this._autoFitWidth=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText());}},{key:"autoFitHeight",get:function(){return this._autoFitHeight},set:function(e){this._autoFitHeight!==e&&(this._autoFitHeight=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText());}},{key:"maxLines",get:function(){return this._maxLines},set:function(e){this._maxLines!==e&&(null!==e||-1!==this._maxLines)&&(this._maxLines=null===e?-1:e,this.font&&this._wrapLines&&this._updateText());}},{key:"enableMarkup",get:function(){return this._enableMarkup},set:function(e){if(e=!!e,this._enableMarkup!==e){this._enableMarkup=e,this.font&&this._updateText();var t=this._element._isScreenSpace();this._updateMaterial(t);}}},{key:"symbols",get:function(){return this._symbols}},{key:"symbolColors",get:function(){return null===this._symbolColors?null:this._symbolColors.map(function(e){return this._colorPalette.slice(3*e,3*e+3)},this)}},{key:"symbolOutlineParams",get:function(){return null===this._symbolOutlineParams?null:this._symbolOutlineParams.map(function(e){return this._outlinePalette.slice(5*e,5*e+5)},this)}},{key:"symbolShadowParams",get:function(){return null===this._symbolShadowParams?null:this._symbolShadowParams.map(function(e){return this._shadowPalette.slice(6*e,6*e+6)},this)}},{key:"rtl",get:function(){return this._rtl}},{key:"rangeStart",get:function(){return this._rangeStart},set:function(e){(e=Math.max(0,Math.min(e,this._symbols.length)))!==this._rangeStart&&(this._rangeStart=e,this._updateRenderRange());}},{key:"rangeEnd",get:function(){return this._rangeEnd},set:function(e){(e=Math.max(this._rangeStart,Math.min(e,this._symbols.length)))!==this._rangeEnd&&(this._rangeEnd=e,this._updateRenderRange());}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function gf(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function gd(e,t){return (gd=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var gp=new eW,gm=new e$,g_=new eW,gv=new eW,gg=new e$,gy=new e$,gS=new e$,gx=new e$,gb=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n)||this)._evtLayersChanged=null,i._evtLayerAdded=null,i._evtLayerRemoved=null,i._beingInitialized=false,i._anchor=new eY,i._localAnchor=new eY,i._pivot=new eX,i._width=i._calculatedWidth=32,i._height=i._calculatedHeight=32,i._margin=new eY(0,0,-32,-32),i._modelTransform=new e$,i._screenToWorld=new e$,i._anchorTransform=new e$,i._anchorDirty=true,i._parentWorldTransform=new e$,i._screenTransform=new e$,i._screenCorners=[new eW,new eW,new eW,new eW],i._canvasCorners=[new eX,new eX,new eX,new eX],i._worldCorners=[new eW,new eW,new eW,new eW],i._cornersDirty=true,i._canvasCornersDirty=true,i._worldCornersDirty=true,i.entity.on("insert",i._onInsert,i),i._patch(),i.screen=null,i._type=vr,i._image=null,i._text=null,i._group=null,i._drawOrder=0,i._fitMode=vo,i._useInput=false,i._layers=[4],i._addedModels=[],i._batchGroupId=-1,i._offsetReadAt=0,i._maskOffset=.5,i._maskedBy=null,i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&gd(t,e);var n,i=t.prototype;return i._setValue=function(e,t){this._text?(this._text[e]!==t&&this._dirtyBatch(),this._text[e]=t):this._image&&(this._image[e]!==t&&this._dirtyBatch(),this._image[e]=t);},i._patch=function(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition;},i._unpatch=function(){this.entity._sync=my.prototype._sync,this.entity.setPosition=my.prototype.setPosition,this.entity.setLocalPosition=my.prototype.setLocalPosition;},i._setPosition=function(e,t,n){if(!this.element.screen)return void my.prototype.setPosition.call(this,e,t,n);gf(e,eW)?gp.copy(e):gp.set(e,t,n),this.getWorldTransform(),gm.copy(this.element._screenToWorld).invert(),gm.transformPoint(gp,this.localPosition),this._dirtyLocal||this._dirtifyLocal();},i._setLocalPosition=function(e,t,n){gf(e,eW)?this.localPosition.copy(e):this.localPosition.set(e,t,n);var i=this.element,r=this.localPosition,s=i._pivot;i._margin.x=r.x-i._calculatedWidth*s.x,i._margin.z=i._localAnchor.z-i._localAnchor.x-i._calculatedWidth-i._margin.x,i._margin.y=r.y-i._calculatedHeight*s.y,i._margin.w=i._localAnchor.w-i._localAnchor.y-i._calculatedHeight-i._margin.y,this._dirtyLocal||this._dirtifyLocal();},i._sync=function(){var e=this.element,t=e.screen;if(t){if(e._anchorDirty){var n=0,i=0,r=0,s=1;if(this._parent&&this._parent.element)n=this._parent.element.calculatedWidth,i=this._parent.element.calculatedHeight,r=this._parent.element.pivot.x,s=this._parent.element.pivot.y;else {var a=t.screen.resolution;n=a.x/t.screen.scale,i=a.y/t.screen.scale;}e._anchorTransform.setTranslate(n*(e.anchor.x-r),-(i*(s-e.anchor.y)),0),e._anchorDirty=false,e._calculateLocalAnchors();}e._sizeDirty&&e._calculateSize(false,false);}if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);var o=this.localPosition,l=e._pivot;e._margin.x=o.x-e._calculatedWidth*l.x,e._margin.z=e._localAnchor.z-e._localAnchor.x-e._calculatedWidth-e._margin.x,e._margin.y=o.y-e._calculatedHeight*l.y,e._margin.w=e._localAnchor.w-e._localAnchor.y-e._calculatedHeight-e._margin.y,this._dirtyLocal=false;}if(!t){this._dirtyWorld&&(e._cornersDirty=true,e._canvasCornersDirty=true,e._worldCornersDirty=true),my.prototype._sync.call(this);return}if(this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this._parent.element?e._screenToWorld.mul2(this._parent.element._modelTransform,e._anchorTransform):e._screenToWorld.copy(e._anchorTransform),e._modelTransform.mul2(e._screenToWorld,this.localTransform),t){e._screenToWorld.mul2(t.screen._screenMatrix,e._screenToWorld),t.screen.screenSpace||e._screenToWorld.mul2(t.worldTransform,e._screenToWorld),this.worldTransform.mul2(e._screenToWorld,this.localTransform);var u=e._parentWorldTransform;u.setIdentity();var c=this._parent;c&&c.element&&c!==t&&(gg.setTRS(eW.ZERO,c.getLocalRotation(),c.getLocalScale()),u.mul2(c.element._parentWorldTransform,gg)),g_.set(0,0,this.localPosition.z),gv.set(e._absLeft+e._pivot.x*e.calculatedWidth,e._absBottom+e._pivot.y*e.calculatedHeight,0),gg.setTranslate(-gv.x,-gv.y,-gv.z),gy.setTRS(g_,this.getLocalRotation(),this.getLocalScale()),gS.setTranslate(gv.x,gv.y,gv.z),e._screenTransform.mul2(e._parentWorldTransform,gS).mul(gy).mul(gg),e._cornersDirty=true,e._canvasCornersDirty=true,e._worldCornersDirty=true;}else this.worldTransform.copy(e._modelTransform);this._dirtyWorld=false;}},i._onInsert=function(e){var t=this._parseUpToScreen();this.entity._dirtifyWorld(),this._updateScreen(t.screen),this._dirtifyMask();},i._dirtifyMask=function(){for(var e=this.entity;e;){var t=e.parent;if((null===t||t.screen)&&e.element){this.system._prerender&&this.system._prerender.length||(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));var n=this.system._prerender.indexOf(this.entity);n>=0&&this.system._prerender.splice(n,1),0>this.system._prerender.indexOf(e)&&this.system._prerender.push(e);}e=t;}},i._onPrerender=function(){for(var e=0;e<this.system._prerender.length;e++){var t=this.system._prerender[e];t.element&&t.element.syncMask(1);}this.system._prerender.length=0;},i._bindScreen=function(e){e._bindElement(this);},i._unbindScreen=function(e){e._unbindElement(this);},i._updateScreen=function(e){this.screen&&this.screen!==e&&this._unbindScreen(this.screen.screen);var t=this.screen;this.screen=e,this.screen&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,t),this._anchorDirty=true;for(var n=this.entity.children,i=0,r=n.length;i<r;i++)n[i].element&&n[i].element._updateScreen(e);this.screen&&this.screen.screen.syncDrawOrder();},i.syncMask=function(e){var t=this._parseUpToScreen();this._updateMask(t.mask,e);},i._setMaskedBy=function(e){var t=this._image||this._text;if(e){var n=e.element._image._maskRef;null==t||t._setStencil(new n7({ref:n,func:2})),this._maskedBy=e;}else null==t||t._setStencil(null),this._maskedBy=null;},i._updateMask=function(e,t){if(e){if(this._setMaskedBy(e),this.mask){var n,i=new n7({ref:e.element._image._maskRef,func:2,zpass:3});this._image._setStencil(i),this._image._maskRef=t,t++,e=this.entity;}for(var r=this.entity.children,s=0,a=r.length;s<a;s++)null==(n=r[s].element)||n._updateMask(e,t);this.mask&&t--;}else {if(this._setMaskedBy(null),this.mask){var o,l=new n7({ref:t,func:7,zpass:2});this._image._setStencil(l),this._image._maskRef=t,t++,e=this.entity;}for(var u=this.entity.children,c=0,h=u.length;c<h;c++)null==(o=u[c].element)||o._updateMask(e,t);this.mask&&t--;}},i._parseUpToScreen=function(){for(var e={screen:null,mask:null},t=this.entity._parent;t&&!t.screen;)t.element&&t.element.mask&&!e.mask&&(e.mask=t),t=t.parent;return t&&t.screen&&(e.screen=t),e},i._onScreenResize=function(e){this._anchorDirty=true,this._cornersDirty=true,this._worldCornersDirty=true,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",e);},i._onScreenSpaceChange=function(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace);},i._onScreenRemove=function(){this.screen&&(this.screen._destroying?this.screen=null:this._updateScreen(null));},i._calculateLocalAnchors=function(){var e=1e3,t=1e3,n=this.entity._parent;if(n&&n.element)e=n.element.calculatedWidth,t=n.element.calculatedHeight;else if(this.screen){var i=this.screen.screen.resolution,r=this.screen.screen.scale;e=i.x/r,t=i.y/r;}this._localAnchor.set(this._anchor.x*e,this._anchor.y*t,this._anchor.z*e,this._anchor.w*t);},i.getOffsetPosition=function(e,t){var n=this.entity.getLocalPosition().clone();return n.x+=e,n.y+=t,this._screenToWorld.transformPoint(n,n),n},i.onLayersChanged=function(e,t){this.addModelToLayers(this._image?this._image._renderable.model:this._text._model),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);},i.onLayerAdded=function(e){!(0>this.layers.indexOf(e.id))&&(this._image?e.addMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.addMeshInstances(this._text._model.meshInstances));},i.onLayerRemoved=function(e){!(0>this.layers.indexOf(e.id))&&(this._image?e.removeMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.removeMeshInstances(this._text._model.meshInstances));},i.onEnable=function(){var e,t=this.system.app.scene,n=t.layers;this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this._evtLayersChanged=t.on("set:layers",this.onLayersChanged,this),n&&(this._evtLayerAdded=n.on("add",this.onLayerAdded,this),this._evtLayerRemoved=n.on("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&(null==(e=this.system.app.batcher)||e.insert(lo.ELEMENT,this.batchGroupId,this.entity)),this.fire("enableelement");},i.onDisable=function(){var e,t,n,i,r=this.system.app.scene.layers;null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,r&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(n=this._evtLayerRemoved)||n.off(),this._evtLayerRemoved=null),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this._batchGroupId>=0&&(null==(i=this.system.app.batcher)||i.remove(lo.ELEMENT,this.batchGroupId,this.entity)),this.fire("disableelement");},i.onRemove=function(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off();},i._calculateSize=function(e,t){if(this.entity._parent||this.screen){this._calculateLocalAnchors();var n=this._absRight-this._absLeft,i=this._absTop-this._absBottom;e?this._setWidth(n):this._setCalculatedWidth(n,false),t?this._setHeight(i):this._setCalculatedHeight(i,false);var r=this.entity.getLocalPosition();r.x=this._margin.x+this._calculatedWidth*this._pivot.x,r.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(r),this._sizeDirty=false;}},i._setWidth=function(e){this._width=e,this._setCalculatedWidth(e,false),this.fire("set:width",this._width);},i._setHeight=function(e){this._height=e,this._setCalculatedHeight(e,false),this.fire("set:height",this._height);},i._setCalculatedWidth=function(e,t){if(!(1e-4>=Math.abs(e-this._calculatedWidth))){if(this._calculatedWidth=e,this.entity._dirtifyLocal(),t){var n=this.entity.getLocalPosition(),i=this._pivot;this._margin.x=n.x-this._calculatedWidth*i.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x;}this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight);}},i._setCalculatedHeight=function(e,t){if(!(1e-4>=Math.abs(e-this._calculatedHeight))){if(this._calculatedHeight=e,this.entity._dirtifyLocal(),t){var n=this.entity.getLocalPosition(),i=this._pivot;this._margin.y=n.y-this._calculatedHeight*i.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y;}this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight);}},i._flagChildrenAsDirty=function(){for(var e=this.entity._children,t=0,n=e.length;t<n;t++)e[t].element&&(e[t].element._anchorDirty=true,e[t].element._sizeDirty=true);},i.addModelToLayers=function(e){this._addedModels.push(e);for(var t=0;t<this.layers.length;t++){var n=this.system.app.scene.layers.getLayerById(this.layers[t]);n&&n.addMeshInstances(e.meshInstances);}},i.removeModelFromLayers=function(e){var t=this._addedModels.indexOf(e);t>=0&&this._addedModels.splice(t,1);for(var n=0;n<this.layers.length;n++){var i=this.system.app.scene.layers.getLayerById(this.layers[n]);i&&i.removeMeshInstances(e.meshInstances);}},i.getMaskOffset=function(){var e=this.system.app.frame;this._offsetReadAt!==e&&(this._maskOffset=.5,this._offsetReadAt=e);var t=this._maskOffset;return this._maskOffset-=.001,t},i.isVisibleForCamera=function(e){if(this.maskedBy){var t,n,i,r,s=this.maskedBy.element.screenCorners;t=Math.min(Math.min(s[0].x,s[1].x),Math.min(s[2].x,s[3].x)),n=Math.max(Math.max(s[0].x,s[1].x),Math.max(s[2].x,s[3].x)),r=Math.min(Math.min(s[0].y,s[1].y),Math.min(s[2].y,s[3].y)),i=Math.max(Math.max(s[0].y,s[1].y),Math.max(s[2].y,s[3].y));}else {var a=this.system.app.graphicsDevice.width,o=this.system.app.graphicsDevice.height,l=e._rect.z*a,u=e._rect.w*o;n=(t=e._rect.x*a)+l,r=(i=(1-e._rect.y)*o)-u;}var c=this.screenCorners,h=Math.min(Math.min(c[0].x,c[1].x),Math.min(c[2].x,c[3].x)),f=Math.max(Math.max(c[0].x,c[1].x),Math.max(c[2].x,c[3].x)),d=Math.min(Math.min(c[0].y,c[1].y),Math.min(c[2].y,c[3].y)),p=Math.max(Math.max(c[0].y,c[1].y),Math.max(c[2].y,c[3].y));return !(f<t)&&!(h>n)&&!(d>i)&&!(p<r)},i._isScreenSpace=function(){return !!this.screen&&!!this.screen.screen&&this.screen.screen.screenSpace},i._isScreenCulled=function(){return !!this.screen&&!!this.screen.screen&&this.screen.screen.cull},i._dirtyBatch=function(){if(-1!==this.batchGroupId){var e;null==(e=this.system.app.batcher)||e.markGroupDirty(this.batchGroupId);}},n=[{key:"data",get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}},{key:"enabled",get:function(){return this.data.enabled},set:function(e){var t=this.data,n=t.enabled;t.enabled=e,this.fire("set","enabled",n,e);}},{key:"_absLeft",get:function(){return this._localAnchor.x+this._margin.x}},{key:"_absRight",get:function(){return this._localAnchor.z-this._margin.z}},{key:"_absTop",get:function(){return this._localAnchor.w-this._margin.w}},{key:"_absBottom",get:function(){return this._localAnchor.y+this._margin.y}},{key:"_hasSplitAnchorsX",get:function(){return Math.abs(this._anchor.x-this._anchor.z)>.001}},{key:"_hasSplitAnchorsY",get:function(){return Math.abs(this._anchor.y-this._anchor.w)>.001}},{key:"aabb",get:function(){return this._image?this._image.aabb:this._text?this._text.aabb:null}},{key:"anchor",get:function(){return this._anchor},set:function(e){if(gf(e,eY))this._anchor.copy(e);else {var t;(t=this._anchor).set.apply(t,[].concat(e));}this.entity._parent||this.screen?this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):this._calculateLocalAnchors(),this._anchorDirty=true,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor);}},{key:"batchGroupId",get:function(){return this._batchGroupId},set:function(e){var t,n;this._batchGroupId!==e&&(this.entity.enabled&&this._batchGroupId>=0&&(null==(t=this.system.app.batcher)||t.remove(lo.ELEMENT,this.batchGroupId,this.entity)),this.entity.enabled&&e>=0&&(null==(n=this.system.app.batcher)||n.insert(lo.ELEMENT,e,this.entity)),e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=e);}},{key:"bottom",get:function(){return this._margin.y},set:function(e){this._margin.y=e;var t=this.entity.getLocalPosition(),n=this._absTop,i=this._localAnchor.y+e;this._setHeight(n-i),t.y=e+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(t);}},{key:"calculatedWidth",get:function(){return this._calculatedWidth},set:function(e){this._setCalculatedWidth(e,true);}},{key:"calculatedHeight",get:function(){return this._calculatedHeight},set:function(e){this._setCalculatedHeight(e,true);}},{key:"canvasCorners",get:function(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;for(var e=this.system.app.graphicsDevice,t=this.screenCorners,n=e.canvas.clientWidth/e.width,i=e.canvas.clientHeight/e.height,r=0;r<4;r++)this._canvasCorners[r].set(t[r].x*n,(e.height-t[r].y)*i);return this._canvasCornersDirty=false,this._canvasCorners}},{key:"drawOrder",get:function(){return this._drawOrder},set:function(e){var t=0;this.screen&&(t=this.screen.screen.priority),e>0xffffff&&(e=0xffffff),this._drawOrder=(t<<24)+e,this.fire("set:draworder",this._drawOrder);}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this._hasSplitAnchorsY||this._setCalculatedHeight(e,true),this.fire("set:height",this._height);}},{key:"layers",get:function(){return this._layers},set:function(e){if(this._addedModels.length)for(var t=0;t<this._layers.length;t++){var n=this.system.app.scene.layers.getLayerById(this._layers[t]);if(n)for(var i=0;i<this._addedModels.length;i++)n.removeMeshInstances(this._addedModels[i].meshInstances);}if(this._layers=e,this.enabled&&this.entity.enabled&&this._addedModels.length)for(var r=0;r<this._layers.length;r++){var s=this.system.app.scene.layers.getLayerById(this._layers[r]);if(s)for(var a=0;a<this._addedModels.length;a++)s.addMeshInstances(this._addedModels[a].meshInstances);}}},{key:"left",get:function(){return this._margin.x},set:function(e){this._margin.x=e;var t=this.entity.getLocalPosition(),n=this._absRight,i=this._localAnchor.x+e;this._setWidth(n-i),t.x=e+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(t);}},{key:"margin",get:function(){return this._margin},set:function(e){this._margin.copy(e),this._calculateSize(true,true),this.fire("set:margin",this._margin);}},{key:"maskedBy",get:function(){return this._maskedBy}},{key:"pivot",get:function(){return this._pivot},set:function(e){var t=this.pivot,n=this.margin,i=t.x,r=t.y;gf(e,eX)?t.copy(e):t.set.apply(t,[].concat(e));var s=n.x+n.z,a=t.x-i;n.x+=s*a,n.z-=s*a;var o=n.y+n.w,l=t.y-r;n.y+=o*l,n.w-=o*l,this._anchorDirty=true,this._cornersDirty=true,this._worldCornersDirty=true,this._calculateSize(false,false),this._flagChildrenAsDirty(),this.fire("set:pivot",t);}},{key:"right",get:function(){return this._margin.z},set:function(e){this._margin.z=e;var t=this.entity.getLocalPosition(),n=this._absLeft,i=this._localAnchor.z-e;this._setWidth(i-n),t.x=this._localAnchor.z-this._localAnchor.x-e-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(t);}},{key:"screenCorners",get:function(){if(!this._cornersDirty||!this.screen)return this._screenCorners;var e=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);for(var t=this.screen.screen.screenSpace,n=0;n<4;n++)this._screenTransform.transformPoint(this._screenCorners[n],this._screenCorners[n]),t&&this._screenCorners[n].mulScalar(this.screen.screen.scale),e&&this._screenCorners[n].add(e);return this._cornersDirty=false,this._canvasCornersDirty=true,this._worldCornersDirty=true,this._screenCorners}},{key:"textWidth",get:function(){return this._text?this._text.width:0}},{key:"textHeight",get:function(){return this._text?this._text.height:0}},{key:"top",get:function(){return this._margin.w},set:function(e){this._margin.w=e;var t=this.entity.getLocalPosition(),n=this._absBottom,i=this._localAnchor.w-e;this._setHeight(i-n),t.y=this._localAnchor.w-this._localAnchor.y-e-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(t);}},{key:"type",get:function(){return this._type},set:function(e){e!==this._type&&(this._type=e,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),e===vs?this._image=new vJ(this):e===va&&(this._text=new gh(this)));}},{key:"useInput",get:function(){return this._useInput},set:function(e){this._useInput!==e&&(this._useInput=e,this.system.app.elementInput?e?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this):this._useInput,this.fire("set:useInput",e));}},{key:"fitMode",get:function(){return this._fitMode},set:function(e){this._fitMode=e,this._calculateSize(true,true),this._image&&this._image.refreshMesh();}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._hasSplitAnchorsX||this._setCalculatedWidth(e,true),this.fire("set:width",this._width);}},{key:"worldCorners",get:function(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){var e=this.screenCorners;if(!this.screen.screen.screenSpace){gg.copy(this.screen.screen._screenMatrix),gg.data[13]=-gg.data[13],gg.mul2(this.screen.getWorldTransform(),gg);for(var t=0;t<4;t++)gg.transformPoint(e[t],this._worldCorners[t]);}}else {var n=this.entity.getLocalPosition();gg.setTranslate(-n.x,-n.y,-n.z),gy.setTRS(eW.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),gS.setTranslate(n.x,n.y,n.z);var i=this.entity.parent?this.entity.parent:this.entity;gx.copy(i.getWorldTransform()),gx.mul(gS).mul(gy).mul(gg),g_.set(n.x-this.pivot.x*this.calculatedWidth,n.y-this.pivot.y*this.calculatedHeight,n.z),gx.transformPoint(g_,this._worldCorners[0]),g_.set(n.x+(1-this.pivot.x)*this.calculatedWidth,n.y-this.pivot.y*this.calculatedHeight,n.z),gx.transformPoint(g_,this._worldCorners[1]),g_.set(n.x+(1-this.pivot.x)*this.calculatedWidth,n.y+(1-this.pivot.y)*this.calculatedHeight,n.z),gx.transformPoint(g_,this._worldCorners[2]),g_.set(n.x-this.pivot.x*this.calculatedWidth,n.y+(1-this.pivot.y)*this.calculatedHeight,n.z),gx.transformPoint(g_,this._worldCorners[3]);}return this._worldCornersDirty=false,this._worldCorners}},{key:"fontSize",get:function(){return this._text?this._text.fontSize:null},set:function(e){this._setValue("fontSize",e);}},{key:"minFontSize",get:function(){return this._text?this._text.minFontSize:null},set:function(e){this._setValue("minFontSize",e);}},{key:"maxFontSize",get:function(){return this._text?this._text.maxFontSize:null},set:function(e){this._setValue("maxFontSize",e);}},{key:"maxLines",get:function(){return this._text?this._text.maxLines:null},set:function(e){this._setValue("maxLines",e);}},{key:"autoFitWidth",get:function(){return this._text?this._text.autoFitWidth:null},set:function(e){this._setValue("autoFitWidth",e);}},{key:"autoFitHeight",get:function(){return this._text?this._text.autoFitHeight:null},set:function(e){this._setValue("autoFitHeight",e);}},{key:"color",get:function(){return this._text?this._text.color:this._image?this._image.color:null},set:function(e){this._setValue("color",e);}},{key:"font",get:function(){return this._text?this._text.font:null},set:function(e){this._setValue("font",e);}},{key:"fontAsset",get:function(){return this._text&&"number"==typeof this._text.fontAsset?this._text.fontAsset:null},set:function(e){this._setValue("fontAsset",e);}},{key:"spacing",get:function(){return this._text?this._text.spacing:null},set:function(e){this._setValue("spacing",e);}},{key:"lineHeight",get:function(){return this._text?this._text.lineHeight:null},set:function(e){this._setValue("lineHeight",e);}},{key:"wrapLines",get:function(){return this._text?this._text.wrapLines:null},set:function(e){this._setValue("wrapLines",e);}},{key:"lines",get:function(){return this._text?this._text.lines:null},set:function(e){this._setValue("lines",e);}},{key:"alignment",get:function(){return this._text?this._text.alignment:null},set:function(e){this._setValue("alignment",e);}},{key:"autoWidth",get:function(){return this._text?this._text.autoWidth:null},set:function(e){this._setValue("autoWidth",e);}},{key:"autoHeight",get:function(){return this._text?this._text.autoHeight:null},set:function(e){this._setValue("autoHeight",e);}},{key:"rtlReorder",get:function(){return this._text?this._text.rtlReorder:null},set:function(e){this._setValue("rtlReorder",e);}},{key:"unicodeConverter",get:function(){return this._text?this._text.unicodeConverter:null},set:function(e){this._setValue("unicodeConverter",e);}},{key:"text",get:function(){return this._text?this._text.text:null},set:function(e){this._setValue("text",e);}},{key:"key",get:function(){return this._text?this._text.key:null},set:function(e){this._setValue("key",e);}},{key:"texture",get:function(){return this._image?this._image.texture:null},set:function(e){this._setValue("texture",e);}},{key:"textureAsset",get:function(){return this._image?this._image.textureAsset:null},set:function(e){this._setValue("textureAsset",e);}},{key:"material",get:function(){return this._image?this._image.material:null},set:function(e){this._setValue("material",e);}},{key:"materialAsset",get:function(){return this._image?this._image.materialAsset:null},set:function(e){this._setValue("materialAsset",e);}},{key:"sprite",get:function(){return this._image?this._image.sprite:null},set:function(e){this._setValue("sprite",e);}},{key:"spriteAsset",get:function(){return this._image?this._image.spriteAsset:null},set:function(e){this._setValue("spriteAsset",e);}},{key:"spriteFrame",get:function(){return this._image?this._image.spriteFrame:null},set:function(e){this._setValue("spriteFrame",e);}},{key:"pixelsPerUnit",get:function(){return this._image?this._image.pixelsPerUnit:null},set:function(e){this._setValue("pixelsPerUnit",e);}},{key:"opacity",get:function(){return this._text?this._text.opacity:this._image?this._image.opacity:null},set:function(e){this._setValue("opacity",e);}},{key:"rect",get:function(){return this._image?this._image.rect:null},set:function(e){this._setValue("rect",e);}},{key:"mask",get:function(){return this._image?this._image.mask:null},set:function(e){this._setValue("mask",e);}},{key:"outlineColor",get:function(){return this._text?this._text.outlineColor:null},set:function(e){this._setValue("outlineColor",e);}},{key:"outlineThickness",get:function(){return this._text?this._text.outlineThickness:null},set:function(e){this._setValue("outlineThickness",e);}},{key:"shadowColor",get:function(){return this._text?this._text.shadowColor:null},set:function(e){this._setValue("shadowColor",e);}},{key:"shadowOffset",get:function(){return this._text?this._text.shadowOffset:null},set:function(e){this._setValue("shadowOffset",e);}},{key:"enableMarkup",get:function(){return this._text?this._text.enableMarkup:null},set:function(e){this._setValue("enableMarkup",e);}},{key:"rangeStart",get:function(){return this._text?this._text.rangeStart:null},set:function(e){this._setValue("rangeStart",e);}},{key:"rangeEnd",get:function(){return this._text?this._text.rangeEnd:null},set:function(e){this._setValue("rangeEnd",e);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX);gb.EVENT_MOUSEDOWN="mousedown",gb.EVENT_MOUSEUP="mouseup",gb.EVENT_MOUSEENTER="mouseenter",gb.EVENT_MOUSELEAVE="mouseleave",gb.EVENT_MOUSEMOVE="mousemove",gb.EVENT_MOUSEWHEEL="mousewheel",gb.EVENT_CLICK="click",gb.EVENT_TOUCHSTART="touchstart",gb.EVENT_TOUCHEND="touchend",gb.EVENT_TOUCHMOVE="touchmove",gb.EVENT_TOUCHCANCEL="touchcancel";var gT=function(){this.enabled=true;};function gE(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function gw(e,t){return (gw=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var gA=["enabled"],gC=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){(n=e.call(this,t)||this).id="element",n.ComponentType=gb,n.DataType=gT,n.schema=gA,n._unicodeConverter=null,n._rtlReorder=null,n._defaultTexture=new nO(t.graphicsDevice,{width:1,height:1,format:20,name:"element-system"});var n,i=n._defaultTexture.lock(),r=new Uint8Array(4);return r[0]=255,r[1]=255,r[2]=255,r[3]=255,i.set(r),n._defaultTexture.unlock(),n.defaultImageMaterial=null,n.defaultImage9SlicedMaterial=null,n.defaultImage9TiledMaterial=null,n.defaultImageMaskMaterial=null,n.defaultImage9SlicedMaskMaterial=null,n.defaultImage9TiledMaskMaterial=null,n.defaultScreenSpaceImageMaterial=null,n.defaultScreenSpaceImage9SlicedMaterial=null,n.defaultScreenSpaceImage9TiledMaterial=null,n.defaultScreenSpaceImageMask9SlicedMaterial=null,n.defaultScreenSpaceImageMask9TiledMaterial=null,n.defaultScreenSpaceImageMaskMaterial=null,n._defaultTextMaterials={},n.defaultImageMaterials=[],n.on("add",n.onAddComponent,n),n.on("beforeremove",n.onRemoveComponent,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&gw(t,e);var n=t.prototype;return n.destroy=function(){e.prototype.destroy.call(this),this._defaultTexture.destroy();},n.initializeComponentData=function(t,n,i){t._beingInitialized=true,void 0!==n.anchor&&(gE(n.anchor,eY)?t.anchor.copy(n.anchor):t.anchor.set(n.anchor[0],n.anchor[1],n.anchor[2],n.anchor[3])),void 0!==n.pivot&&(gE(n.pivot,eX)?t.pivot.copy(n.pivot):t.pivot.set(n.pivot[0],n.pivot[1]));var r,s=Math.abs(t.anchor.x-t.anchor.z)>.001,a=Math.abs(t.anchor.y-t.anchor.w)>.001,o=false;void 0!==n.margin&&(gE(n.margin,eY)?t.margin.copy(n.margin):t._margin.set(n.margin[0],n.margin[1],n.margin[2],n.margin[3]),o=true),void 0!==n.left&&(t._margin.x=n.left,o=true),void 0!==n.bottom&&(t._margin.y=n.bottom,o=true),void 0!==n.right&&(t._margin.z=n.right,o=true),void 0!==n.top&&(t._margin.w=n.top,o=true),o&&(t.margin=t._margin);var l=false;void 0===n.width||s?s&&(l=true):t.width=n.width,void 0===n.height||a?a&&(l=true):t.height=n.height,l&&(t.anchor=t.anchor),void 0!==n.enabled&&(t.enabled=n.enabled),void 0!==n.useInput&&(t.useInput=n.useInput),void 0!==n.fitMode&&(t.fitMode=n.fitMode),t.batchGroupId=void 0===n.batchGroupId||null===n.batchGroupId?-1:n.batchGroupId,n.layers&&Array.isArray(n.layers)&&(t.layers=n.layers.slice(0)),void 0!==n.type&&(t.type=n.type),t.type===vs?(void 0!==n.rect&&(t.rect=n.rect),void 0!==n.color&&(gE(r=n.color,eN)||(r=new eN(n.color[0],n.color[1],n.color[2])),t.color=r),void 0!==n.opacity&&(t.opacity=n.opacity),void 0!==n.textureAsset&&(t.textureAsset=n.textureAsset),n.texture&&(t.texture=n.texture),void 0!==n.spriteAsset&&(t.spriteAsset=n.spriteAsset),n.sprite&&(t.sprite=n.sprite),void 0!==n.spriteFrame&&(t.spriteFrame=n.spriteFrame),void 0!==n.pixelsPerUnit&&null!==n.pixelsPerUnit&&(t.pixelsPerUnit=n.pixelsPerUnit),void 0!==n.materialAsset&&(t.materialAsset=n.materialAsset),n.material&&(t.material=n.material),void 0!==n.mask&&(t.mask=n.mask)):t.type===va&&(void 0!==n.autoWidth&&(t.autoWidth=n.autoWidth),void 0!==n.autoHeight&&(t.autoHeight=n.autoHeight),void 0!==n.rtlReorder&&(t.rtlReorder=n.rtlReorder),void 0!==n.unicodeConverter&&(t.unicodeConverter=n.unicodeConverter),null!==n.text&&void 0!==n.text?t.text=n.text:null!==n.key&&void 0!==n.key&&(t.key=n.key),void 0!==n.color&&(gE(r=n.color,eN)||(r=new eN(r[0],r[1],r[2])),t.color=r),void 0!==n.opacity&&(t.opacity=n.opacity),void 0!==n.spacing&&(t.spacing=n.spacing),void 0!==n.fontSize&&(t.fontSize=n.fontSize,n.lineHeight||(t.lineHeight=n.fontSize)),void 0!==n.lineHeight&&(t.lineHeight=n.lineHeight),void 0!==n.maxLines&&(t.maxLines=n.maxLines),void 0!==n.wrapLines&&(t.wrapLines=n.wrapLines),void 0!==n.minFontSize&&(t.minFontSize=n.minFontSize),void 0!==n.maxFontSize&&(t.maxFontSize=n.maxFontSize),n.autoFitWidth&&(t.autoFitWidth=n.autoFitWidth),n.autoFitHeight&&(t.autoFitHeight=n.autoFitHeight),void 0!==n.fontAsset&&(t.fontAsset=n.fontAsset),void 0!==n.font&&(t.font=n.font),void 0!==n.alignment&&(t.alignment=n.alignment),void 0!==n.outlineColor&&(t.outlineColor=n.outlineColor),void 0!==n.outlineThickness&&(t.outlineThickness=n.outlineThickness),void 0!==n.shadowColor&&(t.shadowColor=n.shadowColor),void 0!==n.shadowOffset&&(t.shadowOffset=n.shadowOffset),void 0!==n.enableMarkup&&(t.enableMarkup=n.enableMarkup));var u=t._parseUpToScreen();u.screen&&t._updateScreen(u.screen),e.prototype.initializeComponentData.call(this,t,n,i),t._beingInitialized=false,t.type===vs&&t._image._meshDirty&&t._image._updateMesh(t._image.mesh);},n.onAddComponent=function(e,t){e.fire("element:add");},n.onRemoveComponent=function(e,t){t.onRemove();},n.cloneComponent=function(e,t){var n=e.element,i={enabled:n.enabled,width:n.width,height:n.height,anchor:n.anchor.clone(),pivot:n.pivot.clone(),margin:n.margin.clone(),alignment:n.alignment&&n.alignment.clone()||n.alignment,autoWidth:n.autoWidth,autoHeight:n.autoHeight,type:n.type,rect:n.rect&&n.rect.clone()||n.rect,rtlReorder:n.rtlReorder,unicodeConverter:n.unicodeConverter,materialAsset:n.materialAsset,material:n.material,color:n.color&&n.color.clone()||n.color,opacity:n.opacity,textureAsset:n.textureAsset,texture:n.texture,spriteAsset:n.spriteAsset,sprite:n.sprite,spriteFrame:n.spriteFrame,pixelsPerUnit:n.pixelsPerUnit,spacing:n.spacing,lineHeight:n.lineHeight,wrapLines:n.wrapLines,layers:n.layers,fontSize:n.fontSize,minFontSize:n.minFontSize,maxFontSize:n.maxFontSize,autoFitWidth:n.autoFitWidth,autoFitHeight:n.autoFitHeight,maxLines:n.maxLines,fontAsset:n.fontAsset,font:n.font,useInput:n.useInput,fitMode:n.fitMode,batchGroupId:n.batchGroupId,mask:n.mask,outlineColor:n.outlineColor&&n.outlineColor.clone()||n.outlineColor,outlineThickness:n.outlineThickness,shadowColor:n.shadowColor&&n.shadowColor.clone()||n.shadowColor,shadowOffset:n.shadowOffset&&n.shadowOffset.clone()||n.shadowOffset,enableMarkup:n.enableMarkup};return void 0!==n.key&&null!==n.key?i.key=n.key:i.text=n.text,this.addComponent(t,i)},n.getTextElementMaterial=function(e,t,n){var i=(e&&1)|(t&&2)|(n&&4),r=this._defaultTextMaterials[i];if(r)return r;var s="TextMaterial";return r=new dw,t?(r.msdfMap=this._defaultTexture,r.msdfTextAttribute=n,r.emissive.set(1,1,1)):(s="Bitmap"+s,r.emissive.set(1,1,1),r.emissiveMap=this._defaultTexture,r.opacityMap=this._defaultTexture,r.opacityMapChannel="a"),e&&(s="ScreenSpace"+s,r.depthTest=false),r.name="default"+s,r.useLighting=false,r.useTonemap=false,r.useFog=false,r.useSkybox=false,r.diffuse.set(0,0,0),r.opacity=.5,r.blendType=4,r.depthWrite=false,r.emissiveVertexColor=true,r.update(),this._defaultTextMaterials[i]=r,r},n._createBaseImageMaterial=function(){var e=new dw;return e.diffuse.set(0,0,0),e.emissive.set(1,1,1),e.emissiveMap=this._defaultTexture,e.opacityMap=this._defaultTexture,e.opacityMapChannel="a",e.useLighting=false,e.useTonemap=false,e.useFog=false,e.useSkybox=false,e.blendType=4,e.depthWrite=false,e},n.getImageElementMaterial=function(e,t,n,i){if(e)if(t)if(n)return this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=false,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=false,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=false,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=false,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=false,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial;else if(i)return this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=false,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=false,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=false,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=false,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=false,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial;else return this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=false,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=false,this.defaultScreenSpaceImageMaskMaterial.greenWrite=false,this.defaultScreenSpaceImageMaskMaterial.blueWrite=false,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=false,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)),this.defaultScreenSpaceImageMaskMaterial;else if(n)return this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=false,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial;else if(i)return this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImage9TiledMaterial.depthTest=false,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial;else return this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=false,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)),this.defaultScreenSpaceImageMaterial;if(t)if(n)return this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=false,this.defaultImage9SlicedMaskMaterial.greenWrite=false,this.defaultImage9SlicedMaskMaterial.blueWrite=false,this.defaultImage9SlicedMaskMaterial.alphaWrite=false,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial;else if(i)return this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=2,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=false,this.defaultImage9TiledMaskMaterial.greenWrite=false,this.defaultImage9TiledMaskMaterial.blueWrite=false,this.defaultImage9TiledMaskMaterial.alphaWrite=false,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial;else return this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=false,this.defaultImageMaskMaterial.greenWrite=false,this.defaultImageMaskMaterial.blueWrite=false,this.defaultImageMaskMaterial.alphaWrite=false,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial)),this.defaultImageMaskMaterial;return n?(this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial):i?(this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=2,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial):(this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial)),this.defaultImageMaterial)},n.registerUnicodeConverter=function(e){this._unicodeConverter=e;},n.registerRtlReorder=function(e){this._rtlReorder=e;},n.getUnicodeConverter=function(){return this._unicodeConverter},n.getRtlReorder=function(){return this._rtlReorder},t}(mZ),gP="free",gI="limited",gL="locked";function gD(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function gM(e,t){return (gM=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var gR=["angularDampingX","angularDampingY","angularDampingZ","angularEquilibriumX","angularEquilibriumY","angularEquilibriumZ","angularLimitsX","angularLimitsY","angularLimitsZ","angularMotionX","angularMotionY","angularMotionZ","angularSpringX","angularSpringY","angularSpringZ","angularStiffnessX","angularStiffnessY","angularStiffnessZ","breakForce","enableCollision","enabled","entityA","entityB","linearDampingX","linearDampingY","linearDampingZ","linearEquilibriumX","linearEquilibriumY","linearEquilibriumZ","linearLimitsX","linearLimitsY","linearLimitsZ","linearMotionX","linearMotionY","linearMotionZ","linearSpringX","linearSpringY","linearSpringZ","linearStiffnessX","linearStiffnessY","linearStiffnessZ"],gO=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n)||this)._constraint=null,i._entityA=null,i._entityB=null,i._breakForce=34e37,i._enableCollision=true,i._linearMotionX=gL,i._linearLimitsX=new eX(0,0),i._linearSpringX=false,i._linearStiffnessX=0,i._linearDampingX=1,i._linearEquilibriumX=0,i._linearMotionY=gL,i._linearLimitsY=new eX(0,0),i._linearSpringY=false,i._linearStiffnessY=0,i._linearDampingY=1,i._linearEquilibriumY=0,i._linearMotionZ=gL,i._linearLimitsZ=new eX(0,0),i._linearSpringZ=false,i._linearStiffnessZ=0,i._linearDampingZ=1,i._linearEquilibriumZ=0,i._angularMotionX=gL,i._angularLimitsX=new eX(0,0),i._angularSpringX=false,i._angularStiffnessX=0,i._angularDampingX=1,i._angularEquilibriumX=0,i._angularMotionY=gL,i._angularLimitsY=new eX(0,0),i._angularSpringY=false,i._angularStiffnessY=0,i._angularDampingY=1,i._angularEquilibriumY=0,i._angularMotionZ=gL,i._angularLimitsZ=new eX(0,0),i._angularSpringZ=false,i._angularEquilibriumZ=0,i._angularDampingZ=1,i._angularStiffnessZ=0,i.on("set_enabled",i._onSetEnabled,i),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&gM(t,e);var n,r=t.prototype;return r._convertTransform=function(e,t){var n=e.getTranslation(),i=new e0;i.setFromMat4(e);var r=new Ammo.btVector3(n.x,n.y,n.z),s=new Ammo.btQuaternion(i.x,i.y,i.z,i.w);t.setOrigin(r),t.setRotation(s),Ammo.destroy(r),Ammo.destroy(s);},r._updateAngularLimits=function(){var e=this._constraint;if(e){this._angularMotionX===gI?(t=this._angularLimitsX.x*ek.DEG_TO_RAD,r=this._angularLimitsX.y*ek.DEG_TO_RAD):this._angularMotionX===gP?(t=1,r=0):t=r=0,this._angularMotionY===gI?(n=this._angularLimitsY.x*ek.DEG_TO_RAD,s=this._angularLimitsY.y*ek.DEG_TO_RAD):this._angularMotionY===gP?(n=1,s=0):n=s=0,this._angularMotionZ===gI?(i=this._angularLimitsZ.x*ek.DEG_TO_RAD,a=this._angularLimitsZ.y*ek.DEG_TO_RAD):this._angularMotionZ===gP?(i=1,a=0):i=a=0;var t,n,i,r,s,a,o=new Ammo.btVector3(t,n,i);e.setAngularLowerLimit(o),o.setValue(r,s,a),e.setAngularUpperLimit(o),Ammo.destroy(o);}},r._updateLinearLimits=function(){var e=this._constraint;if(e){this._linearMotionX===gI?(t=this._linearLimitsX.x,r=this._linearLimitsX.y):this._linearMotionX===gP?(t=1,r=0):t=r=0,this._linearMotionY===gI?(n=this._linearLimitsY.x,s=this._linearLimitsY.y):this._linearMotionY===gP?(n=1,s=0):n=s=0,this._linearMotionZ===gI?(i=this._linearLimitsZ.x,a=this._linearLimitsZ.y):this._linearMotionZ===gP?(i=1,a=0):i=a=0;var t,n,i,r,s,a,o=new Ammo.btVector3(t,n,i);e.setLinearLowerLimit(o),o.setValue(r,s,a),e.setLinearUpperLimit(o),Ammo.destroy(o);}},r._createConstraint=function(){if(this._entityA&&this._entityA.rigidbody){this._destroyConstraint();var e=new e$,t=this._entityA.rigidbody.body;t.activate();var n=this.entity.getWorldTransform(),i=this._entityA.getWorldTransform().clone().invert();e.mul2(i,n);var r=new Ammo.btTransform;if(this._convertTransform(e,r),this._entityB&&this._entityB.rigidbody){var s=this._entityB.rigidbody.body;s.activate();var a=this._entityB.getWorldTransform().clone().invert();e.mul2(a,n);var o=new Ammo.btTransform;this._convertTransform(e,o),this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,s,r,o,!this._enableCollision),Ammo.destroy(o);}else this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,r,!this._enableCollision);Ammo.destroy(r);for(var l=["X","Y","Z","X","Y","Z"],u=0;u<6;u++){var c=u<3?"_linear":"_angular";this._constraint.enableSpring(u,this[c+"Spring"+l[u]]),this._constraint.setDamping(u,this[c+"Damping"+l[u]]),this._constraint.setEquilibriumPoint(u,this[c+"Equilibrium"+l[u]]),this._constraint.setStiffness(u,this[c+"Stiffness"+l[u]]);}this._constraint.setBreakingImpulseThreshold(this._breakForce),this._updateLinearLimits(),this._updateAngularLimits(),this.system.app.systems.rigidbody.dynamicsWorld.addConstraint(this._constraint,!this._enableCollision);}},r._destroyConstraint=function(){this._constraint&&(this.system.app.systems.rigidbody.dynamicsWorld.removeConstraint(this._constraint),Ammo.destroy(this._constraint),this._constraint=null);},r.initFromData=function(e){for(var t,n=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return gD(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return gD(e,void 0)}}(e))){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(gR);!(t=n()).done;){var r,s=t.value;e.hasOwnProperty(s)&&((r=e[s],null!=eX&&"undefined"!=typeof Symbol&&eX[Symbol.hasInstance]?!!eX[Symbol.hasInstance](r):i(r,eX))?this["_"+s].copy(e[s]):this["_"+s]=e[s]);}this._createConstraint();},r.onEnable=function(){this._createConstraint();},r.onDisable=function(){this._destroyConstraint();},r._onSetEnabled=function(e,t,n){},r._onBeforeRemove=function(){this.fire("remove");},n=[{key:"entityA",get:function(){return this._entityA},set:function(e){this._destroyConstraint(),this._entityA=e,this._createConstraint();}},{key:"entityB",get:function(){return this._entityB},set:function(e){this._destroyConstraint(),this._entityB=e,this._createConstraint();}},{key:"breakForce",get:function(){return this._breakForce},set:function(e){this._constraint&&this._breakForce!==e&&(this._constraint.setBreakingImpulseThreshold(e),this._breakForce=e);}},{key:"enableCollision",get:function(){return this._enableCollision},set:function(e){this._destroyConstraint(),this._enableCollision=e,this._createConstraint();}},{key:"angularLimitsX",get:function(){return this._angularLimitsX},set:function(e){this._angularLimitsX.equals(e)||(this._angularLimitsX.copy(e),this._updateAngularLimits());}},{key:"angularMotionX",get:function(){return this._angularMotionX},set:function(e){this._angularMotionX!==e&&(this._angularMotionX=e,this._updateAngularLimits());}},{key:"angularLimitsY",get:function(){return this._angularLimitsY},set:function(e){this._angularLimitsY.equals(e)||(this._angularLimitsY.copy(e),this._updateAngularLimits());}},{key:"angularMotionY",get:function(){return this._angularMotionY},set:function(e){this._angularMotionY!==e&&(this._angularMotionY=e,this._updateAngularLimits());}},{key:"angularLimitsZ",get:function(){return this._angularLimitsZ},set:function(e){this._angularLimitsZ.equals(e)||(this._angularLimitsZ.copy(e),this._updateAngularLimits());}},{key:"angularMotionZ",get:function(){return this._angularMotionZ},set:function(e){this._angularMotionZ!==e&&(this._angularMotionZ=e,this._updateAngularLimits());}},{key:"linearLimitsX",get:function(){return this._linearLimitsX},set:function(e){this._linearLimitsX.equals(e)||(this._linearLimitsX.copy(e),this._updateLinearLimits());}},{key:"linearMotionX",get:function(){return this._linearMotionX},set:function(e){this._linearMotionX!==e&&(this._linearMotionX=e,this._updateLinearLimits());}},{key:"linearLimitsY",get:function(){return this._linearLimitsY},set:function(e){this._linearLimitsY.equals(e)||(this._linearLimitsY.copy(e),this._updateLinearLimits());}},{key:"linearMotionY",get:function(){return this._linearMotionY},set:function(e){this._linearMotionY!==e&&(this._linearMotionY=e,this._updateLinearLimits());}},{key:"linearLimitsZ",get:function(){return this._linearLimitsZ},set:function(e){this._linearLimitsZ.equals(e)||(this._linearLimitsZ.copy(e),this._updateLinearLimits());}},{key:"linearMotionZ",get:function(){return this._linearMotionZ},set:function(e){this._linearMotionZ!==e&&(this._linearMotionZ=e,this._updateLinearLimits());}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX),gk={Damping:"setDamping",Equilibrium:"setEquilibriumPoint",Spring:"enableSpring",Stiffness:"setStiffness"};["linear","angular"].forEach(function(e){["Damping","Equilibrium","Spring","Stiffness"].forEach(function(t){["X","Y","Z"].forEach(function(n){var i=e+t+n,r="_"+i,s=3*("linear"!==e);"Y"===n&&(s+=1),"Z"===n&&(s+=2),Object.defineProperty(gO.prototype,i,{get:function(){return this[r]},set:function(e){this[r]!==e&&(this[r]=e,this._constraint[gk[t]](s,e));}});});});});var gN=function(){this.enabled=true;};function gF(e,t){return (gF=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var gB=["enabled"],gU=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).id="joint",n.app=t,n.ComponentType=gO,n.DataType=gN,n.schema=gB,n}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&gF(t,e),t.prototype.initializeComponentData=function(t,n,i){t.initFromData(n),e.prototype.initializeComponentData.call(this,t,n,gB);},t}(mZ);function gz(e,t){return (gz=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}mX._buildAccessors(gO.prototype,gB);var gV=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var t;return t=e.apply(this,arguments)||this,t._minWidth=0,t._minHeight=0,t._maxWidth=null,t._maxHeight=null,t._fitWidthProportion=0,t._fitHeightProportion=0,t._excludeFromLayout=false,t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:true,configurable:true}}),e&&gz(n,e),t=[{key:"minWidth",get:function(){return this._minWidth},set:function(e){e!==this._minWidth&&(this._minWidth=e,this.fire("resize"));}},{key:"minHeight",get:function(){return this._minHeight},set:function(e){e!==this._minHeight&&(this._minHeight=e,this.fire("resize"));}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){e!==this._maxWidth&&(this._maxWidth=e,this.fire("resize"));}},{key:"maxHeight",get:function(){return this._maxHeight},set:function(e){e!==this._maxHeight&&(this._maxHeight=e,this.fire("resize"));}},{key:"fitWidthProportion",get:function(){return this._fitWidthProportion},set:function(e){e!==this._fitWidthProportion&&(this._fitWidthProportion=e,this.fire("resize"));}},{key:"fitHeightProportion",get:function(){return this._fitHeightProportion},set:function(e){e!==this._fitHeightProportion&&(this._fitHeightProportion=e,this.fire("resize"));}},{key:"excludeFromLayout",get:function(){return this._excludeFromLayout},set:function(e){e!==this._excludeFromLayout&&(this._excludeFromLayout=e,this.fire("resize"));}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(n.prototype,t),n}(mX),gG=function(){this.enabled=true;};function gH(e,t){return (gH=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var gW=["enabled"],gj=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).id="layoutchild",n.ComponentType=gV,n.DataType=gG,n.schema=gW,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&gH(t,e);var n=t.prototype;return n.initializeComponentData=function(t,n,i){ void 0!==n.enabled&&(t.enabled=n.enabled),void 0!==n.minWidth&&(t.minWidth=n.minWidth),void 0!==n.minHeight&&(t.minHeight=n.minHeight),void 0!==n.maxWidth&&(t.maxWidth=n.maxWidth),void 0!==n.maxHeight&&(t.maxHeight=n.maxHeight),void 0!==n.fitWidthProportion&&(t.fitWidthProportion=n.fitWidthProportion),void 0!==n.fitHeightProportion&&(t.fitHeightProportion=n.fitHeightProportion),void 0!==n.excludeFromLayout&&(t.excludeFromLayout=n.excludeFromLayout),e.prototype.initializeComponentData.call(this,t,n,i);},n.cloneComponent=function(e,t){var n=e.layoutchild;return this.addComponent(t,{enabled:n.enabled,minWidth:n.minWidth,minHeight:n.minHeight,maxWidth:n.maxWidth,maxHeight:n.maxHeight,fitWidthProportion:n.fitWidthProportion,fitHeightProportion:n.fitHeightProportion,excludeFromLayout:n.excludeFromLayout})},t}(mZ);mX._buildAccessors(gV.prototype,gW);var gX={};gX[0]={axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},gX[1]={axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"};var gY={};gY[0]=1,gY[1]=0;var gq={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},gK={NONE:"NONE",APPLY_STRETCHING:"APPLY_STRETCHING",APPLY_SHRINKING:"APPLY_SHRINKING"},gZ=new eX;function gQ(e){var t,n=gX[e],i=gX[gY[e]];function r(e,t){return -t[i.size]*e.pivot[i.axis]}function s(e){var t=e.entity.layoutchild;return !t||!t.enabled||!t.excludeFromLayout}function a(e,t,n){switch(e){case 0:return gK.NONE;case 1:if(t<n)return gK.APPLY_STRETCHING;return gK.NONE;case 2:if(t>=n)return gK.APPLY_SHRINKING;return gK.NONE;case 3:if(t<n)return gK.APPLY_STRETCHING;return gK.APPLY_SHRINKING;default:throw Error("Unrecognized fitting mode: "+e)}}function o(e,n){return p(e,n.size)+(e.length-1)*t.spacing[n.axis]}function l(e,t,n){for(var i=_(e,n.maxSize),r=m(e,n.fittingProportion),s=y(r,i),a=gZ[n.axis]-t,o=0;o<e.length;++o){var l=i[o],u=c(l,a,r,s),h=e[l][n.size]+u,f=Math.min(h,e[l][n.maxSize]);e[l][n.size]=f,a-=u-Math.max(h-f,0);}}function u(e,t,n){for(var i=_(e,n.minSize,true),r=function(e){if(1===e.length)return [1];for(var t=[],n=e.length,i=0;i<n;++i)t.push((1-e[i])/(n-1));return t}(m(e,n.fittingProportion)),s=y(r,i),a=t-gZ[n.axis],o=0;o<e.length;++o){var l=i[o],u=c(l,a,r,s),h=e[l][n.size]-u,f=Math.max(h,e[l][n.minSize]);e[l][n.size]=f,a-=u-Math.max(f-h,0);}}function c(e,t,n,i){var r=n[e],s=i[e];return 1e-5>Math.abs(r)&&1e-5>Math.abs(s)?t:t*r/s}function h(e){for(var t=[],n=0;n<e.length;++n){var i=e[n],r=Math.max(f(i,"minWidth"),0),s=Math.max(f(i,"minHeight"),0),a=Math.max(f(i,"maxWidth"),r),o=Math.max(f(i,"maxHeight"),s),l=d(f(i,"width"),r,a),u=d(f(i,"height"),s,o),c=f(i,"fitWidthProportion"),h=f(i,"fitHeightProportion");t.push({minWidth:r,minHeight:s,maxWidth:a,maxHeight:o,width:l,height:u,fitWidthProportion:c,fitHeightProportion:h});}return t}function f(e,t){var n=e.entity.layoutchild;return n&&n.enabled&&void 0!==n[t]&&null!==n[t]?n[t]:void 0!==e[t]?e[t]:gq[t]}function d(e,t,n){return Math.min(Math.max(e,t),n)}function p(e,t){return e.reduce(function(e,n){return e+n[t]},0)}function m(e,t){var n=p(e,t),i=[],r=e.length;if(0===n)for(var s=0;s<r;++s)i.push(1/r);else for(var a=0;a<r;++a)i.push(e[a][t]/n);return i}function _(e,t,n){return e.forEach(v),e.slice().sort(function(e,i){return n?i[t]-e[t]:e[t]-i[t]}).map(g)}function v(e,t){e.index=t;}function g(e){return e.index}function y(e,t){var n=[];n[t[e.length-1]]=e[t[e.length-1]];for(var i=e.length-2;i>=0;--i)n[t[i]]=n[t[i+1]]+e[t[i]];return n}return function(e,c){e=e.filter(s),gZ.x=(t=c).containerSize.x-t.padding.x-t.padding.z,gZ.y=t.containerSize.y-t.padding.y-t.padding.w,function(e){for(var t=0;t<e.length;++t){var n=e[t],i=n.anchor;(0!==i.x||0!==i.y||0!==i.z||0!==i.w)&&(n.anchor=eY.ZERO);}}(e);var f,d,p,m=function(e){var n=0===t.orientation&&t.reverseX||1===t.orientation&&t.reverseY,i=0===t.orientation&&t.reverseY||1===t.orientation&&t.reverseX;if(n)for(var r=0;r<e.length;++r)n&&e[r].reverse();return i&&e.reverse(),e}(function(e){if(!t.wrap)return [e];for(var i=[[]],r=h(e),s=0,a=2===t[n.fitting],o=0;o<e.length;++o){i[i.length-1].length>0&&(s+=t.spacing[n.axis]);var l=r[o][n.size];s+=l,!a&&s>gZ[n.axis]&&0!==i[i.length-1].length&&(s=l,i.push([])),i[i.length-1].push(e[o]),a&&s>gZ[n.axis]&&o!==e.length-1&&(s=0,i.push([]));}return i}(e)),_=function(e,n){for(var r=[],s=[],c=0;c<e.length;++c){var h=e[c];h.largestElement=null,h.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(var f=0;f<h.length;++f){var d=n[c][f];d[i.size]>h.largestSize[i.size]&&(h.largestElement=h[f],h.largestSize=d);}r.push(h.largestElement),s.push(h.largestSize);}var p=o(s,i),m=a(t[i.fitting],p,gZ[i.axis]);m===gK.APPLY_STRETCHING?l(s,p,i):m===gK.APPLY_SHRINKING&&u(s,p,i);for(var _=0;_<e.length;++_)for(var v=e[_],g=0;g<v.length;++g){var y=n[_][g],S=y[i.size],x=1===e.length?gZ[i.axis]:v.largestSize[i.size],b=a(t[i.fitting],S,x);b===gK.APPLY_STRETCHING?y[i.size]=Math.min(x,y[i.maxSize]):b===gK.APPLY_SHRINKING&&(y[i.size]=Math.max(x,y[i.minSize]));}return n}(m,function(e){for(var i=[],r=0;r<e.length;++r){var s=h(e[r]),c=o(s,n),f=a(t[n.fitting],c,gZ[n.axis]);f===gK.APPLY_STRETCHING?l(s,c,n):f===gK.APPLY_SHRINKING&&u(s,c,n),i.push(s);}return i}(m)),v=function(e,s){var a={};a[n.axis]=0,a[i.axis]=0,e[n.size]=Number.NEGATIVE_INFINITY;for(var o=[],l=0;l<e.length;++l){var u=e[l];if(0===u.length){o.push([]);continue}for(var c=[],h=s[l],f=0;f<u.length;++f){var d=u[f],p=h[f];a[i.axis]-=r(d,p),a[n.axis]-=-p[n.size]*d.pivot[n.axis],c[f]={},c[f][n.axis]=a[n.axis],c[f][i.axis]=a[i.axis],a[i.axis]+=r(d,p),a[n.axis]+=p[n.size]*(1-d.pivot[n.axis])+t.spacing[n.axis];}u[n.size]=a[n.axis]-t.spacing[n.axis],u[i.size]=u.largestSize[i.size],e[n.size]=Math.max(e[n.size],u[n.size]),a[n.axis]=0,a[i.axis]+=u[i.size]+t.spacing[i.axis],o.push(c);}return e[i.size]=a[i.axis]-t.spacing[i.axis],o}(m,_);return function(e,r,s){for(var a=t.alignment[n.axis],o=t.alignment[i.axis],l=t.padding[n.axis],u=t.padding[i.axis],c=0;c<e.length;++c)for(var h=e[c],f=r[c],d=s[c],p=(gZ[n.axis]-h[n.size])*a+l,m=(gZ[i.axis]-e[i.size])*o+u,_=0;_<h.length;++_){var v=(h[i.size]-f[_][i.size])*t.alignment[i.axis];d[_][n.axis]+=p,d[_][i.axis]+=m+v;}}(m,_,v),function(e,r,s){for(var a=0;a<e.length;++a)for(var o=e[a],l=r[a],u=s[a],c=0;c<o.length;++c){var h=o[c];h[n.calculatedSize]=l[c][n.size],h[i.calculatedSize]=l[c][i.size],0===t.orientation?h.entity.setLocalPosition(u[c][n.axis],u[c][i.axis],h.entity.getLocalPosition().z):h.entity.setLocalPosition(u[c][i.axis],u[c][n.axis],h.entity.getLocalPosition().z);}}(m,_,v),d=(f=m).width,p=f.height,{bounds:new eY((gZ.x-d)*t.alignment.x+t.padding.x,(gZ.y-p)*t.alignment.y+t.padding.y,d,p)}}}var gJ={};gJ[0]=gQ(0),gJ[1]=gQ(1);var g$=function(){function e(){}return e.prototype.calculateLayout=function(e,t){var n=gJ[t.orientation];if(n)return n(e,t);throw Error("Unrecognized orientation value: "+t.orientation)},e}();function g0(e,t){return (g0=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function g1(e){return e.element}function g2(e){return e.enabled&&e.element&&e.element.enabled}var g3=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n)||this)._orientation=0,i._reverseX=false,i._reverseY=true,i._alignment=new eX(0,1),i._padding=new eY,i._spacing=new eX,i._widthFitting=0,i._heightFitting=0,i._wrap=false,i._layoutCalculator=new g$,i._listenForReflowEvents(i.entity,"on"),i.entity.children.forEach(function(e){i._listenForReflowEvents(e,"on");}),i.entity.on("childinsert",i._onChildInsert,i),i.entity.on("childremove",i._onChildRemove,i),t.app.systems.element.on("add",i._onElementOrLayoutComponentAdd,i),t.app.systems.element.on("beforeremove",i._onElementOrLayoutComponentRemove,i),t.app.systems.layoutchild.on("add",i._onElementOrLayoutComponentAdd,i),t.app.systems.layoutchild.on("beforeremove",i._onElementOrLayoutComponentRemove,i),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&g0(t,e);var n,i=t.prototype;return i._isSelfOrChild=function(e){return e===this.entity||-1!==this.entity.children.indexOf(e)},i._listenForReflowEvents=function(e,t){e.element&&(e.element[t]("enableelement",this._scheduleReflow,this),e.element[t]("disableelement",this._scheduleReflow,this),e.element[t]("resize",this._scheduleReflow,this),e.element[t]("set:pivot",this._scheduleReflow,this)),e.layoutchild&&(e.layoutchild[t]("set_enabled",this._scheduleReflow,this),e.layoutchild[t]("resize",this._scheduleReflow,this));},i._onElementOrLayoutComponentAdd=function(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"on"),this._scheduleReflow());},i._onElementOrLayoutComponentRemove=function(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"off"),this._scheduleReflow());},i._onChildInsert=function(e){this._listenForReflowEvents(e,"on"),this._scheduleReflow();},i._onChildRemove=function(e){this._listenForReflowEvents(e,"off"),this._scheduleReflow();},i._scheduleReflow=function(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this);},i.reflow=function(){var e=g1(this.entity),t=this.entity.children.filter(g2).map(g1);if(e&&0!==t.length){var n=Math.max(e.calculatedWidth,0),i=Math.max(e.calculatedHeight,0),r={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new eX(n,i)};this._isPerformingReflow=true;var s=this._layoutCalculator.calculateLayout(t,r);this._isPerformingReflow=false,this.fire("reflow",s);}},i.onEnable=function(){this._scheduleReflow();},i.onRemove=function(){var e=this;this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach(function(t){e._listenForReflowEvents(t,"off");}),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this);},n=[{key:"orientation",get:function(){return this._orientation},set:function(e){e!==this._orientation&&(this._orientation=e,this._scheduleReflow());}},{key:"reverseX",get:function(){return this._reverseX},set:function(e){e!==this._reverseX&&(this._reverseX=e,this._scheduleReflow());}},{key:"reverseY",get:function(){return this._reverseY},set:function(e){e!==this._reverseY&&(this._reverseY=e,this._scheduleReflow());}},{key:"alignment",get:function(){return this._alignment},set:function(e){e.equals(this._alignment)||(this._alignment.copy(e),this._scheduleReflow());}},{key:"padding",get:function(){return this._padding},set:function(e){e.equals(this._padding)||(this._padding.copy(e),this._scheduleReflow());}},{key:"spacing",get:function(){return this._spacing},set:function(e){e.equals(this._spacing)||(this._spacing.copy(e),this._scheduleReflow());}},{key:"widthFitting",get:function(){return this._widthFitting},set:function(e){e!==this._widthFitting&&(this._widthFitting=e,this._scheduleReflow());}},{key:"heightFitting",get:function(){return this._heightFitting},set:function(e){e!==this._heightFitting&&(this._heightFitting=e,this._scheduleReflow());}},{key:"wrap",get:function(){return this._wrap},set:function(e){e!==this._wrap&&(this._wrap=e,this._scheduleReflow());}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX),g4=function(){this.enabled=true;};function g5(e,t){return (g5=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var g8=["enabled"],g6=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).id="layoutgroup",n.ComponentType=g3,n.DataType=g4,n.schema=g8,n._reflowQueue=[],n.on("beforeremove",n._onRemoveComponent,n),n.app.systems.on("postUpdate",n._onPostUpdate,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&g5(t,e);var n=t.prototype;return n.initializeComponentData=function(t,n,i){ void 0!==n.enabled&&(t.enabled=n.enabled),void 0!==n.orientation&&(t.orientation=n.orientation),void 0!==n.reverseX&&(t.reverseX=n.reverseX),void 0!==n.reverseY&&(t.reverseY=n.reverseY),void 0!==n.alignment&&(t.alignment=Array.isArray(n.alignment)?new eX(n.alignment):n.alignment),void 0!==n.padding&&(t.padding=Array.isArray(n.padding)?new eY(n.padding):n.padding),void 0!==n.spacing&&(t.spacing=Array.isArray(n.spacing)?new eX(n.spacing):n.spacing),void 0!==n.widthFitting&&(t.widthFitting=n.widthFitting),void 0!==n.heightFitting&&(t.heightFitting=n.heightFitting),void 0!==n.wrap&&(t.wrap=n.wrap),e.prototype.initializeComponentData.call(this,t,n,i);},n.cloneComponent=function(e,t){var n=e.layoutgroup;return this.addComponent(t,{enabled:n.enabled,orientation:n.orientation,reverseX:n.reverseX,reverseY:n.reverseY,alignment:n.alignment,padding:n.padding,spacing:n.spacing,widthFitting:n.widthFitting,heightFitting:n.heightFitting,wrap:n.wrap})},n.scheduleReflow=function(e){ -1===this._reflowQueue.indexOf(e)&&this._reflowQueue.push(e);},n._onPostUpdate=function(){this._processReflowQueue();},n._processReflowQueue=function(){if(0!==this._reflowQueue.length)for(var e=0;this._reflowQueue.length>0;){var t=this._reflowQueue.slice();this._reflowQueue.length=0,t.sort(function(e,t){return e.entity.graphDepth-t.entity.graphDepth});for(var n=0;n<t.length;++n)t[n].reflow();if(++e>=100)break}},n._onRemoveComponent=function(e,t){t.onRemove();},n.destroy=function(){e.prototype.destroy.call(this),this.app.systems.off("postUpdate",this._onPostUpdate,this);},t}(mZ);mX._buildAccessors(g3.prototype,g8);var g9=function(){function e(){this.map=new Map;}return e.prototype.destroy=function(e){this.map.forEach(function(e){return e.mesh.destroy()});},e}(),g7=new nD,ye=function(e,t){var n,i,r=g7.get(e,function(){return new g9}),s=r.map.get(t);if(!s){switch(t){case "box":n=l_.fromGeometry(e,new ft),i={x:2,y:2,z:2,uv:2/3};break;case "capsule":n=l_.fromGeometry(e,new dU({radius:.5,height:2})),i={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case "cone":n=l_.fromGeometry(e,new dV({baseRadius:.5,peakRadius:0,height:1})),i={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case "cylinder":n=l_.fromGeometry(e,new dH({radius:.5,height:1})),i={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case "plane":n=l_.fromGeometry(e,new dj({halfExtents:new eX(.5,.5),widthSegments:1,lengthSegments:1})),i={x:0,y:1,z:0,uv:1};break;case "sphere":n=l_.fromGeometry(e,new fi({radius:.5})),i={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case "torus":n=l_.fromGeometry(e,new dY({tubeRadius:.2,ringRadius:.3})),i={x:.5*Math.PI*.5-.1*Math.PI*.1,y:.4,z:.4,uv:1};break;default:throw Error("Invalid primitive type: "+t)}n.incRefCount(),s={mesh:n,area:i},r.map.set(t,s);}return s};function yt(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function yn(e,t){return (yn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var yi=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n)||this)._type="asset",i._asset=null,i._model=null,i._mapping={},i._castShadows=true,i._receiveShadows=true,i._materialAsset=null,i._castShadowsLightmap=true,i._lightmapped=false,i._lightmapSizeMultiplier=1,i.isStatic=false,i._layers=[0],i._batchGroupId=-1,i._customAabb=null,i._area=null,i._materialEvents=null,i._clonedModel=false,i._evtLayersChanged=null,i._evtLayerAdded=null,i._evtLayerRemoved=null,i._material=t.defaultMaterial,n.on("remove",i.onRemoveChild,i),n.on("removehierarchy",i.onRemoveChild,i),n.on("insert",i.onInsertChild,i),n.on("inserthierarchy",i.onInsertChild,i),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&yn(t,e);var n,i=t.prototype;return i.addModelToLayers=function(){for(var e=this.system.app.scene.layers,t=0;t<this._layers.length;t++){var n=e.getLayerById(this._layers[t]);n&&n.addMeshInstances(this.meshInstances);}},i.removeModelFromLayers=function(){for(var e=this.system.app.scene.layers,t=0;t<this._layers.length;t++){var n=e.getLayerById(this._layers[t]);n&&n.removeMeshInstances(this.meshInstances);}},i.onRemoveChild=function(){this._model&&this.removeModelFromLayers();},i.onInsertChild=function(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers();},i.onRemove=function(){this.asset=null,this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this);},i.onLayersChanged=function(e,t){this.addModelToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);},i.onLayerAdded=function(e){0>this.layers.indexOf(e.id)||e.addMeshInstances(this.meshInstances);},i.onLayerRemoved=function(e){0>this.layers.indexOf(e.id)||e.removeMeshInstances(this.meshInstances);},i._setMaterialEvent=function(e,t,n,i){var r=t+":"+n;this.system.app.assets.on(r,i,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[e]||(this._materialEvents[e]={}),this._materialEvents[e][r]={id:n,handler:i};},i._unsetMaterialEvents=function(){var e=this.system.app.assets,t=this._materialEvents;if(t){for(var n=0,i=t.length;n<i;n++)if(t[n]){var r=t[n];for(var s in r)e.off(s,r[s].handler,this);}this._materialEvents=null;}},i._getAssetByIdOrPath=function(e){var t=null;if(isNaN(parseInt(e,10))){if(this.asset){var n=this._getMaterialAssetUrl(e);n&&(t=this.system.app.assets.getByUrl(n));}}else t=this.system.app.assets.get(e);return t},i._getMaterialAssetUrl=function(e){if(!this.asset)return null;var t=this.system.app.assets.get(this.asset);return t?t.getAbsoluteUrl(e):null},i._loadAndSetMeshInstanceMaterial=function(e,t,n){var i=this.system.app.assets;e&&(e.resource?(t.material=e.resource,this._setMaterialEvent(n,"remove",e.id,function(){t.material=this.system.defaultMaterial;})):(this._setMaterialEvent(n,"load",e.id,function(i){t.material=i.resource,this._setMaterialEvent(n,"remove",e.id,function(){t.material=this.system.defaultMaterial;});}),this.enabled&&this.entity.enabled&&i.load(e)));},i.onEnable=function(){var e,t,n=this.system.app,i=n.scene,r=null==i?void 0:i.layers;this._evtLayersChanged=i.on("set:layers",this.onLayersChanged,this),r&&(this._evtLayerAdded=r.on("add",this.onLayerAdded,this),this._evtLayerRemoved=r.on("remove",this.onLayerRemoved,this));var s="asset"===this._type;if(this._model?this.addModelToLayers():s&&this._asset&&(e=n.assets.get(this._asset))&&e.resource!==this._model&&this._bindModelAsset(e),this._materialAsset&&(e=n.assets.get(this._materialAsset))&&e.resource!==this._material&&this._bindMaterialAsset(e),s&&this._mapping)for(var a in this._mapping)this._mapping[a]&&(e=this._getAssetByIdOrPath(this._mapping[a]))&&!e.resource&&n.assets.load(e);this._batchGroupId>=0&&(null==(t=n.batcher)||t.insert(lo.MODEL,this.batchGroupId,this.entity));},i.onDisable=function(){var e,t,n,i,r=this.system.app,s=r.scene.layers;null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,s&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(n=this._evtLayerRemoved)||n.off(),this._evtLayerRemoved=null),this._batchGroupId>=0&&(null==(i=r.batcher)||i.remove(lo.MODEL,this.batchGroupId,this.entity)),this._model&&this.removeModelFromLayers();},i.hide=function(){if(this._model)for(var e=this._model.meshInstances,t=0,n=e.length;t<n;t++)e[t].visible=false;},i.show=function(){if(this._model)for(var e=this._model.meshInstances,t=0,n=e.length;t<n;t++)e[t].visible=true;},i._bindMaterialAsset=function(e){if(e.on("load",this._onMaterialAssetLoad,this),e.on("unload",this._onMaterialAssetUnload,this),e.on("remove",this._onMaterialAssetRemove,this),e.on("change",this._onMaterialAssetChange,this),e.resource)this._onMaterialAssetLoad(e);else {if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e);}},i._unbindMaterialAsset=function(e){e.off("load",this._onMaterialAssetLoad,this),e.off("unload",this._onMaterialAssetUnload,this),e.off("remove",this._onMaterialAssetRemove,this),e.off("change",this._onMaterialAssetChange,this);},i._onMaterialAssetAdd=function(e){this.system.app.assets.off("add:"+e.id,this._onMaterialAssetAdd,this),this._materialAsset===e.id&&this._bindMaterialAsset(e);},i._onMaterialAssetLoad=function(e){this._setMaterial(e.resource);},i._onMaterialAssetUnload=function(e){this._setMaterial(this.system.defaultMaterial);},i._onMaterialAssetRemove=function(e){this._onMaterialAssetUnload(e);},i._onMaterialAssetChange=function(e){},i._bindModelAsset=function(e){if(this._unbindModelAsset(e),e.on("load",this._onModelAssetLoad,this),e.on("unload",this._onModelAssetUnload,this),e.on("change",this._onModelAssetChange,this),e.on("remove",this._onModelAssetRemove,this),e.resource)this._onModelAssetLoad(e);else {if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e);}},i._unbindModelAsset=function(e){e.off("load",this._onModelAssetLoad,this),e.off("unload",this._onModelAssetUnload,this),e.off("change",this._onModelAssetChange,this),e.off("remove",this._onModelAssetRemove,this);},i._onModelAssetAdded=function(e){this.system.app.assets.off("add:"+e.id,this._onModelAssetAdded,this),e.id===this._asset&&this._bindModelAsset(e);},i._onModelAssetLoad=function(e){this.model=e.resource.clone(),this._clonedModel=true;},i._onModelAssetUnload=function(e){this.model=null;},i._onModelAssetChange=function(e,t,n,i){"data"===t&&(this.mapping=this._mapping);},i._onModelAssetRemove=function(e){this.model=null;},i._setMaterial=function(e){if(this._material!==e){this._material=e;var t=this._model;if(t&&"asset"!==this._type)for(var n=t.meshInstances,i=0,r=n.length;i<r;i++)n[i].material=e;}},n=[{key:"meshInstances",get:function(){return this._model?this._model.meshInstances:null},set:function(e){this._model&&(this._model.meshInstances=e);}},{key:"customAabb",get:function(){return this._customAabb},set:function(e){if(this._customAabb=e,this._model){var t=this._model.meshInstances;if(t)for(var n=0;n<t.length;n++)t[n].setCustomAabb(this._customAabb);}}},{key:"type",get:function(){return this._type},set:function(e){if(this._type!==e)if(this._area=null,this._type=e,"asset"===e)null!==this._asset?this._bindModelAsset(this._asset):this.model=null;else {var t=ye(this.system.app.graphicsDevice,e);this._area=t.area;var n=t.mesh,i=new us,r=new he;r.graph=i,r.meshInstances=[new lL(n,this._material,i)],this.model=r,this._asset=null;}}},{key:"asset",get:function(){return this._asset},set:function(e){var t=this.system.app.assets,n=e;if(yt(e,pZ)&&(n=e.id),this._asset!==n){if(this._asset){t.off("add:"+this._asset,this._onModelAssetAdded,this);var i=t.get(this._asset);i&&this._unbindModelAsset(i);}if(this._asset=n,this._asset){var r=t.get(this._asset);r?this._bindModelAsset(r):(this.model=null,t.on("add:"+this._asset,this._onModelAssetAdded,this));}else this.model=null;}}},{key:"model",get:function(){return this._model},set:function(e){if(this._model!==e&&(!e||!e._immutable)&&(this._model&&(this._model._immutable=false,this.removeModelFromLayers(),this._model.getGraph().destroy(),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=false)),this._model=e,this._model)){this._model._immutable=true;for(var t=this._model.meshInstances,n=0;n<t.length;n++)t[n].castShadow=this._castShadows,t[n].receiveShadow=this._receiveShadows,t[n].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&this.entity.anim.rebind(),"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents();}}},{key:"lightmapped",get:function(){return this._lightmapped},set:function(e){if(e!==this._lightmapped&&(this._lightmapped=e,this._model))for(var t=this._model.meshInstances,n=0;n<t.length;n++)t[n].setLightmapped(e);}},{key:"castShadows",get:function(){return this._castShadows},set:function(e){if(this._castShadows!==e){var t=this._model;if(t){var n=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(var r=0;r<n.length;r++){var s=this.system.app.scene.layers.getLayerById(this.layers[r]);s&&s.removeShadowCasters(t.meshInstances);}for(var a=t.meshInstances,o=0;o<a.length;o++)a[o].castShadow=e;if(!this._castShadows&&e)for(var l=0;l<n.length;l++){var u=i.layers.getLayerById(n[l]);u&&u.addShadowCasters(t.meshInstances);}}this._castShadows=e;}}},{key:"receiveShadows",get:function(){return this._receiveShadows},set:function(e){if(this._receiveShadows!==e&&(this._receiveShadows=e,this._model))for(var t=this._model.meshInstances,n=0,i=t.length;n<i;n++)t[n].receiveShadow=e;}},{key:"castShadowsLightmap",get:function(){return this._castShadowsLightmap},set:function(e){this._castShadowsLightmap=e;}},{key:"lightmapSizeMultiplier",get:function(){return this._lightmapSizeMultiplier},set:function(e){this._lightmapSizeMultiplier=e;}},{key:"layers",get:function(){return this._layers},set:function(e){var t=this.system.app.scene.layers;if(this.meshInstances)for(var n=0;n<this._layers.length;n++){var i=t.getLayerById(this._layers[n]);i&&i.removeMeshInstances(this.meshInstances);}this._layers.length=0;for(var r=0;r<e.length;r++)this._layers[r]=e[r];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(var s=0;s<this._layers.length;s++){var a=t.getLayerById(this._layers[s]);a&&a.addMeshInstances(this.meshInstances);}}},{key:"batchGroupId",get:function(){return this._batchGroupId},set:function(e){var t,n;this._batchGroupId!==e&&(this.entity.enabled&&this._batchGroupId>=0&&(null==(t=this.system.app.batcher)||t.remove(lo.MODEL,this.batchGroupId,this.entity)),this.entity.enabled&&e>=0&&(null==(n=this.system.app.batcher)||n.insert(lo.MODEL,e,this.entity)),e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=e);}},{key:"materialAsset",get:function(){return this._materialAsset},set:function(e){var t=e;yt(e,pZ)&&(t=e.id);var n=this.system.app.assets;if(t!==this._materialAsset){if(this._materialAsset){n.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);var i=n.get(this._materialAsset);i&&this._unbindMaterialAsset(i);}if(this._materialAsset=t,this._materialAsset){var r=n.get(this._materialAsset);r?this._bindMaterialAsset(r):(this._setMaterial(this.system.defaultMaterial),n.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this));}else this._setMaterial(this.system.defaultMaterial);}}},{key:"material",get:function(){return this._material},set:function(e){this._material!==e&&(this.materialAsset=null,this._setMaterial(e));}},{key:"mapping",get:function(){return this._mapping},set:function(e){if("asset"===this._type&&(this._unsetMaterialEvents(),e||(e={}),this._mapping=e,this._model)){for(var t=this._model.meshInstances,n=this.asset?this.system.app.assets.get(this.asset):null,i=n?n.data.mapping:null,r=null,s=0,a=t.length;s<a;s++)if(void 0!==e[s])e[s]?(r=this.system.app.assets.get(e[s]),this._loadAndSetMeshInstanceMaterial(r,t[s],s)):t[s].material=this.system.defaultMaterial;else if(i)if(i[s]&&(i[s].material||i[s].path)){if(void 0!==i[s].material)r=this.system.app.assets.get(i[s].material);else if(void 0!==i[s].path){var o=this._getMaterialAssetUrl(i[s].path);o&&(r=this.system.app.assets.getByUrl(o));}this._loadAndSetMeshInstanceMaterial(r,t[s],s);}else t[s].material=this.system.defaultMaterial;}}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX),yr=function(){this.enabled=true;};function ys(e,t){return (ys=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ya=["enabled"],yo=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).id="model",n.ComponentType=yi,n.DataType=yr,n.schema=ya,n.defaultMaterial=lg(t.graphicsDevice),n.on("beforeremove",n.onRemove,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&ys(t,e);var n=t.prototype;return n.initializeComponentData=function(t,n,i){i=["material","materialAsset","asset","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","type","mapping","layers","isStatic","batchGroupId"],(null===n.batchGroupId||void 0===n.batchGroupId)&&(n.batchGroupId=-1),n.layers&&n.layers.length&&(n.layers=n.layers.slice(0));for(var r=0;r<i.length;r++)n.hasOwnProperty(i[r])&&(t[i[r]]=n[i[r]]);n.aabbCenter&&n.aabbHalfExtents&&(t.customAabb=new e8(new eW(n.aabbCenter),new eW(n.aabbHalfExtents))),e.prototype.initializeComponentData.call(this,t,n,["enabled"]);},n.cloneComponent=function(e,t){var n,r={type:e.model.type,asset:e.model.asset,castShadows:e.model.castShadows,receiveShadows:e.model.receiveShadows,castShadowsLightmap:e.model.castShadowsLightmap,lightmapped:e.model.lightmapped,lightmapSizeMultiplier:e.model.lightmapSizeMultiplier,isStatic:e.model.isStatic,enabled:e.model.enabled,layers:e.model.layers,batchGroupId:e.model.batchGroupId,mapping:ee({},e.model.mapping)},s=e.model.materialAsset;n=s,(null!=pZ&&"undefined"!=typeof Symbol&&pZ[Symbol.hasInstance]?pZ[Symbol.hasInstance](n):i(n,pZ))||null==s||(s=this.app.assets.get(s));var a=e.model.material;a&&a!==this.defaultMaterial&&s&&a!==s.resource||(r.materialAsset=s);var o=this.addComponent(t,r);if(e.model.model&&"asset"===e.model.type&&!e.model.asset&&(o.model=e.model.model.clone(),o._clonedModel=true),r.materialAsset||(o.material=a),e.model.model)for(var l=e.model.model.meshInstances,u=o.model.meshInstances,c=0;c<l.length;c++)u[c].mask=l[c].mask,u[c].material=l[c].material,u[c].layer=l[c].layer,u[c].receiveShadow=l[c].receiveShadow;return e.model.customAabb&&(o.customAabb=e.model.customAabb.clone()),o},n.onRemove=function(e,t){t.onRemove();},t}(mZ);function yl(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function yu(e,t){return (yu=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}mX._buildAccessors(yi.prototype,ya);var yc=["emitterExtents","emitterRadius","emitterExtentsInner","emitterRadiusInner","loop","initialVelocity","animSpeed","normalMap","particleNormal"],yh=["numParticles","lifetime","rate","rate2","startAngle","startAngle2","lighting","halfLambert","intensity","wrap","wrapBounds","depthWrite","noFog","sort","stretch","alignToMotion","preWarm","emitterShape","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animLoop","colorMap","localSpace","screenSpace","orientation"],yf=["scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","velocityGraph","velocityGraph2","localVelocityGraph","localVelocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2"],yd=["colorMapAsset","normalMapAsset","meshAsset","renderAsset"],yp=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n)||this)._requestedDepth=false,i._drawOrder=0,i._evtLayersChanged=null,i._evtLayerAdded=null,i._evtLayerRemoved=null,i._evtSetMeshes=null,i.on("set_colorMapAsset",i.onSetColorMapAsset,i),i.on("set_normalMapAsset",i.onSetNormalMapAsset,i),i.on("set_meshAsset",i.onSetMeshAsset,i),i.on("set_mesh",i.onSetMesh,i),i.on("set_renderAsset",i.onSetRenderAsset,i),i.on("set_loop",i.onSetLoop,i),i.on("set_blendType",i.onSetBlendType,i),i.on("set_depthSoftening",i.onSetDepthSoftening,i),i.on("set_layers",i.onSetLayers,i),yc.forEach(function(e){i.on("set_"+e,i.onSetSimpleProperty,i);}),yh.forEach(function(e){i.on("set_"+e,i.onSetComplexProperty,i);}),yf.forEach(function(e){i.on("set_"+e,i.onSetGraphProperty,i);}),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&yu(t,e);var n,i=t.prototype;return i._setValue=function(e,t){var n=this.data,i=n[e];n[e]=t,this.fire("set",e,i,t);},i.addMeshInstanceToLayers=function(){if(this.emitter)for(var e=0;e<this.layers.length;e++){var t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addMeshInstances([this.emitter.meshInstance]),this.emitter._layer=t);}},i.removeMeshInstanceFromLayers=function(){if(this.emitter)for(var e=0;e<this.layers.length;e++){var t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeMeshInstances([this.emitter.meshInstance]);}},i.onSetLayers=function(e,t,n){if(this.emitter){for(var i=0;i<t.length;i++){var r=this.system.app.scene.layers.getLayerById(t[i]);r&&r.removeMeshInstances([this.emitter.meshInstance]);}if(this.enabled&&this.entity.enabled)for(var s=0;s<n.length;s++){var a=this.system.app.scene.layers.getLayerById(n[s]);a&&a.addMeshInstances([this.emitter.meshInstance]);}}},i.onLayersChanged=function(e,t){this.addMeshInstanceToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);},i.onLayerAdded=function(e){this.emitter&&(0>this.layers.indexOf(e.id)||e.addMeshInstances([this.emitter.meshInstance]));},i.onLayerRemoved=function(e){this.emitter&&(0>this.layers.indexOf(e.id)||e.removeMeshInstances([this.emitter.meshInstance]));},i._bindColorMapAsset=function(e){if(e.on("load",this._onColorMapAssetLoad,this),e.on("unload",this._onColorMapAssetUnload,this),e.on("remove",this._onColorMapAssetRemove,this),e.on("change",this._onColorMapAssetChange,this),e.resource)this._onColorMapAssetLoad(e);else {if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e);}},i._unbindColorMapAsset=function(e){e.off("load",this._onColorMapAssetLoad,this),e.off("unload",this._onColorMapAssetUnload,this),e.off("remove",this._onColorMapAssetRemove,this),e.off("change",this._onColorMapAssetChange,this);},i._onColorMapAssetLoad=function(e){this.colorMap=e.resource;},i._onColorMapAssetUnload=function(e){this.colorMap=null;},i._onColorMapAssetRemove=function(e){this._onColorMapAssetUnload(e);},i._onColorMapAssetChange=function(e){},i.onSetColorMapAsset=function(e,t,n){var i=this,r=this.system.app.assets;if(t){var s=r.get(t);s&&this._unbindColorMapAsset(s);}if(n){yl(n,pZ)&&(this.data.colorMapAsset=n.id,n=n.id);var a=r.get(n);a?this._bindColorMapAsset(a):r.once("add:"+n,function(e){i._bindColorMapAsset(e);});}else this.colorMap=null;},i._bindNormalMapAsset=function(e){if(e.on("load",this._onNormalMapAssetLoad,this),e.on("unload",this._onNormalMapAssetUnload,this),e.on("remove",this._onNormalMapAssetRemove,this),e.on("change",this._onNormalMapAssetChange,this),e.resource)this._onNormalMapAssetLoad(e);else {if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e);}},i._unbindNormalMapAsset=function(e){e.off("load",this._onNormalMapAssetLoad,this),e.off("unload",this._onNormalMapAssetUnload,this),e.off("remove",this._onNormalMapAssetRemove,this),e.off("change",this._onNormalMapAssetChange,this);},i._onNormalMapAssetLoad=function(e){this.normalMap=e.resource;},i._onNormalMapAssetUnload=function(e){this.normalMap=null;},i._onNormalMapAssetRemove=function(e){this._onNormalMapAssetUnload(e);},i._onNormalMapAssetChange=function(e){},i.onSetNormalMapAsset=function(e,t,n){var i=this,r=this.system.app.assets;if(t){var s=r.get(t);s&&this._unbindNormalMapAsset(s);}if(n){yl(n,pZ)&&(this.data.normalMapAsset=n.id,n=n.id);var a=r.get(n);a?this._bindNormalMapAsset(a):r.once("add:"+n,function(e){i._bindNormalMapAsset(e);});}else this.normalMap=null;},i._bindMeshAsset=function(e){if(e.on("load",this._onMeshAssetLoad,this),e.on("unload",this._onMeshAssetUnload,this),e.on("remove",this._onMeshAssetRemove,this),e.on("change",this._onMeshAssetChange,this),e.resource)this._onMeshAssetLoad(e);else {if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e);}},i._unbindMeshAsset=function(e){e.off("load",this._onMeshAssetLoad,this),e.off("unload",this._onMeshAssetUnload,this),e.off("remove",this._onMeshAssetRemove,this),e.off("change",this._onMeshAssetChange,this);},i._onMeshAssetLoad=function(e){this._onMeshChanged(e.resource);},i._onMeshAssetUnload=function(e){this.mesh=null;},i._onMeshAssetRemove=function(e){this._onMeshAssetUnload(e);},i._onMeshAssetChange=function(e){},i.onSetMeshAsset=function(e,t,n){var i=this.system.app.assets;if(t){var r=i.get(t);r&&this._unbindMeshAsset(r);}if(n){yl(n,pZ)&&(this.data.meshAsset=n.id,n=n.id);var s=i.get(n);s&&this._bindMeshAsset(s);}else this._onMeshChanged(null);},i.onSetMesh=function(e,t,n){!n||yl(n,pZ)||"number"==typeof n?this.meshAsset=n:this._onMeshChanged(n);},i._onMeshChanged=function(e){e&&!yl(e,l_)&&(e=e.meshInstances[0]?e.meshInstances[0].mesh:null),this.data.mesh=e,this.emitter&&(this.emitter.mesh=e,this.emitter.resetMaterial(),this.rebuild());},i.onSetRenderAsset=function(e,t,n){var i=this.system.app.assets;if(t){var r=i.get(t);r&&this._unbindRenderAsset(r);}if(n){yl(n,pZ)&&(this.data.renderAsset=n.id,n=n.id);var s=i.get(n);s&&this._bindRenderAsset(s);}else this._onRenderChanged(null);},i._bindRenderAsset=function(e){if(e.on("load",this._onRenderAssetLoad,this),e.on("unload",this._onRenderAssetUnload,this),e.on("remove",this._onRenderAssetRemove,this),e.resource)this._onRenderAssetLoad(e);else {if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e);}},i._unbindRenderAsset=function(e){var t;e.off("load",this._onRenderAssetLoad,this),e.off("unload",this._onRenderAssetUnload,this),e.off("remove",this._onRenderAssetRemove,this),null==(t=this._evtSetMeshes)||t.off(),this._evtSetMeshes=null;},i._onRenderAssetLoad=function(e){this._onRenderChanged(e.resource);},i._onRenderAssetUnload=function(e){this._onRenderChanged(null);},i._onRenderAssetRemove=function(e){this._onRenderAssetUnload(e);},i._onRenderChanged=function(e){var t;if(!e)return void this._onMeshChanged(null);null==(t=this._evtSetMeshes)||t.off(),this._evtSetMeshes=e.on("set:meshes",this._onRenderSetMeshes,this),e.meshes&&this._onRenderSetMeshes(e.meshes);},i._onRenderSetMeshes=function(e){this._onMeshChanged(e&&e[0]);},i.onSetLoop=function(e,t,n){this.emitter&&(this.emitter[e]=n,this.emitter.resetTime());},i.onSetBlendType=function(e,t,n){this.emitter&&(this.emitter[e]=n,this.emitter.material.blendType=n,this.emitter.resetMaterial(),this.rebuild());},i._requestDepth=function(){!this._requestedDepth&&(L||(L=this.system.app.scene.layers.getLayerById(1)),L&&(L.incrementCounter(),this._requestedDepth=true));},i._releaseDepth=function(){this._requestedDepth&&L&&(L.decrementCounter(),this._requestedDepth=false);},i.onSetDepthSoftening=function(e,t,n){t!==n&&(n?this.enabled&&this.entity.enabled&&this._requestDepth():this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[e]=n),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()));},i.onSetSimpleProperty=function(e,t,n){this.emitter&&(this.emitter[e]=n,this.emitter.resetMaterial());},i.onSetComplexProperty=function(e,t,n){this.emitter&&(this.emitter[e]=n,this.emitter.resetMaterial(),this.rebuild(),this.reset());},i.onSetGraphProperty=function(e,t,n){this.emitter&&(this.emitter[e]=n,this.emitter.rebuildGraphs(),this.emitter.resetMaterial());},i.onEnable=function(){for(var e=this.system.app.scene,t=e.layers,n=this.data,i=0,r=yd.length;i<r;i++){var s=n[yd[i]];if(s){if(!yl(s,pZ)){if(!(parseInt(s,10)>=0))continue;s=this.system.app.assets.get(s);}s&&!s.resource&&this.system.app.assets.load(s);}}if(!this.system.app.graphicsDevice.disableParticleSystem){if(!this.emitter){var a=n.mesh;yl(a,l_)||(a=null),this.emitter=new hJ(this.system.app.graphicsDevice,{numParticles:n.numParticles,emitterExtents:n.emitterExtents,emitterExtentsInner:n.emitterExtentsInner,emitterRadius:n.emitterRadius,emitterRadiusInner:n.emitterRadiusInner,emitterShape:n.emitterShape,initialVelocity:n.initialVelocity,wrap:n.wrap,localSpace:n.localSpace,screenSpace:n.screenSpace,wrapBounds:n.wrapBounds,lifetime:n.lifetime,rate:n.rate,rate2:n.rate2,orientation:n.orientation,particleNormal:n.particleNormal,animTilesX:n.animTilesX,animTilesY:n.animTilesY,animStartFrame:n.animStartFrame,animNumFrames:n.animNumFrames,animNumAnimations:n.animNumAnimations,animIndex:n.animIndex,randomizeAnimIndex:n.randomizeAnimIndex,animSpeed:n.animSpeed,animLoop:n.animLoop,startAngle:n.startAngle,startAngle2:n.startAngle2,scaleGraph:n.scaleGraph,scaleGraph2:n.scaleGraph2,colorGraph:n.colorGraph,colorGraph2:n.colorGraph2,alphaGraph:n.alphaGraph,alphaGraph2:n.alphaGraph2,localVelocityGraph:n.localVelocityGraph,localVelocityGraph2:n.localVelocityGraph2,velocityGraph:n.velocityGraph,velocityGraph2:n.velocityGraph2,rotationSpeedGraph:n.rotationSpeedGraph,rotationSpeedGraph2:n.rotationSpeedGraph2,radialSpeedGraph:n.radialSpeedGraph,radialSpeedGraph2:n.radialSpeedGraph2,colorMap:n.colorMap,normalMap:n.normalMap,loop:n.loop,preWarm:n.preWarm,sort:n.sort,stretch:n.stretch,alignToMotion:n.alignToMotion,lighting:n.lighting,halfLambert:n.halfLambert,intensity:n.intensity,depthSoftening:n.depthSoftening,scene:this.system.app.scene,mesh:a,depthWrite:n.depthWrite,noFog:n.noFog,node:this.entity,blendType:n.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,n.autoPlay||(this.pause(),this.emitter.meshInstance.visible=false);}this.emitter.colorMap&&this.addMeshInstanceToLayers(),this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&n.depthSoftening&&this._requestDepth();}},i.onDisable=function(){var e,t,n,i=this.system.app.scene.layers;null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,i&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(n=this._evtLayerRemoved)||n.off(),this._evtLayerRemoved=null),this.emitter&&(this.removeMeshInstanceFromLayers(),this.data.depthSoftening&&this._releaseDepth(),this.emitter.camera=null);},i.onBeforeRemove=function(){this.enabled&&(this.enabled=false),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(var e=0;e<yd.length;e++){var t=yd[e];this.data[t]&&(this[t]=null);}this.off();},i.reset=function(){this.emitter&&this.emitter.reset();},i.stop=function(){this.emitter&&(this.emitter.loop=false,this.emitter.resetTime(),this.emitter.addTime(0,true));},i.pause=function(){this.data.paused=true;},i.unpause=function(){this.data.paused=false;},i.play=function(){this.data.paused=false,this.emitter&&(this.emitter.meshInstance.visible=true,this.emitter.loop=this.data.loop,this.emitter.resetTime());},i.isPlaying=function(){return !this.data.paused&&(!!this.emitter&&!!this.emitter.loop||Date.now()<=this.emitter.endTime)},i.setInTools=function(){var e=this.emitter;e&&!e.inTools&&(e.inTools=true,this.rebuild());},i.rebuild=function(){var e=this.enabled;this.enabled=false,this.emitter&&this.emitter.rebuild(),this.enabled=e;},n=[{key:"data",get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}},{key:"enabled",get:function(){return this.data.enabled},set:function(e){this._setValue("enabled",e);}},{key:"autoPlay",get:function(){return this.data.autoPlay},set:function(e){this._setValue("autoPlay",e);}},{key:"numParticles",get:function(){return this.data.numParticles},set:function(e){this._setValue("numParticles",e);}},{key:"lifetime",get:function(){return this.data.lifetime},set:function(e){this._setValue("lifetime",e);}},{key:"rate",get:function(){return this.data.rate},set:function(e){this._setValue("rate",e);}},{key:"rate2",get:function(){return this.data.rate2},set:function(e){this._setValue("rate2",e);}},{key:"startAngle",get:function(){return this.data.startAngle},set:function(e){this._setValue("startAngle",e);}},{key:"startAngle2",get:function(){return this.data.startAngle2},set:function(e){this._setValue("startAngle2",e);}},{key:"loop",get:function(){return this.data.loop},set:function(e){this._setValue("loop",e);}},{key:"preWarm",get:function(){return this.data.preWarm},set:function(e){this._setValue("preWarm",e);}},{key:"lighting",get:function(){return this.data.lighting},set:function(e){this._setValue("lighting",e);}},{key:"halfLambert",get:function(){return this.data.halfLambert},set:function(e){this._setValue("halfLambert",e);}},{key:"intensity",get:function(){return this.data.intensity},set:function(e){this._setValue("intensity",e);}},{key:"depthWrite",get:function(){return this.data.depthWrite},set:function(e){this._setValue("depthWrite",e);}},{key:"noFog",get:function(){return this.data.noFog},set:function(e){this._setValue("noFog",e);}},{key:"depthSoftening",get:function(){return this.data.depthSoftening},set:function(e){this._setValue("depthSoftening",e);}},{key:"sort",get:function(){return this.data.sort},set:function(e){this._setValue("sort",e);}},{key:"blendType",get:function(){return this.data.blendType},set:function(e){this._setValue("blendType",e);}},{key:"stretch",get:function(){return this.data.stretch},set:function(e){this._setValue("stretch",e);}},{key:"alignToMotion",get:function(){return this.data.alignToMotion},set:function(e){this._setValue("alignToMotion",e);}},{key:"emitterShape",get:function(){return this.data.emitterShape},set:function(e){this._setValue("emitterShape",e);}},{key:"emitterExtents",get:function(){return this.data.emitterExtents},set:function(e){this._setValue("emitterExtents",e);}},{key:"emitterExtentsInner",get:function(){return this.data.emitterExtentsInner},set:function(e){this._setValue("emitterExtentsInner",e);}},{key:"emitterRadius",get:function(){return this.data.emitterRadius},set:function(e){this._setValue("emitterRadius",e);}},{key:"emitterRadiusInner",get:function(){return this.data.emitterRadiusInner},set:function(e){this._setValue("emitterRadiusInner",e);}},{key:"initialVelocity",get:function(){return this.data.initialVelocity},set:function(e){this._setValue("initialVelocity",e);}},{key:"wrap",get:function(){return this.data.wrap},set:function(e){this._setValue("wrap",e);}},{key:"wrapBounds",get:function(){return this.data.wrapBounds},set:function(e){this._setValue("wrapBounds",e);}},{key:"localSpace",get:function(){return this.data.localSpace},set:function(e){this._setValue("localSpace",e);}},{key:"screenSpace",get:function(){return this.data.screenSpace},set:function(e){this._setValue("screenSpace",e);}},{key:"colorMapAsset",get:function(){return this.data.colorMapAsset},set:function(e){this._setValue("colorMapAsset",e);}},{key:"normalMapAsset",get:function(){return this.data.normalMapAsset},set:function(e){this._setValue("normalMapAsset",e);}},{key:"mesh",get:function(){return this.data.mesh},set:function(e){this._setValue("mesh",e);}},{key:"meshAsset",get:function(){return this.data.meshAsset},set:function(e){this._setValue("meshAsset",e);}},{key:"renderAsset",get:function(){return this.data.renderAsset},set:function(e){this._setValue("renderAsset",e);}},{key:"orientation",get:function(){return this.data.orientation},set:function(e){this._setValue("orientation",e);}},{key:"particleNormal",get:function(){return this.data.particleNormal},set:function(e){this._setValue("particleNormal",e);}},{key:"localVelocityGraph",get:function(){return this.data.localVelocityGraph},set:function(e){this._setValue("localVelocityGraph",e);}},{key:"localVelocityGraph2",get:function(){return this.data.localVelocityGraph2},set:function(e){this._setValue("localVelocityGraph2",e);}},{key:"velocityGraph",get:function(){return this.data.velocityGraph},set:function(e){this._setValue("velocityGraph",e);}},{key:"velocityGraph2",get:function(){return this.data.velocityGraph2},set:function(e){this._setValue("velocityGraph2",e);}},{key:"rotationSpeedGraph",get:function(){return this.data.rotationSpeedGraph},set:function(e){this._setValue("rotationSpeedGraph",e);}},{key:"rotationSpeedGraph2",get:function(){return this.data.rotationSpeedGraph2},set:function(e){this._setValue("rotationSpeedGraph2",e);}},{key:"radialSpeedGraph",get:function(){return this.data.radialSpeedGraph},set:function(e){this._setValue("radialSpeedGraph",e);}},{key:"radialSpeedGraph2",get:function(){return this.data.radialSpeedGraph2},set:function(e){this._setValue("radialSpeedGraph2",e);}},{key:"scaleGraph",get:function(){return this.data.scaleGraph},set:function(e){this._setValue("scaleGraph",e);}},{key:"scaleGraph2",get:function(){return this.data.scaleGraph2},set:function(e){this._setValue("scaleGraph2",e);}},{key:"colorGraph",get:function(){return this.data.colorGraph},set:function(e){this._setValue("colorGraph",e);}},{key:"colorGraph2",get:function(){return this.data.colorGraph2},set:function(e){this._setValue("colorGraph2",e);}},{key:"alphaGraph",get:function(){return this.data.alphaGraph},set:function(e){this._setValue("alphaGraph",e);}},{key:"alphaGraph2",get:function(){return this.data.alphaGraph2},set:function(e){this._setValue("alphaGraph2",e);}},{key:"colorMap",get:function(){return this.data.colorMap},set:function(e){this._setValue("colorMap",e);}},{key:"normalMap",get:function(){return this.data.normalMap},set:function(e){this._setValue("normalMap",e);}},{key:"animTilesX",get:function(){return this.data.animTilesX},set:function(e){this._setValue("animTilesX",e);}},{key:"animTilesY",get:function(){return this.data.animTilesY},set:function(e){this._setValue("animTilesY",e);}},{key:"animStartFrame",get:function(){return this.data.animStartFrame},set:function(e){this._setValue("animStartFrame",e);}},{key:"animNumFrames",get:function(){return this.data.animNumFrames},set:function(e){this._setValue("animNumFrames",e);}},{key:"animNumAnimations",get:function(){return this.data.animNumAnimations},set:function(e){this._setValue("animNumAnimations",e);}},{key:"animIndex",get:function(){return this.data.animIndex},set:function(e){this._setValue("animIndex",e);}},{key:"randomizeAnimIndex",get:function(){return this.data.randomizeAnimIndex},set:function(e){this._setValue("randomizeAnimIndex",e);}},{key:"animSpeed",get:function(){return this.data.animSpeed},set:function(e){this._setValue("animSpeed",e);}},{key:"animLoop",get:function(){return this.data.animLoop},set:function(e){this._setValue("animLoop",e);}},{key:"layers",get:function(){return this.data.layers},set:function(e){this._setValue("layers",e);}},{key:"drawOrder",get:function(){return this._drawOrder},set:function(e){this._drawOrder=e,this.emitter&&(this.emitter.drawOrder=e);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX),ym=function(){this.numParticles=1,this.rate=1,this.rate2=null,this.startAngle=0,this.startAngle2=null,this.lifetime=50,this.emitterExtents=new eW,this.emitterExtentsInner=new eW,this.emitterRadius=0,this.emitterRadiusInner=0,this.emitterShape=0,this.initialVelocity=0,this.wrap=false,this.wrapBounds=new eW,this.localSpace=false,this.screenSpace=false,this.colorMap=null,this.colorMapAsset=null,this.normalMap=null,this.normalMapAsset=null,this.loop=true,this.preWarm=false,this.sort=0,this.mode=0,this.scene=null,this.lighting=false,this.halfLambert=false,this.intensity=1,this.stretch=0,this.alignToMotion=false,this.depthSoftening=0,this.renderAsset=null,this.meshAsset=null,this.mesh=null,this.depthWrite=false,this.noFog=false,this.orientation=0,this.particleNormal=new eW(0,1,0),this.animTilesX=1,this.animTilesY=1,this.animStartFrame=0,this.animNumFrames=1,this.animNumAnimations=1,this.animIndex=0,this.randomizeAnimIndex=false,this.animSpeed=1,this.animLoop=true,this.scaleGraph=null,this.scaleGraph2=null,this.colorGraph=null,this.colorGraph2=null,this.alphaGraph=null,this.alphaGraph2=null,this.localVelocityGraph=null,this.localVelocityGraph2=null,this.velocityGraph=null,this.velocityGraph2=null,this.rotationSpeedGraph=null,this.rotationSpeedGraph2=null,this.radialSpeedGraph=null,this.radialSpeedGraph2=null,this.blendType=2,this.enabled=true,this.paused=false,this.autoPlay=true,this.layers=[0];},y_={particlePS:"\nvarying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n#ifndef CAMERAPLANES\n	#define CAMERAPLANES\n	uniform vec4 camera_params;\n#endif\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n	return clamp(x, 0.0, 1.0);\n}\nvoid main(void) {\n	vec4 tex  = texture2D(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y));\n	vec4 ramp = texture2D(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n	ramp.rgb *= colorMult;\n	ramp.a += texCoordsAlphaLife.z;\n	vec3 rgb = tex.rgb * ramp.rgb;\n	float a  = tex.a * ramp.a;\n",particleVS:"\nvec3 unpack3NFloats(float src) {\n	float r = fract(src);\n	float g = fract(src * 256.0);\n	float b = fract(src * 65536.0);\n	return vec3(r, g, b);\n}\nfloat saturate(float x) {\n	return clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc) {\n	return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc, out vec3 w) {\n	vec4 a = texture2D(tex,tc);\n	vec4 b = texture2D(tex,tc + graphSampleSize);\n	float c = fract(tc.x*graphNumSamples);\n	vec3 unpackedA = unpack3NFloats(a.w);\n	vec3 unpackedB = unpack3NFloats(b.w);\n	w = mix(unpackedA, unpackedB, c);\n	return mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n	float c = cos(pRotation);\n	float s = sin(pRotation);\n	mat2 m = mat2(c, -s, s, c);\n	rotMatrix = m;\n	return m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n	#ifdef SCREEN_SPACE\n		vec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;\n	#else\n		vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n	#endif\n	return pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n	vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n	return pos;\n}\nvec2 safeNormalize(vec2 v) {\n	float l = length(v);\n	return (l > 1e-06) ? v / l : v;\n}\nvoid main(void) {\n	vec3 meshLocalPos = particle_vertexData.xyz;\n	float id = floor(particle_vertexData.w);\n	float rndFactor = fract(sin(id + 1.0 + seed));\n	vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n	float uv = id / numParticlesPot;\n	readInput(uv);\n#ifdef LOCAL_SPACE\n	inVel = mat3(matrix_model) * inVel;\n#endif\n	vec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);\n	float particleLifetime = lifetime;\n	if (inLife <= 0.0 || inLife > particleLifetime || !inShow)\n		meshLocalPos = vec3(0.0);\n	vec2 quadXY = meshLocalPos.xy;\n	float nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n	vec3 paramDiv;\n	vec4 params = tex1Dlod_lerp(TEXTURE_PASS(internalTex2), vec2(nlife, 0), paramDiv);\n	float scale = params.y;\n	float scaleDiv = paramDiv.x;\n	float alphaDiv = paramDiv.z;\n	scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n#ifndef USE_MESH\n	texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n	texCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n	vec3 particlePos = inPos;\n	vec3 particlePosMoved = vec3(0.0);\n	mat2 rotMatrix;\n",particleAnimFrameClampVS:"\n	float animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n",particleAnimFrameLoopVS:"\n	float animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n",particleAnimTexVS:"\n	float animationIndex;\n	if (animTexIndexParams.y == 1.0) {\n		animationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n	} else {\n		animationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n	}\n	float atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n	float atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n	atlasX = fract(atlasX);\n	texCoordsAlphaLife.xy *= animTexTilesParams.xy;\n	texCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",particleInputFloatPS:"\nvoid readInput(float uv) {\n	vec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n	vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n	inPos = tex.xyz;\n	inVel = tex2.xyz;\n	inAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n	inShow = tex.w >= 0.0;\n	inLife = tex2.w;\n}\n",particleInputRgba8PS:"\n#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n	return rg.y * (1.0 / 255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n	return dot(rgba, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n}\nvoid readInput(float uv) {\n	vec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n	vec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n	vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n	vec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n	inPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n	inPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n	inVel = tex2.xyz;\n	inVel = (inVel - vec3(0.5)) * maxVel;\n	inAngle = decodeFloatRG(tex1.ba) * PI2;\n	inShow = tex2.a > 0.5;\n	inLife = decodeFloatRGBA(tex3);\n	float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n	float maxPosLife = lifetime+1.0;\n	inLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",particleOutputFloatPS:"\nvoid writeOutput() {\n	if (gl_FragCoord.y<1.0) {\n		gl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n	} else {\n		gl_FragColor = vec4(outVel, outLife);\n	}\n}\n",particleOutputRgba8PS:"\nuniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n	vec2 enc = vec2(1.0, 255.0) * v;\n	enc = fract(enc);\n	enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n	return enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n	vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n	enc = fract(enc);\n	enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n	return enc;\n}\nvoid writeOutput() {\n	outPos = outPos * outBoundsMul + outBoundsAdd;\n	outAngle = fract(outAngle / PI2);\n	outVel = (outVel / maxVel) + vec3(0.5);\n	float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n	float maxPosLife = lifetime+1.0;\n	outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n	if (gl_FragCoord.y < 1.0) {\n		gl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n	} else if (gl_FragCoord.y < 2.0) {\n		gl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n	} else if (gl_FragCoord.y < 3.0) {\n		gl_FragColor = vec4(outVel, visMode*0.5+0.5);\n	} else {\n		gl_FragColor = encodeFloatRGBA(outLife);\n	}\n}\n",particleUpdaterAABBPS:"\nuniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n	vec3 pos = inBounds - vec3(0.5);\n	vec3 posAbs = abs(pos);\n	vec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n	vec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n	pos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n	pos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n	pos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n#ifndef LOCAL_SPACE\n	return emitterPos + spawnBounds * pos;\n#else\n	return spawnBounds * pos;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n	localVelocity -= vec3(0, 0, initialVelocity);\n}\n",particleUpdaterEndPS:"\n	writeOutput();\n}\n",particleUpdaterInitPS:"\nvarying vec2 vUv0;\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\nuniform mat3 emitterMatrix;\nuniform mat3 emitterMatrixInv;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos;\nuniform vec3 frameRandom;\nuniform vec3 localVelocityDivMult;\nuniform vec3 velocityDivMult;\nuniform float delta;\nuniform float rate;\nuniform float rateDiv;\nuniform float lifetime;\nuniform float numParticles;\nuniform float rotSpeedDivMult;\nuniform float radialSpeedDivMult;\nuniform float seed;\nuniform float startAngle;\nuniform float startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",particleUpdaterNoRespawnPS:"\n	if (outLife >= lifetime) {\n		outLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n		visMode = -1.0;\n	}\n",particleUpdaterOnStopPS:"\n	visMode = outLife < 0.0? -1.0: visMode;\n",particleUpdaterRespawnPS:"\n	if (outLife >= lifetime) {\n		outLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n		visMode = 1.0;\n	}\n	visMode = outLife < 0.0? 1.0: visMode;\n",particleUpdaterSpherePS:"\nuniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n	float rnd4 = fract(rndFactor * 1000.0);\n	vec3 norm = normalize(inBounds.xyz - vec3(0.5));\n	float r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n	return emitterPos + norm * r * spawnBoundsSphere;\n#else\n	return norm * r * spawnBoundsSphere;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n	localVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",particleUpdaterStartPS:"\nfloat saturate(float x) {\n	return clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n	float r = fract(src);\n	float g = fract(src * 256.0);\n	float b = fract(src * 65536.0);\n	return vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc, out vec3 w) {\n	vec4 a = texture2D(tex, tc);\n	vec4 b = texture2D(tex, tc + graphSampleSize);\n	float c = fract(tc.x * graphNumSamples);\n	vec3 unpackedA = unpack3NFloats(a.w);\n	vec3 unpackedB = unpack3NFloats(b.w);\n	w = mix(unpackedA, unpackedB, c);\n	return mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n	vec4 p4 = fract(vec4(p) * HASHSCALE4);\n	p4 += dot(p4, p4.wzxy+19.19);\n	return fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void) {\n	if (gl_FragCoord.x > numParticles) discard;\n	readInput(vUv0.x);\n	visMode = inShow? 1.0 : -1.0;\n	vec4 rndFactor = hash41(gl_FragCoord.x + seed);\n	float particleRate = rate + rateDiv * rndFactor.x;\n	outLife = inLife + delta;\n	float nlife = clamp(outLife / lifetime, 0.0, 1.0);\n	vec3 localVelocityDiv;\n	vec3 velocityDiv;\n	vec3 paramDiv;\n	vec3 localVelocity = tex1Dlod_lerp(TEXTURE_PASS(internalTex0), vec2(nlife, 0), localVelocityDiv);\n	vec3 velocity =	  tex1Dlod_lerp(TEXTURE_PASS(internalTex1), vec2(nlife, 0), velocityDiv);\n	vec3 params =		tex1Dlod_lerp(TEXTURE_PASS(internalTex2), vec2(nlife, 0), paramDiv);\n	float rotSpeed = params.x;\n	float rotSpeedDiv = paramDiv.y;\n	vec3 radialParams = tex1Dlod_lerp(TEXTURE_PASS(internalTex3), vec2(nlife, 0), paramDiv);\n	float radialSpeed = radialParams.x;\n	float radialSpeedDiv = radialParams.y;\n	bool respawn = inLife <= 0.0 || outLife >= lifetime;\n	inPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n	inAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n#ifndef LOCAL_SPACE\n	vec3 radialVel = inPos - emitterPos;\n#else\n	vec3 radialVel = inPos;\n#endif\n	radialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n	radialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n	localVelocity +=	(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n	velocity +=		 (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n	rotSpeed +=		 (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n	addInitialVelocity(localVelocity, rndFactor.xyz);\n#ifndef LOCAL_SPACE\n	outVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n	outVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n	outPos = inPos + outVel * delta;\n	outAngle = inAngle + rotSpeed * delta;\n",particle_billboardVS:"\n	quadXY = rotate(quadXY, inAngle, rotMatrix);\n	vec3 localPos = billboard(particlePos, quadXY);\n",particle_blendAddPS:"\n	dBlendModeFogFactor = 0.0;\n	rgb *= saturate(gammaCorrectInput(max(a, 0.0)));\n	if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",particle_blendMultiplyPS:"\n	rgb = mix(vec3(1.0), rgb, vec3(a));\n	if (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",particle_blendNormalPS:"\n	if (a < 0.01) discard;\n",particle_cpuVS:"\nattribute vec4 particle_vertexData;\nattribute vec4 particle_vertexData2;\nattribute vec4 particle_vertexData3;\nattribute float particle_vertexData4;\n#ifndef USE_MESH\n	attribute vec2 particle_vertexData5;\n#else\n	attribute vec4 particle_vertexData5;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifndef VIEWMATRIX\n	#define VIEWMATRIX\n	uniform mat4 matrix_view;\n#endif\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale;\nuniform vec3 faceTangent;\nuniform vec3 faceBinorm;\n#ifdef PARTICLE_GPU\n	uniform highp sampler2D internalTex0;\n	uniform highp sampler2D internalTex1;\n	uniform highp sampler2D internalTex2;\n#endif\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n	float c = cos(pRotation);\n	float s = sin(pRotation);\n	mat2 m = mat2(c, -s, s, c);\n	rotMatrix = m;\n	return m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n	vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n	return pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n	vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n	return pos;\n}\nvoid main(void)\n{\n	vec3 particlePos = particle_vertexData.xyz;\n	vec3 inPos = particlePos;\n	vec3 vertPos = particle_vertexData3.xyz;\n	vec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n	float id = floor(particle_vertexData4);\n	float rndFactor = fract(sin(id + 1.0 + seed));\n	vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n#ifdef LOCAL_SPACE\n	inVel = mat3(matrix_model) * inVel;\n#endif\n	vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);\n	vec2 quadXY = vertPos.xy;\n#ifdef USE_MESH\n	texCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#else\n	texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#endif\n	mat2 rotMatrix;\n	float inAngle = particle_vertexData2.x;\n	vec3 particlePosMoved = vec3(0.0);\n	vec3 meshLocalPos = particle_vertexData3.xyz;\n",particle_cpu_endVS:"\n	localPos *= particle_vertexData2.y * emitterScale;\n	localPos += particlePos;\n	gl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\n	quadXY = rotate(quadXY, inAngle, rotMatrix);\n	vec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"\n	rgb = addFog(rgb);\n	rgb = toneMap(rgb);\n	rgb = gammaCorrectOutput(rgb);\n	gl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\n	localPos *= scale * emitterScale;\n	localPos += particlePos;\n	#ifdef SCREEN_SPACE\n	gl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);\n	#else\n	gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n	#endif\n",particle_halflambertPS:"\n	vec3 negNormal = normal * 0.5 + 0.5;\n	vec3 posNormal = -normal * 0.5 + 0.5;\n	negNormal *= negNormal;\n	posNormal *= posNormal;\n",particle_initVS:"\nattribute vec4 particle_vertexData;\n#if defined(USE_MESH)\n	#if defined(USE_MESH_UV)\n		attribute vec2 particle_uv;\n	#else\n		vec2 particle_uv = vec2(0.0, 0.0);\n	#endif\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n#ifndef VIEWMATRIX\n	#define VIEWMATRIX\n	uniform mat4 matrix_view;\n#endif\nuniform float numParticles;\nuniform float numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos;\nuniform vec3 faceTangent;\nuniform vec3 faceBinorm;\nuniform float rate;\nuniform float rateDiv;\nuniform float lifetime;\nuniform float deltaRandomnessStatic;\nuniform float scaleDivMult;\nuniform float alphaDivMult;\nuniform float seed;\nuniform float delta;\nuniform sampler2D particleTexOUT;\nuniform sampler2D particleTexIN;\n#ifdef PARTICLE_GPU\n	uniform highp sampler2D internalTex0;\n	uniform highp sampler2D internalTex1;\n	uniform highp sampler2D internalTex2;\n#endif\n#ifndef CAMERAPLANES\n	#define CAMERAPLANES\n	uniform vec4 camera_params;\n#endif\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",particle_lambertPS:"\n	vec3 negNormal = max(normal, vec3(0.0));\n	vec3 posNormal = max(-normal, vec3(0.0));\n",particle_lightingPS:"\n	vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n						negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n						negNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n	rgb *= light;\n",particle_localShiftVS:"\n	particlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",particle_meshVS:"\n	vec3 localPos = meshLocalPos;\n	localPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n	localPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n	billboard(particlePos, quadXY);\n",particle_normalVS:"\n	Normal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\n	vec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);\n	vec3 normal = ParticleMat * normalMap;\n",particle_pointAlongVS:"\n	inAngle = atan(velocityV.x, velocityV.y);\n",particle_simulationPS:'\n	#include "particleUpdaterInitPS"\n	#ifdef PACK8\n		#include "particleInputRgba8PS"\n		#include "particleOutputRgba8PS"\n	#else\n		#include "particleInputFloatPS"\n		#include "particleOutputFloatPS"\n	#endif\n	#ifdef EMITTERSHAPE_BOX\n		#include "particleUpdaterAABBPS"\n	#else\n		#include "particleUpdaterSpherePS"\n	#endif\n	#include "particleUpdaterStartPS"\n	#ifdef RESPAWN\n		#include "particleUpdaterRespawnPS"\n	#endif\n	#ifdef NO_RESPAWN\n		#include "particleUpdaterNoRespawnPS"\n	#endif\n	#ifdef ON_STOP\n		#include "particleUpdaterOnStopPS"\n	#endif\n	#include "particleUpdaterEndPS"\n',particle_shaderPS:'\n	#if NORMAL != NONE\n		#if NORMAL == VERTEX\n			varying vec3 Normal;\n		#endif\n		#if NORMAL == MAP\n			varying mat3 ParticleMat;\n		#endif\n		uniform vec3 lightCube[6];\n	#endif\n	#ifdef SOFT\n		varying float vDepth;\n		#include "screenDepthPS"\n	#endif\n	#include "gammaPS"\n	#include "tonemappingPS"\n	#include "fogPS"\n	#if NORMAL == MAP\n		uniform sampler2D normalMap;\n	#endif\n	#include "particlePS"\n	#ifdef SOFT\n		#include "particle_softPS"\n	#endif\n	#if NORMAL == VERTEX\n		vec3 normal = Normal;\n	#endif\n	#if NORMAL == MAP\n		#include "particle_normalMapPS"\n	#endif\n	#if NORMAL != NONE\n		#ifdef HALF_LAMBERT\n			#include "particle_halflambertPS"\n		#else\n			#include "particle_lambertPS"\n		#endif\n		#include "particle_lightingPS"\n	#endif\n	#if BLEND == NORMAL\n		#include "particle_blendNormalPS"\n	#elif BLEND == ADDITIVE\n		#include "particle_blendAddPS"\n	#elif BLEND == MULTIPLICATIVE\n		#include "particle_blendMultiplyPS"\n	#endif\n	#include "particle_endPS"\n',particle_shaderVS:'\n	#ifdef ANIMTEX\n		uniform vec2 animTexTilesParams;\n		uniform vec4 animTexParams;\n		uniform vec2 animTexIndexParams;\n	#endif\n	#if NORMAL == MAP\n		varying mat3 ParticleMat;\n	#endif\n	#if NORMAL == VERTEX\n		varying vec3 Normal;\n	#endif\n	#ifdef SOFT\n		varying float vDepth;\n	#endif\n	#ifdef PARTICLE_GPU\n		#include "particle_initVS"\n		#ifdef PACK8\n			#include "particleInputRgba8PS"\n		#else\n			#include  "particleInputFloatPS"\n		#endif\n		#ifdef SOFT\n			#include "screenDepthPS"\n		#endif\n		#include "particleVS"\n	#else\n		#ifdef SOFT\n			#include "screenDepthPS"\n		#endif\n		#include "particle_cpuVS"\n	#endif\n	#ifdef LOCAL_SPACE\n		#include "particle_localShiftVS"\n	#endif\n	#ifdef ANIMTEX\n		#ifdef ANIMTEX_LOOP\n			#include "particleAnimFrameLoopVS"\n		#else\n			#include "particleAnimFrameClampVS"\n		#endif\n		#include "particleAnimTexVS"\n	#endif\n	#ifdef PARTICLE_GPU\n		#ifdef WRAP\n			#include "particle_wrapVS"\n		#endif\n	#endif\n	#ifdef ALIGN_TO_MOTION\n		#include "particle_pointAlongVS"\n	#endif\n	#ifdef USE_MESH\n		#include "particle_meshVS"\n	#else\n		#ifdef CUSTOM_FACE\n			#include "particle_customFaceVS"\n		#else\n			#include "particle_billboardVS"\n		#endif\n	#endif\n	#if NORMAL == VERTEX\n		#include "particle_normalVS"\n	#endif\n	#if NORMAL == MAP\n		#include "particle_TBNVS"\n	#endif\n	#ifdef STRETCH\n		#include "particle_stretchVS"\n	#endif\n	#ifdef PARTICLE_GPU\n		#include "particle_endVS"\n	#else\n		#include "particle_cpu_endVS"\n	#endif\n	#ifdef SOFT\n		#include "particle_softVS"\n	#endif\n	}\n',particle_softPS:"\n	float depth = getLinearScreenDepth();\n	float particleDepth = vDepth;\n	float depthDiff = saturate(abs(particleDepth - depth) * softening);\n	a *= depthDiff;\n",particle_softVS:"\n	vDepth = getLinearDepth(localPos);\n",particle_stretchVS:"\n	vec3 moveDir = inVel * stretch;\n	vec3 posPrev = particlePos - moveDir;\n	posPrev += particlePosMoved;\n	vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n	float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n	particlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\n	mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);\n	ParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",particle_wrapVS:"\n	vec3 origParticlePos = particlePos;\n	particlePos -= matrix_model[3].xyz;\n	particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n	particlePos += matrix_model[3].xyz;\n	particlePosMoved = particlePos - origParticlePos;\n"},yv={particlePS:"\nvarying texCoordsAlphaLife: vec4f;\nvar colorMap: texture_2d<f32>;\nvar colorMapSampler: sampler;\nvar colorParam: texture_2d<f32>;\nvar colorParamSampler: sampler;\nuniform graphSampleSize: f32;\nuniform graphNumSamples: f32;\n#ifndef CAMERAPLANES\n	#define CAMERAPLANES\n	uniform camera_params: vec4f;\n#endif\nuniform softening: f32;\nuniform colorMult: f32;\nfn saturate(x: f32) -> f32 {\n	return clamp(x, 0.0, 1.0);\n}\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n	var output: FragmentOutput;\n	let tex: vec4f  = textureSample(colorMap, colorMapSampler, vec2f(input.texCoordsAlphaLife.x, 1.0 - input.texCoordsAlphaLife.y));\n	var ramp: vec4f = textureSample(colorParam, colorParamSampler, vec2f(input.texCoordsAlphaLife.w, 0.0));\n	ramp = vec4f(ramp.rgb * uniform.colorMult, ramp.a);\n	ramp.a = ramp.a + input.texCoordsAlphaLife.z;\n	var rgb: vec3f = tex.rgb * ramp.rgb;\n	var a: f32 = tex.a * ramp.a;\n",particleVS:"\nfn unpack3NFloats(src: f32) -> vec3f {\n	let r = fract(src);\n	let g = fract(src * 256.0);\n	let b = fract(src * 65536.0);\n	return vec3f(r, g, b);\n}\nfn saturate(x: f32) -> f32 {\n	return clamp(x, 0.0, 1.0);\n}\nstruct TexLerpUnpackResult {\n	result: vec4f,\n	unpacked: vec3f\n}\nfn tex1Dlod_lerp_simple(tex: texture_2d<f32>, texSampler: sampler, tc: vec2f) -> vec4f {\n	let tc_next = tc + vec2f(uniform.graphSampleSize);\n	return mix( textureSample(tex, texSampler, tc), textureSample(tex, texSampler, tc_next), fract(tc.x * uniform.graphNumSamples) );\n}\nfn tex1Dlod_lerp_unpack(tex: texture_2d<f32>, texSampler: sampler, tc: vec2f) -> TexLerpUnpackResult {\n	let tc_next = tc + vec2f(uniform.graphSampleSize);\n	let a = textureSampleLevel(tex, texSampler, tc, 0.0);\n	let b = textureSampleLevel(tex, texSampler, tc_next, 0.0);\n	let c = fract(tc.x * uniform.graphNumSamples);\n	let unpackedA = unpack3NFloats(a.w);\n	let unpackedB = unpack3NFloats(b.w);\n	let w_out = mix(unpackedA, unpackedB, c);\n	return TexLerpUnpackResult(mix(a, b, c), w_out);\n}\nstruct RotateResult {\n	rotatedVec: vec2f,\n	matrix: mat2x2f\n}\nfn rotateWithMatrix(quadXY: vec2f, pRotation: f32) -> RotateResult {\n	let c = cos(pRotation);\n	let s = sin(pRotation);\n	let m = mat2x2f(vec2f(c, -s), vec2f(s, c));\n	return RotateResult(m * quadXY, m);\n}\nfn billboard(InstanceCoords: vec3f, quadXY: vec2f) -> vec3f {\n	var pos: vec3f;\n	#ifdef SCREEN_SPACE\n		pos = vec3f(-1.0, 0.0, 0.0) * quadXY.x + vec3f(0.0, -1.0, 0.0) * quadXY.y;\n	#else\n		pos = -uniform.matrix_viewInverse[0].xyz * quadXY.x + -uniform.matrix_viewInverse[1].xyz * quadXY.y;\n	#endif\n	return pos;\n}\nfn customFace(InstanceCoords: vec3f, quadXY: vec2f) -> vec3f {\n	let pos = uniform.faceTangent * quadXY.x + uniform.faceBinorm * quadXY.y;\n	return pos;\n}\nfn safeNormalize(v: vec2f) -> vec2f {\n	let l = length(v);\n	return select(v, v / l, l > 1e-06);\n}\n@vertex\nfn vertexMain(input: VertexInput) -> VertexOutput {\n	var output: VertexOutput;\n	let meshLocalPos_in = input.particle_vertexData.xyz;\n	let id = floor(input.particle_vertexData.w);\n	let rndFactor = fract(sin(id + 1.0 + uniform.seed));\n	let rndFactor3 = vec3f(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n	let uv = id / uniform.numParticlesPot;\n	readInput(uv);\n	#ifdef LOCAL_SPACE\n		let modelRotation = mat3x3f(uniform.matrix_model[0].xyz, uniform.matrix_model[1].xyz, uniform.matrix_model[2].xyz);\n		inVel = modelRotation * inVel;\n	#endif\n	let viewRotation = mat3x3f(uniform.matrix_view[0].xyz, uniform.matrix_view[1].xyz, uniform.matrix_view[2].xyz);\n	let velocityV = safeNormalize((viewRotation * inVel).xy);\n	let particleLifetime = uniform.lifetime;\n	var meshLocalPos = meshLocalPos_in;\n	if (inLife <= 0.0 || inLife > particleLifetime || !inShow) {\n		 meshLocalPos = vec3f(0.0);\n	}\n	let quadXY = meshLocalPos.xy;\n	let nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n	let lerp_result = tex1Dlod_lerp_unpack(internalTex2, internalTex2Sampler, vec2f(nlife, 0.0));\n	let params = lerp_result.result;\n	let paramDiv = lerp_result.unpacked;\n	var scale = params.y;\n	let scaleDiv = paramDiv.x;\n	let alphaDiv = paramDiv.z;\n	scale = scale + (scaleDiv * 2.0 - 1.0) * uniform.scaleDivMult * fract(rndFactor*10000.0);\n	#ifndef USE_MESH\n		output.texCoordsAlphaLife = vec4f(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * uniform.alphaDivMult * fract(rndFactor*1000.0), nlife);\n	#else\n		output.texCoordsAlphaLife = vec4f(particle_uv, (alphaDiv * 2.0 - 1.0) * uniform.alphaDivMult * fract(rndFactor*1000.0), nlife);\n	#endif\n	var particlePos = inPos;\n	var particlePosMoved = vec3f(0.0);\n	var rotMatrix: mat2x2f;\n",particleAnimFrameClampVS:"\n	let animFrame: f32 = min(floor(input.texCoordsAlphaLife.w * uniform.animTexParams.y) + uniform.animTexParams.x, uniform.animTexParams.z);\n",particleAnimFrameLoopVS:"\n	let animFrame: f32 = floor((output.texCoordsAlphaLife.w * uniform.animTexParams.y + uniform.animTexParams.x) % (uniform.animTexParams.z + 1.0));	\n",particleAnimTexVS:"\n	var animationIndex: f32;\n	if (uniform.animTexIndexParams.y == 1.0) {\n		animationIndex = floor((uniform.animTexParams.w + 1.0) * rndFactor3.z) * (uniform.animTexParams.z + 1.0);\n	} else {\n		animationIndex = uniform.animTexIndexParams.x * (uniform.animTexParams.z + 1.0);\n	}\n	var atlasX: f32 = (animationIndex + animFrame) * uniform.animTexTilesParams.x;\n	let atlasY: f32 = 1.0 - floor(atlasX + 1.0) * uniform.animTexTilesParams.y;\n	atlasX = fract(atlasX);\n	let current_tcal_xy = output.texCoordsAlphaLife.xy;\n	let scaled_tcal_xy = current_tcal_xy * uniform.animTexTilesParams.xy;\n	let final_tcal_xy = scaled_tcal_xy + vec2f(atlasX, atlasY);\n	output.texCoordsAlphaLife = vec4f(final_tcal_xy, output.texCoordsAlphaLife.z, output.texCoordsAlphaLife.w);\n",particleInputFloatPS:"\nfn readInput(uv: f32) {\n	let tex: vec4f = textureSampleLevel(particleTexIN, particleTexINSampler, vec2f(uv, 0.25), 0.0);\n	let tex2: vec4f = textureSampleLevel(particleTexIN, particleTexINSampler, vec2f(uv, 0.75), 0.0);\n	inPos = tex.xyz;\n	inVel = tex2.xyz;\n	inAngle = abs(tex.w) - 1000.0;\n	inShow = tex.w >= 0.0;\n	inLife = tex2.w;\n}\n",particleInputRgba8PS:"\nconst PI2: f32 = 6.283185307179586;\nuniform inBoundsSize: vec3f;\nuniform inBoundsCenter: vec3f;\nuniform maxVel: f32;\nfn decodeFloatRG(rg: vec2f) -> f32 {\n	return rg.y * (1.0 / 255.0) + rg.x;\n}\nfn decodeFloatRGBA( rgba: vec4f ) -> f32 {\n	return dot(rgba, vec4f(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n}\nfn readInput(uv: f32) {\n	let tex0 = textureSampleLevel(particleTexIN, particleTexINSampler, vec2f(uv, 0.125), 0.0);\n	let tex1 = textureSampleLevel(particleTexIN, particleTexINSampler, vec2f(uv, 0.375), 0.0);\n	let tex2 = textureSampleLevel(particleTexIN, particleTexINSampler, vec2f(uv, 0.625), 0.0);\n	let tex3 = textureSampleLevel(particleTexIN, particleTexINSampler, vec2f(uv, 0.875), 0.0);\n	inPos = vec3f(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n	inPos = (inPos - vec3f(0.5)) * uniform.inBoundsSize + uniform.inBoundsCenter;\n	inVel = tex2.xyz;\n	inVel = (inVel - vec3f(0.5)) * uniform.maxVel;\n	inAngle = decodeFloatRG(tex1.ba) * PI2;\n	inShow = tex2.a > 0.5;\n	let life_decoded = decodeFloatRGBA(tex3);\n	let maxNegLife = max(uniform.lifetime, (uniform.numParticles - 1.0) * (uniform.rate + uniform.rateDiv));\n	let maxPosLife = uniform.lifetime + 1.0;\n	inLife = life_decoded * (maxNegLife + maxPosLife) - maxNegLife;\n}",particleOutputFloatPS:"\nfn getOutput() -> vec4f {\n	if (pcPosition.y < 1.0) {\n		return vec4f(outPos, (outAngle + 1000.0) * visMode);\n	} else {\n		return vec4f(outVel, outLife);\n	}\n}\n",particleOutputRgba8PS:"\nuniform outBoundsMul: vec3f;\nuniform outBoundsAdd: vec3f;\nfn encodeFloatRG( v: f32 ) -> vec2f {\n	var enc: vec2f = vec2f(1.0, 255.0) * v;\n	enc = fract(enc);\n	enc = enc - enc.yy * (1.0 / 255.0);\n	return enc;\n}\nfn encodeFloatRGBA( v: f32 ) -> vec4f {\n	let factors = vec4f(1.0, 255.0, 65025.0, 160581375.0);\n	var enc: vec4f = factors * v;\n	enc = fract(enc);\n	enc = enc - enc.yzww * vec4f(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n	return enc;\n}\nfn getOutput() -> vec4f {\n	outPos = outPos * uniform.outBoundsMul + uniform.outBoundsAdd;\n	outAngle = fract(outAngle / PI2);\n	outVel = (outVel / uniform.maxVel) + vec3f(0.5);\n	let maxNegLife = max(uniform.lifetime, (uniform.numParticles - 1.0) * (uniform.rate + uniform.rateDiv));\n	let maxPosLife = uniform.lifetime + 1.0;\n	outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n	if (pcPosition.y < 1.0) {\n		return vec4f(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n	} else if (pcPosition.y < 2.0) {\n		return vec4f(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n	} else if (pcPosition.y < 3.0) {\n		return vec4f(outVel, visMode * 0.5 + 0.5);\n	} else {\n		return encodeFloatRGBA(outLife);\n	}\n}\n",particleUpdaterAABBPS:"\nuniform spawnBounds: mat3x3f;\nuniform spawnPosInnerRatio: vec3f;\nfn calcSpawnPosition(inBounds: vec3f, rndFactor: f32) -> vec3f {\n	var pos = inBounds - vec3f(0.5);\n	let posAbs = abs(pos);\n	let maxComp = max(posAbs.x, max(posAbs.y, posAbs.z));\n	let maxPos = vec3f(maxComp);\n	let edge = maxPos + (vec3f(0.5) - maxPos) * uniform.spawnPosInnerRatio;\n	pos.x = edge.x * select(2.0 * pos.x, sign(pos.x), maxPos.x == posAbs.x);\n	pos.y = edge.y * select(2.0 * pos.y, sign(pos.y), maxPos.y == posAbs.y);\n	pos.z = edge.z * select(2.0 * pos.z, sign(pos.z), maxPos.z == posAbs.z);\n	#ifndef LOCAL_SPACE\n		return uniform.emitterPos + uniform.spawnBounds * pos;\n	#else\n		return uniform.spawnBounds * pos;\n	#endif\n}\nfn addInitialVelocity(localVelocity: ptr<function, vec3f>, inBounds: vec3f) {\n	*localVelocity = *localVelocity - vec3f(0.0, 0.0, uniform.initialVelocity);\n}\n",particleUpdaterEndPS:"\n	output.color = getOutput();\n	return output;\n}\n",particleUpdaterInitPS:"\nvarying vUv0: vec2f;\nvar particleTexIN: texture_2d<f32>;\nvar particleTexINSampler: sampler;\nvar internalTex0: texture_2d<f32>;\nvar internalTex0Sampler: sampler;\nvar internalTex1: texture_2d<f32>;\nvar internalTex1Sampler: sampler;\nvar internalTex2: texture_2d<f32>;\nvar internalTex2Sampler: sampler;\nvar internalTex3: texture_2d<f32>;\nvar internalTex3Sampler: sampler;\nuniform emitterMatrix: mat3x3f;\nuniform emitterMatrixInv: mat3x3f;\nuniform emitterScale: vec3f;\nuniform emitterPos: vec3f;\nuniform frameRandom: vec3f;\nuniform localVelocityDivMult: vec3f;\nuniform velocityDivMult: vec3f;\nuniform delta: f32;\nuniform rate: f32;\nuniform rateDiv: f32;\nuniform lifetime: f32;\nuniform numParticles: f32;\nuniform rotSpeedDivMult: f32;\nuniform radialSpeedDivMult: f32;\nuniform seed: f32;\nuniform startAngle: f32;\nuniform startAngle2: f32;\nuniform initialVelocity: f32;\nuniform graphSampleSize: f32;\nuniform graphNumSamples: f32;\nvar<private> inPos: vec3f;\nvar<private> inVel: vec3f;\nvar<private> inAngle: f32;\nvar<private> inShow: bool;\nvar<private> inLife: f32;\nvar<private> visMode: f32;\nvar<private> outPos: vec3f;\nvar<private> outVel: vec3f;\nvar<private> outAngle: f32;\nvar<private> outShow: bool;\nvar<private> outLife: f32;\n",particleUpdaterNoRespawnPS:"\n	if (outLife >= uniform.lifetime) {\n		outLife = outLife - max(uniform.lifetime, (uniform.numParticles - 1.0) * particleRate);\n		visMode = -1.0;\n	}\n",particleUpdaterOnStopPS:"\n	visMode = select(visMode, -1.0, outLife < 0.0);\n",particleUpdaterRespawnPS:"\n	if (outLife >= uniform.lifetime) {\n		let subtractAmount = max(uniform.lifetime, (uniform.numParticles - 1.0) * particleRate);\n		outLife = outLife - subtractAmount;\n		visMode = 1.0;\n	}\n	visMode = select(visMode, 1.0, outLife < 0.0);\n",particleUpdaterSpherePS:"\nuniform spawnBoundsSphere: f32;\nuniform spawnBoundsSphereInnerRatio: f32;\nfn calcSpawnPosition(inBounds: vec3f, rndFactor: f32) -> vec3f {\n	let rnd4: f32 = fract(rndFactor * 1000.0);\n	let norm: vec3f = normalize(inBounds.xyz - vec3f(0.5));\n	let r: f32 = rnd4 * (1.0 - uniform.spawnBoundsSphereInnerRatio) + uniform.spawnBoundsSphereInnerRatio;\n	#ifndef LOCAL_SPACE\n		return uniform.emitterPos + norm * r * uniform.spawnBoundsSphere;\n	#else\n		return norm * r * uniform.spawnBoundsSphere;\n	#endif\n}\nfn addInitialVelocity(localVelocity: ptr<function, vec3f>, inBounds: vec3f) {\n	let initialVelOffset: vec3f = normalize(inBounds - vec3f(0.5)) * uniform.initialVelocity;\n	*localVelocity = *localVelocity + initialVelOffset;\n}\n",particleUpdaterStartPS:"\nfn saturate(x: f32) -> f32 {\n	return clamp(x, 0.0, 1.0);\n}\nfn unpack3NFloats(src: f32) -> vec3f {\n	let r = fract(src);\n	let g = fract(src * 256.0);\n	let b = fract(src * 65536.0);\n	return vec3f(r, g, b);\n}\nstruct TexLerpUnpackResult {\n	result: vec3f,\n	unpacked: vec3f\n}\nfn tex1Dlod_lerp(tex: texture_2d<f32>, texSampler: sampler, tc: vec2f) -> TexLerpUnpackResult {\n	let tc_next = tc + vec2f(uniform.graphSampleSize);\n	let a = textureSampleLevel(tex, texSampler, tc, 0.0);\n	let b = textureSampleLevel(tex, texSampler, tc_next, 0.0);\n	let c = fract(tc.x * uniform.graphNumSamples);\n	let unpackedA = unpack3NFloats(a.w);\n	let unpackedB = unpack3NFloats(b.w);\n	let w_out = mix(unpackedA, unpackedB, c);\n	return TexLerpUnpackResult(mix(a.xyz, b.xyz, c), w_out);\n}\nconst HASHSCALE4: vec4f = vec4f(1031.0, 0.1030, 0.0973, 0.1099);\nfn hash41(p: f32) -> vec4f {\n	var p4 = fract(vec4f(p) * HASHSCALE4);\n	p4 = p4 + dot(p4, p4.wzxy + 19.19);\n	return fract(vec4f((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\n@fragment\nfn fragmentMain(input : FragmentInput) -> FragmentOutput {\n	var output: FragmentOutput;\n	if (pcPosition.x > uniform.numParticles) {\n		discard;\n		return output;\n	}\n	readInput(input.vUv0.x);\n	visMode = select(-1.0, 1.0, inShow);\n	let rndFactor = hash41(pcPosition.x + uniform.seed);\n	let particleRate = uniform.rate + uniform.rateDiv * rndFactor.x;\n	outLife = inLife + uniform.delta;\n	let nlife = clamp(outLife / uniform.lifetime, 0.0, 1.0);\n	let lerpResult0 = tex1Dlod_lerp(internalTex0, internalTex0Sampler, vec2f(nlife, 0.0));\n	var localVelocity = lerpResult0.result;\n	let localVelocityDiv = lerpResult0.unpacked;\n	let lerpResult1 = tex1Dlod_lerp(internalTex1, internalTex1Sampler, vec2f(nlife, 0.0));\n	var velocity = lerpResult1.result;\n	let velocityDiv = lerpResult1.unpacked;\n	let lerpResult2 = tex1Dlod_lerp(internalTex2, internalTex2Sampler, vec2f(nlife, 0.0));\n	let params = lerpResult2.result;\n	let paramDiv = lerpResult2.unpacked;\n	var rotSpeed = params.x;\n	let rotSpeedDiv = paramDiv.y;\n	let lerpResult3 = tex1Dlod_lerp(internalTex3, internalTex3Sampler, vec2f(nlife, 0.0));\n	let radialParams = lerpResult3.result;\n	let radialParamDiv = lerpResult3.unpacked;\n	let radialSpeed = radialParams.x;\n	let radialSpeedDiv = radialParamDiv.y;\n	let respawn = inLife <= 0.0 || outLife >= uniform.lifetime;\n	inPos = select(inPos, calcSpawnPosition(rndFactor.xyz, rndFactor.x), respawn);\n	inAngle = select(inAngle, mix(uniform.startAngle, uniform.startAngle2, rndFactor.x), respawn);\n	#ifndef LOCAL_SPACE\n		var radialVel: vec3f = inPos - uniform.emitterPos;\n	#else\n		var radialVel: vec3f = inPos;\n	#endif\n	radialVel = select(vec3f(0.0), radialSpeed * normalize(radialVel), dot(radialVel, radialVel) > 1.0E-8);\n	radialVel = radialVel + (radialSpeedDiv * vec3f(2.0) - vec3f(1.0)) * uniform.radialSpeedDivMult * rndFactor.xyz;\n	localVelocity = localVelocity + (localVelocityDiv * vec3f(2.0) - vec3f(1.0)) * uniform.localVelocityDivMult * rndFactor.xyz;\n	velocity = velocity + (velocityDiv * vec3f(2.0) - vec3f(1.0)) * uniform.velocityDivMult * rndFactor.xyz;\n	rotSpeed = rotSpeed + (rotSpeedDiv * 2.0 - 1.0) * uniform.rotSpeedDivMult * rndFactor.y;\n	addInitialVelocity(&localVelocity, rndFactor.xyz);\n	#ifndef LOCAL_SPACE\n		outVel = uniform.emitterMatrix * localVelocity + (radialVel + velocity) * uniform.emitterScale;\n	#else\n		outVel = (localVelocity + radialVel) / uniform.emitterScale + uniform.emitterMatrixInv * velocity;\n	#endif\n	outPos = inPos + outVel * uniform.delta;\n	outAngle = inAngle + rotSpeed * uniform.delta;\n",particle_billboardVS:"\n	let rotationResult = rotateWithMatrix(quadXY, inAngle);\n	let rotatedQuadXY = rotationResult.rotatedVec;\n	rotMatrix = rotationResult.matrix;\n	var localPos = billboard(particlePos, rotatedQuadXY);\n",particle_blendAddPS:"\n	dBlendModeFogFactor = 0.0;\n	rgb = rgb * saturate(gammaCorrectInput(max(a, 0.0)));\n	if ((rgb.r + rgb.g + rgb.b) < 0.000001) {\n		discard;\n	}	\n",particle_blendMultiplyPS:"\n	rgb = mix(vec3f(1.0), rgb, a);\n	if ((rgb.r + rgb.g + rgb.b) > 2.99) {\n		discard;\n	}\n",particle_blendNormalPS:"\n	if (a < 0.01) {\n		discard;\n	}\n",particle_cpuVS:"\nattribute particle_vertexData: vec4f;\nattribute particle_vertexData2: vec4f;\nattribute particle_vertexData3: vec4f;\nattribute particle_vertexData4: f32;\n#ifndef USE_MESH\n	attribute particle_vertexData5: vec2f;\n#else\n	attribute particle_vertexData5: vec4f;\n#endif\nuniform matrix_viewProjection: mat4x4f;\nuniform matrix_model: mat4x4f;\n#ifndef VIEWMATRIX\n	#define VIEWMATRIX\n	uniform matrix_view: mat4x4f;\n#endif\nuniform matrix_normal: mat3x3f;\nuniform matrix_viewInverse: mat4x4f;\nuniform numParticles: f32;\nuniform lifetime: f32;\nuniform stretch: f32;\nuniform seed: f32;\nuniform wrapBounds: vec3f;\nuniform emitterScale: vec3f;\nuniform faceTangent: vec3f;\nuniform faceBinorm: vec3f;\n#ifdef PARTICLE_GPU\n	var internalTex0: texture_2d<f32>;\n	var internalTex0Sampler: sampler;\n	var internalTex1: texture_2d<f32>;\n	var internalTex1Sampler: sampler;\n	var internalTex2: texture_2d<f32>;\n	var internalTex2Sampler: sampler;\n#endif\nuniform emitterPos: vec3f;\nvarying texCoordsAlphaLife: vec4f;\nstruct RotateResult {\n	rotatedVec: vec2f,\n	matrix: mat2x2f\n}\nfn rotateWithMatrix(quadXY: vec2f, pRotation: f32) -> RotateResult {\n	let c = cos(pRotation);\n	let s = sin(pRotation);\n	let m = mat2x2f(vec2f(c, -s), vec2f(s, c));\n	return RotateResult(m * quadXY, m);\n}\nfn billboard(InstanceCoords: vec3f, quadXY: vec2f) -> vec3f {\n	let pos = -uniform.matrix_viewInverse[0].xyz * quadXY.x + -uniform.matrix_viewInverse[1].xyz * quadXY.y;\n	return pos;\n}\nfn customFace(InstanceCoords: vec3f, quadXY: vec2f) -> vec3f {\n	let pos = uniform.faceTangent * quadXY.x + uniform.faceBinorm * quadXY.y;\n	return pos;\n}\nfn safeNormalize(v: vec2f) -> vec2f {\n	let l = length(v);\n	return select(v, v / l, l > 1e-06);\n}\n@vertex\nfn vertexMain(input: VertexInput) -> VertexOutput {\n	var output: VertexOutput;\n	var particlePos = input.particle_vertexData.xyz;\n	let inPos = particlePos;\n	let vertPos = input.particle_vertexData3.xyz;\n	var inVel = vec3f(input.particle_vertexData2.w, input.particle_vertexData3.w, input.particle_vertexData5.x);\n	let id = floor(input.particle_vertexData4);\n	let rndFactor = fract(sin(id + 1.0 + uniform.seed));\n	let rndFactor3 = vec3f(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n	#ifdef LOCAL_SPACE\n		let modelRotation = mat3x3f(uniform.matrix_model[0].xyz, uniform.matrix_model[1].xyz, uniform.matrix_model[2].xyz);\n		inVel = modelRotation * inVel;\n	#endif\n	let velocityV = safeNormalize((mat3x3f(uniform.matrix_view[0].xyz, uniform.matrix_view[1].xyz, uniform.matrix_view[2].xyz) * inVel).xy);\n	let quadXY = vertPos.xy;\n	#ifdef USE_MESH\n		output.texCoordsAlphaLife = vec4f(input.particle_vertexData5.zw, input.particle_vertexData2.z, input.particle_vertexData.w);\n	#else\n		output.texCoordsAlphaLife = vec4f(quadXY * -0.5 + 0.5, input.particle_vertexData2.z, input.particle_vertexData.w);\n	#endif\n	var rotMatrix: mat2x2f;\n	var inAngle = input.particle_vertexData2.x;\n	var particlePosMoved = vec3f(0.0);\n	let meshLocalPos = input.particle_vertexData3.xyz;\n",particle_cpu_endVS:"\n	localPos = localPos * input.particle_vertexData2.y * uniform.emitterScale;\n	localPos = localPos + particlePos;\n	output.position = uniform.matrix_viewProjection * vec4f(localPos, 1.0);\n",particle_customFaceVS:"\n	let rotationResult = rotateWithMatrix(quadXY, inAngle);\n	let rotatedQuadXY = rotationResult.rotatedVec;\n	rotMatrix = rotationResult.matrix;\n	var localPos = customFace(particlePos, rotatedQuadXY);\n",particle_endPS:"\n	rgb = addFog(rgb);\n	rgb = toneMap(rgb);\n	rgb = gammaCorrectOutput(rgb);\n	output.color = vec4f(rgb, a);\n	return output;\n}\n",particle_endVS:"\n	localPos = localPos * scale * uniform.emitterScale;\n	localPos = localPos + particlePos;\n	#ifdef SCREEN_SPACE\n		output.position = vec4f(localPos.x, localPos.y, 0.0, 1.0);\n	#else\n		output.position = uniform.matrix_viewProjection * vec4f(localPos.xyz, 1.0);\n	#endif\n",particle_halflambertPS:"\n	var negNormal: vec3f = normal * 0.5 + 0.5;\n	var posNormal: vec3f = -normal * 0.5 + 0.5;\n	negNormal = negNormal * negNormal;\n	posNormal = posNormal * posNormal;\n",particle_initVS:"\nattribute particle_vertexData: vec4f;\n#if defined(USE_MESH)\n	#if defined(USE_MESH_UV)\n		attribute particle_uv: vec2f;\n	#else\n		var<private> particle_uv: vec2f = vec2f(0.0, 0.0);\n	#endif\n#endif\nuniform matrix_viewProjection: mat4x4f;\nuniform matrix_model: mat4x4f;\nuniform matrix_normal: mat3x3f;\nuniform matrix_viewInverse: mat4x4f;\n#ifndef VIEWMATRIX\n	#define VIEWMATRIX\n	uniform matrix_view: mat4x4f;\n#endif\nuniform numParticles: f32;\nuniform numParticlesPot: f32;\nuniform graphSampleSize: f32;\nuniform graphNumSamples: f32;\nuniform stretch: f32;\nuniform wrapBounds: vec3f;\nuniform emitterScale: vec3f;\nuniform emitterPos: vec3f;\nuniform faceTangent: vec3f;\nuniform faceBinorm: vec3f;\nuniform rate: f32;\nuniform rateDiv: f32;\nuniform lifetime: f32;\nuniform deltaRandomnessStatic: f32;\nuniform scaleDivMult: f32;\nuniform alphaDivMult: f32;\nuniform seed: f32;\nuniform delta: f32;\nvar particleTexOUT: texture_2d<f32>;\nvar particleTexOUTSampler: sampler;\nvar particleTexIN: texture_2d<f32>;\nvar particleTexINSampler: sampler;\n#ifdef PARTICLE_GPU\n	var internalTex0: texture_2d<f32>;\n	var internalTex0Sampler: sampler;\n	var internalTex1: texture_2d<f32>;\n	var internalTex1Sampler: sampler;\n	var internalTex2: texture_2d<f32>;\n	var internalTex2Sampler: sampler;\n#endif\n#ifndef CAMERAPLANES\n	#define CAMERAPLANES\n	uniform camera_params: vec4f;\n#endif\nvarying texCoordsAlphaLife: vec4f;\nvar<private> inPos: vec3f;\nvar<private> inVel: vec3f;\nvar<private> inAngle: f32;\nvar<private> inShow: bool;\nvar<private> inLife: f32;\n",particle_lambertPS:"\n	var negNormal: vec3f = max(normal, vec3(0.0));\n	var posNormal: vec3f = max(-normal, vec3(0.0));\n",particle_lightingPS:"\n	let light: vec3f = negNormal.x * uniform.lightCube[0] + posNormal.x * uniform.lightCube[1] +\n					   negNormal.y * uniform.lightCube[2] + posNormal.y * uniform.lightCube[3] +\n					   negNormal.z * uniform.lightCube[4] + posNormal.z * uniform.lightCube[5];\n	rgb = rgb * light;\n",particle_localShiftVS:"\nparticlePos = (uniform.matrix_model * vec4f(particlePos, 1.0)).xyz;\n",particle_meshVS:"\nvar localPos = meshLocalPos;\nlet rotResultXY = rotateWithMatrix(localPos.xy, inAngle);\nlocalPos = vec3f(rotResultXY.rotatedVec, localPos.z);\nrotMatrix = rotResultXY.matrix;\nlet rotResultYZ = rotateWithMatrix(localPos.yz, inAngle);\nlocalPos = vec3f(localPos.x, rotResultYZ.rotatedVec);\nrotMatrix = rotResultYZ.matrix;\nbillboard(particlePos, quadXY);\n",particle_normalVS:"\noutput.Normal = normalize(localPos + uniform.matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\n	let sampledNormal: vec4f = textureSample(normalMap, normalMapSampler, vec2f(input.texCoordsAlphaLife.x, 1.0 - input.texCoordsAlphaLife.y));\n	let normalMap: vec3f = normalize(sampledNormal.xyz * 2.0 - 1.0);\n	let ParticleMat = mat3x3<f32>(ParticleMat0, ParticleMat1, ParticleMat2);\n	let normal: vec3f = ParticleMat * normalMap;\n",particle_pointAlongVS:"\n	inAngle = atan2(velocityV.x, velocityV.y);\n",particle_simulationPS:'\n	#include "particleUpdaterInitPS"\n	#ifdef PACK8\n		#include "particleInputRgba8PS"\n		#include "particleOutputRgba8PS"\n	#else\n		#include "particleInputFloatPS"\n		#include "particleOutputFloatPS"\n	#endif\n	#ifdef EMITTERSHAPE_BOX\n		#include "particleUpdaterAABBPS"\n	#else\n		#include "particleUpdaterSpherePS"\n	#endif\n	#include "particleUpdaterStartPS"\n	#ifdef RESPAWN\n		#include "particleUpdaterRespawnPS"\n	#endif\n	#ifdef NO_RESPAWN\n		#include "particleUpdaterNoRespawnPS"\n	#endif\n	#ifdef ON_STOP\n		#include "particleUpdaterOnStopPS"\n	#endif\n	#include "particleUpdaterEndPS"\n',particle_shaderPS:'\n	#if NORMAL != NONE\n		#if NORMAL == VERTEX\n			varying Normal: vec3f;\n		#endif\n		#if NORMAL == MAP\n			varying ParticleMat0: vec3f;\n			varying ParticleMat1: vec3f;\n			varying ParticleMat2: vec3f;\n		#endif\n		uniform lightCube: array<vec3f, 6>;\n	#endif\n	#ifdef SOFT\n		varying vDepth: f32;\n		#include "screenDepthPS"\n	#endif\n	#include "gammaPS"\n	#include "tonemappingPS"\n	#include "fogPS"\n	#if NORMAL == MAP\n		var normalMap: texture_2d<f32>;\n		var normalMapSampler: sampler;\n	#endif\n	#include "particlePS"\n	#ifdef SOFT\n		#include "particle_softPS"\n	#endif\n	#if NORMAL == VERTEX\n		var normal: vec3f = Normal;\n	#endif\n	#if NORMAL == MAP\n		#include "particle_normalMapPS"\n	#endif\n	#if NORMAL != NONE\n		#ifdef HALF_LAMBERT\n			#include "particle_halflambertPS"\n		#else\n			#include "particle_lambertPS"\n		#endif\n		#include "particle_lightingPS"\n	#endif\n	#if BLEND == NORMAL\n		#include "particle_blendNormalPS"\n	#elif BLEND == ADDITIVE\n		#include "particle_blendAddPS"\n	#elif BLEND == MULTIPLICATIVE\n		#include "particle_blendMultiplyPS"\n	#endif\n	#include "particle_endPS"\n',particle_shaderVS:'\n	#ifdef ANIMTEX\n		uniform animTexTilesParams: vec2f;\n		uniform animTexParams: vec4f;\n		uniform animTexIndexParams: vec2f;\n	#endif\n	#if NORMAL == MAP\n		varying ParticleMat0: vec3f;\n		varying ParticleMat1: vec3f;\n		varying ParticleMat2: vec3f;\n	#endif\n	#if NORMAL == VERTEX\n		varying Normal: vec3f;\n	#endif\n	#ifdef SOFT\n		varying vDepth: f32;\n	#endif\n	#ifdef PARTICLE_GPU\n		#include "particle_initVS"\n		#ifdef PACK8\n			#include "particleInputRgba8PS"\n		#else\n			#include  "particleInputFloatPS"\n		#endif\n		#ifdef SOFT\n			#include "screenDepthPS"\n		#endif\n		#include "particleVS"\n	#else\n		#ifdef SOFT\n			#include "screenDepthPS"\n		#endif\n		#include "particle_cpuVS"\n	#endif\n	#ifdef LOCAL_SPACE\n		#include "particle_localShiftVS"\n	#endif\n	#ifdef ANIMTEX\n		#ifdef ANIMTEX_LOOP\n			#include "particleAnimFrameLoopVS"\n		#else\n			#include "particleAnimFrameClampVS"\n		#endif\n		#include "particleAnimTexVS"\n	#endif\n	#ifdef PARTICLE_GPU\n		#ifdef WRAP\n			#include "particle_wrapVS"\n		#endif\n	#endif\n	#ifdef ALIGN_TO_MOTION\n		#include "particle_pointAlongVS"\n	#endif\n	#ifdef USE_MESH\n		#include "particle_meshVS"\n	#else\n		#ifdef CUSTOM_FACE\n			#include "particle_customFaceVS"\n		#else\n			#include "particle_billboardVS"\n		#endif\n	#endif\n	#if NORMAL == VERTEX\n		#include "particle_normalVS"\n	#endif\n	#if NORMAL == MAP\n		#include "particle_TBNVS"\n	#endif\n	#ifdef STRETCH\n		#include "particle_stretchVS"\n	#endif\n	#ifdef PARTICLE_GPU\n		#include "particle_endVS"\n	#else\n		#include "particle_cpu_endVS"\n	#endif\n	#ifdef SOFT\n		#include "particle_softVS"\n	#endif\n	return output;\n}\n',particle_softPS:"\n	var depth: f32 = getLinearScreenDepthFrag();\n	var particleDepth: f32 = vDepth;\n	var depthDiff: f32 = saturate(abs(particleDepth - depth) * uniform.softening);\n	a = a * depthDiff;\n",particle_softVS:"\n	output.vDepth = getLinearDepth(localPos);\n",particle_stretchVS:"\n	let moveDir: vec3f = inVel * uniform.stretch;\n	var posPrev: vec3f = particlePos - moveDir;\n	posPrev = posPrev + particlePosMoved;\n	let viewRotationTemp: mat3x3f = mat3x3f(uniform.matrix_view[0].xyz, uniform.matrix_view[1].xyz, uniform.matrix_view[2].xyz);\n	let centerToVertexV: vec2f = normalize((viewRotationTemp * localPos).xy);\n	let interpolation: f32 = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n	particlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\n	let rot3 = mat3x3f(\n		vec3f(rotMatrix[0][0], rotMatrix[1][0], 0.0),\n		vec3f(rotMatrix[0][1], rotMatrix[1][1], 0.0),\n		vec3f(0.0, 0.0, 1.0)\n	);\n	let viewBasis = mat3x3f(\n		-uniform.matrix_viewInverse[0].xyz,\n		-uniform.matrix_viewInverse[1].xyz,\n		uniform.matrix_viewInverse[2].xyz\n	);\n	let tempMat = viewBasis * rot3;\n	output.ParticleMat0 = tempMat[0];\n	output.ParticleMat1 = tempMat[1];\n	output.ParticleMat2 = tempMat[2];\n",particle_wrapVS:"\n	let origParticlePos: vec3f = particlePos;\n	particlePos = particlePos - uniform.matrix_model[3].xyz;\n	particlePos = (particlePos % uniform.wrapBounds) - uniform.wrapBounds * 0.5;\n	particlePos = particlePos + uniform.matrix_model[3].xyz;\n	particlePosMoved = particlePos - origParticlePos;\n"};function yg(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function yy(e,t){return (yy=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var yS=["enabled","autoPlay","numParticles","lifetime","rate","rate2","startAngle","startAngle2","loop","preWarm","lighting","halfLambert","intensity","depthWrite","noFog","depthSoftening","sort","blendType","stretch","alignToMotion","emitterShape","emitterExtents","emitterExtentsInner","emitterRadius","emitterRadiusInner","initialVelocity","wrap","wrapBounds","localSpace","screenSpace","colorMapAsset","normalMapAsset","mesh","meshAsset","renderAsset","orientation","particleNormal","localVelocityGraph","localVelocityGraph2","velocityGraph","velocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2","scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","colorMap","normalMap","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animSpeed","animLoop","layers"],yx=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).id="particlesystem",n.ComponentType=yp,n.DataType=ym,n.schema=yS,n.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},n.on("beforeremove",n.onBeforeRemove,n),n.app.systems.on("update",n.onUpdate,n),o0.get(t.graphicsDevice,nn).add(y_),o0.get(t.graphicsDevice,ni).add(yv),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&yy(t,e);var n=t.prototype;return n.initializeComponentData=function(t,n,i){var r={};i=[];var s=this.propertyTypes;for(var a in (yg(n.mesh,pZ)||"number"==typeof n.mesh)&&(n.meshAsset=n.mesh,delete n.mesh),n){if(n.hasOwnProperty(a)&&(i.push(a),r[a]=n[a]),"vec3"===s[a])Array.isArray(r[a])&&(r[a]=new eW(r[a][0],r[a][1],r[a][2]));else if("curve"===s[a]){if(!yg(r[a],eB)){var o=r[a].type;r[a]=new eB(r[a].keys),r[a].type=o;}}else if("curveset"===s[a]&&!yg(r[a],eU)){var l=r[a].type;r[a]=new eU(r[a].keys),r[a].type=l;}r.layers&&Array.isArray(r.layers)&&(r.layers=r.layers.slice(0));}e.prototype.initializeComponentData.call(this,t,r,i);},n.cloneComponent=function(e,t){for(var n=e.particlesystem.data,i=this.schema,r={},s=0,a=i.length;s<a;s++){var o=i[s],l=n[o];yg(l,eW)||yg(l,eB)||yg(l,eU)?(l=l.clone(),r[o]=l):"layers"===o?r.layers=n.layers.slice(0):null!=l&&(r[o]=l);}return this.addComponent(t,r)},n.onUpdate=function(e){for(var t=this.store,n=this.app.stats.particles,i=this.app.scene.layers,r=0;r<i.layerList.length;r++)i.layerList[r].requiresLightCube=false;for(var s in t)if(t.hasOwnProperty(s)){var a=t[s],o=a.entity,l=a.data;if(l.enabled&&o.enabled){var u=o.particlesystem.emitter;if(!(null==u?void 0:u.meshInstance.visible))continue;if(u.lighting)for(var c=l.layers,h=0;h<c.length;h++){var f=i.getLayerById(c[h]);f&&(f.requiresLightCube=true);}if(!l.paused){var d=0;if(u.simTime+=e,u.simTime>=u.fixedTimeStep&&(d=Math.floor(u.simTime/u.fixedTimeStep),u.simTime-=d*u.fixedTimeStep),d){d=Math.min(d,u.maxSubSteps);for(var p=0;p<d;p++)u.addTime(u.fixedTimeStep,false);n._updatesPerFrame+=d,n._frameTime+=u._addTimeTime,u._addTimeTime=0;}u.finishFrame();}}}},n.onBeforeRemove=function(e,t){t.onBeforeRemove();},n.destroy=function(){e.prototype.destroy.call(this),this.app.systems.off("update",this.onUpdate,this);},t}(mZ);function yb(e,t){return (yb=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var yT=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this)||this).skin=t,i.skinInstance=n,i}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&yb(t,e),t}(iF),yE=function(){function e(){}return e.createCachedSkinInstance=function(t,n,i){var r=e.getCachedSkinInstance(t,n);return r||((r=new lu(t)).resolve(n,i),e.addCachedSkinInstance(t,n,r)),r},e.getCachedSkinInstance=function(t,n){var i=null,r=e._skinInstanceCache.get(n);if(r){var s=r.find(function(e){return e.skin===t});s&&(s.incRefCount(),i=s.skinInstance);}return i},e.addCachedSkinInstance=function(t,n,i){var r=e._skinInstanceCache.get(n);r||(r=[],e._skinInstanceCache.set(n,r));var s=r.find(function(e){return e.skin===t});s||(s=new yT(t,i),r.push(s)),s.incRefCount();},e.removeCachedSkinInstance=function(t){if(t){var n=t.rootBone;if(n){var i=e._skinInstanceCache.get(n);if(i){var r=i.findIndex(function(e){return e.skinInstance===t});if(r>=0){var s=i[r];s.decRefCount(),0===s.refCount&&(i.splice(r,1),i.length||e._skinInstanceCache.delete(n),t&&(t.destroy(),s.skinInstance=null));}}}}},e}();yE._skinInstanceCache=new Map;var yw=function(){function e(e,t,n,i,r){this._evtLoadById=null,this._evtUnloadById=null,this._evtAddById=null,this._evtRemoveById=null,this._evtLoadByUrl=null,this._evtAddByUrl=null,this._evtRemoveByUrl=null,this.propertyName=e,this.parent=t,this._scope=r,this._registry=n,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=i.load,this._onAssetAdd=i.add,this._onAssetRemove=i.remove,this._onAssetUnload=i.unload;}var t,n=e.prototype;return n._bind=function(){this.id&&(this._onAssetLoad&&(this._evtLoadById=this._registry.on("load:"+this.id,this._onLoad,this)),this._onAssetAdd&&(this._evtAddById=this._registry.once("add:"+this.id,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveById=this._registry.on("remove:"+this.id,this._onRemove,this)),this._onAssetUnload&&(this._evtUnloadById=this._registry.on("unload:"+this.id,this._onUnload,this))),this.url&&(this._onAssetLoad&&(this._evtLoadByUrl=this._registry.on("load:url:"+this.url,this._onLoad,this)),this._onAssetAdd&&(this._evtAddByUrl=this._registry.once("add:url:"+this.url,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveByUrl=this._registry.on("remove:url:"+this.url,this._onRemove,this)));},n._unbind=function(){var e,t,n,i,r,s,a;this.id&&(null==(e=this._evtLoadById)||e.off(),this._evtLoadById=null,null==(t=this._evtAddById)||t.off(),this._evtAddById=null,null==(n=this._evtRemoveById)||n.off(),this._evtRemoveById=null,null==(i=this._evtUnloadById)||i.off(),this._evtUnloadById=null),this.url&&(null==(r=this._evtLoadByUrl)||r.off(),this._evtLoadByUrl=null,null==(s=this._evtAddByUrl)||s.off(),this._evtAddByUrl=null,null==(a=this._evtRemoveByUrl)||a.off(),this._evtRemoveByUrl=null);},n._onLoad=function(e){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,e);},n._onAdd=function(e){this.asset=e,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,e);},n._onRemove=function(e){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,e),this.asset=null;},n._onUnload=function(e){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,e);},t=[{key:"id",get:function(){return this._id},set:function(e){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=e,this.asset=this._registry.get(this._id),this._bind();}},{key:"url",get:function(){return this._url},set:function(e){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=e,this.asset=this._registry.getByUrl(this._url),this._bind();}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function yA(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function yC(e,t){return (yC=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var yP=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n)||this)._type="asset",i._castShadows=true,i._receiveShadows=true,i._castShadowsLightmap=true,i._lightmapped=false,i._lightmapSizeMultiplier=1,i.isStatic=false,i._batchGroupId=-1,i._layers=[0],i._renderStyle=0,i._meshInstances=[],i._customAabb=null,i._area=null,i._materialReferences=[],i._rootBone=null,i._evtLayersChanged=null,i._evtLayerAdded=null,i._evtLayerRemoved=null,i._evtSetMeshes=null,i._assetReference=new yw("asset",i,t.app.assets,{add:i._onRenderAssetAdded,load:i._onRenderAssetLoad,remove:i._onRenderAssetRemove,unload:i._onRenderAssetUnload},i),i._material=t.defaultMaterial,n.on("remove",i.onRemoveChild,i),n.on("removehierarchy",i.onRemoveChild,i),n.on("insert",i.onInsertChild,i),n.on("inserthierarchy",i.onInsertChild,i),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&yC(t,e);var n,i=t.prototype;return i.assignAsset=function(e){var t=yA(e,pZ)?e.id:e;this._assetReference.id=t;},i.destroyMeshInstances=function(){var e=this._meshInstances;if(e){this.removeFromLayers(),this._clearSkinInstances();for(var t=0;t<e.length;t++)e[t].destroy();this._meshInstances.length=0;}},i.addToLayers=function(){for(var e=this.system.app.scene.layers,t=0;t<this._layers.length;t++){var n=e.getLayerById(this._layers[t]);n&&n.addMeshInstances(this._meshInstances);}},i.removeFromLayers=function(){if(this._meshInstances&&this._meshInstances.length)for(var e=this.system.app.scene.layers,t=0;t<this._layers.length;t++){var n=e.getLayerById(this._layers[t]);n&&n.removeMeshInstances(this._meshInstances);}},i.onRemoveChild=function(){this.removeFromLayers();},i.onInsertChild=function(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers();},i.onRemove=function(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this._assetReference.id=null;for(var e=0;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this);},i.onLayersChanged=function(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);},i.onLayerAdded=function(e){0>this.layers.indexOf(e.id)||e.addMeshInstances(this._meshInstances);},i.onLayerRemoved=function(e){0>this.layers.indexOf(e.id)||e.removeMeshInstances(this._meshInstances);},i.onEnable=function(){var e,t=this.system.app,n=t.scene,i=n.layers;this._rootBone&&this._cloneSkinInstances(),this._evtLayersChanged=n.on("set:layers",this.onLayersChanged,this),i&&(this._evtLayerAdded=i.on("add",this.onLayerAdded,this),this._evtLayerRemoved=i.on("remove",this.onLayerRemoved,this));var r="asset"===this._type;this._meshInstances&&this._meshInstances.length?this.addToLayers():r&&this.asset&&this._onRenderAssetAdded();for(var s=0;s<this._materialReferences.length;s++)this._materialReferences[s].asset&&this.system.app.assets.load(this._materialReferences[s].asset);this._batchGroupId>=0&&(null==(e=t.batcher)||e.insert(lo.RENDER,this.batchGroupId,this.entity));},i.onDisable=function(){var e,t,n,i,r=this.system.app,s=r.scene.layers;null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,this._rootBone&&this._clearSkinInstances(),s&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(n=this._evtLayerRemoved)||n.off(),this._evtLayerRemoved=null),this._batchGroupId>=0&&(null==(i=r.batcher)||i.remove(lo.RENDER,this.batchGroupId,this.entity)),this.removeFromLayers();},i.hide=function(){if(this._meshInstances)for(var e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=false;},i.show=function(){if(this._meshInstances)for(var e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=true;},i._onRenderAssetAdded=function(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset));},i._onRenderAssetLoad=function(){if(this.destroyMeshInstances(),this._assetReference.asset){var e,t=this._assetReference.asset.resource;null==(e=this._evtSetMeshes)||e.off(),this._evtSetMeshes=t.on("set:meshes",this._onSetMeshes,this),t.meshes&&this._onSetMeshes(t.meshes);}},i._onSetMeshes=function(e){this._cloneMeshes(e);},i._clearSkinInstances=function(){for(var e=0;e<this._meshInstances.length;e++){var t=this._meshInstances[e];yE.removeCachedSkinInstance(t.skinInstance),t.skinInstance=null;}},i._cloneSkinInstances=function(){if(this._meshInstances.length&&yA(this._rootBone,us))for(var e=0;e<this._meshInstances.length;e++){var t=this._meshInstances[e],n=t.mesh;n.skin&&!t.skinInstance&&(t.skinInstance=yE.createCachedSkinInstance(n.skin,this._rootBone,this.entity));}},i._cloneMeshes=function(e){if(e&&e.length){for(var t=[],n=0;n<e.length;n++){var i=e[n],r=new lL(i,this._materialReferences[n]&&this._materialReferences[n].asset&&this._materialReferences[n].asset.resource||this.system.defaultMaterial,this.entity);t.push(r),i.morph&&(r.morphInstance=new c7(i.morph));}this.meshInstances=t,this._cloneSkinInstances();}},i._onRenderAssetUnload=function(){"asset"===this._type&&this.destroyMeshInstances();},i._onRenderAssetRemove=function(){var e;null==(e=this._evtSetMeshes)||e.off(),this._evtSetMeshes=null,this._onRenderAssetUnload();},i._onMaterialAdded=function(e,t,n){n.resource?this._onMaterialLoad(e,t,n):this.enabled&&this.entity.enabled&&this.system.app.assets.load(n);},i._updateMainMaterial=function(e,t){0===e&&(this.material=t);},i._onMaterialLoad=function(e,t,n){this._meshInstances[e]&&(this._meshInstances[e].material=n.resource),this._updateMainMaterial(e,n.resource);},i._onMaterialRemove=function(e,t,n){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial);},i._onMaterialUnload=function(e,t,n){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial);},i.resolveDuplicatedEntityReferenceProperties=function(e,t){e.rootBone&&(this.rootBone=t[e.rootBone.getGuid()]);},n=[{key:"renderStyle",get:function(){return this._renderStyle},set:function(e){this._renderStyle!==e&&(this._renderStyle=e,lL._prepareRenderStyleForArray(this._meshInstances,e));}},{key:"customAabb",get:function(){return this._customAabb},set:function(e){this._customAabb=e;var t=this._meshInstances;if(t)for(var n=0;n<t.length;n++)t[n].setCustomAabb(this._customAabb);}},{key:"type",get:function(){return this._type},set:function(e){if(this._type!==e&&(this._area=null,this._type=e,this.destroyMeshInstances(),"asset"!==e)){var t=this._material;t&&t!==this.system.defaultMaterial||(t=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);var n=ye(this.system.app.graphicsDevice,e);this._area=n.area,this.meshInstances=[new lL(n.mesh,t||this.system.defaultMaterial,this.entity)];}}},{key:"meshInstances",get:function(){return this._meshInstances},set:function(e){if(this.destroyMeshInstances(),this._meshInstances=e,this._meshInstances){for(var t=this._meshInstances,n=0;n<t.length;n++)t[n].node||(t[n].node=this.entity),t[n].castShadow=this._castShadows,t[n].receiveShadow=this._receiveShadows,t[n].renderStyle=this._renderStyle,t[n].setLightmapped(this._lightmapped),t[n].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers();}}},{key:"lightmapped",get:function(){return this._lightmapped},set:function(e){if(e!==this._lightmapped){this._lightmapped=e;var t=this._meshInstances;if(t)for(var n=0;n<t.length;n++)t[n].setLightmapped(e);}}},{key:"castShadows",get:function(){return this._castShadows},set:function(e){if(this._castShadows!==e){var t=this._meshInstances;if(t){var n=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(var r=0;r<n.length;r++){var s=i.layers.getLayerById(this.layers[r]);s&&s.removeShadowCasters(t);}for(var a=0;a<t.length;a++)t[a].castShadow=e;if(!this._castShadows&&e)for(var o=0;o<n.length;o++){var l=i.layers.getLayerById(n[o]);l&&l.addShadowCasters(t);}}this._castShadows=e;}}},{key:"receiveShadows",get:function(){return this._receiveShadows},set:function(e){if(this._receiveShadows!==e){this._receiveShadows=e;var t=this._meshInstances;if(t)for(var n=0;n<t.length;n++)t[n].receiveShadow=e;}}},{key:"castShadowsLightmap",get:function(){return this._castShadowsLightmap},set:function(e){this._castShadowsLightmap=e;}},{key:"lightmapSizeMultiplier",get:function(){return this._lightmapSizeMultiplier},set:function(e){this._lightmapSizeMultiplier=e;}},{key:"layers",get:function(){return this._layers},set:function(e){var t,n=this.system.app.scene.layers;if(this._meshInstances)for(var i=0;i<this._layers.length;i++)(t=n.getLayerById(this._layers[i]))&&t.removeMeshInstances(this._meshInstances);this._layers.length=0;for(var r=0;r<e.length;r++)this._layers[r]=e[r];if(this.enabled&&this.entity.enabled&&this._meshInstances)for(var s=0;s<this._layers.length;s++)(t=n.getLayerById(this._layers[s]))&&t.addMeshInstances(this._meshInstances);}},{key:"batchGroupId",get:function(){return this._batchGroupId},set:function(e){if(this._batchGroupId!==e){var t,n;this.entity.enabled&&this._batchGroupId>=0&&(null==(t=this.system.app.batcher)||t.remove(lo.RENDER,this.batchGroupId,this.entity)),this.entity.enabled&&e>=0&&(null==(n=this.system.app.batcher)||n.insert(lo.RENDER,e,this.entity)),e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=e;}}},{key:"material",get:function(){return this._material},set:function(e){if(this._material!==e&&(this._material=e,this._meshInstances&&"asset"!==this._type))for(var t=0;t<this._meshInstances.length;t++)this._meshInstances[t].material=e;}},{key:"materialAssets",get:function(){return this._materialReferences.map(function(e){return e.id})},set:function(e){if(void 0===e&&(e=[]),this._materialReferences.length>e.length){for(var t=e.length;t<this._materialReferences.length;t++)this._materialReferences[t].id=null;this._materialReferences.length=e.length;}for(var n=0;n<e.length;n++)if(this._materialReferences[n]||this._materialReferences.push(new yw(n,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),e[n]){var i=yA(e[n],pZ)?e[n].id:e[n];this._materialReferences[n].id!==i&&(this._materialReferences[n].id=i),this._materialReferences[n].asset&&this._onMaterialAdded(n,this,this._materialReferences[n].asset);}else this._materialReferences[n].id=null,this._meshInstances[n]&&(this._meshInstances[n].material=this.system.defaultMaterial);}},{key:"asset",get:function(){return this._assetReference.id},set:function(e){var t=yA(e,pZ)?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onRenderAssetAdded());}},{key:"rootBone",get:function(){return this._rootBone},set:function(e){if(this._rootBone!==e){var t="string"==typeof e;this._rootBone&&t&&this._rootBone.getGuid()===e||(this._rootBone&&this._clearSkinInstances(),yA(e,us)?this._rootBone=e:t?(this._rootBone=this.system.app.getEntityFromIndex(e)||null,this._rootBone):this._rootBone=null,this._rootBone&&this._cloneSkinInstances());}}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX),yI=function(){this.enabled=true;};function yL(e,t){return (yL=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var yD=["enabled"],yM=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId","rootBone"],yR=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).id="render",n.ComponentType=yP,n.DataType=yI,n.schema=yD,n.defaultMaterial=lg(t.graphicsDevice),n.on("beforeremove",n.onRemove,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&yL(t,e);var n=t.prototype;return n.initializeComponentData=function(t,n,i){(null===n.batchGroupId||void 0===n.batchGroupId)&&(n.batchGroupId=-1),n.layers&&n.layers.length&&(n.layers=n.layers.slice(0));for(var r=0;r<yM.length;r++)n.hasOwnProperty(yM[r])&&(t[yM[r]]=n[yM[r]]);n.aabbCenter&&n.aabbHalfExtents&&(t.customAabb=new e8(new eW(n.aabbCenter),new eW(n.aabbHalfExtents))),e.prototype.initializeComponentData.call(this,t,n,yD);},n.cloneComponent=function(e,t){for(var n={},i=0;i<yM.length;i++)n[yM[i]]=e.render[yM[i]];n.enabled=e.render.enabled,delete n.meshInstances;var r=this.addComponent(t,n),s=e.render.meshInstances,a=s.map(function(e){return e.mesh});r._onSetMeshes(a);for(var o=0;o<s.length;o++)r.meshInstances[o].material=s[o].material;return e.render.customAabb&&(r.customAabb=e.render.customAabb.clone()),r},n.onRemove=function(e,t){t.onRemove();},t}(mZ);mX._buildAccessors(yP.prototype,yD);var yO=function(){function e(e,t){this._pool=[],this._count=0,this._constructor=e,this._resize(t);}var t=e.prototype;return t._resize=function(e){if(e>this._pool.length)for(var t=this._pool.length;t<e;t++)this._pool[t]=new this._constructor;},t.allocate=function(){return this._count>=this._pool.length&&this._resize(2*this._pool.length),this._pool[this._count++]},t.freeAll=function(){this._count=0;},e}();function yk(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function yN(e,t){return (yN=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var yF=new e0,yB=new e0,yU=new eW,yz=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return t=e.apply(this,arguments)||this,t._angularDamping=0,t._angularFactor=new eW(1,1,1),t._angularVelocity=new eW,t._body=null,t._friction=.5,t._group=2,t._linearDamping=0,t._linearFactor=new eW(1,1,1),t._linearVelocity=new eW,t._mask=65533,t._mass=1,t._restitution=0,t._rollingFriction=0,t._simulationEnabled=false,t._type=vC,t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&yN(t,e);var n,i=t.prototype;return i.createBody=function(){var e,t=this.entity;if(t.collision&&(e=t.collision.shape,t.trigger&&(t.trigger.destroy(),delete t.trigger)),e){this._body&&(this.system.removeBody(this._body),this.system.destroyBody(this._body),this._body=null);var n=this._type===vP?this._mass:0;this._getEntityTransform(D);var i=this.system.createBody(n,e,D);if(i.setRestitution(this._restitution),i.setFriction(this._friction),i.setRollingFriction(this._rollingFriction),i.setDamping(this._linearDamping,this._angularDamping),this._type===vP){var r=this._linearFactor;M.setValue(r.x,r.y,r.z),i.setLinearFactor(M);var s=this._angularFactor;M.setValue(s.x,s.y,s.z),i.setAngularFactor(M);}else this._type===vI&&(i.setCollisionFlags(2|i.getCollisionFlags()),i.setActivationState(4));i.entity=t,this.body=i,this.enabled&&t.enabled&&this.enableSimulation();}},i.isActive=function(){return !!this._body&&this._body.isActive()},i.activate=function(){this._body&&this._body.activate();},i.enableSimulation=function(){var e=this.entity;if(e.collision&&e.collision.enabled&&!this._simulationEnabled){var t=this._body;if(t){switch(this.system.addBody(t,this._group,this._mask),this._type){case vP:this.system._dynamic.push(this),t.forceActivationState(1),this.syncEntityToBody();break;case vI:this.system._kinematic.push(this),t.forceActivationState(4);break;case vC:t.forceActivationState(1),this.syncEntityToBody();}"compound"===e.collision.type&&this.system._compounds.push(e.collision),t.activate(),this._simulationEnabled=true;}}},i.disableSimulation=function(){var e=this._body;if(e&&this._simulationEnabled){var t=this.system,n=t._compounds.indexOf(this.entity.collision);n>-1&&t._compounds.splice(n,1),(n=t._dynamic.indexOf(this))>-1&&t._dynamic.splice(n,1),(n=t._kinematic.indexOf(this))>-1&&t._kinematic.splice(n,1),t.removeBody(e),e.forceActivationState(5),this._simulationEnabled=false;}},i.applyForce=function(e,t,n,i,r,s){var a=this._body;a&&(a.activate(),yk(e,eW)?M.setValue(e.x,e.y,e.z):M.setValue(e,t,n),yk(t,eW)?R.setValue(t.x,t.y,t.z):void 0!==i?R.setValue(i,r,s):R.setValue(0,0,0),a.applyForce(M,R));},i.applyTorque=function(e,t,n){var i=this._body;i&&(i.activate(),yk(e,eW)?M.setValue(e.x,e.y,e.z):M.setValue(e,t,n),i.applyTorque(M));},i.applyImpulse=function(e,t,n,i,r,s){var a=this._body;a&&(a.activate(),yk(e,eW)?M.setValue(e.x,e.y,e.z):M.setValue(e,t,n),yk(t,eW)?R.setValue(t.x,t.y,t.z):void 0!==i?R.setValue(i,r,s):R.setValue(0,0,0),a.applyImpulse(M,R));},i.applyTorqueImpulse=function(e,t,n){var i=this._body;i&&(i.activate(),yk(e,eW)?M.setValue(e.x,e.y,e.z):M.setValue(e,t,n),i.applyTorqueImpulse(M));},i.isStatic=function(){return this._type===vC},i.isStaticOrKinematic=function(){return this._type===vC||this._type===vI},i.isKinematic=function(){return this._type===vI},i._getEntityTransform=function(e){var t=this.entity,n=t.collision;if(n){var i=n.getShapePosition(),r=n.getShapeRotation();M.setValue(i.x,i.y,i.z),O.setValue(r.x,r.y,r.z,r.w);}else {var s=t.getPosition(),a=t.getRotation();M.setValue(s.x,s.y,s.z),O.setValue(a.x,a.y,a.z,a.w);}e.setOrigin(M),e.setRotation(O);},i.syncEntityToBody=function(){var e=this._body;if(e){if(this._getEntityTransform(D),e.setWorldTransform(D),this._type===vI){var t=e.getMotionState();t&&t.setWorldTransform(D);}e.activate();}},i._updateDynamic=function(){var e=this._body;if(e.isActive()){var t=e.getMotionState();if(t){var n=this.entity;t.getWorldTransform(D);var i=D.getOrigin(),r=D.getRotation(),s=n.collision;if(s&&s._hasOffset){var a=s.data.linearOffset,o=s.data.angularOffset,l=yB.copy(o).invert(),u=yF.set(r.x(),r.y(),r.z(),r.w()).mul(l);u.transformVector(a,yU),n.setPosition(i.x()-yU.x,i.y()-yU.y,i.z()-yU.z),n.setRotation(u);}else n.setPosition(i.x(),i.y(),i.z()),n.setRotation(r.x(),r.y(),r.z(),r.w());}}},i._updateKinematic=function(){var e=this._body.getMotionState();e&&(this._getEntityTransform(D),e.setWorldTransform(D));},i.teleport=function(e,t,n,i,r,s){yk(e,eW)?this.entity.setPosition(e):this.entity.setPosition(e,t,n),yk(t,e0)?this.entity.setRotation(t):yk(t,eW)?this.entity.setEulerAngles(t):void 0!==i&&this.entity.setEulerAngles(i,r,s),this.syncEntityToBody();},i.onEnable=function(){this._body||this.createBody(),this.enableSimulation();},i.onDisable=function(){this.disableSimulation();},t.onLibraryLoaded=function(){"undefined"!=typeof Ammo&&(D=new Ammo.btTransform,M=new Ammo.btVector3,R=new Ammo.btVector3,O=new Ammo.btQuaternion);},t.onAppDestroy=function(){Ammo.destroy(D),Ammo.destroy(M),Ammo.destroy(R),Ammo.destroy(O),D=null,M=null,R=null,O=null;},n=[{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping!==e&&(this._angularDamping=e,this._body&&this._body.setDamping(this._linearDamping,e));}},{key:"angularFactor",get:function(){return this._angularFactor},set:function(e){!this._angularFactor.equals(e)&&(this._angularFactor.copy(e),this._body&&this._type===vP&&(M.setValue(e.x,e.y,e.z),this._body.setAngularFactor(M)));}},{key:"angularVelocity",get:function(){if(this._body&&this._type===vP){var e=this._body.getAngularVelocity();this._angularVelocity.set(e.x(),e.y(),e.z());}return this._angularVelocity},set:function(e){this._body&&this._type===vP&&(this._body.activate(),M.setValue(e.x,e.y,e.z),this._body.setAngularVelocity(M),this._angularVelocity.copy(e));}},{key:"body",get:function(){return this._body},set:function(e){this._body!==e&&(this._body=e,e&&this._simulationEnabled&&e.activate());}},{key:"friction",get:function(){return this._friction},set:function(e){this._friction!==e&&(this._friction=e,this._body&&this._body.setFriction(e));}},{key:"group",get:function(){return this._group},set:function(e){this._group!==e&&(this._group=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()));}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping!==e&&(this._linearDamping=e,this._body&&this._body.setDamping(e,this._angularDamping));}},{key:"linearFactor",get:function(){return this._linearFactor},set:function(e){!this._linearFactor.equals(e)&&(this._linearFactor.copy(e),this._body&&this._type===vP&&(M.setValue(e.x,e.y,e.z),this._body.setLinearFactor(M)));}},{key:"linearVelocity",get:function(){if(this._body&&this._type===vP){var e=this._body.getLinearVelocity();this._linearVelocity.set(e.x(),e.y(),e.z());}return this._linearVelocity},set:function(e){this._body&&this._type===vP&&(this._body.activate(),M.setValue(e.x,e.y,e.z),this._body.setLinearVelocity(M),this._linearVelocity.copy(e));}},{key:"mask",get:function(){return this._mask},set:function(e){this._mask!==e&&(this._mask=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()));}},{key:"mass",get:function(){return this._mass},set:function(e){if(this._mass!==e&&(this._mass=e,this._body&&this._type===vP)){var t=this.enabled&&this.entity.enabled;t&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(e,M),this._body.setMassProps(e,M),this._body.updateInertiaTensor(),t&&this.enableSimulation();}}},{key:"restitution",get:function(){return this._restitution},set:function(e){this._restitution!==e&&(this._restitution=e,this._body&&this._body.setRestitution(e));}},{key:"rollingFriction",get:function(){return this._rollingFriction},set:function(e){this._rollingFriction!==e&&(this._rollingFriction=e,this._body&&this._body.setRollingFriction(e));}},{key:"type",get:function(){return this._type},set:function(e){if(this._type!==e){switch(this._type=e,this.disableSimulation(),e){case vP:this._group=1,this._mask=65535;break;case vI:this._group=4,this._mask=65535;break;default:this._group=2,this._mask=65533;}this.createBody();}}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX);yz.EVENT_CONTACT="contact",yz.EVENT_COLLISIONSTART="collisionstart",yz.EVENT_COLLISIONEND="collisionend",yz.EVENT_TRIGGERENTER="triggerenter",yz.EVENT_TRIGGERLEAVE="triggerleave",yz.order=-1;var yV=function(){this.enabled=true;};function yG(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function yH(e,t){return (yH=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var yW=function(e,t,n,i){this.entity=e,this.point=t,this.normal=n,this.hitFraction=i;},yj=function(e,t,n){0!=arguments.length?(this.a=e,this.b=t,this.impulse=n.impulse,this.localPointA=n.localPoint,this.localPointB=n.localPointOther,this.pointA=n.point,this.pointB=n.pointOther,this.normal=n.normal):(this.a=null,this.b=null,this.impulse=0,this.localPointA=new eW,this.localPointB=new eW,this.pointA=new eW,this.pointB=new eW,this.normal=new eW);},yX=function(e,t,n,i,r,s){ void 0===e&&(e=new eW),void 0===t&&(t=new eW),void 0===n&&(n=new eW),void 0===i&&(i=new eW),void 0===r&&(r=new eW),void 0===s&&(s=0),this.localPoint=e,this.localPointOther=t,this.point=n,this.pointOther=i,this.normal=r,this.impulse=s;},yY=function(e,t){this.other=e,this.contacts=t;},yq=["enabled"],yK=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).maxSubSteps=10,n.fixedTimeStep=1/60,n.gravity=new eW(0,-9.81,0),n._gravityFloat32=new Float32Array(3),n._dynamic=[],n._kinematic=[],n._triggers=[],n._compounds=[],n.id="rigidbody",n._stats=t.stats.frame,n.ComponentType=yz,n.DataType=yV,n.contactPointPool=null,n.contactResultPool=null,n.singleContactResultPool=null,n.schema=yq,n.collisions={},n.frameCollisions={},n.on("beforeremove",n.onBeforeRemove,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&yH(t,e);var n=t.prototype;return n.onLibraryLoaded=function(){if("undefined"!=typeof Ammo){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){var e=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(e);}k=new Ammo.btVector3,N=new Ammo.btVector3,yz.onLibraryLoaded(),this.contactPointPool=new yO(yX,1),this.contactResultPool=new yO(yY,1),this.singleContactResultPool=new yO(yj,1),this.app.systems.on("update",this.onUpdate,this);}else this.app.systems.off("update",this.onUpdate,this);},n.initializeComponentData=function(t,n,i){for(var r,s=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return yG(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return yG(e,void 0)}}(e))){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"]);!(r=s()).done;){var a=r.value;if(n.hasOwnProperty(a)){var o=n[a];Array.isArray(o)?t[a]=new eW(o[0],o[1],o[2]):t[a]=o;}}e.prototype.initializeComponentData.call(this,t,n,["enabled"]);},n.cloneComponent=function(e,t){var n=e.rigidbody,i={enabled:n.enabled,mass:n.mass,linearDamping:n.linearDamping,angularDamping:n.angularDamping,linearFactor:[n.linearFactor.x,n.linearFactor.y,n.linearFactor.z],angularFactor:[n.angularFactor.x,n.angularFactor.y,n.angularFactor.z],friction:n.friction,rollingFriction:n.rollingFriction,restitution:n.restitution,type:n.type,group:n.group,mask:n.mask};return this.addComponent(t,i)},n.onBeforeRemove=function(e,t){t.enabled&&(t.enabled=false),t.body&&(this.destroyBody(t.body),t.body=null);},n.addBody=function(e,t,n){ void 0!==t&&void 0!==n?this.dynamicsWorld.addRigidBody(e,t,n):this.dynamicsWorld.addRigidBody(e);},n.removeBody=function(e){this.dynamicsWorld.removeRigidBody(e);},n.createBody=function(e,t,n){var i=new Ammo.btVector3(0,0,0);0!==e&&t.calculateLocalInertia(e,i);var r=new Ammo.btDefaultMotionState(n),s=new Ammo.btRigidBodyConstructionInfo(e,r,t,i),a=new Ammo.btRigidBody(s);return Ammo.destroy(s),Ammo.destroy(i),a},n.destroyBody=function(e){var t=e.getMotionState();t&&Ammo.destroy(t),Ammo.destroy(e);},n.raycastFirst=function(e,t,n){if(void 0===n&&(n={}),n.filterTags||n.filterCallback)return n.sort=true,this.raycastAll(e,t,n)[0]||null;var i=null;k.setValue(e.x,e.y,e.z),N.setValue(t.x,t.y,t.z);var r=new Ammo.ClosestRayResultCallback(k,N);if("number"==typeof n.filterCollisionGroup&&r.set_m_collisionFilterGroup(n.filterCollisionGroup),"number"==typeof n.filterCollisionMask&&r.set_m_collisionFilterMask(n.filterCollisionMask),this.dynamicsWorld.rayTest(k,N,r),r.hasHit()){var s=r.get_m_collisionObject(),a=Ammo.castObject(s,Ammo.btRigidBody);if(a){var o=r.get_m_hitPointWorld(),l=r.get_m_hitNormalWorld();i=new yW(a.entity,new eW(o.x(),o.y(),o.z()),new eW(l.x(),l.y(),l.z()),r.get_m_closestHitFraction());}}return Ammo.destroy(r),i},n.raycastAll=function(e,t,n){ void 0===n&&(n={});var i=[];k.setValue(e.x,e.y,e.z),N.setValue(t.x,t.y,t.z);var r=new Ammo.AllHitsRayResultCallback(k,N);if("number"==typeof n.filterCollisionGroup&&r.set_m_collisionFilterGroup(n.filterCollisionGroup),"number"==typeof n.filterCollisionMask&&r.set_m_collisionFilterMask(n.filterCollisionMask),this.dynamicsWorld.rayTest(k,N,r),r.hasHit()){for(var s=r.get_m_collisionObjects(),a=r.get_m_hitPointWorld(),o=r.get_m_hitNormalWorld(),l=r.get_m_hitFractions(),u=s.size(),c=0;c<u;c++){var h=Ammo.castObject(s.at(c),Ammo.btRigidBody);if(h&&h.entity){if(n.filterTags&&!(f=h.entity.tags).has.apply(f,[].concat(n.filterTags))||n.filterCallback&&!n.filterCallback(h.entity))continue;var f,d=a.at(c),p=o.at(c),m=new yW(h.entity,new eW(d.x(),d.y(),d.z()),new eW(p.x(),p.y(),p.z()),l.at(c));i.push(m);}}n.sort&&i.sort(function(e,t){return e.hitFraction-t.hitFraction});}return Ammo.destroy(r),i},n._storeCollision=function(e,t){var n=false,i=e.getGuid();return this.collisions[i]=this.collisions[i]||{others:[],entity:e},0>this.collisions[i].others.indexOf(t)&&(this.collisions[i].others.push(t),n=true),this.frameCollisions[i]=this.frameCollisions[i]||{others:[],entity:e},this.frameCollisions[i].others.push(t),n},n._createContactPointFromAmmo=function(e){var t=e.get_m_localPointA(),n=e.get_m_localPointB(),i=e.getPositionWorldOnA(),r=e.getPositionWorldOnB(),s=e.get_m_normalWorldOnB(),a=this.contactPointPool.allocate();return a.localPoint.set(t.x(),t.y(),t.z()),a.localPointOther.set(n.x(),n.y(),n.z()),a.point.set(i.x(),i.y(),i.z()),a.pointOther.set(r.x(),r.y(),r.z()),a.normal.set(s.x(),s.y(),s.z()),a.impulse=e.getAppliedImpulse(),a},n._createReverseContactPointFromAmmo=function(e){var t=e.get_m_localPointA(),n=e.get_m_localPointB(),i=e.getPositionWorldOnA(),r=e.getPositionWorldOnB(),s=e.get_m_normalWorldOnB(),a=this.contactPointPool.allocate();return a.localPointOther.set(t.x(),t.y(),t.z()),a.localPoint.set(n.x(),n.y(),n.z()),a.pointOther.set(i.x(),i.y(),i.z()),a.point.set(r.x(),r.y(),r.z()),a.normal.set(s.x(),s.y(),s.z()),a.impulse=e.getAppliedImpulse(),a},n._createSingleContactResult=function(e,t,n){var i=this.singleContactResultPool.allocate();return i.a=e,i.b=t,i.localPointA=n.localPoint,i.localPointB=n.localPointOther,i.pointA=n.point,i.pointB=n.pointOther,i.normal=n.normal,i.impulse=n.impulse,i},n._createContactResult=function(e,t){var n=this.contactResultPool.allocate();return n.other=e,n.contacts=t,n},n._cleanOldCollisions=function(){for(var e in this.collisions)if(this.collisions.hasOwnProperty(e)){for(var t=this.frameCollisions[e],n=this.collisions[e],i=n.entity,r=i.collision,s=i.rigidbody,a=n.others,o=a.length;o--;){var l=a[o];(!t||0>t.others.indexOf(l))&&(a.splice(o,1),i.trigger?(r&&r.fire("triggerleave",l),l.rigidbody&&l.rigidbody.fire("triggerleave",i)):!l.trigger&&(s&&s.fire("collisionend",l),r&&r.fire("collisionend",l)));}0===a.length&&delete this.collisions[e];}},n._hasContactEvent=function(e){var t=e.collision;if(t&&(t.hasEvent("collisionstart")||t.hasEvent("collisionend")||t.hasEvent("contact")))return  true;var n=e.rigidbody;return n&&(n.hasEvent("collisionstart")||n.hasEvent("collisionend")||n.hasEvent("contact"))},n._checkForCollisions=function(e,t){var n=Ammo.wrapPointer(e,Ammo.btDynamicsWorld).getDispatcher(),i=n.getNumManifolds();this.frameCollisions={};for(var r=0;r<i;r++){var s=n.getManifoldByIndexInternal(r),a=s.getBody0(),o=s.getBody1(),l=Ammo.castObject(a,Ammo.btRigidBody),u=Ammo.castObject(o,Ammo.btRigidBody),c=l.entity,h=u.entity;if(c&&h){var f=l.getCollisionFlags(),d=u.getCollisionFlags(),p=s.getNumContacts(),m=[],_=[],v=void 0;if(p>0)if(4&f||4&d){var g=c.collision&&(c.collision.hasEvent("triggerenter")||c.collision.hasEvent("triggerleave")),y=h.collision&&(h.collision.hasEvent("triggerenter")||h.collision.hasEvent("triggerleave")),S=c.rigidbody&&(c.rigidbody.hasEvent("triggerenter")||c.rigidbody.hasEvent("triggerleave")),x=h.rigidbody&&(h.rigidbody.hasEvent("triggerenter")||h.rigidbody.hasEvent("triggerleave"));g&&(v=this._storeCollision(c,h))&&!(4&d)&&c.collision.fire("triggerenter",h),y&&(v=this._storeCollision(h,c))&&!(4&f)&&h.collision.fire("triggerenter",c),S&&(v||(v=this._storeCollision(h,c)),v&&c.rigidbody.fire("triggerenter",h)),x&&(v||(v=this._storeCollision(c,h)),v&&h.rigidbody.fire("triggerenter",c));}else {var b=this._hasContactEvent(c),T=this._hasContactEvent(h),E=this.hasEvent("contact");if(E||b||T){for(var w=0;w<p;w++){var A=s.getContactPoint(w),C=this._createContactPointFromAmmo(A);if(b||T){m.push(C);var P=this._createReverseContactPointFromAmmo(A);_.push(P);}if(E){var I=this._createSingleContactResult(c,h,C);this.fire("contact",I);}}if(b){var L=this._createContactResult(h,m);v=this._storeCollision(c,h),c.collision&&(c.collision.fire("contact",L),v&&c.collision.fire("collisionstart",L)),c.rigidbody&&(c.rigidbody.fire("contact",L),v&&c.rigidbody.fire("collisionstart",L));}if(T){var D=this._createContactResult(c,_);v=this._storeCollision(h,c),h.collision&&(h.collision.fire("contact",D),v&&h.collision.fire("collisionstart",D)),h.rigidbody&&(h.rigidbody.fire("contact",D),v&&h.rigidbody.fire("collisionstart",D));}}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll();},n.onUpdate=function(e){this._gravityFloat32[0]=this.gravity.x,this._gravityFloat32[1]=this.gravity.y,this._gravityFloat32[2]=this.gravity.z;var t,n,i=this.dynamicsWorld.getGravity();(i.x()!==this._gravityFloat32[0]||i.y()!==this._gravityFloat32[1]||i.z()!==this._gravityFloat32[2])&&(i.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(i));var r=this._triggers;for(t=0,n=r.length;t<n;t++)r[t].updateTransform();var s=this._compounds;for(t=0,n=s.length;t<n;t++)s[t]._updateCompound();var a=this._kinematic;for(t=0,n=a.length;t<n;t++)a[t]._updateKinematic();this.dynamicsWorld.stepSimulation(e,this.maxSubSteps,this.fixedTimeStep);var o=this._dynamic;for(t=0,n=o.length;t<n;t++)o[t]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),e);},n.destroy=function(){e.prototype.destroy.call(this),this.app.systems.off("update",this.onUpdate,this),"undefined"!=typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),Ammo.destroy(k),Ammo.destroy(N),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null,k=null,N=null,yz.onAppDestroy());},t}(mZ);yK.EVENT_CONTACT="contact",mX._buildAccessors(yz.prototype,yq);var yZ="none",yQ="blend";function yJ(e,t){return (yJ=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var y$=new e$,y0=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n)||this)._resolution=new eX(640,320),i._referenceResolution=new eX(640,320),i._scaleMode=yZ,i.scale=1,i._scaleBlend=.5,i._priority=0,i._screenSpace=false,i.cull=i._screenSpace,i._screenMatrix=new e$,i._elements=new Set,t.app.graphicsDevice.on("resizecanvas",i._onResize,i),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&yJ(t,e);var n,r=t.prototype;return r.syncDrawOrder=function(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this);},r._recurseDrawOrderSync=function(e,t){if(null!=my&&"undefined"!=typeof Symbol&&my[Symbol.hasInstance]?!my[Symbol.hasInstance](e):!i(e,my))return t;if(e.element){var n,r=e.element.drawOrder;e.element.drawOrder=t++,e.element._batchGroupId>=0&&r!==e.element.drawOrder&&(null==(n=this.system.app.batcher)||n.markGroupDirty(e.element._batchGroupId));}e.particlesystem&&(e.particlesystem.drawOrder=t++);for(var s=e.children,a=0;a<s.length;a++)t=this._recurseDrawOrderSync(s[a],t);return t},r._processDrawOrderSync=function(){this._recurseDrawOrderSync(this.entity,1),this.fire("syncdraworder");},r._calcProjectionMatrix=function(){var e=this._resolution.x/this.scale,t=this._resolution.y/this.scale;this._screenMatrix.setOrtho(0,e,-t,0,1,-1),this._screenSpace||(y$.setScale(.5*e,.5*t,1),this._screenMatrix.mul2(y$,this._screenMatrix));},r._updateScale=function(){this.scale=this._calcScale(this._resolution,this.referenceResolution);},r._calcScale=function(e,t){var n=Math.log2((e.x||1)/t.x),i=Math.log2((e.y||1)/t.y);return Math.pow(2,n*(1-this._scaleBlend)+i*this._scaleBlend)},r._onResize=function(e,t){this._screenSpace&&(this._resolution.set(e,t),this.resolution=this._resolution);},r._bindElement=function(e){this._elements.add(e);},r._unbindElement=function(e){this._elements.delete(e);},r.onRemove=function(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this._elements.forEach(function(e){return e._onScreenRemove()}),this._elements.clear(),this.off();},n=[{key:"resolution",get:function(){return this._resolution},set:function(e){var t=this;this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution),this._elements.forEach(function(e){return e._onScreenResize(t._resolution)});}},{key:"referenceResolution",get:function(){return this._scaleMode===yZ?this._resolution:this._referenceResolution},set:function(e){var t=this;this._referenceResolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution),this._elements.forEach(function(e){return e._onScreenResize(t._resolution)});}},{key:"screenSpace",get:function(){return this._screenSpace},set:function(e){this._screenSpace=e,this._screenSpace&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace),this._elements.forEach(function(e){return e._onScreenSpaceChange()});}},{key:"scaleMode",get:function(){return this._scaleMode},set:function(e){e!==yZ&&e!==yQ&&(e=yZ),this._screenSpace||e===yZ||(e=yZ),this._scaleMode=e,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode);}},{key:"scaleBlend",get:function(){return this._scaleBlend},set:function(e){var t=this;this._scaleBlend=e,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend),this._elements.forEach(function(e){return e._onScreenResize(t._resolution)});}},{key:"priority",get:function(){return this._priority},set:function(e){e>255&&(e=255),this._priority!==e&&(this._priority=e,this.syncDrawOrder());}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX),y1=function(){this.enabled=true;};function y2(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function y3(e,t){return (y3=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var y4=["enabled"],y5=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).id="screen",n.ComponentType=y0,n.DataType=y1,n.schema=y4,n.windowResolution=new eX,n._drawOrderSyncQueue=new eb,n.app.graphicsDevice.on("resizecanvas",n._onResize,n),n.app.systems.on("update",n._onUpdate,n),n.on("beforeremove",n.onRemoveComponent,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&y3(t,e);var n=t.prototype;return n.initializeComponentData=function(t,n,i){ void 0!==n.priority&&(t.priority=n.priority),void 0!==n.screenSpace&&(t.screenSpace=n.screenSpace),t.cull=t.screenSpace,void 0!==n.scaleMode&&(t.scaleMode=n.scaleMode),void 0!==n.scaleBlend&&(t.scaleBlend=n.scaleBlend),void 0!==n.resolution&&(y2(n.resolution,eX)?t._resolution.copy(n.resolution):t._resolution.set(n.resolution[0],n.resolution[1]),t.resolution=t._resolution),void 0!==n.referenceResolution&&(y2(n.referenceResolution,eX)?t._referenceResolution.copy(n.referenceResolution):t._referenceResolution.set(n.referenceResolution[0],n.referenceResolution[1]),t.referenceResolution=t._referenceResolution),t.syncDrawOrder(),e.prototype.initializeComponentData.call(this,t,n,y4);},n.destroy=function(){e.prototype.destroy.call(this),this.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.app.systems.off("update",this._onUpdate,this);},n._onUpdate=function(e){var t=this.store;for(var n in t)t[n].entity.screen.update&&t[n].entity.screen.update(e);},n._onResize=function(e,t){this.windowResolution.x=e,this.windowResolution.y=t;},n.cloneComponent=function(e,t){var n=e.screen;return this.addComponent(t,{enabled:n.enabled,screenSpace:n.screenSpace,scaleMode:n.scaleMode,scaleBlend:n.scaleBlend,priority:n.priority,resolution:n.resolution.clone(),referenceResolution:n.referenceResolution.clone()})},n.onRemoveComponent=function(e,t){t.onRemove();},n.processDrawOrderSyncQueue=function(){for(var e=this._drawOrderSyncQueue.list(),t=0;t<e.length;t++){var n=e[t];n.callback.call(n.scope);}this._drawOrderSyncQueue.clear();},n.queueDrawOrderSync=function(e,t,n){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(e)||this._drawOrderSyncQueue.push(e,{callback:t,scope:n});},t}(mZ);function y8(e,t){return (y8=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}mX._buildAccessors(y0.prototype,y4);var y6=new eX,y9=new eW,y7=new tn,Se=new te,St=new eW,Sn=new eW,Si=new e0,Sr={x:"y",y:"x"},Ss=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var r;if(r=e.call(this)||this,!t||(null!=gb&&"undefined"!=typeof Symbol&&gb[Symbol.hasInstance]?!gb[Symbol.hasInstance](t):!i(t,gb)))throw Error("Element was null or not an ElementComponent");if(n&&"x"!==n&&"y"!==n)throw Error("Unrecognized axis: "+n);return r._element=t,r._app=t.system.app,r._axis=n||null,r._enabled=true,r._dragScale=new eW,r._dragStartMousePosition=new eW,r._dragStartHandlePosition=new eW,r._deltaMousePosition=new eW,r._deltaHandlePosition=new eW,r._isDragging=false,r._toggleLifecycleListeners("on"),r}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&y8(t,e);var n,r=t.prototype;return r._toggleLifecycleListeners=function(e){this._element[e]("mousedown",this._onMouseDownOrTouchStart,this),this._element[e]("touchstart",this._onMouseDownOrTouchStart,this),this._element[e]("selectstart",this._onMouseDownOrTouchStart,this);},r._toggleDragListeners=function(e){var t="on"===e;this._hasDragListeners&&t||(this._app.mouse&&(this._element[e]("mousemove",this._onMove,this),this._element[e]("mouseup",this._onMouseUpOrTouchEnd,this)),ef.touch&&(this._element[e]("touchmove",this._onMove,this),this._element[e]("touchend",this._onMouseUpOrTouchEnd,this),this._element[e]("touchcancel",this._onMouseUpOrTouchEnd,this)),this._element[e]("selectmove",this._onMove,this),this._element[e]("selectend",this._onMouseUpOrTouchEnd,this),this._hasDragListeners=t);},r._onMouseDownOrTouchStart=function(e){if(this._element&&!this._isDragging&&this.enabled){this._dragCamera=e.camera,this._calculateDragScale();var t=this._screenToLocal(e);t&&(this._toggleDragListeners("on"),this._isDragging=true,this._dragStartMousePosition.copy(t),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"));}},r._onMouseUpOrTouchEnd=function(){this._isDragging&&(this._isDragging=false,this._toggleDragListeners("off"),this.fire("drag:end"));},r._screenToLocal=function(e){return (e.inputSource?y7.set(e.inputSource.getOrigin(),e.inputSource.getDirection()):(this._determineInputPosition(e),this._chooseRayOriginAndDirection()),St.copy(this._element.entity.forward).mulScalar(-1),Se.setFromPointNormal(this._element.entity.getPosition(),St),Se.intersectsRay(y7,Sn))?(Si.copy(this._element.entity.getRotation()).invert().transformVector(Sn,Sn),Sn.mul(this._dragScale),Sn):null},r._determineInputPosition=function(e){var t=this._app.graphicsDevice.maxPixelRatio;void 0!==e.x&&void 0!==e.y?(y6.x=e.x*t,y6.y=e.y*t):e.changedTouches&&(y6.x=e.changedTouches[0].x*t,y6.y=e.changedTouches[0].y*t);},r._chooseRayOriginAndDirection=function(){this._element.screen&&this._element.screen.screen.screenSpace?(y7.origin.set(y6.x,-y6.y,0),y7.direction.copy(eW.FORWARD)):(y9.copy(this._dragCamera.screenToWorld(y6.x,y6.y,1)),y7.origin.copy(this._dragCamera.entity.getPosition()),y7.direction.copy(y9).sub(y7.origin).normalize());},r._calculateDragScale=function(){var e=this._element.entity.parent,t=this._element.screen&&this._element.screen.screen,n=t&&t.screenSpace,i=n?t.scale:1,r=this._dragScale;for(r.set(i,i,i);e&&(r.mul(e.getLocalScale()),e=e.parent,!n||!e.screen););r.x=1/r.x,r.y=1/r.y,r.z=0;},r._onMove=function(e){var t=this._element,n=this._deltaMousePosition,i=this._deltaHandlePosition,r=this._axis;if(t&&this._isDragging&&this.enabled&&t.enabled&&t.entity.enabled){var s=this._screenToLocal(e);if(s){if(n.sub2(s,this._dragStartMousePosition),i.add2(this._dragStartHandlePosition,n),r){var a=t.entity.getLocalPosition(),o=Sr[r];i[o]=a[o];}t.entity.setLocalPosition(i),this.fire("drag:move",i);}}},r.destroy=function(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off");},n=[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e;}},{key:"isDragging",get:function(){return this._isDragging}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function Sa(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function So(e,t){return (So=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}Ss.EVENT_DRAGSTART="drag:start",Ss.EVENT_DRAGEND="drag:end",Ss.EVENT_DRAGMOVE="drag:move";var Sl=new eX,Su=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n)||this)._viewportEntity=null,i._contentEntity=null,i._horizontalScrollbarEntity=null,i._verticalScrollbarEntity=null,i._evtElementRemove=null,i._evtViewportElementRemove=null,i._evtViewportResize=null,i._evtContentEntityElementAdd=null,i._evtContentElementRemove=null,i._evtContentResize=null,i._evtHorizontalScrollbarAdd=null,i._evtHorizontalScrollbarRemove=null,i._evtHorizontalScrollbarValue=null,i._evtVerticalScrollbarAdd=null,i._evtVerticalScrollbarRemove=null,i._evtVerticalScrollbarValue=null,i._scrollbarUpdateFlags={},i._scrollbarEntities={},i._prevContentSizes={},i._prevContentSizes[0]=null,i._prevContentSizes[1]=null,i._scroll=new eX,i._velocity=new eW,i._dragStartPosition=new eW,i._disabledContentInput=false,i._disabledContentInputEntities=[],i._toggleLifecycleListeners("on"),i._toggleElementListeners("on"),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&So(t,e);var n,i=t.prototype;return i._setValue=function(e,t){var n=this.data,i=n[e];n[e]=t,this.fire("set",e,i,t);},i._toggleLifecycleListeners=function(e){this[e]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[e]("set_vertical",this._onSetVerticalScrollingEnabled,this),this.entity[e]("element:add",this._onElementComponentAdd,this);},i._toggleElementListeners=function(e){this.entity.element&&("on"===e&&this._hasElementListeners||(this.entity.element[e]("resize",this._syncAll,this),this.entity.element[e]("mousewheel",this._onMouseWheel,this),this._hasElementListeners="on"===e));},i._onElementComponentAdd=function(e){this._evtElementRemove=this.entity.element.once("beforeremove",this._onElementComponentRemove,this),this._toggleElementListeners("on");},i._onElementComponentRemove=function(e){var t;null==(t=this._evtElementRemove)||t.off(),this._evtElementRemove=null,this._toggleElementListeners("off");},i._viewportEntitySubscribe=function(){this._evtViewportEntityElementAdd=this._viewportEntity.on("element:add",this._onViewportElementGain,this),this._viewportEntity.element&&this._onViewportElementGain();},i._viewportEntityUnsubscribe=function(){var e,t;null==(e=this._evtViewportEntityElementAdd)||e.off(),this._evtViewportEntityElementAdd=null,(null==(t=this._viewportEntity)?void 0:t.element)&&this._onViewportElementLose();},i._viewportEntityElementSubscribe=function(){var e=this._viewportEntity.element;this._evtViewportElementRemove=e.once("beforeremove",this._onViewportElementLose,this),this._evtViewportResize=e.on("resize",this._syncAll,this);},i._viewportEntityElementUnsubscribe=function(){var e,t;null==(e=this._evtViewportElementRemove)||e.off(),this._evtViewportElementRemove=null,null==(t=this._evtViewportResize)||t.off(),this._evtViewportResize=null;},i._onViewportElementGain=function(){this._viewportEntityElementSubscribe(),this._syncAll();},i._onViewportElementLose=function(){this._viewportEntityElementUnsubscribe();},i._contentEntitySubscribe=function(){this._evtContentEntityElementAdd=this._contentEntity.on("element:add",this._onContentElementGain,this),this._contentEntity.element&&this._onContentElementGain();},i._contentEntityUnsubscribe=function(){var e,t;null==(e=this._evtContentEntityElementAdd)||e.off(),this._evtContentEntityElementAdd=null,(null==(t=this._contentEntity)?void 0:t.element)&&this._onContentElementLose();},i._contentEntityElementSubscribe=function(){var e=this._contentEntity.element;this._evtContentElementRemove=e.once("beforeremove",this._onContentElementLose,this),this._evtContentResize=e.on("resize",this._syncAll,this);},i._contentEntityElementUnsubscribe=function(){var e,t;null==(e=this._evtContentElementRemove)||e.off(),this._evtContentElementRemove=null,null==(t=this._evtContentResize)||t.off(),this._evtContentResize=null;},i._onContentElementGain=function(){this._contentEntityElementSubscribe(),this._destroyDragHelper(),this._contentDragHelper=new Ss(this._contentEntity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._syncAll();},i._onContentElementLose=function(){this._contentEntityElementUnsubscribe(),this._destroyDragHelper();},i._onContentDragStart=function(){this._contentEntity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentEntity.getLocalPosition());},i._onContentDragEnd=function(){this._prevContentDragPosition=null,this._enableContentInput();},i._onContentDragMove=function(e){if(this._contentEntity&&this.enabled&&this.entity.enabled&&(this._wasDragged=true,this._setScrollFromContentPosition(e),this._setVelocityFromContentPositionDelta(e),!this._disabledContentInput)){var t=e.x-this._dragStartPosition.x,n=e.y-this._dragStartPosition.y;(Math.abs(t)>this.dragThreshold||Math.abs(n)>this.dragThreshold)&&this._disableContentInput();}},i._horizontalScrollbarEntitySubscribe=function(){this._evtHorizontalScrollbarAdd=this._horizontalScrollbarEntity.on("scrollbar:add",this._onHorizontalScrollbarGain,this),this._horizontalScrollbarEntity.scrollbar&&this._onHorizontalScrollbarGain();},i._verticalScrollbarEntitySubscribe=function(){this._evtVerticalScrollbarAdd=this._verticalScrollbarEntity.on("scrollbar:add",this._onVerticalScrollbarGain,this),this._verticalScrollbarEntity.scrollbar&&this._onVerticalScrollbarGain();},i._horizontalScrollbarEntityUnsubscribe=function(){var e;null==(e=this._evtHorizontalScrollbarAdd)||e.off(),this._evtHorizontalScrollbarAdd=null,this._horizontalScrollbarEntity.scrollbar&&this._onHorizontalScrollbarLose();},i._verticalScrollbarEntityUnsubscribe=function(){var e;null==(e=this._evtVerticalScrollbarAdd)||e.off(),this._evtVerticalScrollbarAdd=null,this._verticalScrollbarEntity.scrollbar&&this._onVerticalScrollbarLose();},i._onSetHorizontalScrollbarValue=function(e){!this._scrollbarUpdateFlags[0]&&this.enabled&&this.entity.enabled&&this._onSetScroll(e,null);},i._onSetVerticalScrollbarValue=function(e){!this._scrollbarUpdateFlags[1]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,e);},i._onHorizontalScrollbarGain=function(){var e,t=null==(e=this._horizontalScrollbarEntity)?void 0:e.scrollbar;this._evtHorizontalScrollbarRemove=t.on("beforeremove",this._onHorizontalScrollbarLose,this),this._evtHorizontalScrollbarValue=t.on("set:value",this._onSetHorizontalScrollbarValue,this),this._syncScrollbarEnabledState(0),this._syncScrollbarPosition(0);},i._onVerticalScrollbarGain=function(){var e,t=null==(e=this._verticalScrollbarEntity)?void 0:e.scrollbar;this._evtVerticalScrollbarRemove=t.on("beforeremove",this._onVerticalScrollbarLose,this),this._evtVerticalScrollbarValue=t.on("set:value",this._onSetVerticalScrollbarValue,this),this._syncScrollbarEnabledState(1),this._syncScrollbarPosition(1);},i._onHorizontalScrollbarLose=function(){var e,t;null==(e=this._evtHorizontalScrollbarRemove)||e.off(),this._evtHorizontalScrollbarRemove=null,null==(t=this._evtHorizontalScrollbarValue)||t.off(),this._evtHorizontalScrollbarValue=null;},i._onVerticalScrollbarLose=function(){var e,t;null==(e=this._evtVerticalScrollbarRemove)||e.off(),this._evtVerticalScrollbarRemove=null,null==(t=this._evtVerticalScrollbarValue)||t.off(),this._evtVerticalScrollbarValue=null;},i._onSetHorizontalScrollingEnabled=function(){this._syncScrollbarEnabledState(0);},i._onSetVerticalScrollingEnabled=function(){this._syncScrollbarEnabledState(1);},i._onSetScroll=function(e,t,n){ false!==n&&this._velocity.set(0,0,0);var i=this._updateAxis(e,"x",0),r=this._updateAxis(t,"y",1);(i||r)&&this.fire("set:scroll",this._scroll);},i._updateAxis=function(e,t,n){var i=null!==e&&Math.abs(e-this._scroll[t])>1e-5;return (i||this._isDragging()||0===e)&&(this._scroll[t]=this._determineNewScrollValue(e,t,n),this._syncContentPosition(n),this._syncScrollbarPosition(n)),i},i._determineNewScrollValue=function(e,t,n){if(!this._getScrollingEnabled(n))return this._scroll[t];switch(this.scrollMode){case 0:return ek.clamp(e,0,this._getMaxScrollValue(n));case 1:return this._setVelocityFromOvershoot(e,t,n),e;default:return e}},i._syncAll=function(){this._syncContentPosition(0),this._syncContentPosition(1),this._syncScrollbarPosition(0),this._syncScrollbarPosition(1),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1);},i._syncContentPosition=function(e){if(this._contentEntity){var t=this._getAxis(e),n=this._getSign(e),i=this._prevContentSizes[e],r=this._getContentSize(e);if(null!==i&&Math.abs(i-r)>1e-4){var s=this._getMaxOffset(e,i),a=this._getMaxOffset(e,r);0===a?this._scroll[t]=1:this._scroll[t]=ek.clamp(this._scroll[t]*s/a,0,1);}var o=this._scroll[t]*this._getMaxOffset(e),l=this._contentEntity.getLocalPosition();l[t]=o*n,this._contentEntity.setLocalPosition(l),this._prevContentSizes[e]=r;}},i._syncScrollbarPosition=function(e){var t=this._scrollbarEntities[e];if(null==t?void 0:t.scrollbar){var n=this._getAxis(e);this._scrollbarUpdateFlags[e]=true,t.scrollbar.value=this._scroll[n],t.scrollbar.handleSize=this._getScrollbarHandleSize(n,e),this._scrollbarUpdateFlags[e]=false;}},i._syncScrollbarEnabledState=function(e){var t=this._scrollbarEntities[e];if(t){var n=this._getScrollingEnabled(e);switch(this._getScrollbarVisibility(e)){case 0:t.enabled=n;return;case 1:t.enabled=n&&this._contentIsLargerThanViewport(e);return;default:t.enabled=n;}}},i._contentIsLargerThanViewport=function(e){return this._getContentSize(e)>this._getViewportSize(e)},i._contentPositionToScrollValue=function(e){var t=this._getMaxOffset(0),n=this._getMaxOffset(1);return 0===t?Sl.x=0:Sl.x=e.x/t,0===n?Sl.y=0:Sl.y=-(e.y/n),Sl},i._getMaxOffset=function(e,t){t=void 0===t?this._getContentSize(e):t;var n=this._getViewportSize(e);return t<n?-this._getViewportSize(e):n-t},i._getMaxScrollValue=function(e){return +!!this._contentIsLargerThanViewport(e)},i._getScrollbarHandleSize=function(e,t){var n=this._getViewportSize(t),i=this._getContentSize(t);if(.001>Math.abs(i))return 1;var r=Math.min(n/i,1),s=this._toOvershoot(this._scroll[e],t);return 0===s?r:r/(1+Math.abs(s))},i._getViewportSize=function(e){return this._getSize(e,this._viewportEntity)},i._getContentSize=function(e){return this._getSize(e,this._contentEntity)},i._getSize=function(e,t){return (null==t?void 0:t.element)?t.element[this._getCalculatedDimension(e)]:0},i._getScrollingEnabled=function(e){return 0===e?this.horizontal:1===e?this.vertical:void 0},i._getScrollbarVisibility=function(e){return 0===e?this.horizontalScrollbarVisibility:1===e?this.verticalScrollbarVisibility:void 0},i._getSign=function(e){return 0===e?1:-1},i._getAxis=function(e){return 0===e?"x":"y"},i._getCalculatedDimension=function(e){return 0===e?"calculatedWidth":"calculatedHeight"},i._destroyDragHelper=function(){this._contentDragHelper&&this._contentDragHelper.destroy();},i.onUpdate=function(){this._contentEntity&&(this._updateVelocity(),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1));},i._updateVelocity=function(){if(!this._isDragging()){if(1===this.scrollMode&&(this._hasOvershoot("x",0)&&this._setVelocityFromOvershoot(this.scroll.x,"x",0),this._hasOvershoot("y",1)&&this._setVelocityFromOvershoot(this.scroll.y,"y",1)),Math.abs(this._velocity.x)>1e-4||Math.abs(this._velocity.y)>1e-4){var e=this._contentEntity.getLocalPosition();e.x+=this._velocity.x,e.y+=this._velocity.y,this._contentEntity.setLocalPosition(e),this._setScrollFromContentPosition(e);}this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction;}},i._hasOvershoot=function(e,t){return Math.abs(this._toOvershoot(this.scroll[e],t))>.001},i._toOvershoot=function(e,t){var n=this._getMaxScrollValue(t);return e<0?e:e>n?e-n:0},i._setVelocityFromOvershoot=function(e,t,n){var i=this._toOvershoot(e,n)*this._getMaxOffset(n)*this._getSign(n);Math.abs(i)>0&&(this._velocity[t]=-i/(50*this.bounceAmount+1));},i._setVelocityFromContentPositionDelta=function(e){this._prevContentDragPosition?(this._velocity.sub2(e,this._prevContentDragPosition),this._prevContentDragPosition.copy(e)):(this._velocity.set(0,0,0),this._prevContentDragPosition=e.clone());},i._setScrollFromContentPosition=function(e){var t=this._contentPositionToScrollValue(e);this._isDragging()&&(t=this._applyScrollValueTension(t)),this._onSetScroll(t.x,t.y,false);},i._applyScrollValueTension=function(e){var t=this._getMaxScrollValue(0),n=this._toOvershoot(e.x,0);return n>0?e.x=t+ +Math.log10(1+n):n<0&&(e.x=-1*Math.log10(1-n)),t=this._getMaxScrollValue(1),(n=this._toOvershoot(e.y,1))>0?e.y=t+ +Math.log10(1+n):n<0&&(e.y=-1*Math.log10(1-n)),e},i._isDragging=function(){return this._contentDragHelper&&this._contentDragHelper.isDragging},i._setScrollbarComponentsEnabled=function(e){var t,n;(null==(t=this._horizontalScrollbarEntity)?void 0:t.scrollbar)&&(this._horizontalScrollbarEntity.scrollbar.enabled=e),(null==(n=this._verticalScrollbarEntity)?void 0:n.scrollbar)&&(this._verticalScrollbarEntity.scrollbar.enabled=e);},i._setContentDraggingEnabled=function(e){this._contentDragHelper&&(this._contentDragHelper.enabled=e);},i._onMouseWheel=function(e){if(this.useMouseWheel&&(null==(t=this._contentEntity)?void 0:t.element)){var t,n=e.event,i=n.deltaX/this._contentEntity.element.calculatedWidth*this.mouseWheelSensitivity.x,r=n.deltaY/this._contentEntity.element.calculatedHeight*this.mouseWheelSensitivity.y,s=ek.clamp(this._scroll.x+i,0,this._getMaxScrollValue(0)),a=ek.clamp(this._scroll.y+r,0,this._getMaxScrollValue(1));this.scroll=new eX(s,a);}},i._enableContentInput=function(){for(;this._disabledContentInputEntities.length;){var e=this._disabledContentInputEntities.pop();e.element&&(e.element.useInput=true);}this._disabledContentInput=false;},i._disableContentInput=function(){var e=this,t=function(n){n.element&&n.element.useInput&&(e._disabledContentInputEntities.push(n),n.element.useInput=false);for(var i=n.children,r=0,s=i.length;r<s;r++)t(i[r]);};if(this._contentEntity)for(var n=this._contentEntity.children,i=0,r=n.length;i<r;i++)t(n[i]);this._disabledContentInput=true;},i.onEnable=function(){this._setScrollbarComponentsEnabled(true),this._setContentDraggingEnabled(true),this._syncAll();},i.onDisable=function(){this._setScrollbarComponentsEnabled(false),this._setContentDraggingEnabled(false);},i.onRemove=function(){this._toggleLifecycleListeners("off"),this._toggleElementListeners("off"),this._destroyDragHelper();},i.resolveDuplicatedEntityReferenceProperties=function(e,t){e.viewportEntity&&(this.viewportEntity=t[e.viewportEntity.getGuid()]),e.contentEntity&&(this.contentEntity=t[e.contentEntity.getGuid()]),e.horizontalScrollbarEntity&&(this.horizontalScrollbarEntity=t[e.horizontalScrollbarEntity.getGuid()]),e.verticalScrollbarEntity&&(this.verticalScrollbarEntity=t[e.verticalScrollbarEntity.getGuid()]);},n=[{key:"data",get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}},{key:"enabled",get:function(){return this.data.enabled},set:function(e){this._setValue("enabled",e);}},{key:"horizontal",get:function(){return this.data.horizontal},set:function(e){this._setValue("horizontal",e);}},{key:"vertical",get:function(){return this.data.vertical},set:function(e){this._setValue("vertical",e);}},{key:"scrollMode",get:function(){return this.data.scrollMode},set:function(e){this._setValue("scrollMode",e);}},{key:"bounceAmount",get:function(){return this.data.bounceAmount},set:function(e){this._setValue("bounceAmount",e);}},{key:"friction",get:function(){return this.data.friction},set:function(e){this._setValue("friction",e);}},{key:"dragThreshold",get:function(){return this.data.dragThreshold},set:function(e){this._setValue("dragThreshold",e);}},{key:"useMouseWheel",get:function(){return this.data.useMouseWheel},set:function(e){this._setValue("useMouseWheel",e);}},{key:"mouseWheelSensitivity",get:function(){return this.data.mouseWheelSensitivity},set:function(e){this._setValue("mouseWheelSensitivity",e);}},{key:"horizontalScrollbarVisibility",get:function(){return this.data.horizontalScrollbarVisibility},set:function(e){this._setValue("horizontalScrollbarVisibility",e);}},{key:"verticalScrollbarVisibility",get:function(){return this.data.verticalScrollbarVisibility},set:function(e){this._setValue("verticalScrollbarVisibility",e);}},{key:"viewportEntity",get:function(){return this._viewportEntity},set:function(e){if(this._viewportEntity!==e){var t="string"==typeof e;(!this._viewportEntity||!t||this._viewportEntity.getGuid()!==e)&&(this._viewportEntity&&this._viewportEntityUnsubscribe(),Sa(e,us)?this._viewportEntity=e:t?this._viewportEntity=this.system.app.getEntityFromIndex(e)||null:this._viewportEntity=null,this._viewportEntity&&this._viewportEntitySubscribe(),this._viewportEntity?this.data.viewportEntity=this._viewportEntity.getGuid():t&&e&&(this.data.viewportEntity=e));}}},{key:"contentEntity",get:function(){return this._contentEntity},set:function(e){if(this._contentEntity!==e){var t="string"==typeof e;(!this._contentEntity||!t||this._contentEntity.getGuid()!==e)&&(this._contentEntity&&this._contentEntityUnsubscribe(),Sa(e,us)?this._contentEntity=e:t?this._contentEntity=this.system.app.getEntityFromIndex(e)||null:this._contentEntity=null,this._contentEntity&&this._contentEntitySubscribe(),this._contentEntity?this.data.contentEntity=this._contentEntity.getGuid():t&&e&&(this.data.contentEntity=e));}}},{key:"horizontalScrollbarEntity",get:function(){return this._horizontalScrollbarEntity},set:function(e){if(this._horizontalScrollbarEntity!==e){var t="string"==typeof e;(!this._horizontalScrollbarEntity||!t||this._horizontalScrollbarEntity.getGuid()!==e)&&(this._horizontalScrollbarEntity&&this._horizontalScrollbarEntityUnsubscribe(),Sa(e,us)?this._horizontalScrollbarEntity=e:t?this._horizontalScrollbarEntity=this.system.app.getEntityFromIndex(e)||null:this._horizontalScrollbarEntity=null,this._scrollbarEntities[0]=this._horizontalScrollbarEntity,this._horizontalScrollbarEntity&&this._horizontalScrollbarEntitySubscribe(),this._horizontalScrollbarEntity?this.data.horizontalScrollbarEntity=this._horizontalScrollbarEntity.getGuid():t&&e&&(this.data.horizontalScrollbarEntity=e));}}},{key:"verticalScrollbarEntity",get:function(){return this._verticalScrollbarEntity},set:function(e){if(this._verticalScrollbarEntity!==e){var t="string"==typeof e;(!this._verticalScrollbarEntity||!t||this._verticalScrollbarEntity.getGuid()!==e)&&(this._verticalScrollbarEntity&&this._verticalScrollbarEntityUnsubscribe(),Sa(e,us)?this._verticalScrollbarEntity=e:t?this._verticalScrollbarEntity=this.system.app.getEntityFromIndex(e)||null:this._verticalScrollbarEntity=null,this._scrollbarEntities[1]=this._verticalScrollbarEntity,this._verticalScrollbarEntity&&this._verticalScrollbarEntitySubscribe(),this._verticalScrollbarEntity?this.data.verticalScrollbarEntity=this._verticalScrollbarEntity.getGuid():t&&e&&(this.data.verticalScrollbarEntity=e));}}},{key:"scroll",get:function(){return this._scroll},set:function(e){this._onSetScroll(e.x,e.y);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX);Su.EVENT_SETSCROLL="set:scroll";var Sc=function(){this.enabled=true,this.dragThreshold=10,this.useMouseWheel=true,this.mouseWheelSensitivity=new eX(1,1),this.horizontalScrollbarVisibility=0,this.verticalScrollbarVisibility=0,this.viewportEntity=null,this.contentEntity=null,this.horizontalScrollbarEntity=null,this.verticalScrollbarEntity=null;};function Sh(e,t){return (Sh=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Sf=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"useMouseWheel",type:"boolean"},{name:"mouseWheelSensitivity",type:"vec2"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"}],Sd=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).id="scrollview",n.ComponentType=Su,n.DataType=Sc,n.schema=Sf,n.on("beforeremove",n._onRemoveComponent,n),n.app.systems.on("update",n.onUpdate,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Sh(t,e);var n=t.prototype;return n.initializeComponentData=function(t,n,i){ void 0===n.dragThreshold&&(n.dragThreshold=10),void 0===n.useMouseWheel&&(n.useMouseWheel=true),void 0===n.mouseWheelSensitivity&&(n.mouseWheelSensitivity=new eX(1,1)),e.prototype.initializeComponentData.call(this,t,n,Sf),t.viewportEntity=n.viewportEntity,t.contentEntity=n.contentEntity,t.horizontalScrollbarEntity=n.horizontalScrollbarEntity,t.verticalScrollbarEntity=n.verticalScrollbarEntity;},n.onUpdate=function(e){var t=this.store;for(var n in t){var i=t[n].entity,r=i.scrollview;r.enabled&&i.enabled&&r.onUpdate();}},n._onRemoveComponent=function(e,t){t.onRemove();},n.destroy=function(){e.prototype.destroy.call(this),this.app.systems.off("update",this.onUpdate,this);},t}(mZ);function Sp(e,t){return (Sp=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Sm=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n)||this)._handleEntity=null,i._evtHandleEntityElementAdd=null,i._evtHandleEntityChanges=[],i._toggleLifecycleListeners("on"),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Sp(t,e);var n,r=t.prototype;return r._setValue=function(e,t){var n=this.data,i=n[e];n[e]=t,this.fire("set",e,i,t);},r._toggleLifecycleListeners=function(e){this[e]("set_value",this._onSetValue,this),this[e]("set_handleSize",this._onSetHandleSize,this),this[e]("set_orientation",this._onSetOrientation,this);},r._handleEntitySubscribe=function(){this._evtHandleEntityElementAdd=this._handleEntity.on("element:add",this._onHandleElementGain,this),this._handleEntity.element&&this._onHandleElementGain();},r._handleEntityUnsubscribe=function(){var e,t;null==(e=this._evtHandleEntityElementAdd)||e.off(),this._evtHandleEntityElementAdd=null,(null==(t=this._handleEntity)?void 0:t.element)&&this._onHandleElementLose();},r._handleEntityElementSubscribe=function(){var e=this._handleEntity.element,t=this._evtHandleEntityChanges;t.push(e.once("beforeremove",this._onHandleElementLose,this)),t.push(e.on("set:anchor",this._onSetHandleAlignment,this)),t.push(e.on("set:margin",this._onSetHandleAlignment,this)),t.push(e.on("set:pivot",this._onSetHandleAlignment,this));},r._handleEntityElementUnsubscribe=function(){for(var e=0;e<this._evtHandleEntityChanges.length;e++)this._evtHandleEntityChanges[e].off();this._evtHandleEntityChanges.length=0;},r._onHandleElementGain=function(){this._handleEntityElementSubscribe(),this._destroyDragHelper(),this._handleDragHelper=new Ss(this._handleEntity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize();},r._onHandleElementLose=function(){this._handleEntityElementUnsubscribe(),this._destroyDragHelper();},r._onHandleDrag=function(e){this._handleEntity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(e[this._getAxis()]));},r._onSetValue=function(e,t,n){Math.abs(n-t)>1e-5&&(this.data.value=ek.clamp(n,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value));},r._onSetHandleSize=function(e,t,n){Math.abs(n-t)>1e-5&&(this.data.handleSize=ek.clamp(n,0,1),this._updateHandlePositionAndSize());},r._onSetHandleAlignment=function(){this._updateHandlePositionAndSize();},r._onSetOrientation=function(e,t,n){var i;n!==t&&(null==(i=this._handleEntity)?void 0:i.element)&&(this._handleEntity.element[this._getOppositeDimension()]=0);},r._updateHandlePositionAndSize=function(){var e=this._handleEntity,t=null==e?void 0:e.element;if(e){var n=e.getLocalPosition();n[this._getAxis()]=this._getHandlePosition(),e.setLocalPosition(n);}t&&(t[this._getDimension()]=this._getHandleLength());},r._handlePositionToScrollValue=function(e){return e*this._getSign()/this._getUsableTrackLength()},r._scrollValueToHandlePosition=function(e){return e*this._getSign()*this._getUsableTrackLength()},r._getUsableTrackLength=function(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)},r._getTrackLength=function(){return this.entity.element?0===this.orientation?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0},r._getHandleLength=function(){return this._getTrackLength()*this.handleSize},r._getHandlePosition=function(){return this._scrollValueToHandlePosition(this.value)},r._getSign=function(){return 0===this.orientation?1:-1},r._getAxis=function(){return 0===this.orientation?"x":"y"},r._getDimension=function(){return 0===this.orientation?"width":"height"},r._getOppositeDimension=function(){return 0===this.orientation?"height":"width"},r._destroyDragHelper=function(){this._handleDragHelper&&this._handleDragHelper.destroy();},r._setHandleDraggingEnabled=function(e){this._handleDragHelper&&(this._handleDragHelper.enabled=e);},r.onEnable=function(){this._setHandleDraggingEnabled(true);},r.onDisable=function(){this._setHandleDraggingEnabled(false);},r.onRemove=function(){this._destroyDragHelper(),this._toggleLifecycleListeners("off");},r.resolveDuplicatedEntityReferenceProperties=function(e,t){e.handleEntity&&(this.handleEntity=t[e.handleEntity.getGuid()]);},n=[{key:"data",get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}},{key:"enabled",get:function(){return this.data.enabled},set:function(e){this._setValue("enabled",e);}},{key:"orientation",get:function(){return this.data.orientation},set:function(e){this._setValue("orientation",e);}},{key:"value",get:function(){return this.data.value},set:function(e){this._setValue("value",e);}},{key:"handleSize",get:function(){return this.data.handleSize},set:function(e){this._setValue("handleSize",e);}},{key:"handleEntity",get:function(){return this._handleEntity},set:function(e){if(this._handleEntity!==e){var t="string"==typeof e;(!this._handleEntity||!t||this._handleEntity.getGuid()!==e)&&((this._handleEntity&&this._handleEntityUnsubscribe(),null!=us&&"undefined"!=typeof Symbol&&us[Symbol.hasInstance]?!!us[Symbol.hasInstance](e):i(e,us))?this._handleEntity=e:t?this._handleEntity=this.system.app.getEntityFromIndex(e)||null:this._handleEntity=null,this._handleEntity&&this._handleEntitySubscribe(),this._handleEntity?this.data.handleEntity=this._handleEntity.getGuid():t&&e&&(this.data.handleEntity=e));}}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX);Sm.EVENT_SETVALUE="set:value";var S_=function(){this.enabled=true,this.orientation=0,this.value=0,this.handleSize=0,this.handleEntity=null;};function Sv(e,t){return (Sv=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Sg=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"}],Sy=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).id="scrollbar",n.ComponentType=Sm,n.DataType=S_,n.schema=Sg,n.on("add",n._onAddComponent,n),n.on("beforeremove",n._onRemoveComponent,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Sv(t,e);var n=t.prototype;return n.initializeComponentData=function(t,n,i){e.prototype.initializeComponentData.call(this,t,n,Sg),t.handleEntity=n.handleEntity;},n._onAddComponent=function(e){e.fire("scrollbar:add");},n._onRemoveComponent=function(e,t){t.onRemove();},t}(mZ);function SS(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function Sx(e,t){return (Sx=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Sb={volume:0,pitch:0,loop:false,startTime:0,duration:0,position:new eW,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null},ST=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i){var r;return void 0===n&&(n="Untitled"),void 0===i&&(i={}),(r=e.call(this)||this).instances=[],r._component=t,r._assets=t.system.app.assets,r._manager=t.system.manager,r.name=n,r._volume=void 0!==i.volume?ek.clamp(Number(i.volume)||0,0,1):1,r._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,r._loop=!!(void 0!==i.loop&&i.loop),r._duration=i.duration>0?i.duration:null,r._startTime=Math.max(0,Number(i.startTime)||0),r._overlap=!!i.overlap,r._autoPlay=!!i.autoPlay,r._firstNode=null,r._lastNode=null,r._asset=i.asset,SS(r._asset,pZ)&&(r._asset=r._asset.id),r._onInstancePlayHandler=r._onInstancePlay.bind(r),r._onInstancePauseHandler=r._onInstancePause.bind(r),r._onInstanceResumeHandler=r._onInstanceResume.bind(r),r._onInstanceStopHandler=r._onInstanceStop.bind(r),r._onInstanceEndHandler=r._onInstanceEnd.bind(r),r}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Sx(t,e);var n,i=t.prototype;return i.play=function(){if(this.overlap||this.stop(),this.isLoaded||this._hasAsset()){var e=this._createInstance();if(this.instances.push(e),this.isLoaded)e.play();else {var t=function(t){var n=e._playWhenLoaded;e.sound=t,n&&e.play();};this.off("load",t),this.once("load",t),this.load();}return e}},i.pause=function(){for(var e=false,t=this.instances,n=0,i=t.length;n<i;n++)t[n].pause()&&(e=true);return e},i.resume=function(){for(var e=false,t=this.instances,n=0,i=t.length;n<i;n++)t[n].resume()&&(e=true);return e},i.stop=function(){for(var e=false,t=this.instances,n=t.length;n--;)t[n].stop(),e=true;return t.length=0,e},i.load=function(){if(this._hasAsset()){var e=this._assets.get(this._asset);if(!e){this._assets.off("add:"+this._asset,this._onAssetAdd,this),this._assets.once("add:"+this._asset,this._onAssetAdd,this);return}if(e.off("remove",this._onAssetRemoved,this),e.on("remove",this._onAssetRemoved,this),!e.resource){e.off("load",this._onAssetLoad,this),e.once("load",this._onAssetLoad,this),this._assets.load(e);return}this.fire("load",e.resource);}},i.setExternalNodes=function(e,t){if(e&&(t||(t=e),this._firstNode=e,this._lastNode=t,!this._overlap))for(var n=this.instances,i=0,r=n.length;i<r;i++)n[i].setExternalNodes(e,t);},i.clearExternalNodes=function(){if(this._firstNode=null,this._lastNode=null,!this._overlap)for(var e=this.instances,t=0,n=e.length;t<n;t++)e[t].clearExternalNodes();},i.getExternalNodes=function(){return [this._firstNode,this._lastNode]},i._hasAsset=function(){return null!=this._asset},i._createInstance=function(){var e=null,t=this._component,n=null;if(this._hasAsset()){var i=this._assets.get(this._asset);i&&(n=i.resource);}return Sb.volume=this._volume*t.volume,Sb.pitch=this._pitch*t.pitch,Sb.loop=this._loop,Sb.startTime=this._startTime,Sb.duration=this._duration,Sb.onPlay=this._onInstancePlayHandler,Sb.onPause=this._onInstancePauseHandler,Sb.onResume=this._onInstanceResumeHandler,Sb.onStop=this._onInstanceStopHandler,Sb.onEnd=this._onInstanceEndHandler,t.positional?(Sb.position.copy(t.entity.getPosition()),Sb.maxDistance=t.maxDistance,Sb.refDistance=t.refDistance,Sb.rollOffFactor=t.rollOffFactor,Sb.distanceModel=t.distanceModel,e=new a9(this._manager,n,Sb)):e=new a8(this._manager,n,Sb),this._firstNode&&e.setExternalNodes(this._firstNode,this._lastNode),e},i._onInstancePlay=function(e){this.fire("play",e),this._component.fire("play",this,e);},i._onInstancePause=function(e){this.fire("pause",e),this._component.fire("pause",this,e);},i._onInstanceResume=function(e){this.fire("resume",e),this._component.fire("resume",this,e);},i._onInstanceStop=function(e){var t=this.instances.indexOf(e);-1!==t&&this.instances.splice(t,1),this.fire("stop",e),this._component.fire("stop",this,e);},i._onInstanceEnd=function(e){var t=this.instances.indexOf(e);-1!==t&&this.instances.splice(t,1),this.fire("end",e),this._component.fire("end",this,e);},i._onAssetAdd=function(e){this.load();},i._onAssetLoad=function(e){this.load();},i._onAssetRemoved=function(e){e.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+e.id,this._onAssetAdd,this),this.stop();},i.updatePosition=function(e){for(var t=this.instances,n=0,i=t.length;n<i;n++)t[n].position=e;},n=[{key:"asset",get:function(){return this._asset},set:function(e){var t=this._asset;if(t){this._assets.off("add:"+t,this._onAssetAdd,this);var n=this._assets.get(t);n&&n.off("remove",this._onAssetRemoved,this);}this._asset=e,SS(this._asset,pZ)&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load();}},{key:"autoPlay",get:function(){return this._autoPlay},set:function(e){this._autoPlay=!!e;}},{key:"duration",get:function(){var e=0;if(this._hasAsset()){var t=this._assets.get(this._asset);e=(null==t?void 0:t.resource)?t.resource.duration:0;}return null!=this._duration?this._duration%(e||1):e},set:function(e){if(this._duration=Math.max(0,Number(e)||0)||null,!this._overlap)for(var t=this.instances,n=0,i=t.length;n<i;n++)t[n].duration=this._duration;}},{key:"isLoaded",get:function(){if(this._hasAsset()){var e=this._assets.get(this._asset);if(e)return !!e.resource}return  false}},{key:"isPaused",get:function(){var e=this.instances,t=e.length;if(0===t)return  false;for(var n=0;n<t;n++)if(!e[n].isPaused)return  false;return  true}},{key:"isPlaying",get:function(){for(var e=this.instances,t=0,n=e.length;t<n;t++)if(e[t].isPlaying)return  true;return  false}},{key:"isStopped",get:function(){for(var e=this.instances,t=0,n=e.length;t<n;t++)if(!e[t].isStopped)return  false;return  true}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=!!e;for(var t=this.instances,n=0,i=t.length;n<i;n++)t[n].loop=this._loop;}},{key:"overlap",get:function(){return this._overlap},set:function(e){this._overlap=!!e;}},{key:"pitch",get:function(){return this._pitch},set:function(e){if(this._pitch=Math.max(Number(e)||0,.01),!this._overlap)for(var t=this.instances,n=0,i=t.length;n<i;n++)t[n].pitch=this.pitch*this._component.pitch;}},{key:"startTime",get:function(){return this._startTime},set:function(e){if(this._startTime=Math.max(0,Number(e)||0),!this._overlap)for(var t=this.instances,n=0,i=t.length;n<i;n++)t[n].startTime=this._startTime;}},{key:"volume",get:function(){return this._volume},set:function(e){if(this._volume=ek.clamp(Number(e)||0,0,1),!this._overlap)for(var t=this.instances,n=0,i=t.length;n<i;n++)t[n].volume=this._volume*this._component.volume;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function SE(e,t){return (SE=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}ST.EVENT_PLAY="play",ST.EVENT_PAUSE="pause",ST.EVENT_RESUME="resume",ST.EVENT_STOP="stop",ST.EVENT_END="end",ST.EVENT_LOAD="load";var Sw=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return t=e.apply(this,arguments)||this,t._volume=1,t._pitch=1,t._positional=true,t._refDistance=1,t._maxDistance=1e4,t._rollOffFactor=1,t._distanceModel=aK,t._slots={},t._playingBeforeDisable={},t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&SE(t,e);var n,r=t.prototype;return r._updateSoundInstances=function(e,t,n){var i=this._slots;for(var r in i){var s=i[r];if(!s.overlap)for(var a=s.instances,o=0,l=a.length;o<l;o++)a[o][e]=n?s[e]*t:t;}},r.onEnable=function(){if(!this.system._inTools){var e=this._slots,t=this._playingBeforeDisable;for(var n in e){var i=e[n];i.autoPlay&&i.isStopped?i.play():t[n]?i.resume():i.isLoaded||i.load();}}},r.onDisable=function(){var e=this._slots,t={};for(var n in e)!e[n].overlap&&e[n].isPlaying&&(e[n].pause(),t[n]=true);this._playingBeforeDisable=t;},r.onRemove=function(){this.off();},r.addSlot=function(e,t){var n=this._slots;if(n[e])return null;var i=new ST(this,e,t);return n[e]=i,i.autoPlay&&this.enabled&&this.entity.enabled&&i.play(),i},r.removeSlot=function(e){var t=this._slots;t[e]&&(t[e].stop(),delete t[e]);},r.slot=function(e){return this._slots[e]},r._getSlotProperty=function(e,t){if(this.enabled&&this.entity.enabled){var n=this._slots[e];if(n)return n[t]}},r.isPlaying=function(e){return this._getSlotProperty(e,"isPlaying")||false},r.isLoaded=function(e){return this._getSlotProperty(e,"isLoaded")||false},r.isPaused=function(e){return this._getSlotProperty(e,"isPaused")||false},r.isStopped=function(e){return this._getSlotProperty(e,"isStopped")||false},r.play=function(e){if(!this.enabled||!this.entity.enabled)return null;var t=this._slots[e];return t?t.play():null},r.pause=function(e){var t=this._slots;if(e){var n=t[e];if(!n)return;n.pause();}else for(var i in t)t[i].pause();},r.resume=function(e){var t=this._slots;if(e){var n=t[e];if(!n)return;n.isPaused&&n.resume();}else for(var i in t)t[i].resume();},r.stop=function(e){var t=this._slots;if(e){var n=t[e];if(!n)return;n.stop();}else for(var i in t)t[i].stop();},n=[{key:"distanceModel",get:function(){return this._distanceModel},set:function(e){this._distanceModel=e,this._updateSoundInstances("distanceModel",e,false);}},{key:"maxDistance",get:function(){return this._maxDistance},set:function(e){this._maxDistance=e,this._updateSoundInstances("maxDistance",e,false);}},{key:"refDistance",get:function(){return this._refDistance},set:function(e){this._refDistance=e,this._updateSoundInstances("refDistance",e,false);}},{key:"rollOffFactor",get:function(){return this._rollOffFactor},set:function(e){this._rollOffFactor=e,this._updateSoundInstances("rollOffFactor",e,false);}},{key:"pitch",get:function(){return this._pitch},set:function(e){this._pitch=e,this._updateSoundInstances("pitch",e,true);}},{key:"volume",get:function(){return this._volume},set:function(e){this._volume=e,this._updateSoundInstances("volume",e,true);}},{key:"positional",get:function(){return this._positional},set:function(e){this._positional=e;var t=this._slots;for(var n in t){var i=t[n];if(!i.overlap)for(var r=i.instances,s=r.length,a=s-1;a>=0;a--){var o=r[a].isPlaying||r[a].isSuspended,l=r[a].currentTime;o&&r[a].stop();var u=i._createInstance();o&&(u.play(),u.currentTime=l),r.push(u);}}}},{key:"slots",get:function(){return this._slots},set:function(e){var t,n=this._slots;if(n)for(var r in n)n[r].stop();var s={};for(var a in e)(t=e[a],null!=ST&&"undefined"!=typeof Symbol&&ST[Symbol.hasInstance]?!!ST[Symbol.hasInstance](t):i(t,ST))?s[e[a].name]=e[a]:e[a].name&&(s[e[a].name]=new ST(this,e[a].name,e[a]));this._slots=s,this.enabled&&this.entity.enabled&&this.onEnable();}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX);Sw.EVENT_PLAY="play",Sw.EVENT_PAUSE="pause",Sw.EVENT_RESUME="resume",Sw.EVENT_STOP="stop",Sw.EVENT_END="end";var SA=function(){this.enabled=true;};function SC(e,t){return (SC=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var SP=["enabled"],SI=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).id="sound",n.ComponentType=Sw,n.DataType=SA,n.schema=SP,n.manager=t.soundManager,n.app.systems.on("update",n.onUpdate,n),n.on("beforeremove",n.onBeforeRemove,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&SC(t,e);var n,i=t.prototype;return i.initializeComponentData=function(t,n,i){i=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"];for(var r=0;r<i.length;r++)n.hasOwnProperty(i[r])&&(t[i[r]]=n[i[r]]);e.prototype.initializeComponentData.call(this,t,n,["enabled"]);},i.cloneComponent=function(e,t){var n=e.sound,i=n.slots,r={};for(var s in i){var a=i[s];r[s]={name:a.name,volume:a.volume,pitch:a.pitch,loop:a.loop,duration:a.duration,startTime:a.startTime,overlap:a.overlap,autoPlay:a.autoPlay,asset:a.asset};}var o={distanceModel:n.distanceModel,enabled:n.enabled,maxDistance:n.maxDistance,pitch:n.pitch,positional:n.positional,refDistance:n.refDistance,rollOffFactor:n.rollOffFactor,slots:r,volume:n.volume};return this.addComponent(t,o)},i.onUpdate=function(e){var t=this.store;for(var n in t)if(t.hasOwnProperty(n)){var i=t[n].entity;if(i.enabled){var r=i.sound;if(r.enabled&&r.positional){var s=i.getPosition(),a=r.slots;for(var o in a)a[o].updatePosition(s);}}}},i.onBeforeRemove=function(e,t){var n=t.slots;for(var i in n)n[i].overlap||n[i].stop();t.onRemove();},i.destroy=function(){e.prototype.destroy.call(this),this.app.systems.off("update",this.onUpdate,this);},n=[{key:"volume",get:function(){return this.manager.volume},set:function(e){this.manager.volume=e;}},{key:"context",get:function(){return a4()?this.manager.context:null}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mZ);mX._buildAccessors(Sw.prototype,SP);var SL="simple",SD="animated";function SM(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function SR(e,t){return (SR=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var SO=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this)||this)._evtSetMeshes=null,i._component=t,i._frame=0,i._sprite=null,i._spriteAsset=null,i.spriteAsset=n.spriteAsset,i.name=n.name,i.fps=n.fps||0,i.loop=n.loop||false,i._playing=false,i._paused=false,i._time=0,i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&SR(t,e);var n,i=t.prototype;return i._onSpriteAssetAdded=function(e){this._component.system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e);},i._bindSpriteAsset=function(e){e.on("load",this._onSpriteAssetLoad,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._component.system.app.assets.load(e);},i._unbindSpriteAsset=function(e){e&&(e.off("load",this._onSpriteAssetLoad,this),e.off("remove",this._onSpriteAssetRemove,this),e.resource&&!e.resource.atlas&&this._component.system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this));},i._onSpriteAssetLoad=function(e){if(e.resource)if(e.resource.atlas)this.sprite=e.resource;else {var t=e.data.textureAtlasAsset,n=this._component.system.app.assets;n.off("load:"+t,this._onTextureAtlasLoad,this),n.once("load:"+t,this._onTextureAtlasLoad,this);}else this.sprite=null;},i._onTextureAtlasLoad=function(e){var t=this._spriteAsset;SM(t,pZ)?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._component.system.app.assets.get(t));},i._onSpriteAssetRemove=function(e){this.sprite=null;},i._onSpriteMeshesChange=function(){this._component.currentClip===this&&this._component._showFrame(this.frame);},i._onSpritePpuChanged=function(){this._component.currentClip===this&&0!==this.sprite.renderMode&&this._component._showFrame(this.frame);},i._update=function(e){if(0!==this.fps&&this._playing&&!this._paused&&this._sprite){var t=this.fps<0?-1:1,n=this._time+e*this._component.speed*t,i=this.duration,r=n>i||n<0;this._setTime(n);var s=this.frame;(s=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/i):0)!==this._frame&&this._setFrame(s),r&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._playing=false,this._paused=false,this.fire("end"),this._component.fire("end",this)));}},i._setTime=function(e){this._time=e;var t=this.duration;this._time<0?this.loop?this._time=this._time%t+t:this._time=0:this._time>t&&(this.loop?this._time%=t:this._time=t);},i._setFrame=function(e){this._sprite?this._frame=ek.clamp(e,0,this._sprite.frameKeys.length-1):this._frame=e,this._component.currentClip===this&&this._component._showFrame(this._frame);},i._destroy=function(){if(this._spriteAsset){var e=this._component.system.app.assets;this._unbindSpriteAsset(e.get(this._spriteAsset));}this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null);},i.play=function(){this._playing||(this._playing=true,this._paused=false,this.frame=0,this.fire("play"),this._component.fire("play",this));},i.pause=function(){this._playing&&!this._paused&&(this._paused=true,this.fire("pause"),this._component.fire("pause",this));},i.resume=function(){this._paused&&(this._paused=false,this.fire("resume"),this._component.fire("resume",this));},i.stop=function(){this._playing&&(this._playing=false,this._paused=false,this._time=0,this.frame=0,this.fire("stop"),this._component.fire("stop",this));},n=[{key:"duration",get:function(){if(this._sprite){var e=this.fps||Number.MIN_VALUE;return this._sprite.frameKeys.length/Math.abs(e)}return 0}},{key:"frame",get:function(){return this._frame},set:function(e){this._setFrame(e);var t=this.fps||Number.MIN_VALUE;this._setTime(this._frame/t);}},{key:"isPaused",get:function(){return this._paused}},{key:"isPlaying",get:function(){return this._playing}},{key:"sprite",get:function(){return this._sprite},set:function(e){var t,n;this._sprite&&(null==(t=this._evtSetMeshes)||t.off(),this._evtSetMeshes=null,this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)),this._sprite=e,this._sprite&&(this._evtSetMeshes=this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this&&(e&&e.atlas?(e.atlas.texture&&((n=this._component._meshInstance)&&(n.setParameter("texture_emissiveMap",e.atlas.texture),n.setParameter("texture_opacityMap",e.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame):((n=this._component._meshInstance)&&(n.deleteParameter("texture_emissiveMap"),n.deleteParameter("texture_opacityMap")),this._component._hideModel()));}},{key:"spriteAsset",get:function(){return this._spriteAsset},set:function(e){var t=this._component.system.app.assets,n=e;if(SM(e,pZ)&&(n=e.id),this._spriteAsset!==n){if(this._spriteAsset){var i=t.get(this._spriteAsset);i&&this._unbindSpriteAsset(i);}if(this._spriteAsset=n,this._spriteAsset){var r=t.get(this._spriteAsset);r?this._bindSpriteAsset(r):(this.sprite=null,t.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this));}else this.sprite=null;}}},{key:"time",get:function(){return this._time},set:function(e){this._setTime(e),this._sprite?this.frame=Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):this.frame=0;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function Sk(e,t){return (Sk=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}SO.EVENT_PLAY="play",SO.EVENT_PAUSE="pause",SO.EVENT_RESUME="resume",SO.EVENT_STOP="stop",SO.EVENT_END="end",SO.EVENT_LOOP="loop";var SN="texture_emissiveMap",SF="texture_opacityMap",SB="material_emissive",SU="material_opacity",Sz=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n)||this)._evtLayersChanged=null,i._evtLayerAdded=null,i._evtLayerRemoved=null,i._type=SL,i._material=t.defaultMaterial,i._color=new eN(1,1,1,1),i._colorUniform=new Float32Array(3),i._speed=1,i._flipX=false,i._flipY=false,i._width=1,i._height=1,i._drawOrder=0,i._layers=[0],i._outerScale=new eX(1,1),i._outerScaleUniform=new Float32Array(2),i._innerOffset=new eY,i._innerOffsetUniform=new Float32Array(4),i._atlasRect=new eY,i._atlasRectUniform=new Float32Array(4),i._batchGroupId=-1,i._batchGroup=null,i._node=new us,i._model=new he,i._model.graph=i._node,i._meshInstance=null,n.addChild(i._model.graph),i._model._entity=n,i._updateAabbFunc=i._updateAabb.bind(i),i._addedModel=false,i._autoPlayClip=null,i._clips={},i._defaultClip=new SO(i,{name:i.entity.name,fps:0,loop:false,spriteAsset:null}),i._currentClip=i._defaultClip,i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Sk(t,e);var n,r=t.prototype;return r.onEnable=function(){var e,t=this.system.app,n=t.scene,i=n.layers;this._evtLayersChanged=n.on("set:layers",this._onLayersChanged,this),i&&(this._evtLayerAdded=i.on("add",this._onLayerAdded,this),this._evtLayerRemoved=i.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),this._batchGroupId>=0&&(null==(e=t.batcher)||e.insert(lo.SPRITE,this._batchGroupId,this.entity));},r.onDisable=function(){var e,t,n,i,r=this.system.app,s=r.scene.layers;null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,s&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(n=this._evtLayerRemoved)||n.off(),this._evtLayerRemoved=null),this.stop(),this._hideModel(),this._batchGroupId>=0&&(null==(i=r.batcher)||i.remove(lo.SPRITE,this._batchGroupId,this.entity));},r.onDestroy=function(){var e;for(var t in this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null),this._clips)this._clips[t]._destroy();this._clips=null,this._hideModel(),this._model=null,null==(e=this._node)||e.remove(),this._node=null,this._meshInstance&&(this._meshInstance.material=null,this._meshInstance.mesh=null,this._meshInstance=null);},r._showModel=function(){if(!this._addedModel&&this._meshInstance){for(var e=[this._meshInstance],t=0,n=this._layers.length;t<n;t++){var i=this.system.app.scene.layers.getLayerById(this._layers[t]);i&&i.addMeshInstances(e);}this._addedModel=true;}},r._hideModel=function(){if(this._addedModel&&this._meshInstance){for(var e=[this._meshInstance],t=0,n=this._layers.length;t<n;t++){var i=this.system.app.scene.layers.getLayerById(this._layers[t]);i&&i.removeMeshInstances(e);}this._addedModel=false;}},r._showFrame=function(e){if(this.sprite){var t,n=this.sprite.meshes[e];if(!n){this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=false);return}if(t=1===this.sprite.renderMode?this.system.default9SlicedMaterialSlicedMode:2===this.sprite.renderMode?this.system.default9SlicedMaterialTiledMode:this.system.defaultMaterial,!this._meshInstance&&(this._meshInstance=new lL(n,this._material,this._node),this._meshInstance.castShadow=false,this._meshInstance.receiveShadow=false,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(SB,this._colorUniform),this._meshInstance.setParameter(SU,this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==t&&(this._meshInstance.material=t),this._meshInstance.mesh!==n&&(this._meshInstance.mesh=n,this._meshInstance.visible=true,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter(SN,this.sprite.atlas.texture),this._meshInstance.setParameter(SF,this.sprite.atlas.texture)):(this._meshInstance.deleteParameter(SN),this._meshInstance.deleteParameter(SF)),this.sprite.atlas&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){this._meshInstance._updateAabbFunc=this._updateAabbFunc;var i=this.sprite.atlas.frames[this.sprite.frameKeys[e]];if(i){var r=2/i.rect.z,s=2/i.rect.w;this._innerOffset.set(i.border.x*r,i.border.y*s,i.border.z*r,i.border.w*s);var a=this.sprite.atlas.texture;this._atlasRect.set(i.rect.x/a.width,i.rect.y/a.height,i.rect.z/a.width,i.rect.w/a.height);}else this._innerOffset.set(0,0,0,0);this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter("atlasRect",this._atlasRectUniform);}else this._meshInstance._updateAabbFunc=null;this._updateTransform();}},r._updateTransform=function(){var e=this.flipX?-1:1,t=this.flipY?-1:1,n=0,i=0;if(this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){var r=1,s=1;if(this.sprite.atlas){var a=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];a&&(r=a.rect.z,s=a.rect.w,n=(.5-a.pivot.x)*this._width,i=(.5-a.pivot.y)*this._height);}var o=r/this.sprite.pixelsPerUnit,l=s/this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*o),Math.max(this._height,this._innerOffset.y*l)),e*=o,t*=l,this._outerScale.x/=o,this._outerScale.y/=l,e*=ek.clamp(this._width/(this._innerOffset.x*o),1e-4,1),t*=ek.clamp(this._height/(this._innerOffset.y*l),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter("outerScale",this._outerScaleUniform));}this._node.setLocalScale(e,t,1),this._node.setLocalPosition(n,i,0);},r._updateAabb=function(e){return e.center.set(0,0,0),e.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),e.setFromTransformedAabb(e,this._node.getWorldTransform()),e},r._tryAutoPlay=function(){if(this._autoPlayClip&&this.type===SD){var e=this._clips[this._autoPlayClip];e&&!e.isPlaying&&(!this._currentClip||!this._currentClip.isPlaying)&&this.enabled&&this.entity.enabled&&this.play(e.name);}},r._onLayersChanged=function(e,t){e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel();},r._onLayerAdded=function(e){!(0>this.layers.indexOf(e.id))&&this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&e.addMeshInstances([this._meshInstance]);},r._onLayerRemoved=function(e){this._meshInstance&&(0>this.layers.indexOf(e.id)||e.removeMeshInstances([this._meshInstance]));},r.removeModelFromLayers=function(){for(var e=0;e<this.layers.length;e++){var t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeMeshInstances([this._meshInstance]);}},r.addClip=function(e){var t=new SO(this,{name:e.name,fps:e.fps,loop:e.loop,spriteAsset:e.spriteAsset});return this._clips[e.name]=t,t.name&&t.name===this._autoPlayClip&&this._tryAutoPlay(),t},r.removeClip=function(e){delete this._clips[e];},r.clip=function(e){return this._clips[e]},r.play=function(e){var t=this._clips[e],n=this._currentClip;return n&&n!==t&&(n._playing=false),this._currentClip=t,this._currentClip&&(this._currentClip=t,this._currentClip.play()),t},r.pause=function(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause();},r.resume=function(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume();},r.stop=function(){this._currentClip!==this._defaultClip&&this._currentClip.stop();},n=[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._type===SL?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):this._type===SD&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()));}},{key:"frame",get:function(){return this._currentClip.frame},set:function(e){this._currentClip.frame=e;}},{key:"spriteAsset",get:function(){return this._defaultClip._spriteAsset},set:function(e){this._defaultClip.spriteAsset=e;}},{key:"sprite",get:function(){return this._currentClip.sprite},set:function(e){this._currentClip.sprite=e;}},{key:"material",get:function(){return this._material},set:function(e){this._material=e,this._meshInstance&&(this._meshInstance.material=e);}},{key:"color",get:function(){return this._color},set:function(e){this._color.r=e.r,this._color.g=e.g,this._color.b=e.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(SB,this._colorUniform));}},{key:"opacity",get:function(){return this._color.a},set:function(e){this._color.a=e,this._meshInstance&&this._meshInstance.setParameter(SU,e);}},{key:"clips",get:function(){return this._clips},set:function(e){if(!e){for(var t in this._clips)this.removeClip(t);return}for(var n in this._clips){var i=false;for(var r in e)if(e[r].name===n){i=true,this._clips[n].fps=e[r].fps,this._clips[n].loop=e[r].loop,e[r].hasOwnProperty("sprite")?this._clips[n].sprite=e[r].sprite:e[r].hasOwnProperty("spriteAsset")&&(this._clips[n].spriteAsset=e[r].spriteAsset);break}i||this.removeClip(n);}for(var s in e)this._clips[e[s].name]||this.addClip(e[s]);this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.sprite||this._hideModel();}},{key:"currentClip",get:function(){return this._currentClip}},{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e;}},{key:"flipX",get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._updateTransform());}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._updateTransform());}},{key:"width",get:function(){return this._width},set:function(e){e!==this._width&&(this._width=e,this._outerScale.x=this._width,this.sprite&&(2===this.sprite.renderMode||1===this.sprite.renderMode)&&this._updateTransform());}},{key:"height",get:function(){return this._height},set:function(e){e!==this._height&&(this._height=e,this._outerScale.y=this.height,this.sprite&&(2===this.sprite.renderMode||1===this.sprite.renderMode)&&this._updateTransform());}},{key:"batchGroupId",get:function(){return this._batchGroupId},set:function(e){if(this._batchGroupId!==e){var t,n,i=this._batchGroupId;this._batchGroupId=e,this.entity.enabled&&i>=0&&(null==(t=this.system.app.batcher)||t.remove(lo.SPRITE,i,this.entity)),this.entity.enabled&&e>=0?null==(n=this.system.app.batcher)||n.insert(lo.SPRITE,e,this.entity):i>=0&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel();}}},{key:"autoPlayClip",get:function(){return this._autoPlayClip},set:function(e){this._autoPlayClip=(null!=SO&&"undefined"!=typeof Symbol&&SO[Symbol.hasInstance]?!!SO[Symbol.hasInstance](e):i(e,SO))?e.name:e,this._tryAutoPlay();}},{key:"drawOrder",get:function(){return this._drawOrder},set:function(e){this._drawOrder=e,this._meshInstance&&(this._meshInstance.drawOrder=e);}},{key:"layers",get:function(){return this._layers},set:function(e){this._addedModel&&this._hideModel(),this._layers=e,this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel();}},{key:"aabb",get:function(){return this._meshInstance?this._meshInstance.aabb:null}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX);Sz.EVENT_PLAY="play",Sz.EVENT_PAUSE="pause",Sz.EVENT_RESUME="resume",Sz.EVENT_STOP="stop",Sz.EVENT_END="end",Sz.EVENT_LOOP="loop";var SV=function(){this.enabled=true;};function SG(e,t){return (SG=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var SH=["enabled"],SW=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).id="sprite",n.ComponentType=Sz,n.DataType=SV,n.schema=SH,n._defaultTexture=null,n._defaultMaterial=null,n._default9SlicedMaterialSlicedMode=null,n._default9SlicedMaterialTiledMode=null,n.app.systems.on("update",n.onUpdate,n),n.on("beforeremove",n.onBeforeRemove,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&SG(t,e);var n,r=t.prototype;return r.destroy=function(){e.prototype.destroy.call(this),this.app.systems.off("update",this.onUpdate,this),this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null);},r.initializeComponentData=function(t,n,r){if(void 0!==n.enabled&&(t.enabled=n.enabled),t.type=n.type,n.layers&&Array.isArray(n.layers)&&(t.layers=n.layers.slice(0)),void 0!==n.drawOrder&&(t.drawOrder=n.drawOrder),void 0!==n.color){var s,a,o;(o=n.color,null!=eN&&"undefined"!=typeof Symbol&&eN[Symbol.hasInstance]?!!eN[Symbol.hasInstance](o):i(o,eN))?t.color.set(n.color.r,n.color.g,n.color.b,null!=(s=n.opacity)?s:1):t.color.set(n.color[0],n.color[1],n.color[2],null!=(a=n.opacity)?a:1),t.color=t.color;}if(void 0!==n.opacity&&(t.opacity=n.opacity),void 0!==n.flipX&&(t.flipX=n.flipX),void 0!==n.flipY&&(t.flipY=n.flipY),void 0!==n.width&&(t.width=n.width),void 0!==n.height&&(t.height=n.height),void 0!==n.spriteAsset&&(t.spriteAsset=n.spriteAsset),n.sprite&&(t.sprite=n.sprite),void 0!==n.frame&&(t.frame=n.frame),n.clips)for(var l in n.clips)t.addClip(n.clips[l]);void 0!==n.speed&&(t.speed=n.speed),n.autoPlayClip&&(t.autoPlayClip=n.autoPlayClip),t.batchGroupId=void 0===n.batchGroupId||null===n.batchGroupId?-1:n.batchGroupId,e.prototype.initializeComponentData.call(this,t,n,r);},r.cloneComponent=function(e,t){var n=e.sprite;return this.addComponent(t,{enabled:n.enabled,type:n.type,spriteAsset:n.spriteAsset,sprite:n.sprite,width:n.width,height:n.height,frame:n.frame,color:n.color.clone(),opacity:n.opacity,flipX:n.flipX,flipY:n.flipY,speed:n.speed,clips:n.clips,autoPlayClip:n.autoPlayClip,batchGroupId:n.batchGroupId,drawOrder:n.drawOrder,layers:n.layers.slice(0)})},r.onUpdate=function(e){var t=this.store;for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];if(i.data.enabled&&i.entity.enabled){var r=i.entity.sprite;r._currentClip&&r._currentClip._update(e);}}},r.onBeforeRemove=function(e,t){t.onDestroy();},n=[{key:"defaultMaterial",get:function(){if(!this._defaultMaterial){var e=new nO(this.app.graphicsDevice,{width:1,height:1,format:20,name:"sprite"}),t=new Uint8Array(e.lock());t[0]=t[1]=t[2]=t[3]=255,e.unlock();var n=new dw;n.diffuse.set(0,0,0),n.emissive.set(1,1,1),n.emissiveMap=e,n.opacityMap=e,n.opacityMapChannel="a",n.useLighting=false,n.useTonemap=false,n.useFog=false,n.useSkybox=false,n.blendType=4,n.depthWrite=false,n.pixelSnap=false,n.cull=0,n.update(),this._defaultTexture=e,this._defaultMaterial=n;}return this._defaultMaterial},set:function(e){this._defaultMaterial=e;}},{key:"default9SlicedMaterialSlicedMode",get:function(){if(!this._default9SlicedMaterialSlicedMode){var e=this.defaultMaterial.clone();e.nineSlicedMode=1,e.update(),this._default9SlicedMaterialSlicedMode=e;}return this._default9SlicedMaterialSlicedMode},set:function(e){this._default9SlicedMaterialSlicedMode=e;}},{key:"default9SlicedMaterialTiledMode",get:function(){if(!this._default9SlicedMaterialTiledMode){var e=this.defaultMaterial.clone();e.nineSlicedMode=2,e.update(),this._default9SlicedMaterialTiledMode=e;}return this._default9SlicedMaterialTiledMode},set:function(e){this._default9SlicedMaterialTiledMode=e;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mZ);function Sj(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function SX(e,t){return (SX=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}mX._buildAccessors(Sz.prototype,SH);var SY=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n)||this)._oldState=true,i._size=new eW,i.on("set_enabled",i._onSetEnabled,i),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&SX(t,e);var n,i=t.prototype;return i.onEnable=function(){this._checkState();},i.onDisable=function(){this._checkState();},i._onSetEnabled=function(e,t,n){this._checkState();},i._checkState=function(){var e=this.enabled&&this.entity.enabled;e!==this._oldState&&(this._oldState=e,this.fire("enable"),this.fire("state",this.enabled));},i._onBeforeRemove=function(){this.fire("remove");},n=[{key:"size",get:function(){return this._size},set:function(e){Sj(e,eW)?this._size.copy(e):Sj(e,Array)&&e.length>=3&&this.size.set(e[0],e[1],e[2]);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX);SY.EVENT_ENABLE="enable",SY.EVENT_DISABLE="disable",SY.EVENT_STATE="state",SY.EVENT_REMOVE="remove";var Sq=function(){this.enabled=true;};function SK(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function SZ(e,t){return (SZ=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var SQ=["enabled"],SJ=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).id="zone",n.ComponentType=SY,n.DataType=Sq,n.schema=SQ,n.on("beforeremove",n._onBeforeRemove,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&SZ(t,e);var n=t.prototype;return n.initializeComponentData=function(e,t,n){e.enabled=!t.hasOwnProperty("enabled")||!!t.enabled,t.size&&(SK(t.size,eW)?e.size.copy(t.size):SK(t.size,Array)&&t.size.length>=3&&e.size.set(t.size[0],t.size[1],t.size[2]));},n.cloneComponent=function(e,t){var n={enabled:e.zone.enabled,size:e.zone.size};return this.addComponent(t,n)},n._onBeforeRemove=function(e,t){t._onBeforeRemove();},t}(mZ);mX._buildAccessors(SY.prototype,SQ);var S$=function(e,t){this.effect=e,this.inputTarget=t,this.outputTarget=null,this.name=e.constructor.name;},S0=function(){function e(e,t){this.app=e,this.camera=t,this.destinationRenderTarget=null,this.effects=[],this.enabled=false,this.depthTarget=null,t.on("set:rect",this.onCameraRectChanged,this);}var t=e.prototype;return t._allocateColorBuffer=function(e,t){var n,i,r=this.camera.rect,s=this.destinationRenderTarget,a=this.app.graphicsDevice,o=Math.floor(r.z*(null!=(n=null==s?void 0:s.width)?n:a.width)),l=Math.floor(r.w*(null!=(i=null==s?void 0:s.height)?i:a.height));return new nO(a,{name:t,format:e,width:o,height:l,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1})},t._createOffscreenTarget=function(e,t){var n,i,r=this.app.graphicsDevice,s=(null!=(n=this.destinationRenderTarget)?n:r.backBuffer).isColorBufferSrgb(0),a=null!=(i=t&&r.getRenderableHdrFormat([12,14],true))?i:s?20:7,o=this.camera.entity.name+"-posteffect-"+this.effects.length;return new il({colorBuffer:this._allocateColorBuffer(a,o),depth:e,stencil:e&&this.app.graphicsDevice.supportsStencil,samples:e?r.samples:1})},t._resizeOffscreenTarget=function(e){var t=e.colorBuffer.format,n=e.colorBuffer.name;e.destroyFrameBuffers(),e.destroyTextureBuffers(),e._colorBuffer=this._allocateColorBuffer(t,n),e._colorBuffers=[e._colorBuffer];},t._destroyOffscreenTarget=function(e){e.destroyTextureBuffers(),e.destroy();},t.addEffect=function(e){var t=this.effects,n=0===t.length,i=this._createOffscreenTarget(n,e.hdr),r=new S$(e,i);t.push(r),this._sourceTarget=r.inputTarget,t.length>1&&(t[t.length-2].outputTarget=r.inputTarget),this._newPostEffect=e,e.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0;},t.removeEffect=function(e){for(var t=-1,n=0,i=this.effects.length;n<i;n++)if(this.effects[n].effect===e){t=n;break}t>=0&&(t>0?this.effects[t-1].outputTarget=t+1<this.effects.length?this.effects[t+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(true,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[t].inputTarget),this.effects.splice(t,1)),this.enabled&&e.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable();},t._requestDepthMaps=function(){for(var e=0,t=this.effects.length;e<t;e++){var n=this.effects[e].effect;this._newPostEffect!==n&&n.needsDepthBuffer&&this._requestDepthMap();}},t._releaseDepthMaps=function(){for(var e=0,t=this.effects.length;e<t;e++)this.effects[e].effect.needsDepthBuffer&&this._releaseDepthMap();},t._requestDepthMap=function(){var e=this.app.scene.layers.getLayerById(1);e&&(e.incrementCounter(),this.camera.requestSceneDepthMap(true));},t._releaseDepthMap=function(){var e=this.app.scene.layers.getLayerById(1);e&&(e.decrementCounter(),this.camera.requestSceneDepthMap(false));},t.destroy=function(){for(var e=0,t=this.effects.length;e<t;e++)this.effects[e].inputTarget.destroy();this.effects.length=0,this.disable();},t.enable=function(){var e=this;!this.enabled&&this.effects.length&&(this.enabled=true,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=function(){if(e.enabled){var t=null,n=e.effects.length;if(n)for(var i=0;i<n;i++){var r=e.effects[i],s=r.outputTarget;i===n-1&&(t=e.camera.rect,e.destinationRenderTarget&&(s=e.destinationRenderTarget)),r.effect.render(r.inputTarget,s,t);}}});},t.disable=function(){this.enabled&&(this.enabled=false,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=this.destinationRenderTarget,this.camera.onPostprocessing=null);},t._onCanvasResized=function(e,t){var n,i,r=this.camera.rect,s=this.destinationRenderTarget;e=null!=(n=null==s?void 0:s.width)?n:e,t=null!=(i=null==s?void 0:s.height)?i:t,this.camera.camera.aspectRatio=e*r.z/(t*r.w),this.resizeRenderTargets();},t.resizeRenderTargets=function(){for(var e,t,n=this.app.graphicsDevice,i=this.destinationRenderTarget,r=null!=(e=null==i?void 0:i.width)?e:n.width,s=null!=(t=null==i?void 0:i.height)?t:n.height,a=this.camera.rect,o=Math.floor(a.z*r),l=Math.floor(a.w*s),u=this.effects,c=0,h=u.length;c<h;c++){var f=u[c];(f.inputTarget.width!==o||f.inputTarget.height!==l)&&this._resizeOffscreenTarget(f.inputTarget);}},t.onCameraRectChanged=function(e,t,n){this.enabled&&this.resizeRenderTargets();},e}();function S1(e,t){return (S1=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var S2=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n)||this).onPostprocessing=null,i._renderSceneDepthMap=0,i._renderSceneColorMap=0,i._sceneDepthMapRequested=false,i._sceneColorMapRequested=false,i._priority=0,i._disablePostEffectsLayer=4,i._camera=new lZ,i._evtLayersChanged=null,i._evtLayerAdded=null,i._evtLayerRemoved=null,i._camera.node=n,i._postEffects=new S0(t.app,i),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&S1(t,e);var n,i=t.prototype;return i.setShaderPass=function(e){var t=oW.get(this.system.app.graphicsDevice),n=e?t.allocate(e,{isForward:true}):null;return this._camera.shaderPassInfo=n,n.index},i.getShaderPass=function(){var e;return null==(e=this._camera.shaderPassInfo)?void 0:e.name},i._enableDepthLayer=function(e){if(this.layers.find(function(e){return 1===e})){var t=this.system.app.scene.layers.getLayerById(1);e?null==t||t.incrementCounter():null==t||t.decrementCounter();}else if(e)return  false;return  true},i.requestSceneColorMap=function(e){this._renderSceneColorMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassColorGrab(this.system.app.graphicsDevice,this.renderSceneColorMap),this.system.app.scene.layers.markDirty();},i.requestSceneDepthMap=function(e){this._renderSceneDepthMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassDepthGrab(this.system.app.graphicsDevice,this.system.app.renderer,this.renderSceneDepthMap),this.system.app.scene.layers.markDirty();},i.dirtyLayerCompositionCameras=function(){this.system.app.scene.layers._dirty=true;},i.screenToWorld=function(e,t,n,i){var r=this.system.app.graphicsDevice.clientRect,s=r.width,a=r.height;return this._camera.screenToWorld(e,t,n,s,a,i)},i.worldToScreen=function(e,t){var n=this.system.app.graphicsDevice.clientRect,i=n.width,r=n.height;return this._camera.worldToScreen(e,i,r,t)},i.onAppPrerender=function(){this._camera._viewMatDirty=true,this._camera._viewProjMatDirty=true;},i.addCameraToLayers=function(){for(var e=this.layers,t=0;t<e.length;t++){var n=this.system.app.scene.layers.getLayerById(e[t]);n&&n.addCamera(this);}},i.removeCameraFromLayers=function(){for(var e=this.layers,t=0;t<e.length;t++){var n=this.system.app.scene.layers.getLayerById(e[t]);n&&n.removeCamera(this);}},i.onLayersChanged=function(e,t){this.addCameraToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);},i.onLayerAdded=function(e){0>this.layers.indexOf(e.id)||e.addCamera(this);},i.onLayerRemoved=function(e){0>this.layers.indexOf(e.id)||e.removeCamera(this);},i.onEnable=function(){var e,t,n,i=this.system.app.scene,r=i.layers;this.system.addCamera(this),null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=i.on("set:layers",this.onLayersChanged,this),r&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=r.on("add",this.onLayerAdded,this),null==(n=this._evtLayerRemoved)||n.off(),this._evtLayerRemoved=r.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable();},i.onDisable=function(){var e,t,n,i=this.system.app.scene.layers;this.postEffects.disable(),this.removeCameraFromLayers(),null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,i&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(n=this._evtLayerRemoved)||n.off(),this._evtLayerRemoved=null),this.system.removeCamera(this);},i.onRemove=function(){this.onDisable(),this.off(),this.camera.destroy();},i.calculateAspectRatio=function(e){var t=this.system.app.graphicsDevice,n=e?e.width:t.width,i=e?e.height:t.height;return n*this.rect.z/(i*this.rect.w)},i.frameUpdate=function(e){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(e));},i.startXr=function(e,t,n){this.system.app.xr.start(this,e,t,n);},i.endXr=function(e){if(!this._camera.xr){e&&e(Error("Camera is not in XR"));return}this._camera.xr.end(e);},i.copy=function(e){this.aperture=e.aperture,this.aspectRatio=e.aspectRatio,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.disablePostEffectsLayer=e.disablePostEffectsLayer,this.farClip=e.farClip,this.flipFaces=e.flipFaces,this.fov=e.fov,this.frustumCulling=e.frustumCulling,this.horizontalFov=e.horizontalFov,this.layers=e.layers,this.nearClip=e.nearClip,this.orthoHeight=e.orthoHeight,this.priority=e.priority,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.sensitivity=e.sensitivity,this.shutter=e.shutter;},n=[{key:"renderPasses",get:function(){return this._camera.renderPasses},set:function(e){this._camera.renderPasses=e||[],this.dirtyLayerCompositionCameras(),this.system.app.scene.updateShaders=true;}},{key:"shaderParams",get:function(){return this._camera.shaderParams}},{key:"gammaCorrection",get:function(){return this.camera.shaderParams.gammaCorrection},set:function(e){this.camera.shaderParams.gammaCorrection=e;}},{key:"toneMapping",get:function(){return this.camera.shaderParams.toneMapping},set:function(e){this.camera.shaderParams.toneMapping=e;}},{key:"fog",get:function(){return this._camera.fogParams},set:function(e){this._camera.fogParams=e;}},{key:"aperture",get:function(){return this._camera.aperture},set:function(e){this._camera.aperture=e;}},{key:"aspectRatio",get:function(){return this._camera.aspectRatio},set:function(e){this._camera.aspectRatio=e;}},{key:"aspectRatioMode",get:function(){return this._camera.aspectRatioMode},set:function(e){this._camera.aspectRatioMode=e;}},{key:"calculateProjection",get:function(){return this._camera.calculateProjection},set:function(e){this._camera.calculateProjection=e;}},{key:"calculateTransform",get:function(){return this._camera.calculateTransform},set:function(e){this._camera.calculateTransform=e;}},{key:"camera",get:function(){return this._camera}},{key:"clearColor",get:function(){return this._camera.clearColor},set:function(e){this._camera.clearColor=e;}},{key:"clearColorBuffer",get:function(){return this._camera.clearColorBuffer},set:function(e){this._camera.clearColorBuffer=e,this.dirtyLayerCompositionCameras();}},{key:"clearDepthBuffer",get:function(){return this._camera.clearDepthBuffer},set:function(e){this._camera.clearDepthBuffer=e,this.dirtyLayerCompositionCameras();}},{key:"clearStencilBuffer",get:function(){return this._camera.clearStencilBuffer},set:function(e){this._camera.clearStencilBuffer=e,this.dirtyLayerCompositionCameras();}},{key:"cullFaces",get:function(){return this._camera.cullFaces},set:function(e){this._camera.cullFaces=e;}},{key:"disablePostEffectsLayer",get:function(){return this._disablePostEffectsLayer},set:function(e){this._disablePostEffectsLayer=e,this.dirtyLayerCompositionCameras();}},{key:"farClip",get:function(){return this._camera.farClip},set:function(e){this._camera.farClip=e;}},{key:"flipFaces",get:function(){return this._camera.flipFaces},set:function(e){this._camera.flipFaces=e;}},{key:"fov",get:function(){return this._camera.fov},set:function(e){this._camera.fov=e;}},{key:"frustum",get:function(){return this._camera.frustum}},{key:"frustumCulling",get:function(){return this._camera.frustumCulling},set:function(e){this._camera.frustumCulling=e;}},{key:"horizontalFov",get:function(){return this._camera.horizontalFov},set:function(e){this._camera.horizontalFov=e;}},{key:"layers",get:function(){return this._camera.layers},set:function(e){var t=this,n=this._camera.layers,i=this.system.app.scene;n.forEach(function(e){var n=i.layers.getLayerById(e);null==n||n.removeCamera(t);}),this._camera.layers=e,this.enabled&&this.entity.enabled&&e.forEach(function(e){var n=i.layers.getLayerById(e);null==n||n.addCamera(t);}),this.fire("set:layers");}},{key:"layersSet",get:function(){return this._camera.layersSet}},{key:"jitter",get:function(){return this._camera.jitter},set:function(e){this._camera.jitter=e;}},{key:"nearClip",get:function(){return this._camera.nearClip},set:function(e){this._camera.nearClip=e;}},{key:"orthoHeight",get:function(){return this._camera.orthoHeight},set:function(e){this._camera.orthoHeight=e;}},{key:"postEffects",get:function(){return this._postEffects}},{key:"postEffectsEnabled",get:function(){return this._postEffects.enabled}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this.dirtyLayerCompositionCameras();}},{key:"projection",get:function(){return this._camera.projection},set:function(e){this._camera.projection=e;}},{key:"projectionMatrix",get:function(){return this._camera.projectionMatrix}},{key:"rect",get:function(){return this._camera.rect},set:function(e){this._camera.rect=e,this.fire("set:rect",this._camera.rect);}},{key:"renderSceneColorMap",get:function(){return this._renderSceneColorMap>0},set:function(e){e&&!this._sceneColorMapRequested?(this.requestSceneColorMap(true),this._sceneColorMapRequested=true):this._sceneColorMapRequested&&(this.requestSceneColorMap(false),this._sceneColorMapRequested=false);}},{key:"renderSceneDepthMap",get:function(){return this._renderSceneDepthMap>0},set:function(e){e&&!this._sceneDepthMapRequested?(this.requestSceneDepthMap(true),this._sceneDepthMapRequested=true):this._sceneDepthMapRequested&&(this.requestSceneDepthMap(false),this._sceneDepthMapRequested=false);}},{key:"renderTarget",get:function(){return this._camera.renderTarget},set:function(e){this._camera.renderTarget=e,this.dirtyLayerCompositionCameras();}},{key:"scissorRect",get:function(){return this._camera.scissorRect},set:function(e){this._camera.scissorRect=e;}},{key:"sensitivity",get:function(){return this._camera.sensitivity},set:function(e){this._camera.sensitivity=e;}},{key:"shutter",get:function(){return this._camera.shutter},set:function(e){this._camera.shutter=e;}},{key:"viewMatrix",get:function(){return this._camera.viewMatrix}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX),S3=function(){this.enabled=true;};function S4(e,t){return (S4=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var S5=["enabled"],S8=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).cameras=[],n.id="camera",n.ComponentType=S2,n.DataType=S3,n.schema=S5,n.on("beforeremove",n.onBeforeRemove,n),n.app.on("prerender",n.onAppPrerender,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&S4(t,e);var n=t.prototype;return n.initializeComponentData=function(t,n,i){i=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","renderSceneColorMap","renderSceneDepthMap","cullFaces","farClip","flipFaces","fog","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect","aperture","shutter","sensitivity","gammaCorrection","toneMapping"];for(var r=0;r<i.length;r++){var s=i[r];if(n.hasOwnProperty(s)){var a=n[s];switch(s){case "rect":case "scissorRect":Array.isArray(a)?t[s]=new eY(a[0],a[1],a[2],a[3]):t[s]=a;break;case "clearColor":Array.isArray(a)?t[s]=new eN(a[0],a[1],a[2],a[3]):t[s]=a;break;default:t[s]=a;}}}e.prototype.initializeComponentData.call(this,t,n,["enabled"]);},n.cloneComponent=function(e,t){var n=e.camera;return this.addComponent(t,{aspectRatio:n.aspectRatio,aspectRatioMode:n.aspectRatioMode,calculateProjection:n.calculateProjection,calculateTransform:n.calculateTransform,clearColor:n.clearColor,clearColorBuffer:n.clearColorBuffer,clearDepthBuffer:n.clearDepthBuffer,clearStencilBuffer:n.clearStencilBuffer,renderSceneDepthMap:n.renderSceneDepthMap,renderSceneColorMap:n.renderSceneColorMap,cullFaces:n.cullFaces,enabled:n.enabled,farClip:n.farClip,flipFaces:n.flipFaces,fov:n.fov,frustumCulling:n.frustumCulling,horizontalFov:n.horizontalFov,layers:n.layers,renderTarget:n.renderTarget,nearClip:n.nearClip,orthoHeight:n.orthoHeight,projection:n.projection,priority:n.priority,rect:n.rect,scissorRect:n.scissorRect,aperture:n.aperture,sensitivity:n.sensitivity,shutter:n.shutter,gammaCorrection:n.gammaCorrection,toneMapping:n.toneMapping})},n.onBeforeRemove=function(e,t){this.removeCamera(t),t.onRemove();},n.onAppPrerender=function(){for(var e=0,t=this.cameras.length;e<t;e++)this.cameras[e].onAppPrerender();},n.addCamera=function(e){this.cameras.push(e),cq(this.cameras);},n.removeCamera=function(e){var t=this.cameras.indexOf(e);t>=0&&(this.cameras.splice(t,1),cq(this.cameras));},n.destroy=function(){this.app.off("prerender",this.onAppPrerender,this),e.prototype.destroy.call(this);},t}(mZ);mX._buildAccessors(S2.prototype,S5);var S6=function(){this.enabled=true,this.type="directional",this.color=new eN(1,1,1),this.intensity=1,this.luminance=0,this.shape=0,this.affectSpecularity=true,this.castShadows=false,this.shadowDistance=40,this.shadowIntensity=1,this.shadowResolution=1024,this.shadowBias=.05,this.numCascades=1,this.cascadeBlend=0,this.bakeNumSamples=1,this.bakeArea=0,this.cascadeDistribution=.5,this.normalOffsetBias=0,this.range=10,this.innerConeAngle=40,this.outerConeAngle=45,this.falloffMode=0,this.shadowType=0,this.vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this.cookieAsset=null,this.cookie=null,this.cookieIntensity=1,this.cookieFalloff=true,this.cookieChannel="rgb",this.cookieAngle=0,this.cookieScale=null,this.cookieOffset=null,this.shadowUpdateMode=2,this.mask=1,this.affectDynamic=true,this.affectLightmapped=false,this.bake=false,this.bakeDir=true,this.isStatic=false,this.layers=[0],this.penumbraSize=1,this.penumbraFalloff=1,this.shadowSamples=16,this.shadowBlockerSamples=16;},S9=Object.keys(new S6);function S7(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function xe(e,t){return (xe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var xt=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return t=e.apply(this,arguments)||this,t._evtLayersChanged=null,t._evtLayerAdded=null,t._evtLayerRemoved=null,t._cookieAsset=null,t._cookieAssetId=null,t._cookieAssetAdd=false,t._cookieMatrix=null,t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&xe(t,e);var n,i=t.prototype;return i._setValue=function(e,t,n,i){var r=this.data,s=r[e];(i||s!==t)&&(r[e]=t,n&&n.call(this,t,s));},i.addLightToLayers=function(){for(var e=0;e<this.layers.length;e++){var t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addLight(this),this.light.addLayer(t));}},i.removeLightFromLayers=function(){for(var e=0;e<this.layers.length;e++){var t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.removeLight(this),this.light.removeLayer(t));}},i.onLayersChanged=function(e,t){this.enabled&&this.entity.enabled&&this.addLightToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);},i.onLayerAdded=function(e){this.layers.indexOf(e.id)>=0&&this.enabled&&this.entity.enabled&&(e.addLight(this),this.light.addLayer(e));},i.onLayerRemoved=function(e){this.layers.indexOf(e.id)>=0&&(e.removeLight(this),this.light.removeLayer(e));},i.refreshProperties=function(){for(var e=0;e<S9.length;e++){var t=S9[e];this[t]=this[t];}this.enabled&&this.entity.enabled&&this.onEnable();},i.onCookieAssetSet=function(){var e=false;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=true,e=true),(!this._cookieAsset.resource||e)&&this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad();},i.onCookieAssetAdd=function(e){this._cookieAssetId===e.id&&(this._cookieAsset=e,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this));},i.onCookieAssetLoad=function(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource);},i.onCookieAssetRemove=function(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=false),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null);},i.onEnable=function(){var e=this.system.app.scene,t=e.layers;this.light.enabled=true,this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet();},i.onDisable=function(){var e,t,n,i=this.system.app.scene.layers;this.light.enabled=false,null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,i&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(n=this._evtLayerRemoved)||n.off(),this._evtLayerRemoved=null),this.removeLightFromLayers();},i.onRemove=function(){this.onDisable(),this.light.destroy(),this.cookieAsset=null;},n=[{key:"data",get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}},{key:"enabled",get:function(){return this.data.enabled},set:function(e){this._setValue("enabled",e,function(e,t){this.onSetEnabled(null,t,e);});}},{key:"light",get:function(){return this.data.light},set:function(e){this._setValue("light",e);}},{key:"type",get:function(){return this.data.type},set:function(e){this._setValue("type",e,function(e,t){this.system.changeType(this,t,e),this.refreshProperties();});}},{key:"color",get:function(){return this.data.color},set:function(e){this._setValue("color",e,function(e,t){this.light.setColor(e);},true);}},{key:"intensity",get:function(){return this.data.intensity},set:function(e){this._setValue("intensity",e,function(e,t){this.light.intensity=e;});}},{key:"luminance",get:function(){return this.data.luminance},set:function(e){this._setValue("luminance",e,function(e,t){this.light.luminance=e;});}},{key:"shape",get:function(){return this.data.shape},set:function(e){this._setValue("shape",e,function(e,t){this.light.shape=e;});}},{key:"affectSpecularity",get:function(){return this.data.affectSpecularity},set:function(e){this._setValue("affectSpecularity",e,function(e,t){this.light.affectSpecularity=e;});}},{key:"castShadows",get:function(){return this.data.castShadows},set:function(e){this._setValue("castShadows",e,function(e,t){this.light.castShadows=e;});}},{key:"shadowDistance",get:function(){return this.data.shadowDistance},set:function(e){this._setValue("shadowDistance",e,function(e,t){this.light.shadowDistance=e;});}},{key:"shadowIntensity",get:function(){return this.data.shadowIntensity},set:function(e){this._setValue("shadowIntensity",e,function(e,t){this.light.shadowIntensity=e;});}},{key:"shadowResolution",get:function(){return this.data.shadowResolution},set:function(e){this._setValue("shadowResolution",e,function(e,t){this.light.shadowResolution=e;});}},{key:"shadowBias",get:function(){return this.data.shadowBias},set:function(e){this._setValue("shadowBias",e,function(e,t){this.light.shadowBias=-0.01*ek.clamp(e,0,1);});}},{key:"numCascades",get:function(){return this.data.numCascades},set:function(e){this._setValue("numCascades",e,function(e,t){this.light.numCascades=ek.clamp(Math.floor(e),1,4);});}},{key:"cascadeBlend",get:function(){return this.data.cascadeBlend},set:function(e){this._setValue("cascadeBlend",e,function(e,t){this.light.cascadeBlend=ek.clamp(e,0,1);});}},{key:"bakeNumSamples",get:function(){return this.data.bakeNumSamples},set:function(e){this._setValue("bakeNumSamples",e,function(e,t){this.light.bakeNumSamples=ek.clamp(Math.floor(e),1,255);});}},{key:"bakeArea",get:function(){return this.data.bakeArea},set:function(e){this._setValue("bakeArea",e,function(e,t){this.light.bakeArea=ek.clamp(e,0,180);});}},{key:"cascadeDistribution",get:function(){return this.data.cascadeDistribution},set:function(e){this._setValue("cascadeDistribution",e,function(e,t){this.light.cascadeDistribution=ek.clamp(e,0,1);});}},{key:"normalOffsetBias",get:function(){return this.data.normalOffsetBias},set:function(e){this._setValue("normalOffsetBias",e,function(e,t){this.light.normalOffsetBias=ek.clamp(e,0,1);});}},{key:"range",get:function(){return this.data.range},set:function(e){this._setValue("range",e,function(e,t){this.light.attenuationEnd=e;});}},{key:"innerConeAngle",get:function(){return this.data.innerConeAngle},set:function(e){this._setValue("innerConeAngle",e,function(e,t){this.light.innerConeAngle=e;});}},{key:"outerConeAngle",get:function(){return this.data.outerConeAngle},set:function(e){this._setValue("outerConeAngle",e,function(e,t){this.light.outerConeAngle=e;});}},{key:"falloffMode",get:function(){return this.data.falloffMode},set:function(e){this._setValue("falloffMode",e,function(e,t){this.light.falloffMode=e;});}},{key:"shadowType",get:function(){return this.data.shadowType},set:function(e){this._setValue("shadowType",e,function(e,t){this.light.shadowType=e;});}},{key:"vsmBlurSize",get:function(){return this.data.vsmBlurSize},set:function(e){this._setValue("vsmBlurSize",e,function(e,t){this.light.vsmBlurSize=e;});}},{key:"vsmBlurMode",get:function(){return this.data.vsmBlurMode},set:function(e){this._setValue("vsmBlurMode",e,function(e,t){this.light.vsmBlurMode=e;});}},{key:"vsmBias",get:function(){return this.data.vsmBias},set:function(e){this._setValue("vsmBias",e,function(e,t){this.light.vsmBias=ek.clamp(e,0,1);});}},{key:"cookieAsset",get:function(){return this.data.cookieAsset},set:function(e){this._setValue("cookieAsset",e,function(e,t){if(!(this._cookieAssetId&&(S7(e,pZ)&&e.id===this._cookieAssetId||e===this._cookieAssetId))){if(this.onCookieAssetRemove(),this._cookieAssetId=null,S7(e,pZ))this.data.cookieAsset=e.id,this._cookieAssetId=e.id,this.onCookieAssetAdd(e);else if("number"==typeof e){this._cookieAssetId=e;var n=this.system.app.assets.get(e);n?this.onCookieAssetAdd(n):(this._cookieAssetAdd=true,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this));}}});}},{key:"cookie",get:function(){return this.data.cookie},set:function(e){this._setValue("cookie",e,function(e,t){this.light.cookie=e;});}},{key:"cookieIntensity",get:function(){return this.data.cookieIntensity},set:function(e){this._setValue("cookieIntensity",e,function(e,t){this.light.cookieIntensity=ek.clamp(e,0,1);});}},{key:"cookieFalloff",get:function(){return this.data.cookieFalloff},set:function(e){this._setValue("cookieFalloff",e,function(e,t){this.light.cookieFalloff=e;});}},{key:"cookieChannel",get:function(){return this.data.cookieChannel},set:function(e){this._setValue("cookieChannel",e,function(e,t){this.light.cookieChannel=e;});}},{key:"cookieAngle",get:function(){return this.data.cookieAngle},set:function(e){this._setValue("cookieAngle",e,function(e,t){if(0!==e||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new eY);var n=1,i=1;this.cookieScale&&(n=this.cookieScale.x,i=this.cookieScale.y);var r=Math.cos(e*ek.DEG_TO_RAD),s=Math.sin(e*ek.DEG_TO_RAD);this._cookieMatrix.set(r/n,-s/n,s/i,r/i),this.light.cookieTransform=this._cookieMatrix;}else this.light.cookieTransform=null;});}},{key:"cookieScale",get:function(){return this.data.cookieScale},set:function(e){this._setValue("cookieScale",e,function(e,t){if(null!==e||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new eY);var n=e.x,i=e.y,r=Math.cos(this.cookieAngle*ek.DEG_TO_RAD),s=Math.sin(this.cookieAngle*ek.DEG_TO_RAD);this._cookieMatrix.set(r/n,-s/n,s/i,r/i),this.light.cookieTransform=this._cookieMatrix;}else this.light.cookieTransform=null;},true);}},{key:"cookieOffset",get:function(){return this.data.cookieOffset},set:function(e){this._setValue("cookieOffset",e,function(e,t){this.light.cookieOffset=e;},true);}},{key:"shadowUpdateMode",get:function(){return this.data.shadowUpdateMode},set:function(e){this._setValue("shadowUpdateMode",e,function(e,t){this.light.shadowUpdateMode=e;},true);}},{key:"mask",get:function(){return this.data.mask},set:function(e){this._setValue("mask",e,function(e,t){this.light.mask=e;});}},{key:"affectDynamic",get:function(){return this.data.affectDynamic},set:function(e){this._setValue("affectDynamic",e,function(e,t){e?this.light.mask|=1:this.light.mask&=-2,this.light.layersDirty();});}},{key:"affectLightmapped",get:function(){return this.data.affectLightmapped},set:function(e){this._setValue("affectLightmapped",e,function(e,t){e?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4));});}},{key:"bake",get:function(){return this.data.bake},set:function(e){this._setValue("bake",e,function(e,t){e?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2)),this.light.layersDirty();});}},{key:"bakeDir",get:function(){return this.data.bakeDir},set:function(e){this._setValue("bakeDir",e,function(e,t){this.light.bakeDir=e;});}},{key:"isStatic",get:function(){return this.data.isStatic},set:function(e){this._setValue("isStatic",e,function(e,t){this.light.isStatic=e;});}},{key:"layers",get:function(){return this.data.layers},set:function(e){this._setValue("layers",e,function(e,t){for(var n=0;n<t.length;n++){var i=this.system.app.scene.layers.getLayerById(t[n]);i&&(i.removeLight(this),this.light.removeLayer(i));}for(var r=0;r<e.length;r++){var s=this.system.app.scene.layers.getLayerById(e[r]);s&&this.enabled&&this.entity.enabled&&(s.addLight(this),this.light.addLayer(s));}});}},{key:"shadowUpdateOverrides",get:function(){return this.light.shadowUpdateOverrides},set:function(e){this.light.shadowUpdateOverrides=e;}},{key:"shadowSamples",get:function(){return this.light.shadowSamples},set:function(e){this.light.shadowSamples=e;}},{key:"shadowBlockerSamples",get:function(){return this.light.shadowBlockerSamples},set:function(e){this.light.shadowBlockerSamples=e;}},{key:"penumbraSize",get:function(){return this.light.penumbraSize},set:function(e){this.light.penumbraSize=e;}},{key:"penumbraFalloff",get:function(){return this.light.penumbraFalloff},set:function(e){this.light.penumbraFalloff=e;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX);function xn(){return (xn=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);}return e}).apply(this,arguments)}function xi(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function xr(e,t){return (xr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var xs=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).id="light",n.ComponentType=xt,n.DataType=S6,n.on("beforeremove",n._onRemoveComponent,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&xr(t,e);var n=t.prototype;return n.initializeComponentData=function(t,n){var i=xn({},n);i.type||(i.type=t.data.type),t.data.type=i.type,i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0)),i.color&&Array.isArray(i.color)&&(i.color=new eN(i.color[0],i.color[1],i.color[2])),i.cookieOffset&&xi(i.cookieOffset,Array)&&(i.cookieOffset=new eX(i.cookieOffset[0],i.cookieOffset[1])),i.cookieScale&&xi(i.cookieScale,Array)&&(i.cookieScale=new eX(i.cookieScale[0],i.cookieScale[1])),i.enable&&(i.enabled=i.enable),i.shape||(i.shape=0);var r=new c6(this.app.graphicsDevice,this.app.scene.clusteredLightingEnabled);r.type=c2[i.type],r._node=t.entity,t.data.light=r,e.prototype.initializeComponentData.call(this,t,i,S9);},n._onRemoveComponent=function(e,t){t.onRemove();},n.cloneComponent=function(e,t){for(var n,i=e.light,r=[],s=0;s<S9.length;s++)"light"!==(n=S9[s])&&(i[n]&&i[n].clone?r[n]=i[n].clone():r[n]=i[n]);return this.addComponent(t,r)},n.changeType=function(e,t,n){t!==n&&(e.light.type=c2[n]);},t}(mZ);function xa(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}var xo=["x","y","z","w"],xl=[void 0,void 0,eX,eW,eY];function xu(e,t,n,i){switch(t.type){case "boolean":return !!n;case "number":if("number"==typeof n)break;if("string"==typeof n){var r,s=parseInt(n,10);if(isNaN(s))return null;return s}if("boolean"==typeof n)return 0+n;return null;case "json":var a,o={};if(Array.isArray(t.schema)){n&&(void 0===n?"undefined":(a=n)&&"undefined"!=typeof Symbol&&a.constructor===Symbol?"symbol":typeof a)=="object"||(n={});for(var l=0;l<t.schema.length;l++){var u=t.schema[l];if(u.name)if(u.array){o[u.name]=[];for(var c=Array.isArray(n[u.name])?n[u.name]:[],h=0;h<c.length;h++)o[u.name].push(xu(e,u,c[h]));}else {var f=n.hasOwnProperty(u.name)?n[u.name]:u.default;o[u.name]=xu(e,u,f);}}}return o;case "asset":if(xa(n,pZ))break;if("number"==typeof n)return e.assets.get(n)||null;if("string"==typeof n)return e.assets.get(parseInt(n,10))||null;return null;case "entity":if(xa(n,us))break;if("string"==typeof n)return e.getEntityFromIndex(n);return null;case "rgb":case "rgba":if(xa(n,eN)){if(xa(i,eN))return i.copy(n),i;return n.clone()}if(xa(n,Array)&&n.length>=3&&n.length<=4){for(var d=0;d<n.length;d++)if("number"!=typeof n[d])return null;return i||(i=new eN),i.r=n[0],i.g=n[1],i.b=n[2],i.a=3===n.length?1:n[3],i}if("string"==typeof n&&/#(?:[0-9a-f]{2}){3,4}/i.test(n))return i||(i=new eN),i.fromString(n),i;return null;case "vec2":case "vec3":case "vec4":var p=parseInt(t.type.slice(3),10),m=xl[p];if(xa(n,m)){if(xa(i,m))return i.copy(n),i;return n.clone()}if(xa(n,Array)&&n.length===p){for(var _=0;_<n.length;_++)if("number"!=typeof n[_])return null;i||(i=new m);for(var v=0;v<p;v++)i[xo[v]]=n[v];return i}return null;case "curve":if(n)return xa(n,eB)||xa(n,eU)?r=n.clone():(r=new(xa(n.keys[0],Array)?eU:eB)(n.keys)).type=n.type,r}return n}function xc(e,t,n,i){return t.array?n.map(function(n,r){return xu(e,t,n,i?i[r]:null)}):xu(e,t,n,i)}function xh(e,t,n,i){if(n)for(var r in t){var s=t[r],a=n[r];void 0!==a&&(i[r]=xc(e,s,a,i[r]));}}var xf=function(){function e(e){this.scriptType=e,this.index={};}var t=e.prototype;return t.add=function(t,n){if(!this.index[t])e.reservedNames.has(t)||(this.index[t]=n,Object.defineProperty(this.scriptType.prototype,t,{get:function(){return this.__attributes[t]},set:function(e){var i="attr",r="attr:"+t,s=this.__attributes[t],a=s;if(s&&"json"!==n.type&&"entity"!==n.type&&s.clone&&(this.hasEvent(i)||this.hasEvent(r))&&(a=s.clone()),n.array){if(this.__attributes[t]=[],e)for(var o=0,l=e.length;o<l;o++)this.__attributes[t].push(xu(this.app,n,e[o],s?s[o]:null));}else this.__attributes[t]=xu(this.app,n,e,s);this.fire(i,t,this.__attributes[t],a),this.fire(r,this.__attributes[t],a);}}));},t.remove=function(e){return !!this.index[e]&&(delete this.index[e],delete this.scriptType.prototype[e],true)},t.has=function(e){return !!this.index[e]},t.get=function(e){return this.index[e]||null},e}();xf.assignAttributesToScript=xh,xf.attributeToValue=xc,xf.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"]);var xd="initialize",xp="postInitialize";function xm(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}function x_(e,t){return (x_=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var xv=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function i(t){var n;return (n=e.call(this)||this).initScript(t),n}return i.prototype=Object.create(e&&e.prototype,{constructor:{value:i,writable:true,configurable:true}}),e&&x_(i,e),i.prototype.initScript=function(e){var t=this.constructor;this.app=e.app,this.entity=e.entity,this._enabled="boolean"!=typeof e.enabled||e.enabled,this._enabledOld=this.enabled,this.__destroyed=false,this.__scriptType=t,this.__executionOrder=-1;},n=[{key:"scriptName",get:function(){return this.__name}}],t=[{key:"enabled",get:function(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled},set:function(e){this._enabled=!!e,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=true,this.fire("preInitialize"),this.initialize&&this.entity.script._scriptMethod(this,xd)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=true,this.postInitialize&&this.entity.script._scriptMethod(this,xp)));}}],xm(i.prototype,t),n&&xm(i,n),i}(ex);xv.EVENT_ENABLE="enable",xv.EVENT_DISABLE="disable",xv.EVENT_STATE="state",xv.EVENT_DESTROY="destroy",xv.EVENT_ATTR="attr",xv.EVENT_ERROR="error",xv.__name=null,xv.__getScriptName=xy;var xg=/^\s*function(?:\s|\s*\/\*.*\*\/\s*)+([^(\s\/]*)\s*/;function xy(e){if("function"==typeof e){if(e.scriptName)return e.scriptName;if("name"in Function.prototype)return e.name;if(e===Function||e===Function.prototype.constructor)return "Function";var t=(""+e).match(xg);return t?t[1]:void 0}}function xS(e,t){return (xS=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var xx=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).initScriptType(t),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&xS(t,e);var n=t.prototype;return n.initScript=function(e){xv.prototype.initScript.call(this,e),this.__attributes={},this.__attributesRaw=e.attributes||{};},n.initScriptType=function(e){this.initScript(e);},n.__initializeAttributes=function(e){if(e||this.__attributesRaw){for(var t in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(t)?this[t]=this.__attributesRaw[t]:this.__attributes.hasOwnProperty(t)||(this.__scriptType.attributes.index[t].hasOwnProperty("default")?this[t]=this.__scriptType.attributes.index[t].default:this[t]=null);this.__attributesRaw=null;}},t.extend=function(e){for(var t in e)e.hasOwnProperty(t)&&(this.prototype[t]=e[t]);},function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t,[{key:"attributes",get:function(){return this.hasOwnProperty("__attributes")||(this.__attributes=new xf(this)),this.__attributes}}]),t}(xv);function xb(){return (xb=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);}return e}).apply(this,arguments)}function xT(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function xE(e,t){return (xE=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function xw(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}var xA=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n)||this)._attributeDataMap=new Map,i._scripts=[],i._updateList=new eC({sortBy:"__executionOrder"}),i._postUpdateList=new eC({sortBy:"__executionOrder"}),i._scriptsIndex={},i._destroyedScripts=[],i._destroyed=false,i._scriptsData=null,i._oldState=true,i._enabled=true,i._beingEnabled=false,i._isLoopingThroughScripts=false,i._executionOrder=-1,i.on("set_enabled",i._onSetEnabled,i),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&xE(t,e);var n,i=t.prototype;return i.onEnable=function(){this._beingEnabled=true,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=false;},i.onDisable=function(){this._checkState();},i.onPostStateChange=function(){for(var e=this._beginLooping(),t=0,n=this.scripts.length;t<n;t++){var i=this.scripts[t];i._initialized&&!i._postInitialized&&i.enabled&&(i._postInitialized=true,i.postInitialize&&this._scriptMethod(i,xp));}this._endLooping(e);},i._beginLooping=function(){var e=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=true,e},i._endLooping=function(e){this._isLoopingThroughScripts=e,this._isLoopingThroughScripts||this._removeDestroyedScripts();},i._onSetEnabled=function(e,t,n){this._beingEnabled=true,this._checkState(),this._beingEnabled=false;},i._checkState=function(){var e,t=this,n=this.enabled&&this.entity.enabled;if(n!==this._oldState){this._oldState=n,this.fire(n?"enable":"disable"),this.fire("state",n),n?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);for(var i=this._beginLooping(),r=0,s=this.scripts.length;r<s;r++)e=this,function(n,i){var r=e.scripts[n];r.once("preInitialize",function(){t.initializeAttributes(r);}),r.enabled=r._enabled;}(r);this._endLooping(i);}},i._onBeforeRemove=function(){this.fire("remove");for(var e=this._beginLooping(),t=0;t<this.scripts.length;t++){var n=this.scripts[t];n&&this.destroy(n.__scriptType.__name);}this._endLooping(e);},i._removeDestroyedScripts=function(){var e=this._destroyedScripts.length;if(e){for(var t=0;t<e;t++){var n=this._destroyedScripts[t];this._removeScriptInstance(n);}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length);}},i._onInitializeAttributes=function(){for(var e=0,t=this.scripts.length;e<t;e++){var n=this.scripts[e];this.initializeAttributes(n);}},i.initializeAttributes=function(e){if(xT(e,xx))e.__initializeAttributes();else {var t,n=e.__scriptType.__name,i=this._attributeDataMap.get(n);if(!i)return;var r=null==(t=this.system.app.scripts)?void 0:t.getSchema(n);xh(this.system.app,r.attributes,i,e);}},i._scriptMethod=function(e,t,n){e[t](n);},i._onInitialize=function(){for(var e=this._scripts,t=this._beginLooping(),n=0,i=e.length;n<i;n++){var r=e[n];!r._initialized&&r.enabled&&(r._initialized=true,r.initialize&&this._scriptMethod(r,xd));}this._endLooping(t);},i._onPostInitialize=function(){this.onPostStateChange();},i._onUpdate=function(e){var t=this._updateList;if(t.length){var n=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){var i=t.items[t.loopIndex];i.enabled&&this._scriptMethod(i,"update",e);}this._endLooping(n);}},i._onPostUpdate=function(e){var t=this._postUpdateList;if(t.length){var n=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){var i=t.items[t.loopIndex];i.enabled&&this._scriptMethod(i,"postUpdate",e);}this._endLooping(n);}},i._insertScriptInstance=function(e,t,n){ -1===t?(this._scripts.push(e),e.__executionOrder=n,e.update&&this._updateList.append(e),e.postUpdate&&this._postUpdateList.append(e)):(this._scripts.splice(t,0,e),e.__executionOrder=t,this._resetExecutionOrder(t+1,n+1),e.update&&this._updateList.insert(e),e.postUpdate&&this._postUpdateList.insert(e));},i._removeScriptInstance=function(e){var t=this._scripts.indexOf(e);return -1===t||(this._scripts.splice(t,1),e.update&&this._updateList.remove(e),e.postUpdate&&this._postUpdateList.remove(e)),t},i._resetExecutionOrder=function(e,t){for(var n=e;n<t;n++)this._scripts[n].__executionOrder=n;},i._resolveEntityScriptAttribute=function(e,t,n,i,r,s){if(e.array){var a=n.length;if(a){for(var o=n.slice(),l=0;l<a;l++){var u=xT(o[l],my)?o[l].getGuid():o[l];s[u]&&(o[l]=i?s[u].getGuid():s[u]);}r[t]=o;}}else {if(xT(n,my))n=n.getGuid();else if("string"!=typeof n)return;s[n]&&(r[t]=s[n]);}},i.has=function(e){if("string"==typeof e)return !!this._scriptsIndex[e];if(!e)return  false;var t=e.__name,n=this._scriptsIndex[t];return xT(n&&n.instance,e)},i.get=function(e){if("string"==typeof e){var t=this._scriptsIndex[e];return t?t.instance:null}if(!e)return null;var n=e.__name,i=this._scriptsIndex[n],r=i&&i.instance;return xT(r,e)?r:null},i.create=function(e,t){ void 0===t&&(t={});var n=this,i=e,r=e;if("string"==typeof i)i=this.system.app.scripts.get(i);else if(i){var s,a,o,l=(o=xy(i))[0].toLowerCase()+o.substring(1);xT(i.prototype,xx)||i.scriptName,null!=(s=i).__name||(s.__name=null!=(a=i.scriptName)?a:l),r=i.__name;}if(i){if(!this._scriptsIndex[r]||!this._scriptsIndex[r].instance){var u=new i({app:this.system.app,entity:this.entity,enabled:!t.hasOwnProperty("enabled")||t.enabled,attributes:t.attributes||{}});t.properties&&"object"===xw(t.properties)&&Object.assign(u,t.properties),!xT(u,xx)&&t.attributes&&this._attributeDataMap.set(r,xb({},t.attributes));var c=this._scripts.length,h=-1;return "number"==typeof t.ind&&-1!==t.ind&&c>t.ind&&(h=t.ind),this._insertScriptInstance(u,h,c),this._scriptsIndex[r]={instance:u,onSwap:function(){n.swap(r);}},this[r]=u,t.preloading||this.initializeAttributes(u),this.fire("create",r,u),this.fire("create:"+r,u),this.system.app.scripts.on("swap:"+r,this._scriptsIndex[r].onSwap),!t.preloading&&(u.enabled&&!u._initialized&&(u._initialized=true,u.initialize&&this._scriptMethod(u,xd)),u.enabled&&!u._postInitialized&&(u._postInitialized=true,u.postInitialize&&this._scriptMethod(u,xp))),u}}else this._scriptsIndex[r]={awaiting:true,ind:this._scripts.length};return null},i.destroy=function(e){var t=e,n=e;"string"==typeof n?n=this.system.app.scripts.get(n):n&&(t=n.__name);var i=this._scriptsIndex[t];if(delete this._scriptsIndex[t],!i)return  false;this._attributeDataMap.delete(t);var r=i.instance;if(r&&!r._destroyed)if(r.enabled=false,r._destroyed=true,this._isLoopingThroughScripts)this._destroyedScripts.push(r);else {var s=this._removeScriptInstance(r);s>=0&&this._resetExecutionOrder(s,this._scripts.length);}return this.system.app.scripts.off("swap:"+t,i.onSwap),delete this[t],this.fire("destroy",t,r||null),this.fire("destroy:"+t,r||null),r&&r.fire("destroy"),true},i.swap=function(e){var t=e,n=e;"string"==typeof n?n=this.system.app.scripts.get(n):n&&(t=n.__name);var i=this._scriptsIndex[t];if(!i||!i.instance)return  false;var r=i.instance,s=this._scripts.indexOf(r),a=new n({app:this.system.app,entity:this.entity,enabled:r.enabled,attributes:r.__attributes});return !!a.swap&&(this.initializeAttributes(a),this._scripts[s]=a,this._scriptsIndex[t].instance=a,this[t]=a,a.__executionOrder=s,r.update&&this._updateList.remove(r),r.postUpdate&&this._postUpdateList.remove(r),a.update&&this._updateList.insert(a),a.postUpdate&&this._postUpdateList.insert(a),this._scriptMethod(a,"swap",r),this.fire("swap",t,a),this.fire("swap:"+t,a),true)},i.resolveDuplicatedEntityReferenceProperties=function(e,t){var n=this.entity.script;for(var i in e._scriptsIndex){var r=this.system.app.scripts.get(i);if(r){var s=e._scriptsIndex[i];if(s&&s.instance){var a=null!=(h=n[i].__attributesRaw)?h:n._attributeDataMap.get(i),o=n[i].__attributes;if(a||o){var l=!!a,u=null!=(f=s.instance.__attributes)?f:n._attributeDataMap.get(i);for(var c in u)if(u[c]){var h,f,d,p,m,_,v=null!=(_=null==(d=r.attributes)?void 0:d.get(c))?_:null==(m=this.system.app.scripts.getSchema(i))||null==(p=m.attributes)?void 0:p[c];if(v){if("entity"===v.type)this._resolveEntityScriptAttribute(v,c,u[c],l,a||o,t);else if("json"===v.type&&Array.isArray(v.schema))for(var g=u[c],y=a?a[c]:o[c],S=0;S<v.schema.length;S++){var x=v.schema[S];if("entity"===x.type)if(v.array)for(var b=0;b<g.length;b++)this._resolveEntityScriptAttribute(x,x.name,g[b][x.name],l,y[b],t);else this._resolveEntityScriptAttribute(x,x.name,g[x.name],l,y,t);}}}}}}}},i.move=function(e,t){var n=this._scripts.length;if(t>=n||t<0)return  false;var i=e,r=e;"string"!=typeof r?r=e.__name:i=null;var s=this._scriptsIndex[r];if(!s||!s.instance)return  false;var a=s.instance;if(i&&!xT(a,i))return  false;var o=this._scripts.indexOf(a);return -1!==o&&o!==t&&(this._scripts.splice(t,0,this._scripts.splice(o,1)[0]),this._resetExecutionOrder(0,n),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",r,a,t,o),this.fire("move:"+r,a,t,o),true)},n=[{key:"scripts",get:function(){return this._scripts},set:function(e){var t,n=this;for(var i in this._scriptsData=e,e)t=this,function(i){if(e.hasOwnProperty(i)){var r=t._scriptsIndex[i];if(r&&("boolean"==typeof e[i].enabled&&(r.once("preInitialize",function(){n.initializeAttributes(r);}),r.enabled=!!e[i].enabled),"object"===xw(e[i].attributes))){for(var s in e[i].attributes)if(!xf.reservedNames.has(s)){if(!r.__attributes.hasOwnProperty(s)){var a=t.system.app.scripts.get(i);a&&a.attributes.add(s,{});}r[s]=e[i].attributes[s];}}}}(i);}},{key:"enabled",get:function(){return this._enabled},set:function(e){var t=this._enabled;this._enabled=e,this.fire("set","enabled",t,e);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX);xA.EVENT_CREATE="create",xA.EVENT_DESTROY="destroy",xA.EVENT_ENABLE="enable",xA.EVENT_DISABLE="disable",xA.EVENT_REMOVE="remove",xA.EVENT_STATE="state",xA.EVENT_MOVE="move",xA.EVENT_ERROR="error";var xC=function(){this.enabled=true;};function xP(e,t){return (xP=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var xI=0,xL=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t)||this).id="script",n.ComponentType=xA,n.DataType=xC,n._components=new eC({sortBy:"_executionOrder"}),n._enabledComponents=new eC({sortBy:"_executionOrder"}),n.preloading=true,n.on("beforeremove",n._onBeforeRemove,n),n.app.systems.on("initialize",n._onInitialize,n),n.app.systems.on("postInitialize",n._onPostInitialize,n),n.app.systems.on("update",n._onUpdate,n),n.app.systems.on("postUpdate",n._onPostUpdate,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&xP(t,e);var n=t.prototype;return n.initializeComponentData=function(e,t){if(e._executionOrder=xI++,this._components.append(e),xI>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),e.enabled=!t.hasOwnProperty("enabled")||!!t.enabled,e.enabled&&e.entity.enabled&&this._enabledComponents.append(e),t.hasOwnProperty("order")&&t.hasOwnProperty("scripts")){e._scriptsData=t.scripts;for(var n=0;n<t.order.length;n++)e.create(t.order[n],{enabled:t.scripts[t.order[n]].enabled,attributes:t.scripts[t.order[n]].attributes,preloading:this.preloading});}},n.cloneComponent=function(e,t){for(var n=[],i={},r=0;r<e.script._scripts.length;r++){var s,a=e.script._scripts[r],o=a.__scriptType.__name;n.push(o);var l=(null==(s=e.script._attributeDataMap)?void 0:s.get(o))||{};for(var u in a.__attributes)l[u]=a.__attributes[u];i[o]={enabled:a._enabled,attributes:l};}for(var c in e.script._scriptsIndex)c.awaiting&&n.splice(c.ind,0,c);var h={enabled:e.script.enabled,order:n,scripts:i};return this.addComponent(t,h)},n._resetExecutionOrder=function(){xI=0;for(var e=0,t=this._components.length;e<t;e++)this._components.items[e]._executionOrder=xI++;},n._callComponentMethod=function(e,t,n){for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++)e.items[e.loopIndex][t](n);},n._onInitialize=function(){this.preloading=false,this._callComponentMethod(this._components,"_onInitializeAttributes"),this._callComponentMethod(this._enabledComponents,"_onInitialize");},n._onPostInitialize=function(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize");},n._onUpdate=function(e){this._callComponentMethod(this._enabledComponents,"_onUpdate",e);},n._onPostUpdate=function(e){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",e);},n._addComponentToEnabled=function(e){this._enabledComponents.insert(e);},n._removeComponentFromEnabled=function(e){this._enabledComponents.remove(e);},n._onBeforeRemove=function(e,t){this._components.items.indexOf(t)>=0&&t._onBeforeRemove(),this._removeComponentFromEnabled(t),this._components.remove(t);},n.destroy=function(){e.prototype.destroy.call(this),this.app.systems.off("initialize",this._onInitialize,this),this.app.systems.off("postInitialize",this._onPostInitialize,this),this.app.systems.off("update",this._onUpdate,this),this.app.systems.off("postUpdate",this._onPostUpdate,this);},t}(mZ),xD=function(){function e(e){this.texture=null,this.rt=null,this.intervalsDataTexture=null,this.shader=null,this.device=e;}var t=e.prototype;return t.destroy=function(){var e,t,n;null==(e=this.texture)||e.destroy(),this.texture=null,null==(t=this.rt)||t.destroy(),this.rt=null,null==(n=this.intervalsDataTexture)||n.destroy(),this.intervalsDataTexture=null,this.shader=null;},t.getShader=function(){return this.shader||(this.shader=o8.createShader(this.device,{uniqueName:"GSplatIntervalsShader",attributes:{aPosition:tT},vertexChunk:"quadVS",fragmentGLSL:"\nprecision highp usampler2D;\nuniform usampler2D uIntervalsTexture;\nuniform int uNumIntervals;\nuniform int uTextureWidth;\nuniform int uActiveSplats;\nivec2 getCoordFromIndex(int index, int textureWidth) {\n	return ivec2(index % textureWidth, index / textureWidth);\n}\nvoid main() {\n	ivec2 coord = ivec2(gl_FragCoord.xy);\n	int targetIndex = coord.y * uTextureWidth + coord.x;\n	\n	if (targetIndex >= uActiveSplats) {\n		gl_FragColor = 0u;\n		return;\n	}\n	\n	int left = 0;\n	int right = uNumIntervals - 1;\n	int intervalIndex = 0;\n	\n	while (left <= right) {\n		int mid = (left + right) / 2;\n		\n		int textureWidth = textureSize(uIntervalsTexture, 0).x;\n		ivec2 intervalCoord = getCoordFromIndex(mid, textureWidth);\n		uvec2 intervalData = texelFetch(uIntervalsTexture, intervalCoord, 0).rg;\n		\n		uint accumulatedSum = intervalData.g;\n		\n		if (uint(targetIndex) < accumulatedSum) {\n			intervalIndex = mid;\n			right = mid - 1;\n		} else {\n			left = mid + 1;\n		}\n	}\n	\n	int textureWidth = textureSize(uIntervalsTexture, 0).x;\n	ivec2 intervalCoord = getCoordFromIndex(intervalIndex, textureWidth);\n	uvec2 intervalData = texelFetch(uIntervalsTexture, intervalCoord, 0).rg;\n	\n	uint intervalStart = intervalData.r;\n	uint currentAccSum = intervalData.g;\n	\n	uint prevAccSum = 0u;\n	if (intervalIndex > 0) {\n		ivec2 prevCoord = getCoordFromIndex(intervalIndex - 1, textureWidth);\n		prevAccSum = texelFetch(uIntervalsTexture, prevCoord, 0).g;\n	}\n	\n	uint offsetInInterval = uint(targetIndex) - prevAccSum;\n	uint originalIndex = intervalStart + offsetInInterval;\n	\n	gl_FragColor = originalIndex;\n}\n",fragmentWGSL:"\nvar uIntervalsTexture: texture_2d<u32>;\nuniform uNumIntervals: i32;\nuniform uTextureWidth: i32;\nuniform uActiveSplats: i32;\nfn getCoordFromIndex(index: i32, textureWidth: i32) -> vec2i {\n	return vec2i(index % textureWidth, index / textureWidth);\n}\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n	var output: FragmentOutput;\n	\n	let coord = vec2i(i32(input.position.x), i32(input.position.y));\n	let targetIndex = coord.y * uniform.uTextureWidth + coord.x;\n	\n	if (targetIndex >= uniform.uActiveSplats) {\n		output.color = 0u;\n		return output;\n	}\n	\n	var left = 0i;\n	var right = uniform.uNumIntervals - 1;\n	var intervalIndex = 0i;\n	\n	while (left <= right) {\n		let mid = (left + right) / 2;\n		\n		let textureWidth = i32(textureDimensions(uIntervalsTexture, 0).x);\n		let intervalCoord = getCoordFromIndex(mid, textureWidth);\n		let intervalData = textureLoad(uIntervalsTexture, intervalCoord, 0).rg;\n		\n		let accumulatedSum = intervalData.g;\n		\n		if (u32(targetIndex) < accumulatedSum) {\n			intervalIndex = mid;\n			right = mid - 1;\n		} else {\n			left = mid + 1;\n		}\n	}\n	\n	let textureWidth = i32(textureDimensions(uIntervalsTexture, 0).x);\n	let intervalCoord = getCoordFromIndex(intervalIndex, textureWidth);\n	let intervalData = textureLoad(uIntervalsTexture, intervalCoord, 0).rg;\n	\n	let intervalStart = intervalData.r;\n	let currentAccSum = intervalData.g;\n	\n	var prevAccSum = 0u;\n	if (intervalIndex > 0) {\n		let prevCoord = getCoordFromIndex(intervalIndex - 1, textureWidth);\n		prevAccSum = textureLoad(uIntervalsTexture, prevCoord, 0).g;\n	}\n	\n	let offsetInInterval = u32(targetIndex) - prevAccSum;\n	let originalIndex = intervalStart + offsetInInterval;\n	\n	output.color = originalIndex;\n	return output;\n}\n",fragmentOutputTypes:["uint"]})),this.shader},t.createTexture=function(e,t,n,i){return new nO(this.device,{name:e,width:n,height:i,format:t,cubemap:false,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1})},t.update=function(e){if(!e||0===e.length)return 0;for(var t=0,n=0;n<e.length;n+=2){var i=e[n];t+=e[n+1]-i;}var r=this.device.maxTextureSize,s=Math.ceil(Math.sqrt(t)),a=Math.ceil(t/(s=Math.min(s,r)));this.texture||(this.texture=this.createTexture("intervalsTexture",37,s,a)),this.rt||(this.rt=new il({colorBuffer:this.texture,depth:false})),(this.rt.width!==s||this.rt.height!==a)&&this.rt.resize(s,a);var o=e.length/2,l=Math.ceil(Math.sqrt(o));this.intervalsDataTexture||(this.intervalsDataTexture=this.createTexture("intervalsData",43,l,l)),this.intervalsDataTexture.width!==l&&this.intervalsDataTexture.resize(l,l);for(var u=this.intervalsDataTexture.lock(),c=0,h=0;h<o;h++){var f=e[2*h];c+=e[2*h+1]-f,u[2*h]=f,u[2*h+1]=c;}this.intervalsDataTexture.unlock();var d=this.device.scope;return d.resolve("uIntervalsTexture").setValue(this.intervalsDataTexture),d.resolve("uNumIntervals").setValue(o),d.resolve("uTextureWidth").setValue(s),d.resolve("uActiveSplats").setValue(t),this.device.setCullMode(0),this.device.setBlendState(nj.NOBLEND),this.device.setDepthState(nq.NODEPTH),ls(this.device,this.rt,this.getShader()),t},e}();function xM(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}var xR=function(){function e(e,t,n){this.activeSplats=0,this.intervals=[],this.lineStart=0,this.lineCount=0,this.padding=0,this.viewport=new eY,this.previousWorldTransform=new e$,this.aabb=new e8,this.device=e,this.resource=t,this.node=n.node,this.lodIndex=n.lodIndex,this.numSplats=t.centers.length/3,this.aabb.copy(n.aabb),this.intervalTexture=new xD(e),this.updateIntervals(n.intervals);}var t=e.prototype;return t.destroy=function(){this.intervals.length=0,this.intervalTexture.destroy();},t.setLines=function(e,t,n,i){this.lineStart=e,this.lineCount=t,this.padding=n*t-i,this.viewport.set(0,e,n,t);},t.updateIntervals=function(e){var t=this.resource;if(this.intervals.length=0,this.activeSplats=t.numSplats,e.size>0){for(var n,i=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return xM(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return xM(e,void 0)}}(e))){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(e.values());!(n=i()).done;){var r=n.value;this.intervals.push(r.x,r.y+1);}this.activeSplats=this.intervalTexture.update(this.intervals);}},t.update=function(){var e=this.node.getWorldTransform(),t=!this.previousWorldTransform.equals(e);return t&&this.previousWorldTransform.copy(e),t},e}();function xO(){var e,t,n,i="undefined"!=typeof self&&self||require("node:worker_threads").parentPort,r=new Map,s=function(e,t,n,i,s,a,o){for(var l=a.ids,u=a.lineStarts,c=a.padding,h=a.intervals,f=a.textureSize,d=0;d<e.length;d++){for(var p=e[d],m=p.transformedDirection,_=p.offset,v=p.scale,g=m.x,y=m.y,S=m.z,x=g*v*n,b=y*v*n,T=S*v*n,E=(_-t)*n,w=l[d],A=r.get(w),C=u[d]*f,P=h[d].length>0?h[d]:[0,A.length/3],I=0;I<P.length;I+=2)for(var L=3*P[I],D=3*P[I+1],M=L;M<D;M+=3){var R=Math.floor(A[M]*x+A[M+1]*b+A[M+2]*T+E);i[C++]=R,s[R]++;}var O=c[d];s[0]+=O,i.fill(0,C,C+O),C+=O;}},a=function(e,t,n,i,r){for(var s=1;s<e;s++)t[s]+=t[s-1];for(var a=0;a<n;a++){var o=i[a];r[--t[o]]=a;}},o=function(e){for(var t=1/0,n=-1/0,i=0;i<e.length;i++){var r=e[i],s=r.transformedDirection,a=r.offset,o=r.scale,l=r.aabbMin,u=r.aabbMax,c=s.x,h=s.y,f=s.z,d=c>=0?l[0]:u[0],p=h>=0?l[1]:u[1],m=f>=0?l[2]:u[2],_=c>=0?u[0]:l[0],v=h>=0?u[1]:l[1],g=f>=0?u[2]:l[2],y=(d*c+p*h+m*f)*o+a,S=(_*c+v*h+g*f)*o+a,x=Math.min(y,S),b=Math.max(y,S);x<t&&(t=x),b>n&&(n=b);}return t===1/0&&(t=0,n=0),{minDist:t,maxDist:n}},l=function(e,r,l){var u=o(e),c=u.minDist,h=u.maxDist,f=l.totalUsedPixels,d=Math.max(10,Math.min(20,Math.round(Math.log2(f/4)))),p=Math.pow(2,d)+1;(null==t?void 0:t.length)!==f&&(t=new Uint32Array(f)),n&&n.length===p?n.fill(0):n=new Uint32Array(p);var m=h-c;s(e,c,m<1e-6?0:1/m*Math.pow(2,d),t,n,l),a(p,n,f,t,r);var _=[r.buffer],v={order:r.buffer,count:f,version:l.version};i.postMessage(v,_);};i.addEventListener("message",function(t){var n,i=null!=(n=t.data)?n:t;switch(i.command){case "addCenters":r.set(i.id,new Float32Array(i.centers));break;case "removeCenters":r.delete(i.id);break;case "sort":var s=new Uint32Array(i.order);l(i.sortParams,s,e);break;case "intervals":e=i;}});}function xk(e,t){return (xk=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var xN=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){(t=e.call(this)||this).bufferLength=0,t.availableOrderData=[],t.jobsInFlight=0,t.hasNewVersion=false,t.centersSet=new Set;var t,n="("+xO.toString()+")()";return "node"===ef.environment?(t.worker=new Worker(n,{eval:true}),t.worker.on("message",t.onSorted.bind(t))):(t.worker=new Worker(URL.createObjectURL(new Blob([n],{type:"application/javascript"}))),t.worker.addEventListener("message",t.onSorted.bind(t))),t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&xk(t,e);var n=t.prototype;return n.onSorted=function(e){var t,n=null!=(t=e.data)?t:e,i=new Uint32Array(n.order);this.jobsInFlight--,this.fire("sorted",n.count,n.version,i),i.length===this.bufferLength&&this.availableOrderData.push(i);},n.destroy=function(){this.worker.terminate(),this.worker=null;},n.setCenters=function(e,t){if(t){if(!this.centersSet.has(e)){this.centersSet.add(e);var n=t.buffer.slice();this.worker.postMessage({command:"addCenters",id:e,centers:n},[n]);}}else this.centersSet.has(e)&&(this.centersSet.delete(e),this.worker.postMessage({command:"removeCenters",id:e}));},n.setSortParameters=function(e){this.hasNewVersion=true;var t=e.textureSize,n=t*t;n!==this.bufferLength&&(this.bufferLength=n,this.availableOrderData.length=0),this.worker.postMessage(e);},n.setSortParams=function(e){if(this.hasNewVersion||0===this.jobsInFlight){var t=this.availableOrderData.pop();t||(t=new Uint32Array(this.bufferLength)),this.jobsInFlight++,this.hasNewVersion=false,this.worker.postMessage({command:"sort",sortParams:e,order:t.buffer},[t.buffer]);}},t}(ex);function xF(e,t){return (xF=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var xB=new e$,xU=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return t=e.apply(this,arguments)||this,t.splats=[],t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&xF(t,e);var n=t.prototype;return n.init=function(t){e.prototype.init.call(this,t),this.colorOps.clear=false,this.depthStencilOps.clearDepth=false;},n.update=function(e,t){this.splats.length=0;for(var n=0;n<e.length;n++){var i=e[n];i.activeSplats>0&&this.splats.push(i);}return this.cameraNode=t,this.splats.length>0},n.execute=function(){var e=this.device,t=this.splats,n=this.cameraNode;e.setBlendState(nj.NOBLEND),e.setCullMode(0),e.setDepthState(nq.NODEPTH),e.setStencilState();var i=n.getWorldTransform(),r=xB.copy(i).invert();e.scope.resolve("matrix_view").setValue(r.data);for(var s=0;s<t.length;s++)this.renderSplat(t[s]);},n.renderSplat=function(e){var t=e.device,n=e.resource,i=t.scope,r=e.intervals,s=e.activeSplats,a=e.lineStart,o=e.viewport,l=e.intervalTexture,u=n.getWorkBufferRenderInfo(r.length>0,false);u.material.setParameters(t),i.resolve("uTransform").setValue(e.node.getWorldTransform().data),l.texture&&i.resolve("uIntervalsTexture").setValue(l.texture),i.resolve("uActiveSplats").setValue(s),i.resolve("uStartLine").setValue(a),i.resolve("uViewportWidth").setValue(o.z),i.resolve("matrix_model").setValue(e.node.getWorldTransform().data),u.quadRender.render(o);},n.destroy=function(){this.splats.length=0,e.prototype.destroy.call(this);},t}(s2),xz=0,xV=function(){function e(e){this.id=xz++,this.device=e,this.colorTexture=this.createTexture("splatColor",12,1,1),this.covATexture=this.createTexture("covA",12,1,1),this.covBTexture=this.createTexture("covB",12,1,1),this.centerTexture=this.createTexture("center",12,1,1),this.renderTarget=new il({name:"GsplatWorkBuffer-MRT-"+this.id,colorBuffers:[this.colorTexture,this.centerTexture,this.covATexture,this.covBTexture],depth:false,flipY:true}),this.orderTexture=this.createTexture("SplatGlobalOrder",37,1,1),this.renderPass=new xU(e),this.renderPass.init(this.renderTarget);}var t,n=e.prototype;return n.destroy=function(){var e,t,n,i,r,s,a;null==(e=this.renderPass)||e.destroy(),null==(t=this.colorTexture)||t.destroy(),null==(n=this.covATexture)||n.destroy(),null==(i=this.covBTexture)||i.destroy(),null==(r=this.centerTexture)||r.destroy(),null==(s=this.orderTexture)||s.destroy(),null==(a=this.renderTarget)||a.destroy();},n.setOrderData=function(e){this.orderTexture.width,this.orderTexture.height,e.length,this.orderTexture._levels[0]=e,this.orderTexture.upload();},n.createTexture=function(e,t,n,i){return new nO(this.device,{name:e,width:n,height:i,format:t,cubemap:false,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1})},n.resize=function(e){this.renderTarget.resize(e,e),this.orderTexture.resize(e,e);},n.render=function(e,t){this.renderPass.update(e,t)&&this.renderPass.render();},t=[{key:"textureSize",get:function(){return this.orderTexture.width}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),xG=function(){function e(e,t,n,i,r){this.maxNumSplats=0,this.instanceIndices=null,this.viewportParams=[0,0],this.device=e,this.node=t,this.cameraNode=n,this.layer=i,this.workBuffer=r,this._material=new h3({uniqueName:"UnifiedSplatMaterial",vertexGLSL:'#include "gsplatVS"',fragmentGLSL:'#include "gsplatPS"',vertexWGSL:'#include "gsplatVS"',fragmentWGSL:'#include "gsplatPS"',attributes:{vertex_position:tT,vertex_id_attrib:tQ}}),this._material.setDefine("GSPLAT_WORKBUFFER_DATA",true),this._material.setParameter("splatColor",r.colorTexture),this._material.setParameter("covA",r.covATexture),this._material.setParameter("covB",r.covBTexture),this._material.setParameter("center",r.centerTexture),this._material.setDefine("SH_BANDS","0"),this._material.setParameter("numSplats",0),this._material.setParameter("splatOrder",r.orderTexture),this._material.setParameter("alphaClip",.3),this._material.setDefine("DITHER_NONE",""),this._material.cull=0,this._material.blendType=4,this._material.depthWrite=false,this._material.update(),this.meshInstance=this.createMeshInstance(),i.addMeshInstances([this.meshInstance]);}var t=e.prototype;return t.destroy=function(){this.layer.removeMeshInstances([this.meshInstance]),this._material.destroy(),this.meshInstance.destroy();},t.setNumSplats=function(e){this.meshInstance.instancingCount=Math.ceil(e/d9.instanceSize),this._material.setParameter("numSplats",e),this.meshInstance.visible=e>0;},t.setMaxNumSplats=function(e){if(this.maxNumSplats!==e){var t;this.maxNumSplats=e,null==(t=this.instanceIndices)||t.destroy(),this.instanceIndices=d9.createInstanceIndices(this.device,e),this.meshInstance.setInstancing(this.instanceIndices,true);}},t.createMeshInstance=function(){var e=d9.createMesh(this.device),t=this.workBuffer.textureSize,n=d9.createInstanceIndices(this.device,t*t),i=new lL(e,this._material);i.node=this.node,i.setInstancing(n,true),i.instancingCount=0;var r=this.cameraNode.camera;return i.isVisibleFunc=function(e){return r.camera===e},i},t.updateViewport=function(e){var t,n=e.camera,i=n.rect,r=null==n?void 0:n.renderTarget,s=null!=r?r:this.device,a=s.width,o=s.height,l=this.viewportParams;l[0]=a*i.z,l[1]=o*i.w;var u=null==n||null==(t=n.camera)?void 0:t.xr;(null==u?void 0:u.active)&&2===u.views.list.length&&(l[0]*=.5),this._material.setParameter("viewport",l);},e}(),xH=function(){var e;function t(e,t,n){ void 0===n&&(n=0),this.intervals=new Map,this.lodIndex=0,this._aabb=new e8,this.resource=e,this.node=t,this.lodIndex=n;}return e=[{key:"aabb",get:function(){return this._aabb},set:function(e){this._aabb.copy(e);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}();function xW(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function xj(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return xW(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return xW(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var xX=new e$,xY=new eW,xq=[],xK=function(){function e(e,t,n){this.activePlacements=new Set,this.dirtyModifiedPlacements=false,this.pending=new Set,this.pendingDecrements=new Map,this.previousPosition=new eW,this.octree=e,this.placement=t,this.assetLoader=n,this.nodeLods=new Int32Array(e.nodes.length),this.nodeLods.fill(-1);var i=e.files.length;this.filePlacements=Array(i).fill(null);}var t=e.prototype;return t.destroy=function(){this.pending.clear(),this.pendingDecrements.clear(),this.filePlacements.length=0;},t.calculateNodeLod=function(e,t,n){for(var i=this.octree.nodes[t],r=e.distance(i.bounds.center),s=[2,4,6,8,10],a=0;a<n;a++)if(r<s[a])return a;return n},t.updateLod=function(e){var t=e.getPosition(),n=this.placement.node.getWorldTransform();xX.copy(n).invert();for(var i=xX.transformPoint(t,xY),r=this.octree.lodLevels-1,s=this.octree.nodes,a=0;a<s.length;a++){var o=s[a],l=this.calculateNodeLod(i,a,r),u=this.nodeLods[a];if(l!==u){var c=this.pendingDecrements.get(a);void 0!==c&&(this.decrementFileRef(c,a),this.pendingDecrements.delete(a)),this.nodeLods[a]=l;var h=u>=0,f=l>=0;if(!h&&f){var d=o.lods[l].fileIndex;this.incrementFileRef(d,a,l);}else if(h&&!f){var p=o.lods[u].fileIndex;this.decrementFileRef(p,a);}else if(h&&f){var m=o.lods[l].fileIndex,_=o.lods[u].fileIndex;this.incrementFileRef(m,a,l);var v=this.filePlacements[m];(null==v?void 0:v.resource)?this.decrementFileRef(_,a):this.pendingDecrements.set(a,_);}}}},t.incrementFileRef=function(e,t,n){if(-1!==e){var i=this.filePlacements[e];if(!i&&(i=new xH(null,this.placement.node,n),this.filePlacements[e]=i,!this.addFilePlacement(e))){var r=this.octree.files[e];this.octree.ensureFileResource(r,this.assetLoader),this.pending.add(e);}var s=this.octree.nodes[t].lods[n],a=new eX(s.offset,s.offset+s.count-1);i.intervals.set(t,a),this.dirtyModifiedPlacements=true;}},t.decrementFileRef=function(e,t){if(-1!==e){var n=this.filePlacements[e];n&&(n.intervals.delete(t),this.dirtyModifiedPlacements=true,0===n.intervals.size&&(n.resource&&this.activePlacements.delete(n),this.filePlacements[e]=null,this.pending.delete(e)));}},t.addFilePlacement=function(e){var t=this.octree.files[e],n=this.octree.getFileResource(t);if(n){var i=this.filePlacements[e];if(i)return i.resource=n,i.aabb.copy(n.aabb),this.activePlacements.add(i),this.dirtyModifiedPlacements=true,true}return  false},t.testMoved=function(){var e=this.placement.node.getPosition();return e.distance(this.previousPosition)>1&&(this.previousPosition.copy(e),true)},t.update=function(){if(this.pending.size){for(var e,t=xj(this.pending);!(e=t()).done;){var n=e.value,i=this.octree.files[n];this.octree.ensureFileResource(i,this.assetLoader);var r=this.filePlacements[n];if(r&&r.intervals.size>0&&this.addFilePlacement(n)){xq.push(n);for(var s,a=xj(r.intervals);!(s=a()).done;){var o=s.value[0],l=this.pendingDecrements.get(o);void 0!==l&&(this.decrementFileRef(l,o),this.pendingDecrements.delete(o));}}}for(var u,c=xj(xq);!(u=c()).done;){var h=u.value;this.pending.delete(h);}xq.length=0;}var f=this.dirtyModifiedPlacements;return this.dirtyModifiedPlacements=false,f},e}(),xZ=new eW,xQ=new eW,xJ=function(e,t){this.bounds=new e8,this.lods=e,xZ.set(t.min[0],t.min[1],t.min[2]),xQ.set(t.max[0],t.max[1],t.max[2]),this.bounds.setMinMax(xZ,xQ);};function x$(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}var x0=function(){function e(e,t){var n=this;this.fileResources=new Map,this.files=t.filenames,this.lodLevels=t.lodLevels,this.assetFileUrl=e,this.baseDir=en.getDirectory(e);var i=[];this._extractLeafNodes(t.tree,i),this.nodes=i.map(function(e){for(var t=[],i=0;i<n.lodLevels;i++){var r=e.lods[i.toString()];r?t.push({file:n.files[r.file]||"",fileIndex:r.file,offset:r.offset||0,count:r.count||0}):t.push({file:"",fileIndex:-1,offset:0,count:0});}return new xJ(t,e.bound)});}var t=e.prototype;return t._extractLeafNodes=function(e,t){if(e.lods)t.push({lods:e.lods,bound:e.bound});else if(e.children)for(var n,i=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return x$(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return x$(e,void 0)}}(e))){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(e.children);!(n=i()).done;){var r=n.value;this._extractLeafNodes(r,t);}},t.getFullUrl=function(e){return en.join(this.baseDir,e)},t.getFileResource=function(e){return this.fileResources.get(e)},t.ensureFileResource=function(e,t){if(!this.fileResources.has(e)){var n=this.getFullUrl(e),i=t.getResource(n);if(i)return void this.fileResources.set(e,i);t.load(n);}},e}(),x1=function(e,t){this.aabb=new e8,this.octree=new x0(e,t),this.aabb.setMinMax(new eW(t.tree.bound.min),new eW(t.tree.bound.max));};function x2(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function x3(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return x2(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return x2(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var x4=function(){function e(e,t,n){this.version=0,this.sortParametersSet=false,this.sortedBefore=false,this.splats=[],this.textureSize=0,this.totalUsedPixels=0,this.version=t,this.splats=n,this.estimateTextureSize(this.splats,e.maxTextureSize),this.assignLines(this.splats,this.textureSize);}var t=e.prototype;return t.estimateTextureSize=function(e,t){for(var n=1,i=t,r=null;n<=i;){var s=Math.floor((n+i)/2);!function(t){for(var n,i=0,r=x3(e);!(n=r()).done;)if((i+=Math.ceil(n.value.activeSplats/t))>t)return  false;return  true}(s)?n=s+1:(r=s,i=s-1);}return null===r?(this.textureSize=0,false):(this.textureSize=r,true)},t.destroy=function(){this.splats.forEach(function(e){return e.destroy()}),this.splats.length=0;},t.assignLines=function(e,t){if(0===e.length){this.totalUsedPixels=0;return}for(var n,i=0,r=x3(e);!(n=r()).done;){var s=n.value,a=s.activeSplats,o=Math.ceil(a/t);s.setLines(i,o,t,a),i+=o;}this.totalUsedPixels=i*t;},e}();function x5(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function x8(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return x5(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return x5(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var x6=new eW,x9=new eW,x7=new eW,be=new e$,bt=new Set,bn=new Set,bi=[],br=function(){function e(e,t,n,i){this.node=new us("GSplatManager"),this.worldStates=new Map,this.lastWorldStateVersion=0,this.sortedVersion=0,this.lastCameraPos=new eW(1/0,1/0,1/0),this.layerPlacements=[],this.layerPlacementsDirty=false,this.octreeInstances=new Map,this.device=e,this.director=t,this.cameraNode=i,this.workBuffer=new xV(e),this.renderer=new xG(e,this.node,this.cameraNode,n,this.workBuffer),this.sorter=this.createSorter();}var t=e.prototype;return t.destroy=function(){this.workBuffer.destroy(),this.renderer.destroy(),this.sorter.destroy();},t.createSorter=function(){var e=this,t=new xN;return t.on("sorted",function(t,n,i){e.onSorted(t,n,i);}),t},t.reconcile=function(e){bt.clear();for(var t,n=x8(e);!(t=n()).done;){var r,s=t.value;(r=s.resource,null!=x1&&"undefined"!=typeof Symbol&&x1[Symbol.hasInstance]?!!x1[Symbol.hasInstance](r):i(r,x1))?(this.octreeInstances.has(s)||this.octreeInstances.set(s,new xK(s.resource.octree,s,this.director.assetLoader)),bn.add(s)):bt.add(s);}for(var a,o=x8(this.octreeInstances);!(a=o()).done;){var l=a.value,u=l[0],c=l[1];bn.has(u)||(this.octreeInstances.delete(u),c.destroy());}if(this.layerPlacementsDirty=this.layerPlacements.length!==bt.size,!this.layerPlacementsDirty)for(var h=0;h<this.layerPlacements.length;h++){var f=this.layerPlacements[h];if(!bt.has(f)){this.layerPlacementsDirty=true;break}}this.layerPlacements.length=0;for(var d,p=x8(bt);!(d=p()).done;){var m=d.value;this.layerPlacements.push(m);}bt.clear(),bn.clear();},t.updateWorldState=function(){for(var e,t=this,n=x8(this.octreeInstances);!(e=n()).done;){var i=e.value[1];this.layerPlacementsDirty||(this.layerPlacementsDirty=i.update());}if(this.layerPlacementsDirty||0===this.worldStates.size){this.lastWorldStateVersion++;for(var r,s=[],a=x8(this.layerPlacements);!(r=a()).done;){var o=r.value,l=new xR(this.device,o.resource,o);s.push(l);}for(var u,c=x8(this.octreeInstances);!(u=c()).done;)u.value[1].activePlacements.forEach(function(e){s.push(new xR(t.device,e.resource,e));});s.forEach(function(e){t.sorter.setCenters(e.resource.id,e.resource.centers);});var h=new x4(this.device,this.lastWorldStateVersion,s);this.worldStates.set(this.lastWorldStateVersion,h),this.layerPlacementsDirty=false;}},t.onSorted=function(e,t,n){this.sortedVersion=t;var i=this.worldStates.get(t-1);i&&(this.worldStates.delete(t-1),i.destroy());var r=this.worldStates.get(t);if(r){if(!r.sortedBefore){r.sortedBefore=true;var s=r.textureSize;s!==this.workBuffer.textureSize&&(this.workBuffer.resize(s),this.renderer.setMaxNumSplats(s*s)),this.workBuffer.render(r.splats,this.cameraNode);}this.workBuffer.setOrderData(n),this.renderer.setNumSplats(e);}},t.update=function(e){for(var t,n=false,i=x8(this.octreeInstances);!(t=i()).done;){var r=t.value[1];n||(n=r.testMoved());}var s=this.cameraNode.getPosition();if(this.lastCameraPos.distance(s)>1||n){this.lastCameraPos.copy(s);for(var a,o=x8(this.octreeInstances);!(a=o()).done;)a.value[1].updateLod(this.cameraNode);}this.updateWorldState();var l=this.worldStates.get(this.lastWorldStateVersion);if(l){if(!l.sortParametersSet){l.sortParametersSet=true;var u=this.prepareSortParameters(l);this.sorter.setSortParameters(u);}this.sort(l);}var c=this.worldStates.get(this.sortedVersion);c&&(c.splats.forEach(function(e){e.update()&&bi.push(e);}),bi.length>0&&(this.workBuffer.render(bi,this.cameraNode),bi.length=0));},t.sort=function(e){var t=this.cameraNode,n=t.getWorldTransform();n.getTranslation(x6),n.getZ(x9).normalize();var i=[];e.splats.forEach(function(e){var t=e.node.getWorldTransform();be.copy(t).invert();var n=t.getScale().x,r=be.transformVector(x9).normalize();t.getTranslation(x7);var s=x7.sub(x6).dot(x9),a=e.aabb.getMin(),o=e.aabb.getMax();i.push({transformedDirection:r,offset:s,scale:n,modelMat:t.data.slice(),aabbMin:[a.x,a.y,a.z],aabbMax:[o.x,o.y,o.z]});}),this.sorter.setSortParams(i),this.renderer.updateViewport(t);},t.prepareSortParameters=function(e){return {command:"intervals",textureSize:e.textureSize,totalUsedPixels:e.totalUsedPixels,version:e.version,ids:e.splats.map(function(e){return e.resource.id}),lineStarts:e.splats.map(function(e){return e.lineStart}),padding:e.splats.map(function(e){return e.padding}),intervals:e.splats.map(function(e){return e.intervals})}},e}(),bs=function(){function e(e,t,n,i){this.gsplatManager=new br(e,t,n,i);}return e.prototype.destroy=function(){this.gsplatManager.destroy();},e}(),ba=function(){function e(){this.layersMap=new Map;}var t=e.prototype;return t.destroy=function(){this.layersMap.forEach(function(e){return e.destroy()}),this.layersMap.clear();},t.removeLayerData=function(e){var t=this.layersMap.get(e);t&&(t.destroy(),this.layersMap.delete(e));},t.getLayerData=function(e,t,n,i){var r=this.layersMap.get(n);return r||(r=new bs(e,t,n,i),this.layersMap.set(n,r)),r},e}(),bo=function(){function e(e,t,n){this.camerasMap=new Map,this.octrees=new Map,this.device=e,this.assetLoader=n,this.scene=t;}var t=e.prototype;return t.getCameraData=function(e){var t=this.camerasMap.get(e);return t||(t=new ba,this.camerasMap.set(e,t)),t},t.update=function(e){var t=this;this.camerasMap.forEach(function(n,i){e.camerasSet.has(i)?n.layersMap.forEach(function(e,t){i.layersSet.has(t.id)&&t.enabled||(e.destroy(),n.layersMap.delete(t));}):(n.destroy(),t.camerasMap.delete(i));});for(var n=e.cameras,i=0;i<n.length;i++){for(var r=n[i].camera,s=this.camerasMap.get(r),a=r.layers,o=0;o<a.length;o++){var l=e.getLayerById(a[o]);if((null==l?void 0:l.enabled)&&(l.gsplatPlacementsDirty||!s)){var u=l.gsplatPlacements;0===u.length?s&&s.removeLayerData(l):(null!=s||(s=this.getCameraData(r)),s.getLayerData(this.device,this,l,r.node).gsplatManager.reconcile(u));}}null==s||s.layersMap.forEach(function(e){e.gsplatManager.update(t.scene);});}for(var c=0;c<e.layerList.length;c++)e.layerList[c].gsplatPlacementsDirty=false;},e}();function bl(e,t){return (bl=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var bu=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n)||this)._layers=[0],i._instance=null,i._placement=null,i._materialTmp=null,i._highQualitySH=true,i._customAabb=null,i._evtLayersChanged=null,i._evtLayerAdded=null,i._evtLayerRemoved=null,i._castShadows=false,i._unified=false,i._assetReference=new yw("asset",i,t.app.assets,{add:i._onGSplatAssetAdded,load:i._onGSplatAssetLoad,remove:i._onGSplatAssetRemove,unload:i._onGSplatAssetUnload},i),n.on("remove",i.onRemoveChild,i),n.on("removehierarchy",i.onRemoveChild,i),n.on("insert",i.onInsertChild,i),n.on("inserthierarchy",i.onInsertChild,i),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&bl(t,e);var n,r=t.prototype;return r.destroyInstance=function(){if(this._placement&&(this.removeFromLayers(),this._placement=null),this._instance){var e;this.removeFromLayers(),null==(e=this._instance)||e.destroy(),this._instance=null;}},r.addToLayers=function(){if(this._placement){for(var e,t,n=this.system.app.scene.layers,i=0;i<this._layers.length;i++)null==(t=n.getLayerById(this._layers[i]))||t.addGSplatPlacement(this._placement);return}var r=null==(e=this.instance)?void 0:e.meshInstance;if(r)for(var s,a=this.system.app.scene.layers,o=0;o<this._layers.length;o++)null==(s=a.getLayerById(this._layers[o]))||s.addMeshInstances([r]);},r.removeFromLayers=function(){if(this._placement){for(var e,t,n=this.system.app.scene.layers,i=0;i<this._layers.length;i++)null==(t=n.getLayerById(this._layers[i]))||t.removeGSplatPlacement(this._placement);return}var r=null==(e=this.instance)?void 0:e.meshInstance;if(r)for(var s,a=this.system.app.scene.layers,o=0;o<this._layers.length;o++)null==(s=a.getLayerById(this._layers[o]))||s.removeMeshInstances([r]);},r.onRemoveChild=function(){this.removeFromLayers();},r.onInsertChild=function(){this.enabled&&this.entity.enabled&&(this._instance||this._placement)&&this.addToLayers();},r.onRemove=function(){this.destroyInstance(),this.asset=null,this._assetReference.id=null,this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this);},r.onLayersChanged=function(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);},r.onLayerAdded=function(e){!(0>this.layers.indexOf(e.id))&&this._instance&&e.addMeshInstances(this._instance.meshInstance);},r.onLayerRemoved=function(e){!(0>this.layers.indexOf(e.id))&&this._instance&&e.removeMeshInstances(this._instance.meshInstance);},r.onEnable=function(){var e=this.system.app.scene,t=e.layers;this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this._instance||this._placement?this.addToLayers():this.asset&&this._onGSplatAssetAdded();},r.onDisable=function(){var e,t,n,i=this.system.app.scene.layers;null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,i&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(n=this._evtLayerRemoved)||n.off(),this._evtLayerRemoved=null),this.removeFromLayers();},r.hide=function(){this._instance&&(this._instance.meshInstance.visible=false);},r.show=function(){this._instance&&(this._instance.meshInstance.visible=true);},r._onGSplatAssetAdded=function(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onGSplatAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset));},r._onGSplatAssetLoad=function(){this.destroyInstance();var e=this._assetReference.asset;this.unified?(this._placement=null,e&&(this._placement=new xH(e.resource,this.entity))):e&&(this.instance=new pE(e.resource,{material:this._materialTmp,highQualitySH:this._highQualitySH}),this._materialTmp=null),e&&(this.customAabb=e.resource.aabb.clone());},r._onGSplatAssetUnload=function(){this.destroyInstance();},r._onGSplatAssetRemove=function(){this._onGSplatAssetUnload();},n=[{key:"customAabb",get:function(){return this._customAabb},set:function(e){var t,n;this._customAabb=e,null==(n=this._instance)||null==(t=n.meshInstance)||t.setCustomAabb(this._customAabb),this._placement&&this._customAabb&&(this._placement.aabb=this._customAabb);}},{key:"instance",get:function(){return this._instance},set:function(e){if(this.destroyInstance(),this._instance=e,this._instance){var t=this._instance.meshInstance;t.node||(t.node=this.entity),t.castShadow=this._castShadows,t.setCustomAabb(this._customAabb),this.enabled&&this.entity.enabled&&this.addToLayers();}}},{key:"material",get:function(){var e,t,n;return null!=(n=null!=(t=null==(e=this._instance)?void 0:e.material)?t:this._materialTmp)?n:null},set:function(e){this._instance?this._instance.material=e:this._materialTmp=e;}},{key:"highQualitySH",get:function(){return this._highQualitySH},set:function(e){if(e!==this._highQualitySH){var t;this._highQualitySH=e,null==(t=this._instance)||t.setHighQualitySH(e);}}},{key:"castShadows",get:function(){return this._castShadows},set:function(e){if(this._castShadows!==e){var t,n=null==(t=this.instance)?void 0:t.meshInstance;if(n){var i=this.layers,r=this.system.app.scene;if(this._castShadows&&!e)for(var s=0;s<i.length;s++){var a=r.layers.getLayerById(this.layers[s]);a&&a.removeShadowCasters([n]);}if(n.castShadow=e,!this._castShadows&&e)for(var o=0;o<i.length;o++){var l=r.layers.getLayerById(i[o]);l&&l.addShadowCasters([n]);}}this._castShadows=e;}}},{key:"unified",get:function(){return this._unified},set:function(e){this.enabled&&this.entity.enabled||(this._unified=e,this._onGSplatAssetAdded());}},{key:"layers",get:function(){return this._layers},set:function(e){this.removeFromLayers(),this._layers.length=0;for(var t=0;t<e.length;t++)this._layers[t]=e[t];this.enabled&&this.entity.enabled&&this.addToLayers();}},{key:"asset",get:function(){return this._assetReference.id},set:function(e){var t=(null!=pZ&&"undefined"!=typeof Symbol&&pZ[Symbol.hasInstance]?!!pZ[Symbol.hasInstance](e):i(e,pZ))?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onGSplatAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onGSplatAssetAdded());}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mX),bc=function(){this.enabled=true;};function bh(e,t){return (bh=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var bf=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this)._urlToAsset=new Map,n._registry=t,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&bh(t,e);var n=t.prototype;return n.load=function(e){var t=this._urlToAsset.get(e);t||((t=this._registry.getByUrl(e))||(t=new pZ(e,"gsplat",{url:e}),this._registry.add(t)),this._urlToAsset.set(e,t)),t.loaded||t.loading||this._registry.load(t);},n.unload=function(e){var t=this._urlToAsset.get(e);t&&(t.unload(),this._urlToAsset.delete(e));},n.getResource=function(e){var t=this._urlToAsset.get(e);return null==t?void 0:t.resource},t}(function(){function e(){}var t=e.prototype;return t.load=function(e){},t.unload=function(e){},t.getResource=function(e){},e}());function bd(e,t){return (bd=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var bp=["enabled"],bm=["unified","castShadows","material","highQualitySH","asset","layers"],b_=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){(n=e.call(this,t)||this).id="gsplat",n.ComponentType=bu,n.DataType=bc,n.schema=bp;var n,i=new bf(t.assets);return t.renderer.gsplatDirector=new bo(t.graphicsDevice,t.scene,i),n.on("beforeremove",n.onRemove,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&bd(t,e);var n=t.prototype;return n.initializeComponentData=function(t,n,i){n.layers&&n.layers.length&&(n.layers=n.layers.slice(0));for(var r=0;r<bm.length;r++)n.hasOwnProperty(bm[r])&&(t[bm[r]]=n[bm[r]]);n.aabbCenter&&n.aabbHalfExtents&&(t.customAabb=new e8(new eW(n.aabbCenter),new eW(n.aabbHalfExtents))),e.prototype.initializeComponentData.call(this,t,n,bp);},n.cloneComponent=function(e,t){var n=e.gsplat,i={};bm.forEach(function(e){if("material"===e){var t=n[e];t&&(i[e]=t.clone());}else i[e]=n[e];}),i.enabled=n.enabled;var r=this.addComponent(t,i);return n.customAabb&&(r.customAabb=n.customAabb.clone()),r},n.onRemove=function(e,t){t.onRemove();},t}(mZ);function bv(e,t){return (bv=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}mX._buildAccessors(bu.prototype,bp);var bg=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return t=e.apply(this,arguments)||this,t._meshes=null,t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&bv(t,e);var n,i=t.prototype;return i.destroy=function(){this.meshes=null;},i.decRefMeshes=function(){var e,t=this;null==(e=this._meshes)||e.forEach(function(e,n){e&&(e.decRefCount(),e.refCount<1&&(e.destroy(),t._meshes[n]=null));});},i.incRefMeshes=function(){var e;null==(e=this._meshes)||e.forEach(function(e){null==e||e.incRefCount();});},n=[{key:"meshes",get:function(){return this._meshes},set:function(e){this.decRefMeshes(),this._meshes=e,this.incRefMeshes(),this.fire("set:meshes",e);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function by(e,t){return (by=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function bS(e){if(this.resource){var t=e.resource,n=t.renders&&t.renders[this.data.renderIndex];n&&(this.resource.meshes=n.resource.meshes);}}function bx(e){this.registry.off("load:"+e.id,bS,this),this.registry.on("load:"+e.id,bS,this),this.registry.off("remove:"+e.id,bb,this),this.registry.once("remove:"+e.id,bb,this),e.resource?bS.call(this,e):this.registry.load(e);}function bb(e){this.registry.off("load:"+e.id,bS,this),this.resource&&this.resource.destroy();}bg.EVENT_SETMESHES="set:meshes";var bT=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"render")||this)._registry=t.assets,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&by(t,e);var n=t.prototype;return n.open=function(e,t){return new bg},n.patch=function(e,t){if(e.data.containerAsset){var n=t.get(e.data.containerAsset);if(!n)return void t.once("add:"+e.data.containerAsset,bx,e);bx.call(e,n);}},t}(mn),bE=function(){var e;function t(e,t,n,i){this._paths=e,this._input=t,this._output=n,this._interpolation=i;}return e=[{key:"paths",get:function(){return this._paths}},{key:"input",get:function(){return this._input}},{key:"output",get:function(){return this._output}},{key:"interpolation",get:function(){return this._interpolation}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}(),bw=function(){var e;function t(e,t){this._components=e,this._data=t;}return e=[{key:"components",get:function(){return this._components}},{key:"data",get:function(){return this._data}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}();function bA(e,t){var n,i=function(e,t){switch(t){case n.DT_INT8:return new Int8Array(e.buffer,e.byteOffset,e.byteLength);case n.DT_INT16:return new Int16Array(e.buffer,e.byteOffset,e.byteLength/2);case n.DT_INT32:return new Int32Array(e.buffer,e.byteOffset,e.byteLength/4);case n.DT_UINT8:return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);case n.DT_UINT16:return new Uint16Array(e.buffer,e.byteOffset,e.byteLength/2);case n.DT_UINT32:return new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4);case n.DT_FLOAT32:return new Float32Array(e.buffer,e.byteOffset,e.byteLength/4)}return null},r=function(e){switch(e){case n.DT_INT8:break;case n.DT_INT16:return 2;case n.DT_INT32:return 4;case n.DT_UINT8:break;case n.DT_UINT16:return 2;case n.DT_UINT32:case n.DT_FLOAT32:return 4}return 1},s=function(e){return e.num_components()*r(e.data_type())},a={0:0,1:1,5:2,2:3,7:4,8:5,4:6,3:7},o=function(e,t){for(var n=function(e,t,n){e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2];},i=function(e,t){var n=e[t+0],i=e[t+1],r=e[t+2],s=1/Math.sqrt(n*n+i*i+r*r);e[t+0]*=s,e[t+1]*=s,e[t+2]*=s;},r=function(e,t,n){for(var i=0;i<3;++i)e[i]=t[n+i];},s=t.length/3,a=e.length/3,o=new Float32Array(e.length),l=[0,0,0],u=[0,0,0],c=[0,0,0],h=[0,0,0],f=[0,0,0],d=[0,0,0],p=0;p<s;++p){var m=3*t[3*p+0],_=3*t[3*p+1],v=3*t[3*p+2];r(l,e,m),r(u,e,_),r(c,e,v),n(h,u,l),n(f,c,l),d[0]=h[1]*f[2]-f[1]*h[2],d[1]=h[2]*f[0]-f[2]*h[0],d[2]=h[0]*f[1]-f[0]*h[1],i(d,0);for(var g=0;g<3;++g)o[m+g]+=d[g],o[_+g]+=d[g],o[v+g]+=d[g];}for(var y=0;y<a;++y)i(o,3*y);return new Uint8Array(o.buffer)},l=function(e){var t={},r=new n.DecoderBuffer;r.Init(e,e.length);var l=new n.Decoder;if(l.GetEncodedGeometryType(r)!==n.TRIANGULAR_MESH)return t.error="Failed to decode draco mesh: not a mesh",t;var u=new n.Mesh,c=l.DecodeBufferToMesh(r,u);if(!c||!c.ok()||0===n.getPointer(u))return t.error="Failed to decode draco asset",t;var h=3*u.num_faces(),f=65535>=u.num_points(),d=h*(f?2:4),p=n._malloc(d);f?(l.GetTrianglesUInt16Array(u,d,p),t.indices=new Uint16Array(n.HEAPU16.buffer,p,h).slice().buffer):(l.GetTrianglesUInt32Array(u,d,p),t.indices=new Uint32Array(n.HEAPU32.buffer,p,h).slice().buffer),n._free(p);for(var m=[],_=0;_<u.num_attributes();++_)m.push(l.GetAttribute(u,_));m.sort(function(e,t){var n,i;return (null!=(n=a[e.attribute_type()])?n:a.length)-(null!=(i=a[t.attribute_type()])?i:a.length)}),t.attributes=m.map(function(e){return e.unique_id()});var v=0,g=m.map(function(e){var t=v;return v+=4*Math.ceil(s(e)/4),t}),y=m.some(function(e){return 1===e.attribute_type()}),S=g[1];if(!y){for(var x=1;x<g.length;++x)g[x]+=12;v+=12;}t.vertices=new ArrayBuffer(u.num_points()*v);for(var b=new Uint8Array(t.vertices),T=0;T<u.num_attributes();++T){var E=m[T],w=s(E),A=u.num_points()*w,C=n._malloc(A);l.GetAttributeDataArrayForAllPoints(u,E,E.data_type(),A,C);for(var P=new Uint8Array(n.HEAPU8.buffer,C,A),I=0;I<u.num_points();++I)for(var L=0;L<w;++L)b[I*v+g[T]+L]=P[I*w+L];if(!y&&0===E.attribute_type())for(var D=o(i(P,E.data_type()),f?new Uint16Array(t.indices):new Uint32Array(t.indices)),M=0;M<u.num_points();++M)for(var R=0;R<12;++R)b[M*v+S+R]=D[12*M+R];n._free(C);}return n.destroy(u),n.destroy(l),n.destroy(r),t},u=function(e){var t=l(new Uint8Array(e.buffer));self.postMessage({jobId:e.jobId,error:t.error,indices:t.indices,vertices:t.vertices,attributes:t.attributes},[t.indices,t.vertices].filter(function(e){return null!=e}));},c=[];self.onmessage=function(e){var t=e.data;switch(t.type){case "init":self.DracoDecoderModule({instantiateWasm:function(e,n){return WebAssembly.instantiate(t.module,e).then(function(e){return n(e)}).catch(function(e){}),{}}}).then(function(e){n=e,c.forEach(function(e){return u(e)});});break;case "decodeMesh":n?u(t):c.push(t);}};}var bC=function(){function e(){this.workers=[[],[],[]],this.jobId=0,this.jobQueue=[],this.jobCallbacks=new Map,this.run=function(e,t){e.postMessage({type:"decodeMesh",jobId:t.jobId,buffer:t.buffer},[t.buffer]);};}var t=e.prototype;return t.init=function(e){var t=this;for(e.forEach(function(e){e.addEventListener("message",function(n){var i=n.data,r=t.jobCallbacks.get(i.jobId);if(r&&r(i.error,{indices:i.indices,vertices:i.vertices,attributes:i.attributes}),t.jobCallbacks.delete(i.jobId),t.jobQueue.length>0){var s=t.jobQueue.shift();t.run(e,s);}else {var a=t.workers[2].indexOf(e);if(-1!==a)t.workers[2].splice(a,1),t.workers[1].push(e);else {var o=t.workers[1].indexOf(e);-1!==o&&(t.workers[1].splice(o,1),t.workers[0].push(e));}}});}),this.workers[0]=e;this.jobQueue.length&&(this.workers[0].length||this.workers[1].length);){var n=this.jobQueue.shift();if(this.workers[0].length>0){var i=this.workers[0].shift();this.workers[1].push(i),this.run(i,n);}else {var r=this.workers[1].shift();this.workers[2].push(r),this.run(r,n);}}},t.enqueueJob=function(e,t){var n={jobId:this.jobId++,buffer:e};if(this.jobCallbacks.set(n.jobId,t),this.workers[0].length>0){var i=this.workers[0].shift();this.workers[1].push(i),this.run(i,n);}else if(this.workers[1].length>0){var r=this.workers[1].shift();this.workers[2].push(r),this.run(r,n);}else this.jobQueue.push(n);},e}(),bP=function(e){var t=function(){return fetch(e).then(function(e){return e.arrayBuffer()}).then(function(e){return WebAssembly.compile(e)})};return WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(e)).catch(function(e){return t()}):t()},bI=function(e){if(F)return  true;if(!e)if(B)e=B;else {var t,n=ew.getConfig("DracoDecoderModule");e=n?{jsUrl:n.glueUrl,wasmUrl:n.wasmUrl,numWorkers:n.numWorkers}:{jsUrl:"draco.wasm.js",wasmUrl:"draco.wasm.wasm",numWorkers:1};}return !!e.jsUrl&&!!e.wasmUrl&&(F=new bC,Promise.all([(t=e.jsUrl,new Promise(function(e,n){aq.get(t,{cache:true,responseType:"text",retry:true,maxRetries:3},function(t,i){t?n(t):e(i);});})),bP(e.wasmUrl)]).then(function(t){for(var n=t[0],i=t[1],r=new Blob([["/* draco */",n,"/* worker */","(\n"+bA.toString()+"\n)()\n\n"].join("\n")],{type:"application/javascript"}),s=URL.createObjectURL(r),a=Math.max(1,Math.min(16,e.numWorkers||1)),o=[],l=0;l<a;++l){var u=new Worker(s);u.postMessage({type:"init",module:i}),o.push(u);}F.init(o);}),true)};function bL(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function bD(e,t,n,i,r,s,a){try{var o=e[s](a),l=o.value;}catch(e){n(e);return}o.done?t(l):Promise.resolve(l).then(i,r);}function bM(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function bR(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return bL(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return bL(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var bO=function(){function e(){}return e.prototype.destroy=function(){this.renders&&this.renders.forEach(function(e){e.meshes=null;});},e}(),bk=function(e){return /^data:[^\n\r,\u2028\u2029]*,.*$/i.test(e)},bN=function(e){switch(e){case "SCALAR":return 1;case "VEC2":return 2;case "VEC3":default:return 3;case "VEC4":case "MAT2":return 4;case "MAT3":return 9;case "MAT4":return 16}},bF=function(e){switch(e){case 5120:default:return 0;case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6}},bB=function(e){switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},bU=function(e){switch(e){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}},bz={POSITION:tT,NORMAL:tE,TANGENT:tw,COLOR_0:tP,JOINTS_0:tC,WEIGHTS_0:tA,TEXCOORD_0:tL,TEXCOORD_1:tD,TEXCOORD_2:tM,TEXCOORD_3:tR,TEXCOORD_4:tO,TEXCOORD_5:tk,TEXCOORD_6:tN,TEXCOORD_7:tF},bV=((U={})[tT]=0,U[tE]=1,U[tw]=2,U[tP]=3,U[tC]=4,U[tA]=5,U[tL]=6,U[tD]=7,U[tM]=8,U[tR]=9,U[tO]=10,U[tk]=11,U[tN]=12,U[tF]=13,U),bG=function(e){switch(e){case 0:return function(e){return Math.max(e/127,-1)};case 1:return function(e){return e/255};case 2:return function(e){return Math.max(e/32767,-1)};case 3:return function(e){return e/65535};default:return function(e){return e}}},bH=function(e,t,n){for(var i=bG(n),r=t.length,s=0;s<r;++s)e[s]=i(t[s]);return e},bW=function(e,t,n){ void 0===n&&(n=false);var i,r=bN(e.type),s=bU(e.componentType);if(!s)return null;if(e.sparse){var a=e.sparse,o=bW(Object.assign({count:a.count,type:"SCALAR"},a.indices),t,true),l=bW(Object.assign({count:a.count,type:e.type,componentType:e.componentType},a.values),t,true);i=e.hasOwnProperty("bufferView")?bW({bufferView:e.bufferView,byteOffset:e.byteOffset,componentType:e.componentType,count:e.count,type:e.type},t,true).slice():new s(e.count*r);for(var u=0;u<a.count;++u)for(var c=o[u],h=0;h<r;++h)i[c*r+h]=l[u*r+h];}else if(e.hasOwnProperty("bufferView")){var f=t[e.bufferView];if(n&&f.hasOwnProperty("byteStride")){for(var d=r*s.BYTES_PER_ELEMENT,p=new ArrayBuffer(e.count*d),m=new Uint8Array(p),_=0,v=0;v<e.count;++v)for(var g=(e.byteOffset||0)+v*f.byteStride,y=0;y<d;++y)m[_++]=f[g++];i=new s(p);}else i=new s(f.buffer,f.byteOffset+(e.byteOffset||0),e.count*r);}else i=new s(e.count*r);return i},bj=function(e,t){var n=bW(e,t,true);if(bM(n,Float32Array)||!e.normalized)return n;var i=new Float32Array(n.length);return bH(i,n,bF(e.componentType)),i},bX=function(e){var t=e.min,n=e.max;if(!t||!n)return null;if(e.normalized){var i=bF(e.componentType);t=bH([],t,i),n=bH([],n,i);}return new e8(new eW((n[0]+t[0])*.5,(n[1]+t[1])*.5,(n[2]+t[2])*.5),new eW((n[0]-t[0])*.5,(n[1]-t[1])*.5,(n[2]-t[2])*.5))},bY=function(e){if(!e.hasOwnProperty("mode"))return 4;switch(e.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:default:return 4;case 5:return 5;case 6:return 6}},bq=function(e){for(var t=new Uint16Array(e),n=0;n<e;n++)t[n]=n;return t},bK=function(e,t){var n,i=e[tT];if(i&&3===i.components){if(i.size!==i.stride){var r=i.stride/n_[i.type],s=new nm[i.type](i.buffer,i.offset,i.count*r);n=new nm[i.type](3*i.count);for(var a=0;a<i.count;++a)n[3*a+0]=s[a*r+0],n[3*a+1]=s[a*r+1],n[3*a+2]=s[a*r+2];}else n=new nm[i.type](i.buffer,i.offset,3*i.count);var o=i.count;t||(t=bq(o));var l=h6(n,t),u=new Float32Array(l.length);u.set(l),e[tE]={buffer:u.buffer,size:12,offset:0,stride:12,count:o,components:3,type:6};}},bZ=function(e){var t=new nO(e.device,e);return t._levels=function(e){for(var t=[],n=0;n<e._levels.length;++n){var i=[];if(e.cubemap)for(var r=0;r<6;++r)i.push(e._levels[n][r]);else i=e._levels[n];t.push(i);}return t}(e),t},bQ=function(e){var t=new pZ(""+e.name+"_clone",e.type,e.file,e.data,e.options);return t.loaded=true,t.resource=bZ(e.resource),e.registry.add(t),t},bJ=function(e,t){var n,i,r,s,a,o,l,u,c,h=t[tT];if(!h)return null;var f=h.count,d=[];for(var p in t)if(t.hasOwnProperty(p)){var m={semantic:p,components:t[p].components,type:t[p].type,normalize:!!t[p].normalize};!n6.isElementValid(e,m)&&m.components++,d.push(m);}d.sort(function(e,t){return bV[e.semantic]-bV[t.semantic]});var _=new n6(e,d),v=true;for(n=0;n<_.elements.length;++n)if(o=(s=t[(a=_.elements[n]).name]).offset-h.offset,s.buffer!==h.buffer||s.stride!==a.stride||s.size!==a.size||o!==a.offset){v=false;break}var g=new n1(e,_,f),y=new Uint32Array(g.lock());if(v)l=new Uint32Array(h.buffer,h.offset,f*g.format.size/4),y.set(l);else for(n=0;n<g.format.elements.length;++n){u=(a=g.format.elements[n]).stride/4,c=(s=t[a.name]).stride/4,l=new Uint32Array(s.buffer,s.offset,(s.count-1)*c+(s.size+3)/4);var S=0,x=a.offset/4,b=Math.floor((s.size+3)/4);for(i=0;i<f;++i){for(r=0;r<b;++r)y[x+r]=l[S+r];S+=c,x+=u;}}return g.unlock(),g},b$=function(e,t,n,i,r,s){var a={},o=[];for(var l in t)t.hasOwnProperty(l)&&bz.hasOwnProperty(l)&&(a[l]=t[l],o.push(l+":"+t[l]));o.sort();var u=o.join(),c=s[u];if(!c){var h={};for(var f in a){var d=i[t[f]],p=bW(d,r),m=r[d.bufferView],_=bz[f],v=bN(d.type)*bB(d.componentType),g=m&&m.hasOwnProperty("byteStride")?m.byteStride:v;h[_]={buffer:p.buffer,size:v,offset:p.byteOffset,stride:g,count:d.count,components:bN(d.type),type:bF(d.componentType),normalize:d.normalized};}h.hasOwnProperty(tE)||bK(h,n),c=bJ(e,h),s[u]=c;}return c},b0=function(e,t,n,i,r,s){var a,o,l,u=t.joints,c=u.length,h=[];if(t.hasOwnProperty("inverseBindMatrices")){var f=bW(n[t.inverseBindMatrices],i,true),d=[];for(a=0;a<c;a++){for(o=0;o<16;o++)d[o]=f[16*a+o];(l=new e$).set(d),h.push(l);}}else for(a=0;a<c;a++)l=new e$,h.push(l);var p=[];for(a=0;a<c;a++)p[a]=r[u[a]].name;var m=p.join("#"),_=s.get(m);return _||(_=new fU(e,h,p),s.set(m,_)),_},b1=function(e,t,n,i,r,s,a){var o=new l_(e);o.aabb=bX(n[t.attributes.POSITION]);for(var l,u,c=[],h=bR(Object.entries(t.attributes));!(u=h()).done;){var f,d=u.value,p=d[0],m=n[d[1]],_=bz[p],v=bF(m.componentType);c.push({semantic:_,components:bN(m.type),type:v,normalize:null!=(f=m.normalized)?f:_===tP&&(1===v||3===v)});}if(a.push(new Promise(function(n,r){var s,a=t.extensions.KHR_draco_mesh_compression;s=i[a.bufferView].slice().buffer,bI()&&F.enqueueJob(s,function(i,s){if(i)r(i);else {for(var l,u,h={},f=bR(Object.entries(a.attributes));!(u=f()).done;){var d=u.value,p=d[0],m=d[1];h[bz[p]]=s.attributes.indexOf(m);}c.sort(function(e,t){return h[e.semantic]-h[t.semantic]}),(null==(l=t.attributes)?void 0:l.NORMAL)||c.splice(1,0,{semantic:"NORMAL",components:3,type:6});var _=new n6(e,c),v=s.vertices.byteLength/_.size,g=s.indices.byteLength/(v<=65535?2:4),y=new n1(e,_,v,{data:s.vertices}),S=new s$(e,v<=65535?1:2,g,0,s.indices);o.vertexBuffer=y,o.indexBuffer[0]=S,o.primitive[0].type=bY(t),o.primitive[0].base=0,o.primitive[0].count=S?g:v,o.primitive[0].indexed=!!S,n();}});})),null==t||null==(l=t.extensions)?void 0:l.KHR_materials_variants){var g=t.extensions.KHR_materials_variants,y={};g.mappings.forEach(function(e){e.variants.forEach(function(t){y[t]=e.material;});}),r[o.id]=y;}return s[o.id]=t.material,o},b2=function(e,t,n,i,r,s,a,o,l){var u=[];return t.primitives.forEach(function(c){var h;if(null==(h=c.extensions)?void 0:h.KHR_draco_mesh_compression)u.push(b1(e,c,n,i,s,a,l));else {var f=c.hasOwnProperty("indices")?bW(n[c.indices],i,true):null,d=b$(e,c.attributes,f,n,i,r),p=bY(c),m=new l_(e);if(m.vertexBuffer=d,m.primitive[0].type=p,m.primitive[0].base=0,m.primitive[0].indexed=null!==f,null!==f){0==(_=bM(f,Uint8Array)?0:bM(f,Uint16Array)?1:2)&&e.isWebGPU&&(_=1,f=new Uint16Array(f));var _,v=new s$(e,_,f.length,0,f);m.indexBuffer[0]=v,m.primitive[0].count=f.length;}else m.primitive[0].count=d.numVertices;if(c.hasOwnProperty("extensions")&&c.extensions.hasOwnProperty("KHR_materials_variants")){var g=c.extensions.KHR_materials_variants,y={};g.mappings.forEach(function(e){e.variants.forEach(function(t){y[t]=e.material;});}),s[m.id]=y;}a[m.id]=c.material;var S=n[c.attributes.POSITION];if(m.aabb=bX(S),c.hasOwnProperty("targets")){var x=[];c.targets.forEach(function(e,r){var s={};e.hasOwnProperty("POSITION")&&(s.deltaPositions=bj(S=n[e.POSITION],i),s.aabb=bX(S)),e.hasOwnProperty("NORMAL")&&(s.deltaNormals=bj(S=n[e.NORMAL],i)),t.hasOwnProperty("extras")&&t.extras.hasOwnProperty("targetNames")?s.name=t.extras.targetNames[r]:s.name=r.toString(10),t.hasOwnProperty("weights")&&(s.defaultWeight=t.weights[r]),s.preserveData=o.morphPreserveData,x.push(new hi(s));}),m.morph=new hn(x,e,{preferHighPrecision:o.morphPreferHighPrecision});}u.push(m);}}),u},b3=function(e,t,n){var i,r,s=e.texCoord;if(s)for(r=0;r<n.length;++r)t[""+n[r]+"MapUv"]=s;var a=null==(i=e.extensions)?void 0:i.KHR_texture_transform;if(a){var o=a.offset||[0,0],l=a.scale||[1,1],u=a.rotation?-a.rotation*ek.RAD_TO_DEG:0,c=new eX(l[0],l[1]),h=new eX(o[0],1-l[1]-o[1]);for(r=0;r<n.length;++r)t[""+n[r]+"MapTiling"]=c,t[""+n[r]+"MapOffset"]=h,t[""+n[r]+"MapRotation"]=u;}},b4=function(e,t,n){var i,r;if(e.hasOwnProperty("diffuseFactor")?(i=e.diffuseFactor,t.diffuse.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)),t.opacity=i[3]):(t.diffuse.set(1,1,1),t.opacity=1),e.hasOwnProperty("diffuseTexture")){var s=e.diffuseTexture;t.diffuseMap=r=n[s.index],t.diffuseMapChannel="rgb",t.opacityMap=r,t.opacityMapChannel="a",b3(s,t,["diffuse","opacity"]);}if(t.useMetalness=false,e.hasOwnProperty("specularFactor")?(i=e.specularFactor,t.specular.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2))):t.specular.set(1,1,1),e.hasOwnProperty("glossinessFactor")?t.gloss=e.glossinessFactor:t.gloss=1,e.hasOwnProperty("specularGlossinessTexture")){var a=e.specularGlossinessTexture;t.specularMap=t.glossMap=n[a.index],t.specularMapChannel="rgb",t.glossMapChannel="a",b3(a,t,["gloss","metalness"]);}},b5=function(e,t,n){if(e.hasOwnProperty("clearcoatFactor")?t.clearCoat=.25*e.clearcoatFactor:t.clearCoat=0,e.hasOwnProperty("clearcoatTexture")){var i=e.clearcoatTexture;t.clearCoatMap=n[i.index],t.clearCoatMapChannel="r",b3(i,t,["clearCoat"]);}if(e.hasOwnProperty("clearcoatRoughnessFactor")?t.clearCoatGloss=e.clearcoatRoughnessFactor:t.clearCoatGloss=0,e.hasOwnProperty("clearcoatRoughnessTexture")){var r=e.clearcoatRoughnessTexture;t.clearCoatGlossMap=n[r.index],t.clearCoatGlossMapChannel="g",b3(r,t,["clearCoatGloss"]);}if(e.hasOwnProperty("clearcoatNormalTexture")){var s=e.clearcoatNormalTexture;t.clearCoatNormalMap=n[s.index],b3(s,t,["clearCoatNormal"]),s.hasOwnProperty("scale")?t.clearCoatBumpiness=s.scale:t.clearCoatBumpiness=1;}t.clearCoatGlossInvert=true;},b8=function(e,t,n){t.useLighting=false,t.emissive.copy(t.diffuse),t.emissiveMap=t.diffuseMap,t.emissiveMapUv=t.diffuseMapUv,t.emissiveMapTiling.copy(t.diffuseMapTiling),t.emissiveMapOffset.copy(t.diffuseMapOffset),t.emissiveMapRotation=t.diffuseMapRotation,t.emissiveMapChannel=t.diffuseMapChannel,t.emissiveVertexColor=t.diffuseVertexColor,t.emissiveVertexColorChannel=t.diffuseVertexColorChannel,t.useLighting=false,t.useSkybox=false,t.diffuse.set(1,1,1),t.diffuseMap=null,t.diffuseVertexColor=false;},b6=function(e,t,n){if(t.useMetalnessSpecularColor=true,e.hasOwnProperty("specularColorTexture")&&(t.specularMap=n[e.specularColorTexture.index],t.specularMapChannel="rgb",b3(e.specularColorTexture,t,["specular"])),e.hasOwnProperty("specularColorFactor")){var i=e.specularColorFactor;t.specular.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2));}else t.specular.set(1,1,1);e.hasOwnProperty("specularFactor")?t.specularityFactor=e.specularFactor:t.specularityFactor=1,e.hasOwnProperty("specularTexture")&&(t.specularityFactorMapChannel="a",t.specularityFactorMap=n[e.specularTexture.index],b3(e.specularTexture,t,["specularityFactor"]));},b9=function(e,t,n){e.hasOwnProperty("ior")&&(t.refractionIndex=1/e.ior);},b7=function(e,t,n){e.hasOwnProperty("dispersion")&&(t.dispersion=e.dispersion);},Te=function(e,t,n){t.blendType=2,t.useDynamicRefraction=true,e.hasOwnProperty("transmissionFactor")&&(t.refraction=e.transmissionFactor),e.hasOwnProperty("transmissionTexture")&&(t.refractionMapChannel="r",t.refractionMap=n[e.transmissionTexture.index],b3(e.transmissionTexture,t,["refraction"]));},Tt=function(e,t,n){if(t.useSheen=true,e.hasOwnProperty("sheenColorFactor")){var i=e.sheenColorFactor;t.sheen.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2));}else t.sheen.set(1,1,1);e.hasOwnProperty("sheenColorTexture")&&(t.sheenMap=n[e.sheenColorTexture.index],b3(e.sheenColorTexture,t,["sheen"])),t.sheenGloss=e.hasOwnProperty("sheenRoughnessFactor")?e.sheenRoughnessFactor:0,e.hasOwnProperty("sheenRoughnessTexture")&&(t.sheenGlossMap=n[e.sheenRoughnessTexture.index],t.sheenGlossMapChannel="a",b3(e.sheenRoughnessTexture,t,["sheenGloss"])),t.sheenGlossInvert=true;},Tn=function(e,t,n){if(t.blendType=2,t.useDynamicRefraction=true,e.hasOwnProperty("thicknessFactor")&&(t.thickness=e.thicknessFactor),e.hasOwnProperty("thicknessTexture")&&(t.thicknessMap=n[e.thicknessTexture.index],t.thicknessMapChannel="g",b3(e.thicknessTexture,t,["thickness"])),e.hasOwnProperty("attenuationDistance")&&(t.attenuationDistance=e.attenuationDistance),e.hasOwnProperty("attenuationColor")){var i=e.attenuationColor;t.attenuation.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2));}},Ti=function(e,t,n){e.hasOwnProperty("emissiveStrength")&&(t.emissiveIntensity=e.emissiveStrength);},Tr=function(e,t,n){t.useIridescence=true,e.hasOwnProperty("iridescenceFactor")&&(t.iridescence=e.iridescenceFactor),e.hasOwnProperty("iridescenceTexture")&&(t.iridescenceMapChannel="r",t.iridescenceMap=n[e.iridescenceTexture.index],b3(e.iridescenceTexture,t,["iridescence"])),e.hasOwnProperty("iridescenceIor")&&(t.iridescenceRefractionIndex=e.iridescenceIor),e.hasOwnProperty("iridescenceThicknessMinimum")&&(t.iridescenceThicknessMin=e.iridescenceThicknessMinimum),e.hasOwnProperty("iridescenceThicknessMaximum")&&(t.iridescenceThicknessMax=e.iridescenceThicknessMaximum),e.hasOwnProperty("iridescenceThicknessTexture")&&(t.iridescenceThicknessMapChannel="g",t.iridescenceThicknessMap=n[e.iridescenceThicknessTexture.index],b3(e.iridescenceThicknessTexture,t,["iridescenceThickness"]));},Ts=function(e,t,n){if(t.enableGGXSpecular=true,e.hasOwnProperty("anisotropyStrength")?t.anisotropyIntensity=e.anisotropyStrength:t.anisotropyIntensity=0,e.hasOwnProperty("anisotropyTexture")){var i=e.anisotropyTexture;t.anisotropyMap=n[i.index],b3(i,t,["anisotropy"]);}e.hasOwnProperty("anisotropyRotation")?t.anisotropyRotation=e.anisotropyRotation*ek.RAD_TO_DEG:t.anisotropyRotation=0;},Ta=function(e,t){var n,i,r=new dw;if(e.hasOwnProperty("name")&&(r.name=e.name),r.occludeSpecular=1,r.diffuseVertexColor=true,r.specularTint=true,r.specularVertexColor=true,r.specular.set(1,1,1),r.gloss=1,r.glossInvert=true,r.useMetalness=true,e.hasOwnProperty("pbrMetallicRoughness")){var s=e.pbrMetallicRoughness;if(s.hasOwnProperty("baseColorFactor")&&(n=s.baseColorFactor,r.diffuse.set(Math.pow(n[0],1/2.2),Math.pow(n[1],1/2.2),Math.pow(n[2],1/2.2)),r.opacity=n[3]),s.hasOwnProperty("baseColorTexture")){var a=s.baseColorTexture;r.diffuseMap=i=t[a.index],r.diffuseMapChannel="rgb",r.opacityMap=i,r.opacityMapChannel="a",b3(a,r,["diffuse","opacity"]);}if(s.hasOwnProperty("metallicFactor")&&(r.metalness=s.metallicFactor),s.hasOwnProperty("roughnessFactor")&&(r.gloss=s.roughnessFactor),s.hasOwnProperty("metallicRoughnessTexture")){var o=s.metallicRoughnessTexture;r.metalnessMap=r.glossMap=t[o.index],r.metalnessMapChannel="b",r.glossMapChannel="g",b3(o,r,["gloss","metalness"]);}}if(e.hasOwnProperty("normalTexture")){var l=e.normalTexture;r.normalMap=t[l.index],b3(l,r,["normal"]),l.hasOwnProperty("scale")&&(r.bumpiness=l.scale);}if(e.hasOwnProperty("occlusionTexture")){var u=e.occlusionTexture;r.aoMap=t[u.index],r.aoMapChannel="r",b3(u,r,["ao"]);}if(e.hasOwnProperty("emissiveFactor")&&(n=e.emissiveFactor,r.emissive.set(Math.pow(n[0],1/2.2),Math.pow(n[1],1/2.2),Math.pow(n[2],1/2.2))),e.hasOwnProperty("emissiveTexture")){var c=e.emissiveTexture;r.emissiveMap=t[c.index],b3(c,r,["emissive"]);}if(e.hasOwnProperty("alphaMode"))switch(e.alphaMode){case "MASK":r.blendType=3,e.hasOwnProperty("alphaCutoff")?r.alphaTest=e.alphaCutoff:r.alphaTest=.5;break;case "BLEND":r.blendType=2,r.depthWrite=false;break;default:r.blendType=3;}else r.blendType=3;e.hasOwnProperty("doubleSided")?(r.twoSidedLighting=e.doubleSided,r.cull=+!e.doubleSided):(r.twoSidedLighting=false,r.cull=1);var h={KHR_materials_clearcoat:b5,KHR_materials_emissive_strength:Ti,KHR_materials_ior:b9,KHR_materials_dispersion:b7,KHR_materials_iridescence:Tr,KHR_materials_pbrSpecularGlossiness:b4,KHR_materials_sheen:Tt,KHR_materials_specular:b6,KHR_materials_transmission:Te,KHR_materials_unlit:b8,KHR_materials_volume:Tn,KHR_materials_anisotropy:Ts};if(e.hasOwnProperty("extensions"))for(var f in e.extensions){var d=h[f];void 0!==d&&d(e.extensions[f],r,t);}return r.update(),r},To=function(e,t,n,i,r,s,a){var o,l,u=function(e){return new bw(bN(e.type),bj(e,i))},c={STEP:0,LINEAR:1,CUBICSPLINE:2},h={},f={},d={},p=1;for(o=0;o<e.samplers.length;++o){var m=e.samplers[o];h.hasOwnProperty(m.input)||(h[m.input]=u(n[m.input])),f.hasOwnProperty(m.output)||(f[m.output]=u(n[m.output]));var _=m.hasOwnProperty("interpolation")&&c.hasOwnProperty(m.interpolation)?c[m.interpolation]:1,v={paths:[],input:m.input,output:m.output,interpolation:_};d[o]=v;}var g=[],y={translation:"localPosition",rotation:"localRotation",scale:"localScale"};for(o=0;o<e.channels.length;++o){var S=e.channels[o],x=S.target,b=d[S.sampler],T=r[x.node],E=a[x.node],w=function(e){for(var t=[];e;)t.unshift(e.name),e=e.parent;return t}(T);x.path.startsWith("weights")?(!function(e,t,n){var i,r=f[e.output];if(r){if(s&&s[t.mesh]){var a=s[t.mesh];a.hasOwnProperty("extras")&&a.extras.hasOwnProperty("targetNames")&&(i=a.extras.targetNames);}for(var l=r.data,u=l.length/h[e.input].data.length,c=l.length/u,m=4*c,_=new ArrayBuffer(m*u),v=0;v<u;v++){for(var g=new Float32Array(_,m*v,c),y=0;y<c;y++)g[y]=l[y*u+v];var S=new bw(1,g),x=(null==i?void 0:i[v])?"name."+i[v]:v;f[-p]=S;var b={paths:[{entityPath:n,component:"graph",propertyPath:["weight."+x]}],input:e.input,output:-p,interpolation:e.interpolation};p++,d["morphCurve-"+o+"-"+v]=b;}}}(b,E,w),d[S.sampler].morphCurve=true):b.paths.push({entityPath:w,component:"graph",propertyPath:[y[x.path]]});}var A=[],C=[],P=[];for(var I in h)A.push(h[I]),h[I]=A.length-1;for(var L in f)C.push(f[L]),f[L]=C.length-1;for(var D in d){var M=d[D];!M.morphCurve&&(P.push(new bE(M.paths,h[M.input],f[M.output],M.interpolation)),M.paths.length>0&&"localRotation"===M.paths[0].propertyPath[0]&&2!==M.interpolation&&g.push(P[P.length-1].output));}g.sort();var R=null;for(o=0;o<g.length;++o){var O=g[o];if(0===o||O!==R){if(4===(l=C[O]).components)for(var k=l.data,N=k.length-4,F=0;F<N;F+=4)k[F+0]*k[F+4]+k[F+1]*k[F+5]+k[F+2]*k[F+6]+k[F+3]*k[F+7]<0&&(k[F+4]*=-1,k[F+5]*=-1,k[F+6]*=-1,k[F+7]*=-1);R=O;}}var B=0;for(o=0;o<A.length;o++)B=Math.max(B,0===(l=A[o]._data).length?0:l[l.length-1]);return new _v(e.hasOwnProperty("name")?e.name:"animation_"+t,B,A,C,P)},Tl=new e$,Tu=new eW,Tc=function(e,t,n){var i=new us;if(e.hasOwnProperty("name")&&e.name.length>0?i.name=e.name:i.name="node_"+t,e.hasOwnProperty("matrix")&&(Tl.data.set(e.matrix),Tl.getTranslation(Tu),i.setLocalPosition(Tu),Tl.getEulerAngles(Tu),i.setLocalEulerAngles(Tu),Tl.getScale(Tu),i.setLocalScale(Tu)),e.hasOwnProperty("rotation")){var r=e.rotation;i.setLocalRotation(r[0],r[1],r[2],r[3]);}if(e.hasOwnProperty("translation")){var s=e.translation;i.setLocalPosition(s[0],s[1],s[2]);}if(e.hasOwnProperty("scale")){var a=e.scale;i.setLocalScale(a[0],a[1],a[2]);}return e.hasOwnProperty("extensions")&&e.extensions.EXT_mesh_gpu_instancing&&n.set(e,{ext:e.extensions.EXT_mesh_gpu_instancing}),i},Th=function(e,t){var n=+("orthographic"===e.type),i=1===n?e.orthographic:e.perspective,r={enabled:false,projection:n,nearClip:i.znear,aspectRatioMode:0};i.zfar&&(r.farClip=i.zfar),1===n?(r.orthoHeight=.5*i.ymag,i.ymag&&(r.aspectRatioMode=1,r.aspectRatio=i.xmag/i.ymag)):(r.fov=i.yfov*ek.RAD_TO_DEG,i.aspectRatio&&(r.aspectRatioMode=1,r.aspectRatio=i.aspectRatio));var s=new my(e.name);return s.addComponent("camera",r),s},Tf=function(e,t){var n={enabled:false,type:"point"===e.type?"omni":e.type,color:e.hasOwnProperty("color")?new eN(e.color):eN.WHITE,range:e.hasOwnProperty("range")?e.range:9999,falloffMode:1,intensity:e.hasOwnProperty("intensity")?ek.clamp(e.intensity,0,2):1};e.hasOwnProperty("spot")&&(n.innerConeAngle=e.spot.hasOwnProperty("innerConeAngle")?e.spot.innerConeAngle*ek.RAD_TO_DEG:0,n.outerConeAngle=e.spot.hasOwnProperty("outerConeAngle")?e.spot.outerConeAngle*ek.RAD_TO_DEG:Math.PI/4),e.hasOwnProperty("intensity")&&(n.luminance=e.intensity*c6.getLightUnitConversion(c2[n.type],n.outerConeAngle,n.innerConeAngle));var i=new my(t.name);return i.rotateLocal(90,0,0),i.addComponent("light",n),i},Td=function(e,t,n,i){if(!t.hasOwnProperty("skins")||0===t.skins.length)return [];var r=new Map;return t.skins.map(function(s){return b0(e,s,t.accessors,i,n,r)})},Tp=function(e,t,n,i){var r,s,a,o={},l={},u={},c=[];return {meshes:!i.skipMeshes&&(null==t||null==(r=t.meshes)?void 0:r.length)&&(null==t||null==(s=t.accessors)?void 0:s.length)&&(null==t||null==(a=t.bufferViews)?void 0:a.length)?t.meshes.map(function(r){return b2(e,r,t.accessors,n,o,l,u,i,c)}):[],meshVariants:l,meshDefaultMaterials:u,promises:c}},Tm=function(e,t,n){if(!e.hasOwnProperty("materials")||0===e.materials.length)return [];var i,r,s,a,o=null==n||null==(i=n.material)?void 0:i.preprocess,l=null!=(a=null==n||null==(r=n.material)?void 0:r.process)?a:Ta,u=null==n||null==(s=n.material)?void 0:s.postprocess;return e.materials.map(function(e){o&&o(e);var n=l(e,t);return u&&u(e,n),n})},T_=function(e){if(!e.hasOwnProperty("extensions")||!e.extensions.hasOwnProperty("KHR_materials_variants"))return null;for(var t=e.extensions.KHR_materials_variants.variants,n={},i=0;i<t.length;i++)n[t[i].name]=i;return n},Tv=function(e,t,n,i){if(!e.hasOwnProperty("animations")||0===e.animations.length)return [];var r,s,a=null==i||null==(r=i.animation)?void 0:r.preprocess,o=null==i||null==(s=i.animation)?void 0:s.postprocess;return e.animations.map(function(i,r){a&&a(i);var s=To(i,r,e.accessors,n,t,e.meshes,e.nodes);return o&&o(i,s),s})},Tg=function(e,t,n,i){var r=t.accessors;n.forEach(function(e,t){var n,s,a,o=e.ext.attributes;o.hasOwnProperty("TRANSLATION")&&(n=bj(r[o.TRANSLATION],i)),o.hasOwnProperty("ROTATION")&&(s=bj(r[o.ROTATION],i)),o.hasOwnProperty("SCALE")&&(a=bj(r[o.SCALE],i));var l=(n?n.length/3:0)||(s?s.length/4:0)||(a?a.length/3:0);if(l){for(var u=new Float32Array(16*l),c=new eW,h=new e0,f=new eW(1,1,1),d=new e$,p=0,m=0;m<l;m++){var _=3*m;if(n&&c.set(n[_],n[_+1],n[_+2]),s){var v=4*m;h.set(s[v],s[v+1],s[v+2],s[v+3]);}a&&f.set(a[_],a[_+1],a[_+2]),d.setTRS(c,h,f);for(var g=0;g<16;g++)u[p++]=d.data[g];}e.matrices=u;}});},Ty=function(e,t,n){if(!e.hasOwnProperty("nodes")||0===e.nodes.length)return [];for(var i,r,s,a,o=null==t||null==(i=t.node)?void 0:i.preprocess,l=null!=(a=null==t||null==(r=t.node)?void 0:r.process)?a:Tc,u=null==t||null==(s=t.node)?void 0:s.postprocess,c=e.nodes.map(function(e,t){o&&o(e);var i=l(e,t,n);return u&&u(e,i),i}),h=0;h<e.nodes.length;++h){var f=e.nodes[h];if(f.hasOwnProperty("children"))for(var d=c[h],p={},m=0;m<f.children.length;++m){var _=c[f.children[m]];_.parent||(p.hasOwnProperty(_.name)?_.name+=p[_.name]++:p[_.name]=1,d.addChild(_));}}return c},TS=function(e,t){var n,i=[],r=e.scenes.length;if(1===r&&(null==(n=e.scenes[0].nodes)?void 0:n.length)===1){var s=e.scenes[0].nodes[0];i.push(t[s]);}else for(var a=0;a<r;a++){var o=e.scenes[a];if(o.nodes){for(var l=new us(o.name),u=0;u<o.nodes.length;u++){var c=t[o.nodes[u]];l.addChild(c);}i.push(l);}}return i},Tx=function(e,t,n){var i=null;if(e.hasOwnProperty("nodes")&&e.hasOwnProperty("cameras")&&e.cameras.length>0){var r,s,a,o,l=null==n||null==(r=n.camera)?void 0:r.preprocess,u=null!=(o=null==n||null==(s=n.camera)?void 0:s.process)?o:Th,c=null==n||null==(a=n.camera)?void 0:a.postprocess;e.nodes.forEach(function(n,r){if(n.hasOwnProperty("camera")){var s=e.cameras[n.camera];if(s){l&&l(s);var a=u(s,t[r]);c&&c(s,a),a&&(i||(i=new Map),i.set(n,a));}}});}return i},Tb=function(e,t,n){var i=null;if(e.hasOwnProperty("nodes")&&e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_lights_punctual")&&e.extensions.KHR_lights_punctual.hasOwnProperty("lights")){var r=e.extensions.KHR_lights_punctual.lights;if(r.length){var s,a,o,l,u=null==n||null==(s=n.light)?void 0:s.preprocess,c=null!=(l=null==n||null==(a=n.light)?void 0:a.process)?l:Tf,h=null==n||null==(o=n.light)?void 0:o.postprocess;e.nodes.forEach(function(e,n){if(e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_lights_punctual")&&e.extensions.KHR_lights_punctual.hasOwnProperty("light")){var s=r[e.extensions.KHR_lights_punctual.light];if(s){u&&u(s);var a=c(s,t[n]);h&&h(s,a),a&&(i||(i=new Map),i.set(e,a));}}});}}return i},TT=function(e,t,n){e.nodes.forEach(function(e){e.hasOwnProperty("mesh")&&e.hasOwnProperty("skin")&&t[e.mesh].meshes.forEach(function(t){t.skin=n[e.skin];});});},TE=(a=function(e,t,n,i,r){var s,a,o,l,u,c,h,f,d,p,m,_,v,g,y,S,x,b,T,E,w,A,C;return function(e,t){var n,i,r,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(l){var u=[o,l];if(n)throw TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(s=0)),s;)try{if(n=1,i&&(r=2&u[0]?i.return:u[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,u[1])).done)return r;switch(i=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,i=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===u[0]||2===u[0])){s=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){s.label=u[1];break}if(6===u[0]&&s.label<r[1]){s.label=r[1],r=u;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(u);break}r[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s);}catch(e){u=[6,e],i=0;}finally{n=r=0;}if(5&u[0])throw u[1];return {value:u[0]?u[1]:void 0,done:true}}}}(this,function(P){switch(P.label){case 0:return o=null==r||null==(s=r.global)?void 0:s.preprocess,l=null==r||null==(a=r.global)?void 0:a.postprocess,o&&o(t),t.asset&&t.asset.generator,c=Ty(t,r,u=new Map),h=TS(t,c),f=Tb(t,c,r),d=Tx(t,c,r),p=T_(t),[4,Promise.all(n)];case 1:return v=(_=Tp(e,t,m=P.sent(),r)).meshes,g=_.meshVariants,y=_.meshDefaultMaterials,S=_.promises,x=Tv(t,c,m,r),Tg(e,t,u,m),[4,Promise.all(i)];case 2:for(A=0,T=Tm(t,(b=P.sent()).map(function(e){return e.resource}),r),E=Td(e,t,c,m),w=[];A<v.length;A++)w[A]=new bg,w[A].meshes=v[A];return TT(t,w,E),(C=new bO).gltf=t,C.nodes=c,C.scenes=h,C.animations=x,C.textures=b,C.materials=T,C.variants=p,C.meshVariants=g,C.meshDefaultMaterials=y,C.renders=w,C.skins=E,C.lights=f,C.cameras=d,C.nodeInstancingMap=u,l&&l(t,C),[4,Promise.all(S)];case 3:return P.sent(),[2,C]}})},function(){var e=this,t=arguments;return new Promise(function(n,i){var r=a.apply(e,t);function s(e){bD(r,n,i,s,o,"next",e);}function o(e){bD(r,n,i,s,o,"throw",e);}s(void 0);})}),Tw=function(e,t){var n=function(e,t){switch(e){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return t}},i=function(e,t){switch(e){case 33071:return 1;case 33648:return 2;case 10497:return 0;default:return t}};e&&(e.minFilter=n((t=null!=t?t:{}).minFilter,5),e.magFilter=n(t.magFilter,1),e.addressU=i(t.wrapS,0),e.addressV=i(t.wrapT,0));},TA=0,TC=function(e){var t,n,i,r,s,a;return null!=(a=null!=(s=null==(n=e.extensions)||null==(t=n.KHR_texture_basisu)?void 0:t.source)?s:null==(r=e.extensions)||null==(i=r.EXT_texture_webp)?void 0:i.source)?a:e.source},TP=function(e,t,n,i,r){if(!e.images||0===e.images.length)return [];var s,a,o,l,u=null==r||null==(a=r.image)?void 0:a.preprocess,c=null==r||null==(o=r.image)?void 0:o.processAsync,h=null==r||null==(l=r.image)?void 0:l.postprocess,f={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},d=function(e,t,n,r,s,a){return new Promise(function(o,l){var u=function(n){var u=(e.name||"gltf-texture")+"-"+TA++,c={url:t||u};if(n&&(c.contents=n.slice(0).buffer),r){var h=f[r];h&&(c.filename=c.url+"."+h);}var d=new pZ(u,"texture",c,{srgb:a},s);d.on("load",function(e){return o(e)}),d.on("error",function(e){return l(e)}),i.add(d),i.load(d);};n?n.then(function(e){return u(e)}):u(null);})},p=(s=new Set,e.hasOwnProperty("materials")&&e.materials.forEach(function(t){if(t.hasOwnProperty("pbrMetallicRoughness")){var n=t.pbrMetallicRoughness;if(n.hasOwnProperty("baseColorTexture")){var i=e.textures[n.baseColorTexture.index];s.add(TC(i));}}if(t.hasOwnProperty("emissiveTexture")){var r=e.textures[t.emissiveTexture.index];s.add(TC(r));}if(t.hasOwnProperty("extensions")){var a=t.extensions.KHR_materials_sheen;if(a&&a.hasOwnProperty("sheenColorTexture")){var o=e.textures[a.sheenColorTexture.index];s.add(TC(o));}var l=t.extensions.KHR_materials_pbrSpecularGlossiness;if(l&&l.hasOwnProperty("specularGlossinessTexture")){var u=e.textures[l.specularGlossinessTexture.index];s.add(TC(u));}var c=t.extensions.KHR_materials_specular;if(c&&c.hasOwnProperty("specularColorTexture")){var h=e.textures[c.specularColorTexture.index];s.add(TC(h));}}}),s);return e.images.map(function(e,i){var r;return u&&u(e),r=(r=new Promise(c?function(t,n){c(e,function(e,i){e?n(e):t(i);});}:function(e){e(null);})).then(function(r){var s,a=p.has(i);if(r)return r;if(e.hasOwnProperty("uri"))return bk(e.uri)?d(e,e.uri,null,(s=e.uri).substring(s.indexOf(":")+1,s.indexOf(";")),null,a):d(e,pW.test(e.uri)?e.uri:en.join(n,e.uri),null,null,{crossOrigin:"anonymous"},a);return e.hasOwnProperty("bufferView")&&e.hasOwnProperty("mimeType")?d(e,null,t[e.bufferView],e.mimeType,null,a):Promise.reject(Error("Invalid image found in gltf (neither uri or bufferView found). index="+i))}),h&&(r=r.then(function(t){return h(e,t),t})),r})},TI=function(e,t,n){if(!(null==e||null==(i=e.images)?void 0:i.length)||!(null==e||null==(r=e.textures)?void 0:r.length))return [];var i,r,s,a,o,l=null==n||null==(s=n.texture)?void 0:s.preprocess,u=null==n||null==(a=n.texture)?void 0:a.processAsync,c=null==n||null==(o=n.texture)?void 0:o.postprocess,h=new Set;return e.textures.map(function(n){var i;return l&&l(n),i=(i=new Promise(u?function(t,i){u(n,e.images,function(e,n){e?i(e):t(n);});}:function(e){e(null);})).then(function(i){i=null!=i?i:TC(n);var r=h.has(i);return h.add(i),t[i].then(function(t){var i,s=r?bQ(t):t;return Tw(s.resource,(null!=(i=e.samplers)?i:[])[n.sampler]),s})}),c&&(i=i.then(function(e){return c(n,e),e})),i})},TL=function(e,t,n,i){if(!e.buffers||0===e.buffers.length)return [];var r,s,a,o=null==i||null==(r=i.buffer)?void 0:r.preprocess,l=null==i||null==(s=i.buffer)?void 0:s.processAsync,u=null==i||null==(a=i.buffer)?void 0:a.postprocess;return e.buffers.map(function(i,r){var s;return o&&o(i),s=(s=new Promise(l?function(e,t){l(i,function(n,i){n?t(n):e(i);});}:function(e){e(null);})).then(function(e){if(e)return e;if(i.hasOwnProperty("uri")){if(bk(i.uri)){for(var r=atob(i.uri.split(",")[1]),s=new Uint8Array(r.length),a=0;a<r.length;a++)s[a]=r.charCodeAt(a);return s}return new Promise(function(e,t){aq.get(pW.test(i.uri)?i.uri:en.join(n,i.uri),{cache:true,responseType:"arraybuffer",retry:false},function(n,i){n?t(n):e(new Uint8Array(i));});})}return t}),u&&(s=s.then(function(t){return u(e.buffers[r],t),t})),s})},TD=function(e,t){var n=JSON.parse(function(e){if("undefined"!=typeof TextDecoder)return new TextDecoder().decode(e);for(var t="",n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return decodeURIComponent(escape(t))}(e));if(n.asset&&n.asset.version&&2>parseFloat(n.asset.version))return void t("Invalid gltf version. Expected version 2.0 or above but found version '"+n.asset.version+"'.");t(null,n);},TM=function(e,t){var n=bM(e,ArrayBuffer)?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),i=n.getUint32(0,true),r=n.getUint32(4,true),s=n.getUint32(8,true);if(0x46546c67!==i)return void t("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+i.toString(16));if(2!==r)return void t("Invalid version number found in glb header. Expected 2, found "+r);if(s<=0||s>n.byteLength)return void t("Invalid length found in glb header. Found "+s);for(var a=[],o=12;o<s;){var l=n.getUint32(o,true);o+l+8>n.byteLength&&t("Invalid chunk length found in glb. Found "+l);var u=n.getUint32(o+4,true),c=new Uint8Array(n.buffer,n.byteOffset+o+8,l);a.push({length:l,type:u,data:c}),o+=l+8;}return 1!==a.length&&2!==a.length?void t("Invalid number of chunks found in glb file."):0x4e4f534a!==a[0].type?void t("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+a[0].type.toString(16)):a.length>1&&5130562!==a[1].type?void t("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+a[1].type.toString(16)):void t(null,{gltfChunk:a[0].data,binaryChunk:2===a.length?a[1].data:null})},TR=function(e,t,n){var i;e&&e.toLowerCase().endsWith(".glb")||103===(i=new Uint8Array(t))[0]&&108===i[1]&&84===i[2]&&70===i[3]?TM(t,n):n(null,{gltfChunk:t,binaryChunk:null});},TO=function(e,t,n){var i,r,s,a,o=[],l=null==n||null==(i=n.bufferView)?void 0:i.preprocess,u=null==n||null==(r=n.bufferView)?void 0:r.processAsync,c=null==n||null==(s=n.bufferView)?void 0:s.postprocess;if(!(null==(a=e.bufferViews)?void 0:a.length))return o;for(var h=0;h<e.bufferViews.length;++h)!function(n){var i=e.bufferViews[n];l&&l(i);var r=void 0;r=(r=new Promise(u?function(e,n){u(i,t,function(t,i){t?n(t):e(i);});}:function(e){e(null);})).then(function(e){return e||t[i.buffer].then(function(e){return new Uint8Array(e.buffer,e.byteOffset+(i.byteOffset||0),i.byteLength)})}),i.hasOwnProperty("byteStride")&&(r=r.then(function(e){return e.byteStride=i.byteStride,e})),c&&(r=r.then(function(e){return c(i,e),e})),o.push(r);}(h);return o},Tk=function(){function e(){}return e.parse=function(e,t,n,i,r,s,a){TR(e,n,function(e,n){if(e)return void a(e);TD(n.gltfChunk,function(e,o){if(e)return void a(e);var l=TL(o,n.binaryChunk,t,s),u=TO(o,l,s),c=TP(o,u,t,r,s),h=TI(o,c,s);TE(i,o,u,h,s).then(function(e){return a(null,e)}).catch(function(e){return a(e)});});});},e.createDefaultMaterial=function(){return Ta({name:"defaultGlbMaterial"},[])},e}();function TN(e,t){return (TN=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var TF=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"animation")||this).device=t.graphicsDevice,n.assets=t.assets,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&TN(t,e);var n=t.prototype;return n.load=function(e,t,n){var i=this;"string"==typeof e&&(e={load:e,original:e});var r={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.load.startsWith("blob:")||e.load.startsWith("data:"))&&(".glb"===en.getExtension(e.original).toLowerCase()?r.responseType=aY.ResponseType.ARRAY_BUFFER:r.responseType=aY.ResponseType.JSON),aq.get(e.load,r,function(r,s){if(r)t("Error loading animation resource: "+e.original+" ["+r+"]");else if(".glb"===en.getExtension(e.original).toLowerCase()){var a;Tk.parse("filename.glb","",s,i.device,i.assets,null!=(a=null==n?void 0:n.options)?a:{},function(e,i){if(e)t(e);else {var r,s=i.animations;if(null==n||null==(r=n.data)?void 0:r.events)for(var a=0;a<s.length;a++)s[a].events=new __(Object.values(n.data.events));i.destroy(),t(null,s);}});}else t(null,i["_parseAnimationV"+s.animation.version](s));});},n.open=function(e,t,n){return t},n._parseAnimationV3=function(e){var t=e.animation,n=new fK;n.name=t.name,n.duration=t.duration;for(var i=0;i<t.nodes.length;i++){var r=new fq,s=t.nodes[i];r._name=s.name;for(var a=0;a<s.keys.length;a++){var o=s.keys[a],l=o.time,u=o.pos,c=o.rot,h=o.scale,f=new fY(l,new eW(u[0],u[1],u[2]),new e0().setFromEulerAngles(c[0],c[1],c[2]),new eW(h[0],h[1],h[2]));r._keys.push(f);}n.addNode(r);}return n},n._parseAnimationV4=function(e){var t=e.animation,n=new fK;n.name=t.name,n.duration=t.duration;for(var i=0;i<t.nodes.length;i++){var r=new fq,s=t.nodes[i];r._name=s.name;for(var a=s.defaults.p,o=s.defaults.r,l=s.defaults.s,u=0;u<s.keys.length;u++){var c=s.keys[u],h=c.t,f=a||c.p,d=o||c.r,p=l||c.s,m=new fY(h,new eW(f[0],f[1],f[2]),new e0().setFromEulerAngles(d[0],d[1],d[2]),new eW(p[0],p[1],p[2]));r._keys.push(m);}n.addNode(r);}return n},t}(mn);function TB(e,t){return (TB=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var TU=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){return e.call(this,t,"animclip")||this}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&TB(t,e);var n=t.prototype;return n.load=function(e,t){"string"==typeof e&&(e={load:e,original:e});var n={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(n.responseType=aY.ResponseType.JSON),aq.get(e.load,n,function(n,i){n?t("Error loading animation clip resource: "+e.original+" ["+n+"]"):t(null,i);});},n.open=function(e,t){return new _v(t.name,t.duration,t.inputs.map(function(e){return new bw(1,e)}),t.outputs.map(function(e){return new bw(e.components,e.data)}),t.curves.map(function(e){return new bE([e.path],e.inputIndex,e.outputIndex,e.interpolation)}))},t}(mn);function Tz(e,t){return (Tz=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var TV=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){return e.call(this,t,"animstategraph")||this}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Tz(t,e);var n=t.prototype;return n.load=function(e,t){"string"==typeof e&&(e={load:e,original:e});var n={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(n.responseType=aY.ResponseType.JSON),aq.get(e.load,n,function(n,i){n?t("Error loading animation state graph resource: "+e.original+" ["+n+"]"):t(null,i);});},n.open=function(e,t){return new _$(t)},t}(mn);function TG(e,t){return (TG=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var TH=function(){if("undefined"==typeof window)return  false;var e=window.navigator.userAgent,t=e.indexOf("MSIE ");if(t>0)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);if(e.indexOf("Trident/")>0){var n=e.indexOf("rv:");return parseInt(e.substring(n+3,e.indexOf(".",n)),10)}return  false}(),TW=[".ogg",".mp3",".wav",".mp4a",".m4a",".mp4",".aac",".opus"],Tj=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"audio")||this).manager=t.soundManager,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&TG(t,e);var n=t.prototype;return n._isSupported=function(e){var t=en.getExtension(e);return TW.indexOf(t)>-1},n.load=function(e,t){"string"==typeof e&&(e={load:e,original:e});var n=function(n){var i="Error loading audio url: "+e.original;n&&(i+=": "+(n.message||n)),t(i);};if(this._createSound){if(!this._isSupported(e.original))return void n("Audio format for "+e.original+" not supported");this._createSound(e.load,function(e){t(null,new a3(e));},n);}else n(null);},n._createSound=function(e,t,n){if(a4()){var i=this.manager;if(!i.context)return void n("Audio manager has no audio context");var r={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.startsWith("blob:")||e.startsWith("data:"))&&(r.responseType=aY.ResponseType.ARRAY_BUFFER),aq.get(e,r,function(e,r){if(e)return void n(e);i.context.decodeAudioData(r,t,n);});}else {var s=null;try{s=new Audio;}catch(e){n("No support for Audio element");return}TH&&document.body.appendChild(s);var a=function(){s.removeEventListener("canplaythrough",a),TH&&document.body.removeChild(s),t(s);};s.onerror=function(){s.onerror=null,TH&&document.body.removeChild(s),n();},s.addEventListener("canplaythrough",a),s.src=e;}},t}(mn);function TX(e,t){return (TX=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var TY=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){return e.call(this,t,"binary")||this}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&TX(t,e);var n=t.prototype;return n.load=function(e,t){"string"==typeof e&&(e={load:e,original:e}),aq.get(e.load,{responseType:aY.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,i){n?t("Error loading binary resource: "+e.original+" ["+n+"]"):t(null,i);});},n.openBinary=function(e){return e.buffer},t}(mn);function Tq(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function TK(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Tq(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Tq(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var TZ=function(){function e(t,n,i,r){for(var s=function(t,r,s){var a=e.createAsset(n.name,t,r,s);return i.add(a),a},a=[],o=0;o<t.renders.length;++o)a.push(s("render",t.renders[o],o));for(var l=[],u=0;u<t.materials.length;++u)l.push(s("material",t.materials[u],u));for(var c=[],h=0;h<t.animations.length;++h)c.push(s("animation",t.animations[h],h));this.data=t,this._model=null,this._assetName=n.name,this._assets=i,this._defaultMaterial=r,this.renders=a,this.materials=l,this.textures=t.textures,this.animations=c;}var t,n=e.prototype;return n.instantiateModelEntity=function(e){var t=new my(void 0,this._assets._loader._app);return t.addComponent("model",Object.assign({type:"asset",asset:this.model},e)),t},n.instantiateRenderEntity=function(t){for(var n,i=this,r=this._defaultMaterial,s=[],a=function(e,t,n,i,a,o,l,u){var c=a[n.id],h=new lL(n,void 0===c?r:i[c]);n.morph&&(h.morphInstance=new c7(n.morph)),l.hasOwnProperty("skin")&&s.push({meshInstance:h,rootBone:e,entity:t});var f=u.get(l);if(f){var d=f.matrices,p=n6.getDefaultInstancingFormat(n.device),m=new n1(n.device,p,d.length/16,{data:d});h.setInstancing(m),h.instancingData._destroyVertexBuffer=true;}return h},o=function(e,n,r){var s=new my(void 0,i._assets._loader._app);n._cloneInternal(s),e||(e=s);for(var l=null,u=null,c=0;c<r.nodes.length;c++)if(r.nodes[c]===n){var h=r.gltf.nodes[c];if(h.hasOwnProperty("mesh")){var f=r.renders[h.mesh].meshes;u=i.renders[h.mesh];for(var d=0;d<f.length;d++){var p=f[d];if(p){var m=a(e,s,p,r.materials,r.meshDefaultMaterials,r.skins,h,r.nodeInstancingMap);l||(l=[]),l.push(m);}}}if(r.lights){var _=r.lights.get(h);_&&s.addChild(_.clone());}if(r.cameras){var v=r.cameras.get(h);v&&v.camera.system.cloneComponent(v,s);}}l&&(s.addComponent("render",Object.assign({type:"asset",meshInstances:l},t)),s.render.assignAsset(u));for(var g=n.children,y=0;y<g.length;y++){var S=o(e,g[y],r);s.addChild(S);}return s},l=[],u=TK(this.data.scenes);!(n=u()).done;){var c=n.value;l.push(o(null,c,this.data));}return s.forEach(function(e){e.meshInstance.skinInstance=yE.createCachedSkinInstance(e.meshInstance.mesh.skin,e.rootBone,e.entity),e.meshInstance.node.render.rootBone=e.rootBone;}),e.createSceneHierarchy(l,my)},n.getMaterialVariants=function(){return this.data.variants?Object.keys(this.data.variants):[]},n.applyMaterialVariant=function(e,t){var n=t?this.data.variants[t]:null;if(void 0!==n)for(var i=e.findComponents("render"),r=0;r<i.length;r++){var s=i[r];this._applyMaterialVariant(n,s.meshInstances);}},n.applyMaterialVariantInstances=function(e,t){var n=t?this.data.variants[t]:null;void 0!==n&&this._applyMaterialVariant(n,e);},n._applyMaterialVariant=function(e,t){var n=this;t.forEach(function(t){if(null===e)t.material=n._defaultMaterial;else {var i=n.data.meshVariants[t.mesh.id];i&&(t.material=n.data.materials[i[e]]);}});},n.destroy=function(){var e=this._assets,t=function(t){e.remove(t),t.unload();},n=function(e){e.forEach(function(e){t(e);});};this.animations&&(n(this.animations),this.animations=null),this.textures&&(n(this.textures),this.textures=null),this.materials&&(n(this.materials),this.materials=null),this.renders&&(n(this.renders),this.renders=null),this._model&&(t(this._model),this._model=null),this.data=null,this.assets=null;},e.createAsset=function(e,t,n,i){var r=new pZ(e+"/"+t+"/"+i,t,{url:""});return r.resource=n,r.loaded=true,r},e.createSceneHierarchy=function(e,t){var n=null;if(1===e.length)n=e[0];else {n=new t("SceneGroup");for(var i,r=TK(e);!(i=r()).done;){var s=i.value;n.addChild(s);}}return n},e.createModel=function(t,n){for(var i,r=new he,s=[],a=TK(t.skins);!(i=a()).done;){var o=i.value,l=new lu(o);l.bones=o.bones,s.push(l);}r.graph=e.createSceneHierarchy(t.scenes,us);for(var u=0;u<t.nodes.length;u++){var c=t.nodes[u];if(c.root===r.graph){var h=t.gltf.nodes[u];if(h.hasOwnProperty("mesh"))for(var f=t.renders[h.mesh].meshes,d=0;d<f.length;d++){var p=f[d];p&&function(e,i,r,s,a,o,l){var u=t.meshDefaultMaterials[i.id],c=new lL(i,void 0===u?n:a[u],o);if(i.morph){var h=new c7(i.morph);c.morphInstance=h,e.morphInstances.push(h);}if(l.hasOwnProperty("skin")){var f=l.skin;i.skin=r[f];var d=s[f];c.skinInstance=d,e.skinInstances.push(d);}e.meshInstances.push(c);}(r,p,t.skins,s,t.materials,c,h);}}}return r},t=[{key:"model",get:function(){if(!this._model){var t=e.createModel(this.data,this._defaultMaterial),n=e.createAsset(this._assetName,"model",t,0);this._assets.add(n),this._model=n;}return this._model}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),TQ=function(){function e(e,t,n){this._device=e,this._assets=t,this._defaultMaterial=Tk.createDefaultMaterial(),this.maxRetries=n;}var t=e.prototype;return t._getUrlWithoutParams=function(e){return e.indexOf("?")>=0?e.split("?")[0]:e},t.load=function(e,t,n){var i=this;pZ.fetchArrayBuffer(e.load,function(r,s){r?t(r):Tk.parse(i._getUrlWithoutParams(e.original),en.extractPath(e.load),s,i._device,n.registry,n.options,function(e,r){e?t(e):t(null,new TZ(r,n,i._assets,i._defaultMaterial));});},n,this.maxRetries);},t.open=function(e,t,n){return t},t.patch=function(e,t){},e}();function TJ(e,t){return (TJ=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var T$=function(){function e(){}var t=e.prototype;return t.instantiateModelEntity=function(e){return null},t.instantiateRenderEntity=function(e){return null},t.getMaterialVariants=function(){return null},t.applyMaterialVariant=function(e,t){},t.applyMaterialVariantInstances=function(e,t){},e}(),T0=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"container")||this).glbContainerParser=new TQ(t.graphicsDevice,t.assets,0),n.parsers={},n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&TJ(t,e);var n,i=t.prototype;return i._getUrlWithoutParams=function(e){return e.indexOf("?")>=0?e.split("?")[0]:e},i._getParser=function(e){var t=e?en.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".",""):null;return this.parsers[t]||this.glbContainerParser},i.load=function(e,t,n){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,n);},i.open=function(e,t,n){return this._getParser(e).open(e,t,n)},n=[{key:"maxRetries",get:function(){return this.glbContainerParser.maxRetries},set:function(e){for(var t in this.glbContainerParser.maxRetries=e,this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mn);function T1(e,t){return (T1=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var T2=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"css")||this).decoder=null,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&T1(t,e);var n=t.prototype;return n.load=function(e,t){"string"==typeof e&&(e={load:e,original:e}),aq.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,i){n?t("Error loading css resource: "+e.original+" ["+n+"]"):t(null,i);});},n.openBinary=function(e){return null!=this.decoder||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)},t}(mn);function T3(e,t){return (T3=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var T4=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"cubemap")||this)._device=t.graphicsDevice,n._registry=t.assets,n._loader=t.loader,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&T3(t,e);var n=t.prototype;return n.load=function(e,t,n){this.loadAssets(n,t);},n.open=function(e,t,n){return n?n.resource:null},n.patch=function(e,t){this.loadAssets(e,function(n,i){n&&(t.fire("error",e),t.fire("error:"+e.id,n,e),e.fire("error",e));});},n.getAssetIds=function(e){var t=[];if(t[0]=e.file,(e.loadFaces||!e.file)&&e.data&&e.data.textures)for(var n=0;n<6;++n)t[n+1]=e.data.textures[n];else t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=null;return t},n.compareAssetIds=function(e,t){return e&&t?parseInt(e,10)===e||"string"==typeof e?e===t:e.url===t.url:null!==e==(null!==t)},n.update=function(e,t,n){var i=e.data||{},r=e._handlerState.assets,s=e._resources,a=[null,null,null,null,null,null,null],o=function(){return i.hasOwnProperty("type")?i.type:i.hasOwnProperty("rgbm")?i.rgbm?t1:t0:null};if(e.loaded&&n[0]===r[0])a[1]=s[1]||null,a[2]=s[2]||null,a[3]=s[3]||null,a[4]=s[4]||null,a[5]=s[5]||null,a[6]=s[6]||null;else if(n[0])if((u=n[0].resource).cubemap)for(h=0;h<6;++h)a[h+1]=new nO(this._device,{name:e.name+"_prelitCubemap"+(u.width>>h),cubemap:true,type:o()||u.type,width:u.width>>h,height:u.height>>h,format:u.format,levels:[u._levels[h]],addressU:1,addressV:1,mipmaps:0===h});else a[1]=u;var l=n.slice(1);if(e.loaded&&this.cmpArrays(l,r.slice(1)))a[0]=s[0]||null;else if(-1===l.indexOf(null)){var u,c,h,f,d=l.map(function(e){return e.resource}),p=[];for(c=0;c<d[0]._levels.length;++c)p.push(d.map(function(e){return e._levels[c]}));var m=d[0].format,_=new nO(this._device,{name:""+e.name+"_faces",cubemap:true,type:o()||d[0].type,width:d[0].width,height:d[0].height,format:6===m?7:m,mipmaps:null==(f=i.mipmaps)||f,levels:p,minFilter:i.hasOwnProperty("minFilter")?i.minFilter:d[0].minFilter,magFilter:i.hasOwnProperty("magFilter")?i.magFilter:d[0].magFilter,anisotropy:i.hasOwnProperty("anisotropy")?i.anisotropy:1,addressU:1,addressV:1});a[0]=_;}if(!this.cmpArrays(a,s))for(h=0,e.resources=a,e._handlerState.assetIds=t,e._handlerState.assets=n;h<s.length;++h)null!==s[h]&&-1===a.indexOf(s[h])&&s[h].destroy();for(h=0;h<r.length;++h)null!==r[h]&&-1===n.indexOf(r[h])&&r[h].unload();},n.cmpArrays=function(e,t){if(e.length!==t.length)return  false;for(var n=0;n<e.length;++n)if(e[n]!==t[n])return  false;return  true},n.resolveId=function(e){var t=parseInt(e,10);return t===e||t.toString()===e?t:e},n.loadAssets=function(e,t){e.hasOwnProperty("_handlerState")||(e._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});for(var n,i=this,r=i.getAssetIds(e),s=[null,null,null,null,null,null,null],a=e._handlerState.assetIds,o=e._handlerState.assets,l=i._registry,u=7,c=function(n,a){s[n]=a,0==--u&&(i.update(e,r,s),t(null,e.resources));},h=function(e,n,i){t(n);},f=function(e,t){t.loaded?c(e,t):(l.once("load:"+t.id,c.bind(i,e)),l.once("error:"+t.id,h.bind(i,e)),t.loading||l.load(t));},d=0;d<7;++d){var p=this.resolveId(r[d]);if(p)if(i.compareAssetIds(p,a[d]))f(d,o[d]);else if(parseInt(p,10)===p)(n=l.get(p))?f(d,n):setTimeout((function(e,t){var n=l.get(t);n?f(e,n):h(e,"failed to find dependent cubemap asset="+t);}).bind(null,d,p));else {var m="string"==typeof p?{url:p,filename:p}:p,_=-1===m.url.search(".dds")?{type:"rgbp",addressu:"clamp",addressv:"clamp",mipmaps:false}:null;n=new pZ(e.name+"_part_"+d,"texture",m,_),l.add(n),f(d,n);}else c(d,null);}},t}(mn);function T5(e,t){return (T5=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var T8=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){return e.call(this,t,"folder")||this}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&T5(t,e),t.prototype.load=function(e,t){t(null,null);},t}(mn),T6=function(){var e;function t(e,t){this.type=t&&t.type||v2,this.em=1,this.textures=e,this.intensity=0,this._data=null,this.data=t;}return e=[{key:"data",get:function(){return this._data},set:function(e){if(this._data=e,e&&(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),!this._data.version||this._data.version<2)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars))for(var t in this._data.chars)this._data.chars[t].map=0;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}();function T9(e,t){return (T9=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function T7(e){return e.version<3&&(e.version<2&&(e.info.maps=e.info.maps||[{width:e.info.width,height:e.info.height}]),e.chars=Object.keys(e.chars||{}).reduce(function(t,n){var i=e.chars[n],r=void 0!==i.letter?i.letter:ev.fromCodePoint(n);return e.version<2&&(i.map=i.map||0),t[r]=i,t},{}),e.version=3),e}var Ee=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"font")||this)._loader=t.loader,n.maxRetries=0,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&T9(t,e);var n=t.prototype;return n.load=function(e,t,n){"string"==typeof e&&(e={load:e,original:e});var i=this;".json"===en.getExtension(e.original)?aq.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,r){if(n)t("Error loading font resource: "+e.original+" ["+n+"]");else {var s=T7(r);i._loadTextures(e.load.replace(".json",".png"),s,function(e,n){e?t(e):t(null,{data:s,textures:n});});}}):(n&&n.data&&(n.data=T7(n.data)),this._loadTextures(e.load,n&&n.data,t));},n._loadTextures=function(e,t,n){for(var i=t.info.maps.length,r=0,s=null,a=Array(i),o=this._loader,l=function(t){var l=function(e,o){if(!s){if(e){s=e,n(e);return}o.upload(),a[t]=o,++r===i&&n(null,a);}};0===t?o.load(e,"texture",l):o.load(e.replace(".png",""+t+".png"),"texture",l);},u=0;u<i;u++)l(u);},n.open=function(e,t,n){return t.textures?new T6(t.textures,t.data):new T6(t,null)},n.patch=function(e,t){var n=e.resource;!n.data&&e.data?n.data=e.data:!e.data&&n.data&&(e.data=n.data),e.data&&(e.data=T7(e.data));},t}(mn),Et=function(e,t,n,i,r,s){var a=function(e,t){var n=(1<<t)-1;return (e&n)/n},o=function(e,t){e.x=a(t>>>21,11),e.y=a(t>>>11,10),e.z=a(t,11);},l=function(e,t){e.x=a(t>>>24,8),e.y=a(t>>>16,8),e.z=a(t>>>8,8),e.w=a(t,8);},u=function(e,t){var n=1/(.5*Math.sqrt(2)),i=(a(t>>>20,10)-.5)*n,r=(a(t>>>10,10)-.5)*n,s=(a(t,10)-.5)*n,o=Math.sqrt(1-(i*i+r*r+s*s));switch(t>>>30){case 0:e.set(i,r,s,o);break;case 1:e.set(o,r,s,i);break;case 2:e.set(r,o,s,i);break;case 3:e.set(r,s,o,i);}},c=function(e,t,n){return e*(1-n)+t*n},h=e.chunkData,f=e.chunkSize,d=e.vertexData,p=e.shData0,m=e.shData1,_=e.shData2,v=e.shBands,g=[3,8,15][v-1];this.read=function(e){var a=Math.floor(e/256)*f;if(t&&(o(t,d[4*e+0]),t.x=c(h[a+0],h[a+3],t.x),t.y=c(h[a+1],h[a+4],t.y),t.z=c(h[a+2],h[a+5],t.z)),n&&u(n,d[4*e+1]),i&&(o(i,d[4*e+2]),i.x=c(h[a+6],h[a+9],i.x),i.y=c(h[a+7],h[a+10],i.y),i.z=c(h[a+8],h[a+11],i.z)),r&&(l(r,d[4*e+3]),f>12&&(r.x=c(h[a+12],h[a+15],r.x),r.y=c(h[a+13],h[a+16],r.y),r.z=c(h[a+14],h[a+17],r.z))),s&&v>0)for(var y=[p,m,_],S=0;S<3;++S)for(var x=0;x<15;++x)s[15*S+x]=x<g?y[S][16*e+x]*(8/255)-4:0;};},En=function(){function e(){}var t,n=e.prototype;return n.createIter=function(e,t,n,i,r){return new Et(this,e,t,n,i,r)},n.calcAabb=function(e){for(var t=this.chunkData,n=this.numChunks,i=this.chunkSize,r=Math.exp(Math.max(t[9],t[10],t[11])),s=t[0]-r,a=t[1]-r,o=t[2]-r,l=t[3]+r,u=t[4]+r,c=t[5]+r,h=1;h<n;++h){var f=h*i;r=Math.exp(Math.max(t[f+9],t[f+10],t[f+11])),s=Math.min(s,t[f+0]-r),a=Math.min(a,t[f+1]-r),o=Math.min(o,t[f+2]-r),l=Math.max(l,t[f+3]+r),u=Math.max(u,t[f+4]+r),c=Math.max(c,t[f+5]+r);}return e.center.set((s+l)*.5,(a+u)*.5,(o+c)*.5),e.halfExtents.set((l-s)*.5,(u-a)*.5,(c-o)*.5),true},n.getCenters=function(e){for(var t,n,i,r,s,a,o=this.vertexData,l=this.chunkData,u=this.numChunks,c=this.chunkSize,h=0;h<u;++h){var f=h*c;t=l[f+0],n=l[f+1],i=l[f+2],r=l[f+3],s=l[f+4],a=l[f+5];for(var d=Math.min(this.numSplats,(h+1)*256),p=256*h;p<d;++p){var m=o[4*p],_=(m>>>21)/2047,v=(m>>>11&1023)/1023,g=(2047&m)/2047;e[3*p+0]=(1-_)*t+_*r,e[3*p+1]=(1-v)*n+v*s,e[3*p+2]=(1-g)*i+g*a;}}},n.getChunks=function(e){for(var t,n,i,r,s,a,o=this.chunkData,l=this.numChunks,u=this.chunkSize,c=0;c<l;++c){var h=c*u;t=o[h+0],n=o[h+1],i=o[h+2],r=o[h+3],s=o[h+4],a=o[h+5],e[6*c+0]=t,e[6*c+1]=n,e[6*c+2]=i,e[6*c+3]=r,e[6*c+4]=s,e[6*c+5]=a;}},n.calcFocalPoint=function(e){var t=this.chunkData,n=this.numChunks,i=this.chunkSize;e.x=0,e.y=0,e.z=0;for(var r=0;r<n;++r){var s=r*i;e.x+=t[s+0]+t[s+3],e.y+=t[s+1]+t[s+4],e.z+=t[s+2]+t[s+5];}e.mulScalar(.5/n);},n.decompress=function(){var e=this,t=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],n=this.shBands;if(n>0){for(var i,r=[],s=0;s<45;++s)r.push("f_rest_"+s);var a=(i=Math).max.apply(i,[].concat(["f_dc_0","f_dc_1","f_dc_2"].map(function(e){return t.indexOf(e)})));t.splice.apply(t,[].concat([a+1,0],r));}var o={};t.forEach(function(t){o[t]=new Float32Array(e.numSplats);});for(var l=new eW,u=new e0,c=new eW,h=new eY,f=n>0?new Float32Array(45):null,d=this.createIter(l,u,c,h,f),p=0;p<this.numSplats;++p)if(d.read(p),o.x[p]=l.x,o.y[p]=l.y,o.z[p]=l.z,o.rot_1[p]=u.x,o.rot_2[p]=u.y,o.rot_3[p]=u.z,o.rot_0[p]=u.w,o.scale_0[p]=c.x,o.scale_1[p]=c.y,o.scale_2[p]=c.z,o.f_dc_0[p]=(h.x-.5)/.28209479177387814,o.f_dc_1[p]=(h.y-.5)/.28209479177387814,o.f_dc_2[p]=(h.z-.5)/.28209479177387814,o.opacity[p]=h.w<=0?-40:h.w>=1?40:-Math.log(1/h.w-1),f)for(var m=0;m<45;++m)o["f_rest_"+m][p]=f[m];return new d2([{name:"vertex",count:this.numSplats,properties:t.map(function(e){return {name:e,type:"float",byteSize:4,storage:o[e]}})}],this.comments)},t=[{key:"isCompressed",get:function(){return  true}},{key:"numChunks",get:function(){return Math.ceil(this.numSplats/256)}},{key:"chunkSize",get:function(){return this.chunkData.length/this.numChunks}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function Ei(e,t){return (Ei=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Er=function(e,t,n,i,r){for(var s=0;s<r;++s)for(var a=0;a<i;++a)e[s*t+a]=n[s*i+a];},Es=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i=e.call(this,t,n)||this,r=n.chunkData,s=n.chunkSize,a=n.numChunks,o=n.numSplats,l=n.vertexData,u=n.shBands;i.chunks=new Float32Array(6*a),n.getChunks(i.chunks),i.packedTexture=i.createTexture("packedData",49,i.evalTextureSize(o),l);var c=i.evalTextureSize(a);c.x*=5,i.chunkTexture=i.createTexture("chunkData",14,c);var h=i.chunkTexture.lock();if(Er(h,20,r,s,a),12===s)for(var f=0;f<a;++f)h[20*f+15]=1,h[20*f+16]=1,h[20*f+17]=1;if(i.chunkTexture.unlock(),u>0){var d=i.evalTextureSize(o);i.shTexture0=i.createTexture("shTexture0",49,d,new Uint32Array(n.shData0.buffer)),i.shTexture1=i.createTexture("shTexture1",49,d,new Uint32Array(n.shData1.buffer)),i.shTexture2=i.createTexture("shTexture2",49,d,new Uint32Array(n.shData2.buffer));}else i.shTexture0=null,i.shTexture1=null,i.shTexture2=null;return i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Ei(t,e);var n=t.prototype;return n.destroy=function(){var t,n,i,r,s;null==(t=this.packedTexture)||t.destroy(),null==(n=this.chunkTexture)||n.destroy(),null==(i=this.shTexture0)||i.destroy(),null==(r=this.shTexture1)||r.destroy(),null==(s=this.shTexture2)||s.destroy(),e.prototype.destroy.call(this);},n.configureMaterialDefines=function(e){e.set("GSPLAT_COMPRESSED_DATA",true),e.set("SH_BANDS",3*!!this.shTexture0);},n.configureMaterial=function(e){this.configureMaterialDefines(e.defines),e.setParameter("packedTexture",this.packedTexture),e.setParameter("chunkTexture",this.chunkTexture),this.shTexture0&&(e.setParameter("shTexture0",this.shTexture0),e.setParameter("shTexture1",this.shTexture1),e.setParameter("shTexture2",this.shTexture2));},n.evalTextureSize=function(e){var t=Math.ceil(Math.sqrt(e)),n=Math.ceil(e/t);return new eX(t,n)},t}(d9);function Ea(e,t,n,i,r,s,a){try{var o=e[s](a),l=o.value;}catch(e){n(e);return}o.done?t(l):Promise.resolve(l).then(i,r);}function Eo(e){return function(){var t=this,n=arguments;return new Promise(function(i,r){var s=e.apply(t,n);function a(e){Ea(s,i,r,a,o,"next",e);}function o(e){Ea(s,i,r,a,o,"throw",e);}a(void 0);})}}function El(e,t){var n,i,r,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(l){var u=[o,l];if(n)throw TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(s=0)),s;)try{if(n=1,i&&(r=2&u[0]?i.return:u[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,u[1])).done)return r;switch(i=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,i=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===u[0]||2===u[0])){s=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){s.label=u[1];break}if(6===u[0]&&s.label<r[1]){s.label=r[1],r=u;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(u);break}r[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s);}catch(e){u=[6,e],i=0;}finally{n=r=0;}if(5&u[0])throw u[1];return {value:u[0]?u[1]:void 0,done:true}}}}var Eu=new Uint8Array([112,108,121,10]),Ec=new Uint8Array([10,101,110,100,95,104,101,97,100,101,114,10]),Eh=new Map([["char",Int8Array],["uchar",Uint8Array],["short",Int16Array],["ushort",Uint16Array],["int",Int32Array],["uint",Uint32Array],["float",Float32Array],["double",Float64Array]]),Ef=function(){function e(e,t){this.head=0,this.tail=0,this.reader=e,this.progressFunc=t;}var t,n=e.prototype;return n.read=function(){var e=this;return Eo(function(){var t,n;return El(this,function(i){switch(i.label){case 0:return [4,e.reader.read()];case 1:if(n=(t=i.sent()).value,t.done)throw Error("Stream finished before end of header");return e.push(n),null==e.progressFunc||e.progressFunc.call(e,n.byteLength),[2]}})})()},n.push=function(e){if(this.data){var t=this.tail-this.head,n=t+e.length;if(this.data.length>=n)this.head>0?(this.data.copyWithin(0,this.head,this.tail),this.data.set(e,t),this.head=0,this.tail=n):(this.data.set(e,this.tail),this.tail+=e.length);else {var i=new Uint8Array(n);this.head>0||this.tail<this.data.length?i.set(this.data.subarray(this.head,this.tail),0):i.set(this.data,0),i.set(e,t),this.data=i,this.view=new DataView(this.data.buffer),this.head=0,this.tail=n;}}else this.data=e,this.view=new DataView(this.data.buffer),this.tail=e.length;},n.compact=function(){this.head>0&&(this.data.copyWithin(0,this.head,this.tail),this.tail-=this.head,this.head=0);},n.getInt8=function(){var e=this.view.getInt8(this.head);return this.head++,e},n.getUint8=function(){var e=this.view.getUint8(this.head);return this.head++,e},n.getInt16=function(){var e=this.view.getInt16(this.head,true);return this.head+=2,e},n.getUint16=function(){var e=this.view.getUint16(this.head,true);return this.head+=2,e},n.getInt32=function(){var e=this.view.getInt32(this.head,true);return this.head+=4,e},n.getUint32=function(){var e=this.view.getUint32(this.head,true);return this.head+=4,e},n.getFloat32=function(){var e=this.view.getFloat32(this.head,true);return this.head+=4,e},n.getFloat64=function(){var e=this.view.getFloat64(this.head,true);return this.head+=8,e},t=[{key:"remaining",get:function(){return this.tail-this.head}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),Ed=function(e){for(var t,n=[],i=[],r=1;r<e.length;++r){var s=e[r].split(" ");switch(s[0]){case "comment":i.push(s.slice(1).join(" "));break;case "format":t=s[1];break;case "element":n.push({name:s[1],count:parseInt(s[2],10),properties:[]});break;case "property":if(!Eh.has(s[1]))throw Error("Unrecognized property data type '"+s[1]+"' in ply header");n[n.length-1].properties.push({type:s[1],name:s[2],storage:null,byteSize:Eh.get(s[1]).BYTES_PER_ELEMENT});break;default:throw Error("Unrecognized header value '"+s[0]+"' in ply header")}}return {elements:n,format:t,comments:i}},Ep=function(e){var t=["min_x","min_y","min_z","max_x","max_y","max_z","min_scale_x","min_scale_y","min_scale_z","max_scale_x","max_scale_y","max_scale_z","min_r","min_g","min_b","max_r","max_g","max_b"],n=["packed_position","packed_rotation","packed_scale","packed_color"],i=Array(45).fill("").map(function(e,t){return "f_rest_"+t}),r=function(){return "chunk"===e[0].name&&e[0].properties.every(function(e,n){return e.name===t[n]&&"float"===e.type})&&"vertex"===e[1].name&&e[1].properties.every(function(e,t){return e.name===n[t]&&"uint"===e.type})};return 2===e.length&&r()||3===e.length&&r()&&"sh"===e[2].name&&-1!==[9,24,45].indexOf(e[2].properties.length)&&e[2].properties.every(function(e,t){return e.name===i[t]&&"uchar"===e.type})},Em=Eo(function(e,t,n){var i,r,s,a,o,l,u,c,h,f,d,p,m,_,v,g,y,S;return El(this,function(x){switch(x.label){case 0:var b,T,E;return (i=new En).comments=n,r=t[0].count,s=t[0].properties.length,T=Math.ceil(Math.sqrt(b=a=t[1].count)),E=Math.ceil(b/T),o=T*E,i.numSplats=a,i.chunkData=new Float32Array(r*s),i.vertexData=new Uint32Array(4*o),[4,(l=Eo(function(t,n){var i,r,s,a,o;return El(this,function(l){switch(l.label){case 0:i=new Uint8Array(t),r=0,l.label=1;case 1:if(!(r<n))return [3,5];l.label=2;case 2:if(0!==e.remaining)return [3,4];return [4,e.read()];case 3:return l.sent(),[3,2];case 4:for(o=0,s=Math.min(n-r,e.remaining),a=e.data;o<s;++o)i[r++]=a[e.head++];return [3,1];case 5:return [2]}})}))(i.chunkData.buffer,r*s*4)];case 1:return x.sent(),[4,l(i.vertexData.buffer,4*a*4)];case 2:if(x.sent(),3!==t.length)return [3,7];c=new Uint8Array(u=16*o),h=new Uint8Array(u),f=new Uint8Array(u),d=1024,p=t[2].properties.length/3,m=new Uint8Array(d*p*3),_=0,x.label=3;case 3:if(!(_<i.numSplats))return [3,6];return v=Math.min(d,i.numSplats-_),[4,l(m.buffer,v*p*3)];case 4:for(x.sent(),g=0;g<v;++g)for(y=0;y<15;++y)S=(_+g)*16+y,y<p?(c[S]=m[(3*g+0)*p+y],h[S]=m[(3*g+1)*p+y],f[S]=m[(3*g+2)*p+y]):(c[S]=127,h[S]=127,f[S]=127);x.label=5;case 5:return _+=d,[3,3];case 6:return i.shData0=c,i.shData1=h,i.shData2=f,i.shBands=({3:1,8:2,15:3})[p],[3,8];case 7:i.shBands=0,x.label=8;case 8:return [2,i]}})}),E_=Eo(function(e,t,n){var i,r,s,a,o,l,u,c,h,f,d,p;return El(this,function(m){switch(m.label){case 0:s=(r=(i=t[0]).properties).length,a=r.map(function(e){return e.storage}),o=r.reduce(function(e,t){return e+t.byteSize},0),l=0,(c=function(){var t=e.data.buffer;(null==u?void 0:u.buffer)!==t&&(u=new Float32Array(t,0,t.byteLength/4));})(),m.label=1;case 1:if(!(l<i.count))return [3,5];m.label=2;case 2:if(!(e.remaining<o))return [3,4];return [4,e.read()];case 3:return m.sent(),c(),[3,2];case 4:for(f=0,h=Math.min(i.count-l,Math.floor(e.remaining/o));f<s;++f)for(p=0,d=a[f];p<h;++p)d[p+l]=u[p*s+f];return l+=h,e.head+=h*o,[3,1];case 5:return [2,new d2(t,n)]}})}),Ev=Eo(function(e,t,n){var i,r,s,a,o,l,u,c;return El(this,function(h){switch(h.label){case 0:i=0,h.label=1;case 1:if(!(i<t.length))return [3,7];s=(r=t[i]).properties.reduce(function(e,t){return e+t.byteSize},0),a=r.properties.map(function(e){if(!e.storage)return function(t){t.head+=e.byteSize;};switch(e.type){case "char":return function(t,n){e.storage[n]=t.getInt8();};case "uchar":return function(t,n){e.storage[n]=t.getUint8();};case "short":return function(t,n){e.storage[n]=t.getInt16();};case "ushort":return function(t,n){e.storage[n]=t.getUint16();};case "int":return function(t,n){e.storage[n]=t.getInt32();};case "uint":return function(t,n){e.storage[n]=t.getUint32();};case "float":return function(t,n){e.storage[n]=t.getFloat32();};case "double":return function(t,n){e.storage[n]=t.getFloat64();};default:throw Error("Unsupported property data type '"+e.type+"' in ply header")}}),o=0,h.label=2;case 2:if(!(o<r.count))return [3,6];h.label=3;case 3:if(!(e.remaining<s))return [3,5];return [4,e.read()];case 4:return h.sent(),[3,3];case 5:for(u=0,l=Math.min(r.count-o,Math.floor(e.remaining/s));u<l;++u){for(c=0;c<r.properties.length;++c)a[c](e,o);o++;}return [3,2];case 6:return ++i,[3,1];case 7:return [2,new d2(t,n)]}})}),Eg=Eo(function(e,t,n){var i,r,s,a,o,l,u,c;return El(this,function(h){switch(h.label){case 0:void 0===t&&(t=null),void 0===n&&(n=null),i=function(e,t){var n,i,r=e.length-t.length;for(n=0;n<=r;++n){for(i=0;i<t.length&&e[n+i]===t[i];++i);if(i===t.length)return n}return -1},r=function(e,t){if(e.length<t.length)return  false;for(var n=0;n<t.length;++n)if(e[n]!==t[n])return  false;return  true},s=new Ef(e,n),h.label=1;case 1:return [4,s.read()];case 2:if(h.sent(),s.tail>=Eu.length&&!r(s.data,Eu))throw Error("Invalid ply header");if(-1!==(a=i(s.data,Ec)))return [3,3];return [3,1];case 3:if(l=(o=Ed(new TextDecoder("ascii").decode(s.data.subarray(0,a)).split("\n"))).elements,u=o.format,c=o.comments,"binary_little_endian"!==u)throw Error("Unsupported ply format");return s.head=a+Ec.length,s.compact(),[4,Eo(function(){return El(this,function(e){switch(e.label){case 0:if(!Ep(l))return [3,2];return [4,Em(s,l,c)];case 1:case 3:case 5:return [2,e.sent()];case 2:if(l.forEach(function(e){e.properties.forEach(function(n){var i=Eh.get(n.type);if(i){var r=!t||t(n.name)?new i(e.count):null;n.storage=r;}});}),!(1===l.length&&"vertex"===l[0].name&&l[0].properties.every(function(e){return "float"===e.type})))return [3,4];return [4,E_(s,l,c)];case 4:return [4,Ev(s,l,c)]}})})()];case 4:return [2,h.sent()]}})}),Ey=function(e){return  true},ES=function(){function e(e,t){this.app=e,this.maxRetries=t;}var t=e.prototype;return t.load=function(e,t,n){var i=this;return Eo(function(){var r,s,a,o,l,u,c,h,f;return El(this,function(d){switch(d.label){case 0:return d.trys.push([0,5,,6]),[4,null!=(s=null==(r=n.file)?void 0:r.contents)?s:fetch(e.load)];case 1:if(!(!(a=d.sent())||!a.body))return [3,2];return t("Error loading resource",null),[3,4];case 2:return l=parseInt(null!=(o=a.headers.get("content-length"))?o:"0",10),u=0,[4,Eg(a.body.getReader(),null!=(c=n.data.elementFilter)?c:Ey,function(e){u+=e,n&&n.fire("progress",u,l);})];case 3:h=d.sent(),n.fire("load:data",h),!h.isCompressed&&(null==(f=n.data.reorder)||f)&&h.reorderData(),t(null,h.isCompressed&&!n.data.decompress?new Es(i.app.graphicsDevice,h):new pt(i.app.graphicsDevice,h.isCompressed?h.decompress():h)),d.label=4;case 4:return [3,6];case 5:return t(d.sent(),null),[3,6];case 6:return [2]}})})()},t.open=function(e,t){return t},e}();function Ex(e,t,n,i,r,s,a){try{var o=e[s](a),l=o.value;}catch(e){n(e);return}o.done?t(l):Promise.resolve(l).then(i,r);}var Eb=function(e,t){var n=new Map,i=function(){var t=0,i=0;n.forEach(function(e){t+=e.loaded,i+=e.total;}),e.fire("progress",t,i);};t.forEach(function(e){var t=function(t,r){n.set(e,{loaded:t,total:r}),i();},r=function(){e.off("progress",t),e.off("load",r),e.off("error",r);};e.on("progress",t),e.on("load",r),e.on("error",r);});},ET=function(e){var t={version:1,count:e.means.shape[0],means:{mins:e.means.mins,maxs:e.means.maxs,files:e.means.files},scales:{mins:e.scales.mins,maxs:e.scales.maxs,files:e.scales.files},quats:{files:e.quats.files},sh0:{mins:e.sh0.mins,maxs:e.sh0.maxs,files:e.sh0.files}};return e.shN&&(t.shN={mins:e.shN.mins,maxs:e.shN.maxs,files:e.shN.files}),t},EE=function(){function e(e,t){this.app=e,this.maxRetries=t;}var t=e.prototype;return t.loadTextures=function(e,t,n,i){var r,s=this;return (r=function(){var r,a,o,l,u,c,h,f,d,p,m,_,v,g,y;return function(e,t){var n,i,r,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(l){var u=[o,l];if(n)throw TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(s=0)),s;)try{if(n=1,i&&(r=2&u[0]?i.return:u[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,u[1])).done)return r;switch(i=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,i=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===u[0]||2===u[0])){s=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){s.label=u[1];break}if(6===u[0]&&s.label<r[1]){s.label=r[1],r=u;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(u);break}r[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s);}catch(e){u=[6,e],i=0;}finally{n=r=0;}if(5&u[0])throw u[1];return {value:u[0]?u[1]:void 0,done:true}}}}(this,function(S){switch(S.label){case 0:return 2!==i.version&&(i=ET(i)),c=s.app.assets,f={},d=[],(h=["means","quats","scales","sh0","shN"]).forEach(function(t){var r,s,a=null!=(s=null==(r=i[t])?void 0:r.files)?s:[];f[t]=a.map(function(t){var i,r,s,a=new pZ(t,"texture",{url:null!=(s=null==(r=n.options)||null==(i=r.mapUrl)?void 0:i.call(r,t))?s:new URL(t,new URL(e.load,window.location.href).toString()).toString(),filename:t},{mipmaps:false}),o=new Promise(function(e,t){a.on("load",function(){return e(null)}),a.on("error",function(e){return t(e)});});return c.add(a),d.push(o),a});}),Eb(n,p=h.map(function(e){return f[e]}).flat()),p.forEach(function(e){return c.load(e)}),[4,Promise.allSettled(d)];case 1:if(S.sent(),(m=new py).meta=i,m.numSplats=i.count,m.means_l=f.means[0].resource,m.means_u=f.means[1].resource,m.quats=f.quats[0].resource,m.scales=f.scales[0].resource,m.sh0=f.sh0[0].resource,m.sh_centroids=null==(a=f.shN)||null==(r=a[0])?void 0:r.resource,m.sh_labels=null==(l=f.shN)||null==(o=l[1])?void 0:o.resource,_=null==(u=n.data)?void 0:u.decompress)return [3,3];return [4,m.prepareGpuData()];case 2:S.sent(),S.label=3;case 3:if(!_)return [3,5];return g=pt.bind,y=[void 0,s.app.graphicsDevice],[4,m.decompress()];case 4:return v=new(g.apply(pt,y.concat([S.sent()]))),[3,6];case 5:v=new pA(s.app.graphicsDevice,m),S.label=6;case 6:return t(null,v),[2]}})},function(){var e=this,t=arguments;return new Promise(function(n,i){var s=r.apply(e,t);function a(e){Ex(s,n,i,a,o,"next",e);}function o(e){Ex(s,n,i,a,o,"throw",e);}a(void 0);})})()},t.load=function(e,t,n){var i,r=this;if(null==(i=n.data)?void 0:i.means)this.loadTextures(e,t,n,n.data);else {"string"==typeof e&&(e={load:e,original:e});var s={retry:this.maxRetries>0,maxRetries:this.maxRetries,responseType:aY.ResponseType.JSON};aq.get(e.load,s,function(i,s){i?t("Error loading gsplat meta: "+e.original+" ["+i+"]"):r.loadTextures(e,t,n,s);});}},e}();function Ew(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function EA(e,t,n,i,r,s,a){try{var o=e[s](a),l=o.value;}catch(e){n(e);return}o.done?t(l):Promise.resolve(l).then(i,r);}function EC(e){return function(){var t=this,n=arguments;return new Promise(function(i,r){var s=e.apply(t,n);function a(e){EA(s,i,r,a,o,"next",e);}function o(e){EA(s,i,r,a,o,"throw",e);}a(void 0);})}}function EP(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Ew(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ew(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function EI(e,t){var n,i,r,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(l){var u=[o,l];if(n)throw TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(s=0)),s;)try{if(n=1,i&&(r=2&u[0]?i.return:u[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,u[1])).done)return r;switch(i=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,i=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===u[0]||2===u[0])){s=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){s.label=u[1];break}if(6===u[0]&&s.label<r[1]){s.label=r[1],r=u;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(u);break}r[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s);}catch(e){u=[6,e],i=0;}finally{n=r=0;}if(5&u[0])throw u[1];return {value:u[0]?u[1]:void 0,done:true}}}}var EL=function(e){var t=new DataView(e),n=function(e){return t.getUint16(e,true)},i=function(e){return t.getUint32(e,true)},r={magic:i(l=t.byteLength-22),numFiles:n(l+8),cdSizeBytes:i(l+12),cdOffsetBytes:i(l+16)};if(0x6054b50!==r.magic)throw Error("Invalid zip file: EOCDR not found");if(0xffffffff===r.cdOffsetBytes||0xffffffff===r.cdSizeBytes)throw Error("Invalid zip file: Zip64 not supported");for(var s=[],a=r.cdOffsetBytes,o=0;o<r.numFiles;o++){var l,u,c=function(t){var r=n(t+28),s=n(t+30),a=n(t+32);return {magic:i(t),compressionMethod:n(t+10),compressedSizeBytes:i(t+20),uncompressedSizeBytes:i(t+24),lfhOffsetBytes:i(t+42),filename:new TextDecoder().decode(new Uint8Array(e,t+46,r)),recordSizeBytes:46+r+s+a}}(a);if(0x2014b50!==c.magic)throw Error("Invalid zip file: CDR not found");var h=function(e){var t=n(e+26),r=n(e+28);return {magic:i(e),offsetBytes:e+30+t+r}}(c.lfhOffsetBytes);if(0x4034b50!==h.magic)throw Error("Invalid zip file: LFH not found");s.push({filename:c.filename,compression:null!=(u=({0:"none",8:"deflate"})[c.compressionMethod])?u:"unknown",data:new Uint8Array(e,h.offsetBytes,c.compressedSizeBytes)}),a+=c.recordSizeBytes;}return s},ED=EC(function(e){var t;return EI(this,function(n){switch(n.label){case 0:return t=new DecompressionStream("deflate-raw"),[4,new Response(new Blob([e]).stream().pipeThrough(t)).arrayBuffer()];case 1:return [2,new Uint8Array(n.sent())]}})}),EM=function(){function e(e,t){ void 0===t&&(t=3),this.app=e,this.maxRetries=t;}return e.prototype.load=function(e,t,n){var i=this,r=EC(function(e){var r,s,a,o,l,u,c,h,f,d,p,m,_,v,g,y,S,x,b,T,E,w;return EI(this,function(A){switch(A.label){case 0:r=function(){var e=S.value,t=c.find(function(t){return t.filename===e}),n=void 0;if(t)n=new pZ(e,"texture",{url:e,filename:e,contents:t.data},{mipmaps:false});else {var r=new URL(e,new URL(e,window.location.href).toString()).toString();n=new pZ(e,"texture",{url:r,filename:e},{mipmaps:false});}var s=new Promise(function(e,t){n.on("load",function(){return e(null)}),n.on("error",function(e){return t(e)});});i.app.assets.add(n),v[e]=n,g.push(s);},h=EP(c=EL(e)),A.label=1;case 1:if((f=h()).done)return [3,4];if("deflate"!==(d=f.value).compression)return [3,3];return [4,ED(d.data)];case 2:d.data=A.sent(),A.label=3;case 3:return [3,1];case 4:if(!(p=c.find(function(e){return "meta.json"===e.filename})))return t("Error: meta.json not found"),[2];try{m=JSON.parse(new TextDecoder().decode(p.data));}catch(e){return t("Error parsing meta.json: "+e),[2]}for(_=["means","scales","quats","sh0","shN"].map(function(e){var t,n;return null!=(n=null==(t=m[e])?void 0:t.files)?n:[]}).flat(),v={},g=[],y=EP(_);!(S=y()).done;)r();return Object.values(v).forEach(function(e){return i.app.assets.load(e)}),[4,Promise.allSettled(g)];case 5:if(A.sent(),(x=new py).meta=m,x.numSplats=m.count,x.means_l=v[m.means.files[0]].resource,x.means_u=v[m.means.files[1]].resource,x.quats=v[m.quats.files[0]].resource,x.scales=v[m.scales.files[0]].resource,x.sh0=v[m.sh0.files[0]].resource,x.sh_centroids=null==(s=v[null==(a=m.shN)?void 0:a.files[0]])?void 0:s.resource,x.sh_labels=null==(o=v[null==(l=m.shN)?void 0:l.files[1]])?void 0:o.resource,b=null==(u=n.data)?void 0:u.decompress)return [3,7];return [4,x.prepareGpuData()];case 6:A.sent(),A.label=7;case 7:if(!b)return [3,9];return E=pt.bind,w=[void 0,i.app.graphicsDevice],[4,x.decompress()];case 8:return T=new(E.apply(pt,w.concat([A.sent()]))),[3,10];case 9:T=new pA(i.app.graphicsDevice,x),A.label=10;case 10:return t(null,T),[2]}})});pZ.fetchArrayBuffer(e.load,function(e,n){e?t(e):r(n);},n,this.maxRetries);},e}(),ER=function(){function e(e,t){this.app=e,this.maxRetries=t;}return e.prototype.load=function(e,t,n){"string"==typeof e&&(e={load:e,original:e});var i={retry:this.maxRetries>0,maxRetries:this.maxRetries,responseType:aY.ResponseType.JSON};aq.get(e.load,i,function(i,r){i?t("Error loading gsplat octree: "+e.original+" ["+i+"]"):t(null,new x1(n.file.url,r));});},e}();function EO(e,t){return (EO=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ek=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"gsplat")||this).parsers={ply:new ES(t,3),sog:new EM(t),json:new EE(t,3),octree:new ER(t,3)},n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&EO(t,e);var n=t.prototype;return n._getUrlWithoutParams=function(e){return e.indexOf("?")>=0?e.split("?")[0]:e},n._getParser=function(e){var t=en.getBasename(this._getUrlWithoutParams(e)).toLowerCase();if("lod-meta.json"===t)return this.parsers.octree;var n=en.getExtension(t).replace(".","");return this.parsers[n]||this.parsers.ply},n.load=function(e,t,n){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,n);},n.open=function(e,t,n){return t},t}(mn),EN=function(){function e(){}return e.setCompressedPRS=function(e,t,n){var i,r,s=n.singleVecs,a=t.___1;a||(i=n.tripleVecs,r=t.___2);var o=a?a[0]:i[r];e.setLocalPosition(s[o],s[o+1],s[o+2]),o=a?a[1]:i[r+1],e.setLocalEulerAngles(s[o],s[o+1],s[o+2]),o=a?a[2]:i[r+2],e.setLocalScale(s[o],s[o+1],s[o+2]);},e.oneCharToKey=function(e,t){var n=e.charCodeAt(0)-t.fieldFirstCode;return t.fieldArray[n]},e.multCharToKey=function(e,t){for(var n=0,i=0;i<e.length;i++)n=n*t.fieldCodeBase+e.charCodeAt(i)-t.fieldFirstCode;return t.fieldArray[n]},e}(),EF=function(){function e(e,t){this._node=e,this._data=t;}var t=e.prototype;return t.run=function(){var e=Object.prototype.toString.call(this._node);return "[object Object]"===e?this._handleMap():"[object Array]"===e?this._handleArray():this._result=this._node,this._result},t._handleMap=function(){this._result={},Object.keys(this._node).forEach(this._handleKey,this);},t._handleKey=function(t){var n=t,i=t.length;1===i?n=EN.oneCharToKey(t,this._data):2===i&&(n=EN.multCharToKey(t,this._data)),this._result[n]=new e(this._node[t],this._data).run();},t._handleArray=function(){this._result=[],this._node.forEach(this._handleArElt,this);},t._handleArElt=function(t){var n=new e(t,this._data).run();this._result.push(n);},e}(),EB=function(){function e(e,t){this._app=e,this._isTemplate=t;}var t=e.prototype;return t.parse=function(e){var t={},n=null,i=e.compressedFormat;for(var r in i&&!e.entDecompressed&&(e.entDecompressed=true,e.entities=new EF(e.entities,i).run()),e.entities){var s=e.entities[r],a=this._createEntity(s,i);t[r]=a,null===s.parent&&(n=a);}for(var o in e.entities)for(var l=t[o],u=e.entities[o].children,c=u.length,h=0;h<c;h++){var f=t[u[h]];f&&l.addChild(f);}return this._openComponentData(n,e.entities),n},t._createEntity=function(e,t){var n,i=new my(e.name,this._app);if(i.setGuid(e.resource_id),this._setPosRotScale(i,e,t),i._enabled=null==(n=e.enabled)||n,this._isTemplate?i._template=true:i._enabledInHierarchy=i._enabled,i.template=e.template,e.tags)for(var r=0;r<e.tags.length;r++)i.tags.add(e.tags[r]);return i},t._setPosRotScale=function(e,t,n){if(n)EN.setCompressedPRS(e,t,n);else {var i=t.position,r=t.rotation,s=t.scale;e.setLocalPosition(i[0],i[1],i[2]),e.setLocalEulerAngles(r[0],r[1],r[2]),e.setLocalScale(s[0],s[1],s[2]);}},t._openComponentData=function(e,t){for(var n=this._app.systems.list,i=n.length,r=t[e.getGuid()],s=0;s<i;s++){var a=n[s],o=r.components[a.id];o&&a.addComponent(e,o);}i=r.children.length;for(var l=e._children,u=0;u<i;u++)l[u]&&(l[u]=this._openComponentData(l[u],t));return e},e}(),EU=function(){function e(){}return e.load=function(e,t,n){"string"==typeof e&&(e={load:e,original:e}),aq.get(e.load,{retry:t>0,maxRetries:t},function(t,i){if(t){var r="Error while loading scene JSON "+e.original;t.message?(r+=": "+t.message,t.stack&&(r+="\n"+t.stack)):r+=": "+t,n(r);}else n(t,i);});},e}();function Ez(e,t){return (Ez=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var EV=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){return e.call(this,t,"hierarchy")||this}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Ez(t,e);var n=t.prototype;return n.load=function(e,t){EU.load(e,this.maxRetries,t);},n.open=function(e,t){this._app.systems.script.preloading=true;var n=new EB(this._app,false).parse(t);return this._app.systems.script.preloading=false,n},t}(mn);function EG(e,t){return (EG=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var EH=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"html")||this).decoder=null,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&EG(t,e);var n=t.prototype;return n.load=function(e,t){"string"==typeof e&&(e={load:e,original:e}),aq.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,i){n?t("Error loading html resource: "+e.original+" ["+n+"]"):t(null,i);});},n.openBinary=function(e){return null!=this.decoder||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)},t}(mn);function EW(e,t){return (EW=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ej=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"json")||this).decoder=null,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&EW(t,e);var n=t.prototype;return n.load=function(e,t){"string"==typeof e&&(e={load:e,original:e});var n={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(n.responseType=aY.ResponseType.JSON),aq.get(e.load,n,function(n,i){n?t("Error loading JSON resource: "+e.original+" ["+n+"]"):t(null,i);});},n.openBinary=function(e){return null!=this.decoder||(this.decoder=new TextDecoder("utf-8")),JSON.parse(this.decoder.decode(e))},t}(mn);function EX(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}var EY=function(){function e(){this.removeInvalid=true,this.valid=true,this.enumValidators={occludeSpecular:this._createEnumValidator([0,1,2]),cull:this._createEnumValidator([0,1,2,3]),blendType:this._createEnumValidator([0,1,2,3,4,5,6,7,8,9,10]),depthFunc:this._createEnumValidator([0,1,2,3,4,5,6,7])};}var t=e.prototype;return t.setInvalid=function(e,t){this.valid=false,this.removeInvalid&&delete t[e];},t.validate=function(e){var t="path"===e.mappingFormat;for(var n in e){var i=dp[n];if(!i){dy[n]?delete e[n]:this.valid=false;continue}if(i.startsWith("enum")){var r=i.split(":")[1];this.enumValidators[r]&&!this.enumValidators[r](e[n])&&this.setInvalid(n,e);}else if("number"===i)"number"!=typeof e[n]&&this.setInvalid(n,e);else if("boolean"===i)"boolean"!=typeof e[n]&&this.setInvalid(n,e);else if("string"===i)"string"!=typeof e[n]&&this.setInvalid(n,e);else if("vec2"===i)EX(e[n],Array)&&2===e[n].length||this.setInvalid(n,e);else if("rgb"===i)EX(e[n],Array)&&3===e[n].length||this.setInvalid(n,e);else if("texture"===i)t?"string"==typeof e[n]||null===e[n]||EX(e[n],nO)||this.setInvalid(n,e):"number"==typeof e[n]||null===e[n]||EX(e[n],nO)||this.setInvalid(n,e);else if("boundingbox"===i)e[n].center&&EX(e[n].center,Array)&&3===e[n].center.length||this.setInvalid(n,e),e[n].halfExtents&&EX(e[n].halfExtents,Array)&&3===e[n].halfExtents.length||this.setInvalid(n,e);else if("cubemap"===i)"number"==typeof e[n]||null===e[n]||void 0===e[n]||EX(e[n],nO)&&e[n].cubemap||this.setInvalid(n,e);else if("chunks"===i)for(var s=Object.keys(e[n]),a=0;a<s.length;a++)"string"!=typeof e[n][s[a]]&&this.setInvalid(s[a],e[n]);}return e.validated=true,this.valid},t._createEnumValidator=function(e){return function(t){return e.indexOf(t)>=0}},e}();function Eq(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}var EK=function(){function e(){this._validator=null;}var t=e.prototype;return t.parse=function(e){var t=this.migrate(e),n=this._validate(t),i=new dw;return this.initialize(i,n),i},t.initialize=function(e,t){if(t.validated||(t=this._validate(t)),t.chunks&&t.chunks&&Object.keys(t.chunks).length>0){var n=e.shaderChunks.glsl;Object.entries(t.chunks).forEach(function(e){var t=e[0],i=e[1];return n.set(t,i)});}for(var i in t){var r=dp[i],s=t[i];if("vec2"===r)e[i]=new eX(s[0],s[1]);else if("rgb"===r)e[i]=new eN(s[0],s[1],s[2]);else if("texture"===r)Eq(s,nO)?e[i]=s:Eq(e[i],nO)&&"number"==typeof s&&s>0||(e[i]=null);else if("cubemap"===r)Eq(s,nO)?e[i]=s:Eq(e[i],nO)&&"number"==typeof s&&s>0||(e[i]=null),"cubeMap"!==i||s||(e.prefilteredCubemaps=null);else if("boundingbox"===r){var a=new eW(s.center[0],s.center[1],s.center[2]),o=new eW(s.halfExtents[0],s.halfExtents[1],s.halfExtents[2]);e[i]=new e8(a,o);}else e[i]=t[i];}e.update();},t.migrate=function(e){e.shader&&delete e.shader,e.mapping_format&&(e.mappingFormat=e.mapping_format,delete e.mapping_format);var t,n=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["specularMapTint","specularTint"],["metalnessMapTint","metalnessTint"],["clearCoatGlossiness","clearCoatGloss"]];for(t=0;t<n.length;t++){var i=n[t][0],r=n[t][1];void 0!==e[i]&&(void 0===e[r]&&(e[r]=e[i]),delete e[i]);}var s=["fresnelFactor","shadowSampleType"];for(t=0;t<s.length;t++){var a=s[t];e.hasOwnProperty(a)&&delete e[a];}return e},t._validate=function(e){return e.validated||(this._validator||(this._validator=new EY),this._validator.validate(e)),e},e}();function EZ(e,t){return (EZ=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var EQ={aoMap:"white",aoDetailMap:"white",diffuseMap:"gray",diffuseDetailMap:"gray",specularMap:"gray",specularityFactorMap:"white",metalnessMap:"black",glossMap:"gray",sheenMap:"black",sheenGlossMap:"gray",clearCoatMap:"black",clearCoatGlossMap:"gray",clearCoatNormalMap:"normal",refractionMap:"white",emissiveMap:"gray",normalMap:"normal",normalDetailMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white",thicknessMap:"black",iridescenceMap:"black",iridescenceThicknessMap:"black",envAtlas:"black",anisotropyMap:"black"},EJ=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"material")||this)._assets=t.assets,n._device=t.graphicsDevice,n._parser=new EK,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&EZ(t,e);var n=t.prototype;return n.load=function(e,t){"string"==typeof e&&(e={load:e,original:e}),aq.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,i){n?t&&t("Error loading material: "+e.original+" ["+n+"]"):t&&(i._engine=true,t(null,i));});},n.open=function(e,t){var n=this._parser.parse(t);return t._engine&&(n._data=t,delete t._engine),n},n.patch=function(e,t){e.resource._data&&(e._data=e.resource._data,delete e.resource._data),e.data.name=e.name,e.resource.name=e.name,this._bindAndAssignAssets(e,t),e.off("unload",this._onAssetUnload,this),e.on("unload",this._onAssetUnload,this);},n._onAssetUnload=function(e){delete e.data.parameters,delete e.data.chunks,delete e.data.name;},n._assignTexture=function(e,t,n){t.resource[e]=n;},n._getPlaceholderTexture=function(e){var t=EQ[e];return nB(this._device,t)},n._assignPlaceholderTexture=function(e,t){t.resource[e]=this._getPlaceholderTexture(e);},n._onTextureLoad=function(e,t,n){this._assignTexture(e,t,n.resource),t.resource.update();},n._onTextureAdd=function(e,t,n){this._assets.load(n);},n._onTextureRemoveOrUnload=function(e,t,n){var i=t.resource;i&&t.resource[e]===n.resource&&(this._assignPlaceholderTexture(e,t),i.update());},n._assignCubemap=function(e,t,n){if(t.resource[e]=n[0],"cubeMap"===e){var i=n.slice(1);i.every(function(e){return e})?t.resource.prefilteredCubemaps=i:i[0]&&(t.resource.envAtlas=i[0]);}},n._onCubemapLoad=function(e,t,n){this._assignCubemap(e,t,n.resources),this._parser.initialize(t.resource,t.data);},n._onCubemapAdd=function(e,t,n){this._assets.load(n);},n._onCubemapRemoveOrUnload=function(e,t,n){var i=t.resource;t.data.prefilteredCubeMap128===n.resources[1]&&(this._assignCubemap(e,t,[null,null,null,null,null,null,null]),i.update());},n._bindAndAssignAssets=function(e,t){var n,i,r,s=this._parser.migrate(e.data),a=e.resource,o="path"===s.mappingFormat;for(n=0;n<dm.length;n++){i=dm[n],r=a._assetReferences[i];var l=s[i],u=a[i],c=u===this._getPlaceholderTexture(i),h=s.validated;l&&(!u||!h||c)?(r||(r=new yw(i,e,t,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemoveOrUnload,unload:this._onTextureRemoveOrUnload},this),a._assetReferences[i]=r),o?r.url=e.getAbsoluteUrl(l):r.id=l,r.asset&&(r.asset.resource?this._assignTexture(i,e,r.asset.resource):this._assignPlaceholderTexture(i,e),t.load(r.asset))):r&&(o?r.url=null:r.id=null);}for(n=0;n<dv.length;n++)i=dv[n],r=a._assetReferences[i],s[i]&&!e.data.prefilteredCubeMap128&&(r||(r=new yw(i,e,t,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemoveOrUnload,unload:this._onCubemapRemoveOrUnload},this),a._assetReferences[i]=r),o?r.url=s[i]:r.id=s[i],r.asset&&(r.asset.loaded&&this._assignCubemap(i,e,r.asset.resources),t.load(r.asset)));this._parser.initialize(a,s);},t}(mn),E$=function(){function e(e){this._device=e.device,this._defaultMaterial=e.defaultMaterial,this._assets=e.assets;}return e.prototype.parse=function(e,t,n){var i,r=this;Tk.parse("filename.glb","",e,this._device,this._assets,null!=(i=null==n?void 0:n.options)?i:{},function(e,n){if(e)t(e);else {var i=TZ.createModel(n,r._defaultMaterial);n.destroy(),t(null,i);}});},e}(),E0={points:0,lines:1,lineloop:2,linestrip:3,triangles:4,trianglestrip:5,trianglefan:6},E1={int8:0,uint8:1,int16:2,uint16:3,int32:4,uint32:5,float32:6},E2=function(){function e(e){this._device=e.device,this._defaultMaterial=e.defaultMaterial;}var t=e.prototype;return t.parse=function(e,t){var n=e.model;if(!n)return void t(null,null);if(n.version<=1)return void t("JsonModelParser#parse: Trying to parse unsupported model format.");var i=this._parseNodes(e),r=this._parseSkins(e,i),s=this._parseVertexBuffers(e),a=this._parseIndexBuffers(e,s),o=this._parseMorphs(e,i,s),l=this._parseMeshes(e,r.skins,o.morphs,s,a.buffer,a.data),u=this._parseMeshInstances(e,i,l,r.skins,r.instances,o.morphs,o.instances),c=new he;c.graph=i[0],c.meshInstances=u,c.skinInstances=r.instances,c.morphInstances=o.instances,c.getGraph().syncHierarchy(),t(null,c);},t._parseNodes=function(e){var t,n=e.model,i=[];for(t=0;t<n.nodes.length;t++){var r=n.nodes[t],s=new us(r.name);s.setLocalPosition(r.position[0],r.position[1],r.position[2]),s.setLocalEulerAngles(r.rotation[0],r.rotation[1],r.rotation[2]),s.setLocalScale(r.scale[0],r.scale[1],r.scale[2]),s.scaleCompensation=!!r.scaleCompensation,i.push(s);}for(t=1;t<n.parents.length;t++)i[n.parents[t]].addChild(i[t]);return i},t._parseSkins=function(e,t){var n,i,r=e.model,s=[],a=[];for(n=0;n<r.skins.length;n++){var o=r.skins[n],l=[];for(i=0;i<o.inverseBindMatrices.length;i++){var u=o.inverseBindMatrices[i];l[i]=new e$().set(u);}var c=new fU(this._device,l,o.boneNames);s.push(c);var h=new lu(c),f=[];for(i=0;i<c.boneNames.length;i++){var d=c.boneNames[i],p=t[0].findByName(d);f.push(p);}h.bones=f,a.push(h);}return {skins:s,instances:a}},t._getMorphVertexCount=function(e,t,n){for(var i=0;i<e.meshes.length;i++){var r=e.meshes[i];if(r.morph===t)return n[r.vertices].numVertices}},t._parseMorphs=function(e,t,n){var i,r,s,a,o,l,u=e.model,c=[],h=[];if(u.morphs){var f=function(e,t,n){for(var i=new Float32Array(3*n),r=0;r<t.length;r++){var s=3*t[r];i[s]=e[3*r],i[s+1]=e[3*r+1],i[s+2]=e[3*r+2];}return i};for(i=0;i<u.morphs.length;i++){for(r=0,a=u.morphs[i].targets,l=[],s=this._getMorphVertexCount(u,i,n);r<a.length;r++){var d=a[r].aabb,p=d.min,m=d.max,_=new e8(new eW((m[0]+p[0])*.5,(m[1]+p[1])*.5,(m[2]+p[2])*.5),new eW((m[0]-p[0])*.5,(m[1]-p[1])*.5,(m[2]-p[2])*.5)),v=a[r].indices,g=a[r].deltaPositions,y=a[r].deltaNormals;v&&(g=f(g,v,s),y=f(y,v,s)),o=new hi({deltaPositions:g,deltaNormals:y,name:a[r].name,aabb:_}),l.push(o);}var S=new hn(l,this._device);c.push(S);var x=new c7(S);h.push(x);}}return {morphs:c,instances:h}},t._parseVertexBuffers=function(e){for(var t=e.model,n=[],i={position:tT,normal:tE,tangent:tw,blendWeight:tA,blendIndices:tC,color:tP,texCoord0:tL,texCoord1:tD,texCoord2:tM,texCoord3:tR,texCoord4:tO,texCoord5:tk,texCoord6:tN,texCoord7:tF},r=0;r<t.vertices.length;r++){var s=t.vertices[r],a=[];for(var o in s){var l=s[o];a.push({semantic:i[o],components:l.components,type:E1[l.type],normalize:i[o]===tP});}for(var u=new n6(this._device,a),c=s.position.data.length/s.position.components,h=new n1(this._device,u,c),f=new ao(h),d=0;d<c;d++){for(var p in s){var m=s[p];switch(m.components){case 1:f.element[i[p]].set(m.data[d]);break;case 2:f.element[i[p]].set(m.data[2*d],1-m.data[2*d+1]);break;case 3:f.element[i[p]].set(m.data[3*d],m.data[3*d+1],m.data[3*d+2]);break;case 4:f.element[i[p]].set(m.data[4*d],m.data[4*d+1],m.data[4*d+2],m.data[4*d+3]);}}f.next();}f.end(),n.push(h);}return n},t._parseIndexBuffers=function(e,t){var n,i=e.model,r=null,s=null,a=0;for(n=0;n<i.meshes.length;n++){var o=i.meshes[n];void 0!==o.indices&&(a+=o.indices.length);}var l=0;for(n=0;n<t.length;n++)l=Math.max(l,t[n].numVertices);return a>0&&(s=l>65535?new Uint32Array((r=new s$(this._device,2,a)).lock()):new Uint16Array((r=new s$(this._device,1,a)).lock())),{buffer:r,data:s}},t._parseMeshes=function(e,t,n,i,r,s){for(var a=e.model,o=[],l=0,u=0;u<a.meshes.length;u++){var c=a.meshes[u],h=c.aabb,f=h.min,d=h.max,p=new e8(new eW((d[0]+f[0])*.5,(d[1]+f[1])*.5,(d[2]+f[2])*.5),new eW((d[0]-f[0])*.5,(d[1]-f[1])*.5,(d[2]-f[2])*.5)),m=void 0!==c.indices,_=new l_(this._device);_.vertexBuffer=i[c.vertices],_.indexBuffer[0]=m?r:null,_.primitive[0].type=E0[c.type],_.primitive[0].base=m?c.base+l:c.base,_.primitive[0].count=c.count,_.primitive[0].indexed=m,_.skin=void 0!==c.skin?t[c.skin]:null,_.morph=void 0!==c.morph?n[c.morph]:null,_.aabb=p,m&&(s.set(c.indices,l),l+=c.indices.length),o.push(_);}return null!==r&&r.unlock(),o},t._parseMeshInstances=function(e,t,n,i,r,s,a){var o,l=e.model,u=[];for(o=0;o<l.meshInstances.length;o++){var c=l.meshInstances[o],h=t[c.node],f=n[c.mesh],d=new lL(f,this._defaultMaterial,h);f.skin&&(d.skinInstance=r[i.indexOf(f.skin)]),f.morph&&(d.morphInstance=a[s.indexOf(f.morph)]),u.push(d);}return u},e}();function E3(e,t){return (E3=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var E4=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"model")||this)._parsers=[],n.device=t.graphicsDevice,n.assets=t.assets,n.defaultMaterial=lg(n.device),n.addParser(new E2(n),function(e,t){return ".json"===en.getExtension(e)}),n.addParser(new E$(n),function(e,t){return ".glb"===en.getExtension(e)}),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&E3(t,e);var n=t.prototype;return n.load=function(e,t,n){var i=this;"string"==typeof e&&(e={load:e,original:e});var r={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.load.startsWith("blob:")||e.load.startsWith("data:"))&&(".glb"===en.getExtension(e.original).toLowerCase()?r.responseType=aY.ResponseType.ARRAY_BUFFER:r.responseType=aY.ResponseType.JSON),aq.get(e.load,r,function(r,s){if(t)if(r)t("Error loading model: "+e.original+" ["+r+"]");else {for(var a=0;a<i._parsers.length;a++){var o=i._parsers[a];if(o.decider(e.original,s))return void o.parser.parse(s,function(e,n){e?t(e):t(null,n);},n)}t("No parsers found");}});},n.open=function(e,t){return t},n.patch=function(e,t){if(e.resource){var n=e.data,i=this;e.resource.meshInstances.forEach(function(r,s){if(n.mapping){var a,o=function(e){e.resource?r.material=e.resource:(e.once("load",o),t.load(e)),e.once("remove",function(e){r.material===e.resource&&(r.material=i.defaultMaterial);});};if(!n.mapping[s]){r.material=i.defaultMaterial;return}var l=n.mapping[s].material,u=n.mapping[s].path;if(void 0!==l)l?(a=t.get(l))?o(a):t.once("add:"+l,o):r.material=i.defaultMaterial;else if(u){var c=e.getAbsoluteUrl(n.mapping[s].path);(a=t.getByUrl(c))?o(a):t.once("add:url:"+c,o);}}});}},n.addParser=function(e,t){this._parsers.push({parser:e,decider:t});},t}(mn);function E5(e,t){return (E5=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var E8=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){return e.call(this,t,"scene")||this}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&E5(t,e);var n=t.prototype;return n.load=function(e,t){EU.load(e,this.maxRetries,t);},n.open=function(e,t){this._app.systems.script.preloading=true;var n=new EB(this._app,false).parse(t),i=this._app.scene;return i.root=n,this._app.applySceneSettings(t.settings),this._app.systems.script.preloading=false,i},t}(mn),E6=function(){function e(){}return e.push=function(t){e._types.push(t);},e}();E6._types=[];var E9=new Set(["system","entity","create","destroy","swap","move","data","scripts","_scripts","_scriptsIndex","_scriptsData","enabled","_oldState","onEnable","onDisable","onPostStateChange","_onSetEnabled","_checkState","_onBeforeRemove","_onInitializeAttributes","_onInitialize","_onPostInitialize","_onUpdate","_onPostUpdate","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"]);function E7(e,t){if(E9.has(e))throw Error("Script name '"+e+"' is reserved, please rename the script");var n=function(e){ex.prototype.initEventHandler.call(this),xx.prototype.initScriptType.call(this,e);};return n.prototype=Object.create(xx.prototype),n.prototype.constructor=n,n.extend=xx.extend,n.attributes=new xf(n),wt(n,e,t),n}var we={};function wt(e,t,n){var r;if("function"!=typeof e)throw Error("script class: '"+e+"' must be a constructor function (i.e. class).");if(r=e.prototype,null!=xv&&"undefined"!=typeof Symbol&&xv[Symbol.hasInstance]?!xv[Symbol.hasInstance](r):!i(r,xv))throw Error("script class: '"+xx.__getScriptName(e)+"' does not extend pc.Script.");if(t=t||e.__name||xx.__getScriptName(e),E9.has(t))throw Error("script name: '"+t+"' is reserved, please change script name");e.__name=t,(n?n.scripts:mA.getApplication().scripts).add(e),E6.push(e);}function wn(e,t){return (wn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}xf.reservedNames.forEach(function(e,t,n){we[e]=1;}),E7.reservedAttributes=we;var wi=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"script")||this)._scripts={},n._cache={},n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&wn(t,e);var n=t.prototype;return n.clearCache=function(){for(var e in this._cache){var t=this._cache[e],n=t.parentNode;n&&n.removeChild(t);}this._cache={};},n.load=function(e,t){"string"==typeof e&&(e={load:e,original:e});var n=this;pM.app=this._app;var i=(e.load,function(e,i,r){if(e)t(e);else {for(var s={},a=0;a<E6._types.length;a++)s[E6._types[a].name]=E6._types[a];E6._types.length=0,t(null,s,r);var o=i.split("&hash=")[0];delete n._loader._cache[ms.makeKey(o,"script")];}}),r=e.load.split("?")[0];r.endsWith(".mjs")?this._loadModule(r,i):this._loadScript(e.load,i);},n.open=function(e,t){return t},n.patch=function(e,t){},n._loadScript=function(e,t){var n=document.head,i=document.createElement("script");this._cache[e]=i,i.async=false,i.addEventListener("error",function(e){t("Script: "+e.target.src+" failed to load");},false);var r=false;i.onload=i.onreadystatechange=function(){r||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(r=true,t(null,e,i));},i.src=e,n.appendChild(i);},n._loadModule=function(e,t){var n=this,r=ef.browser&&"null"!==window.location.origin?window.location.origin+window.location.pathname:"undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:G&&"SCRIPT"===G.tagName.toUpperCase()&&G.src||new URL("playcanvas.js",document.baseURI).href,s=new URL(e,r);Function("modulePath","return import(modulePath)")(s.toString()).then(function(r){var a=s.pathname.split("/").pop(),o=null==(d=n._app.assets.find(a,"script"))||null==(f=d.data)?void 0:f.scripts;for(var l in r){var u=r[l];if(c=u.prototype,null!=xv&&"undefined"!=typeof Symbol&&xv[Symbol.hasInstance]?!!xv[Symbol.hasInstance](c):i(c,xv)){var c,h,f,d,p,m=(h=u.name)[0].toLowerCase()+h.substring(1);u.scriptName;var _=null!=(p=u.scriptName)?p:m;wt(u,_),o&&n._app.scripts.addSchema(_,o[_]);}}t(null,e,null);}).catch(function(e){t(e);});},t}(mn);function wr(e,t){return (wr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ws=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"shader")||this).decoder=null,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&wr(t,e);var n=t.prototype;return n.load=function(e,t){"string"==typeof e&&(e={load:e,original:e}),aq.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,i){n?t("Error loading shader resource: "+e.original+" ["+n+"]"):t(null,i);});},n.openBinary=function(e){return null!=this.decoder||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)},t}(mn);function wa(e,t){return (wa=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function wo(e){this.resource&&(this.resource.atlas=e.resource);}function wl(e){this.registry.load(e);}var wu=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"sprite")||this)._assets=t.assets,n._device=t.graphicsDevice,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&wa(t,e);var n=t.prototype;return n.load=function(e,t){"string"==typeof e&&(e={load:e,original:e}),".json"===en.getExtension(e.original)&&aq.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(e,n){e?t(e):t(null,n);});},n.open=function(e,t){var n=new fW(this._device);return e&&(n.__data=t),n},n.patch=function(e,t){var n=e.resource;if(n.__data&&(e.data.pixelsPerUnit=n.__data.pixelsPerUnit,e.data.renderMode=n.__data.renderMode,e.data.frameKeys=n.__data.frameKeys,n.__data.textureAtlasAsset)){var i=t.getByUrl(n.__data.textureAtlasAsset);i&&(e.data.textureAtlasAsset=i.id);}n.startUpdate(),n.renderMode=e.data.renderMode,n.pixelsPerUnit=e.data.pixelsPerUnit,n.frameKeys=e.data.frameKeys,this._updateAtlas(e),n.endUpdate(),e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this);},n._updateAtlas=function(e){var t=e.resource;if(!e.data.textureAtlasAsset){t.atlas=null;return}this._assets.off("load:"+e.data.textureAtlasAsset,wo,e),this._assets.on("load:"+e.data.textureAtlasAsset,wo,e);var n=this._assets.get(e.data.textureAtlasAsset);n&&n.resource?t.atlas=n.resource:n?this._assets.load(n):(this._assets.off("add:"+e.data.textureAtlasAsset,wl,e),this._assets.on("add:"+e.data.textureAtlasAsset,wl,e));},n._onAssetChange=function(e,t,n,i){"data"===t&&n&&n.textureAtlasAsset&&i&&n.textureAtlasAsset!==i.textureAtlasAsset&&(this._assets.off("load:"+i.textureAtlasAsset,wo,e),this._assets.off("add:"+i.textureAtlasAsset,wl,e));},t}(mn),wc=function(){function e(e,t){this._templateRoot=null,this._app=e,this._data=t;}var t=e.prototype;return t.instantiate=function(){return this._templateRoot||this._parseTemplate(),this._templateRoot.clone()},t._parseTemplate=function(){var e=new EB(this._app,true);this._templateRoot=e.parse(this._data);},e}();function wh(e,t){return (wh=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var wf=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"template")||this).decoder=null,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&wh(t,e);var n=t.prototype;return n.load=function(e,t){"string"==typeof e&&(e={load:e,original:e});var n={retry:this.maxRetries>0,maxRetries:this.maxRetries};aq.get(e.load,n,function(n,i){n?t("Error requesting template: "+e.original):t(n,i);});},n.open=function(e,t){return new wc(this._app,t)},n.openBinary=function(e){return null!=this.decoder||(this.decoder=new TextDecoder("utf-8")),new wc(this._app,JSON.parse(this.decoder.decode(e)))},t}(mn);function wd(e,t){return (wd=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var wp=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"text")||this).decoder=null,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&wd(t,e);var n=t.prototype;return n.load=function(e,t){"string"==typeof e&&(e={load:e,original:e}),aq.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,i){n?t("Error loading text resource: "+e.original+" ["+n+"]"):t(null,i);});},n.openBinary=function(e){return null!=this.decoder||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)},t}(mn);function wm(e,t){return (wm=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var w_={repeat:0,clamp:1,mirror:2},wv={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},wg=/^data\.frames\.(\d+)$/,wy=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,t,"textureatlas")||this)._loader=t.loader,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&wm(t,e);var n=t.prototype;return n.load=function(e,t){"string"==typeof e&&(e={load:e,original:e});var n=this,i=this._loader.getHandler("texture");".json"===en.getExtension(e.original)?aq.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(i,r){if(i)t(i);else {var s=e.original.replace(".json",".png");n._loader.load(s,"texture",function(e,n){e?t(e):t(null,{data:r,texture:n});});}}):i.load(e,t);},n.open=function(e,t,n){var i=new fX;if(t.texture&&t.data)i.texture=t.texture,i.__data=t.data;else {var r=this._loader.getHandler("texture").open(e,t,n);if(!r)return null;i.texture=r;}return i},n.patch=function(e,t){if(e.resource){e.resource.__data&&(void 0!==e.resource.__data.minfilter&&(e.data.minfilter=e.resource.__data.minfilter),void 0!==e.resource.__data.magfilter&&(e.data.magfilter=e.resource.__data.magfilter),void 0!==e.resource.__data.addressu&&(e.data.addressu=e.resource.__data.addressu),void 0!==e.resource.__data.addressv&&(e.data.addressv=e.resource.__data.addressv),void 0!==e.resource.__data.mipmaps&&(e.data.mipmaps=e.resource.__data.mipmaps),void 0!==e.resource.__data.anisotropy&&(e.data.anisotropy=e.resource.__data.anisotropy),void 0!==e.resource.__data.rgbm&&(e.data.rgbm=!!e.resource.__data.rgbm),e.data.frames=e.resource.__data.frames,delete e.resource.__data);var n=e.resource.texture;if(n&&(n.name=e.name,e.data.hasOwnProperty("minfilter")&&n.minFilter!==wv[e.data.minfilter]&&(n.minFilter=wv[e.data.minfilter]),e.data.hasOwnProperty("magfilter")&&n.magFilter!==wv[e.data.magfilter]&&(n.magFilter=wv[e.data.magfilter]),e.data.hasOwnProperty("addressu")&&n.addressU!==w_[e.data.addressu]&&(n.addressU=w_[e.data.addressu]),e.data.hasOwnProperty("addressv")&&n.addressV!==w_[e.data.addressv]&&(n.addressV=w_[e.data.addressv]),e.data.hasOwnProperty("mipmaps")&&n.mipmaps!==e.data.mipmaps&&(n.mipmaps=e.data.mipmaps),e.data.hasOwnProperty("anisotropy")&&n.anisotropy!==e.data.anisotropy&&(n.anisotropy=e.data.anisotropy),e.data.hasOwnProperty("rgbm"))){var i=e.data.rgbm?t1:t0;n.type!==i&&(n.type=i);}e.resource.texture=n;var r={};for(var s in e.data.frames){var a=e.data.frames[s];r[s]={rect:new eY(a.rect),pivot:new eX(a.pivot),border:new eY(a.border)};}e.resource.frames=r,e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this);}},n._onAssetChange=function(e,t,n){var i;if("data"===t||"data.frames"===t){var r={};for(var s in n.frames)i=n.frames[s],r[s]={rect:new eY(i.rect),pivot:new eX(i.pivot),border:new eY(i.border)};e.resource.frames=r;}else {var a=t.match(wg);if(a){var o=a[1];n?(e.resource.frames[o]?((i=e.resource.frames[o]).rect.set(n.rect[0],n.rect[1],n.rect[2],n.rect[3]),i.pivot.set(n.pivot[0],n.pivot[1]),i.border.set(n.border[0],n.border[1],n.border[2],n.border[3])):e.resource.frames[o]={rect:new eY(n.rect),pivot:new eX(n.pivot),border:new eY(n.border)},e.resource.fire("set:frame",o,e.resource.frames[o])):e.resource.frames[o]&&(delete e.resource.frames[o],e.resource.fire("remove:frame",o));}}},t}(mn);function wS(){var e,t,n,i={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFRGBA4444:16},r={astc:i.cTFASTC_4x4,dxt:i.cTFBC1,etc1:i.cTFETC1,etc2:i.cTFETC1,pvr:i.cTFPVRTC1_4_RGB,atc:i.cTFATC_RGB,none:i.cTFRGB565},s={astc:i.cTFASTC_4x4,dxt:i.cTFBC3,etc1:i.cTFRGBA4444,etc2:i.cTFETC2,pvr:i.cTFPVRTC1_4_RGBA,atc:i.cTFATC_RGBA_INTERPOLATED_ALPHA,none:i.cTFRGBA4444},a={ETC1:21,ETC2_RGB:22,ETC2_RGBA:23,DXT1:8,DXT5:10,PVRTC_4BPP_RGB_1:26,PVRTC_4BPP_RGBA_1:27,ASTC_4x4:28,ATC_RGB:29,ATC_RGBA:30,R8_G8_B8_A8:7,R5_G6_B5:3,R4_G4_B4_A4:5},o=function(e,t){switch(e){case i.cTFETC1:return t.formats.etc2?a.ETC2_RGB:a.ETC1;case i.cTFETC2:return a.ETC2_RGBA;case i.cTFBC1:return a.DXT1;case i.cTFBC3:return a.DXT5;case i.cTFPVRTC1_4_RGB:return a.PVRTC_4BPP_RGB_1;case i.cTFPVRTC1_4_RGBA:return a.PVRTC_4BPP_RGBA_1;case i.cTFASTC_4x4:return a.ASTC_4x4;case i.cTFATC_RGB:return a.ATC_RGB;case i.cTFATC_RGBA_INTERPOLATED_ALPHA:return a.ATC_RGBA;case i.cTFRGBA32:return a.R8_G8_B8_A8;case i.cTFRGB565:return a.R5_G6_B5;case i.cTFRGBA4444:return a.R4_G4_B4_A4}},l=function(e){for(var t=0;t<e.length;t+=4){var n=e[t+3],i=e[t+1];e[t+0]=n,e[t+2]=function(e,t){var n=2/255*e-1,i=2/255*t-1;return Math.max(0,Math.min(255,Math.floor((Math.sqrt(1-Math.min(1,n*n+i*i))+1)*127.5)))}(n,i),e[t+3]=255;}return e},u=function(e){for(var t=new Uint16Array(e.length/4),n=0;n<e.length;n+=4){var i=e[n+0],r=e[n+1],s=e[n+2];t[n/4]=(248&i)<<8|(252&r)<<3|s>>3;}return t},c=function(){return "undefined"!=typeof performance?performance.now():0},h=function(e,i,r){if(r){if(e.formats.astc)return "astc"}else if(i){if(e.formats.etc2)return "etc2"}else {if(e.formats.etc2)return "etc2";if(e.formats.etc1)return "etc1"}for(var s=i?n:t,a=0;a<s.length;++a){var o=s[a];if(e.formats[o])return o}return "none"},f=function(e,t,n){switch(n){case i.cTFETC1:case i.cTFETC2:return  true;case i.cTFBC1:case i.cTFBC3:return (3&e)==0&&(3&t)==0;case i.cTFPVRTC1_4_RGB:case i.cTFPVRTC1_4_RGBA:return (e&e-1)==0&&(t&t-1)==0;case i.cTFASTC_4x4:case i.cTFATC_RGB:case i.cTFATC_RGBA_INTERPOLATED_ALPHA:return  true}return  false},d=function(t,n,a){if(!e.KTX2File)throw Error("Basis transcoder module does not include support for KTX2.");var d,p,m=c(),_=new e.KTX2File(new Uint8Array(n)),v=_.getWidth(),g=_.getHeight(),y=_.getLevels(),S=!!_.getHasAlpha(),x=_.isUASTC&&_.isUASTC();if(!v||!g||!y)throw _.close(),_.delete(),Error("Invalid image dimensions url="+t+" width="+v+" height="+g+" levels="+y);var b=h(a.deviceDetails,S,x),T=!!a.isGGGR&&"pvr"===b;if(T?d=i.cTFRGBA32:f(v,g,d=S?s[b]:r[b])||(d=S?i.cTFRGBA32:i.cTFRGB565),!_.startTranscoding())throw _.close(),_.delete(),Error("Failed to start transcoding url="+t);for(var E=[],w=0;w<y;++w){var A=new Uint8Array(_.getImageTranscodedSizeInBytes(w,0,0,d));if(!_.transcodeImage(A,w,0,0,d,0,-1,-1))throw _.close(),_.delete(),Error("Failed to transcode image url="+t);var C=d===i.cTFRGB565||d===i.cTFRGBA4444;E.push(C?new Uint16Array(A.buffer):A);}if(_.close(),_.delete(),T)for(p=0,d=i.cTFRGB565;p<E.length;++p)E[p]=u(l(E[p]));return {format:o(d,a.deviceDetails),width:v,height:g,levels:E,cubemap:false,transcodeTime:c()-m,url:t,unswizzledGGGR:T}},p=function(t,n,a){var d,p,m=c(),_=new e.BasisFile(new Uint8Array(n)),v=_.getImageWidth(0,0),g=_.getImageHeight(0,0),y=_.getNumImages(),S=_.getNumLevels(0),x=!!_.getHasAlpha(),b=_.isUASTC&&_.isUASTC();if(!v||!g||!y||!S)throw _.close(),_.delete(),Error("Invalid image dimensions url="+t+" width="+v+" height="+g+" images="+y+" levels="+S);var T=h(a.deviceDetails,x,b),E=!!a.isGGGR&&"pvr"===T;if(E?d=i.cTFRGBA32:f(v,g,d=x?s[T]:r[T])||(d=x?i.cTFRGBA32:i.cTFRGB565),!_.startTranscoding())throw _.close(),_.delete(),Error("Failed to start transcoding url="+t);for(var w=[],A=0;A<S;++A){var C=_.getImageTranscodedSizeInBytes(0,A,d),P=new Uint8Array(C);if(!_.transcodeImage(P,0,A,d,0,0))if(A===S-1&&C===w[A-1].buffer.byteLength)P.set(new Uint8Array(w[A-1].buffer));else throw _.close(),_.delete(),Error("Failed to transcode image url="+t);var I=d===i.cTFRGB565||d===i.cTFRGBA4444;w.push(I?new Uint16Array(P.buffer):P);}if(_.close(),_.delete(),E)for(p=0,d=i.cTFRGB565;p<w.length;++p)w[p]=u(l(w[p]));return {format:o(d,a.deviceDetails),width:v,height:g,levels:w,cubemap:false,transcodeTime:c()-m,url:t,unswizzledGGGR:E}},m=function(e,t,n){try{var i=n.isKTX2?d(e,t,n):p(e,t,n);i.levels=i.levels.map(function(e){return e.buffer}),self.postMessage({url:e,data:i},i.levels);}catch(t){self.postMessage({url:e,err:t},null);}},_=function(i,r){self.BASIS(i.module?{instantiateWasm:function(e,t){return WebAssembly.instantiate(i.module,e).then(function(e){t(e);}).catch(function(e){}),{}}}:null).then(function(s){s.initializeBasis(),e=s,t=i.rgbPriority,n=i.rgbaPriority,r(null);});},v=[];self.onmessage=function(t){var n=t.data;switch(n.type){case "init":_(n.config,function(){for(var e=0;e<v.length;++e)m(v[e].url,v[e].data,v[e].options);v.length=0;});break;case "transcode":e?m(n.url,n.data,n.options):v.push(n);}};}function wx(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}var wb=function(e,t){var n=function(n,i){t(null,{workerUrl:URL.createObjectURL(new Blob([["/* basis */",n,"","("+wS.toString()+")()\n\n"].join("\n")],{type:"application/javascript"})),module:i,rgbPriority:e.rgbPriority,rgbaPriority:e.rgbaPriority});},i={cache:true,responseType:"text",retry:e.maxRetries>0,maxRetries:e.maxRetries};if(e.glueUrl&&e.wasmUrl&&function(){try{var e;if(("undefined"==typeof WebAssembly?"undefined":(e=WebAssembly)&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)=="object"&&"function"==typeof WebAssembly.instantiate){var t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(wx(t,WebAssembly.Module))return wx(new WebAssembly.Instance(t),WebAssembly.Instance)}}catch(e){}return  false}()){var r=null,s=null;aq.get(e.glueUrl,i,function(e,i){e?t(e):s?n(i,s):r=i;});var a=fetch(e.wasmUrl),o=function(){a.then(function(e){return e.arrayBuffer()}).then(function(e){return WebAssembly.compile(e)}).then(function(e){r?n(r,e):s=e;}).catch(function(e){t(e,null);});};WebAssembly.compileStreaming?WebAssembly.compileStreaming(a).then(function(e){r?n(r,e):s=e;}).catch(function(e){o();}):o();}else aq.get(e.fallbackUrl,i,function(e,i){e?t(e,null):n(i,null);});},wT=function(){function e(){this.callbacks={},this.queue=[],this.clients=[];}var t=e.prototype;return t.enqueueJob=function(e,t,n,i){if(this.callbacks.hasOwnProperty(e))this.callbacks[e].push(n);else {this.callbacks[e]=[n];var r={url:e,data:t,options:i};this.clients.length>0?this.clients.shift().run(r):this.queue.push(r);}},t.enqueueClient=function(e){this.queue.length>0?e.run(this.queue.shift()):this.clients.push(e);},t.handleResponse=function(e,t,n){var i=this.callbacks[e];if(t)for(var r=0;r<i.length;++r)i[r](t);else {3===n.format||5===n.format?n.levels=n.levels.map(function(e){return new Uint16Array(e)}):n.levels=n.levels.map(function(e){return new Uint8Array(e)});for(var s=0;s<i.length;++s)i[s](null,n);}delete this.callbacks[e];},e}(),wE=function(){function e(e,t,n){var i=this;this.queue=e,this.worker=new Worker(t.workerUrl),this.worker.addEventListener("message",function(e){var t=e.data;i.queue.handleResponse(t.url,t.err,t.data),i.eager||i.queue.enqueueClient(i);}),this.worker.postMessage({type:"init",config:t}),this.eager=n;}return e.prototype.run=function(e){var t=[];wx(e.data,ArrayBuffer)&&t.push(e.data),this.worker.postMessage({type:"transcode",url:e.url,format:e.format,data:e.data,options:e.options},t),this.eager&&this.queue.enqueueClient(this);},e}(),ww=["etc2","etc1","astc","dxt","pvr","atc"],wA=["astc","dxt","etc2","pvr","atc"],wC=new wT,wP=null,wI=false;function wL(e){if(!wI){if(e){if(e.lazyInit){wP=e;return}}else e=wP||{};if(!e.glueUrl||!e.wasmUrl||!e.fallbackUrl){var t=ew.getConfig("BASIS");t&&(e={glueUrl:t.glueUrl,wasmUrl:t.wasmUrl,fallbackUrl:t.fallbackUrl,numWorkers:t.numWorkers});}if(e.glueUrl||e.wasmUrl||e.fallbackUrl){wI=true;var n=Math.max(1,Math.min(16,e.numWorkers||1)),i=1===e.numWorkers||!e.hasOwnProperty("eagerWorkers")||e.eagerWorkers;e.rgbPriority=e.rgbPriority||ww,e.rgbaPriority=e.rgbaPriority||wA,e.maxRetries=e.hasOwnProperty("maxRetries")?e.maxRetries:5,wb(e,function(e,t){if(e);else for(var r=0;r<n;++r)wC.enqueueClient(new wE(wC,t,i));});}}}var wD=null;function wM(e,t,n,i,r){return wL(),wD||(wD={formats:{astc:!!e.extCompressedTextureASTC,atc:!!e.extCompressedTextureATC,dxt:!!e.extCompressedTextureS3TC,etc1:!!e.extCompressedTextureETC1,etc2:!!e.extCompressedTextureETC,pvr:!!e.extCompressedTexturePVRTC}}),wC.enqueueJob(t,n,i,{deviceDetails:wD,isGGGR:!!(null==r?void 0:r.isGGGR),isKTX2:!!(null==r?void 0:r.isKTX2)}),wI}var wR=function(){function e(){}var t=e.prototype;return t.load=function(e,t,n){throw Error("not implemented")},t.open=function(e,t,n){throw Error("not implemented")},e}();function wO(){return (wO=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);}return e}).apply(this,arguments)}function wk(e,t){return (wk=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var wN=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this)||this).device=n,i.maxRetries=0,i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&wk(t,e);var n=t.prototype;return n.load=function(e,t,n){var i=this.device,r=function(r){var s,a,o;wM(i,e.load,r,t,{isGGGR:((null==n||null==(o=n.file)||null==(a=o.variants)||null==(s=a.basis)?void 0:s.opt)&8)!=0})||t("Basis module not found. Asset ["+n.name+"]("+n.getFileUrl()+") basis texture variant will not be loaded.");};pZ.fetchArrayBuffer(e.load,function(e,n){e?t(e):r(n);},n,this.maxRetries);},n.open=function(e,t,n,i){ void 0===i&&(i={});var r=i.srgb?ty(t.format):t.format,s=new nO(n,wO({name:e,addressU:+!!t.cubemap,addressV:+!!t.cubemap,width:t.width,height:t.height,format:r,cubemap:t.cubemap,levels:t.levels},i));return s.upload(),s},t}(wR);function wF(){return (wF=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);}return e}).apply(this,arguments)}function wB(e,t){return (wB=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var wU=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this)||this).crossOrigin=t.prefix?"anonymous":null,i.maxRetries=0,i.device=n,i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&wB(t,e);var n=t.prototype;return n.load=function(e,t,n){var i,r,s=!!(null==n||null==(i=n.file)?void 0:i.contents);if(s){if(this.device.supportsImageBitmap)return void this._loadImageBitmapFromBlob(new Blob([n.file.contents]),t);e={load:URL.createObjectURL(new Blob([n.file.contents])),original:e.original};}var a=function(n,i){s&&URL.revokeObjectURL(e.load),t(n,i);};n&&n.options&&n.options.hasOwnProperty("crossOrigin")?r=n.options.crossOrigin:pW.test(e.load)&&(r=this.crossOrigin),this.device.supportsImageBitmap?this._loadImageBitmap(e.load,e.original,r,a,n):this._loadImage(e.load,e.original,r,a,n);},n.open=function(e,t,n,i){ void 0===i&&(i={});var r=new nO(n,wF({name:e,width:t.width,height:t.height,format:i.srgb?20:7},i));return r.setSource(t),r},n._loadImage=function(e,t,n,i,r){var s,a=new Image;n&&(a.crossOrigin=n);var o=0,l=this.maxRetries;null==r||r.fire("progress",0,1048576),a.onload=function(){null==r||r.fire("progress",1048576,1048576),i(null,a);},a.onerror=function(){if(!s)if(l>0&&++o<=l){var n=100*Math.pow(2,o),r=e.indexOf("?")>=0?"&":"?";s=setTimeout(function(){a.src=e+r+"retry="+Date.now(),s=null;},n);}else i("Error loading Texture from: '"+t+"'");},a.src=e;},n._loadImageBitmap=function(e,t,n,i,r){var s=this,a={cache:true,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries,progress:r};aq.get(e,a,function(e,t){e?i(e):s._loadImageBitmapFromBlob(t,i);});},n._loadImageBitmapFromBlob=function(e,t){createImageBitmap(e,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then(function(e){return t(null,e)}).catch(function(e){return t(e)});},t}(wR);function wz(){return (wz=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);}return e}).apply(this,arguments)}function wV(e,t){return (wV=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var wG={33776:8,33778:9,33779:10,36196:21,37492:22,37496:23,35840:26,35841:24,35842:27,35843:25,32849:6,32856:7,35905:19,35907:20,35898:18,34843:11,34842:12},wH=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this).maxRetries=0,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&wV(t,e);var n=t.prototype;return n.load=function(e,t,n){pZ.fetchArrayBuffer(e.load,t,n,this.maxRetries);},n.open=function(e,t,n,i){ void 0===i&&(i={});var r=this.parse(t);if(!r)return null;var s=i.srgb?ty(r.format):r.format,a=new nO(n,wz({name:e,addressU:+!!r.cubemap,addressV:+!!r.cubemap,width:r.width,height:r.height,format:s,cubemap:r.cubemap,levels:r.levels},i));return a.upload(),a},n.parse=function(e){var t=new Uint32Array(e);if(0x58544bab!==t[0]||0xbb313120!==t[1]||0xa1a0a0d!==t[2])return null;var n={endianness:t[3],glType:t[4],glTypeSize:t[5],glFormat:t[6],glInternalFormat:t[7],glBaseInternalFormat:t[8],pixelWidth:t[9],pixelHeight:t[10],pixelDepth:t[11],numberOfArrayElements:t[12],numberOfFaces:t[13],numberOfMipmapLevels:t[14],bytesOfKeyValueData:t[15]};if(n.pixelDepth>1||0!==n.numberOfArrayElements)return null;var i=wG[n.glInternalFormat];if(void 0===i)return null;for(var r=16+n.bytesOfKeyValueData/4,s=n.numberOfFaces>1,a=[],o=0;o<(n.numberOfMipmapLevels||1);o++){var l,u=t[r++];s&&a.push([]);for(var c=s?a[o]:a,h=0;h<(s?6:1);++h)c.push((l=4*r,18===i?new Uint32Array(e,l,u/4):new Uint8Array(e,l,u))),r+=u+3>>2;}return {format:i,width:n.pixelWidth,height:n.pixelHeight,levels:a,cubemap:s}},t}(wR);function wW(){return (wW=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);}return e}).apply(this,arguments)}function wj(e,t){return (wj=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var wX={KHR_DF_MODEL_UASTC:166},wY=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this)||this).maxRetries=0,i.device=n,i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&wj(t,e);var n=t.prototype;return n.load=function(e,t,n){var i=this;pZ.fetchArrayBuffer(e.load,function(r,s){r?t(r,s):i.parse(s,e,t,n);},n,this.maxRetries);},n.open=function(e,t,n,i){ void 0===i&&(i={});var r=i.srgb?ty(t.format):t.format,s=new nO(n,wW({name:e,addressU:+!!t.cubemap,addressV:+!!t.cubemap,width:t.width,height:t.height,format:r,cubemap:t.cubemap,levels:t.levels},i));return s.upload(),s},n.parse=function(e,t,n,i){var r,s,a,o=new eA(e),l=[o.readU32be(),o.readU32be(),o.readU32be()];if(0xab4b5458!==l[0]||0x203230bb!==l[1]||0xd0a1a0a!==l[2])return null;for(var u={vkFormat:o.readU32(),typeSize:o.readU32(),pixelWidth:o.readU32(),pixelHeight:o.readU32(),pixelDepth:o.readU32(),layerCount:o.readU32(),faceCount:o.readU32(),levelCount:o.readU32(),supercompressionScheme:o.readU32()},c={dfdByteOffset:o.readU32(),dfdByteLength:o.readU32(),kvdByteOffset:o.readU32(),kvdByteLength:o.readU32(),sgdByteOffset:o.readU64(),sgdByteLength:o.readU64()},h=[],f=0;f<Math.max(1,u.levelCount);++f)h.push({byteOffset:o.readU64(),byteLength:o.readU64(),uncompressedByteLength:o.readU64()});if(o.readU32()!==c.kvdByteOffset-c.dfdByteOffset)return null;o.skip(8);var d=o.readU8();(o.skip(c.dfdByteLength-9),o.skip(c.kvdByteLength),1===u.supercompressionScheme||d===wX.KHR_DF_MODEL_UASTC)?wM(this.device,t.load,e,n,{isGGGR:((null==i||null==(a=i.file)||null==(s=a.variants)||null==(r=s.basis)?void 0:r.opt)&8)!=0,isKTX2:true})||n("Basis module not found. Asset ["+i.name+"]("+i.getFileUrl()+") basis texture variant will not be loaded."):n("unsupported KTX2 pixel format");},t}(wR);function wq(){return (wq=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);}return e}).apply(this,arguments)}function wK(e,t){return (wK=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var wZ=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this).maxRetries=0,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&wK(t,e);var n=t.prototype;return n.load=function(e,t,n){pZ.fetchArrayBuffer(e.load,t,n,this.maxRetries);},n.open=function(e,t,n,i){ void 0===i&&(i={});var r,s,a=new Uint32Array(t,0,32),o=a[4],l=a[3],u=Math.max(a[7],1),c=4===a[20],h=a[21],f=a[22],d=65024===a[28],p=false,m=false,_=false,v=false,g=null,y=1;if(c?0x31545844===h?(g=8,p=true):0x35545844===h?(g=10,p=true):113===h?(g=12,y=2):116===h?(g=14,y=4):0x31435445===h?(g=21,p=true,m=true):0x31333250===h||0x31343250===h?(g=0x31333250===h?24:25,p=true,_=true):(0x31333450===h||0x31343450===h)&&(g=0x31333450===h?26:27,p=true,v=true):32===f&&(g=7),!g)return new nO(n,{width:4,height:4,format:6,name:"dds-legacy-empty"});r=new nO(n,wq({name:e,addressU:+!!d,addressV:+!!d,width:o,height:l,format:g,cubemap:d,mipmaps:u>1},i));for(var S=128,x=d?6:1,b=0x31545844===h?8:16,T=0;T<x;T++)for(var E=o,w=l,A=0;A<u;A++){s=p?m?Math.floor((E+3)/4)*Math.floor((w+3)/4)*8:_?Math.max(E,16)*Math.max(w,8)/4:v?Math.max(E,8)*Math.max(w,8)/2:Math.floor((E+4-1)/4)*Math.floor((w+4-1)/4)*b:E*w*4;var C=14===g?new Float32Array(t,S,s):12===g?new Uint16Array(t,S,s):new Uint8Array(t,S,s);d?(r._levels[A]||(r._levels[A]=[]),r._levels[A][T]=C):r._levels[A]=C,S+=s*y,E=Math.max(.5*E,1),w=Math.max(.5*w,1);}return r.upload(),r},t}(wR);function wQ(){return (wQ=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);}return e}).apply(this,arguments)}function wJ(e,t){return (wJ=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var w$=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this).maxRetries=0,n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&wJ(t,e);var n=t.prototype;return n.load=function(e,t,n){pZ.fetchArrayBuffer(e.load,t,n,this.maxRetries),n.data&&!n.data.type&&(n.data.type=t2);},n.open=function(e,t,n,i){ void 0===i&&(i={});var r=this.parse(t);if(!r)return null;var s=new nO(n,wQ({name:e,addressU:0,addressV:1,minFilter:0,magFilter:0,width:r.width,height:r.height,levels:r.levels,format:7,type:t2,mipmaps:false},i));return s.upload(),s},n.parse=function(e){var t=new eA(e);if(!t.readLine().startsWith("#?RADIANCE"))return null;for(var n={};;){var i=t.readLine();if(0===i.length)break;var r=i.split("=");2===r.length&&(n[r[0]]=r[1]);}if(!n.hasOwnProperty("FORMAT"))return null;var s=t.readLine().split(" ");if(4!==s.length)return null;var a=parseInt(s[1],10),o=parseInt(s[3],10),l=this._readPixels(t,o,a,"-Y"===s[0]);return l?{width:o,height:a,levels:[l]}:null},n._readPixels=function(e,t,n,i){if(t<8||t>32767)return this._readPixelsFlat(e,t,n);var r,s,a,o,l,u,c=[0,0,0,0];if(e.readArray(c),2!==c[0]||2!==c[1]||(128&c[2])!=0)return e.skip(-4),this._readPixelsFlat(e,t,n);var h=new Uint8Array(new ArrayBuffer(t*n*4)),f=i?0:4*t*(n-1);for(s=0;s<n;++s){if(s&&e.readArray(c),(c[2]<<8)+c[3]!==t)return null;for(o=0;o<4;++o)for(r=0;r<t;)if((l=e.readU8())>128){if(r+(l-=128)>t)return null;for(a=0,u=e.readU8();a<l;++a)h[f+o+4*r++]=u;}else {if(0===l||r+l>t)return null;for(a=0;a<l;++a)h[f+o+4*r++]=e.readU8();}f+=4*t*(i?1:-1);}return h},n._readPixelsFlat=function(e,t,n){return e.remainingBytes===t*n*4?new Uint8Array(e.arraybuffer,e.offset):null},t}(wR);function w0(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function w1(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function w2(e,t){return (w2=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var w3={repeat:0,clamp:1,mirror:2},w4={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},w5={default:t0,rgbm:t1,rgbe:t2,rgbp:t3,swizzleGGGR:t4},w8=function(e){var t,n=nM.calcMipLevelsCount(e._width,e._height);if(!(7!==e._format&&14!==e._format||e._volume||e._compressed||1===e._levels.length||e._levels.length===n||w1(t=e._cubemap?e._levels[0][0]:e._levels[0],HTMLCanvasElement)||w1(t,HTMLImageElement)||w1(t,HTMLVideoElement))){for(var i=function(e,t,n){for(var i=Math.max(1,e>>1),r=Math.max(1,t>>1),s=new n.constructor(i*r*4),a=Math.floor(e/i),o=Math.floor(t/r),l=a*o,u=0;u<r;++u)for(var c=0;c<i;++c)for(var h=0;h<4;++h){for(var f=0,d=0;d<o;++d)for(var p=0;p<a;++p)f+=n[(c*a+p+(u*o+d)*e)*4+h];s[(c+u*i)*4+h]=f/l;}return s},r=e._levels.length;r<n;++r){var s=Math.max(1,e._width>>r-1),a=Math.max(1,e._height>>r-1);if(e._cubemap){for(var o=[],l=0;l<6;++l)o.push(i(s,a,e._levels[r-1][l]));e._levels.push(o);}else e._levels.push(i(s,a,e._levels[r-1]));}e._levelsUpdated=e._cubemap?[[true,true,true,true,true,true]]:[true];}},w6=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n=e.call(this,t,"texture")||this,i=t.assets,r=t.graphicsDevice;return n._device=r,n._assets=i,n.imgParser=new wU(i,r),n.parsers={dds:new wZ(i),ktx:new wH(i),ktx2:new wY(i,r),basis:new wN(i,r),hdr:new w$(i)},n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&w2(t,e);var n,i=t.prototype;return i._getUrlWithoutParams=function(e){return e.indexOf("?")>=0?e.split("?")[0]:e},i._getParser=function(e){var t=en.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".","");return this.parsers[t]||this.imgParser},i._getTextureOptions=function(e){var t={};if(e){(null==(n=e.name)?void 0:n.length)>0&&(t.name=e.name);var n,i=e.data;i.hasOwnProperty("minfilter")&&(t.minFilter=w4[i.minfilter]),i.hasOwnProperty("magfilter")&&(t.magFilter=w4[i.magfilter]),i.hasOwnProperty("addressu")&&(t.addressU=w3[i.addressu]),i.hasOwnProperty("addressv")&&(t.addressV=w3[i.addressv]),i.hasOwnProperty("mipmaps")&&(t.mipmaps=i.mipmaps),i.hasOwnProperty("anisotropy")&&(t.anisotropy=i.anisotropy),i.hasOwnProperty("flipY")&&(t.flipY=!!i.flipY),i.hasOwnProperty("srgb")&&(t.srgb=!!i.srgb),t.type=t0,i.hasOwnProperty("type")?t.type=w5[i.type]:i.hasOwnProperty("rgbm")&&i.rgbm?t.type=t1:e.file&&(8&e.file.opt)!=0&&(t.type=t4);}return t},i.load=function(e,t,n){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,n);},i.open=function(e,t,n){if(e){var i=this._getTextureOptions(n),r=this._getParser(e).open(e,t,this._device,i);return null===r?r=new nO(this._device,{width:4,height:4,format:6}):(w8(r),t.unswizzledGGGR&&(n.file.variants.basis.opt&=-9)),r}},i.patch=function(e,t){var n=e.resource;if(n)for(var i,r=this._getTextureOptions(e),s=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return w0(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return w0(e,void 0)}}(e))){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(Object.keys(r));!(i=s()).done;){var a=i.value;n[a]=r[a];}},n=[{key:"crossOrigin",get:function(){return this.imgParser.crossOrigin},set:function(e){this.imgParser.crossOrigin=e;}},{key:"maxRetries",get:function(){return this.imgParser.maxRetries},set:function(e){for(var t in this.imgParser.maxRetries=e,this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(mn),w9="inline",w7="immersive-vr",Ae="immersive-ar",At="viewer",An="left",Ai="cpu-optimized",Ar="gpu-optimized",As="luminance-alpha",Aa="unsigned-short",Ao="float32",Al=function(){var e;function t(e){this._supported=ef.browser&&!!window.XRDOMOverlayState,this._root=null,this._manager=e;}return e=[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._supported&&this._manager.active&&null!==this._manager._session.domOverlayState}},{key:"state",get:function(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState?this._manager._session.domOverlayState.type:null}},{key:"root",get:function(){return this._root},set:function(e){this._supported&&!this._manager.active&&(this._root=e);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}();function Au(e,t){return (Au=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ac=[],Ah=[],Af=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i,r){var s;return void 0===r&&(r=null),(s=e.call(this)||this).manager=t,s._xrHitTestSource=n,s._transient=i,s._inputSource=r,s}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Au(t,e);var n=t.prototype;return n.remove=function(){if(this._xrHitTestSource){var e=this.manager.hitTest.sources,t=e.indexOf(this);-1!==t&&e.splice(t,1),this.onStop();}},n.onStop=function(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this);},n.update=function(e){if(this._transient)for(var t=e.getHitTestResultsForTransientInput(this._xrHitTestSource),n=0;n<t.length;n++){var i=t[n];if(i.results.length){var r=void 0;i.inputSource&&(r=this.manager.input._getByInputSource(i.inputSource)),this.updateHitResults(i.results,r);}}else {var s=e.getHitTestResults(this._xrHitTestSource);if(!s.length)return;this.updateHitResults(s);}},n.updateHitResults=function(e,t){if(!this._inputSource||this._inputSource===t){var n,i,r,s=null!=(n=Ac.pop())?n:new eW;t?s.copy(t.getOrigin()):s.copy(this.manager.camera.getPosition());for(var a=1/0,o=null,l=null!=(i=Ac.pop())?i:new eW,u=null!=(r=Ah.pop())?r:new e0,c=0;c<e.length;c++){var h=e[c].getPose(this.manager._referenceSpace),f=s.distance(h.transform.position);f>=a||(a=f,o=e[c],l.copy(h.transform.position),u.copy(h.transform.orientation));}this.fire("result",l,u,t||this._inputSource,o),this.manager.hitTest.fire("result",this,l,u,t||this._inputSource,o),Ac.push(s),Ac.push(l),Ah.push(u);}},t}(ex);function Ad(e,t){return (Ad=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}Af.EVENT_REMOVE="remove",Af.EVENT_RESULT="result";var Ap=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this)._supported=ef.browser&&!!(window.XRSession&&window.XRSession.prototype.requestHitTestSource),n._available=false,n._checkingAvailability=false,n.sources=[],n.manager=t,n._supported&&(n.manager.on("start",n._onSessionStart,n),n.manager.on("end",n._onSessionEnd,n)),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Ad(t,e);var n,i=t.prototype;return i._onSessionStart=function(){var e=this;if(this.manager.session.enabledFeatures){var t=-1!==this.manager.session.enabledFeatures.indexOf("hit-test");if(!t)return;this._available=t,this.fire("available");}else this._checkingAvailability||(this._checkingAvailability=true,this.manager.session.requestReferenceSpace(At).then(function(t){e.manager.session.requestHitTestSource({space:t}).then(function(t){t.cancel(),e.manager.active&&(e._available=true,e.fire("available"));}).catch(function(){});}).catch(function(){}));},i._onSessionEnd=function(){if(this._available){this._available=false;for(var e=0;e<this.sources.length;e++)this.sources[e].onStop();this.sources=[],this.fire("unavailable");}},i.start=function(e){var t,n=this;if(void 0===e&&(e={}),!this._supported){null==e.callback||e.callback.call(e,Error("XR HitTest is not supported"),null);return}if(!this._available){null==e.callback||e.callback.call(e,Error("XR HitTest is not available"),null);return}e.profile||e.spaceType||(e.spaceType=At);var i=e.offsetRay;i&&(t=new XRRay(new DOMPoint(i.origin.x,i.origin.y,i.origin.z,1),new DOMPoint(i.direction.x,i.direction.y,i.direction.z,0)));var r=e.callback;e.spaceType?this.manager.session.requestReferenceSpace(e.spaceType).then(function(i){if(!n.manager.session){var s=Error("XR Session is not started (2)");r&&r(s),n.fire("error",s);return}n.manager.session.requestHitTestSource({space:i,entityTypes:e.entityTypes||void 0,offsetRay:t}).then(function(t){n._onHitTestSource(t,false,e.inputSource,r);}).catch(function(e){r&&r(e),n.fire("error",e);});}).catch(function(e){r&&r(e),n.fire("error",e);}):this.manager.session.requestHitTestSourceForTransientInput({profile:e.profile,entityTypes:e.entityTypes||void 0,offsetRay:t}).then(function(t){n._onHitTestSource(t,true,e.inputSource,r);}).catch(function(e){r&&r(e),n.fire("error",e);});},i._onHitTestSource=function(e,t,n,i){if(!this.manager.session){e.cancel();var r=Error("XR Session is not started (3)");i&&i(r),this.fire("error",r);return}var s=new Af(this.manager,e,t,null!=n?n:null);this.sources.push(s),i&&i(null,s),this.fire("add",s);},i.update=function(e){if(this._available)for(var t=0;t<this.sources.length;t++)this.sources[t].update(e);},n=[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._available}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function Am(e,t){return (Am=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}Ap.EVENT_AVAILABLE="available",Ap.EVENT_UNAVAILABLE="unavailable",Ap.EVENT_ADD="add",Ap.EVENT_REMOVE="remove",Ap.EVENT_RESULT="result",Ap.EVENT_ERROR="error";var A_=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this)||this)._bitmap=null,i._measuredWidth=0,i._trackable=false,i._tracking=false,i._emulated=false,i._pose=null,i._position=new eW,i._rotation=new e0,i._image=t,i._width=n,i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Am(t,e);var n,i=t.prototype;return i.prepare=function(){var e=this;return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then(function(t){return e._bitmap=t,{image:e._bitmap,widthInMeters:e._width}})},i.destroy=function(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null);},i.getPosition=function(){return this._pose&&this._position.copy(this._pose.transform.position),this._position},i.getRotation=function(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation},n=[{key:"image",get:function(){return this._image}},{key:"width",get:function(){return this._width},set:function(e){this._width=e;}},{key:"trackable",get:function(){return this._trackable}},{key:"tracking",get:function(){return this._tracking}},{key:"emulated",get:function(){return this._emulated}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function Av(e,t){return (Av=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}A_.EVENT_TRACKED="tracked",A_.EVENT_UNTRACKED="untracked";var Ag=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this)._supported=ef.browser&&!!window.XRImageTrackingResult,n._available=false,n._images=[],n._manager=t,n._supported&&(n._manager.on("start",n._onSessionStart,n),n._manager.on("end",n._onSessionEnd,n)),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Av(t,e);var n,i=t.prototype;return i.add=function(e,t){if(!this._supported||this._manager.active)return null;var n=new A_(e,t);return this._images.push(n),n},i.remove=function(e){if(!this._manager.active){var t=this._images.indexOf(e);-1!==t&&(e.destroy(),this._images.splice(t,1));}},i._onSessionStart=function(){var e=this;this._manager.session.getTrackedImageScores().then(function(t){e._available=true;for(var n=0;n<t.length;n++)e._images[n]._trackable="trackable"===t[n];}).catch(function(t){e._available=false,e.fire("error",t);});},i._onSessionEnd=function(){this._available=false;for(var e=0;e<this._images.length;e++){var t=this._images[e];t._pose=null,t._measuredWidth=0,t._tracking&&(t._tracking=false,t.fire("untracked"));}},i.prepareImages=function(e){this._images.length?Promise.all(this._images.map(function(e){return e.prepare()})).then(function(t){e(null,t);}).catch(function(t){e(t,null);}):e(null,null);},i.update=function(e){if(this._available){for(var t=e.getImageTrackingResults(),n={},i=0;i<t.length;i++){n[t[i].index]=t[i];var r=this._images[t[i].index];r._emulated="emulated"===t[i].trackingState,r._measuredWidth=t[i].measuredWidthInMeters,r._pose=e.getPose(t[i].imageSpace,this._manager._referenceSpace);}for(var s=0;s<this._images.length;s++)this._images[s]._tracking&&!n[s]?(this._images[s]._tracking=false,this._images[s].fire("untracked")):!this._images[s]._tracking&&n[s]&&(this._images[s]._tracking=true,this._images[s].fire("tracked"));}},n=[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._available}},{key:"images",get:function(){return this._images}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);Ag.EVENT_ERROR="error";for(var Ay=function(){var e;function t(e,t){this._joints=[],this._tip=null,this._index=e,this._hand=t,this._hand._fingers.push(this);}return e=[{key:"index",get:function(){return this._index}},{key:"hand",get:function(){return this._hand}},{key:"joints",get:function(){return this._joints}},{key:"tip",get:function(){return this._tip}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}(),AS=ef.browser&&window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],Ax={},Ab=0;Ab<AS.length;Ab++)Ax[AS[Ab]]=true;var AT=function(){function e(e,t,n,i){ void 0===i&&(i=null),this._radius=null,this._localTransform=new e$,this._worldTransform=new e$,this._localPosition=new eW,this._localRotation=new e0,this._position=new eW,this._rotation=new e0,this._dirtyLocal=true,this._index=e,this._id=t,this._hand=n,this._finger=i,this._wrist="wrist"===t,this._tip=this._finger&&!!Ax[t];}var t,n=e.prototype;return n.update=function(e){this._dirtyLocal=true,this._radius=e.radius,this._localPosition.copy(e.transform.position),this._localRotation.copy(e.transform.orientation);},n._updateTransforms=function(){this._dirtyLocal&&(this._dirtyLocal=false,this._localTransform.setTRS(this._localPosition,this._localRotation,eW.ONE));var e=this._hand._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform);},n.getPosition=function(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position},n.getRotation=function(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation},t=[{key:"id",get:function(){return this._id}},{key:"index",get:function(){return this._index}},{key:"hand",get:function(){return this._hand}},{key:"finger",get:function(){return this._finger}},{key:"wrist",get:function(){return this._wrist}},{key:"tip",get:function(){return this._tip}},{key:"radius",get:function(){return this._radius||.005}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function AE(e,t){return (AE=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Aw=[],AA=new eW,AC=new eW,AP=new eW;ef.browser&&window.XRHand&&(Aw=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);var AI=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){(n=e.call(this)||this)._tracking=false,n._fingers=[],n._joints=[],n._jointsById={},n._tips=[],n._wrist=null;var n,i=t._xrInputSource.hand;if(n._manager=t._manager,n._inputSource=t,i.get("wrist")){var r=new AT(0,"wrist",n,null);n._wrist=r,n._joints.push(r),n._jointsById.wrist=r;}for(var s=0;s<Aw.length;s++)for(var a=new Ay(s,n),o=0;o<Aw[s].length;o++){var l=Aw[s][o];if(i.get(l)){var u=new AT(o,l,n,a);n._joints.push(u),n._jointsById[l]=u,u.tip&&(n._tips.push(u),a._tip=u),a._joints.push(u);}}return n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&AE(t,e);var n,i=t.prototype;return i.update=function(e){for(var t=this._inputSource._xrInputSource,n=0;n<this._joints.length;n++){var i=this._joints[n],r=t.hand.get(i._id);if(r){var s=void 0;if("hidden"!==e.session.visibilityState&&(s=e.getJointPose(r,this._manager._referenceSpace)),s)i.update(s),i.wrist&&!this._tracking&&(this._tracking=true,this.fire("tracking"));else if(i.wrist){this._tracking&&(this._tracking=false,this.fire("trackinglost"));break}}}var a=this._jointsById["thumb-metacarpal"],o=this._jointsById["thumb-tip"],l=this._jointsById["index-finger-phalanx-proximal"],u=this._jointsById["index-finger-tip"],c=this._jointsById["ring-finger-phalanx-proximal"],h=this._jointsById["pinky-finger-phalanx-proximal"];if(a&&o&&l&&u&&c&&h){this._inputSource._dirtyRay=true,this._inputSource._rayLocal.origin.lerp(o._localPosition,u._localPosition,.5);var f=a,d=h;if(this._inputSource.handedness===An){var p=f;f=d,d=p;}AA.sub2(f._localPosition,this._wrist._localPosition),AC.sub2(d._localPosition,this._wrist._localPosition),AP.cross(AA,AC).normalize(),AA.lerp(l._localPosition,c._localPosition,.5),AA.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(AP,AA,.5).normalize();}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=true,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=false,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource));},i._fingerIsClosed=function(e){var t=this._fingers[e];return AA.sub2(t.joints[0]._localPosition,t.joints[1]._localPosition).normalize(),AC.sub2(t.joints[2]._localPosition,t.joints[3]._localPosition).normalize(),-0.8>AA.dot(AC)},i.getJointById=function(e){return this._jointsById[e]||null},n=[{key:"fingers",get:function(){return this._fingers}},{key:"joints",get:function(){return this._joints}},{key:"tips",get:function(){return this._tips}},{key:"wrist",get:function(){return this._wrist}},{key:"tracking",get:function(){return this._tracking}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function AL(e,t){return (AL=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}AI.EVENT_TRACKING="tracking",AI.EVENT_TRACKINGLOST="trackinglost";var AD=new eW,AM=new e0,AR=0,AO=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this)||this)._ray=new tn,i._rayLocal=new tn,i._grip=false,i._hand=null,i._velocitiesAvailable=false,i._velocitiesTimestamp=eL(),i._localTransform=null,i._worldTransform=null,i._position=new eW,i._rotation=new e0,i._localPosition=null,i._localPositionLast=null,i._localRotation=null,i._linearVelocity=null,i._dirtyLocal=true,i._dirtyRay=false,i._selecting=false,i._squeezing=false,i._elementInput=true,i._elementEntity=null,i._hitTestSources=[],i._id=++AR,i._manager=t,i._xrInputSource=n,n.hand&&(i._hand=new AI(i)),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&AL(t,e);var n,i=t.prototype;return i.update=function(e){if(this._hand)this._hand.update(e);else {var t=this._xrInputSource.gripSpace;if(t){var n=e.getPose(t,this._manager._referenceSpace);if(n){this._grip||(this._grip=true,this._localTransform=new e$,this._worldTransform=new e$,this._localPositionLast=new eW,this._localPosition=new eW,this._localRotation=new e0,this._linearVelocity=new eW);var i=eL(),r=(i-this._velocitiesTimestamp)/1e3;this._velocitiesTimestamp=i,this._dirtyLocal=true,this._localPositionLast.copy(this._localPosition),this._localPosition.copy(n.transform.position),this._localRotation.copy(n.transform.orientation),this._velocitiesAvailable=true,this._manager.input.velocitiesSupported&&n.linearVelocity?this._linearVelocity.copy(n.linearVelocity):r>0&&(AD.sub2(this._localPosition,this._localPositionLast).divScalar(r),this._linearVelocity.lerp(this._linearVelocity,AD,.15));}else this._velocitiesAvailable=false;}var s=e.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);s&&(this._dirtyRay=true,this._rayLocal.origin.copy(s.transform.position),this._rayLocal.direction.set(0,0,-1),AM.copy(s.transform.orientation),AM.transformVector(this._rayLocal.direction,this._rayLocal.direction));}},i._updateTransforms=function(){this._dirtyLocal&&(this._dirtyLocal=false,this._localTransform.setTRS(this._localPosition,this._localRotation,eW.ONE));var e=this._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform);},i._updateRayTransforms=function(){var e=this._dirtyRay;if(this._dirtyRay=false,this._manager.camera.parent){var t=this._manager.camera.parent.getWorldTransform();t.getTranslation(this._position),this._rotation.setFromMat4(t),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction);}else e&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction));},i.getPosition=function(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null},i.getLocalPosition=function(){return this._localPosition},i.getRotation=function(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null},i.getLocalRotation=function(){return this._localRotation},i.getLinearVelocity=function(){return this._velocitiesAvailable?this._linearVelocity:null},i.getOrigin=function(){return this._updateRayTransforms(),this._ray.origin},i.getDirection=function(){return this._updateRayTransforms(),this._ray.direction},i.hitTestStart=function(e){var t=this;void 0===e&&(e={}),e.inputSource=this,e.profile=this._xrInputSource.profiles[0];var n=e.callback;e.callback=function(e,i){i&&t.onHitTestSourceAdd(i),n&&n(e,i);},this._manager.hitTest.start(e);},i.onHitTestSourceAdd=function(e){var t=this;this._hitTestSources.push(e),this.fire("hittest:add",e),e.on("result",function(n,i,r,s){r===t&&t.fire("hittest:result",e,n,i,s);}),e.once("remove",function(){t.onHitTestSourceRemove(e),t.fire("hittest:remove",e);});},i.onHitTestSourceRemove=function(e){var t=this._hitTestSources.indexOf(e);-1!==t&&this._hitTestSources.splice(t,1);},n=[{key:"id",get:function(){return this._id}},{key:"inputSource",get:function(){return this._xrInputSource}},{key:"targetRayMode",get:function(){return this._xrInputSource.targetRayMode}},{key:"handedness",get:function(){return this._xrInputSource.handedness}},{key:"profiles",get:function(){return this._xrInputSource.profiles}},{key:"grip",get:function(){return this._grip}},{key:"hand",get:function(){return this._hand}},{key:"gamepad",get:function(){return this._xrInputSource.gamepad||null}},{key:"selecting",get:function(){return this._selecting}},{key:"squeezing",get:function(){return this._squeezing}},{key:"elementInput",get:function(){return this._elementInput},set:function(e){this._elementInput!==e&&(this._elementInput=e,this._elementInput||(this._elementEntity=null));}},{key:"elementEntity",get:function(){return this._elementEntity}},{key:"hitTestSources",get:function(){return this._hitTestSources}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function Ak(e,t){return (Ak=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}AO.EVENT_REMOVE="remove",AO.EVENT_SELECT="select",AO.EVENT_SELECTSTART="selectstart",AO.EVENT_SELECTEND="selectend",AO.EVENT_SQUEEZE="squeeze",AO.EVENT_SQUEEZESTART="squeezestart",AO.EVENT_SQUEEZEEND="squeezeend",AO.EVENT_HITTESTADD="hittest:add",AO.EVENT_HITTESTREMOVE="hittest:remove",AO.EVENT_HITTESTRESULT="hittest:result";var AN=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n,i,r;return (n=e.call(this)||this)._inputSources=[],n.velocitiesSupported=false,n.manager=t,n.velocitiesSupported=!!(ef.browser&&(null==(r=window.XRPose)||null==(i=r.prototype)?void 0:i.hasOwnProperty("linearVelocity"))),n._onInputSourcesChangeEvt=function(e){n._onInputSourcesChange(e);},n.manager.on("start",n._onSessionStart,n),n.manager.on("end",n._onSessionEnd,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Ak(t,e);var n,i=t.prototype;return i._onSessionStart=function(){var e=this,t=this.manager.session;t.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),t.addEventListener("select",function(t){var n=e._getByInputSource(t.inputSource);n.update(t.frame),n.fire("select",t),e.fire("select",n,t);}),t.addEventListener("selectstart",function(t){var n=e._getByInputSource(t.inputSource);n.update(t.frame),n._selecting=true,n.fire("selectstart",t),e.fire("selectstart",n,t);}),t.addEventListener("selectend",function(t){var n=e._getByInputSource(t.inputSource);n.update(t.frame),n._selecting=false,n.fire("selectend",t),e.fire("selectend",n,t);}),t.addEventListener("squeeze",function(t){var n=e._getByInputSource(t.inputSource);n.update(t.frame),n.fire("squeeze",t),e.fire("squeeze",n,t);}),t.addEventListener("squeezestart",function(t){var n=e._getByInputSource(t.inputSource);n.update(t.frame),n._squeezing=true,n.fire("squeezestart",t),e.fire("squeezestart",n,t);}),t.addEventListener("squeezeend",function(t){var n=e._getByInputSource(t.inputSource);n.update(t.frame),n._squeezing=false,n.fire("squeezeend",t),e.fire("squeezeend",n,t);});for(var n=t.inputSources,i=0;i<n.length;i++)this._addInputSource(n[i]);},i._onSessionEnd=function(){for(var e=this._inputSources.length;e--;){var t=this._inputSources[e];this._inputSources.splice(e,1),t.fire("remove"),this.fire("remove",t);}this.manager.session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt);},i._onInputSourcesChange=function(e){for(var t=0;t<e.removed.length;t++)this._removeInputSource(e.removed[t]);for(var n=0;n<e.added.length;n++)this._addInputSource(e.added[n]);},i._getByInputSource=function(e){for(var t=0;t<this._inputSources.length;t++)if(this._inputSources[t].inputSource===e)return this._inputSources[t];return null},i._addInputSource=function(e){if(!this._getByInputSource(e)){var t=new AO(this.manager,e);this._inputSources.push(t),this.fire("add",t);}},i._removeInputSource=function(e){for(var t=0;t<this._inputSources.length;t++)if(this._inputSources[t].inputSource===e){var n=this._inputSources[t];this._inputSources.splice(t,1);for(var i=n.hitTestSources.length;i--;)n.hitTestSources[i].remove();n.fire("remove"),this.fire("remove",n);return}},i.update=function(e){for(var t=0;t<this._inputSources.length;t++)this._inputSources[t].update(e);},n=[{key:"inputSources",get:function(){return this._inputSources}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function AF(e,t){return (AF=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}AN.EVENT_ADD="add",AN.EVENT_REMOVE="remove",AN.EVENT_SELECT="select",AN.EVENT_SELECTSTART="selectstart",AN.EVENT_SELECTEND="selectend",AN.EVENT_SQUEEZE="squeeze",AN.EVENT_SQUEEZESTART="squeezestart",AN.EVENT_SQUEEZEEND="squeezeend";var AB=new eW,AU=new eW,Az=new e$,AV=new e$,AG=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this)._supported=false,n._available=false,n._lightProbeRequested=false,n._lightProbe=null,n._intensity=0,n._rotation=new e0,n._color=new eN,n._sphericalHarmonics=new Float32Array(27),n._manager=t,n._manager.on("start",n._onSessionStart,n),n._manager.on("end",n._onSessionEnd,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&AF(t,e);var n,i=t.prototype;return i._onSessionStart=function(){this._manager.session.requestLightProbe&&(this._supported=true);},i._onSessionEnd=function(){this._supported=false,this._available=false,this._lightProbeRequested=false,this._lightProbe=null;},i.start=function(){var e,t=this;if(this._manager.session||(e=Error("XR session is not running")),e||this._manager.type===Ae||(e=Error("XR session type is not AR")),e||this._supported||(e=Error("light-estimation is not supported")),(!e&&this._lightProbe||this._lightProbeRequested)&&(e=Error("light estimation is already requested")),e)return void this.fire("error",e);this._lightProbeRequested=true,this._manager.session.requestLightProbe().then(function(e){var n=t._lightProbeRequested;t._lightProbeRequested=false,t._manager.active?n&&(t._lightProbe=e):t.fire("error",Error("XR session is not active"));}).catch(function(e){t._lightProbeRequested=false,t.fire("error",e);});},i.end=function(){this._lightProbeRequested=false,this._lightProbe=null,this._available=false;},i.update=function(e){if(this._lightProbe){var t=e.getLightEstimate(this._lightProbe);if(t){this._available||(this._available=true,this.fire("available"));var n=t.primaryLightIntensity;this._intensity=Math.max(1,Math.max(n.x,Math.max(n.y,n.z))),AB.copy(n).mulScalar(1/this._intensity),this._color.set(AB.x,AB.y,AB.z),AB.set(0,0,0),AU.copy(t.primaryLightDirection),Az.setLookAt(AU,AB,eW.UP),AV.setFromAxisAngle(eW.RIGHT,90),Az.mul(AV),this._rotation.setFromMat4(Az),this._sphericalHarmonics.set(t.sphericalHarmonicsCoefficients);}}},n=[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._available}},{key:"intensity",get:function(){return this._available?this._intensity:null}},{key:"color",get:function(){return this._available?this._color:null}},{key:"rotation",get:function(){return this._available?this._rotation:null}},{key:"sphericalHarmonics",get:function(){return this._available?this._sphericalHarmonics:null}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function AH(e,t){return (AH=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}AG.EVENT_AVAILABLE="available",AG.EVENT_ERROR="error";var AW=0,Aj=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this)||this)._position=new eW,i._rotation=new e0,i._id=++AW,i._planeDetection=t,i._xrPlane=n,i._lastChangedTime=n.lastChangedTime,i._orientation=n.orientation,i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&AH(t,e);var n,i=t.prototype;return i.destroy=function(){this._xrPlane&&(this._xrPlane=null,this.fire("remove"));},i.update=function(e){var t=this._planeDetection._manager,n=e.getPose(this._xrPlane.planeSpace,t._referenceSpace);n&&(this._position.copy(n.transform.position),this._rotation.copy(n.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"));},i.getPosition=function(){return this._position},i.getRotation=function(){return this._rotation},n=[{key:"id",get:function(){return this._id}},{key:"orientation",get:function(){return this._orientation}},{key:"points",get:function(){return this._xrPlane.polygon}},{key:"label",get:function(){return this._xrPlane.semanticLabel||""}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function AX(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function AY(e,t){return (AY=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Aq(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return AX(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return AX(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}Aj.EVENT_REMOVE="remove",Aj.EVENT_CHANGE="change";var AK=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this)._supported=ef.browser&&!!window.XRPlane,n._available=false,n._planesIndex=new Map,n._planes=[],n._manager=t,n._supported&&(n._manager.on("start",n._onSessionStart,n),n._manager.on("end",n._onSessionEnd,n)),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&AY(t,e);var n,i=t.prototype;return i._onSessionStart=function(){this._manager.session.enabledFeatures&&-1!==this._manager.session.enabledFeatures.indexOf("plane-detection")&&(this._available=true,this.fire("available"));},i._onSessionEnd=function(){for(var e=0;e<this._planes.length;e++)this._planes[e].destroy(),this.fire("remove",this._planes[e]);this._planesIndex.clear(),this._planes.length=0,this._available&&(this._available=false,this.fire("unavailable"));},i.update=function(e){if(!this._available)if(this._manager.session.enabledFeatures||!e.detectedPlanes.size)return;else this._available=true,this.fire("available");for(var t,n=e.detectedPlanes,i=Aq(this._planesIndex);!(t=i()).done;){var r=t.value,s=r[0],a=r[1];n.has(s)||(this._planesIndex.delete(s),this._planes.splice(this._planes.indexOf(a),1),a.destroy(),this.fire("remove",a));}for(var o,l=Aq(n);!(o=l()).done;){var u=o.value,c=this._planesIndex.get(u);c?c.update(e):(c=new Aj(this,u),this._planesIndex.set(u,c),this._planes.push(c),c.update(e),this.fire("add",c));}},n=[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._available}},{key:"planes",get:function(){return this._planes}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function AZ(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function AQ(e,t){return (AQ=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function AJ(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return AZ(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return AZ(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}AK.EVENT_AVAILABLE="available",AK.EVENT_UNAVAILABLE="unavailable",AK.EVENT_ADD="add",AK.EVENT_REMOVE="remove";var A$=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i){var r;return void 0===i&&(i=null),(r=e.call(this)||this)._position=new eW,r._rotation=new e0,r._uuid=null,r._uuidRequests=null,r._anchors=t,r._xrAnchor=n,r._uuid=i,r}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&AQ(t,e);var n,i=t.prototype;return i.destroy=function(){if(this._xrAnchor){var e=this._xrAnchor;this._xrAnchor.delete(),this._xrAnchor=null,this.fire("destroy",e,this);}},i.update=function(e){if(this._xrAnchor){var t=e.getPose(this._xrAnchor.anchorSpace,this._anchors.manager._referenceSpace);if(t){if(this._position.equals(t.transform.position)&&this._rotation.equals(t.transform.orientation))return;this._position.copy(t.transform.position),this._rotation.copy(t.transform.orientation),this.fire("change");}}},i.getPosition=function(){return this._position},i.getRotation=function(){return this._rotation},i.persist=function(e){var t=this;if(!this._anchors.persistence){null==e||e(Error("Persistent Anchors are not supported"),null);return}if(this._uuid){null==e||e(null,this._uuid);return}if(this._uuidRequests){e&&this._uuidRequests.push(e);return}this._uuidRequests=[],this._xrAnchor.requestPersistentHandle().then(function(n){t._uuid=n,t._anchors._indexByUuid.set(t._uuid,t),null==e||e(null,n);for(var i,r=AJ(t._uuidRequests);!(i=r()).done;)(0, i.value)(null,n);t._uuidRequests=null,t.fire("persist",n);}).catch(function(n){null==e||e(n,null);for(var i,r=AJ(t._uuidRequests);!(i=r()).done;)(0, i.value)(n,null);t._uuidRequests=null;});},i.forget=function(e){var t=this;if(!this._uuid){null==e||e(Error("Anchor is not persistent"));return}this._anchors.forget(this._uuid,function(n){t._uuid=null,null==e||e(n),t.fire("forget");});},n=[{key:"uuid",get:function(){return this._uuid}},{key:"persistent",get:function(){return !!this._uuid}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function A0(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function A1(e,t){return (A1=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function A2(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return A0(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return A0(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}A$.EVENT_DESTROY="destroy",A$.EVENT_CHANGE="change",A$.EVENT_PERSIST="persist",A$.EVENT_FORGET="forget";var A3=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n,i,r;return (n=e.call(this)||this)._supported=ef.browser&&!!window.XRAnchor,n._available=false,n._checkingAvailability=false,n._persistence=ef.browser&&!!(null==(r=window)||null==(i=r.XRSession)?void 0:i.prototype.restorePersistentAnchor),n._creationQueue=[],n._index=new Map,n._indexByUuid=new Map,n._list=[],n._callbacksAnchors=new Map,n.manager=t,n._supported&&(n.manager.on("start",n._onSessionStart,n),n.manager.on("end",n._onSessionEnd,n)),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&A1(t,e);var n,r=t.prototype;return r._onSessionStart=function(){var e,t=(null==(e=this.manager.session.enabledFeatures)?void 0:e.indexOf("anchors"))>=0;t&&(this._available=t,this.fire("available"));},r._onSessionEnd=function(){if(this._available){this._available=false;for(var e=0;e<this._creationQueue.length;e++)this._creationQueue[e].callback&&this._creationQueue[e].callback(Error("session ended"),null);this._creationQueue.length=0,this._index.clear(),this._indexByUuid.clear();for(var t=this._list.length;t--;)this._list[t].destroy();this._list.length=0,this.fire("unavailable");}},r._createAnchor=function(e,t){ void 0===t&&(t=null);var n=new A$(this,e,t);return this._index.set(e,n),t&&this._indexByUuid.set(t,n),this._list.push(n),n.once("destroy",this._onAnchorDestroy,this),n},r._onAnchorDestroy=function(e,t){this._index.delete(e),t.uuid&&this._indexByUuid.delete(t.uuid);var n=this._list.indexOf(t);-1!==n&&this._list.splice(n,1),this.fire("destroy",t);},r.create=function(e,t,n){var r,s=this;if(!this._available){null==n||n(Error("Anchors API is not available"),null);return}if(window.XRHitTestResult&&(null!=(r=XRHitTestResult)&&"undefined"!=typeof Symbol&&r[Symbol.hasInstance]?!!r[Symbol.hasInstance](e):i(e,r))){if(n=t,!this._supported){null==n||n(Error("Anchors API is not supported"),null);return}if(!e.createAnchor){null==n||n(Error("Creating Anchor from Hit Test is not supported"),null);return}e.createAnchor().then(function(e){var t=s._createAnchor(e);null==n||n(null,t),s.fire("add",t);}).catch(function(e){null==n||n(e,null),s.fire("error",e);});}else this._creationQueue.push({transform:new XRRigidTransform(e,t),callback:n});},r.restore=function(e,t){var n=this;if(!this._available){null==t||t(Error("Anchors API is not available"),null);return}if(!this._persistence){null==t||t(Error("Anchor Persistence is not supported"),null);return}if(!this.manager.active){null==t||t(Error("WebXR session is not active"),null);return}this.manager.session.restorePersistentAnchor(e).then(function(i){var r=n._createAnchor(i,e);null==t||t(null,r),n.fire("add",r);}).catch(function(e){null==t||t(e,null),n.fire("error",e);});},r.forget=function(e,t){var n=this;if(!this._available){null==t||t(Error("Anchors API is not available"));return}if(!this._persistence){null==t||t(Error("Anchor Persistence is not supported"));return}if(!this.manager.active){null==t||t(Error("WebXR session is not active"));return}this.manager.session.deletePersistentAnchor(e).then(function(){null==t||t(null);}).catch(function(e){null==t||t(e),n.fire("error",e);});},r.update=function(e){var t=this;if(!this._available){this.manager.session.enabledFeatures||this._checkingAvailability||(this._checkingAvailability=true,e.createAnchor(new XRRigidTransform,this.manager._referenceSpace).then(function(e){e.delete(),t.manager.active&&(t._available=true,t.fire("available"));}).catch(function(){}));return}if(this._creationQueue.length){for(var n,i=0;i<this._creationQueue.length;i++)n=this,function(i){var r=n._creationQueue[i];e.createAnchor(r.transform,n.manager._referenceSpace).then(function(e){r.callback&&t._callbacksAnchors.set(e,r.callback);}).catch(function(e){r.callback&&r.callback(e,null),t.fire("error",e);});}(i);this._creationQueue.length=0;}for(var r,s=A2(this._index);!(r=s()).done;){var a=r.value,o=a[0],l=a[1];e.trackedAnchors.has(o)||(this._index.delete(o),l.destroy());}for(var u=0;u<this._list.length;u++)this._list[u].update(e);for(var c,h=A2(e.trackedAnchors);!(c=h()).done;){var f=c.value;if(!this._index.has(f)){try{f.anchorSpace;}catch(e){continue}var d=this._createAnchor(f);d.update(e);var p=this._callbacksAnchors.get(f);p&&(this._callbacksAnchors.delete(f),p(null,d)),this.fire("add",d);}}},n=[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._available}},{key:"persistence",get:function(){return this._persistence}},{key:"uuids",get:function(){return this._available&&this._persistence&&this.manager.active?this.manager.session.persistentAnchors:null}},{key:"list",get:function(){return this._list}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function A4(e,t){return (A4=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}A3.EVENT_AVAILABLE="available",A3.EVENT_UNAVAILABLE="unavailable",A3.EVENT_ERROR="error",A3.EVENT_ADD="add",A3.EVENT_DESTROY="destroy";var A5=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this)||this)._lastChanged=0,i._position=new eW,i._rotation=new e0,i._meshDetection=t,i._xrMesh=n,i._lastChanged=i._xrMesh.lastChangedTime,i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&A4(t,e);var n,i=t.prototype;return i.destroy=function(){this._xrMesh&&(this._xrMesh=null,this.fire("remove"));},i.update=function(e){var t=this._meshDetection._manager,n=e.getPose(this._xrMesh.meshSpace,t._referenceSpace);n&&(this._position.copy(n.transform.position),this._rotation.copy(n.transform.orientation)),this._lastChanged!==this._xrMesh.lastChangedTime&&(this._lastChanged=this._xrMesh.lastChangedTime,this.fire("change"));},i.getPosition=function(){return this._position},i.getRotation=function(){return this._rotation},n=[{key:"xrMesh",get:function(){return this._xrMesh}},{key:"label",get:function(){return this._xrMesh.semanticLabel||""}},{key:"vertices",get:function(){return this._xrMesh.vertices}},{key:"indices",get:function(){return this._xrMesh.indices}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function A8(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function A6(e,t){return (A6=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function A9(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return A8(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return A8(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}A5.EVENT_REMOVE="remove",A5.EVENT_CHANGE="change";var A7=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this)._supported=ef.browser&&!!window.XRMesh,n._available=false,n._index=new Map,n._list=[],n._manager=t,n._supported&&(n._manager.on("start",n._onSessionStart,n),n._manager.on("end",n._onSessionEnd,n)),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&A6(t,e);var n,i=t.prototype;return i.update=function(e){if(!this._available)if(this._manager.session.enabledFeatures||!e.detectedMeshes.size)return;else this._available=true,this.fire("available");for(var t,n=A9(e.detectedMeshes);!(t=n()).done;){var i=t.value,r=this._index.get(i);r?r.update(e):(r=new A5(this,i),this._index.set(i,r),this._list.push(r),r.update(e),this.fire("add",r));}for(var s,a=A9(this._index.values());!(s=a()).done;){var o=s.value;e.detectedMeshes.has(o.xrMesh)||this._removeMesh(o);}},i._removeMesh=function(e){this._index.delete(e.xrMesh),this._list.splice(this._list.indexOf(e),1),e.destroy(),this.fire("remove",e);},i._onSessionStart=function(){if(this._manager.session.enabledFeatures){var e=-1!==this._manager.session.enabledFeatures.indexOf("mesh-detection");e&&(this._available=e,this.fire("available"));}},i._onSessionEnd=function(){if(this._available){this._available=false;for(var e,t=A9(this._index.values());!(e=t()).done;){var n=e.value;this._removeMesh(n);}this.fire("unavailable");}},n=[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._available}},{key:"meshes",get:function(){return this._list}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function Ce(e,t){return (Ce=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}A7.EVENT_AVAILABLE="available",A7.EVENT_UNAVAILABLE="unavailable",A7.EVENT_ADD="add",A7.EVENT_REMOVE="remove";var Ct=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i){(r=e.call(this)||this)._positionData=new Float32Array(3),r._viewport=new eY,r._projMat=new e$,r._projViewOffMat=new e$,r._viewMat=new e$,r._viewOffMat=new e$,r._viewMat3=new ej,r._viewInvMat=new e$,r._viewInvOffMat=new e$,r._xrCamera=null,r._textureColor=null,r._textureDepth=null,r._depthInfo=null,r._emptyDepthBuffer=new Uint8Array(32),r._depthMatrix=new e$,r._manager=t,r._xrView=n;var r,s=r._manager.app.graphicsDevice;if(r._manager.views.supportedColor&&(r._xrCamera=r._xrView.camera,r._manager.views.availableColor&&r._xrCamera&&(r._textureColor=new nO(s,{format:6,mipmaps:false,addressU:1,addressV:1,minFilter:1,magFilter:1,width:r._xrCamera.width,height:r._xrCamera.height,name:"XrView-"+r._xrView.eye+"-Color"}))),r._manager.views.supportedDepth&&r._manager.views.availableDepth){var a=+!r._manager.views.depthGpuOptimized;r._textureDepth=new nO(s,{format:r._manager.views.depthPixelFormat,arrayLength:1===i?0:i,mipmaps:false,addressU:1,addressV:1,minFilter:a,magFilter:a,width:4,height:4,name:"XrView-"+r._xrView.eye+"-Depth"});for(var o=0;o<r._textureDepth._levels.length;o++)r._textureDepth._levels[o]=r._emptyDepthBuffer;r._textureDepth.upload();}return (r._textureColor||r._textureDepth)&&s.on("devicelost",r._onDeviceLost,r),r}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Ce(t,e);var n,i=t.prototype;return i.update=function(e,t){this._xrView=t,this._manager.views.availableColor&&(this._xrCamera=this._xrView.camera);var n=e.session.renderState.baseLayer.getViewport(this._xrView);this._viewport.x=n.x,this._viewport.y=n.y,this._viewport.z=n.width,this._viewport.w=n.height,this._projMat.set(this._xrView.projectionMatrix),this._viewMat.set(this._xrView.transform.inverse.matrix),this._viewInvMat.set(this._xrView.transform.matrix),this._updateTextureColor(),this._updateDepth(e);},i._updateTextureColor=function(){if(this._manager.views.availableColor&&this._xrCamera&&this._textureColor){var e=this._manager.webglBinding;if(e){var t=e.getCameraImage(this._xrCamera);if(t){var n=this._manager.app.graphicsDevice,i=n.gl;if(this._frameBufferSource){var r=i.COLOR_ATTACHMENT0,s=this._xrCamera.width,a=this._xrCamera.height;n.setFramebuffer(this._frameBufferSource),i.framebufferTexture2D(i.FRAMEBUFFER,r,i.TEXTURE_2D,t,0),n.setFramebuffer(this._frameBuffer),i.framebufferTexture2D(i.FRAMEBUFFER,r,i.TEXTURE_2D,this._textureColor.impl._glTexture,0),i.bindFramebuffer(i.READ_FRAMEBUFFER,this._frameBufferSource),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this._frameBuffer),i.blitFramebuffer(0,a,s,0,0,0,s,a,i.COLOR_BUFFER_BIT,i.NEAREST);}else this._frameBufferSource=i.createFramebuffer(),this._frameBuffer=i.createFramebuffer();}}}},i._updateDepth=function(e){if(this._manager.views.availableDepth&&this._textureDepth){var t,n,i=this._manager.views.depthGpuOptimized,r=i?this._manager.webglBinding:e;if(!r){this._depthInfo=null;return}var s=r.getDepthInformation(this._xrView);if(!s){this._depthInfo=null;return}var a=!this._depthInfo!=!s;this._depthInfo=s;var o=(null==(t=this._depthInfo)?void 0:t.width)||4,l=(null==(n=this._depthInfo)?void 0:n.height)||4,u=false;if((this._textureDepth.width!==o||this._textureDepth.height!==l)&&(this._textureDepth._width=o,this._textureDepth._height=l,a=true,u=true),a&&(this._depthInfo?this._depthMatrix.data.set(this._depthInfo.normDepthBufferFromNormView.matrix):this._depthMatrix.setIdentity()),this._depthInfo)if(i){if(this._depthInfo.texture){var c=this._manager.app.graphicsDevice.gl;switch(this._textureDepth.impl._glTexture=this._depthInfo.texture,"texture-array"===this._depthInfo.textureType?this._textureDepth.impl._glTarget=c.TEXTURE_2D_ARRAY:this._textureDepth.impl._glTarget=c.TEXTURE_2D,this._manager.views.depthPixelFormat){case 15:this._textureDepth.impl._glInternalFormat=c.R32F,this._textureDepth.impl._glPixelType=c.FLOAT,this._textureDepth.impl._glFormat=c.RED;break;case 16:this._textureDepth.impl._glInternalFormat=c.DEPTH_COMPONENT16,this._textureDepth.impl._glPixelType=c.UNSIGNED_SHORT,this._textureDepth.impl._glFormat=c.DEPTH_COMPONENT;}this._textureDepth.impl._glCreated=true;}}else this._textureDepth._levels[0]=new Uint8Array(this._depthInfo.data),this._textureDepth.upload();else this._textureDepth._levels[0]=this._emptyDepthBuffer,this._textureDepth.upload();u&&this.fire("depth:resize",o,l);}},i.updateTransforms=function(e){e?(this._viewInvOffMat.mul2(e,this._viewInvMat),this.viewOffMat.copy(this._viewInvOffMat).invert()):(this._viewInvOffMat.copy(this._viewInvMat),this.viewOffMat.copy(this._viewMat)),this._viewMat3.setFromMat4(this._viewOffMat),this._projViewOffMat.mul2(this._projMat,this._viewOffMat),this._positionData[0]=this._viewInvOffMat.data[12],this._positionData[1]=this._viewInvOffMat.data[13],this._positionData[2]=this._viewInvOffMat.data[14];},i._onDeviceLost=function(){this._frameBufferSource=null,this._frameBuffer=null,this._depthInfo=null;},i.getDepth=function(e,t){var n,i;return this._manager.views.depthGpuOptimized?null:null!=(i=null==(n=this._depthInfo)?void 0:n.getDepthInMeters(e,t))?i:null},i.destroy=function(){if(this._depthInfo=null,this._textureColor&&(this._textureColor.destroy(),this._textureColor=null),this._textureDepth&&(this._textureDepth.destroy(),this._textureDepth=null),this._frameBufferSource){var e=this._manager.app.graphicsDevice.gl;e.deleteFramebuffer(this._frameBufferSource),this._frameBufferSource=null,e.deleteFramebuffer(this._frameBuffer),this._frameBuffer=null;}},n=[{key:"textureColor",get:function(){return this._textureColor}},{key:"textureDepth",get:function(){return this._textureDepth}},{key:"depthUvMatrix",get:function(){return this._depthMatrix}},{key:"depthValueToMeters",get:function(){var e;return (null==(e=this._depthInfo)?void 0:e.rawValueToMeters)||0}},{key:"eye",get:function(){return this._xrView.eye}},{key:"viewport",get:function(){return this._viewport}},{key:"projMat",get:function(){return this._projMat}},{key:"projViewOffMat",get:function(){return this._projViewOffMat}},{key:"viewOffMat",get:function(){return this._viewOffMat}},{key:"viewInvOffMat",get:function(){return this._viewInvOffMat}},{key:"viewMat3",get:function(){return this._viewMat3}},{key:"positionData",get:function(){return this._positionData}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function Cn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function Ci(e,t){return (Ci=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Cr(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Cn(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Cn(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}Ct.EVENT_DEPTHRESIZE="depth:resize";var Cs=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n,i;return (n=e.call(this)||this)._index=new Map,n._indexTmp=new Map,n._list=[],n._supportedColor=ef.browser&&!!window.XRCamera&&!!window.XRWebGLBinding,n._supportedDepth=ef.browser&&!!window.XRDepthInformation,n._availableColor=false,n._availableDepth=false,n._depthUsage="",n._depthFormat="",(i={})[As]=2,i[Aa]=16,i[Ao]=15,n._depthFormats=i,n._manager=t,n._manager.on("start",n._onSessionStart,n),n._manager.on("end",n._onSessionEnd,n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Ci(t,e);var n,i=t.prototype;return i.update=function(e,t){for(var n=0;n<t.length;n++)this._indexTmp.set(t[n].eye,t[n]);for(var i,r=Cr(this._indexTmp);!(i=r()).done;){var s=i.value,a=s[0],o=s[1],l=this._index.get(a);l?l.update(e,o):(l=new Ct(this._manager,o,t.length),this._index.set(a,l),this._list.push(l),l.update(e,o),this.fire("add",l));}for(var u,c=Cr(this._index);!(u=c()).done;){var h=u.value,f=h[0],d=h[1];if(!this._indexTmp.has(f)){d.destroy(),this._index.delete(f);var p=this._list.indexOf(d);-1!==p&&this._list.splice(p,1),this.fire("remove",d);}}this._indexTmp.clear();},i.get=function(e){return this._index.get(e)||null},i._onSessionStart=function(){if(this._manager.type===Ae&&this._manager.session.enabledFeatures&&(this._availableColor=-1!==this._manager.session.enabledFeatures.indexOf("camera-access"),this._availableDepth=-1!==this._manager.session.enabledFeatures.indexOf("depth-sensing"),this._availableDepth)){var e=this._manager.session;this._depthUsage=e.depthUsage,this._depthFormat=e.depthDataFormat;}},i._onSessionEnd=function(){for(var e,t=Cr(this._index.values());!(e=t()).done;)e.value.destroy();this._index.clear(),this._availableColor=false,this._availableDepth=false,this._depthUsage="",this._depthFormat="",this._list.length=0;},n=[{key:"list",get:function(){return this._list}},{key:"supportedColor",get:function(){return this._supportedColor}},{key:"supportedDepth",get:function(){return this._supportedDepth}},{key:"availableColor",get:function(){return this._availableColor}},{key:"availableDepth",get:function(){return this._availableDepth}},{key:"depthUsage",get:function(){return this._depthUsage}},{key:"depthGpuOptimized",get:function(){return this._depthUsage===Ar}},{key:"depthFormat",get:function(){return this._depthFormat}},{key:"depthPixelFormat",get:function(){var e;return null!=(e=this._depthFormats[this._depthFormat])?e:null}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function Ca(e,t){return (Ca=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}Cs.EVENT_ADD="add",Cs.EVENT_REMOVE="remove";var Co=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this)||this)._supported=ef.browser&&!!navigator.xr,n._available={},n._type=null,n._spaceType=null,n._session=null,n._baseLayer=null,n.webglBinding=null,n._referenceSpace=null,n._camera=null,n._localPosition=new eW,n._localRotation=new e0,n._depthNear=.1,n._depthFar=1e3,n._supportedFrameRates=null,n._width=0,n._height=0,n._framebufferScaleFactor=1,n.app=t,n._available[w9]=false,n._available[w7]=false,n._available[Ae]=false,n.views=new Cs(n),n.domOverlay=new Al(n),n.hitTest=new Ap(n),n.imageTracking=new Ag(n),n.planeDetection=new AK(n),n.meshDetection=new A7(n),n.input=new AN(n),n.lightEstimation=new AG(n),n.anchors=new A3(n),n.views=new Cs(n),n._supported&&(navigator.xr.addEventListener("devicechange",function(){n._deviceAvailabilityCheck();}),n._deviceAvailabilityCheck(),n.app.graphicsDevice.on("devicelost",n._onDeviceLost,n),n.app.graphicsDevice.on("devicerestored",n._onDeviceRestored,n)),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Ca(t,e);var n,i=t.prototype;return i.destroy=function(){},i.start=function(e,t,n,i){var r,s=this,a=i;if((void 0===i?"undefined":i&&"undefined"!=typeof Symbol&&i.constructor===Symbol?"symbol":typeof i)=="object"&&(a=i.callback),!this._available[t]){a&&a(Error("XR is not available"));return}if(this._session){a&&a(Error("XR session is already started"));return}this._camera=e,this._camera.camera.xr=this,this._type=t,this._spaceType=n,this._framebufferScaleFactor=null!=(r=null==i?void 0:i.framebufferScaleFactor)?r:1,this._setClipPlanes(e.nearClip,e.farClip);var o={requiredFeatures:[n],optionalFeatures:[]},l=this.app.graphicsDevice;(null==l?void 0:l.isWebGPU)&&o.requiredFeatures.push("webgpu");var u=null==l?void 0:l.isWebGL2;if(t===Ae){if(o.optionalFeatures.push("light-estimation"),o.optionalFeatures.push("hit-test"),i&&(i.imageTracking&&this.imageTracking.supported&&o.optionalFeatures.push("image-tracking"),i.planeDetection&&o.optionalFeatures.push("plane-detection"),i.meshDetection&&o.optionalFeatures.push("mesh-detection")),this.domOverlay.supported&&this.domOverlay.root&&(o.optionalFeatures.push("dom-overlay"),o.domOverlay={root:this.domOverlay.root}),i&&i.anchors&&this.anchors.supported&&o.optionalFeatures.push("anchors"),i&&i.depthSensing&&this.views.supportedDepth){o.optionalFeatures.push("depth-sensing");var c=[],h=[];if(c.push(Ar,Ai),h.push(Ao,As,Aa),i.depthSensing.usagePreference){var f=c.indexOf(i.depthSensing.usagePreference);-1!==f&&c.splice(f,1),c.unshift(i.depthSensing.usagePreference);}if(i.depthSensing.dataFormatPreference){var d=h.indexOf(i.depthSensing.dataFormatPreference);-1!==d&&h.splice(d,1),h.unshift(i.depthSensing.dataFormatPreference);}o.depthSensing={usagePreference:c,dataFormatPreference:h};}u&&i&&i.cameraColor&&this.views.supportedColor&&o.optionalFeatures.push("camera-access");}o.optionalFeatures.push("hand-tracking"),i&&i.optionalFeatures&&(o.optionalFeatures=o.optionalFeatures.concat(i.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages(function(e,i){if(e){a&&a(e),s.fire("error",e);return}null!==i&&(o.trackedImages=i),s._onStartOptionsReady(t,n,o,a);}):this._onStartOptionsReady(t,n,o,a);},i._onStartOptionsReady=function(e,t,n,i){var r=this;navigator.xr.requestSession(e,n).then(function(e){r._onSessionStart(e,t,i);}).catch(function(e){r._camera.camera.xr=null,r._camera=null,r._type=null,r._spaceType=null,i&&i(e),r.fire("error",e);});},i.end=function(e){if(!this._session){e&&e(Error("XR Session is not initialized"));return}this.webglBinding=null,e&&this.once("end",e),this._session.end();},i.isAvailable=function(e){return this._available[e]},i._deviceAvailabilityCheck=function(){for(var e in this._available)this._sessionSupportCheck(e);},i.initiateRoomCapture=function(e){return this._session?this._session.initiateRoomCapture?void this._session.initiateRoomCapture().then(function(){e&&e(null);}).catch(function(t){e&&e(t);}):void e(Error("Session does not support manual room capture")):void e(Error("Session is not active"))},i.updateTargetFrameRate=function(e,t){var n;if(!(null==(n=this._session)?void 0:n.updateTargetFrameRate)){null==t||t(Error("unable to update frameRate"));return}this._session.updateTargetFrameRate(e).then(function(){null==t||t();}).catch(function(e){null==t||t(e);});},i._sessionSupportCheck=function(e){var t=this;navigator.xr.isSessionSupported(e).then(function(n){t._available[e]!==n&&(t._available[e]=n,t.fire("available",e,n),t.fire("available:"+e,n));}).catch(function(e){t.fire("error",e);});},i._onSessionStart=function(e,t,n){var i=this,r=false;this._session=e;var s=function(){i.fire("visibility:change",e.visibilityState);},a=function(){i._setClipPlanes(i._camera.nearClip,i._camera.farClip);},o=function(){i._camera&&(i._camera.off("set_nearClip",a),i._camera.off("set_farClip",a),i._camera.camera.xr=null,i._camera=null),e.removeEventListener("end",o),e.removeEventListener("visibilitychange",s),r||i.fire("end"),i._session=null,i._referenceSpace=null,i._width=0,i._height=0,i._type=null,i._spaceType=null,i.app.systems&&i.app.tick();};e.addEventListener("end",o),e.addEventListener("visibilitychange",s),this._camera.on("set_nearClip",a),this._camera.on("set_farClip",a),this._createBaseLayer(),this.session.supportedFrameRates?this._supportedFrameRates=Array.from(this.session.supportedFrameRates):this._supportedFrameRates=null,this._session.addEventListener("frameratechange",function(){var e;i.fire("frameratechange",null==(e=i._session)?void 0:e.frameRate);}),e.requestReferenceSpace(t).then(function(e){i._referenceSpace=e,i.app.tick(),n&&n(null),i.fire("start");}).catch(function(t){r=true,e.end(),n&&n(t),i.fire("error",t);});},i._setClipPlanes=function(e,t){(this._depthNear!==e||this._depthFar!==t)&&(this._depthNear=e,this._depthFar=t,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}));},i._createBaseLayer=function(){var e=this.app.graphicsDevice,t=e.maxPixelRatio/window.devicePixelRatio*this._framebufferScaleFactor;if(this._baseLayer=new XRWebGLLayer(this._session,e.gl,{alpha:true,depth:true,stencil:true,framebufferScaleFactor:t,antialias:false}),(null==e?void 0:e.isWebGL2)&&window.XRWebGLBinding)try{this.webglBinding=new XRWebGLBinding(this._session,e.gl);}catch(e){this.fire("error",e);}this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar});},i._onDeviceLost=function(){this._session&&(this.webglBinding&&(this.webglBinding=null),this._baseLayer=null,this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}));},i._onDeviceRestored=function(){var e=this;this._session&&setTimeout(function(){e.app.graphicsDevice.gl.makeXRCompatible().then(function(){e._createBaseLayer();}).catch(function(t){e.fire("error",t);});},0);},i.update=function(e){if(!this._session)return  false;var t=e.session.renderState.baseLayer.framebufferWidth,n=e.session.renderState.baseLayer.framebufferHeight;(this._width!==t||this._height!==n)&&(this._width=t,this._height=n,this.app.graphicsDevice.setResolution(t,n));var i=e.getViewerPose(this._referenceSpace);if(!i)return  false;var r=this.views.list.length;this.views.update(e,i.views);var s=i.transform.position,a=i.transform.orientation;if(this._localPosition.set(s.x,s.y,s.z),this._localRotation.set(a.x,a.y,a.z,a.w),0===r&&this.views.list.length>0){var o=new e$,l=this.views.list[0];o.copy(l.projMat);var u=o.data,c=2*Math.atan(1/u[5])*180/Math.PI,h=u[5]/u[0],f=u[14]/(u[10]+1),d=u[14]/(u[10]-1);this._camera.camera.setXrProperties({aspectRatio:h,farClip:f,fov:c,horizontalFov:false,nearClip:d});}return this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(e),this._type===Ae&&(this.hitTest.supported&&this.hitTest.update(e),this.lightEstimation.supported&&this.lightEstimation.update(e),this.imageTracking.supported&&this.imageTracking.update(e),this.anchors.supported&&this.anchors.update(e),this.planeDetection.supported&&this.planeDetection.update(e),this.meshDetection.supported&&this.meshDetection.update(e)),this.fire("update",e),true},n=[{key:"supported",get:function(){return this._supported}},{key:"active",get:function(){return !!this._session}},{key:"type",get:function(){return this._type}},{key:"spaceType",get:function(){return this._spaceType}},{key:"session",get:function(){return this._session}},{key:"frameRate",get:function(){var e,t;return null!=(t=null==(e=this._session)?void 0:e.frameRate)?t:null}},{key:"supportedFrameRates",get:function(){return this._supportedFrameRates}},{key:"framebufferScaleFactor",get:function(){return this._framebufferScaleFactor}},{key:"fixedFoveation",get:function(){var e,t;return null!=(t=null==(e=this._baseLayer)?void 0:e.fixedFoveation)?t:null},set:function(e){var t,n;(null!=(n=null==(t=this._baseLayer)?void 0:t.fixedFoveation)?n:null)!==null&&(this.app.graphicsDevice.samples,this._baseLayer.fixedFoveation=e);}},{key:"camera",get:function(){return this._camera?this._camera.entity:null}},{key:"visibilityState",get:function(){return this._session?this._session.visibilityState:null}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function Cl(e,t){return (Cl=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}Co.EVENT_AVAILABLE="available",Co.EVENT_START="start",Co.EVENT_END="end",Co.EVENT_UPDATE="update",Co.EVENT_ERROR="error";var Cu=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){ void 0===n&&(n={});var i,r=e.call(this,t)||this,s=new mP;return s.graphicsDevice=null!=(i=n.graphicsDevice)?i:r.createDevice(t,n),r.addComponentSystems(s),r.addResourceHandles(s),s.elementInput=n.elementInput,s.keyboard=n.keyboard,s.mouse=n.mouse,s.touch=n.touch,s.gamepads=n.gamepads,s.scriptPrefix=n.scriptPrefix,s.assetPrefix=n.assetPrefix,s.scriptsOrder=n.scriptsOrder,s.soundManager=new a2,s.lightmapper=mW,s.batchManager=lF,s.xr=Co,r.init(s),r}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Cl(t,e);var n=t.prototype;return n.createDevice=function(e,t){return t.graphicsDeviceOptions||(t.graphicsDeviceOptions={}),ef.browser&&navigator.xr&&(t.graphicsDeviceOptions.xrCompatible=true),t.graphicsDeviceOptions.alpha=t.graphicsDeviceOptions.alpha||false,new sV(e,t.graphicsDeviceOptions)},n.addComponentSystems=function(e){e.componentSystems=[yK,vY,gU,_P,_6,yo,yR,S8,xs,xL,SI,vi,yx,y5,gC,vS,Sd,Sy,SW,g6,gj,SJ,b_];},n.addResourceHandles=function(e){e.resourceHandlers=[bT,TF,TU,TV,E4,EJ,w6,wp,Ej,Tj,wi,E8,T4,EH,T2,ws,EV,T8,Ee,TY,wy,wu,wf,T0,Ek];},t}(mA);function Cc(e,t){return (Cc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ch=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var r;return (r=e.call(this)||this)._assets=new Set,r._loadingAssets=new Set,r._waitingAssets=new Set,r._loading=false,r._loaded=false,r._failed=[],r._registry=n,t.forEach(function(e){if(null!=pZ&&"undefined"!=typeof Symbol&&pZ[Symbol.hasInstance]?!!pZ[Symbol.hasInstance](e):i(e,pZ))e.registry||(e.registry=n),r._assets.add(e);else {var t=n.get(e);t?r._assets.add(t):r._waitForAsset(e);}}),r}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Cc(t,e);var n=t.prototype;return n.destroy=function(){var e=this;this._registry.off("load",this._onLoad),this._registry.off("error",this._onError),this._waitingAssets.forEach(function(t){e._registry.off("add:"+t,e._onAddAsset);}),this.off("progress"),this.off("load");},n._assetHasDependencies=function(e){var t;return "model"===e.type&&(null==(t=e.file)?void 0:t.url)&&e.file.url&&e.file.url.match(/.json$/g)},n.load=function(e,t){var n=this;if(!this._loading){this._loading=true,this._callback=e,this._scope=t,this._registry.on("load",this._onLoad,this),this._registry.on("error",this._onError,this);var i=false;this._assets.forEach(function(e){e.loaded||(i=true,n._assetHasDependencies(e)&&n._registry.loadFromUrl(e.file.url,e.type,function(t,i){if(t)return void n._onError(t,e);n._onLoad(e);}),n._loadingAssets.add(e),n._registry.add(e));}),this._loadingAssets.forEach(function(e){n._assetHasDependencies(e)||n._registry.load(e);}),i||0!==this._waitingAssets.size||this._loadingComplete();}},n.ready=function(e,t){ void 0===t&&(t=this),this._loaded?e.call(t,Array.from(this._assets)):this.once("load",function(n){e.call(t,n);});},n._loadingComplete=function(){this._loaded||(this._loaded=true,this._registry.off("load",this._onLoad,this),this._registry.off("error",this._onError,this),this._failed.length?(this._callback&&this._callback.call(this._scope,"Failed to load some assets",this._failed),this.fire("error",this._failed)):(this._callback&&this._callback.call(this._scope),this.fire("load",Array.from(this._assets))));},n._onLoad=function(e){var t=this;this._loadingAssets.has(e)&&(this.fire("progress",e),this._loadingAssets.delete(e)),0===this._loadingAssets.size&&setTimeout(function(){t._loadingComplete();},0);},n._onError=function(e,t){var n=this;this._loadingAssets.has(t)&&(this._failed.push(t),this._loadingAssets.delete(t)),0===this._loadingAssets.size&&setTimeout(function(){n._loadingComplete();},0);},n._onAddAsset=function(e){this._waitingAssets.delete(e),this._assets.add(e),e.loaded||(this._loadingAssets.add(e),this._registry.load(e));},n._waitForAsset=function(e){this._waitingAssets.add(e),this._registry.once("add:"+e,this._onAddAsset,this);},t}(ex);function Cf(e,t){return (Cf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Cd=function(){function e(e,t,n,i){this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=n,this.texture=new nO(e,{name:i,format:20,width:t,height:n,mipmaps:true,minFilter:5,magFilter:1,addressU:1,addressV:1,levels:[this.canvas]}),this.ctx=this.canvas.getContext("2d",{alpha:true});}var t=e.prototype;return t.destroy=function(){this.texture.destroy();},t.clear=function(e){var t=this.canvas,n=t.width,i=t.height;this.ctx.clearRect(0,0,n,i),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,n,i);},e}(),Cp=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return void 0===n&&(n={}),(i=e.call(this)||this).type="bitmap",i.app=t,i.intensity=0,i.fontWeight=n.fontWeight||"normal",i.fontSize=parseInt(n.fontSize,10),i.glyphSize=i.fontSize,i.fontName=n.fontName||"Arial",i.color=n.color||new eN(1,1,1),i.padding=n.padding||0,i.width=Math.min(4096,n.width||512),i.height=Math.min(4096,n.height||512),i.atlases=[],i.chars="",i.data={},i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Cf(t,e);var n,i=t.prototype;return i.createTextures=function(e){var t=this._normalizeCharsSet(e);if(t.length!==this.chars.length)return void this._renderAtlas(t);for(var n=0;n<t.length;n++)if(t[n]!==this.chars[n])return void this._renderAtlas(t)},i.updateTextures=function(e){for(var t=this._normalizeCharsSet(e),n=[],i=0;i<t.length;i++){var r=t[i];this.data.chars[r]||n.push(r);}n.length>0&&this._renderAtlas(this.chars.concat(n));},i.destroy=function(){this.atlases.forEach(function(e){return e.destroy()}),this.chars=null,this.color=null,this.data=null,this.fontName=null,this.fontSize=null,this.glyphSize=null,this.intensity=null,this.atlases=null,this.type=null,this.fontWeight=null;},i._colorToRgbString=function(e,t){var i=Math.round(255*e.r),r=Math.round(255*e.g),s=Math.round(255*e.b);return t?"rgba("+i+", "+r+", "+s+", "+e.a+")":"rgb("+i+", "+r+", "+s+")"},i.renderCharacter=function(e,t,n,i,r){e.fillStyle=r,e.fillText(t,n,i);},i._getAtlas=function(e){return e>=this.atlases.length&&(this.atlases[e]=new Cd(this.app.graphicsDevice,this.width,this.height,"font-atlas-"+this.fontName+"-"+e)),this.atlases[e]},i._renderAtlas=function(e){this.chars=e;var t=this.width,n=this.height,i=this._colorToRgbString(this.color,false),r=this.color.a;this.color.a=1/255;var s=this._colorToRgbString(this.color,true);this.color.a=r;var a=0,o=this._getAtlas(a++);o.clear(s),this.data=this._createJson(this.chars,this.fontName,t,n);for(var l=ev.getSymbols(this.chars.join("")),u=0,c=0,h={},f=0;f<l.length;f++){var d=l[f];h[d]=this._getTextMetrics(d),u=Math.max(u,h[d].height),c=Math.max(c,h[d].descent);}this.glyphSize=Math.max(this.glyphSize,u);for(var p=this.glyphSize+2*this.padding,m=this.glyphSize+2*this.padding,_=this.glyphSize/2+this.padding,v=m-c-this.padding,g=0,y=0,S=0;S<l.length;S++){var x=l[S],b=ev.getCodePoint(l[S]),T=this.fontSize;o.ctx.font=this.fontWeight+" "+T.toString()+"px "+this.fontName,o.ctx.textAlign="center",o.ctx.textBaseline="alphabetic";var E=o.ctx.measureText(x).width;E>T&&(T=this.fontSize*this.fontSize/E,o.ctx.font=this.fontWeight+" "+T.toString()+"px "+this.fontName,E=this.fontSize),this.renderCharacter(o.ctx,x,g+_,y+v,i);var w=this.padding+(this.glyphSize-E)/2,A=-this.padding+h[x].descent-c,C=E;this._addChar(this.data,x,b,g,y,p,m,w,A,C,a-1,t,n),(g+=p)+p>t&&(g=0,(y+=m)+m>n&&((o=this._getAtlas(a++)).clear(s),y=0));}this.atlases.splice(a).forEach(function(e){return e.destroy()}),this.atlases.forEach(function(e){return e.texture.upload()}),this.fire("render");},i._createJson=function(e,t,n,i){return {version:3,intensity:this.intensity,info:{face:t,width:n,height:i,maps:[{width:n,height:i}]},chars:{}}},i._addChar=function(e,t,n,i,r,s,a,o,l,u,c,h,f){e.info.maps.length<c+1&&e.info.maps.push({width:h,height:f});var d=this.fontSize/32;e.chars[t]={id:n,letter:t,x:i,y:r,width:s,height:a,xadvance:u/d,xoffset:o/d,yoffset:(l+this.padding)/d,scale:d,range:1,map:c,bounds:[0,0,s/d,a/d]};},i._normalizeCharsSet=function(e){var t=this.app.systems.element.getUnicodeConverter();t&&(e=t(e));for(var n={},i=ev.getSymbols(e),r=0;r<i.length;r++){var s=i[r];n[s]||(n[s]=s);}return Object.keys(n).sort()},i._getTextMetrics=function(e){var t=document.createElement("span");t.id="content-span",t.innerHTML=e;var n=document.createElement("div");n.id="content-block",n.style.display="inline-block",n.style.width="1px",n.style.height="0px";var i=document.createElement("div");i.appendChild(t),i.appendChild(n),i.style.font=this.fontSize+"px "+this.fontName,document.body.appendChild(i);var r=-1,s=-1,a=-1;try{n.style["vertical-align"]="baseline",r=n.offsetTop-t.offsetTop,n.style["vertical-align"]="bottom",s=(a=n.offsetTop-t.offsetTop)-r;}finally{document.body.removeChild(i);}return {ascent:r,descent:s,height:a}},n=[{key:"textures",get:function(){return this.atlases.map(function(e){return e.texture})}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);function Cm(e,t){return (Cm=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var C_=[],Cv=[[],[],[]],Cg=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t)||this).viewBindGroups=[],i.renderer=n,i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Cm(t,e);var n=t.prototype;return n.destroy=function(){this.viewBindGroups.forEach(function(e){e.defaultUniformBuffer.destroy(),e.destroy();}),this.viewBindGroups.length=0;},n.update=function(e,t,n,i){this.camera=e,this.scene=t,this.layers=n,this.mapping=i,t.clusteredLightingEnabled&&(this.emptyWorldClusters=this.renderer.worldClustersAllocator.empty);},n.execute=function(){for(var e=this.device,t=this.renderer,n=this.camera,i=this.scene,r=this.layers,s=this.mapping,a=this.renderTarget,o=i.layers.layerList,l=i.layers.subLayerEnabled,u=i.layers.subLayerList,c=0;c<o.length;c++){var h=o[c];if(!(r&&0>r.indexOf(h))&&h.enabled&&l[c]&&h.camerasSet.has(n.camera)){var f=u[c];h._clearDepthBuffer&&t.clear(n.camera,false,true,false);for(var d=h.meshInstances,p=0;p<d.length;p++){var m=d[p];m.pick&&m.transparent===f&&(C_.push(m),s.set(m.id,m));}C_.length>0&&(i.clusteredLightingEnabled&&this.emptyWorldClusters.activate(),t.setCameraUniforms(n.camera,a),e.supportsUniformBuffers&&t.setupViewUniformBuffers(this.viewBindGroups,t.viewUniformFormat,t.viewBindGroupFormat,null),t.renderForward(n.camera,a,C_,Cv,3,function(t){e.setBlendState(nj.NOBLEND);}),C_.length=0);}}},t}(s2),Cy=new Set,CS=new eY,Cx=function(){function e(e,t,n){var i=this;this.renderTarget=null,this.mapping=new Map,this.deviceValid=true,this.renderer=e.renderer,this.device=e.graphicsDevice,this.renderPass=new Cg(this.device,e.renderer),this.width=0,this.height=0,this.resize(t,n),this.device.on("destroy",function(){i.deviceValid=false;});}var t=e.prototype;return t.getSelection=function(e,t,n,i){ void 0===n&&(n=1),void 0===i&&(i=1);var r=this.device;if(r.isWebGPU)return [];t=this.renderTarget.height-(t+i);var s=this.sanitizeRect(e,t,n,i);r.setRenderTarget(this.renderTarget),r.updateBegin();var a=new Uint8Array(4*s.z*s.w);return r.readPixels(s.x,s.y,s.z,s.w,a),r.updateEnd(),this.decodePixels(a,this.mapping)},t.getSelectionAsync=function(e,t,n,i){var r,s=this;void 0===n&&(n=1),void 0===i&&(i=1),(null==(r=this.device)?void 0:r.isWebGL2)&&(t=this.renderTarget.height-(t+i));var a=this.sanitizeRect(e,t,n,i);return this.renderTarget.colorBuffer.read(a.x,a.y,a.z,a.w,{renderTarget:this.renderTarget,immediate:true}).then(function(e){return s.decodePixels(e,s.mapping)})},t.sanitizeRect=function(e,t,n,i){var r=this.renderTarget.width,s=this.renderTarget.height;return e=ek.clamp(Math.floor(e),0,r-1),t=ek.clamp(Math.floor(t),0,s-1),n=Math.min(n=Math.floor(Math.max(n,1)),r-e),i=Math.min(i=Math.floor(Math.max(i,1)),s-t),CS.set(e,t,n,i)},t.decodePixels=function(e,t){var n=[];if(this.deviceValid){for(var i=e.length,r=0;r<i;r+=4){var s=e[r+0],a=e[r+1],o=e[r+2],l=(e[r+3]<<24|s<<16|a<<8|o)>>>0;0xffffffff!==l&&Cy.add(t.get(l));}Cy.forEach(function(e){e&&n.push(e);}),Cy.clear();}return n},t.allocateRenderTarget=function(){var e=new nO(this.device,{format:7,width:this.width,height:this.height,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1,name:"pick"});this.renderTarget=new il({colorBuffer:e,depth:true});},t.releaseRenderTarget=function(){this.renderTarget&&(this.renderTarget.destroyTextureBuffers(),this.renderTarget.destroy(),this.renderTarget=null);},t.prepare=function(e,t,n){r=n,(null!=cX&&"undefined"!=typeof Symbol&&cX[Symbol.hasInstance]?!!cX[Symbol.hasInstance](r):i(r,cX))&&(n=[n]),this.renderTarget&&this.width===this.renderTarget.width&&this.height===this.renderTarget.height||(this.releaseRenderTarget(),this.allocateRenderTarget()),this.mapping.clear();var r,s=this.renderPass;s.init(this.renderTarget),s.colorOps.clearValue=eN.WHITE,s.colorOps.clear=true,s.depthStencilOps.clearDepth=true,s.update(e,t,n,this.mapping),s.render();},t.resize=function(e,t){this.width=Math.floor(e),this.height=Math.floor(t);},e}();function Cb(e,t){return (Cb=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var CT=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){return e.call(this,t,"scenesettings")||this}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Cb(t,e);var n=t.prototype;return n.load=function(e,t){EU.load(e,this.maxRetries,t);},n.open=function(e,t){return t.settings},t}(mn);function CE(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:true,configurable:true}}),t&&Cw(e,t);}function Cw(e,t){return (Cw=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var CA=new eW,CC=new eW,CP=new tn,CI=new tn,CL=new tn;CP.end=new eW,CI.end=new eW,CL.end=new eW;var CD=new eW,CM=new eW,CR=new eW,CO=new eW,Ck=new eW,CN=new eW,CF=new eW,CB=new eW,CU=new eW,Cz=new eW,CV=new eW,CG=new eW,CH=new eW,CW=new eW,Cj=new eW,CX=new eW,CY=new eW,Cq=new eW,CK=new eW,CZ=new eW,CQ=new eY;function CJ(e,t,n){return CV.cross(e,t).dot(n)}var C$=function(){function e(e,t,n){this.event=e,this.element=t,this.camera=n,this._stopPropagation=false;}return e.prototype.stopPropagation=function(){this._stopPropagation=true,this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation());},e}(),C0=function(e){function t(t,n,i,r,s,a,o){var l;return (l=e.call(this,t,n,i)||this).x=r,l.y=s,l.ctrlKey=t.ctrlKey||false,l.altKey=t.altKey||false,l.shiftKey=t.shiftKey||false,l.metaKey=t.metaKey||false,l.button=t.button,ax.isPointerLocked()?(l.dx=t.movementX||t.webkitMovementX||t.mozMovementX||0,l.dy=t.movementY||t.webkitMovementY||t.mozMovementY||0):(l.dx=r-a,l.dy=s-o),l.wheelDelta=0,"wheel"===t.type&&(t.deltaY>0?l.wheelDelta=1:t.deltaY<0&&(l.wheelDelta=-1)),l}return CE(t,e),t}(C$),C1=function(e){function t(t,n,i,r,s,a){var o;return (o=e.call(this,t,n,i)||this).touches=t.touches,o.changedTouches=t.changedTouches,o.x=r,o.y=s,o.touch=a,o}return CE(t,e),t}(C$),C2=function(e){function t(t,n,i,r){var s;return (s=e.call(this,t,n,i)||this).inputSource=r,s}return CE(t,e),t}(C$),C3=function(){function e(e,t){this._app=null,this._attached=false,this._target=null,this._enabled=true,this._lastX=0,this._lastY=0,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._touchstartHandler=this._handleTouchStart.bind(this),this._touchendHandler=this._handleTouchEnd.bind(this),this._touchcancelHandler=this._touchendHandler,this._touchmoveHandler=this._handleTouchMove.bind(this),this._sortHandler=this._sortElements.bind(this),this._elements=[],this._hoveredElement=null,this._pressedElement=null,this._touchedElements={},this._touchesForWhichTouchLeaveHasFired={},this._selectedElements={},this._selectedPressedElements={},this._useMouse=!t||false!==t.useMouse,this._useTouch=!t||false!==t.useTouch,this._useXr=!t||false!==t.useXr,this._selectEventsAttached=false,ef.touch&&(this._clickedEntities={}),this.attach(e);}var t,n=e.prototype;return n.attach=function(e){this._attached&&(this._attached=false,this.detach()),this._target=e,this._attached=true;var t=!!ef.passiveEvents&&{passive:true};this._useMouse&&(window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t)),this._useTouch&&ef.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,t),this._target.addEventListener("touchend",this._touchendHandler,false),this._target.addEventListener("touchmove",this._touchmoveHandler,false),this._target.addEventListener("touchcancel",this._touchcancelHandler,false)),this.attachSelectEvents();},n.attachSelectEvents=function(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=true,this.app.xr.on("start",this._onXrStart,this));},n.detach=function(){if(this._attached){this._attached=false;var e=!!ef.passiveEvents&&{passive:true};this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e)),this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,e),this._target.removeEventListener("touchend",this._touchendHandler,false),this._target.removeEventListener("touchmove",this._touchmoveHandler,false),this._target.removeEventListener("touchcancel",this._touchcancelHandler,false)),this._selectEventsAttached&&(this._selectEventsAttached=false,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)),this._target=null;}},n.addElement=function(e){ -1===this._elements.indexOf(e)&&this._elements.push(e);},n.removeElement=function(e){var t=this._elements.indexOf(e);-1!==t&&this._elements.splice(t,1);},n._handleUp=function(e){this._enabled&&(ax.isPointerLocked()||(this._calcMouseCoords(e),this._onElementMouseEvent("mouseup",e)));},n._handleDown=function(e){this._enabled&&(ax.isPointerLocked()||(this._calcMouseCoords(e),this._onElementMouseEvent("mousedown",e)));},n._handleMove=function(e){this._enabled&&(this._calcMouseCoords(e),this._onElementMouseEvent("mousemove",e),this._lastX=z,this._lastY=V);},n._handleWheel=function(e){this._enabled&&(this._calcMouseCoords(e),this._onElementMouseEvent("mousewheel",e));},n._determineTouchedElements=function(e){for(var t={},n=this.app.systems.camera.cameras,i=n.length-1;i>=0;i--){for(var r=n[i],s=0,a=e.changedTouches.length,o=0;o<a;o++){if(t[e.changedTouches[o].identifier]){s++;continue}var l=aV(e.changedTouches[o]),u=this._getTargetElementByCoords(r,l.x,l.y);u&&(s++,t[e.changedTouches[o].identifier]={element:u,camera:r,x:l.x,y:l.y});}if(s===a)break}return t},n._handleTouchStart=function(e){if(this._enabled){for(var t=this._determineTouchedElements(e),n=0,i=e.changedTouches.length;n<i;n++){var r=e.changedTouches[n],s=t[r.identifier],a=this._touchedElements[r.identifier];s&&(!a||s.element!==a.element)&&(this._fireEvent(e.type,new C1(e,s.element,s.camera,s.x,s.y,r)),this._touchesForWhichTouchLeaveHasFired[r.identifier]=false);}for(var o in t)this._touchedElements[o]=t[o];}},n._handleTouchEnd=function(e){if(this._enabled){var t=this.app.systems.camera.cameras;for(var n in this._clickedEntities)delete this._clickedEntities[n];for(var i=0,r=e.changedTouches.length;i<r;i++){var s=e.changedTouches[i],a=this._touchedElements[s.identifier];if(a){var o=a.element,l=a.camera,u=a.x,c=a.y;delete this._touchedElements[s.identifier],delete this._touchesForWhichTouchLeaveHasFired[s.identifier];for(var h=aV(s),f=t.length-1;f>=0;f--)this._getTargetElementByCoords(t[f],h.x,h.y)!==o||this._clickedEntities[o.entity.getGuid()]||(this._fireEvent("click",new C1(e,o,l,u,c,s)),this._clickedEntities[o.entity.getGuid()]=Date.now());this._fireEvent(e.type,new C1(e,o,l,u,c,s));}}}},n._handleTouchMove=function(e){if(e.preventDefault(),this._enabled)for(var t=this._determineTouchedElements(e),n=0,i=e.changedTouches.length;n<i;n++){var r=e.changedTouches[n],s=t[r.identifier],a=this._touchedElements[r.identifier];if(a){var o=aV(r);s&&s.element===a.element||this._touchesForWhichTouchLeaveHasFired[r.identifier]||(this._fireEvent("touchleave",new C1(e,a.element,a.camera,o.x,o.y,r)),this._touchesForWhichTouchLeaveHasFired[r.identifier]=true),this._fireEvent("touchmove",new C1(e,a.element,a.camera,o.x,o.y,r));}}},n._onElementMouseEvent=function(e,t){var n,i=null,r=this._hoveredElement;this._hoveredElement=null;for(var s=this.app.systems.camera.cameras,a=s.length-1;a>=0&&(n=s[a],!(i=this._getTargetElementByCoords(n,z,V)));a--);if(this._hoveredElement=i,("mousemove"===e||"mouseup"===e)&&this._pressedElement?this._fireEvent(e,new C0(t,this._pressedElement,n,z,V,this._lastX,this._lastY)):i&&(this._fireEvent(e,new C0(t,i,n,z,V,this._lastX,this._lastY)),"mousedown"===e&&(this._pressedElement=i)),r!==this._hoveredElement&&(r&&this._fireEvent("mouseleave",new C0(t,r,n,z,V,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new C0(t,this._hoveredElement,n,z,V,this._lastX,this._lastY))),"mouseup"===e&&this._pressedElement){if(this._pressedElement===this._hoveredElement){var o=this._hoveredElement.entity.getGuid(),l=!this._clickedEntities;if(this._clickedEntities){var u=this._clickedEntities[o]||0;l=Date.now()-u>300,delete this._clickedEntities[o];}l&&this._fireEvent("click",new C0(t,this._hoveredElement,n,z,V,this._lastX,this._lastY));}this._pressedElement=null;}},n._onXrStart=function(){this.app.xr.on("end",this._onXrEnd,this),this.app.xr.on("update",this._onXrUpdate,this),this.app.xr.input.on("selectstart",this._onSelectStart,this),this.app.xr.input.on("selectend",this._onSelectEnd,this),this.app.xr.input.on("remove",this._onXrInputRemove,this);},n._onXrEnd=function(){this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this);},n._onXrUpdate=function(){if(this._enabled)for(var e=this.app.xr.input.inputSources,t=0;t<e.length;t++)this._onElementSelectEvent("selectmove",e[t],null);},n._onXrInputRemove=function(e){var t=this._selectedElements[e.id];t&&(e._elementEntity=null,this._fireEvent("selectleave",new C2(null,t,null,e))),delete this._selectedElements[e.id],delete this._selectedPressedElements[e.id];},n._onSelectStart=function(e,t){this._enabled&&this._onElementSelectEvent("selectstart",e,t);},n._onSelectEnd=function(e,t){this._enabled&&this._onElementSelectEvent("selectend",e,t);},n._onElementSelectEvent=function(e,t,n){var i,r,s,a=this._selectedElements[t.id],o=this.app.systems.camera.cameras;if(t.elementInput){CL.set(t.getOrigin(),t.getDirection());for(var l=o.length-1;l>=0&&(s=o[l],!(i=this._getTargetElementByRay(CL,s)));l--);}t._elementEntity=i||null,i?(this._selectedElements[t.id]=i,r=i):delete this._selectedElements[t.id],a!==r&&(a&&this._fireEvent("selectleave",new C2(n,a,s,t)),r&&this._fireEvent("selectenter",new C2(n,r,s,t)));var u=this._selectedPressedElements[t.id];"selectmove"===e&&u&&this._fireEvent("selectmove",new C2(n,u,s,t)),"selectstart"===e&&(this._selectedPressedElements[t.id]=r,r&&this._fireEvent("selectstart",new C2(n,r,s,t))),!t.elementInput&&u&&(delete this._selectedPressedElements[t.id],a&&this._fireEvent("selectend",new C2(n,u,s,t))),"selectend"===e&&t.elementInput&&(delete this._selectedPressedElements[t.id],u&&this._fireEvent("selectend",new C2(n,u,s,t)),u&&u===a&&this._fireEvent("click",new C2(n,u,s,t)));},n._fireEvent=function(e,t){for(var n=t.element;n.fire(e,t),!t._stopPropagation&&n.entity.parent&&(n=n.entity.parent.element););},n._calcMouseCoords=function(e){var t=this._target.getBoundingClientRect(),n=Math.floor(t.left),i=Math.floor(t.top);z=e.clientX-n,V=e.clientY-i;},n._sortElements=function(e,t){var n=this.app.scene.layers.sortTransparentLayers(e.layers,t.layers);return 0!==n?n:e.screen&&!t.screen?-1:!e.screen&&t.screen?1:e.screen||t.screen?e.screen.screen.screenSpace&&!t.screen.screen.screenSpace?-1:t.screen.screen.screenSpace&&!e.screen.screen.screenSpace?1:t.drawOrder-e.drawOrder:0},n._getTargetElementByCoords=function(e,t,n){var i=this._calculateRayScreen(t,n,e,CP)?CP:null,r=this._calculateRay3d(t,n,e,CI)?CI:null;return this._getTargetElement(e,i,r)},n._getTargetElementByRay=function(e,t){CP.origin.copy(e.origin),CP.direction.copy(e.direction),CP.end.copy(CP.direction).mulScalar(2*t.farClip).add(CP.origin);var n=t.worldToScreen(CP.origin,CA),i=this._calculateRayScreen(n.x,n.y,t,CI)?CI:null;return this._getTargetElement(t,i,CP)},n._getTargetElement=function(e,t,n){var i=null,r=1/0;this._elements.sort(this._sortHandler);for(var s=0,a=this._elements.length;s<a;s++){var o=this._elements[s];if(o.layers.some(function(t){return e.layersSet.has(t)}))if(o.screen&&o.screen.screen.screenSpace){if(!t)continue;if(this._checkElement(t,o,true)>=0){i=o;break}}else {if(!n)continue;var l=this._checkElement(n,o,false);if(l>=0&&(l<r&&(i=o,r=l),o.screen)){i=o;break}}}return i},n._calculateRayScreen=function(e,t,n,i){var r=this.app.graphicsDevice.width,s=this.app.graphicsDevice.height,a=n.rect.z*r,o=n.rect.w*s,l=n.rect.x*r,u=(1-n.rect.y)*s,c=u-o,h=e*r/this._target.clientWidth,f=t*s/this._target.clientHeight;return h>=l&&h<=l+a&&f<=u&&f>=c&&(h=r*(h-l)/a,f=s*(f-c)/o,f=s-f,i.origin.set(h,f,1),i.direction.set(0,0,-1),i.end.copy(i.direction).mulScalar(2).add(i.origin),true)},n._calculateRay3d=function(e,t,n,i){var r=this._target.clientWidth,s=this._target.clientHeight,a=n.rect.z*r,o=n.rect.w*s,l=n.rect.x*r,u=(1-n.rect.y)*s,c=u-o,h=e,f=t;return e>=l&&e<=l+a&&t<=u&&f>=c&&(h=r*(h-l)/a,f=s*(f-c)/o,n.screenToWorld(h,f,n.nearClip,CA),n.screenToWorld(h,f,n.farClip,CC),i.origin.copy(CA),i.direction.set(0,0,-1),i.end.copy(CC),true)},n._checkElement=function(t,n,i){if(n.maskedBy&&0>this._checkElement(t,n.maskedBy.element,i))return -1;var r=i?e.calculateScaleToScreen(n):e.calculateScaleToWorld(n),s=e.buildHitCorners(n,i?n.screenCorners:n.worldCorners,r);return function(e,t,n){CD.sub2(t,e),CM.sub2(n[0],e),CR.sub2(n[1],e),CO.sub2(n[2],e),CN.cross(CO,CD);var i,r,s=CM.dot(CN);if(s>=0){if((i=-CR.dot(CN))<0||(r=CJ(CD,CR,CM))<0)return -1;var a=1/(i+s+r);CF.copy(n[0]).mulScalar(i*a),CB.copy(n[1]).mulScalar(s*a),CU.copy(n[2]).mulScalar(r*a),Cz.copy(CF).add(CB).add(CU);}else {if(Ck.sub2(n[3],e),(i=Ck.dot(CN))<0||(r=CJ(CD,CM,Ck))<0)return -1;var o=1/(i+(s=-s)+r);CF.copy(n[0]).mulScalar(i*o),CB.copy(n[3]).mulScalar(s*o),CU.copy(n[2]).mulScalar(r*o),Cz.copy(CF).add(CB).add(CU);}return 1e-8>CD.sub2(n[0],n[2]).lengthSq()||1e-8>CD.sub2(n[1],n[3]).lengthSq()?-1:Cz.sub(e).lengthSq()}(t.origin,t.end,s)},e.buildHitCorners=function(e,t,n){var i=t;if(e.entity&&e.entity.button){var r=e.entity.button.hitPadding||CQ;CH.copy(e.entity.up),CW.copy(CH).mulScalar(-1),CX.copy(e.entity.right),Cj.copy(CX).mulScalar(-1),CH.mulScalar(r.w*n.y),CW.mulScalar(r.y*n.y),CX.mulScalar(r.z*n.x),Cj.mulScalar(r.x*n.x),CY.copy(i[0]).add(CW).add(Cj),Cq.copy(i[1]).add(CW).add(CX),CK.copy(i[2]).add(CH).add(CX),CZ.copy(i[3]).add(CH).add(Cj),i=[CY,Cq,CK,CZ];}if(n.x<0){var s=i[2].x,a=i[0].x;i[0].x=s,i[1].x=a,i[2].x=a,i[3].x=s;}if(n.y<0){var o=i[2].y,l=i[0].y;i[0].y=o,i[1].y=o,i[2].y=l,i[3].y=l;}if(n.z<0){var u=i[2].x,c=i[2].y,h=i[2].z;i[2].x=i[0].x,i[2].y=i[0].y,i[2].z=i[0].z,i[0].x=u,i[0].y=c,i[0].z=h;}return i},e.calculateScaleToScreen=function(e){var t=e.entity,n=e.screen.screen.scale;for(CG.set(n,n,n);t&&!t.screen;)CG.mul(t.getLocalScale()),t=t.parent;return CG},e.calculateScaleToWorld=function(e){var t=e.entity;for(CG.set(1,1,1);t;)CG.mul(t.getLocalScale()),t=t.parent;return CG},t=[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e;}},{key:"app",get:function(){return this._app||A},set:function(e){this._app=e;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();eX.prototype.scale=eX.prototype.mulScalar,eW.prototype.scale=eW.prototype.mulScalar,eY.prototype.scale=eY.prototype.mulScalar;var C4=new eY;Object.defineProperties(il.prototype,{_glFrameBuffer:{get:function(){return this.impl._glFrameBuffer},set:function(e){}}}),Object.defineProperty(n6,"defaultInstancingFormat",{get:function(){return null}}),Object.defineProperties(nO.prototype,{rgbm:{get:function(){return this.type===t1},set:function(e){this.type=e?t1:t0;}},swizzleGGGR:{get:function(){return this.type===t4},set:function(e){this.type=e?t4:t0;}},_glTexture:{get:function(){return this.impl._glTexture}}}),Object.defineProperty(ia.prototype,"boneLimit",{get:function(){return 1024}}),Object.defineProperty(ia.prototype,"webgl2",{get:function(){return this.isWebGL2}}),Object.defineProperty(ia.prototype,"textureFloatHighPrecision",{get:function(){return  true}}),Object.defineProperty(ia.prototype,"extBlendMinmax",{get:function(){return  true}}),Object.defineProperty(ia.prototype,"extTextureHalfFloat",{get:function(){return  true}}),Object.defineProperty(ia.prototype,"extTextureLod",{get:function(){return  true}}),Object.defineProperty(ia.prototype,"textureHalfFloatFilterable",{get:function(){return  true}}),Object.defineProperty(ia.prototype,"supportsMrt",{get:function(){return  true}}),Object.defineProperty(ia.prototype,"supportsVolumeTextures",{get:function(){return  true}}),Object.defineProperty(ia.prototype,"supportsInstancing",{get:function(){return  true}}),Object.defineProperty(ia.prototype,"textureHalfFloatUpdatable",{get:function(){return  true}}),Object.defineProperty(ia.prototype,"extTextureFloat",{get:function(){return  true}}),Object.defineProperty(ia.prototype,"extStandardDerivatives",{get:function(){return  true}}),nj.DEFAULT=Object.freeze(new nj);var C5=new nj,C8=new nq;ia.prototype.setBlendFunction=function(e,t){var n=this.blendState;C5.copy(n),C5.setColorBlend(n.colorOp,e,t),C5.setAlphaBlend(n.alphaOp,e,t),this.setBlendState(C5);},ia.prototype.setBlendFunctionSeparate=function(e,t,n,i){var r=this.blendState;C5.copy(r),C5.setColorBlend(r.colorOp,e,t),C5.setAlphaBlend(r.alphaOp,n,i),this.setBlendState(C5);},ia.prototype.setBlendEquation=function(e){var t=this.blendState;C5.copy(t),C5.setColorBlend(e,t.colorSrcFactor,t.colorDstFactor),C5.setAlphaBlend(e,t.alphaSrcFactor,t.alphaDstFactor),this.setBlendState(C5);},ia.prototype.setBlendEquationSeparate=function(e,t){var n=this.blendState;C5.copy(n),C5.setColorBlend(e,n.colorSrcFactor,n.colorDstFactor),C5.setAlphaBlend(t,n.alphaSrcFactor,n.alphaDstFactor),this.setBlendState(C5);},ia.prototype.setColorWrite=function(e,t,n,i){var r=this.blendState;C5.copy(r),C5.setColorWrite(e,t,n,i),this.setBlendState(C5);},ia.prototype.getBlending=function(){return this.blendState.blend},ia.prototype.setBlending=function(e){C5.copy(this.blendState),C5.blend=e,this.setBlendState(C5);},ia.prototype.setDepthWrite=function(e){C8.copy(this.depthState),C8.write=e,this.setDepthState(C8);},ia.prototype.setDepthFunc=function(e){C8.copy(this.depthState),C8.func=e,this.setDepthState(C8);},ia.prototype.setDepthTest=function(e){C8.copy(this.depthState),C8.test=e,this.setDepthState(C8);},ia.prototype.getCullMode=function(){return this.cullMode};var C6=new Proxy({},{get:function(e,t){return o0.get(A.graphicsDevice,nn).get(t)},set:function(e,t,n){return o0.get(A.graphicsDevice,nn).set(t,n),true}});function C9(e,t,n){Object.defineProperty(e.prototype,t,{set:function(e){},get:function(){}});}function C7(e,t){Object.defineProperty(dw.prototype,t,{get:function(){return this[e]},set:function(t){this[e]=t;}});}function Pe(e){Object.defineProperty(dw.prototype,e,{get:function(){return  true},set:function(e){}});}function Pt(e,t){"pass"!==e&&Object.defineProperty(dr.prototype,e,{get:function(){return this.litOptions[t||e]},set:function(n){this.litOptions[t||e]=n;}});}Object.defineProperty(fB.prototype,"defaultMaterial",{get:function(){return lg(A.graphicsDevice)}}),Object.defineProperty(fB.prototype,"fogColor",{set:function(e){this.fog.color=e;},get:function(){return this.fog.color}}),Object.defineProperty(fB.prototype,"fogEnd",{set:function(e){this.fog.end=e;},get:function(){return this.fog.end}}),Object.defineProperty(fB.prototype,"fogStart",{set:function(e){this.fog.start=e;},get:function(){return this.fog.start}}),Object.defineProperty(fB.prototype,"fogDensity",{set:function(e){this.fog.density=e;},get:function(){return this.fog.density}}),Object.defineProperty(fB.prototype,"toneMapping",{set:function(e){},get:function(){}}),Object.defineProperty(fB.prototype,"gammaCorrection",{set:function(e){},get:function(){}}),Object.defineProperty(fB.prototype,"rendering",{set:function(e){},get:function(){}}),Object.defineProperty(cZ.prototype,"_meshInstances",{get:function(){return null}}),Object.defineProperty(fB.prototype,"drawCalls",{get:function(){return null}}),["128","64","32","16","8","4"].forEach(function(e,t){Object.defineProperty(fB.prototype,"skyboxPrefiltered"+e,{get:function(){return this._prefilteredCubemaps[t]},set:function(e){this._prefilteredCubemaps[t]=e,this.updateShaders=true;}});}),Object.defineProperty(fB.prototype,"models",{get:function(){return this._models||(this._models=[]),this._models}}),C9(cX,"renderTarget"),C9(cX,"onPreCull"),C9(cX,"onPreRender"),C9(cX,"onPreRenderOpaque"),C9(cX,"onPreRenderTransparent"),C9(cX,"onPostCull"),C9(cX,"onPostRender"),C9(cX,"onPostRenderOpaque"),C9(cX,"onPostRenderTransparent"),C9(cX,"onDrawCall"),C9(cX,"layerReference"),C9(S2,"onPreCull"),C9(S2,"onPostCull"),C9(S2,"onPreRender"),C9(S2,"onPostRender"),C9(S2,"onPreRenderLayer"),C9(S2,"onPostRenderLayer"),cz.prototype.renderComposition=function(e){A.renderComposition(e);},lL.prototype.syncAabb=function(){},hn.prototype.getTarget=function(e){return this.targets[e]},us.prototype.getChildren=function(){return this.children},us.prototype.getName=function(){return this.name},us.prototype.getPath=function(){return this.path},us.prototype.getRoot=function(){return this.root},us.prototype.getParent=function(){return this.parent},us.prototype.setName=function(e){this.name=e;},Object.defineProperty(uV.prototype,"shader",{set:function(e){},get:function(){return null}}),Object.defineProperty(uV.prototype,"blend",{set:function(e){this.blendState.blend=e;},get:function(){return this.blendState.blend}}),Object.defineProperty(dw.prototype,"shininess",{get:function(){return 100*this.gloss},set:function(e){this.gloss=.01*e;}}),Object.defineProperty(dw.prototype,"useGammaTonemap",{get:function(){return this.useTonemap},set:function(e){this.useTonemap=e;}}),Object.defineProperty(dw.prototype,"anisotropy",{get:function(){var e=Math.sign(Math.cos(this.anisotropyRotation*ek.DEG_TO_RAD*2));return this.anisotropyIntensity*e},set:function(e){this.anisotropyIntensity=Math.abs(e),e>=0?this.anisotropyRotation=0:this.anisotropyRotation=90;}}),Pe("sheenTint"),Pe("diffuseTint"),Pe("emissiveTint"),Pe("ambientTint"),C7("specularTint","specularMapTint"),C7("aoVertexColor","aoMapVertexColor"),C7("diffuseVertexColor","diffuseMapVertexColor"),C7("specularVertexColor","specularMapVertexColor"),C7("emissiveVertexColor","emissiveMapVertexColor"),C7("metalnessVertexColor","metalnessMapVertexColor"),C7("glossVertexColor","glossMapVertexColor"),C7("opacityVertexColor","opacityMapVertexColor"),C7("lightVertexColor","lightMapVertexColor"),C7("sheenGloss","sheenGlossiess"),C7("clearCoatGloss","clearCostGlossiness"),Pt("refraction","useRefraction");var Pn=Object.getOwnPropertyNames(new f2);for(var Pi in Pn)Pt(Pn[Pi]);p2.prototype.getAssetById=function(e){return this.get(e)},Object.defineProperty(AO.prototype,"ray",{get:function(){return this._rayLocal}}),Object.defineProperty(AO.prototype,"position",{get:function(){return this._localPosition}}),Object.defineProperty(AO.prototype,"rotation",{get:function(){return this._localRotation}}),Object.defineProperty(C3.prototype,"wheel",{get:function(){return -2*this.wheelDelta}}),Object.defineProperty(ay.prototype,"wheel",{get:function(){return -2*this.wheelDelta}}),mA.prototype.isFullscreen=function(){return !!document.fullscreenElement},mA.prototype.enableFullscreen=function(e,t,n){e=e||this.graphicsDevice.canvas;var i=function(){t(),document.removeEventListener("fullscreenchange",i);},r=function(){n(),document.removeEventListener("fullscreenerror",r);};t&&document.addEventListener("fullscreenchange",i,false),n&&document.addEventListener("fullscreenerror",r,false),e.requestFullscreen?e.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):n();},mA.prototype.disableFullscreen=function(e){var t=function(){e(),document.removeEventListener("fullscreenchange",t);};e&&document.addEventListener("fullscreenchange",t,false),document.exitFullscreen();},mA.prototype.getSceneUrl=function(e){var t=this.scenes.find(e);return t?t.url:null},mA.prototype.loadScene=function(e,t){this.scenes.loadScene(e,t);},mA.prototype.loadSceneHierarchy=function(e,t){this.scenes.loadSceneHierarchy(e,t);},mA.prototype.loadSceneSettings=function(e,t){this.scenes.loadSceneSettings(e,t);},yi.prototype.setVisible=function(e){this.enabled=e;},Object.defineProperty(yz.prototype,"bodyType",{get:function(){return this.type},set:function(e){this.type=e;}}),yz.prototype.syncBodyToEntity=function(){this._updateDynamic();},yK.prototype.setGravity=function(){1==arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2]);};var Pr=function(){function e(e){this._frameIndex=0,this._frameTimings=[],this._timings=[],this._prevTimings=[],this.unitsName="ms",this.decimalPlaces=1,this.enabled=true,e.on("frameupdate",this.begin.bind(this,"update")),e.on("framerender",this.mark.bind(this,"render")),e.on("frameend",this.mark.bind(this,"other"));}var t,n=e.prototype;return n.begin=function(e){if(this.enabled){this._frameIndex<this._frameTimings.length&&this._frameTimings.splice(this._frameIndex);var t=this._prevTimings;this._prevTimings=this._timings,this._timings=this._frameTimings,this._frameTimings=t,this._frameIndex=0,this.mark(e);}},n.mark=function(e){if(this.enabled){var t=eL();if(this._frameIndex>0){var n=this._frameTimings[this._frameIndex-1];n[1]=t-n[1];}else if(this._timings.length>0){var i=this._timings[this._timings.length-1];i[1]=t-i[1];}if(this._frameIndex>=this._frameTimings.length)this._frameTimings.push([e,t]);else {var r=this._frameTimings[this._frameIndex];r[0]=e,r[1]=t;}this._frameIndex++;}},t=[{key:"timings",get:function(){return this._timings.slice(0,-1).map(function(e){return e[1]})}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),Ps=function(){var e;function t(e){this.device=e,e.gpuProfiler.enabled=true,this.enabled=true,this.unitsName="ms",this.decimalPlaces=1,this._timings=[];}return e=[{key:"timings",get:function(){return this._timings[0]=this.device.gpuProfiler._frameTime,this._timings}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}(),Pa=function(){var e;function t(e,t,n,i,r){var s=this;this.app=e,this.values=[],this.statNames=t,this.statNames.length>3&&(this.statNames.length=3),this.unitsName=i,this.decimalPlaces=n,this.multiplier=r||1,e.on("frameupdate",function(e){for(var t,n,i=0;i<s.statNames.length;i++)s.values[i]=(t=s.statNames[i],n=s.app.stats,t.split(".").reduce(function(e,t){return e?e[t]:null},n||s)*s.multiplier);});}return e=[{key:"timings",get:function(){return this.values}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}(),Po=function(){function e(e,t,n,i,r){this.app=t,this.name=e,this.device=t.graphicsDevice,this.timer=r,this.watermark=n,this.enabled=false,this.textRefreshRate=i,this.avgTotal=0,this.avgTimer=0,this.avgCount=0,this.timingText="",this.texture=null,this.yOffset=0,this.cursor=0,this.sample=new Uint8ClampedArray(4),this.sample.set([0,0,0,255]),this.counter=0,this.app.on("frameupdate",this.update,this);}var t=e.prototype;return t.destroy=function(){this.app.off("frameupdate",this.update,this);},t.loseContext=function(){this.timer&&"function"==typeof this.timer.loseContext&&this.timer.loseContext();},t.update=function(e){var t=this.timer.timings,n=t.reduce(function(e,t){return e+t},0);if(this.avgTotal+=n,this.avgTimer+=e,this.avgCount++,this.avgTimer>this.textRefreshRate&&(this.timingText=(this.avgTotal/this.avgCount).toFixed(this.timer.decimalPlaces),this.avgTimer=0,this.avgTotal=0,this.avgCount=0),this.enabled){for(var i=0,r=1.5*this.watermark,s=0;s<t.length;++s)i+=Math.floor(t[s]/r*255),this.sample[s]=i;this.sample[3]=this.watermark/r*255,this.texture.lock().set(this.sample,(this.cursor+this.yOffset*this.texture.width)*4),this.texture.unlock(),this.cursor++,this.cursor===this.texture.width&&(this.cursor=0);}},t.render=function(e,t,n,i,r){e.quad(t+i,n,-i,r,this.enabled?this.cursor:0,this.enabled?.5+this.yOffset:this.texture.height-1,-i,0,this.texture,0);},e}(),Pl=function(){function e(e,t){var n=function(e){e.font='10px "Lucida Console", Monaco, monospace',e.textAlign="left",e.textBaseline="alphabetic";},i=document.createElement("canvas"),r=i.getContext("2d",{alpha:true});n(r);var s=new Map,a=5,o=5;t.forEach(function(e){var t=r.measureText(e),n=Math.ceil(-t.actualBoundingBoxLeft),i=Math.ceil(t.actualBoundingBoxRight),l=Math.ceil(t.actualBoundingBoxAscent),u=Math.ceil(t.actualBoundingBoxDescent),c=n+i;a+c+5>=512&&(a=5,o+=16),s.set(e,{l:n,r:i,a:l,d:u,w:c,h:l+u,x:a,y:o}),a+=c+5;}),i.width=512,i.height=ek.nextPowerOfTwo(o+16+5),n(r),r.fillStyle="rgb(0, 0, 0)",r.fillRect(0,0,i.width,i.height),s.forEach(function(e,t){r.fillStyle="."===t||1===t.length&&t.charCodeAt(0)>=48&&57>=t.charCodeAt(0)?"rgb(255, 255, 255)":"rgb(170, 170, 170)",r.fillText(t,e.x-e.l,e.y+e.a);}),this.placements=s;for(var l=r.getImageData(0,0,i.width,i.height).data,u=0;u<l.length;u+=4)l[u+3]=l[u+0],l[u+0]=255,l[u+1]=255,l[u+2]=255;this.texture=new nO(e,{name:"mini-stats-word-atlas",width:i.width,height:i.height,mipmaps:false,minFilter:0,magFilter:0,levels:[l]});}var t=e.prototype;return t.destroy=function(){this.texture.destroy(),this.texture=null;},t.render=function(e,t,n,i){var r=this.placements.get(t);return r?(e.quad(n+r.l-1,i-r.d+1,r.w+2,r.h+2,r.x-1,this.texture.height-r.y-r.h-1,void 0,void 0,this.texture,1),r.w):0},e}(),Pu=function(){function e(e,t){ void 0===t&&(t=512);for(var n=new n6(e,[{semantic:tT,components:3,type:6},{semantic:tL,components:4,type:6}]),i=new Uint16Array(6*t),r=0;r<t;++r)i[6*r+0]=4*r,i[6*r+1]=4*r+1,i[6*r+2]=4*r+2,i[6*r+3]=4*r,i[6*r+4]=4*r+2,i[6*r+5]=4*r+3;this.device=e,this.buffer=new n1(e,n,4*t,{usage:2}),this.data=new Float32Array(this.buffer.numBytes/4),this.indexBuffer=new s$(e,1,6*t,0,i),this.prim={type:4,indexed:true,base:0,baseVertex:0,count:0},this.quads=0,this.mesh=new l_(e),this.mesh.vertexBuffer=this.buffer,this.mesh.indexBuffer[0]=this.indexBuffer,this.mesh.primitive=[this.prim];var s=new h3({uniqueName:"MiniStats",vertexGLSL:"\n	attribute vec3 vertex_position;\n	attribute vec4 vertex_texCoord0;\n	varying vec4 uv0;\n	varying float wordFlag;\n	void main(void) {\n		gl_Position = vec4(vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);\n		uv0 = vertex_texCoord0;\n		wordFlag = vertex_position.z;\n	}\n",fragmentGLSL:"\n	varying vec4 uv0;\n	varying float wordFlag;\n	uniform vec4 clr;\n	uniform sampler2D graphTex;\n	uniform sampler2D wordsTex;\n	void main (void) {\n		vec4 graphSample = texture2D(graphTex, uv0.xy);\n		vec4 graph;\n		if (uv0.w < graphSample.r)\n			graph = vec4(0.7, 0.2, 0.2, 1.0);\n		else if (uv0.w < graphSample.g)\n			graph = vec4(0.2, 0.7, 0.2, 1.0);\n		else if (uv0.w < graphSample.b)\n			graph = vec4(0.2, 0.2, 0.7, 1.0);\n		else\n			graph = vec4(0.0, 0.0, 0.0, 1.0 - 0.25 * sin(uv0.w * 3.14159));\n		vec4 words = texture2D(wordsTex, vec2(uv0.x, 1.0 - uv0.y));\n		gl_FragColor = mix(graph, words, wordFlag) * clr;\n	}\n",vertexWGSL:"\n	attribute vertex_position: vec3f;\n	attribute vertex_texCoord0: vec4f;\n	varying uv0: vec4f;\n	varying wordFlag: f32;\n	@vertex fn vertexMain(input : VertexInput) -> VertexOutput {\n		var output : VertexOutput;\n		output.position = vec4(input.vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);\n		output.uv0 = input.vertex_texCoord0;\n		output.wordFlag = input.vertex_position.z;\n		return output;\n	}\n",fragmentWGSL:"\n	varying uv0: vec4f;\n	varying wordFlag: f32;\n	uniform clr: vec4f;\n	var graphTex : texture_2d<f32>;\n	var graphTex_sampler : sampler;\n	var wordsTex : texture_2d<f32>;\n	var wordsTex_sampler : sampler;\n	@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n		var uv0: vec4f = input.uv0;\n		var graphSample: vec4f = textureSample(graphTex, graphTex_sampler, uv0.xy);\n		var graph: vec4f;\n		if (uv0.w < graphSample.r) {\n			graph = vec4f(0.7, 0.2, 0.2, 1.0);\n		} else if (uv0.w < graphSample.g) {\n			graph = vec4f(0.2, 0.7, 0.2, 1.0);\n		} else if (uv0.w < graphSample.b) {\n			graph = vec4f(0.2, 0.2, 0.7, 1.0);\n		} else {\n			graph = vec4f(0.0, 0.0, 0.0, 1.0 - 0.25 * sin(uv0.w * 3.14159));\n		}\n		var words: vec4f = textureSample(wordsTex, wordsTex_sampler, vec2f(uv0.x, 1.0 - uv0.y));\n		var output: FragmentOutput;\n		output.color = mix(graph, words, input.wordFlag) * uniform.clr;\n		return output;\n	}\n",attributes:{vertex_position:tT,vertex_texCoord0:tL}});this.material=s,s.cull=0,s.depthState=nq.NODEPTH,s.blendState=new nj(true,0,6,8,0,1,1),s.update(),this.meshInstance=new lL(this.mesh,s,new us("MiniStatsMesh")),this.uniforms={clr:new Float32Array(4)},this.targetSize={width:e.width,height:e.height};}var t=e.prototype;return t.quad=function(e,t,n,i,r,s,a,o,l,u){ void 0===u&&(u=0);var c=this.targetSize.width,h=this.targetSize.height,f=e/c,d=t/h,p=(e+n)/c,m=(t+i)/h,_=l.width,v=l.height,g=r/_,y=s/v,S=(r+(null!=a?a:n))/_,x=(s+(null!=o?o:i))/v;this.data.set([f,d,u,g,y,0,0,p,d,u,S,y,1,0,p,m,u,S,x,1,1,f,m,u,g,x,0,1],28*this.quads),this.quads++,this.prim.count+=6;},t.startFrame=function(){this.quads=0,this.prim.count=0,this.targetSize.width=this.device.canvas.scrollWidth,this.targetSize.height=this.device.canvas.scrollHeight;},t.render=function(e,t,n,i,r,s){this.buffer.setData(this.data.buffer),this.uniforms.clr.set(r,0),this.material.setParameter("clr",this.uniforms.clr),this.material.setParameter("graphTex",n),this.material.setParameter("wordsTex",i),e.drawMeshInstance(this.meshInstance,t);},e}(),Pc=function(){function e(t,n){var i=this,r=t.graphicsDevice;n=n||e.getDefaultOptions(),this.initGraphs(t,r,n);var s=new Set(["","ms","0","1","2","3","4","5","6","7","8","9","."].concat(this.graphs.map(function(e){return e.name})).concat(n.stats?n.stats.map(function(e){return e.unitsName}):[]).filter(function(e){return !!e}));this.wordAtlas=new Pl(r,s),this.sizes=n.sizes,this._activeSizeIndex=n.startSizeIndex;var a=document.createElement("div");a.setAttribute("id","mini-stats"),a.style.cssText="position:fixed;bottom:0;left:0;background:transparent;",document.body.appendChild(a),a.addEventListener("mouseenter",function(e){i.opacity=1;}),a.addEventListener("mouseleave",function(e){i.opacity=.7;}),a.addEventListener("click",function(e){e.preventDefault(),i._enabled&&(i.activeSizeIndex=(i.activeSizeIndex+1)%i.sizes.length,i.resize(i.sizes[i.activeSizeIndex].width,i.sizes[i.activeSizeIndex].height,i.sizes[i.activeSizeIndex].graphs));}),r.on("resizecanvas",this.updateDiv,this),r.on("losecontext",this.loseContext,this),t.on("postrender",this.postRender,this),this.app=t,this.drawLayer=t.scene.layers.getLayerById(4),this.device=r,this.render2d=new Pu(r),this.div=a,this.width=0,this.height=0,this.gspacing=2,this.clr=[1,1,1,.5],this._enabled=true,this.activeSizeIndex=this._activeSizeIndex;}var t,n=e.prototype;return n.destroy=function(){this.device.off("resizecanvas",this.updateDiv,this),this.device.off("losecontext",this.loseContext,this),this.app.off("postrender",this.postRender,this),this.graphs.forEach(function(e){return e.destroy()}),this.wordAtlas.destroy(),this.texture.destroy();},n.initGraphs=function(e,t,n){var i=this;if(this.graphs=[],n.cpu.enabled){var r=new Pr(e),s=new Po("CPU",e,n.cpu.watermark,n.textRefreshRate,r);this.graphs.push(s);}if(n.gpu.enabled){var a=new Ps(t),o=new Po("GPU",e,n.gpu.watermark,n.textRefreshRate,a);this.graphs.push(o);}n.stats&&n.stats.forEach(function(t){var r=new Pa(e,t.stats,t.decimalPlaces,t.unitsName,t.multiplier),s=new Po(t.name,e,t.watermark,n.textRefreshRate,r);i.graphs.push(s);});var l=n.sizes.reduce(function(e,t){return t.width>e?t.width:e},0);this.texture=new nO(t,{name:"mini-stats-graph-texture",width:ek.nextPowerOfTwo(l),height:ek.nextPowerOfTwo(this.graphs.length),mipmaps:false,minFilter:0,magFilter:0,addressU:0,addressV:0}),this.graphs.forEach(function(e,t){e.texture=i.texture,e.yOffset=t;});},n.render=function(){var e=this.graphs,t=this.wordAtlas,n=this.render2d,i=this.width,r=this.height,s=this.gspacing;n.startFrame();for(var a=0;a<e.length;++a){var o=e[a],l=a*(r+s);o.render(n,0,l,i,r);var u=1;l+=r-13,u+=t.render(n,o.name,u,l)+10;for(var c=o.timingText,h=0;h<c.length;++h)u+=t.render(n,c[h],u,l);o.timer.unitsName&&(u+=3,t.render(n,o.timer.unitsName,u,l));}n.render(this.app,this.drawLayer,this.texture,this.wordAtlas.texture,this.clr,r);},n.resize=function(e,t,n){for(var i=this.graphs,r=0;r<i.length;++r)i[r].enabled=n;this.width=e,this.height=t,this.updateDiv();},n.updateDiv=function(){var e=this.device.canvas.getBoundingClientRect();this.div.style.left=""+e.left+"px",this.div.style.bottom=""+(window.innerHeight-e.bottom)+"px",this.div.style.width=""+this.width+"px",this.div.style.height=""+this.overallHeight+"px";},n.loseContext=function(){this.graphs.forEach(function(e){return e.loseContext()});},n.postRender=function(){this._enabled&&this.render();},e.getDefaultOptions=function(){return {sizes:[{width:100,height:16,spacing:0,graphs:false},{width:128,height:32,spacing:2,graphs:true},{width:256,height:64,spacing:2,graphs:true}],startSizeIndex:0,textRefreshRate:500,cpu:{enabled:true,watermark:33},gpu:{enabled:true,watermark:33},stats:[{name:"Frame",stats:["frame.ms"],decimalPlaces:1,unitsName:"ms",watermark:33},{name:"DrawCalls",stats:["drawCalls.total"],watermark:1e3}]}},t=[{key:"activeSizeIndex",get:function(){return this._activeSizeIndex},set:function(e){this._activeSizeIndex=e,this.gspacing=this.sizes[e].spacing,this.resize(this.sizes[e].width,this.sizes[e].height,this.sizes[e].graphs);}},{key:"opacity",get:function(){return this.clr[3]},set:function(e){this.clr[3]=e;}},{key:"overallHeight",get:function(){var e=this.graphs,t=this.gspacing;return this.height*e.length+t*(e.length-1)}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(e!==this._enabled){this._enabled=e;for(var t=0;t<this.graphs.length;++t)this.graphs[t].enabled=e,this.graphs[t].timer.enabled=e;}}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function Ph(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}var Pf=new Float32Array(2),Pd=new eN,Pp=function(){function e(e,t,n){var i=this;void 0===n&&(n=-1),this.app=e,this.renderingLayer=null!=t?t:e.scene.layers.getLayerByName("Immediate"),this.rt=this.createRenderTarget("OutlineTexture",1,1,true),this.outlineCameraEntity=new my("OutlineCamera"),this.outlineCameraEntity.addComponent("camera",{layers:[this.renderingLayer.id],priority:n,clearColor:new eN(0,0,0,0),renderTarget:this.rt}),this.outlineShaderPass=this.outlineCameraEntity.camera.setShaderPass("OutlineShaderPass"),this.postRender=function(e){i.outlineCameraEntity.camera===e&&i.onPostRender();},e.scene.on("postrender",this.postRender),this.app.root.addChild(this.outlineCameraEntity),this.tempRt=this.createRenderTarget("OutlineTempTexture",1,1,false),this.blendState=new nj(true,0,6,8);var r=this.app.graphicsDevice;this.shaderExtend=o8.createShader(r,{uniqueName:"OutlineExtendShader",attributes:{vertex_position:tT},vertexGLSL:o0.get(r,nn).get("fullscreenQuadVS"),fragmentGLSL:"\n	varying vec2 vUv0;\n	uniform vec2 uOffset;\n	uniform float uSrcMultiplier;\n	uniform sampler2D source;\n	void main(void)\n	{\n		vec4 pixel;\n		vec4 texel = texture2D(source, vUv0);\n		vec4 firstTexel = texel;\n		float diff = texel.a * uSrcMultiplier;\n		pixel = texture2D(source, vUv0 + uOffset * -2.0);\n		texel = max(texel, pixel);\n		diff = max(diff, length(firstTexel.rgb - pixel.rgb));\n		pixel = texture2D(source, vUv0 + uOffset * -1.0);\n		texel = max(texel, pixel);\n		diff = max(diff, length(firstTexel.rgb - pixel.rgb));\n		pixel = texture2D(source, vUv0 + uOffset * 1.0);\n		texel = max(texel, pixel);\n		diff = max(diff, length(firstTexel.rgb - pixel.rgb));\n		pixel = texture2D(source, vUv0 + uOffset * 2.0);\n		texel = max(texel, pixel);\n		diff = max(diff, length(firstTexel.rgb - pixel.rgb));\n	   gl_FragColor = vec4(texel.rgb, min(diff, 1.0));\n	}\n"}),this.shaderBlend=o8.createShader(r,{uniqueName:"OutlineBlendShader",attributes:{vertex_position:tT},vertexChunk:"fullscreenQuadVS",fragmentChunk:"outputTex2DPS"}),this.quadRenderer=new lt(this.shaderBlend),this.whiteTex=new nO(r,{name:"OutlineWhiteTexture",width:1,height:1,format:20,mipmaps:false}),this.whiteTex.lock().set(new Uint8Array([255,255,255,255])),this.whiteTex.unlock();}var t=e.prototype;return t.destroy=function(){var e;this.whiteTex.destroy(),this.whiteTex=null,this.outlineCameraEntity.destroy(),this.outlineCameraEntity=null,this.rt.destroyTextureBuffers(),this.rt.destroy(),this.rt=null,this.tempRt.destroyTextureBuffers(),this.tempRt.destroy(),this.tempRt=null,this.app.scene.off("postrender",this.postRender),null==(e=this.quadRenderer)||e.destroy(),this.quadRenderer=null;},t.getMeshInstances=function(e,t){var n=[];return e&&((t?e.findComponents("render"):e.render?[e.render]:[]).forEach(function(e){e.meshInstances&&n.push.apply(n,[].concat(e.meshInstances));}),(t?e.findComponents("model"):e.model?[e.model]:[]).forEach(function(e){e.meshInstances&&n.push.apply(n,[].concat(e.meshInstances));})),n},t.addEntity=function(e,t,n){var i=this;void 0===n&&(n=true);var r=this.getMeshInstances(e,n);r.forEach(function(e){if(Ph(e.material,dw)){var n=i.outlineShaderPass;e.material.onUpdateShader=function(e){if(e.pass===n){var t=new dr;return t.defines=e.defines,t.opacityMap=e.opacityMap,t.opacityMapUv=e.opacityMapUv,t.opacityMapChannel=e.opacityMapChannel,t.opacityMapTransform=e.opacityMapTransform,t.opacityVertexColor=e.opacityVertexColor,t.opacityVertexColorChannel=e.opacityVertexColorChannel,t.litOptions.vertexColors=e.litOptions.vertexColors,t.litOptions.alphaTest=e.litOptions.alphaTest,t.litOptions.skin=e.litOptions.skin,t.litOptions.batch=e.litOptions.batch,t.litOptions.useInstancing=e.litOptions.useInstancing,t.litOptions.useMorphPosition=e.litOptions.useMorphPosition,t.litOptions.useMorphNormal=e.litOptions.useMorphNormal,t.litOptions.useMorphTextureBasedInt=e.litOptions.useMorphTextureBasedInt,t.litOptions.opacityFadesSpecular=e.litOptions.opacityFadesSpecular,t}return e},Pd.linear(t);var r=new Float32Array([Pd.r,Pd.g,Pd.b]);e.setParameter("material_emissive",r,1<<i.outlineShaderPass),e.setParameter("texture_emissiveMap",i.whiteTex,1<<i.outlineShaderPass);}}),this.renderingLayer.addMeshInstances(r,true);},t.removeEntity=function(e,t){ void 0===t&&(t=true);var n=this.getMeshInstances(e,t);this.renderingLayer.removeMeshInstances(n),n.forEach(function(e){Ph(e.material,dw)&&(e.material.onUpdateShader=null,e.deleteParameter("material_emissive"));});},t.removeAllEntities=function(){this.renderingLayer.clearMeshInstances();},t.blendOutlines=function(){var e=this.app.graphicsDevice;e.scope.resolve("source").setValue(this.rt.colorBuffer),e.setDepthState(nq.NODEPTH),e.setCullMode(0),e.setBlendState(this.blendState),this.quadRenderer.render();},t.onPostRender=function(){var e=this.app.graphicsDevice,t=e.scope.resolve("uOffset"),n=e.scope.resolve("source"),i=e.scope.resolve("uSrcMultiplier"),r=this.rt,s=this.tempRt,a=this.shaderExtend,o=r.width,l=r.height;Pf[0]=1/o/2,Pf[1]=0,t.setValue(Pf),n.setValue(r.colorBuffer),i.setValue(0),ls(e,s,a),Pf[0]=0,Pf[1]=1/l/2,t.setValue(Pf),n.setValue(s.colorBuffer),i.setValue(1),ls(e,r,a);},t.createRenderTarget=function(e,t,n,i){return new il({colorBuffer:new nO(this.app.graphicsDevice,{name:e,width:t,height:n,format:20,mipmaps:false,addressU:1,addressV:1,minFilter:5,magFilter:1}),depth:i,flipY:this.app.graphicsDevice.isWebGPU})},t.updateRenderTarget=function(e){var t,n,i,r,s=null!=(i=null==(t=e.renderTarget)?void 0:t.width)?i:this.app.graphicsDevice.width,a=null!=(r=null==(n=e.renderTarget)?void 0:n.height)?r:this.app.graphicsDevice.height,o=this.outlineCameraEntity.camera;o.renderTarget&&o.renderTarget.width===s&&o.renderTarget.height===a||(this.rt.resize(s,a),this.tempRt.resize(s,a));},t.frameUpdate=function(e,t,n){var i=this,r=e.camera;this.updateRenderTarget(r);var s=this.app.scene.on("prerender:layer",function(e,a,o){r===e&&o===n&&a===t&&(i.blendOutlines(),s.off());});this.outlineCameraEntity.setLocalPosition(e.getPosition()),this.outlineCameraEntity.setLocalRotation(e.getRotation());var a=this.outlineCameraEntity.camera;a.projection=r.projection,a.horizontalFov=r.horizontalFov,a.fov=r.fov,a.orthoHeight=r.orthoHeight,a.nearClip=r.nearClip,a.farClip=r.farClip;},e}();function Pm(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}var P_=function(){function e(){}var t=e.prototype;return t.textureToCanvas=function(e,t){ void 0===t&&(t={});var n=e.getSource();if("undefined"!=typeof HTMLImageElement&&Pm(n,HTMLImageElement)||"undefined"!=typeof HTMLCanvasElement&&Pm(n,HTMLCanvasElement)||"undefined"!=typeof OffscreenCanvas&&Pm(n,OffscreenCanvas)||"undefined"!=typeof ImageBitmap&&Pm(n,ImageBitmap)){var i=this.calcTextureSize(n.width,n.height,t.maxTextureSize),r=i.width,s=i.height,a=document.createElement("canvas");a.width=r,a.height=s;var o=a.getContext("2d");if(null===o)return Promise.resolve(void 0);if(o.drawImage(n,0,0,a.width,a.height),t.color){for(var l=t.color,u=l.r,c=l.g,h=l.b,f=o.getImageData(0,0,r,s),d=f.data,p=0;p<d.length;p+=4)d[p+0]=d[p+0]*u,d[p+1]=d[p+1]*c,d[p+2]=d[p+2]*h;o.putImageData(f,0,0);}return Promise.resolve(a)}var m=e.device,_=this.calcTextureSize(e.width,e.height,t.maxTextureSize),v=_.width,g=_.height,y=new nO(m,{name:"ExtractedTexture",width:v,height:g,format:t_(e.format)?7:e.format,cubemap:false,mipmaps:false,minFilter:1,magFilter:1,addressU:1,addressV:1}),S=new il({colorBuffer:y,depth:false}),x=o8.createShader(m,{uniqueName:"ShaderCoreExporterBlit",attributes:{vertex_position:tT},vertexChunk:"fullscreenQuadVS",fragmentChunk:"outputTex2DPS"});return m.scope.resolve("source").setValue(e),m.setBlendState(nj.NOBLEND),ls(m,S,x),y.read(0,0,v,g,{renderTarget:S,immediate:true}).then(function(e){y.destroy(),S.destroy();var t=new Uint8ClampedArray(v*g*4);t.set(e);var n=new ImageData(t,v,g),i=document.createElement("canvas");i.width=v,i.height=g;var r=i.getContext("2d");return r?(r.putImageData(n,0,0),Promise.resolve(i)):Promise.resolve(void 0)})},t.calcTextureSize=function(e,t,n){if(n){var i=Math.min(n/Math.max(e,t),1);e=Math.round(e*i),t=Math.round(t*i);}return {width:e,height:t}},e}(),Pv=Uint8Array,Pg=Uint16Array,Py=Int32Array,PS=new Pv([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Px=new Pv([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Pb=new Pv([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),PT=function(e,t){for(var n=new Pg(31),i=0;i<31;++i)n[i]=t+=1<<e[i-1];for(var r=new Py(n[30]),i=1;i<30;++i)for(var s=n[i];s<n[i+1];++s)r[s]=s-n[i]<<5|i;return {b:n,r:r}},PE=PT(PS,2),Pw=PE.b,PA=PE.r;Pw[28]=258,PA[258]=28;for(var PC=PT(Px,0).r,PP=new Pg(32768),PI=0;PI<32768;++PI){var PL=(43690&PI)>>1|(21845&PI)<<1;PL=(61680&(PL=(52428&PL)>>2|(13107&PL)<<2))>>4|(3855&PL)<<4,PP[PI]=((65280&PL)>>8|(255&PL)<<8)>>1;}for(var PD=function(e,t,n){for(var i,r=e.length,s=0,a=new Pg(t);s<r;++s)e[s]&&++a[e[s]-1];var o=new Pg(t);for(s=1;s<t;++s)o[s]=o[s-1]+a[s-1]<<1;if(n){i=new Pg(1<<t);var l=15-t;for(s=0;s<r;++s)if(e[s])for(var u=s<<4|e[s],c=t-e[s],h=o[e[s]-1]++<<c,f=h|(1<<c)-1;h<=f;++h)i[PP[h]>>l]=u;}else for(s=0,i=new Pg(r);s<r;++s)e[s]&&(i[s]=PP[o[e[s]-1]++]>>15-e[s]);return i},PM=new Pv(288),PI=0;PI<144;++PI)PM[PI]=8;for(var PI=144;PI<256;++PI)PM[PI]=9;for(var PI=256;PI<280;++PI)PM[PI]=7;for(var PI=280;PI<288;++PI)PM[PI]=8;for(var PR=new Pv(32),PI=0;PI<32;++PI)PR[PI]=5;var PO=PD(PM,9,0);PD(PM,9,1);var Pk=PD(PR,5,0);PD(PR,5,1);var PN=function(e){return (e+7)/8|0},PF=function(e,t,n){return (null==n||n>e.length)&&(n=e.length),new Pv(e.subarray(t,n))},PB=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],PU=function(e,t,n){var i=Error(t||PB[e]);if(i.code=e,Error.captureStackTrace&&Error.captureStackTrace(i,PU),!n)throw i;return i},Pz=function(e,t,n){n<<=7&t;var i=t/8|0;e[i]|=n,e[i+1]|=n>>8;},PV=function(e,t,n){n<<=7&t;var i=t/8|0;e[i]|=n,e[i+1]|=n>>8,e[i+2]|=n>>16;},PG=function(e,t){for(var n=[],i=0;i<e.length;++i)e[i]&&n.push({s:i,f:e[i]});var r=n.length,s=n.slice();if(!r)return {t:PK,l:0};if(1==r){var a=new Pv(n[0].s+1);return a[n[0].s]=1,{t:a,l:1}}n.sort(function(e,t){return e.f-t.f}),n.push({s:-1,f:25001});var o=n[0],l=n[1],u=0,c=1,h=2;for(n[0]={s:-1,f:o.f+l.f,l:o,r:l};c!=r-1;)o=n[n[u].f<n[h].f?u++:h++],l=n[u!=c&&n[u].f<n[h].f?u++:h++],n[c++]={s:-1,f:o.f+l.f,l:o,r:l};for(var f=s[0].s,i=1;i<r;++i)s[i].s>f&&(f=s[i].s);var d=new Pg(f+1),p=PH(n[c-1],d,0);if(p>t){var i=0,m=0,_=p-t,v=1<<_;for(s.sort(function(e,t){return d[t.s]-d[e.s]||e.f-t.f});i<r;++i){var g=s[i].s;if(d[g]>t)m+=v-(1<<p-d[g]),d[g]=t;else break}for(m>>=_;m>0;){var y=s[i].s;d[y]<t?m-=1<<t-d[y]++-1:++i;}for(;i>=0&&m;--i){var S=s[i].s;d[S]==t&&(--d[S],++m);}p=t;}return {t:new Pv(d),l:p}},PH=function(e,t,n){return -1==e.s?Math.max(PH(e.l,t,n+1),PH(e.r,t,n+1)):t[e.s]=n},PW=function(e){for(var t=e.length;t&&!e[--t];);for(var n=new Pg(++t),i=0,r=e[0],s=1,a=function(e){n[i++]=e;},o=1;o<=t;++o)if(e[o]==r&&o!=t)++s;else {if(!r&&s>2){for(;s>138;s-=138)a(32754);s>2&&(a(s>10?s-11<<5|28690:s-3<<5|12305),s=0);}else if(s>3){for(a(r),--s;s>6;s-=6)a(8304);s>2&&(a(s-3<<5|8208),s=0);}for(;s--;)a(r);s=1,r=e[o];}return {c:n.subarray(0,i),n:t}},Pj=function(e,t){for(var n=0,i=0;i<t.length;++i)n+=e[i]*t[i];return n},PX=function(e,t,n){var i=n.length,r=PN(t+2);e[r]=255&i,e[r+1]=i>>8,e[r+2]=255^e[r],e[r+3]=255^e[r+1];for(var s=0;s<i;++s)e[r+s+4]=n[s];return (r+4+i)*8},PY=function(e,t,n,i,r,s,a,o,l,u,c){Pz(t,c++,n),++r[256];for(var h,f,d,p,m=PG(r,15),_=m.t,v=m.l,g=PG(s,15),y=g.t,S=g.l,x=PW(_),b=x.c,T=x.n,E=PW(y),w=E.c,A=E.n,C=new Pg(19),P=0;P<b.length;++P)++C[31&b[P]];for(var P=0;P<w.length;++P)++C[31&w[P]];for(var I=PG(C,7),L=I.t,D=I.l,M=19;M>4&&!L[Pb[M-1]];--M);var R=u+5<<3,O=Pj(r,PM)+Pj(s,PR)+a,k=Pj(r,_)+Pj(s,y)+a+14+3*M+Pj(C,L)+2*C[16]+3*C[17]+7*C[18];if(l>=0&&R<=O&&R<=k)return PX(t,c,e.subarray(l,l+u));if(Pz(t,c,1+(k<O)),c+=2,k<O){h=PD(_,v,0),f=_,d=PD(y,S,0),p=y;var N=PD(L,D,0);Pz(t,c,T-257),Pz(t,c+5,A-1),Pz(t,c+10,M-4),c+=14;for(var P=0;P<M;++P)Pz(t,c+3*P,L[Pb[P]]);c+=3*M;for(var F=[b,w],B=0;B<2;++B)for(var U=F[B],P=0;P<U.length;++P){var z=31&U[P];Pz(t,c,N[z]),c+=L[z],z>15&&(Pz(t,c,U[P]>>5&127),c+=U[P]>>12);}}else h=PO,f=PM,d=Pk,p=PR;for(var P=0;P<o;++P){var V=i[P];if(V>255){var z=V>>18&31;PV(t,c,h[z+257]),c+=f[z+257],z>7&&(Pz(t,c,V>>23&31),c+=PS[z]);var G=31&V;PV(t,c,d[G]),c+=p[G],G>3&&(PV(t,c,V>>5&8191),c+=Px[G]);}else PV(t,c,h[V]),c+=f[V];}return PV(t,c,h[256]),c+f[256]},Pq=new Py([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),PK=new Pv(0),PZ=function(e,t,n,i,r,s){var a=s.z||e.length,o=new Pv(i+a+5*(1+Math.ceil(a/7e3))+r),l=o.subarray(i,o.length-r),u=s.l,c=7&(s.r||0);if(t){c&&(l[0]=s.r>>3);for(var h=Pq[t-1],f=h>>13,d=8191&h,p=(1<<n)-1,m=s.p||new Pg(32768),_=s.h||new Pg(p+1),v=Math.ceil(n/3),g=2*v,y=function(t){return (e[t]^e[t+1]<<v^e[t+2]<<g)&p},S=new Py(25e3),x=new Pg(288),b=new Pg(32),T=0,E=0,w=s.i||0,A=0,C=s.w||0,P=0;w+2<a;++w){var I=y(w),L=32767&w,D=_[I];if(m[L]=D,_[I]=L,C<=w){var M=a-w;if((T>7e3||A>24576)&&(M>423||!u)){c=PY(e,l,0,S,x,b,E,A,P,w-P,c),A=T=E=0,P=w;for(var R=0;R<286;++R)x[R]=0;for(var R=0;R<30;++R)b[R]=0;}var O=2,k=0,N=d,F=L-D&32767;if(M>2&&I==y(w-F))for(var B=Math.min(f,M)-1,U=Math.min(32767,w),z=Math.min(258,M);F<=U&&--N&&L!=D;){if(e[w+O]==e[w+O-F]){for(var V=0;V<z&&e[w+V]==e[w+V-F];++V);if(V>O){if(O=V,k=F,V>B)break;for(var G=Math.min(F,V-2),H=0,R=0;R<G;++R){var W=w-F+R&32767,j=m[W],X=W-j&32767;X>H&&(H=X,D=W);}}}D=m[L=D],F+=L-D&32767;}if(k){S[A++]=0x10000000|PA[O]<<18|PC[k];var Y=31&PA[O],q=31&PC[k];E+=PS[Y]+Px[q],++x[257+Y],++b[q],C=w+O,++T;}else S[A++]=e[w],++x[e[w]];}}for(w=Math.max(w,C);w<a;++w)S[A++]=e[w],++x[e[w]];c=PY(e,l,u,S,x,b,E,A,P,w-P,c),u||(s.r=7&c|l[c/8|0]<<3,c-=7,s.h=_,s.p=m,s.i=w,s.w=C);}else {for(var w=s.w||0;w<a+u;w+=65535){var K=w+65535;K>=a&&(l[c/8|0]=u,K=a),c=PX(l,c+1,e.subarray(w,K));}s.i=a;}return PF(o,0,i+PN(c)+r)},PQ=function(){for(var e=new Int32Array(256),t=0;t<256;++t){for(var n=t,i=9;--i;)n=(1&n&&-306674912)^n>>>1;e[t]=n;}return e}(),PJ=function(){var e=-1;return {p:function(t){for(var n=e,i=0;i<t.length;++i)n=PQ[255&n^t[i]]^n>>>8;e=n;},d:function(){return ~e}}},P$=function(e,t,n,i,r){if(!r&&(r={l:1},t.dictionary)){var s=t.dictionary.subarray(-32768),a=new Pv(s.length+e.length);a.set(s),a.set(e,s.length),e=a,r.w=s.length;}return PZ(e,null==t.level?6:t.level,null==t.mem?r.l?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):20:12+t.mem,n,i,r)},P0=function(e,t){var n={};for(var i in e)n[i]=e[i];for(var i in t)n[i]=t[i];return n},P1=function(e,t,n){for(;n;++t)e[t]=n,n>>>=8;},P2=function(e,t,n,r){for(var s in e){var a,o=e[s],l=t+s,u=r;(Array.isArray(o)&&(u=P0(r,o[1]),o=o[0]),a=o,null!=Pv&&"undefined"!=typeof Symbol&&Pv[Symbol.hasInstance]?!!Pv[Symbol.hasInstance](a):i(a,Pv))?n[l]=[o,u]:(n[l+="/"]=[new Pv(0),u],P2(o,l,n,r));}},P3="undefined"!=typeof TextEncoder&&new TextEncoder,P4="undefined"!=typeof TextDecoder&&new TextDecoder;try{P4.decode(PK,{stream:!0});}catch(e){}function P5(e,t){if(P3)return P3.encode(e);for(var n,i=e.length,r=new Pv(e.length+(e.length>>1)),s=0,a=function(e){r[s++]=e;},n=0;n<i;++n){if(s+5>r.length){var o=new Pv(s+8+(i-n<<1));o.set(r),r=o;}var l=e.charCodeAt(n);l<128||t?a(l):(l<2048?a(192|l>>6):(l>55295&&l<57344?(a(240|(l=65536+(1047552&l)|1023&e.charCodeAt(++n))>>18),a(128|l>>12&63)):a(224|l>>12),a(128|l>>6&63)),a(128|63&l));}return PF(r,0,s)}var P8=function(e){var t=0;if(e)for(var n in e){var i=e[n].length;i>65535&&PU(9),t+=i+4;}return t},P6=function(e,t,n,i,r,s,a,o){var l=i.length,u=n.extra,c=o&&o.length,h=P8(u);P1(e,t,null!=a?0x2014b50:0x4034b50),t+=4,null!=a&&(e[t++]=20,e[t++]=n.os),e[t]=20,t+=2,e[t++]=n.flag<<1|(s<0&&8),e[t++]=r&&8,e[t++]=255&n.compression,e[t++]=n.compression>>8;var f=new Date(null==n.mtime?Date.now():n.mtime),d=f.getFullYear()-1980;if((d<0||d>119)&&PU(10),P1(e,t,d<<25|f.getMonth()+1<<21|f.getDate()<<16|f.getHours()<<11|f.getMinutes()<<5|f.getSeconds()>>1),t+=4,-1!=s&&(P1(e,t,n.crc),P1(e,t+4,s<0?-s-2:s),P1(e,t+8,n.size)),P1(e,t+12,l),P1(e,t+14,h),t+=16,null!=a&&(P1(e,t,c),P1(e,t+6,n.attrs),P1(e,t+10,a),t+=14),e.set(i,t),t+=l,h)for(var p in u){var m=u[p],_=m.length;P1(e,t,+p),P1(e,t+2,_),e.set(m,t+4),t+=4+_;}return c&&(e.set(o,t),t+=c),t},P9=function(e,t,n,i,r){P1(e,t,0x6054b50),P1(e,t+8,n),P1(e,t+10,n),P1(e,t+12,i),P1(e,t+16,r);};function P7(e,t){return (P7=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ie="root",It=function(e,t,n){return "                    "+e+" inputs:"+t+" = "+n},In=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){return e.apply(this,arguments)||this}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&P7(t,e);var n=t.prototype;return n.init=function(){this.meshMap=new Map,this.textureMap=new Map,this.materialMap=new Map,this.materials=[],this.files={},this.nodeNames=new Set;},n.done=function(){this.meshMap=null,this.textureMap=null,this.materialMap=null,this.materials=null,this.files=null,this.nodeNames=null;},n.build=function(e,t){var n,i=this;void 0===t&&(t={}),this.init(),this.addFile(null,Ie);var r=[];e&&e.findComponents("render").forEach(function(e){r.push.apply(r,[].concat(e.meshInstances));});var s="";r.forEach(function(e){s+=i.buildMeshInstance(e);}),s+='\ndef "Materials"\n{\n    '+this.materials.join("\n")+"\n}\n",this.addFile(null,Ie,"",s);for(var a={maxTextureSize:t.maxTextureSize},o=Array.from(this.textureMap.keys()),l=[],u=0;u<o.length;u++)n=this,function(e){var t=o[e];l.push(n.textureToCanvas(t,a).then(function(e){return e?new Promise(function(t){return e.toBlob(t,"image/png",1)}).then(function(e){return e.arrayBuffer()}):new Promise(function(e){return e(null)})}));}(u);return Promise.all(l).then(function(e){e.forEach(function(e,t){var n=o[t],r=i.getTextureFileIds(n);i.files[r.fileName]=new Uint8Array(e);}),i.alignFiles();var t=function(e,t){t||(t={});var n={},i=[];P2(e,"",n,t);var r=0,s=0;for(var a in n){var o=n[a],l=o[0],u=o[1],c=8*(0!=u.level),h=P5(a),f=h.length,d=u.comment,p=d&&P5(d),m=p&&p.length,_=P8(u.extra);f>65535&&PU(11);var v=c?P$(l,u||{},0,0):l,g=v.length,y=PJ();y.p(l),i.push(P0(u,{size:l.length,crc:y.d(),c:v,f:h,m:p,u:f!=a.length||p&&d.length!=m,o:r,compression:c})),r+=30+f+_+g,s+=76+2*(f+_)+(m||0)+g;}for(var S=new Pv(s+22),x=r,b=s-r,T=0;T<i.length;++T){var h=i[T];P6(S,h.o,h,h.f,h.u,h.c.length);var E=30+h.f.length+P8(h.extra);S.set(h.c,h.o+E),P6(S,r,h,h.f,h.u,h.c.length,h.o,h.m),r+=16+E+(h.m?h.m.length:0);}return P9(S,r,i.length,b,x),S}(i.files,{level:0});return i.done(),t})},n.alignFiles=function(){var e=0;for(var t in this.files){var n=this.files[t],i=63&(e+=34+t.length);if(4!==i){var r=new Uint8Array(64-i);this.files[t]=[n,{extra:{12345:r}}];}e=n.length;}},n.getFileIds=function(e,t,n,i){ void 0===i&&(i="usda");var r=(e?""+e+"/":"")+t+"."+i;return {name:t,fileName:r,refName:"@./"+r+"@</"+n+">"}},n.getTextureFileIds=function(e){return this.getFileIds("texture","Texture_"+e.id,"Texture","png")},n.addFile=function(e,t,n,i){ void 0===n&&(n=""),void 0===i&&(i="");var r=null;i&&(r=P5(i='#usda 1.0\n(\n    customLayerData = {\n        string creator = "PlayCanvas UsdzExporter"\n    }\n    metersPerUnit = 1\n    upAxis = "Y"\n)\n\n'+i));var s=this.getFileIds(e,t,n);return this.files[s.fileName]=r,s.refName},n.getMaterialRef=function(e){var t=this.materialMap.get(e);return t||(t=this.buildMaterial(e),this.materialMap.set(e,t)),t},n.getMeshRef=function(e){var t=this.meshMap.get(e);return t||(t=this.buildMesh(e),this.meshMap.set(e,t)),t},n.buildArray2=function(e){for(var t=[],n=e.length,i=0;i<n;i+=2)t.push("("+e[i]+", "+(1-e[i+1])+")");return t.join(", ")},n.buildArray3=function(e){for(var t=[],n=e.length,i=0;i<n;i+=3)t.push("("+e[i]+", "+e[i+1]+", "+e[i+2]+")");return t.join(", ")},n.buildMat4=function(e){for(var t=e.data,n=[],i=0;i<16;i+=4)n.push("("+t[i]+", "+t[i+1]+", "+t[i+2]+", "+t[i+3]+")");return "( "+n.join(", ")+" )"},n.buildMaterial=function(e){var t=this,n="Material_"+e.id,i="/Materials/"+n,r=function(e){return "<"+i+e+">"},s=[],a=[],o=function(n,i,o,l,u,c,h){ void 0===c&&(c=false),void 0===h&&(h=false);var f=e[n];if(f){var d=t.getTextureFileIds(f);t.textureMap.set(f,d.refName);var p=e[""+n+"Channel"]||"rgb",m=r("/"+d.name+"_"+u+".outputs:"+p);s.push(It(o,""+l+".connect",m)),c&&e.alphaTest;var _=e[""+n+"Tiling"],v=e[""+n+"Offset"],g=e[""+n+"Rotation"],y=1===e[""+n+"Uv"]?"st1":"st",S=h&&i?i:eN.WHITE;a.push('\n                def Shader "Transform2d_'+u+'" (\n                    sdrMetadata = {\n                        string role = "math"\n                    }\n                )\n                {\n                    uniform token info:id = "UsdTransform2d"\n                    float2 inputs:in.connect = '+r("/uvReader_"+y+".outputs:result")+"\n                    float inputs:rotation = "+g+"\n                    float2 inputs:scale = ("+_.x+", "+_.y+")\n                    float2 inputs:translation = ("+v.x+", "+v.y+')\n                    float2 outputs:result\n                }\n\n                def Shader "Texture_'+f.id+"_"+u+'"\n                {\n                    uniform token info:id = "UsdUVTexture"\n                    asset inputs:file = @'+d.fileName+"@\n                    float2 inputs:st.connect = "+r("/Transform2d_"+u+".outputs:result")+'\n                    token inputs:wrapS = "repeat"\n                    token inputs:wrapT = "repeat"\n                    float4 inputs:scale = ('+S.r+", "+S.g+", "+S.b+", "+S.a+")\n                    float outputs:r\n                    float outputs:g\n                    float outputs:b\n                    float3 outputs:rgb\n                    float outputs:a\n                }\n            ");}else if(i){var x="float"===o?""+i:"("+i.r+", "+i.g+", "+i.b+")";s.push(It(o,l,x));}};o("diffuseMap",e.diffuse,"color3f","diffuseColor","diffuse",false,true),(e.transparent||e.alphaTest>0)&&o("opacityMap",e.opacity,"float","opacity","opacity",true),o("normalMap",null,"normal3f","normal","normal"),o("emissiveMap",e.emissive,"color3f","emissiveColor","emissive",false,true),o("aoMap",null,"float","occlusion","occlusion"),o("metalnessMap",e.metalness,"float","metallic","metallic"),o("glossMap",e.gloss,"float","roughness","roughness");var l='\n            def Material "'+n+'"\n            {\n                def Shader "PreviewSurface"\n                {\n                    uniform token info:id = "UsdPreviewSurface"\n'+s.join("\n")+"\n                    int inputs:useSpecularWorkflow = 0\n                    token outputs:surface\n                }\n\n                token outputs:surface.connect = "+r("/PreviewSurface.outputs:surface")+'\n\n                def Shader "uvReader_st"\n                {\n                    uniform token info:id = "UsdPrimvarReader_float2"\n                    token inputs:varname = "st"\n                    float2 inputs:fallback = (0.0, 0.0)\n                    float2 outputs:result\n                }\n\n                def Shader "uvReader_st1"\n                {\n                    uniform token info:id = "UsdPrimvarReader_float2"\n                    token inputs:varname = "st1"\n                    float2 inputs:fallback = (0.0, 0.0)\n                    float2 outputs:result\n                }\n\n                '+a.join("\n")+"\n            }\n        ";return this.materials.push(l),r("")},n.buildMesh=function(e){var t=[],n=[],i=[],r=[],s=[];e.getVertexStream(tT,t),e.getVertexStream(tE,i),e.getVertexStream(tL,r),e.getVertexStream(tD,s),e.getIndices(n);var a=n.length||t.length,o=Array(a/3).fill(3).join(", ");if(!n.length)for(var l=0;l<a;l++)n[l]=l;var u=t.length/3;i=i.length?i:Array(3*u).fill(0),r=r.length?r:Array(2*u).fill(0),s=s.length?s:Array(2*u).fill(0),t=this.buildArray3(t),i=this.buildArray3(i);var c='\ndef "Mesh"\n{\n    def Mesh "Mesh"\n    {\n        int[] faceVertexCounts = ['+o+"]\n        int[] faceVertexIndices = ["+n+"]\n        normal3f[] normals = ["+i+'] (\n            interpolation = "vertex"\n        )\n        point3f[] points = ['+t+"]\n        texCoord2f[] primvars:st = ["+(r=this.buildArray2(r))+'] (\n            interpolation = "vertex"\n        )\n        texCoord2f[] primvars:st1 = ['+(s=this.buildArray2(s))+'] (\n            interpolation = "vertex"\n        )\n        uniform token subdivisionScheme = "none"\n    }\n}\n';return this.addFile("mesh","Mesh_"+e.id,"Mesh",c)},n.buildMeshInstance=function(e){for(var t=this.getMeshRef(e.mesh),n=this.getMaterialRef(e.material),i=this.buildMat4(e.node.getWorldTransform()),r=e.node.name.replace(/[^a-z0-9]/gi,"_"),s=r;this.nodeNames.has(s);)s=r+"_"+Math.random().toString(36).slice(2,7);return this.nodeNames.add(s),'\ndef Xform "'+s+'" (\n    prepend references = '+t+"\n)\n{\n    matrix4d xformOp:transform = "+i+'\n    uniform token[] xformOpOrder = ["xformOp:transform"]\n\n    rel material:binding = '+n+"\n}\n"},t}(P_);function Ii(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function Ir(e,t,n,i,r,s,a){try{var o=e[s](a),l=o.value;}catch(e){n(e);return}o.done?t(l):Promise.resolve(l).then(i,r);}function Is(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function Ia(e,t){return (Ia=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Io(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Ii(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ii(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var Il=function(e){switch(e){case 0:return 5121;case 1:return 5123;case 2:return 5125}return 0},Iu=function(e){switch(e){case 0:return 5120;case 1:return 5121;case 2:return 5122;case 3:return 5123;case 4:return 5124;case 5:return 5125;case 6:return 5126}return 0},Ic=function(e){switch(e){case 1:return "SCALAR";case 2:return "VEC2";case 3:return "VEC3";case 4:return "VEC4"}return 0},Ih=function(e){switch(e){case tT:return "POSITION";case tE:return "NORMAL";case tw:return "TANGENT";case tP:return "COLOR_0";case tC:return "JOINTS_0";case tA:return "WEIGHTS_0";case tL:return "TEXCOORD_0";case tD:return "TEXCOORD_1";case tM:return "TEXCOORD_2";case tR:return "TEXCOORD_3";case tO:return "TEXCOORD_4";case tk:return "TEXCOORD_5";case tN:return "TEXCOORD_6";case tF:return "TEXCOORD_7"}return ""},If=function(e){switch(e){case 0:return 9728;case 1:return 9729;case 2:return 9984;case 4:return 9985;case 3:return 9986;case 5:return 9987}return 0},Id=function(e){switch(e){case 1:return 33071;case 2:return 33648;case 0:return 10497}return 0},Ip=["diffuseMap","colorMap","normalMap","metalnessMap","emissiveMap"],Im=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){return e.apply(this,arguments)||this}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Ia(t,e);var n=t.prototype;return n.collectResources=function(e){var t={buffers:[],cameras:[],entities:[],materials:[],skins:[],textures:[],entityMeshInstances:[],bufferViewMap:new Map,compressableTexture:new Set},n=t.materials,i=t.buffers,r=t.entityMeshInstances,s=t.textures;e.forEach(function(e){t.entities.push(e);});var a=function(e){e.forEach(function(e){var a=e.material;0>n.indexOf(a)&&(t.materials.push(a),Ip.forEach(function(e){var n=a[e];n&&0>s.indexOf(n)&&("normalMap"!==e&&t.compressableTexture.add(n),s.push(n));}));var o=e.node,l=r.find(function(e){return e.node===o});l||(l={node:o,meshInstances:[]},r.push(l)),l.meshInstances.push(e);var u=e.mesh,c=u.vertexBuffer;0>i.indexOf(c)&&i.unshift(c);var h=u.indexBuffer[0];0>i.indexOf(h)&&i.push(h),u.skin&&0>t.skins.indexOf(u.skin)&&t.skins.push(u.skin);});};return t.entities.forEach(function(e){e.camera&&t.cameras.push(e.camera),e.render&&e.render.enabled&&a(e.render.meshInstances),e.model&&e.model.enabled&&e.model.meshInstances&&a(e.model.meshInstances);}),t},n.writeBufferViews=function(e,n){n.bufferViews=[];for(var i,r=Io(e.buffers);!(i=r()).done;){var s=i.value;t.writeBufferView(e,n,s);}},n.writeCameras=function(e,t){e.cameras.length>0&&(t.cameras=e.cameras.map(function(e){var t=e.projection,n=e.nearClip,i=e.farClip,r={};if(1===t)r.type="orthographic",r.orthographic={xmag:1,ymag:1,znear:n,zfar:i};else {var s=e.fov;r.type="perspective",r.perspective={yfov:s*Math.PI/180,znear:n,zfar:i};}return r}));},n.attachTexture=function(e,t,n,i,r,s){var a=t[r];if(a){var o,l,u=e.textures.indexOf(a);n[i]={index:u};var c=t[""+r+"Tiling"],h=t[""+r+"Offset"],f=t[""+r+"Rotation"];(c&&!c.equals(eX.ONE)||h&&!h.equals(eX.ZERO)||0!==f)&&(n[i].extensions={KHR_texture_transform:{}},s.extensionsUsed=null!=(o=s.extensionsUsed)?o:[],0>s.extensionsUsed.indexOf("KHR_texture_transform")&&s.extensionsUsed.push("KHR_texture_transform"),s.extensionsRequired=null!=(l=s.extensionsRequired)?l:[],0>s.extensionsRequired.indexOf("KHR_texture_transform")&&s.extensionsRequired.push("KHR_texture_transform"),c&&!c.equals(eX.ONE)&&(n[i].extensions.KHR_texture_transform.scale=[c.x,c.y]),h&&!h.equals(eX.ZERO)&&(n[i].extensions.KHR_texture_transform.offset=[h.x,h.y-1+c.y]),0!==f&&(n[i].extensions.KHR_texture_transform.rotation=f*ek.DEG_TO_RAD));}},n.writeStandardMaterial=function(e,t,n,i){var r=t.diffuse,s=t.emissive,a=t.opacity,o=t.metalness,l=t.gloss,u=t.glossInvert,c=n.pbrMetallicRoughness;r.equals(eN.WHITE)&&1===a||(c.baseColorFactor=[r.r,r.g,r.b,a]),1!==o&&(c.metallicFactor=o);var h=u?l:1-l;1!==h&&(c.roughnessFactor=h),this.attachTexture(e,t,c,"baseColorTexture","diffuseMap",i),this.attachTexture(e,t,c,"metallicRoughnessTexture","metalnessMap",i),s.equals(eN.BLACK)||(n.emissiveFactor=[s.r,s.g,s.b]);},n.writeMaterials=function(e,t){var n=this;e.materials.length>0&&(t.materials=e.materials.map(function(i){var r=i.name,s=i.blendType,a=i.cull,o=i.alphaTest,l={pbrMetallicRoughness:{}};return r&&r.length>0&&(l.name=r),Is(i,dw)&&n.writeStandardMaterial(e,i,l,t),2===s?l.alphaMode="BLEND":3===s&&0!==o&&(l.alphaMode="MASK",l.alphaCutoff=o),0===a&&(l.doubleSided=true),n.attachTexture(e,i,l,"normalTexture","normalMap",t),n.attachTexture(e,i,l,"occlusionTexture","aoMap",t),n.attachTexture(e,i,l,"emissiveTexture","emissiveMap",t),l}));},n.writeNodes=function(e,t){e.entities.length>0&&(t.nodes=e.entities.map(function(t){var n=t.name,i=t.getLocalPosition(),r=t.getLocalRotation(),s=t.getLocalScale(),a={};n&&n.length>0&&(a.name=n),i.equals(eW.ZERO)||(a.translation=[i.x,i.y,i.z]),r.equals(e0.IDENTITY)||(a.rotation=[r.x,r.y,r.z,r.w]),s.equals(eW.ONE)||(a.scale=[s.x,s.y,s.z]),t.camera&&t.camera.enabled&&(a.camera=e.cameras.indexOf(t.camera));var o=e.entityMeshInstances.find(function(e){return e.node===t});if(o){a.mesh=e.entityMeshInstances.indexOf(o);var l=o.meshInstances[0];l&&l.mesh.skin&&(a.skin=e.skins.indexOf(l.mesh.skin));}return t.children.length>0&&(a.children=[],t.children.forEach(function(t){a.children.push(e.entities.indexOf(t));})),a}));},n.writeMeshes=function(e,n,i){e.entityMeshInstances.length>0&&(n.accessors=[],n.meshes=[],e.entityMeshInstances.forEach(function(r){var s={primitives:[]};r.meshInstances.forEach(function(r){var a=t.createPrimitive(e,n,r.mesh,i);a.material=e.materials.indexOf(r.material),s.primitives.push(a);}),n.meshes.push(s);}));},n.writeSkins=function(e,n){e.skins.length>0&&(n.skins=e.skins.map(function(i){for(var r=new Float32Array(16*i.inverseBindPose.length),s=0;s<i.inverseBindPose.length;s++){var a=i.inverseBindPose[s];r.set(a.data,16*s);}var o=r.buffer;t.writeBufferView(e,n,o),e.buffers.push(o);var l={bufferView:e.bufferViewMap.get(o)[0],componentType:Iu(6),count:i.inverseBindPose.length,type:"MAT4"};return {inverseBindMatrices:n.accessors.push(l)-1,joints:i.boneNames.map(function(t){var n=e.entities.find(function(e){return e.name===t});return e.entities.indexOf(n)})}}));},n.convertTextures=function(e,t){var n=this,i={maxTextureSize:t.maxTextureSize},r=[];return e.forEach(function(e){var t=n.textureToCanvas(e,i);t.then(function(e){return new Promise(function(t){return t(e)})}),r.push(t);}),r},n.writeTextures=function(e,n,i,r){for(var s,a=function(r){var a=l[r],c=n[r],h=function(e){for(var t=e.getContext("2d").getImageData(0,0,e.width,e.height).data,n=3;n<t.length;n+=4)if(t[n]<255)return  true;return  false}(c)||!e.compressableTexture.has(a)?"image/png":"image/jpeg";u.push(s.getBlob(c,h).then(function(e){var t=new FileReader;return t.readAsArrayBuffer(e),new Promise(function(e){t.onloadend=function(){e(t);};})}).then(function(n){var s=o.getPaddedArrayBuffer(n.result);t.writeBufferView(e,i,s),e.buffers.push(s);var l=e.bufferViewMap.get(s);i.images[r]={mimeType:h,bufferView:l[0]},i.samplers[r]={minFilter:If(a.minFilter),magFilter:If(a.magFilter),wrapS:Id(a.addressU),wrapT:Id(a.addressV)},i.textures[r]={sampler:r,source:r};}));},o=this,l=e.textures,u=[],c=0;c<n.length;c++)s=this,a(c);return Promise.all(u)},n.getBlob=function(e,t){if(void 0!==e.toBlob)return new Promise(function(n){e.toBlob(n,t);});var n=1;return "image/jpeg"===t&&(n=.92),e.convertToBlob({type:t,quality:n})},n.getPaddedArrayBuffer=function(e,t){ void 0===t&&(t=0);var n=ek.roundUp(e.byteLength,4);if(n!==e.byteLength){var i=new Uint8Array(n);if(i.set(new Uint8Array(e)),0!==t)for(var r=e.byteLength;r<n;r++)i[r]=t;return i.buffer}return e},n.buildJson=function(e,t){var n,i=this.convertTextures(e.textures,t),r=this;return Promise.all(i).then((n=function(n){var i;return function(e,t){var n,i,r,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(l){var u=[o,l];if(n)throw TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(s=0)),s;)try{if(n=1,i&&(r=2&u[0]?i.return:u[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,u[1])).done)return r;switch(i=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,i=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===u[0]||2===u[0])){s=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){s.label=u[1];break}if(6===u[0]&&s.label<r[1]){s.label=r[1],r=u;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(u);break}r[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s);}catch(e){u=[6,e],i=0;}finally{n=r=0;}if(5&u[0])throw u[1];return {value:u[0]?u[1]:void 0,done:true}}}}(this,function(s){switch(s.label){case 0:return i={asset:{version:"2.0",generator:"PlayCanvas GltfExporter"},scenes:[{nodes:[0]}],images:[],samplers:[],textures:[],scene:0},r.writeBufferViews(e,i),r.writeCameras(e,i),r.writeMeshes(e,i,t),r.writeMaterials(e,i),r.writeNodes(e,i,t),r.writeSkins(e,i),[4,r.writeTextures(e,n,i,t)];case 1:return s.sent(),i.images.length||delete i.images,i.samplers.length||delete i.samplers,i.textures.length||delete i.textures,[2,i]}})},function(){var e=this,t=arguments;return new Promise(function(i,r){var s=n.apply(e,t);function a(e){Ir(s,i,r,a,o,"next",e);}function o(e){Ir(s,i,r,a,o,"throw",e);}a(void 0);})}))},n.build=function(e,t){ void 0===t&&(t={});var n=this.collectResources(e);return this.buildJson(n,t).then(function(e){var t=new TextEncoder().encode(JSON.stringify(e)),i=t.length,r=4-(3&i)&3,s=e.buffers.reduce(function(e,t){return ek.roundUp(e+t.byteLength,4)},0),a=20+i+r;s>0&&(a+=8+s);var o=new ArrayBuffer(a),l=new DataView(o);l.setUint32(0,0x46546c67,true),l.setUint32(4,2,true),l.setUint32(8,a,true),l.setUint32(12,i+r,true),l.setUint32(16,0x4e4f534a,true);var u=20;new Uint8Array(o,20,i).set(t),u+=i;for(var c=0;c<r;c++)l.setUint8(u+c,32);return u+=r,s>0&&(l.setUint32(u,s,true),l.setUint32(u+4,5130562,true),u+=8,n.buffers.forEach(function(t){var i,r=n.bufferViewMap.get(t)[0],s=e.bufferViews[r].byteOffset;if(Is(t,ArrayBuffer))i=new Uint8Array(t);else {var a=t.lock();i=Is(a,ArrayBuffer)?new Uint8Array(a):new Uint8Array(a.buffer,a.byteOffset,a.byteLength);}new Uint8Array(o,u+s,i.byteLength).set(i);})),Promise.resolve(o)})},t.writeBufferView=function(e,t,n){t.buffers=null!=(l=t.buffers)?l:[],t.buffers[0]=null!=(u=t.buffers[0])?u:{byteLength:0};var i=t.buffers[0];i.byteLength=ek.roundUp(i.byteLength,4);var r=i.byteLength,s=function(e,n,i,r){var s={buffer:0,byteLength:n,byteOffset:i};return (34962===e||34963===e)&&(s.target=e),void 0!==r&&(s.byteStride=r),t.bufferViews.push(s)-1};if(Is(n,n1)){c=n.lock();var a=n.getFormat();if(a.interleaved){var o=s(34962,c.byteLength,r,a.size);e.bufferViewMap.set(n,[o]);}else {for(var l,u,c,h,f=[],d=Io(a.elements);!(h=d()).done;){var p=h.value,m=s(34962,p.size*a.vertexCount,r+p.offset,p.size);f.push(m);}e.bufferViewMap.set(n,f);}}else if(Is(n,s$)){var _=s(34963,(c=n.lock()).byteLength,r);e.bufferViewMap.set(n,[_]);}else {var v=s(void 0,(c=n).byteLength,r);e.bufferViewMap.set(n,[v]);}i.byteLength+=c.byteLength;},t.createPrimitive=function(e,n,i,r){ void 0===r&&(r={});var s={attributes:{}},a=i.vertexBuffer,o=a.format,l=o.interleaved,u=o.elements,c=a.getNumVertices();u.forEach(function(o,u){var h=Ih(o.name);if(r.stripUnusedAttributes){var f=true;if(h.startsWith("TEXCOORD_")){var d=parseInt(h.split("_")[1],10);f=e.materials.some(function(e){return Ip.some(function(t){var n;return e[t]&&(0===d||(null==(n=e[""+t+"Tiling"])?void 0:n.uv)===d)})});}if("COLOR_0"===h&&(f=e.materials.some(function(e){return e.vertexColors})),"TANGENT"===h&&(f=e.materials.some(function(e){return e.normalMap})),("JOINTS_0"===h||"WEIGHTS_0"===h)&&(f=e.entityMeshInstances.some(function(e){return e.meshInstances.some(function(e){return e.mesh.skin})})),!f)return}var p=e.bufferViewMap.get(a);p||(t.writeBufferView(e,n,a),e.buffers.push(a),p=e.bufferViewMap.get(a));var m={bufferView:p[l?0:u],byteOffset:l?o.offset:0,componentType:Iu(o.dataType),type:Ic(o.numComponents),count:c},_=n.accessors.push(m)-1;if(s.attributes[h]=_,o.name===tT){var v=[];i.getPositions(v);var g=new eW,y=new eW;e8.computeMinMax(v,g,y),m.min=[g.x,g.y,g.z],m.max=[y.x,y.y,y.z];}});var h=i.indexBuffer[0];if(h){var f=e.bufferViewMap.get(h);f||(t.writeBufferView(e,n,h),e.buffers.push(h),f=e.bufferViewMap.get(h));var d={bufferView:f[0],componentType:Il(h.getFormat()),count:h.getNumIndices(),type:"SCALAR"};s.indices=n.accessors.push(d)-1;}return s},t}(P_),I_="none",Iv="lighting",Ig="combine";function Iy(e,t){return (Iy=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var IS=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i){ void 0===i&&(i={}),(r=e.call(this,t)||this).sourceTexture=n,r.premultiplyTexture=i.premultiplyTexture,o0.get(t,nn).set("downsamplePS","\nuniform sampler2D sourceTexture;\nuniform vec2 sourceInvResolution;\nvarying vec2 uv0;\n#ifdef PREMULTIPLY\n	uniform sampler2D premultiplyTexture;\n#endif\nvoid main()\n{\n	vec3 e = texture2D (sourceTexture, uv0).rgb;\n	#ifdef BOXFILTER\n		vec3 value = e;\n		#ifdef PREMULTIPLY\n			float premultiply = texture2D(premultiplyTexture, uv0).{PREMULTIPLY_SRC_CHANNEL};\n			value *= vec3(premultiply);\n		#endif\n	#else\n		float x = sourceInvResolution.x;\n		float y = sourceInvResolution.y;\n		vec3 a = texture2D(sourceTexture, vec2 (uv0.x - 2.0 * x, uv0.y + 2.0 * y)).rgb;\n		vec3 b = texture2D(sourceTexture, vec2 (uv0.x,		   uv0.y + 2.0 * y)).rgb;\n		vec3 c = texture2D(sourceTexture, vec2 (uv0.x + 2.0 * x, uv0.y + 2.0 * y)).rgb;\n		vec3 d = texture2D(sourceTexture, vec2 (uv0.x - 2.0 * x, uv0.y)).rgb;\n		vec3 f = texture2D(sourceTexture, vec2 (uv0.x + 2.0 * x, uv0.y)).rgb;\n		vec3 g = texture2D(sourceTexture, vec2 (uv0.x - 2.0 * x, uv0.y - 2.0 * y)).rgb;\n		vec3 h = texture2D(sourceTexture, vec2 (uv0.x,		   uv0.y - 2.0 * y)).rgb;\n		vec3 i = texture2D(sourceTexture, vec2 (uv0.x + 2.0 * x, uv0.y - 2.0 * y)).rgb;\n		vec3 j = texture2D(sourceTexture, vec2 (uv0.x - x, uv0.y + y)).rgb;\n		vec3 k = texture2D(sourceTexture, vec2 (uv0.x + x, uv0.y + y)).rgb;\n		vec3 l = texture2D(sourceTexture, vec2 (uv0.x - x, uv0.y - y)).rgb;\n		vec3 m = texture2D(sourceTexture, vec2 (uv0.x + x, uv0.y - y)).rgb;\n		vec3 value = e * 0.125;\n		value += (a + c + g + i) * 0.03125;\n		value += (b + d + f + h) * 0.0625;\n		value += (j + k + l + m) * 0.125;\n	#endif\n	#ifdef REMOVE_INVALID\n		value = max(value, vec3(0.0));\n	#endif\n	gl_FragColor = vec4(value, 1.0);\n}\n"),o0.get(t,ni).set("downsamplePS","\nvar sourceTexture: texture_2d<f32>;\nvar sourceTextureSampler: sampler;\nuniform sourceInvResolution: vec2f;\nvarying uv0: vec2f;\n#ifdef PREMULTIPLY\n	var premultiplyTexture: texture_2d<f32>;\n	var premultiplyTextureSampler: sampler;\n#endif\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n	var output: FragmentOutput;\n	let e: vec3f = textureSample(sourceTexture, sourceTextureSampler, input.uv0).rgb;\n	#ifdef BOXFILTER\n		var value: vec3f = e;\n		#ifdef PREMULTIPLY\n			let premultiply: f32 = textureSample(premultiplyTexture, premultiplyTextureSampler, input.uv0).{PREMULTIPLY_SRC_CHANNEL};\n			value = value * vec3f(premultiply);\n		#endif\n	#else\n		let x: f32 = uniform.sourceInvResolution.x;\n		let y: f32 = uniform.sourceInvResolution.y;\n		let a: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - 2.0 * x, input.uv0.y + 2.0 * y)).rgb;\n		let b: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,		   input.uv0.y + 2.0 * y)).rgb;\n		let c: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + 2.0 * x, input.uv0.y + 2.0 * y)).rgb;\n		let d: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - 2.0 * x, input.uv0.y)).rgb;\n		let f: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + 2.0 * x, input.uv0.y)).rgb;\n		let g: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - 2.0 * x, input.uv0.y - 2.0 * y)).rgb;\n		let h: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,		   input.uv0.y - 2.0 * y)).rgb;\n		let i: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + 2.0 * x, input.uv0.y - 2.0 * y)).rgb;\n		let j: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y + y)).rgb;\n		let k: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y + y)).rgb;\n		let l: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y - y)).rgb;\n		let m: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y - y)).rgb;\n		var value: vec3f = e * 0.125;\n		value = value + (a + c + g + i) * 0.03125;\n		value = value + (b + d + f + h) * 0.0625;\n		value = value + (j + k + l + m) * 0.125;\n	#endif\n	#ifdef REMOVE_INVALID\n		value = max(value, vec3f(0.0));\n	#endif\n	output.color = vec4f(value, 1.0);\n	return output;\n}\n");var r,s,a,o,l=null!=(s=i.boxFilter)&&s,u=(l?"Box":"")+"-"+(i.premultiplyTexture?"Premultiply":"")+"-"+(null!=(a=i.premultiplySrcChannel)?a:"")+"-"+(i.removeInvalid?"RemoveInvalid":""),c=new Map;return l&&c.set("BOXFILTER",""),i.premultiplyTexture&&c.set("PREMULTIPLY",""),i.removeInvalid&&c.set("REMOVE_INVALID",""),c.set("{PREMULTIPLY_SRC_CHANNEL}",null!=(o=i.premultiplySrcChannel)?o:"x"),r.shader=o8.createShader(t,{uniqueName:"DownSampleShader:"+u,attributes:{aPosition:tT},vertexChunk:"quadVS",fragmentChunk:"downsamplePS",fragmentDefines:c}),r.sourceTextureId=t.scope.resolve("sourceTexture"),r.premultiplyTextureId=t.scope.resolve("premultiplyTexture"),r.sourceInvResolutionId=t.scope.resolve("sourceInvResolution"),r.sourceInvResolutionValue=new Float32Array(2),r}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Iy(t,e);var n=t.prototype;return n.setSourceTexture=function(e){this._sourceTexture=e,this.options.resizeSource=e;},n.execute=function(){this.sourceTextureId.setValue(this.sourceTexture),this.premultiplyTexture&&this.premultiplyTextureId.setValue(this.premultiplyTexture),this.sourceInvResolutionValue[0]=1/this.sourceTexture.width,this.sourceInvResolutionValue[1]=1/this.sourceTexture.height,this.sourceInvResolutionId.setValue(this.sourceInvResolutionValue),e.prototype.execute.call(this);},t}(f1);function Ix(e,t){return (Ix=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ib=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t)||this).sourceTexture=n,o0.get(t,nn).set("upsamplePS","\n	uniform sampler2D sourceTexture;\n	uniform vec2 sourceInvResolution;\n	varying vec2 uv0;\n	void main()\n	{\n		float x = sourceInvResolution.x;\n		float y = sourceInvResolution.y;\n		vec3 a = texture2D (sourceTexture, vec2 (uv0.x - x, uv0.y + y)).rgb;\n		vec3 b = texture2D (sourceTexture, vec2 (uv0.x,	 uv0.y + y)).rgb;\n		vec3 c = texture2D (sourceTexture, vec2 (uv0.x + x, uv0.y + y)).rgb;\n		vec3 d = texture2D (sourceTexture, vec2 (uv0.x - x, uv0.y)).rgb;\n		vec3 e = texture2D (sourceTexture, vec2 (uv0.x,	 uv0.y)).rgb;\n		vec3 f = texture2D (sourceTexture, vec2 (uv0.x + x, uv0.y)).rgb;\n		vec3 g = texture2D (sourceTexture, vec2 (uv0.x - x, uv0.y - y)).rgb;\n		vec3 h = texture2D (sourceTexture, vec2 (uv0.x,	 uv0.y - y)).rgb;\n		vec3 i = texture2D (sourceTexture, vec2 (uv0.x + x, uv0.y - y)).rgb;\n		vec3 value = e * 4.0;\n		value += (b + d + f + h) * 2.0;\n		value += (a + c + g + i);\n		value *= 1.0 / 16.0;\n		gl_FragColor = vec4(value, 1.0);\n	}\n"),o0.get(t,ni).set("upsamplePS","\n	var sourceTexture: texture_2d<f32>;\n	var sourceTextureSampler: sampler;\n	uniform sourceInvResolution: vec2f;\n	varying uv0: vec2f;\n	@fragment\n	fn fragmentMain(input: FragmentInput) -> FragmentOutput {\n		var output: FragmentOutput;\n		let x: f32 = uniform.sourceInvResolution.x;\n		let y: f32 = uniform.sourceInvResolution.y;\n		let a: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y + y)).rgb;\n		let b: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,	 input.uv0.y + y)).rgb;\n		let c: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y + y)).rgb;\n		let d: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y)).rgb;\n		let e: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,	 input.uv0.y)).rgb;\n		let f: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y)).rgb;\n		let g: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y - y)).rgb;\n		let h: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,	 input.uv0.y - y)).rgb;\n		let i: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y - y)).rgb;\n		var value: vec3f = e * 4.0;\n		value = value + (b + d + f + h) * 2.0;\n		value = value + (a + c + g + i);\n		value = value * (1.0 / 16.0);\n		output.color = vec4f(value, 1.0);\n		return output;\n	}\n"),i.shader=o8.createShader(t,{uniqueName:"UpSampleShader",attributes:{aPosition:tT},vertexChunk:"quadVS",fragmentChunk:"upsamplePS"}),i.sourceTextureId=t.scope.resolve("sourceTexture"),i.sourceInvResolutionId=t.scope.resolve("sourceInvResolution"),i.sourceInvResolutionValue=new Float32Array(2),i}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Ix(t,e),t.prototype.execute=function(){this.sourceTextureId.setValue(this.sourceTexture),this.sourceInvResolutionValue[0]=1/this.sourceTexture.width,this.sourceInvResolutionValue[1]=1/this.sourceTexture.height,this.sourceInvResolutionId.setValue(this.sourceInvResolutionValue),e.prototype.execute.call(this);},t}(f1);function IT(e,t){return (IT=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var IE=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i){var r;return (r=e.call(this,t)||this).blurLevel=16,r.renderTargets=[],r._sourceTexture=n,r.textureFormat=i,r.bloomRenderTarget=r.createRenderTarget(0),r.bloomTexture=r.bloomRenderTarget.colorBuffer,r}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&IT(t,e);var n=t.prototype;return n.destroy=function(){this.destroyRenderPasses(),this.destroyRenderTargets();},n.destroyRenderTargets=function(e){ void 0===e&&(e=0);for(var t=e;t<this.renderTargets.length;t++){var n=this.renderTargets[t];n.destroyTextureBuffers(),n.destroy();}this.renderTargets.length=0;},n.destroyRenderPasses=function(){for(var e=0;e<this.beforePasses.length;e++)this.beforePasses[e].destroy();this.beforePasses.length=0;},n.createRenderTarget=function(e){return new il({depth:false,colorBuffer:new nO(this.device,{name:"BloomTexture"+e,width:1,height:1,format:this.textureFormat,mipmaps:false,minFilter:1,magFilter:1,addressU:1,addressV:1})})},n.createRenderTargets=function(e){for(var t=0;t<e;t++){var n=0===t?this.bloomRenderTarget:this.createRenderTarget(t);this.renderTargets.push(n);}},n.calcMipLevels=function(e,t,n){return Math.floor(Math.log2(Math.min(e,t))-Math.log2(n))},n.createRenderPasses=function(e){for(var t=this.device,n=this._sourceTexture,i=0;i<e;i++){var r=new IS(t,n),s=this.renderTargets[i];r.init(s,{resizeSource:n,scaleX:.5,scaleY:.5}),r.setClearColor(eN.BLACK),this.beforePasses.push(r),n=s.colorBuffer;}n=this.renderTargets[e-1].colorBuffer;for(var a=e-2;a>=0;a--){var o=new Ib(t,n),l=this.renderTargets[a];o.init(l),o.blendState=nj.ADDBLEND,this.beforePasses.push(o),n=l.colorBuffer;}},n.onDisable=function(){var e;null==(e=this.renderTargets[0])||e.resize(1,1),this.destroyRenderPasses(),this.destroyRenderTargets(1);},n.frameUpdate=function(){e.prototype.frameUpdate.call(this);var t=this.calcMipLevels(this._sourceTexture.width,this._sourceTexture.height,1),n=ek.clamp(t,1,this.blurLevel);this.renderTargets.length!==n&&(this.destroyRenderPasses(),this.destroyRenderTargets(1),this.createRenderTargets(n),this.createRenderPasses(n));},t}(s2),Iw={composePS:'\n	#include "tonemappingPS"\n	#include "gammaPS"\n	varying vec2 uv0;\n	uniform sampler2D sceneTexture;\n	uniform vec2 sceneTextureInvRes;\n	#include "composeBloomPS"\n	#include "composeDofPS"\n	#include "composeSsaoPS"\n	#include "composeGradingPS"\n	#include "composeVignettePS"\n	#include "composeFringingPS"\n	#include "composeCasPS"\n	#include "composeColorLutPS"\n	void main() {\n		vec2 uv = uv0;\n		#ifdef TAA\n		#ifdef WEBGPU\n			uv.y = 1.0 - uv.y;\n		#endif\n		#endif\n		vec4 scene = texture2DLod(sceneTexture, uv, 0.0);\n		vec3 result = scene.rgb;\n		#ifdef CAS\n			result = applyCas(result, uv, sharpness);\n		#endif\n		#ifdef DOF\n			result = applyDof(result, uv0);\n		#endif\n		#ifdef SSAO_TEXTURE\n			result = applySsao(result, uv0);\n		#endif\n		#ifdef FRINGING\n			result = applyFringing(result, uv);\n		#endif\n		#ifdef BLOOM\n			result = applyBloom(result, uv0);\n		#endif\n		#ifdef GRADING\n			result = applyGrading(result);\n		#endif\n		result = toneMap(max(vec3(0.0), result));\n		#ifdef COLOR_LUT\n			result = applyColorLUT(result);\n		#endif\n		#ifdef VIGNETTE\n			result = applyVignette(result, uv);\n		#endif\n		#ifdef DEBUG_COMPOSE\n			#if DEBUG_COMPOSE == scene\n				result = scene.rgb;\n			#elif defined(BLOOM) && DEBUG_COMPOSE == bloom\n				result = dBloom * bloomIntensity;\n			#elif defined(DOF) && DEBUG_COMPOSE == dofcoc\n				result = vec3(dCoc, 0.0);\n			#elif defined(DOF) && DEBUG_COMPOSE == dofblur\n				result = dBlur;\n			#elif defined(SSAO_TEXTURE) && DEBUG_COMPOSE == ssao\n				result = vec3(dSsao);\n			#elif defined(VIGNETTE) && DEBUG_COMPOSE == vignette\n				result = vec3(dVignette);\n			#endif\n		#endif\n		result = gammaCorrectOutput(result);\n		gl_FragColor = vec4(result, scene.a);\n	}\n',composeBloomPS:"\n	#ifdef BLOOM\n		uniform sampler2D bloomTexture;\n		uniform float bloomIntensity;\n		\n		vec3 dBloom;\n		\n		vec3 applyBloom(vec3 color, vec2 uv) {\n			dBloom = texture2DLod(bloomTexture, uv, 0.0).rgb;\n			return color + dBloom * bloomIntensity;\n		}\n	#endif\n",composeDofPS:"\n	#ifdef DOF\n		uniform sampler2D cocTexture;\n		uniform sampler2D blurTexture;\n		\n		vec2 dCoc;\n		vec3 dBlur;\n		vec3 getDofBlur(vec2 uv) {\n			dCoc = texture2DLod(cocTexture, uv, 0.0).rg;\n			#if DOF_UPSCALE\n				vec2 blurTexelSize = 1.0 / vec2(textureSize(blurTexture, 0));\n				vec3 bilinearBlur = vec3(0.0);\n				float totalWeight = 0.0;\n				for (int i = -1; i <= 1; i++) {\n					for (int j = -1; j <= 1; j++) {\n						vec2 offset = vec2(i, j) * blurTexelSize;\n						vec2 cocSample = texture2DLod(cocTexture, uv + offset, 0.0).rg;\n						vec3 blurSample = texture2DLod(blurTexture, uv + offset, 0.0).rgb;\n						float cocWeight = clamp(cocSample.r + cocSample.g, 0.0, 1.0);\n						bilinearBlur += blurSample * cocWeight;\n						totalWeight += cocWeight;\n					}\n				}\n				if (totalWeight > 0.0) {\n					bilinearBlur /= totalWeight;\n				}\n				dBlur = bilinearBlur;\n				return bilinearBlur;\n			#else\n				dBlur = texture2DLod(blurTexture, uv, 0.0).rgb;\n				return dBlur;\n			#endif\n		}\n		vec3 applyDof(vec3 color, vec2 uv) {\n			vec3 blur = getDofBlur(uv);\n			return mix(color, blur, dCoc.r + dCoc.g);\n		}\n	#endif\n",composeSsaoPS:"\n	#ifdef SSAO\n		#define SSAO_TEXTURE\n	#endif\n	#if DEBUG_COMPOSE == ssao\n		#define SSAO_TEXTURE\n	#endif\n	#ifdef SSAO_TEXTURE\n		uniform sampler2D ssaoTexture;\n		\n		float dSsao;\n		\n		vec3 applySsao(vec3 color, vec2 uv) {\n			dSsao = texture2DLod(ssaoTexture, uv, 0.0).r;\n			\n			#ifdef SSAO\n				return color * dSsao;\n			#else\n				return color;\n			#endif\n		}\n	#endif\n",composeGradingPS:"\n	#ifdef GRADING\n		uniform vec3 brightnessContrastSaturation;\n		uniform vec3 tint;\n		vec3 colorGradingHDR(vec3 color, float brt, float sat, float con) {\n			color *= tint;\n			color = color * brt;\n			float grey = dot(color, vec3(0.3, 0.59, 0.11));\n			grey = grey / max(1.0, max(color.r, max(color.g, color.b)));\n			color = mix(vec3(grey), color, sat);\n			return mix(vec3(0.5), color, con);\n		}\n		vec3 applyGrading(vec3 color) {\n			return colorGradingHDR(color, \n				brightnessContrastSaturation.x, \n				brightnessContrastSaturation.z, \n				brightnessContrastSaturation.y);\n		}\n	#endif\n",composeVignettePS:"\n	#ifdef VIGNETTE\n		uniform vec4 vignetterParams;\n		\n		float dVignette;\n		\n		float calcVignette(vec2 uv) {\n			float inner = vignetterParams.x;\n			float outer = vignetterParams.y;\n			float curvature = vignetterParams.z;\n			float intensity = vignetterParams.w;\n			vec2 curve = pow(abs(uv * 2.0 -1.0), vec2(1.0 / curvature));\n			float edge = pow(length(curve), curvature);\n			dVignette = 1.0 - intensity * smoothstep(inner, outer, edge);\n			return dVignette;\n		}\n		vec3 applyVignette(vec3 color, vec2 uv) {\n			return color * calcVignette(uv);\n		}\n	#endif\n",composeFringingPS:"\n	#ifdef FRINGING\n		uniform float fringingIntensity;\n		vec3 applyFringing(vec3 color, vec2 uv) {\n			vec2 centerDistance = uv - 0.5;\n			vec2 offset = fringingIntensity * pow(centerDistance, vec2(2.0, 2.0));\n			color.r = texture2D(sceneTexture, uv - offset).r;\n			color.b = texture2D(sceneTexture, uv + offset).b;\n			return color;\n		}\n	#endif\n",composeCasPS:"\n	#ifdef CAS\n		uniform float sharpness;\n		float maxComponent(float x, float y, float z) { return max(x, max(y, z)); }\n		vec3 toSDR(vec3 c) { return c / (1.0 + maxComponent(c.r, c.g, c.b)); }\n		vec3 toHDR(vec3 c) { return c / (1.0 - maxComponent(c.r, c.g, c.b)); }\n		vec3 applyCas(vec3 color, vec2 uv, float sharpness) {\n			float x = sceneTextureInvRes.x;\n			float y = sceneTextureInvRes.y;\n			vec3 a = toSDR(texture2DLod(sceneTexture, uv + vec2(0.0, -y), 0.0).rgb);\n			vec3 b = toSDR(texture2DLod(sceneTexture, uv + vec2(-x, 0.0), 0.0).rgb);\n			vec3 c = toSDR(color.rgb);\n			vec3 d = toSDR(texture2DLod(sceneTexture, uv + vec2(x, 0.0), 0.0).rgb);\n			vec3 e = toSDR(texture2DLod(sceneTexture, uv + vec2(0.0, y), 0.0).rgb);\n			float min_g = min(a.g, min(b.g, min(c.g, min(d.g, e.g))));\n			float max_g = max(a.g, max(b.g, max(c.g, max(d.g, e.g))));\n			float sharpening_amount = sqrt(min(1.0 - max_g, min_g) / max_g);\n			float w = sharpening_amount * sharpness;\n			vec3 res = (w * (a + b + d + e) + c) / (4.0 * w + 1.0);\n			res = max(res, 0.0);\n			return toHDR(res);\n		}\n	#endif\n",composeColorLutPS:"\n	#ifdef COLOR_LUT\n		uniform sampler2D colorLUT;\n		uniform vec4 colorLUTParams;\n		vec3 applyColorLUT(vec3 color) {\n			vec3 c = clamp(color, 0.0, 1.0);\n			float width = colorLUTParams.x;\n			float height = colorLUTParams.y;\n			float maxColor = colorLUTParams.z;\n			float cell = c.b * maxColor;\n			float cell_l = floor(cell);\n			float cell_h = ceil(cell);\n			float half_px_x = 0.5 / width;\n			float half_px_y = 0.5 / height;\n			float r_offset = half_px_x + c.r / height * (maxColor / height);\n			float g_offset = half_px_y + c.g * (maxColor / height);\n			vec2 uv_l = vec2(cell_l / height + r_offset, g_offset);\n			vec2 uv_h = vec2(cell_h / height + r_offset, g_offset);\n			vec3 color_l = texture2DLod(colorLUT, uv_l, 0.0).rgb;\n			vec3 color_h = texture2DLod(colorLUT, uv_h, 0.0).rgb;\n			vec3 lutColor = mix(color_l, color_h, fract(cell));\n			return mix(color, lutColor, colorLUTParams.w);\n		}\n	#endif\n"},IA={composePS:'\n	#include "tonemappingPS"\n	#include "gammaPS"\n	varying uv0: vec2f;\n	var sceneTexture: texture_2d<f32>;\n	var sceneTextureSampler: sampler;\n	uniform sceneTextureInvRes: vec2f;\n	#include "composeBloomPS"\n	#include "composeDofPS"\n	#include "composeSsaoPS"\n	#include "composeGradingPS"\n	#include "composeVignettePS"\n	#include "composeFringingPS"\n	#include "composeCasPS"\n	#include "composeColorLutPS"\n	@fragment\n	fn fragmentMain(input: FragmentInput) -> FragmentOutput {\n		var output: FragmentOutput;\n		var uv = uv0;\n		#ifdef TAA\n			uv.y = 1.0 - uv.y;\n		#endif\n		let scene = textureSampleLevel(sceneTexture, sceneTextureSampler, uv, 0.0);\n		var result = scene.rgb;\n		#ifdef CAS\n			result = applyCas(result, uv, uniform.sharpness);\n		#endif\n		#ifdef DOF\n			result = applyDof(result, uv0);\n		#endif\n		#ifdef SSAO_TEXTURE\n			result = applySsao(result, uv0);\n		#endif\n		#ifdef FRINGING\n			result = applyFringing(result, uv);\n		#endif\n		#ifdef BLOOM\n			result = applyBloom(result, uv0);\n		#endif\n		#ifdef GRADING\n			result = applyGrading(result);\n		#endif\n		result = toneMap(max(vec3f(0.0), result));\n		#ifdef COLOR_LUT\n			result = applyColorLUT(result);\n		#endif\n		#ifdef VIGNETTE\n			result = applyVignette(result, uv);\n		#endif\n		#ifdef DEBUG_COMPOSE\n			#if DEBUG_COMPOSE == scene\n				result = scene.rgb;\n			#elif defined(BLOOM) && DEBUG_COMPOSE == bloom\n				result = dBloom * uniform.bloomIntensity;\n			#elif defined(DOF) && DEBUG_COMPOSE == dofcoc\n				result = vec3f(dCoc, 0.0);\n			#elif defined(DOF) && DEBUG_COMPOSE == dofblur\n				result = dBlur;\n			#elif defined(SSAO_TEXTURE) && DEBUG_COMPOSE == ssao\n				result = vec3f(dSsao);\n			#elif defined(VIGNETTE) && DEBUG_COMPOSE == vignette\n				result = vec3f(dVignette);\n			#endif\n		#endif\n		result = gammaCorrectOutput(result);\n		output.color = vec4f(result, scene.a);\n		return output;\n	}\n',composeBloomPS:"\n	#ifdef BLOOM\n		var bloomTexture: texture_2d<f32>;\n		var bloomTextureSampler: sampler;\n		uniform bloomIntensity: f32;\n		\n		var<private> dBloom: vec3f;\n		\n		fn applyBloom(color: vec3f, uv: vec2f) -> vec3f {\n			dBloom = textureSampleLevel(bloomTexture, bloomTextureSampler, uv, 0.0).rgb;\n			return color + dBloom * uniform.bloomIntensity;\n		}\n	#endif\n",composeDofPS:"\n	#ifdef DOF\n		var cocTexture: texture_2d<f32>;\n		var cocTextureSampler: sampler;\n		var blurTexture: texture_2d<f32>;\n		var blurTextureSampler: sampler;\n		\n		var<private> dCoc: vec2f;\n		var<private> dBlur: vec3f;\n		fn getDofBlur(uv: vec2f) -> vec3f {\n			dCoc = textureSampleLevel(cocTexture, cocTextureSampler, uv, 0.0).rg;\n			#if DOF_UPSCALE\n				let blurTexelSize = 1.0 / vec2f(textureDimensions(blurTexture, 0));\n				var bilinearBlur = vec3f(0.0);\n				var totalWeight = 0.0;\n				for (var i = -1; i <= 1; i++) {\n					for (var j = -1; j <= 1; j++) {\n						let offset = vec2f(f32(i), f32(j)) * blurTexelSize;\n						let cocSample = textureSampleLevel(cocTexture, cocTextureSampler, uv + offset, 0.0).rg;\n						let blurSample = textureSampleLevel(blurTexture, blurTextureSampler, uv + offset, 0.0).rgb;\n						let cocWeight = clamp(cocSample.r + cocSample.g, 0.0, 1.0);\n						bilinearBlur += blurSample * cocWeight;\n						totalWeight += cocWeight;\n					}\n				}\n				if (totalWeight > 0.0) {\n					bilinearBlur /= totalWeight;\n				}\n				dBlur = bilinearBlur;\n				return bilinearBlur;\n			#else\n				dBlur = textureSampleLevel(blurTexture, blurTextureSampler, uv, 0.0).rgb;\n				return dBlur;\n			#endif\n		}\n		fn applyDof(color: vec3f, uv: vec2f) -> vec3f {\n			let blur = getDofBlur(uv);\n			return mix(color, blur, dCoc.r + dCoc.g);\n		}\n	#endif\n",composeSsaoPS:"\n	#ifdef SSAO\n		#define SSAO_TEXTURE\n	#endif\n	#if DEBUG_COMPOSE == ssao\n		#define SSAO_TEXTURE\n	#endif\n	#ifdef SSAO_TEXTURE\n		var ssaoTexture: texture_2d<f32>;\n		var ssaoTextureSampler: sampler;\n		\n		var<private> dSsao: f32;\n		\n		fn applySsao(color: vec3f, uv: vec2f) -> vec3f {\n			dSsao = textureSampleLevel(ssaoTexture, ssaoTextureSampler, uv, 0.0).r;\n			\n			#ifdef SSAO\n				return color * dSsao;\n			#else\n				return color;\n			#endif\n		}\n	#endif\n",composeGradingPS:"\n	#ifdef GRADING\n		uniform brightnessContrastSaturation: vec3f;\n		uniform tint: vec3f;\n		fn colorGradingHDR(color: vec3f, brt: f32, sat: f32, con: f32) -> vec3f {\n			var colorOut = color * uniform.tint;\n			colorOut = colorOut * brt;\n			let grey = dot(colorOut, vec3f(0.3, 0.59, 0.11));\n			let normalizedGrey = grey / max(1.0, max(colorOut.r, max(colorOut.g, colorOut.b)));\n			colorOut = mix(vec3f(normalizedGrey), colorOut, sat);\n			return mix(vec3f(0.5), colorOut, con);\n		}\n		fn applyGrading(color: vec3f) -> vec3f {\n			return colorGradingHDR(color, \n				uniform.brightnessContrastSaturation.x, \n				uniform.brightnessContrastSaturation.z, \n				uniform.brightnessContrastSaturation.y);\n		}\n	#endif\n",composeVignettePS:"\n	#ifdef VIGNETTE\n		uniform vignetterParams: vec4f;\n		\n		var<private> dVignette: f32;\n		\n		fn calcVignette(uv: vec2f) -> f32 {\n			let inner = uniform.vignetterParams.x;\n			let outer = uniform.vignetterParams.y;\n			let curvature = uniform.vignetterParams.z;\n			let intensity = uniform.vignetterParams.w;\n			let curve = pow(abs(uv * 2.0 - 1.0), vec2f(1.0 / curvature));\n			let edge = pow(length(curve), curvature);\n			dVignette = 1.0 - intensity * smoothstep(inner, outer, edge);\n			return dVignette;\n		}\n		fn applyVignette(color: vec3f, uv: vec2f) -> vec3f {\n			return color * calcVignette(uv);\n		}\n	#endif\n",composeFringingPS:"\n	#ifdef FRINGING\n		uniform fringingIntensity: f32;\n		fn applyFringing(color: vec3f, uv: vec2f) -> vec3f {\n			let centerDistance = uv - 0.5;\n			let offset = uniform.fringingIntensity * pow(centerDistance, vec2f(2.0));\n			var colorOut = color;\n			colorOut.r = textureSample(sceneTexture, sceneTextureSampler, uv - offset).r;\n			colorOut.b = textureSample(sceneTexture, sceneTextureSampler, uv + offset).b;\n			return colorOut;\n		}\n	#endif\n",composeCasPS:"\n	#ifdef CAS\n		uniform sharpness: f32;\n		fn maxComponent(x: f32, y: f32, z: f32) -> f32 { return max(x, max(y, z)); }\n		fn toSDR(c: vec3f) -> vec3f { return c / (1.0 + maxComponent(c.r, c.g, c.b)); }\n		fn toHDR(c: vec3f) -> vec3f { return c / (1.0 - maxComponent(c.r, c.g, c.b)); }\n		fn applyCas(color: vec3f, uv: vec2f, sharpness: f32) -> vec3f {\n			let x = uniform.sceneTextureInvRes.x;\n			let y = uniform.sceneTextureInvRes.y;\n			let a = toSDR(textureSampleLevel(sceneTexture, sceneTextureSampler, uv + vec2f(0.0, -y), 0.0).rgb);\n			let b = toSDR(textureSampleLevel(sceneTexture, sceneTextureSampler, uv + vec2f(-x, 0.0), 0.0).rgb);\n			let c = toSDR(color.rgb);\n			let d = toSDR(textureSampleLevel(sceneTexture, sceneTextureSampler, uv + vec2f(x, 0.0), 0.0).rgb);\n			let e = toSDR(textureSampleLevel(sceneTexture, sceneTextureSampler, uv + vec2f(0.0, y), 0.0).rgb);\n			let min_g = min(a.g, min(b.g, min(c.g, min(d.g, e.g))));\n			let max_g = max(a.g, max(b.g, max(c.g, max(d.g, e.g))));\n			let sharpening_amount = sqrt(min(1.0 - max_g, min_g) / max_g);\n			let w = sharpening_amount * uniform.sharpness;\n			var res = (w * (a + b + d + e) + c) / (4.0 * w + 1.0);\n			res = max(res, vec3f(0.0));\n			return toHDR(res);\n		}\n	#endif\n",composeColorLutPS:"\n	#ifdef COLOR_LUT\n		var colorLUT: texture_2d<f32>;\n		var colorLUTSampler: sampler;\n		uniform colorLUTParams: vec4f;\n		fn applyColorLUT(color: vec3f) -> vec3f {\n			var c: vec3f = clamp(color, vec3f(0.0), vec3f(1.0));\n			let width: f32 = uniform.colorLUTParams.x;\n			let height: f32 = uniform.colorLUTParams.y;\n			let maxColor: f32 = uniform.colorLUTParams.z;\n			let cell: f32 = c.b * maxColor;\n			let cell_l: f32 = floor(cell);\n			let cell_h: f32 = ceil(cell);\n			let half_px_x: f32 = 0.5 / width;\n			let half_px_y: f32 = 0.5 / height;\n			let r_offset: f32 = half_px_x + c.r / height * (maxColor / height);\n			let g_offset: f32 = half_px_y + c.g * (maxColor / height);\n			let uv_l: vec2f = vec2f(cell_l / height + r_offset, g_offset);\n			let uv_h: vec2f = vec2f(cell_h / height + r_offset, g_offset);\n			let color_l: vec3f = textureSampleLevel(colorLUT, colorLUTSampler, uv_l, 0.0).rgb;\n			let color_h: vec3f = textureSampleLevel(colorLUT, colorLUTSampler, uv_h, 0.0).rgb;\n			let lutColor: vec3f = mix(color_l, color_h, fract(cell));\n			return mix(color, lutColor, uniform.colorLUTParams.w);\n		}\n	#endif\n"};function IC(e,t){return (IC=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var IP=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){(n=e.call(this,t)||this).sceneTexture=null,n.bloomIntensity=.01,n._bloomTexture=null,n._cocTexture=null,n.blurTexture=null,n.blurTextureUpscale=false,n._ssaoTexture=null,n._toneMapping=0,n._gradingEnabled=false,n.gradingSaturation=1,n.gradingContrast=1,n.gradingBrightness=1,n.gradingTint=new eN(1,1,1,1),n._shaderDirty=true,n._vignetteEnabled=false,n.vignetteInner=.5,n.vignetteOuter=1,n.vignetteCurvature=.5,n.vignetteIntensity=.3,n._fringingEnabled=false,n.fringingIntensity=10,n._taaEnabled=false,n._sharpness=.5,n._gammaCorrection=1,n._colorLUT=null,n.colorLUTIntensity=1,n._key="",n._debug=null,o0.get(t,nn).add(Iw),o0.get(t,ni).add(IA);var n,i=t.scope;return n.sceneTextureId=i.resolve("sceneTexture"),n.bloomTextureId=i.resolve("bloomTexture"),n.cocTextureId=i.resolve("cocTexture"),n.ssaoTextureId=i.resolve("ssaoTexture"),n.blurTextureId=i.resolve("blurTexture"),n.bloomIntensityId=i.resolve("bloomIntensity"),n.bcsId=i.resolve("brightnessContrastSaturation"),n.tintId=i.resolve("tint"),n.vignetterParamsId=i.resolve("vignetterParams"),n.fringingIntensityId=i.resolve("fringingIntensity"),n.sceneTextureInvResId=i.resolve("sceneTextureInvRes"),n.sceneTextureInvResValue=new Float32Array(2),n.sharpnessId=i.resolve("sharpness"),n.colorLUTId=i.resolve("colorLUT"),n.colorLUTParams=new Float32Array(4),n.colorLUTParamsId=i.resolve("colorLUTParams"),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&IC(t,e);var n,i=t.prototype;return i.postInit=function(){this.setClearColor(eN.BLACK),this.setClearDepth(1),this.setClearStencil(0);},i.frameUpdate=function(){var e=+!(null!=(t=this.renderTarget)?t:this.device.backBuffer).isColorBufferSrgb(0);if(this._gammaCorrection!==e&&(this._gammaCorrection=e,this._shaderDirty=true),this._shaderDirty){this._shaderDirty=false;var t,n,i=oc[this._gammaCorrection],r=""+this.toneMapping+"-"+i+"-"+(this.bloomTexture?"bloom":"nobloom")+"-"+(this.cocTexture?"dof":"nodof")+"-"+(this.blurTextureUpscale?"dofupscale":"")+"-"+(this.ssaoTexture?"ssao":"nossao")+"-"+(this.gradingEnabled?"grading":"nograding")+"-"+(this.colorLUT?"colorlut":"nocolorlut")+"-"+(this.vignetteEnabled?"vignette":"novignette")+"-"+(this.fringingEnabled?"fringing":"nofringing")+"-"+(this.taaEnabled?"taa":"notaa")+"-"+(this.isSharpnessEnabled?"cas":"nocas")+"-"+(null!=(n=this._debug)?n:"");if(this._key!==r){this._key=r;var s=new Map;s.set("TONEMAP",oh[this.toneMapping]),s.set("GAMMA",i),this.bloomTexture&&s.set("BLOOM",true),this.cocTexture&&s.set("DOF",true),this.blurTextureUpscale&&s.set("DOF_UPSCALE",true),this.ssaoTexture&&s.set("SSAO",true),this.gradingEnabled&&s.set("GRADING",true),this.colorLUT&&s.set("COLOR_LUT",true),this.vignetteEnabled&&s.set("VIGNETTE",true),this.fringingEnabled&&s.set("FRINGING",true),this.taaEnabled&&s.set("TAA",true),this.isSharpnessEnabled&&s.set("CAS",true),this._debug&&s.set("DEBUG_COMPOSE",this._debug);var a=new Map(o0.get(this.device,this.device.isWebGPU?ni:nn));this.shader=o8.createShader(this.device,{uniqueName:"ComposeShader-"+r,attributes:{aPosition:tT},vertexChunk:"quadVS",fragmentChunk:"composePS",fragmentDefines:s,fragmentIncludes:a});}}},i.execute=function(){this.sceneTextureId.setValue(this.sceneTexture),this.sceneTextureInvResValue[0]=1/this.sceneTexture.width,this.sceneTextureInvResValue[1]=1/this.sceneTexture.height,this.sceneTextureInvResId.setValue(this.sceneTextureInvResValue),this._bloomTexture&&(this.bloomTextureId.setValue(this._bloomTexture),this.bloomIntensityId.setValue(this.bloomIntensity)),this._cocTexture&&(this.cocTextureId.setValue(this._cocTexture),this.blurTextureId.setValue(this.blurTexture)),this._ssaoTexture&&this.ssaoTextureId.setValue(this._ssaoTexture),this._gradingEnabled&&(this.bcsId.setValue([this.gradingBrightness,this.gradingContrast,this.gradingSaturation]),this.tintId.setValue([this.gradingTint.r,this.gradingTint.g,this.gradingTint.b]));var t=this._colorLUT;t&&(this.colorLUTParams[0]=t.width,this.colorLUTParams[1]=t.height,this.colorLUTParams[2]=t.height-1,this.colorLUTParams[3]=this.colorLUTIntensity,this.colorLUTParamsId.setValue(this.colorLUTParams),this.colorLUTId.setValue(t)),this._vignetteEnabled&&this.vignetterParamsId.setValue([this.vignetteInner,this.vignetteOuter,this.vignetteCurvature,this.vignetteIntensity]),this._fringingEnabled&&this.fringingIntensityId.setValue(this.fringingIntensity/1024),this.isSharpnessEnabled&&this.sharpnessId.setValue(ek.lerp(-0.125,-0.2,this.sharpness)),e.prototype.execute.call(this);},n=[{key:"debug",get:function(){return this._debug},set:function(e){this._debug!==e&&(this._debug=e,this._shaderDirty=true);}},{key:"colorLUT",get:function(){return this._colorLUT},set:function(e){this._colorLUT!==e&&(this._colorLUT=e,this._shaderDirty=true);}},{key:"bloomTexture",get:function(){return this._bloomTexture},set:function(e){this._bloomTexture!==e&&(this._bloomTexture=e,this._shaderDirty=true);}},{key:"cocTexture",get:function(){return this._cocTexture},set:function(e){this._cocTexture!==e&&(this._cocTexture=e,this._shaderDirty=true);}},{key:"ssaoTexture",get:function(){return this._ssaoTexture},set:function(e){this._ssaoTexture!==e&&(this._ssaoTexture=e,this._shaderDirty=true);}},{key:"taaEnabled",get:function(){return this._taaEnabled},set:function(e){this._taaEnabled!==e&&(this._taaEnabled=e,this._shaderDirty=true);}},{key:"gradingEnabled",get:function(){return this._gradingEnabled},set:function(e){this._gradingEnabled!==e&&(this._gradingEnabled=e,this._shaderDirty=true);}},{key:"vignetteEnabled",get:function(){return this._vignetteEnabled},set:function(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._shaderDirty=true);}},{key:"fringingEnabled",get:function(){return this._fringingEnabled},set:function(e){this._fringingEnabled!==e&&(this._fringingEnabled=e,this._shaderDirty=true);}},{key:"toneMapping",get:function(){return this._toneMapping},set:function(e){this._toneMapping!==e&&(this._toneMapping=e,this._shaderDirty=true);}},{key:"sharpness",get:function(){return this._sharpness},set:function(e){this._sharpness!==e&&(this._sharpness=e,this._shaderDirty=true);}},{key:"isSharpnessEnabled",get:function(){return this._sharpness>0}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(f1);function II(e,t){return (II=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var IL=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i){(r=e.call(this,t)||this).historyIndex=0,r.historyTexture=null,r.historyTextures=[],r.historyRenderTargets=[],r.sourceTexture=n,r.cameraComponent=i,o0.get(t,nn).set("sampleCatmullRomPS","\nvec4 SampleTextureCatmullRom(TEXTURE_ACCEPT(tex), vec2 uv, vec2 texSize) {\n	vec2 samplePos = uv * texSize;\n	vec2 texPos1 = floor(samplePos - 0.5) + 0.5;\n	vec2 f = samplePos - texPos1;\n	vec2 w0 = f * (-0.5 + f * (1.0 - 0.5 * f));\n	vec2 w1 = 1.0 + f * f * (-2.5 + 1.5 * f);\n	vec2 w2 = f * (0.5 + f * (2.0 - 1.5 * f));\n	vec2 w3 = f * f * (-0.5 + 0.5 * f);\n	vec2 w12 = w1 + w2;\n	vec2 offset12 = w2 / (w1 + w2);\n	vec2 texPos0 = (texPos1 - 1.0) / texSize;\n	vec2 texPos3 = (texPos1 + 2.0) / texSize;\n	vec2 texPos12 = (texPos1 + offset12) / texSize;\n	vec4 result = vec4(0.0);\n	result += texture2DLod(tex, vec2(texPos0.x, texPos0.y), 0.0) * w0.x * w0.y;\n	result += texture2DLod(tex, vec2(texPos12.x, texPos0.y), 0.0) * w12.x * w0.y;\n	result += texture2DLod(tex, vec2(texPos3.x, texPos0.y), 0.0) * w3.x * w0.y;\n	result += texture2DLod(tex, vec2(texPos0.x, texPos12.y), 0.0) * w0.x * w12.y;\n	result += texture2DLod(tex, vec2(texPos12.x, texPos12.y), 0.0) * w12.x * w12.y;\n	result += texture2DLod(tex, vec2(texPos3.x, texPos12.y), 0.0) * w3.x * w12.y;\n	result += texture2DLod(tex, vec2(texPos0.x, texPos3.y), 0.0) * w0.x * w3.y;\n	result += texture2DLod(tex, vec2(texPos12.x, texPos3.y), 0.0) * w12.x * w3.y;\n	result += texture2DLod(tex, vec2(texPos3.x, texPos3.y), 0.0) * w3.x * w3.y;\n	return result;\n}\n"),o0.get(t,ni).set("sampleCatmullRomPS","\nfn SampleTextureCatmullRom(tex: texture_2d<f32>, texSampler: sampler, uv: vec2f, texSize: vec2f) -> vec4f {\n	let samplePos: vec2f = uv * texSize;\n	let texPos1: vec2f = floor(samplePos - 0.5) + 0.5;\n	let f: vec2f = samplePos - texPos1;\n	let w0: vec2f = f * (-0.5 + f * (1.0 - 0.5 * f));\n	let w1: vec2f = 1.0 + f * f * (-2.5 + 1.5 * f);\n	let w2: vec2f = f * (0.5 + f * (2.0 - 1.5 * f));\n	let w3: vec2f = f * f * (-0.5 + 0.5 * f);\n	let w12: vec2f = w1 + w2;\n	let offset12: vec2f = w2 / w12;\n	let texPos0: vec2f = (texPos1 - 1.0) / texSize;\n	let texPos3: vec2f = (texPos1 + 2.0) / texSize;\n	let texPos12: vec2f = (texPos1 + offset12) / texSize;\n	var result: vec4f = vec4f(0.0);\n	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos0.x, texPos0.y), 0.0) * w0.x * w0.y;\n	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos12.x, texPos0.y), 0.0) * w12.x * w0.y;\n	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos3.x, texPos0.y), 0.0) * w3.x * w0.y;\n	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos0.x, texPos12.y), 0.0) * w0.x * w12.y;\n	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos12.x, texPos12.y), 0.0) * w12.x * w12.y;\n	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos3.x, texPos12.y), 0.0) * w3.x * w12.y;\n	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos0.x, texPos3.y), 0.0) * w0.x * w3.y;\n	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos12.x, texPos3.y), 0.0) * w12.x * w3.y;\n	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos3.x, texPos3.y), 0.0) * w3.x * w3.y;\n	return result;\n}\n"),o0.get(t,nn).set("taaResolvePS",'\n	#include  "sampleCatmullRomPS"\n	#include  "screenDepthPS"\n	uniform sampler2D sourceTexture;\n	uniform sampler2D historyTexture;\n	uniform mat4 matrix_viewProjectionPrevious;\n	uniform mat4 matrix_viewProjectionInverse;\n	uniform vec4 jitters;\n	uniform vec2 textureSize;\n	varying vec2 uv0;\n	vec2 reproject(vec2 uv, float depth) {\n		#ifndef WEBGPU\n			depth = depth * 2.0 - 1.0;\n		#endif\n		vec4 ndc = vec4(uv * 2.0 - 1.0, depth, 1.0);\n		ndc.xy -= jitters.xy;\n		vec4 worldPosition = matrix_viewProjectionInverse * ndc;\n		worldPosition /= worldPosition.w;\n		vec4 screenPrevious = matrix_viewProjectionPrevious * worldPosition;\n		return (screenPrevious.xy / screenPrevious.w) * 0.5 + 0.5;\n	}\n	vec4 colorClamp(vec2 uv, vec4 historyColor) {\n		vec3 minColor = vec3(9999.0);\n		vec3 maxColor = vec3(-9999.0);\n		for(float x = -1.0; x <= 1.0; ++x) {\n			for(float y = -1.0; y <= 1.0; ++y) {\n				vec3 color = texture2D(sourceTexture, uv + vec2(x, y) / textureSize).rgb;\n				minColor = min(minColor, color);\n				maxColor = max(maxColor, color);\n			}\n		}\n		vec3 clamped = clamp(historyColor.rgb, minColor, maxColor);\n		return vec4(clamped, historyColor.a);\n	}\n	void main()\n	{\n		vec2 uv = uv0;\n		#ifdef WEBGPU\n			uv.y = 1.0 - uv.y;\n		#endif\n		vec4 srcColor = texture2D(sourceTexture, uv);\n		float linearDepth = getLinearScreenDepth(uv0);\n		float depth = delinearizeDepth(linearDepth);\n		vec2 historyUv = reproject(uv0, depth);\n		#ifdef QUALITY_HIGH\n			vec4 historyColor = SampleTextureCatmullRom(TEXTURE_PASS(historyTexture), historyUv, textureSize);\n		#else\n			vec4 historyColor = texture2D(historyTexture, historyUv);\n		#endif\n		vec4 historyColorClamped = colorClamp(uv, historyColor);\n		float mixFactor = (historyUv.x < 0.0 || historyUv.x > 1.0 || historyUv.y < 0.0 || historyUv.y > 1.0) ?\n			1.0 : 0.05;\n		gl_FragColor = mix(historyColorClamped, srcColor, mixFactor);\n	}\n'),o0.get(t,ni).set("taaResolvePS",'\n	#include "sampleCatmullRomPS"\n	#include "screenDepthPS"\n	var sourceTexture: texture_2d<f32>;\n	var sourceTextureSampler: sampler;\n	var historyTexture: texture_2d<f32>;\n	var historyTextureSampler: sampler;\n	uniform matrix_viewProjectionPrevious: mat4x4f;\n	uniform matrix_viewProjectionInverse: mat4x4f;\n	uniform jitters: vec4f;\n	uniform textureSize: vec2f;\n	varying uv0: vec2f;\n	fn reproject(uv: vec2f, depth: f32) -> vec2f {\n		var ndc = vec4f(uv * 2.0 - 1.0, depth, 1.0);\n		ndc = vec4f(ndc.xy - uniform.jitters.xy, ndc.zw);\n		var worldPosition = uniform.matrix_viewProjectionInverse * ndc;\n		worldPosition = worldPosition / worldPosition.w;\n		let screenPrevious = uniform.matrix_viewProjectionPrevious * worldPosition;\n		return (screenPrevious.xy / screenPrevious.w) * 0.5 + 0.5;\n	}\n	fn colorClamp(uv: vec2f, historyColor: vec4f) -> vec4f {\n		var minColor = vec3f(9999.0);\n		var maxColor = vec3f(-9999.0);\n		for (var ix: i32 = -1; ix <= 1; ix = ix + 1) {\n			for (var iy: i32 = -1; iy <= 1; iy = iy + 1) {\n				let color_sample = textureSample(sourceTexture, sourceTextureSampler, uv + vec2f(f32(ix), f32(iy)) / uniform.textureSize).rgb;\n				minColor = min(minColor, color_sample);\n				maxColor = max(maxColor, color_sample);\n			}\n		}\n		let clamped = clamp(historyColor.rgb, minColor, maxColor);\n		return vec4f(clamped, historyColor.a);\n	}\n	@fragment\n	fn fragmentMain(input: FragmentInput) -> FragmentOutput {\n		var output: FragmentOutput;\n		var uv = input.uv0;\n		uv.y = 1.0 - uv.y;\n		let srcColor = textureSample(sourceTexture, sourceTextureSampler, uv);\n		let linearDepth = getLinearScreenDepth(uv0);\n		let depth = delinearizeDepth(linearDepth);\n		let historyUv = reproject(uv0, depth);\n		#ifdef QUALITY_HIGH\n			var historyColor: vec4f = SampleTextureCatmullRom(historyTexture, historyTextureSampler, historyUv, uniform.textureSize);\n		#else\n			var historyColor: vec4f = textureSample(historyTexture, historyTextureSampler, historyUv);\n		#endif\n		let historyColorClamped = colorClamp(uv, historyColor);\n		let mixFactor_condition = historyUv.x < 0.0 || historyUv.x > 1.0 || historyUv.y < 0.0 || historyUv.y > 1.0;\n		let mixFactor = select(0.05, 1.0, mixFactor_condition);\n		output.color = mix(historyColorClamped, srcColor, mixFactor);\n		return output;\n	}\n');var r,s=new Map;s.set("QUALITY_HIGH",true),o8.addScreenDepthChunkDefines(t,i.shaderParams,s),r.shader=o8.createShader(t,{uniqueName:"TaaResolveShader",attributes:{aPosition:tT},vertexChunk:"quadVS",fragmentChunk:"taaResolvePS",fragmentDefines:s});var a=t.scope;return r.sourceTextureId=a.resolve("sourceTexture"),r.textureSizeId=a.resolve("textureSize"),r.textureSize=new Float32Array(2),r.historyTextureId=a.resolve("historyTexture"),r.viewProjPrevId=a.resolve("matrix_viewProjectionPrevious"),r.viewProjInvId=a.resolve("matrix_viewProjectionInverse"),r.jittersId=a.resolve("jitters"),r.cameraParams=new Float32Array(4),r.cameraParamsId=a.resolve("camera_params"),r.setup(),r}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&II(t,e);var n=t.prototype;return n.destroy=function(){this.renderTarget&&(this.renderTarget.destroyTextureBuffers(),this.renderTarget.destroy(),this.renderTarget=null);},n.setup=function(){for(var e=0;e<2;++e)this.historyTextures[e]=new nO(this.device,{name:"TAA-History-"+e,width:4,height:4,format:this.sourceTexture.format,mipmaps:false,minFilter:1,magFilter:1,addressU:1,addressV:1}),this.historyRenderTargets[e]=new il({colorBuffer:this.historyTextures[e],depth:false});this.historyTexture=this.historyTextures[0],this.init(this.historyRenderTargets[0],{resizeSource:this.sourceTexture});},n.before=function(){this.sourceTextureId.setValue(this.sourceTexture),this.historyTextureId.setValue(this.historyTextures[1-this.historyIndex]),this.textureSize[0]=this.sourceTexture.width,this.textureSize[1]=this.sourceTexture.height,this.textureSizeId.setValue(this.textureSize);var e=this.cameraComponent.camera;this.viewProjPrevId.setValue(e._viewProjPrevious.data),this.viewProjInvId.setValue(e._viewProjInverse.data),this.jittersId.setValue(e._jitters);var t=e._farClip;this.cameraParams[0]=1/t,this.cameraParams[1]=t,this.cameraParams[2]=e._nearClip,this.cameraParams[3]=+(1===e.projection),this.cameraParamsId.setValue(this.cameraParams);},n.update=function(){return this.historyIndex=1-this.historyIndex,this.historyTexture=this.historyTextures[this.historyIndex],this.renderTarget=this.historyRenderTargets[this.historyIndex],this.historyTexture},t}(f1);function ID(e,t){return (ID=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var IM=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i){(r=e.call(this,t)||this).cameraComponent=n,o0.get(t,nn).set("cocPS",'\n	#include "screenDepthPS"\n	varying vec2 uv0;\n	uniform vec3 params;\n	void main()\n	{\n		float depth = getLinearScreenDepth(uv0);\n		float focusDistance = params.x;\n		float focusRange = params.y;\n		float invRange = params.z;\n		float farRange = focusDistance + focusRange * 0.5;\n		\n		float cocFar = min((depth - farRange) * invRange, 1.0);\n		#ifdef NEAR_BLUR\n			float nearRange = focusDistance - focusRange * 0.5;\n			float cocNear = min((nearRange - depth) * invRange, 1.0);\n		#else\n			float cocNear = 0.0;\n		#endif\n		gl_FragColor = vec4(cocFar, cocNear, 0.0, 0.0);\n	}\n'),o0.get(t,ni).set("cocPS",'\n#include "screenDepthPS"\nvarying uv0: vec2f;\nuniform params: vec3f;\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n	var output: FragmentOutput;\n	let depth: f32 = getLinearScreenDepth(uv0);\n	let focusDistance: f32 = uniform.params.x;\n	let focusRange: f32 = uniform.params.y;\n	let invRange: f32 = uniform.params.z;\n	let farRange: f32 = focusDistance + focusRange * 0.5;\n	let cocFar: f32 = min((depth - farRange) * invRange, 1.0);\n	#ifdef NEAR_BLUR\n		let nearRange: f32 = focusDistance - focusRange * 0.5;\n		var cocNear: f32 = min((nearRange - depth) * invRange, 1.0);\n	#else\n		var cocNear: f32 = 0.0;\n	#endif\n	output.color = vec4f(cocFar, cocNear, 0.0, 0.0);\n	return output;\n}\n');var r,s=new Map;return i&&s.set("NEAR_BLUR",""),o8.addScreenDepthChunkDefines(t,n.shaderParams,s),r.shader=o8.createShader(t,{uniqueName:"CocShader-"+i,attributes:{aPosition:tT},vertexChunk:"quadVS",fragmentChunk:"cocPS",fragmentDefines:s}),r.paramsId=t.scope.resolve("params"),r.paramsValue=new Float32Array(3),r.cameraParams=new Float32Array(4),r.cameraParamsId=t.scope.resolve("camera_params"),r}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&ID(t,e),t.prototype.execute=function(){var t=this.paramsValue,n=this.focusRange;t[0]=this.focusDistance+.001,t[1]=n,t[2]=1/n,this.paramsId.setValue(t);var i=this.cameraComponent.camera,r=i._farClip;this.cameraParams[0]=1/r,this.cameraParams[1]=r,this.cameraParams[2]=i._nearClip,this.cameraParams[3]=+(1===i.projection),this.cameraParamsId.setValue(this.cameraParams),e.prototype.execute.call(this);},t}(f1);function IR(e,t){return (IR=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var IO=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i,r){(s=e.call(this,t)||this).blurRadiusNear=1,s.blurRadiusFar=1,s._blurRings=3,s._blurRingPoints=3,s.nearTexture=n,s.farTexture=i,s.cocTexture=r,o0.get(t,nn).set("dofBlurPS","\n	#if defined(NEAR_BLUR)\n		uniform sampler2D nearTexture;\n	#endif\n	uniform sampler2D farTexture;\n	uniform sampler2D cocTexture;\n	uniform vec2 kernel[{KERNEL_COUNT}];\n	uniform float blurRadiusNear;\n	uniform float blurRadiusFar;\n	varying vec2 uv0;\n	void main()\n	{\n		vec2 coc = texture2D(cocTexture, uv0).rg;\n		float cocFar = coc.r;\n		vec3 sum = vec3(0.0, 0.0, 0.0);\n		#if defined(NEAR_BLUR)\n			float cocNear = coc.g;\n			if (cocNear > 0.0001) {\n				ivec2 nearTextureSize = textureSize(nearTexture, 0);\n				vec2 step = cocNear * blurRadiusNear / vec2(nearTextureSize);\n				for (int i = 0; i < {KERNEL_COUNT}; i++) {\n					vec2 uv = uv0 + step * kernel[i];\n					vec3 tap = texture2DLod(nearTexture, uv, 0.0).rgb;\n					sum += tap.rgb;\n				}\n				sum *= float({INV_KERNEL_COUNT});\n			} else\n		#endif\n			\n			if (cocFar > 0.0001) {\n			ivec2 farTextureSize = textureSize(farTexture, 0);\n			vec2 step = cocFar * blurRadiusFar / vec2(farTextureSize);\n			float sumCoC = 0.0; \n			for (int i = 0; i < {KERNEL_COUNT}; i++) {\n				vec2 uv = uv0 + step * kernel[i];\n				vec3 tap = texture2DLod(farTexture, uv, 0.0).rgb;\n				float cocThis = texture2DLod(cocTexture, uv, 0.0).r;\n				tap *= cocThis;\n				sumCoC += cocThis;\n				sum += tap;\n			}\n			if (sumCoC > 0.0)\n				sum /= sumCoC;\n			sum /= cocFar;\n		}\n		pcFragColor0 = vec4(sum, 1.0);\n	}\n"),o0.get(t,ni).set("dofBlurPS","\n#if defined(NEAR_BLUR)\n	var nearTexture: texture_2d<f32>;\n	var nearTextureSampler: sampler;\n#endif\nvar farTexture: texture_2d<f32>;\nvar farTextureSampler: sampler;\nvar cocTexture: texture_2d<f32>;\nvar cocTextureSampler: sampler;\nuniform kernel: array<vec2f, {KERNEL_COUNT}>;\nuniform blurRadiusNear: f32;\nuniform blurRadiusFar: f32;\nvarying uv0: vec2f;\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n	var output: FragmentOutput;\n	let coc: vec2f = textureSample(cocTexture, cocTextureSampler, input.uv0).rg;\n	let cocFar: f32 = coc.r;\n	var sum: vec3f = vec3f(0.0, 0.0, 0.0);\n	#if defined(NEAR_BLUR)\n		let cocNear: f32 = coc.g;\n		if (cocNear > 0.0001) {\n			let nearTextureSize: vec2f = vec2f(textureDimensions(nearTexture, 0));\n			let step: vec2f = cocNear * uniform.blurRadiusNear / nearTextureSize;\n			for (var i: i32 = 0; i < {KERNEL_COUNT}; i = i + 1) {\n				let uv: vec2f = uv0 + step * uniform.kernel[i].element;\n				let tap: vec3f = textureSampleLevel(nearTexture, nearTextureSampler, uv, 0.0).rgb;\n				sum = sum + tap;\n			}\n			sum = sum * f32({INV_KERNEL_COUNT});\n		} else\n	#endif\n		if (cocFar > 0.0001) {\n			let farTextureSize: vec2f = vec2f(textureDimensions(farTexture, 0));\n			let step: vec2f = cocFar * uniform.blurRadiusFar / farTextureSize;\n			var sumCoC: f32 = 0.0;\n			for (var i: i32 = 0; i < {KERNEL_COUNT}; i = i + 1) {\n				let uv: vec2f = uv0 + step * uniform.kernel[i].element;\n				var tap: vec3f = textureSampleLevel(farTexture, farTextureSampler, uv, 0.0).rgb;\n				let cocThis: f32 = textureSampleLevel(cocTexture, cocTextureSampler, uv, 0.0).r;\n				tap = tap * cocThis;\n				sumCoC = sumCoC + cocThis;\n				sum = sum + tap;\n			}\n			if (sumCoC > 0.0) {\n				sum = sum / sumCoC;\n			}\n			sum = sum / cocFar;\n		}\n	output.color = vec4f(sum, 1.0);\n	return output;\n}\n");var s,a=t.scope;return s.kernelId=a.resolve("kernel[0]"),s.kernelCountId=a.resolve("kernelCount"),s.blurRadiusNearId=a.resolve("blurRadiusNear"),s.blurRadiusFarId=a.resolve("blurRadiusFar"),s.nearTextureId=a.resolve("nearTexture"),s.farTextureId=a.resolve("farTexture"),s.cocTextureId=a.resolve("cocTexture"),s}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&IR(t,e);var n,i=t.prototype;return i.createShader=function(){this.kernel=new Float32Array(eH.concentric(this.blurRings,this.blurRingPoints));var e=this.kernel.length>>1,t=null!==this.nearTexture,n=new Map;n.set("{KERNEL_COUNT}",e),n.set("{INV_KERNEL_COUNT}",1/e),t&&n.set("NEAR_BLUR",""),this.shader=o8.createShader(this.device,{uniqueName:"DofBlurShader-"+e+"-"+(t?"nearBlur":"noNearBlur"),attributes:{aPosition:tT},vertexChunk:"quadVS",fragmentChunk:"dofBlurPS",fragmentDefines:n});},i.execute=function(){this.shader||this.createShader(),this.nearTextureId.setValue(this.nearTexture),this.farTextureId.setValue(this.farTexture),this.cocTextureId.setValue(this.cocTexture),this.kernelId.setValue(this.kernel),this.kernelCountId.setValue(this.kernel.length>>1),this.blurRadiusNearId.setValue(this.blurRadiusNear),this.blurRadiusFarId.setValue(this.blurRadiusFar),e.prototype.execute.call(this);},n=[{key:"blurRings",get:function(){return this._blurRings},set:function(e){this._blurRings!==e&&(this._blurRings=e,this.shader=null);}},{key:"blurRingPoints",get:function(){return this._blurRingPoints},set:function(e){this._blurRingPoints!==e&&(this._blurRingPoints=e,this.shader=null);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(f1);function Ik(e,t){return (Ik=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var IN=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i,r,s,a){(o=e.call(this,t)||this).focusDistance=100,o.focusRange=50,o.blurRadius=1,o.blurRings=3,o.blurRingPoints=3,o.highQuality=true,o.cocTexture=null,o.blurTexture=null,o.cocPass=null,o.farPass=null,o.blurPass=null,o.highQuality=s,o.cocPass=o.setupCocPass(t,n,i,a),o.beforePasses.push(o.cocPass);var o,l=s?i:r;return o.farPass=o.setupFarPass(t,l,.5),o.beforePasses.push(o.farPass),o.blurPass=o.setupBlurPass(t,r,a,s?2:.5),o.beforePasses.push(o.blurPass),o}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Ik(t,e);var n=t.prototype;return n.destroy=function(){this.destroyRenderPasses(),this.cocPass=null,this.farPass=null,this.blurPass=null,this.destroyRT(this.cocRT),this.destroyRT(this.farRt),this.destroyRT(this.blurRt),this.cocRT=null,this.farRt=null,this.blurRt=null;},n.destroyRenderPasses=function(){for(var e=0;e<this.beforePasses.length;e++)this.beforePasses[e].destroy();this.beforePasses.length=0;},n.destroyRT=function(e){e&&(e.destroyTextureBuffers(),e.destroy());},n.setupCocPass=function(e,t,n,i){this.cocRT=this.createRenderTarget("CoCTexture",i?53:52),this.cocTexture=this.cocRT.colorBuffer;var r=new IM(e,t,i);return r.init(this.cocRT,{resizeSource:n}),r.setClearColor(eN.BLACK),r},n.setupFarPass=function(e,t,n){this.farRt=this.createRenderTarget("FarDofTexture",t.format);var i=new IS(e,t,{boxFilter:true,premultiplyTexture:this.cocTexture,premultiplySrcChannel:"r"});return i.init(this.farRt,{resizeSource:t,scaleX:n,scaleY:n}),i.setClearColor(eN.BLACK),i},n.setupBlurPass=function(e,t,n,i){var r,s=null==(r=this.farRt)?void 0:r.colorBuffer;this.blurRt=this.createRenderTarget("DofBlurTexture",t.format),this.blurTexture=this.blurRt.colorBuffer;var a=new IO(e,n?t:null,s,this.cocTexture);return a.init(this.blurRt,{resizeSource:t,scaleX:i,scaleY:i}),a.setClearColor(eN.BLACK),a},n.createTexture=function(e,t){return new nO(this.device,{name:e,width:1,height:1,format:t,mipmaps:false,minFilter:1,magFilter:1,addressU:1,addressV:1})},n.createRenderTarget=function(e,t){return new il({colorBuffer:this.createTexture(e,t),depth:false,stencil:false})},n.frameUpdate=function(){e.prototype.frameUpdate.call(this),this.cocPass.focusDistance=this.focusDistance,this.cocPass.focusRange=this.focusRange,this.blurPass.blurRadiusNear=this.blurRadius,this.blurPass.blurRadiusFar=this.blurRadius*(this.highQuality?1:.5),this.blurPass.blurRings=this.blurRings,this.blurPass.blurRingPoints=this.blurRingPoints;},t}(s2);function IF(e,t){return (IF=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var IB=[],IU=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i,r,s){var a;return (a=e.call(this,t)||this).viewBindGroups=[],a.linearDepthClearValue=new eN(0,0,0,0),a.scene=n,a.renderer=i,a.camera=r,a.setupRenderTarget(s),a}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&IF(t,e);var n=t.prototype;return n.destroy=function(){var t,n;e.prototype.destroy.call(this),null==(t=this.renderTarget)||t.destroy(),this.renderTarget=null,null==(n=this.linearDepthTexture)||n.destroy(),this.linearDepthTexture=null,this.viewBindGroups.forEach(function(e){e.defaultUniformBuffer.destroy(),e.destroy();}),this.viewBindGroups.length=0;},n.setupRenderTarget=function(e){var t=this.device;this.linearDepthFormat=t.textureFloatRenderable?15:7,this.linearDepthTexture=new nO(t,{name:"SceneLinearDepthTexture",width:1,height:1,format:this.linearDepthFormat,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1});var n=new il({name:"PrepassRT",colorBuffer:this.linearDepthTexture,depth:true,samples:1});this.camera.shaderParams.sceneDepthMapLinear=true,this.init(n,e);},n.after=function(){this.device.scope.resolve("uSceneDepthMap").setValue(this.linearDepthTexture);},n.execute=function(){for(var e=this.renderer,t=this.scene,n=this.renderTarget,i=this.camera.camera,r=t.layers.layerList,s=t.layers.subLayerEnabled,a=t.layers.subLayerList,o=0;o<r.length;o++){var l=r[o];if(1===l.id)break;if(l.enabled&&s[o]&&l.camerasSet.has(i)){for(var u=l.getCulledInstances(i),c=a[o]?u.transparent:u.opaque,h=0;h<c.length;h++){var f,d=c[h];(null==(f=d.material)?void 0:f.depthWrite)&&IB.push(d);}e.renderForwardLayer(i,n,null,void 0,1,this.viewBindGroups,{meshInstances:IB}),IB.length=0;}}},n.frameUpdate=function(){e.prototype.frameUpdate.call(this);var t,n=this.camera;if(this.setClearDepth(n.clearDepthBuffer?1:void 0),n.clearDepthBuffer){var i=n.farClip-Number.MIN_VALUE;t=this.linearDepthClearValue,15===this.linearDepthFormat?t.r=i:eG.float2RGBA8(i,t);}this.setClearColor(t);},t}(s2);function Iz(e,t){return (Iz=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var IV=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i,r){(s=e.call(this,t)||this).sourceTexture=n,o0.get(t,nn).set("depthAwareBlurPS",'\n	#include "screenDepthPS"\n	varying vec2 uv0;\n	uniform sampler2D sourceTexture;\n	uniform vec2 sourceInvResolution;\n	uniform int filterSize;\n	float random(const highp vec2 w) {\n		const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);\n		return fract(m.z * fract(dot(w, m.xy)));\n	}\n	mediump float bilateralWeight(in mediump float depth, in mediump float sampleDepth) {\n		mediump float diff = (sampleDepth - depth);\n		return max(0.0, 1.0 - diff * diff);\n	}\n	void tap(inout float sum, inout float totalWeight, float weight, float depth, vec2 position) {\n		mediump float color = texture2D(sourceTexture, position).r;\n		mediump float textureDepth = -getLinearScreenDepth(position);\n	\n		mediump float bilateral = bilateralWeight(depth, textureDepth);\n		bilateral *= weight;\n		sum += color * bilateral;\n		totalWeight += bilateral;\n	}\n	void main() {\n		mediump float depth = -getLinearScreenDepth(uv0);\n		mediump float totalWeight = 1.0;\n		mediump float color = texture2D(sourceTexture, uv0 ).r;\n		mediump float sum = color * totalWeight;\n		for (mediump int i = -filterSize; i <= filterSize; i++) {\n			mediump float weight = 1.0;\n			#ifdef HORIZONTAL\n				vec2 offset = vec2(i, 0) * sourceInvResolution;\n			#else\n				vec2 offset = vec2(0, i) * sourceInvResolution;\n			#endif\n			tap(sum, totalWeight, weight, depth, uv0 + offset);\n		}\n		mediump float ao = sum / totalWeight;\n		gl_FragColor.r = ao;\n	}\n'),o0.get(t,ni).set("depthAwareBlurPS",'\n#include "screenDepthPS"\nvarying uv0: vec2f;\nvar sourceTexture: texture_2d<f32>;\nvar sourceTextureSampler: sampler;\nuniform sourceInvResolution: vec2f;\nuniform filterSize: i32;\nfn random(w: vec2f) -> f32 {\n	const m: vec3f = vec3f(0.06711056, 0.00583715, 52.9829189);\n	return fract(m.z * fract(dot(w, m.xy)));\n}\nfn bilateralWeight(depth: f32, sampleDepth: f32) -> f32 {\n	let diff: f32 = (sampleDepth - depth);\n	return max(0.0, 1.0 - diff * diff);\n}\nfn tap(sum_ptr: ptr<function, f32>, totalWeight_ptr: ptr<function, f32>, weight: f32, depth: f32, position: vec2f) {\n	let color: f32 = textureSample(sourceTexture, sourceTextureSampler, position).r;\n	let textureDepth: f32 = -getLinearScreenDepth(position);\n	let bilateral: f32 = bilateralWeight(depth, textureDepth) * weight;\n	*sum_ptr = *sum_ptr + color * bilateral;\n	*totalWeight_ptr = *totalWeight_ptr + bilateral;\n}\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n	var output: FragmentOutput;\n	let depth: f32 = -getLinearScreenDepth(input.uv0);\n	var totalWeight: f32 = 1.0;\n	let color: f32 = textureSample(sourceTexture, sourceTextureSampler, input.uv0 ).r;\n	var sum: f32 = color * totalWeight;\n	for (var i: i32 = -uniform.filterSize; i <= uniform.filterSize; i = i + 1) {\n		let weight: f32 = 1.0;\n		#ifdef HORIZONTAL\n			var offset: vec2f = vec2f(f32(i), 0.0) * uniform.sourceInvResolution;\n		#else\n			var offset: vec2f = vec2f(0.0, f32(i)) * uniform.sourceInvResolution;\n		#endif\n		tap(&sum, &totalWeight, weight, depth, input.uv0 + offset);\n	}\n	let ao: f32 = sum / totalWeight;\n	output.color = vec4f(ao, ao, ao, 1.0);\n	return output;\n}\n');var s,a=new Map;r&&a.set("HORIZONTAL",""),o8.addScreenDepthChunkDefines(t,i.shaderParams,a),s.shader=o8.createShader(t,{uniqueName:"DepthAware"+(r?"Horizontal":"Vertical")+"BlurShader",attributes:{aPosition:tT},vertexChunk:"quadVS",fragmentChunk:"depthAwareBlurPS",fragmentDefines:a});var o=s.device.scope;return s.sourceTextureId=o.resolve("sourceTexture"),s.sourceInvResolutionId=o.resolve("sourceInvResolution"),s.sourceInvResolutionValue=new Float32Array(2),s.filterSizeId=o.resolve("filterSize"),s}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Iz(t,e),t.prototype.execute=function(){this.filterSizeId.setValue(4),this.sourceTextureId.setValue(this.sourceTexture);var t=this.sourceTexture,n=t.width,i=t.height;this.sourceInvResolutionValue[0]=1/n,this.sourceInvResolutionValue[1]=1/i,this.sourceInvResolutionId.setValue(this.sourceInvResolutionValue),e.prototype.execute.call(this);},t}(f1);function IG(e,t){return (IG=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var IH=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i,r){(s=e.call(this,t)||this).radius=5,s.intensity=1,s.power=1,s.sampleCount=10,s.minAngle=5,s.randomize=false,s._scale=1,s._blueNoise=new uA(19),s.sourceTexture=n,s.cameraComponent=i,o0.get(t,nn).set("ssaoPS",'\n	#include "screenDepthPS"\n	\n	varying vec2 uv0;\n	uniform vec2 uInvResolution;\n	uniform float uAspect;\n	#define saturate(x) clamp(x,0.0,1.0)\n	highp float getWFromProjectionMatrix(const mat4 p, const vec3 v) {\n		return -v.z;\n	}\n	highp float getViewSpaceZFromW(const mat4 p, const float w) {\n		return -w;\n	}\n	const float kLog2LodRate = 3.0;\n	float random(const highp vec2 w) {\n		const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);\n		return fract(m.z * fract(dot(w, m.xy)));\n	}\n	highp vec2 getFragCoord() {\n		return gl_FragCoord.xy;\n	}\n	highp vec3 computeViewSpacePositionFromDepth(highp vec2 uv, highp float linearDepth) {\n		return vec3((0.5 - uv) * vec2(uAspect, 1.0) * linearDepth, linearDepth);\n	}\n	highp vec3 faceNormal(highp vec3 dpdx, highp vec3 dpdy) {\n		return normalize(cross(dpdx, dpdy));\n	}\n	highp vec3 computeViewSpaceNormal(const highp vec3 position) {\n		return faceNormal(dFdx(position), dFdy(position));\n	}\n	highp vec3 computeViewSpaceNormal(const highp vec3 position, const highp vec2 uv) {\n		highp vec2 uvdx = uv + vec2(uInvResolution.x, 0.0);\n		highp vec2 uvdy = uv + vec2(0.0, uInvResolution.y);\n		highp vec3 px = computeViewSpacePositionFromDepth(uvdx, -getLinearScreenDepth(uvdx));\n		highp vec3 py = computeViewSpacePositionFromDepth(uvdy, -getLinearScreenDepth(uvdy));\n		highp vec3 dpdx = px - position;\n		highp vec3 dpdy = py - position;\n		return faceNormal(dpdx, dpdy);\n	}\n	uniform vec2 uSampleCount;\n	uniform float uSpiralTurns;\n	#define PI (3.14159)\n	mediump vec3 tapLocation(mediump float i, const mediump float noise) {\n		mediump float offset = ((2.0 * PI) * 2.4) * noise;\n		mediump float angle = ((i * uSampleCount.y) * uSpiralTurns) * (2.0 * PI) + offset;\n		mediump float radius = (i + noise + 0.5) * uSampleCount.y;\n		return vec3(cos(angle), sin(angle), radius * radius);\n	}\n	highp vec2 startPosition(const float noise) {\n		float angle = ((2.0 * PI) * 2.4) * noise;\n		return vec2(cos(angle), sin(angle));\n	}\n	uniform vec2 uAngleIncCosSin;\n	highp mat2 tapAngleStep() {\n		highp vec2 t = uAngleIncCosSin;\n		return mat2(t.x, t.y, -t.y, t.x);\n	}\n	mediump vec3 tapLocationFast(mediump float i, mediump vec2 p, const mediump float noise) {\n		mediump float radius = (i + noise + 0.5) * uSampleCount.y;\n		return vec3(p, radius * radius);\n	}\n	uniform float uMaxLevel;\n	uniform float uInvRadiusSquared;\n	uniform float uMinHorizonAngleSineSquared;\n	uniform float uBias;\n	uniform float uPeak2;\n	void computeAmbientOcclusionSAO(inout mediump float occlusion, mediump float i, mediump float ssDiskRadius,\n			const highp vec2 uv, const highp vec3 origin, const mediump vec3 normal,\n			const mediump vec2 tapPosition, const float noise) {\n		mediump vec3 tap = tapLocationFast(i, tapPosition, noise);\n		mediump float ssRadius = max(1.0, tap.z * ssDiskRadius);\n		mediump vec2 uvSamplePos = uv + vec2(ssRadius * tap.xy) * uInvResolution;\n		mediump float level = clamp(floor(log2(ssRadius)) - kLog2LodRate, 0.0, float(uMaxLevel));\n		highp float occlusionDepth = -getLinearScreenDepth(uvSamplePos);\n		highp vec3 p = computeViewSpacePositionFromDepth(uvSamplePos, occlusionDepth);\n		vec3 v = p - origin;\n		float vv = dot(v, v);\n		float vn = dot(v, normal);\n		mediump float w = max(0.0, 1.0 - vv * uInvRadiusSquared);\n		w = w * w;\n		w *= step(vv * uMinHorizonAngleSineSquared, vn * vn);\n		occlusion += w * max(0.0, vn + origin.z * uBias) / (vv + uPeak2);\n	}\n	uniform float uProjectionScaleRadius;\n	uniform float uIntensity;\n	uniform float uRandomize;\n	float scalableAmbientObscurance(highp vec2 uv, highp vec3 origin, vec3 normal) {\n		float noise = random(getFragCoord()) + uRandomize;\n		highp vec2 tapPosition = startPosition(noise);\n		highp mat2 angleStep = tapAngleStep();\n		float ssDiskRadius = -(uProjectionScaleRadius / origin.z);\n		float occlusion = 0.0;\n		for (float i = 0.0; i < uSampleCount.x; i += 1.0) {\n			computeAmbientOcclusionSAO(occlusion, i, ssDiskRadius, uv, origin, normal, tapPosition, noise);\n			tapPosition = angleStep * tapPosition;\n		}\n		return occlusion;\n	}\n	uniform float uPower;\n	void main() {\n		highp vec2 uv = uv0;\n		highp float depth = -getLinearScreenDepth(uv0);\n		highp vec3 origin = computeViewSpacePositionFromDepth(uv, depth);\n		vec3 normal = computeViewSpaceNormal(origin, uv);\n		float occlusion = 0.0;\n		if (uIntensity > 0.0) {\n			occlusion = scalableAmbientObscurance(uv, origin, normal);\n		}\n		float ao = max(0.0, 1.0 - occlusion * uIntensity);\n		ao = pow(ao, uPower);\n		gl_FragColor = vec4(ao, ao, ao, 1.0);\n	}\n'),o0.get(t,ni).set("ssaoPS",'\n	#include "screenDepthPS"\n	varying uv0: vec2f;\n	uniform uInvResolution: vec2f;\n	uniform uAspect: f32;\n	fn getWFromProjectionMatrix(p: mat4x4f, v: vec3f) -> f32 {\n		return -v.z;\n	}\n	fn getViewSpaceZFromW(p: mat4x4f, w: f32) -> f32 {\n		return -w;\n	}\n	const kLog2LodRate: f32 = 3.0;\n	fn random(w: vec2f) -> f32 {\n		const m: vec3f = vec3f(0.06711056, 0.00583715, 52.9829189);\n		return fract(m.z * fract(dot(w, m.xy)));\n	}\n	fn getFragCoord() -> vec2f {\n		return pcPosition.xy;\n	}\n	fn computeViewSpacePositionFromDepth(uv: vec2f, linearDepth: f32) -> vec3f {\n		return vec3f((0.5 - uv) * vec2f(uniform.uAspect, 1.0) * linearDepth, linearDepth);\n	}\n	fn faceNormal(dpdx: vec3f, dpdy: vec3f) -> vec3f {\n		return normalize(cross(dpdx, dpdy));\n	}\n	fn computeViewSpaceNormalDeriv(position: vec3f) -> vec3f {\n		return faceNormal(dpdx(position), dpdy(position));\n	}\n	fn computeViewSpaceNormalDepth(position: vec3f, uv: vec2f) -> vec3f {\n		let uvdx: vec2f = uv + vec2f(uniform.uInvResolution.x, 0.0);\n		let uvdy: vec2f = uv + vec2f(0.0, uniform.uInvResolution.y);\n		let px: vec3f = computeViewSpacePositionFromDepth(uvdx, -getLinearScreenDepth(uvdx));\n		let py: vec3f = computeViewSpacePositionFromDepth(uvdy, -getLinearScreenDepth(uvdy));\n		let dpdx: vec3f = px - position;\n		let dpdy: vec3f = py - position;\n		return faceNormal(dpdx, dpdy);\n	}\n	uniform uSampleCount: vec2f;\n	uniform uSpiralTurns: f32;\n	const PI: f32 = 3.14159;\n	fn tapLocation(i: f32, noise: f32) -> vec3f {\n		let offset: f32 = ((2.0 * PI) * 2.4) * noise;\n		let angle: f32 = ((i * uniform.uSampleCount.y) * uniform.uSpiralTurns) * (2.0 * PI) + offset;\n		let radius: f32 = (i + noise + 0.5) * uniform.uSampleCount.y;\n		return vec3f(cos(angle), sin(angle), radius * radius);\n	}\n	fn startPosition(noise: f32) -> vec2f {\n		let angle: f32 = ((2.0 * PI) * 2.4) * noise;\n		return vec2f(cos(angle), sin(angle));\n	}\n	uniform uAngleIncCosSin: vec2f;\n	fn tapAngleStep() -> mat2x2f {\n		let t: vec2f = uniform.uAngleIncCosSin;\n		return mat2x2f(vec2f(t.x, t.y), vec2f(-t.y, t.x));\n	}\n	fn tapLocationFast(i: f32, p: vec2f, noise_in: f32) -> vec3f {\n		let radius: f32 = (i + noise_in + 0.5) * uniform.uSampleCount.y;\n		return vec3f(p.x, p.y, radius * radius);\n	}\n	uniform uMaxLevel: f32;\n	uniform uInvRadiusSquared: f32;\n	uniform uMinHorizonAngleSineSquared: f32;\n	uniform uBias: f32;\n	uniform uPeak2: f32;\n	fn computeAmbientOcclusionSAO(occlusion_ptr: ptr<function, f32>, i: f32, ssDiskRadius: f32,\n			uv: vec2f, origin: vec3f, normal: vec3f,\n			tapPosition: vec2f, noise: f32) {\n		let tap: vec3f = tapLocationFast(i, tapPosition, noise);\n		let ssRadius: f32 = max(1.0, tap.z * ssDiskRadius);\n		let uvSamplePos: vec2f = uv + (ssRadius * tap.xy) * uniform.uInvResolution;\n		let level: f32 = clamp(floor(log2(ssRadius)) - kLog2LodRate, 0.0, uniform.uMaxLevel);\n		let occlusionDepth: f32 = -getLinearScreenDepth(uvSamplePos);\n		let p: vec3f = computeViewSpacePositionFromDepth(uvSamplePos, occlusionDepth);\n		let v: vec3f = p - origin;\n		let vv: f32 = dot(v, v);\n		let vn: f32 = dot(v, normal);\n		var w_val: f32 = max(0.0, 1.0 - vv * uniform.uInvRadiusSquared);\n		w_val = w_val * w_val;\n		w_val = w_val * step(vv * uniform.uMinHorizonAngleSineSquared, vn * vn);\n		*occlusion_ptr = *occlusion_ptr + w_val * max(0.0, vn + origin.z * uniform.uBias) / (vv + uniform.uPeak2);\n	}\n	uniform uProjectionScaleRadius: f32;\n	uniform uIntensity: f32;\n	uniform uRandomize: f32;\n	fn scalableAmbientObscurance(uv: vec2f, origin: vec3f, normal: vec3f) -> f32 {\n		let noise: f32 = random(getFragCoord()) + uniform.uRandomize;\n		var tapPosition: vec2f = startPosition(noise);\n		let angleStep: mat2x2f = tapAngleStep();\n		let ssDiskRadius: f32 = -(uniform.uProjectionScaleRadius / origin.z);\n		var occlusion: f32 = 0.0;\n		for (var i: i32 = 0; i < i32(uniform.uSampleCount.x); i = i + 1) {\n			computeAmbientOcclusionSAO(&occlusion, f32(i), ssDiskRadius, uv, origin, normal, tapPosition, noise);\n			tapPosition = angleStep * tapPosition;\n		}\n		return occlusion;\n	}\n	uniform uPower: f32;\n	@fragment\n	fn fragmentMain(input: FragmentInput) -> FragmentOutput {\n		var output: FragmentOutput;\n		let uv: vec2f = input.uv0;\n		let depth: f32 = -getLinearScreenDepth(input.uv0);\n		let origin: vec3f = computeViewSpacePositionFromDepth(uv, depth);\n		let normal: vec3f = computeViewSpaceNormalDepth(origin, uv);\n		var occlusion: f32 = 0.0;\n		if (uniform.uIntensity > 0.0) {\n			occlusion = scalableAmbientObscurance(uv, origin, normal);\n		}\n		var ao: f32 = max(0.0, 1.0 - occlusion * uniform.uIntensity);\n		ao = pow(ao, uniform.uPower);\n		output.color = vec4f(ao, ao, ao, 1.0);\n		return output;\n	}\n');var s,a=new Map;o8.addScreenDepthChunkDefines(t,i.shaderParams,a),s.shader=o8.createShader(t,{uniqueName:"SsaoShader",attributes:{aPosition:tT},vertexChunk:"quadVS",fragmentChunk:"ssaoPS",fragmentDefines:a});var o=s.createRenderTarget("SsaoFinalTexture");s.ssaoTexture=o.colorBuffer,s.init(o,{resizeSource:s.sourceTexture});var l=new eN(0,0,0,0);if(s.setClearColor(l),r){var u=s.createRenderTarget("SsaoTempTexture"),c=new IV(t,o.colorBuffer,i,true);c.init(u,{resizeSource:o.colorBuffer}),c.setClearColor(l);var h=new IV(t,u.colorBuffer,i,false);h.init(o,{resizeSource:o.colorBuffer}),h.setClearColor(l),s.afterPasses.push(c),s.afterPasses.push(h);}return s.ssaoTextureId=t.scope.resolve("ssaoTexture"),s.ssaoTextureSizeInvId=t.scope.resolve("ssaoTextureSizeInv"),s}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&IG(t,e);var n,i=t.prototype;return i.destroy=function(){var t,n;if(null==(t=this.renderTarget)||t.destroyTextureBuffers(),null==(n=this.renderTarget)||n.destroy(),this.renderTarget=null,this.afterPasses.length>0){var i=this.afterPasses[0].renderTarget;null==i||i.destroyTextureBuffers(),null==i||i.destroy();}this.afterPasses.forEach(function(e){return e.destroy()}),this.afterPasses.length=0,e.prototype.destroy.call(this);},i.createRenderTarget=function(e){return new il({depth:false,colorBuffer:new nO(this.device,{name:e,width:1,height:1,format:52,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1})})},i.execute=function(){var t=this.device,n=this.sourceTexture,i=this.sampleCount,r=this.minAngle,s=this.scale,a=this.renderTarget.colorBuffer,o=a.width,l=a.height,u=t.scope;u.resolve("uAspect").setValue(o/l),u.resolve("uInvResolution").setValue([1/o,1/l]),u.resolve("uSampleCount").setValue([i,1/i]);var c=Math.sin(r*Math.PI/180);u.resolve("uMinHorizonAngleSineSquared").setValue(c*c);var h=1/(i-.5)*62.82,f=this.radius/s,d=.1*f,p=2*d*6.282*this.intensity/i,m=.5*n.height;u.resolve("uSpiralTurns").setValue(10),u.resolve("uAngleIncCosSin").setValue([Math.cos(h),Math.sin(h)]),u.resolve("uMaxLevel").setValue(0),u.resolve("uInvRadiusSquared").setValue(1/(f*f)),u.resolve("uBias").setValue(.001),u.resolve("uPeak2").setValue(d*d),u.resolve("uIntensity").setValue(p),u.resolve("uPower").setValue(this.power),u.resolve("uProjectionScaleRadius").setValue(m*f),u.resolve("uRandomize").setValue(this.randomize?this._blueNoise.value():0),e.prototype.execute.call(this);},i.after=function(){this.ssaoTextureId.setValue(this.ssaoTexture);var e=this.sourceTexture;this.ssaoTextureSizeInvId.setValue([1/e.width,1/e.height]);},n=[{key:"scale",get:function(){return this._scale},set:function(e){this._scale=e,this.scaleX=e,this.scaleY=e;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(f1);function IW(e,t){return (IW=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ij=function(){this.stencil=false,this.samples=1,this.sceneColorMap=false,this.lastGrabLayerId=2,this.lastGrabLayerIsTransparent=false,this.lastSceneLayerId=3,this.lastSceneLayerIsTransparent=true,this.taaEnabled=false,this.bloomEnabled=false,this.ssaoType=I_,this.ssaoBlurEnabled=true,this.prepassEnabled=false,this.dofEnabled=false,this.dofNearBlur=false,this.dofHighQuality=true;},IX=new Ij,IY=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i,r){var s;return void 0===r&&(r={}),(s=e.call(this,t.graphicsDevice)||this)._renderTargetScale=1,s.layersDirty=false,s.rt=null,s.app=t,s.cameraComponent=i,s.cameraFrame=n,s.options=s.sanitizeOptions(r),s.setupRenderPasses(s.options),s}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&IW(t,e);var n,i=t.prototype;return i.destroy=function(){this.reset();},i.reset=function(){this.sceneTexture=null,this.sceneTextureHalf=null,this.rt&&(this.rt.destroyTextureBuffers(),this.rt.destroy(),this.rt=null),this.rtHalf&&(this.rtHalf.destroyTextureBuffers(),this.rtHalf.destroy(),this.rtHalf=null),this.beforePasses.forEach(function(e){return e.destroy()}),this.beforePasses.length=0,this.prePass=null,this.scenePass=null,this.scenePassTransparent=null,this.colorGrabPass=null,this.composePass=null,this.bloomPass=null,this.ssaoPass=null,this.taaPass=null,this.afterPass=null,this.scenePassHalf=null,this.dofPass=null;},i.sanitizeOptions=function(e){return ((e=Object.assign({},IX,e)).taaEnabled||e.ssaoType!==I_||e.dofEnabled)&&(e.prepassEnabled=true),e},i.needsReset=function(e){var t,n,i=this.options;return e.ssaoType!==i.ssaoType||e.ssaoBlurEnabled!==i.ssaoBlurEnabled||e.taaEnabled!==i.taaEnabled||e.samples!==i.samples||e.stencil!==i.stencil||e.bloomEnabled!==i.bloomEnabled||e.prepassEnabled!==i.prepassEnabled||e.sceneColorMap!==i.sceneColorMap||e.dofEnabled!==i.dofEnabled||e.dofNearBlur!==i.dofNearBlur||e.dofHighQuality!==i.dofHighQuality||(t=e.formats)!==(n=i.formats)&&(!(Array.isArray(t)&&Array.isArray(n))||t.length!==n.length||!t.every(function(e,t){return e===n[t]}))},i.update=function(e){e=this.sanitizeOptions(e),(this.needsReset(e)||this.layersDirty)&&(this.layersDirty=false,this.reset()),this.options=e,this.sceneTexture||this.setupRenderPasses(this.options);},i.createRenderTarget=function(e,t,n,i,r){return new il({colorBuffer:new nO(this.device,{name:e,width:4,height:4,format:this.hdrFormat,mipmaps:false,minFilter:1,magFilter:1,addressU:1,addressV:1}),depth:t,stencil:n,samples:i,flipY:r})},i.setupRenderPasses=function(e){var t=this.device,n=this.cameraComponent,i=n.renderTarget;this.hdrFormat=t.getRenderableHdrFormat(e.formats,true,e.samples)||7,this._bloomEnabled=e.bloomEnabled&&7!==this.hdrFormat,this._sceneHalfEnabled=this._bloomEnabled||e.dofEnabled,n.shaderParams.ssaoEnabled=e.ssaoType===Iv;var r=!!(null==i?void 0:i.flipY);this.rt=this.createRenderTarget("SceneColor",true,e.stencil,e.samples,r),this.sceneTexture=this.rt.colorBuffer,this._sceneHalfEnabled&&(this.rtHalf=this.createRenderTarget("SceneColorHalf",false,false,1,r),this.sceneTextureHalf=this.rtHalf.colorBuffer),this.sceneOptions={resizeSource:i,scaleX:this.renderTargetScale,scaleY:this.renderTargetScale},this.createPasses(e);var s=this.collectPasses();this.beforePasses=s.filter(function(e){return null!=e});},i.collectPasses=function(){return [this.prePass,this.ssaoPass,this.scenePass,this.colorGrabPass,this.scenePassTransparent,this.taaPass,this.scenePassHalf,this.bloomPass,this.dofPass,this.composePass,this.afterPass]},i.createPasses=function(e){this.setupScenePrepass(e),this.setupSsaoPass(e);var t=this.setupScenePass(e),n=this.setupTaaPass(e);this.setupSceneHalfPass(e,n),this.setupBloomPass(e,this.sceneTextureHalf),this.setupDofPass(e,this.sceneTexture,this.sceneTextureHalf),this.setupComposePass(e),this.setupAfterPass(e,t);},i.setupScenePrepass=function(e){if(e.prepassEnabled){var t=this.app,n=this.device,i=this.cameraComponent,r=t.scene,s=t.renderer;this.prePass=new IU(n,r,s,i,this.sceneOptions);}},i.setupScenePassSettings=function(e){e.gammaCorrection=0,e.toneMapping=6;},i.setupScenePass=function(e){var t=this.app,n=this.device,i=this.cameraComponent,r=t.scene,s=t.renderer,a=r.layers;this.scenePass=new cR(n,a,r,s),this.setupScenePassSettings(this.scenePass),this.scenePass.init(this.rt,this.sceneOptions);var o=e.sceneColorMap?e.lastGrabLayerId:e.lastSceneLayerId,l=e.sceneColorMap?e.lastGrabLayerIsTransparent:e.lastSceneLayerIsTransparent,u={lastAddedIndex:0,clearRenderTarget:true};return u.lastAddedIndex=this.scenePass.addLayers(a,i,u.lastAddedIndex,u.clearRenderTarget,o,l),u.clearRenderTarget=false,e.sceneColorMap&&(this.colorGrabPass=new lz(n),this.colorGrabPass.source=this.rt,this.scenePassTransparent=new cR(n,a,r,s),this.setupScenePassSettings(this.scenePassTransparent),this.scenePassTransparent.init(this.rt),u.lastAddedIndex=this.scenePassTransparent.addLayers(a,i,u.lastAddedIndex,u.clearRenderTarget,e.lastSceneLayerId,e.lastSceneLayerIsTransparent),this.scenePassTransparent.rendersAnything||(this.scenePassTransparent.destroy(),this.scenePassTransparent=null),this.scenePassTransparent&&e.prepassEnabled&&(this.scenePassTransparent.depthStencilOps.storeDepth=true)),u},i.setupSsaoPass=function(e){var t=e.ssaoBlurEnabled,n=e.ssaoType,i=this.device,r=this.cameraComponent;n!==I_&&(this.ssaoPass=new IH(i,this.sceneTexture,r,t));},i.setupSceneHalfPass=function(e,t){this._sceneHalfEnabled&&(this.scenePassHalf=new IS(this.device,this.sceneTexture,{boxFilter:true,removeInvalid:true}),this.scenePassHalf.name="RenderPassSceneHalf",this.scenePassHalf.init(this.rtHalf,{resizeSource:t,scaleX:.5,scaleY:.5}),this.scenePassHalf.setClearColor(eN.BLACK));},i.setupBloomPass=function(e,t){this._bloomEnabled&&(this.bloomPass=new IE(this.device,t,this.hdrFormat));},i.setupDofPass=function(e,t,n){e.dofEnabled&&(this.dofPass=new IN(this.device,this.cameraComponent,t,n,e.dofHighQuality,e.dofNearBlur));},i.setupTaaPass=function(e){var t=this.sceneTexture;return e.taaEnabled&&(this.taaPass=new IL(this.device,this.sceneTexture,this.cameraComponent),t=this.taaPass.historyTexture),t},i.setupComposePass=function(e){this.composePass=new IP(this.device),this.composePass.bloomTexture=null==(t=this.bloomPass)?void 0:t.bloomTexture,this.composePass.taaEnabled=e.taaEnabled,this.composePass.cocTexture=null==(n=this.dofPass)?void 0:n.cocTexture,this.composePass.blurTexture=null==(i=this.dofPass)?void 0:i.blurTexture,this.composePass.blurTextureUpscale=!(null==(r=this.dofPass)?void 0:r.highQuality);var t,n,i,r,s=this.cameraComponent.renderTarget;this.composePass.init(s),this.composePass.ssaoTexture=e.ssaoType===Ig?this.ssaoPass.ssaoTexture:null;},i.setupAfterPass=function(e,t){var n=this.app,i=this.cameraComponent,r=n.scene,s=n.renderer,a=r.layers,o=i.renderTarget;this.afterPass=new cR(this.device,a,r,s),this.afterPass.init(o),this.afterPass.addLayers(a,i,t.lastAddedIndex,t.clearRenderTarget);},i.frameUpdate=function(){this.layersDirty&&this.cameraFrame.update(),e.prototype.frameUpdate.call(this);var t,n,i,r=null!=(i=null==(t=this.taaPass)?void 0:t.update())?i:this.rt.colorBuffer;this.composePass.sceneTexture=r,null==(n=this.scenePassHalf)||n.setSourceTexture(r);},n=[{key:"renderTargetScale",get:function(){return this._renderTargetScale},set:function(e){this._renderTargetScale=e,this.scenePass&&(this.scenePass.scaleX=e,this.scenePass.scaleY=e);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(s2),Iq=function(){function e(e,t){var n=this;this._enabled=true,this.rendering={renderFormats:[18,12,14],stencil:false,renderTargetScale:1,samples:1,sceneColorMap:false,sceneDepthMap:false,toneMapping:0,sharpness:0},this.ssao={type:I_,blurEnabled:true,randomize:false,intensity:.5,radius:30,samples:12,power:6,minAngle:10,scale:1},this.bloom={intensity:0,blurLevel:16},this.grading={enabled:false,brightness:1,contrast:1,saturation:1,tint:new eN(1,1,1,1)},this.colorLUT={texture:null,intensity:1},this.vignette={intensity:0,inner:.5,outer:1,curvature:.5},this.taa={enabled:false,jitter:1},this.fringing={intensity:0},this.dof={enabled:false,nearBlur:false,focusDistance:100,focusRange:10,blurRadius:3,blurRings:4,blurRingPoints:5,highQuality:true},this.debug=null,this.options=new Ij,this.renderPassCamera=null,this.app=e,this.cameraComponent=t,this.updateOptions(),this.enable(),this.cameraLayersChanged=t.on("set:layers",function(){n.renderPassCamera&&(n.renderPassCamera.layersDirty=true);});}var t,n=e.prototype;return n.destroy=function(){this.disable(),this.cameraLayersChanged.off();},n.enable=function(){this.renderPassCamera=this.createRenderPass(),this.cameraComponent.renderPasses=[this.renderPassCamera];},n.disable=function(){var e,t=this.cameraComponent;null==(e=t.renderPasses)||e.forEach(function(e){e.destroy();}),t.renderPasses=[],t.rendering=null,t.jitter=0,t.shaderParams.ssaoEnabled=false,this.renderPassCamera=null;},n.createRenderPass=function(){return new IY(this.app,this,this.cameraComponent,this.options)},n.updateOptions=function(){var e=this.options,t=this.rendering,n=this.bloom,i=this.taa,r=this.ssao;e.stencil=t.stencil,e.samples=t.samples,e.sceneColorMap=t.sceneColorMap,e.prepassEnabled=t.sceneDepthMap,e.bloomEnabled=n.intensity>0,e.taaEnabled=i.enabled,e.ssaoType=r.type,e.ssaoBlurEnabled=r.blurEnabled,e.formats=t.renderFormats.slice(),e.dofEnabled=this.dof.enabled,e.dofNearBlur=this.dof.nearBlur,e.dofHighQuality=this.dof.highQuality;},n.update=function(){if(this._enabled){var e=this.cameraComponent,t=this.options,n=this.renderPassCamera,i=this.rendering,r=this.bloom,s=this.grading,a=this.vignette,o=this.fringing,l=this.taa,u=this.ssao;this.updateOptions(),n.update(t);var c=n.composePass,h=n.bloomPass,f=n.ssaoPass,d=n.dofPass;n.renderTargetScale=ek.clamp(i.renderTargetScale,.1,1),c.toneMapping=i.toneMapping,c.sharpness=i.sharpness,t.bloomEnabled&&h&&(c.bloomIntensity=r.intensity,h.blurLevel=r.blurLevel),t.dofEnabled&&(d.focusDistance=this.dof.focusDistance,d.focusRange=this.dof.focusRange,d.blurRadius=this.dof.blurRadius,d.blurRings=this.dof.blurRings,d.blurRingPoints=this.dof.blurRingPoints),t.ssaoType!==I_&&(f.intensity=u.intensity,f.power=u.power,f.radius=u.radius,f.sampleCount=u.samples,f.minAngle=u.minAngle,f.scale=u.scale,f.randomize=u.randomize),c.gradingEnabled=s.enabled,s.enabled&&(c.gradingSaturation=s.saturation,c.gradingBrightness=s.brightness,c.gradingContrast=s.contrast,c.gradingTint=s.tint),c.colorLUT=this.colorLUT.texture,c.colorLUTIntensity=this.colorLUT.intensity,c.vignetteEnabled=a.intensity>0,c.vignetteEnabled&&(c.vignetteInner=a.inner,c.vignetteOuter=a.outer,c.vignetteCurvature=a.curvature,c.vignetteIntensity=a.intensity),c.fringingEnabled=o.intensity>0,c.fringingEnabled&&(c.fringingIntensity=o.intensity),e.jitter=l.enabled?l.jitter:0,c.debug=this.debug,"ssao"===c.debug&&t.ssaoType===I_&&(c.debug=null),"vignette"!==c.debug||c.vignetteEnabled||(c.debug=null);}},t=[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(e?this.enable():this.disable(),this._enabled=e);}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),IK=new eW,IZ=new e0,IQ=function(){function e(e,t,n){ void 0===e&&(e=eW.ZERO),void 0===t&&(t=eW.ZERO),void 0===n&&(n=0),this.position=new eW,this.angles=new eW,this.distance=0,this.pitchRange=new eX(-1/0,1/0),this.yawRange=new eX(-1/0,1/0),this.xRange=new eX(-1/0,1/0),this.yRange=new eX(-1/0,1/0),this.zRange=new eX(-1/0,1/0),this.set(e,t,n);}var t=e.prototype;return t.copy=function(e){return this.set(e.position,e.angles,e.distance)},t.clone=function(){return new e(this.position.clone(),this.angles.clone(),this.distance)},t.equalsApprox=function(e,t){return void 0===t&&(t=1e-6),this.position.equalsApprox(e.position,t)&&this.angles.equalsApprox(e.angles,t)&&Math.abs(this.distance-e.distance)<t},t.lerp=function(e,t,n,i,r){return void 0===i&&(i=n),void 0===r&&(r=n),this.position.lerp(e.position,t.position,n),this.angles.x=ek.lerpAngle(e.angles.x,t.angles.x,i)%360,this.angles.y=ek.lerpAngle(e.angles.y,t.angles.y,i)%360,this.angles.z=ek.lerpAngle(e.angles.z,t.angles.z,i)%360,this.distance=ek.lerp(e.distance,t.distance,r),this},t.move=function(e){return this.position.add(e),this.position.x=ek.clamp(this.position.x,this.xRange.x,this.xRange.y),this.position.y=ek.clamp(this.position.y,this.yRange.x,this.yRange.y),this.position.z=ek.clamp(this.position.z,this.zRange.x,this.zRange.y),this},t.rotate=function(e){return this.angles.add(e),this.angles.x%=360,this.angles.y%=360,this.angles.z%=360,this.angles.x=ek.clamp(this.angles.x,this.pitchRange.x,this.pitchRange.y),this.angles.y=ek.clamp(this.angles.y,this.yawRange.x,this.yawRange.y),this},t.set=function(e,t,n){return this.position.copy(e),this.angles.copy(t),this.distance=n,this},t.look=function(e,t){this.position.copy(e),this.distance=e.distance(t);var n=IK.sub2(t,e).normalize(),i=Math.atan2(-n.y,Math.sqrt(n.x*n.x+n.z*n.z))*ek.RAD_TO_DEG,r=Math.atan2(-n.x,-n.z)*ek.RAD_TO_DEG;return this.angles.set(-i,r,0),this},t.getFocus=function(e){return IZ.setFromEulerAngles(this.angles).transformVector(eW.FORWARD,e).mulScalar(this.distance).add(this.position)},e}();function IJ(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function I$(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:true,configurable:true}}),t&&I0(e,t);}function I0(e,t){return (I0=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var I1=function(){function e(e){Array.isArray(e)?this._value=e.slice():this._value=Array(+e).fill(0);}var t=e.prototype;return t.add=function(e){for(var t=0;t<this._value.length;t++)this._value[t]+=e._value[t]||0;return this},t.append=function(e){for(var t=0;t<this._value.length;t++)this._value[t]+=e[t]||0;return this},t.copy=function(e){for(var t=0;t<this._value.length;t++)this._value[t]=e._value[t]||0;return this},t.length=function(){for(var e,t=0,n=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return IJ(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return IJ(e,void 0)}}(e))){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(this._value);!(e=n()).done;){var i=e.value;t+=i*i;}return Math.sqrt(t)},t.read=function(){var e=this._value.slice();return this._value.fill(0),e},e}(),I2=function(){function e(e){for(var t in this.deltas={},e)this.deltas[t]=new I1(e[t]);}return e.prototype.read=function(){var e={};for(var t in this.deltas)e[t]=this.deltas[t].read();return e},e}(),I3=function(e){function t(){var t;return t=e.apply(this,arguments)||this,t._element=null,t._events=new ex,t}I$(t,e);var n=t.prototype;return n.on=function(e,t){this._events.on(e,t);},n.off=function(e,t){this._events.off(e,t);},n.fire=function(e){for(var t,n=arguments.length,i=Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];(t=this._events).fire.apply(t,[].concat([e],i));},n.attach=function(e){this._element&&this.detach(),this._element=e;},n.detach=function(){this._element&&(this._element=null,this.read());},n.destroy=function(){this.detach(),this._events.off();},t}(I2),I4=function(){function e(){}return e.prototype.update=function(e,t){e.read();},e}(),I5=function(e){function t(){var t;return t=e.apply(this,arguments)||this,t._pose=new IQ,t}I$(t,e);var n=t.prototype;return n.attach=function(e,t){},n.detach=function(){},n.update=function(t,n){return e.prototype.update.call(this,t,n),this._pose},n.destroy=function(){this.detach();},t}(I4),I8=new eX,I6=function(){function e(e){var t=(void 0===e?{}:e).range;this._range=70,this._position=new eX,this._value=new eX,this._range=null!=t?t:this._range;}var t,n=e.prototype;return n.down=function(e,t){return this._position.set(e,t),this._value.set(0,0),[e,t,e,t]},n.move=function(e,t){I8.set(e-this._position.x,t-this._position.y),I8.length()>this._range&&I8.normalize().mulScalar(this._range),this._value.set(ek.clamp(I8.x/this._range,-1,1),ek.clamp(I8.y/this._range,-1,1));var n=this._position,i=n.x,r=n.y;return [i,r,i+I8.x,r+I8.y]},n.up=function(){return this._position.set(0,0),this._value.set(0,0),[-1,-1,-1,-1]},t=[{key:"value",get:function(){return this._value}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function I9(e,t){return (I9=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var I7=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return (t=e.call(this,{input:[0,0],doubleTap:[0]})||this)._layout="joystick",t._pointerData=new Map,t._lastPointer={x:0,y:0,time:0},t._joystick=new I6,t._onPointerDown=t._onPointerDown.bind(t),t._onPointerMove=t._onPointerMove.bind(t),t._onPointerUp=t._onPointerUp.bind(t),t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&I9(t,e);var n,i=t.prototype;return i._onPointerDown=function(e){var t,n=e.pointerType,i=e.pointerId,r=e.clientX,s=e.clientY;if("touch"===n){null==(t=this._element)||t.setPointerCapture(i),this._pointerData.set(i,{x:r,y:s});var a=Date.now();Math.pow(this._lastPointer.x-r,2)+Math.pow(this._lastPointer.y-s,2)<100&&a-this._lastPointer.time<250&&this.deltas.doubleTap.append([1]),this._lastPointer.x=r,this._lastPointer.y=s,this._lastPointer.time=a,"joystick"===this._layout&&this.fire("joystick:position",this._joystick.down(r,s));}},i._onPointerMove=function(e){var t=e.pointerType,n=e.pointerId,i=e.target,r=e.clientX,s=e.clientY,a=e.movementX,o=e.movementY;if("touch"===t&&i===this._element){var l=this._pointerData.get(n);l&&(l.x=r,l.y=s,"joystick"===this._layout?this.fire("joystick:position",this._joystick.move(r,s)):this.deltas.input.append([a,o]));}},i._onPointerUp=function(e){var t,n=e.pointerType,i=e.pointerId;"touch"===n&&(null==(t=this._element)||t.releasePointerCapture(i),this._pointerData.get(i)&&(this._pointerData.delete(i),"joystick"===this._layout&&this.fire("joystick:position",this._joystick.up())));},i.attach=function(t){e.prototype.attach.call(this,t),this._element=t,this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("pointercancel",this._onPointerUp);},i.detach=function(){this._element&&(this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("pointercancel",this._onPointerUp),this._pointerData.clear(),e.prototype.detach.call(this));},i.read=function(){return this.deltas.input.append([this._joystick.value.x,this._joystick.value.y]),e.prototype.read.call(this)},i.destroy=function(){this._joystick.up(),e.prototype.destroy.call(this);},n=[{key:"layout",get:function(){return this._layout},set:function(e){this._layout!==e&&(this._layout=e,this.read(),this._pointerData.clear());}},{key:"joystick",get:function(){return this._joystick}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(I3);function Le(e,t){return (Le=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Lt=function(e,t){return 0===e.indexOf(t)},Ln=function(e,t){return -1!==e.indexOf(t,e.length-t.length)},Li=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t){var n;return (n=e.call(this,{leftInput:[0,0],rightInput:[0,0],doubleTap:[0]})||this)._layout="joystick-touch",n._pointerData=new Map,n._lastPointer={x:0,y:0,time:0},t&&(n.layout=t),n._leftJoystick=new I6,n._rightJoystick=new I6,n._onPointerDown=n._onPointerDown.bind(n),n._onPointerMove=n._onPointerMove.bind(n),n._onPointerUp=n._onPointerUp.bind(n),n}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Le(t,e);var n,i=t.prototype;return i._onPointerDown=function(e){var t,n=e.pointerType,i=e.pointerId,r=e.clientX,s=e.clientY;if("touch"===n){null==(t=this._element)||t.setPointerCapture(i);var a=r<.5*window.innerWidth;this._pointerData.set(i,{x:r,y:s,left:a});var o=Date.now();Math.pow(this._lastPointer.x-r,2)+Math.pow(this._lastPointer.y-s,2)<100&&o-this._lastPointer.time<250&&this.deltas.doubleTap.append([1]),this._lastPointer.x=r,this._lastPointer.y=s,this._lastPointer.time=o,a&&Lt(this._layout,"joystick")&&this.fire("joystick:position:left",this._leftJoystick.down(r,s)),!a&&Ln(this._layout,"joystick")&&this.fire("joystick:position:right",this._rightJoystick.down(r,s));}},i._onPointerMove=function(e){var t=e.pointerType,n=e.pointerId,i=e.target,r=e.clientX,s=e.clientY,a=e.movementX,o=e.movementY;if("touch"===t&&i===this._element){var l=this._pointerData.get(n);if(l){var u=l.left;l.x=r,l.y=s,u?Lt(this._layout,"joystick")?this.fire("joystick:position:left",this._leftJoystick.move(r,s)):this.deltas.leftInput.append([a,o]):Ln(this._layout,"joystick")?this.fire("joystick:position:right",this._rightJoystick.move(r,s)):this.deltas.rightInput.append([a,o]);}}},i._onPointerUp=function(e){var t,n=e.pointerType,i=e.pointerId;if("touch"===n){null==(t=this._element)||t.releasePointerCapture(i);var r=this._pointerData.get(i);if(r){var s=r.left;this._pointerData.delete(i),s&&Lt(this._layout,"joystick")&&this.fire("joystick:position:left",this._leftJoystick.up()),!s&&Ln(this._layout,"joystick")&&this.fire("joystick:position:right",this._rightJoystick.up());}}},i.attach=function(t){e.prototype.attach.call(this,t),this._element=t,this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("pointercancel",this._onPointerUp);},i.detach=function(){this._element&&(this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("pointercancel",this._onPointerUp),this._pointerData.clear(),e.prototype.detach.call(this));},i.read=function(){return this.deltas.leftInput.append([this._leftJoystick.value.x,this._leftJoystick.value.y]),this.deltas.rightInput.append([this._rightJoystick.value.x,this._rightJoystick.value.y]),e.prototype.read.call(this)},i.destroy=function(){this._leftJoystick.up(),this._rightJoystick.up(),e.prototype.destroy.call(this);},n=[{key:"layout",get:function(){return this._layout},set:function(e){this._layout!==e&&(this._layout=e,this.read(),this._pointerData.clear());}},{key:"leftJoystick",get:function(){return this._leftJoystick}},{key:"rightJoystick",get:function(){return this._rightJoystick}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(I3);function Lr(e,t){return (Lr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ls=new eX,La=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return (t=e.call(this,{touch:[0,0],count:[0],pinch:[0]})||this)._pointerEvents=new Map,t._pointerPos=new eX,t._pinchDist=-1,t._onPointerDown=t._onPointerDown.bind(t),t._onPointerMove=t._onPointerMove.bind(t),t._onPointerUp=t._onPointerUp.bind(t),t._onContextMenu=t._onContextMenu.bind(t),t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Lr(t,e);var n=t.prototype;return n._onPointerDown=function(e){var t,n=e.pointerId;"touch"===e.pointerType&&(null==(t=this._element)||t.setPointerCapture(n),this._pointerEvents.set(n,e),this.deltas.count.append([1]),this._pointerEvents.size>1&&(this._getMidPoint(this._pointerPos),this._pinchDist=this._getPinchDist()));},n._onPointerMove=function(e){var t=e.pointerType,n=e.target,i=e.pointerId,r=e.movementX,s=e.movementY;if("touch"===t&&n===this._element&&0!==this._pointerEvents.size)if(this._pointerEvents.set(i,e),this._pointerEvents.size>1){var a=this._getMidPoint(Ls);this.deltas.touch.append([a.x-this._pointerPos.x,a.y-this._pointerPos.y]),this._pointerPos.copy(a);var o=this._getPinchDist();this._pinchDist>0&&this.deltas.pinch.append([this._pinchDist-o]),this._pinchDist=o;}else this.deltas.touch.append([r,s]);},n._onPointerUp=function(e){var t,n=e.pointerType,i=e.pointerId;"touch"===n&&(null==(t=this._element)||t.releasePointerCapture(i),this._pointerEvents.delete(i),this.deltas.count.append([-1]),this._pointerEvents.size<2&&(this._pinchDist=-1),this._pointerPos.set(0,0));},n._onContextMenu=function(e){e.preventDefault();},n._getMidPoint=function(e){if(this._pointerEvents.size<2)return e.set(0,0);var t=this._pointerEvents.values(),n=t[0],i=t[1],r=n.clientX-i.clientX,s=n.clientY-i.clientY;return e.set(i.clientX+.5*r,i.clientY+.5*s)},n._getPinchDist=function(){if(this._pointerEvents.size<2)return 0;var e=this._pointerEvents.values(),t=e[0],n=e[1],i=t.clientX-n.clientX,r=t.clientY-n.clientY;return Math.sqrt(i*i+r*r)},n.attach=function(t){e.prototype.attach.call(this,t),this._element=t,this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("pointercancel",this._onPointerUp),this._element.addEventListener("contextmenu",this._onContextMenu);},n.detach=function(){this._element&&(this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("pointercancel",this._onPointerUp),this._element.removeEventListener("contextmenu",this._onContextMenu),this._pointerEvents.clear(),e.prototype.detach.call(this));},t}(I3);function Lo(e,t){return (Lo=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ll={passive:false},Lu={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,0:26,1:27,2:28,3:29,4:30,5:31,6:32,7:33,8:34,9:35,UP:36,DOWN:37,LEFT:38,RIGHT:39,SPACE:40,SHIFT:41,CTRL:42},Lc=Object.keys(Lu).length,Lh=Array(Lc).fill(0),Lf=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(n){var i,r=(void 0===n?{}:n).pointerLock,s=void 0!==r&&r;(i=e.call(this,{key:Array(Lc).fill(0),button:[0,0,0],mouse:[0,0],wheel:[0]})||this)._pointerId=-1,i._keyMap=new Map,i._keyPrev=Array(Lc).fill(0),i._keyNow=Array(Lc).fill(0),i._button=[,,,].fill(0),i._pointerLock=null!=s&&s;for(var a=t.keyCode,o=0;o<26;o++){var l="Key"+String.fromCharCode(65+o);i._keyMap.set(l,a.A+o);}for(var u=0;u<10;u++){var c="Digit"+u;i._keyMap.set(c,a["0"]+u);}return i._keyMap.set("ArrowUp",a.UP),i._keyMap.set("ArrowDown",a.DOWN),i._keyMap.set("ArrowLeft",a.LEFT),i._keyMap.set("ArrowRight",a.RIGHT),i._keyMap.set("Space",a.SPACE),i._keyMap.set("ShiftLeft",a.SHIFT),i._keyMap.set("ShiftRight",a.SHIFT),i._keyMap.set("ControlLeft",a.CTRL),i._keyMap.set("ControlRight",a.CTRL),i._onWheel=i._onWheel.bind(i),i._onPointerDown=i._onPointerDown.bind(i),i._onPointerMove=i._onPointerMove.bind(i),i._onPointerUp=i._onPointerUp.bind(i),i._onContextMenu=i._onContextMenu.bind(i),i._onKeyDown=i._onKeyDown.bind(i),i._onKeyUp=i._onKeyUp.bind(i),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Lo(t,e);var n=t.prototype;return n._onWheel=function(e){e.preventDefault(),this.deltas.wheel.append([e.deltaY]);},n._onPointerDown=function(e){var t,n;"mouse"===e.pointerType&&(this._pointerLock?document.pointerLockElement!==this._element&&(null==(t=this._element)||t.requestPointerLock()):null==(n=this._element)||n.setPointerCapture(e.pointerId),this._clearButtons(),this._button[e.button]=1,this.deltas.button.append(this._button),-1===this._pointerId&&(this._pointerId=e.pointerId));},n._onPointerMove=function(e){if("mouse"===e.pointerType&&e.target===this._element){if(this._pointerLock){if(document.pointerLockElement!==this._element)return}else if(this._pointerId!==e.pointerId)return;this.deltas.mouse.append([e.movementX,e.movementY]);}},n._onPointerUp=function(e){if("mouse"===e.pointerType){if(!this._pointerLock){var t;null==(t=this._element)||t.releasePointerCapture(e.pointerId);}this._clearButtons(),this.deltas.button.append(this._button),this._pointerId===e.pointerId&&(this._pointerId=-1);}},n._onContextMenu=function(e){e.preventDefault();},n._onKeyDown=function(e){this._pointerLock&&document.pointerLockElement!==this._element||(e.stopPropagation(),this._setKey(e.code,1));},n._onKeyUp=function(e){e.stopPropagation(),this._setKey(e.code,0);},n._clearButtons=function(){for(var e=0;e<this._button.length;e++){if(1===this._button[e]){this._button[e]=-1;continue}this._button[e]=0;}},n._setKey=function(e,t){var n;this._keyMap.has(e)&&(this._keyNow[null!=(n=this._keyMap.get(e))?n:0]=t);},n.attach=function(t){e.prototype.attach.call(this,t),this._element=t,this._element.addEventListener("wheel",this._onWheel,Ll),this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("pointercancel",this._onPointerUp),this._element.addEventListener("pointerleave",this._onPointerUp),this._element.addEventListener("contextmenu",this._onContextMenu),window.addEventListener("keydown",this._onKeyDown,false),window.addEventListener("keyup",this._onKeyUp,false);},n.detach=function(){this._element&&(this._element.removeEventListener("wheel",this._onWheel,Ll),this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("pointercancel",this._onPointerUp),this._element.removeEventListener("pointerleave",this._onPointerUp),this._element.removeEventListener("contextmenu",this._onContextMenu),window.removeEventListener("keydown",this._onKeyDown,false),window.removeEventListener("keyup",this._onKeyUp,false),this._keyNow.fill(0),this._keyPrev.fill(0),e.prototype.detach.call(this));},n.read=function(){for(var t=0;t<Lh.length;t++)Lh[t]=this._keyNow[t]-this._keyPrev[t],this._keyPrev[t]=this._keyNow[t];return this.deltas.key.append(Lh),e.prototype.read.call(this)},t}(I3);function Ld(e,t){return (Ld=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}Lf.keyCode=Lu;var Lp={A:0,B:1,X:2,Y:3,LB:4,RB:5,LT:6,RT:7,SELECT:8,START:9,LEFT_STICK:10,RIGHT_STICK:11},Lm=Object.keys(Lp).length,L_=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return (t=e.call(this,{buttons:Array(Lm).fill(0),leftStick:[0,0],rightStick:[0,0]})||this)._buttonPrev=Array(Lm).fill(0),t}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Ld(t,e),t.prototype.read=function(){for(var t=navigator.getGamepads(),n=0;n<t.length;n++){var i=t[n];if(i&&"standard"===i.mapping&&!(i.axes.length<4)&&!(i.buttons.length<Lm)){for(var r=i.buttons,s=i.axes,a=0;a<this._buttonPrev.length;a++){var o=+r[a].pressed;this.deltas.buttons[a]=o-this._buttonPrev[a],this._buttonPrev[a]=o;}this.deltas.leftStick.append([s[0],s[1]]),this.deltas.rightStick.append([s[2],s[3]]);}}return e.prototype.read.call(this)},t}(I3);L_.buttonCode=Lp;var Lv=function(e,t){return 1-Math.pow(e,1e3*t)};function Lg(e,t){return (Lg=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ly=new eW,LS=new eW,Lx=new eW,Lb=new eW,LT=new eW,LE=new e0,Lw=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return t=e.apply(this,arguments)||this,t._targetPose=new IQ,t.rotateDamping=.98,t.moveDamping=.98,t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&Lg(t,e);var n,i=t.prototype;return i.attach=function(e,t){ void 0===t&&(t=true),this._targetPose.copy(e),t||this._pose.copy(this._targetPose);},i.detach=function(){this._targetPose.copy(this._pose);},i.update=function(e,t){var n=e.read(),i=n.move,r=n.rotate;return this._targetPose.rotate(LS.set(-r[1],-r[0],0)),LE.setFromEulerAngles(this._pose.angles),LE.transformVector(eW.FORWARD,Lx),LE.transformVector(eW.RIGHT,Lb),LE.transformVector(eW.UP,LT),Ly.set(0,0,0),Ly.add(Lx.mulScalar(i[2])),Ly.add(Lb.mulScalar(i[0])),Ly.add(LT.mulScalar(i[1])),this._targetPose.move(Ly),this._pose.lerp(this._pose,this._targetPose,Lv(this.moveDamping,t),Lv(this.rotateDamping,t))},i.destroy=function(){this.detach();},n=[{key:"pitchRange",get:function(){return this._targetPose.pitchRange},set:function(e){this._targetPose.pitchRange.copy(e),this._pose.copy(this._targetPose.rotate(eW.ZERO));}},{key:"yawRange",get:function(){return this._targetPose.yawRange},set:function(e){this._targetPose.yawRange.copy(e),this._pose.copy(this._targetPose.rotate(eW.ZERO));}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(I5);function LA(e,t){return (LA=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var LC=new eW,LP=new eW,LI=new eW,LL=new e0,LD=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return t=e.apply(this,arguments)||this,t._targetRootPose=new IQ,t._rootPose=new IQ,t._targetChildPose=new IQ,t._childPose=new IQ,t.rotateDamping=.98,t.moveDamping=.98,t.zoomDamping=.98,t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&LA(t,e);var n,i=t.prototype;return i.attach=function(e,t){ void 0===t&&(t=true),this._targetRootPose.set(e.getFocus(LC),e.angles,0),this._targetChildPose.position.set(0,0,e.distance),t||(this._rootPose.copy(this._targetRootPose),this._childPose.copy(this._targetChildPose));},i.detach=function(){this._targetRootPose.copy(this._rootPose),this._targetChildPose.copy(this._childPose);},i.update=function(e,t){var n=e.read(),i=n.move,r=n.rotate;LP.set(i[0],i[1],0),LL.setFromEulerAngles(this._rootPose.angles).transformVector(LP,LP),this._targetRootPose.move(LP);var s=this._targetChildPose.position.z;return this._targetChildPose.move(LP.set(0,0,s*(1+i[2])-s)),this._targetRootPose.rotate(LI.set(-r[1],-r[0],0)),this._rootPose.lerp(this._rootPose,this._targetRootPose,Lv(this.moveDamping,t),Lv(this.rotateDamping,t),1),this._childPose.lerp(this._childPose,this._targetChildPose,Lv(this.zoomDamping,t),1,1),LL.setFromEulerAngles(this._rootPose.angles).transformVector(this._childPose.position,LP).add(this._rootPose.position),this._pose.set(LP,this._rootPose.angles,this._childPose.position.z)},i.destroy=function(){this.detach();},n=[{key:"pitchRange",get:function(){return this._targetRootPose.pitchRange},set:function(e){this._targetRootPose.pitchRange.copy(e),this._rootPose.copy(this._targetRootPose.rotate(eW.ZERO));}},{key:"yawRange",get:function(){return this._targetRootPose.yawRange},set:function(e){this._targetRootPose.yawRange.copy(e),this._rootPose.copy(this._targetRootPose.rotate(eW.ZERO));}},{key:"zoomRange",get:function(){return this._targetRootPose.zRange},set:function(e){this._targetChildPose.zRange.copy(e),this._childPose.copy(this._targetChildPose.move(eW.ZERO));}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(I5);function LM(e,t){return (LM=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var LR=new eW,LO=new eW,Lk=new e0,LN=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(){var t;return t=e.apply(this,arguments)||this,t._targetRootPose=new IQ,t._rootPose=new IQ,t._targetChildPose=new IQ,t._childPose=new IQ,t.focusDamping=.98,t}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&LM(t,e);var n=t.prototype;return n.attach=function(e,t){ void 0===t&&(t=true),this._targetRootPose.set(e.getFocus(LR),e.angles,0),this._targetChildPose.position.set(0,0,e.distance),t||(this._rootPose.copy(this._targetRootPose),this._childPose.copy(this._targetChildPose));},n.detach=function(){this._targetRootPose.copy(this._rootPose),this._targetChildPose.copy(this._childPose);},n.complete=function(){return this._targetRootPose.equalsApprox(this._rootPose,.001)&&this._targetChildPose.equalsApprox(this._childPose,.001)},n.update=function(e,t){return e.read(),this._rootPose.lerp(this._rootPose,this._targetRootPose,Lv(this.focusDamping,t),Lv(this.focusDamping,t),1),this._childPose.lerp(this._childPose,this._targetChildPose,Lv(this.focusDamping,t),1,1),Lk.setFromEulerAngles(this._rootPose.angles).transformVector(this._childPose.position,LO).add(this._rootPose.position),this._pose.set(LO,this._rootPose.angles,this._childPose.position.length())},n.destroy=function(){this.detach();},t}(I5);function LF(e,t){return (LF=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var LB=new eW,LU=new eW,Lz=new eW,LV=new eW,LG=new e$,LH=new e$,LW=new tn,Lj=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n,i){var r;return void 0===i&&(i="gizmo"),(r=e.call(this)||this)._size=1,r._scale=1,r._coordSpace="world",r._handles=[],r.nodes=[],r.intersectShapes=[],r._layer=n,r._camera=t,r._camera.layers=r._camera.layers.concat(r._layer.id),r._app=r._camera.system.app,r._device=r._app.graphicsDevice,r.root=new my(i),r._app.root.addChild(r.root),r.root.enabled=false,r._updateScale(),r._onPointerDown=r._onPointerDown.bind(r),r._onPointerMove=r._onPointerMove.bind(r),r._onPointerUp=r._onPointerUp.bind(r),r._device.canvas.addEventListener("pointerdown",r._onPointerDown),r._device.canvas.addEventListener("pointermove",r._onPointerMove),r._device.canvas.addEventListener("pointerup",r._onPointerUp),r._handles.push(r._app.on("prerender",function(){return r.prerender()})),r._handles.push(r._app.on("update",function(){return r.update()})),r._handles.push(r._app.on("destroy",function(){return r.destroy()})),r}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&LF(t,e);var n,i=t.prototype;return i._onPointerDown=function(e){if(this.enabled&&!document.pointerLockElement){var n=this._getSelection(e.offsetX,e.offsetY);n[0]&&(e.preventDefault(),e.stopPropagation()),this._device.canvas.setPointerCapture(e.pointerId),this.fire(t.EVENT_POINTERDOWN,e.offsetX,e.offsetY,n[0]);}},i._onPointerMove=function(e){if(this.enabled&&!document.pointerLockElement){var n=this._getSelection(e.offsetX,e.offsetY);n[0]&&(e.preventDefault(),e.stopPropagation()),this.fire(t.EVENT_POINTERMOVE,e.offsetX,e.offsetY,n[0]);}},i._onPointerUp=function(e){if(this.enabled&&!document.pointerLockElement){var n=this._getSelection(e.offsetX,e.offsetY);n[0]&&(e.preventDefault(),e.stopPropagation()),this._device.canvas.releasePointerCapture(e.pointerId),this.fire(t.EVENT_POINTERUP,e.offsetX,e.offsetY,n[0]);}},i._updatePosition=function(){LU.set(0,0,0);for(var e=0;e<this.nodes.length;e++){var n=this.nodes[e];LU.add(n.getPosition());}LU.mulScalar(1/(this.nodes.length||1)),1e-6>LU.distance(this.root.getLocalPosition())||(this.root.setLocalPosition(LU),this.fire(t.EVENT_POSITIONUPDATE,LU),this.fire(t.EVENT_RENDERUPDATE));},i._updateRotation=function(){Lz.set(0,0,0),"local"===this._coordSpace&&0!==this.nodes.length&&Lz.copy(this.nodes[this.nodes.length-1].getEulerAngles()),1e-6>Lz.distance(this.root.getLocalEulerAngles())||(this.root.setLocalEulerAngles(Lz),this.fire(t.EVENT_ROTATIONUPDATE,Lz),this.fire(t.EVENT_RENDERUPDATE));},i._updateScale=function(){if(0===this._camera.projection){var e=this.root.getLocalPosition(),n=this._camera.entity.getPosition(),i=e.distance(n);this._scale=Math.tan(.5*this._camera.fov*ek.DEG_TO_RAD)*i*.3;}else this._scale=.32*this._camera.orthoHeight;this._scale=Math.max(this._scale*this._size,1e-4),1e-6>Math.abs(this._scale-this.root.getLocalScale().x)||(this.root.setLocalScale(this._scale,this._scale,this._scale),this.fire(t.EVENT_SCALEUPDATE,this._scale),this.fire(t.EVENT_RENDERUPDATE));},i._getSelection=function(e,t){for(var n=this._camera.screenToWorld(e,t,0),i=this._camera.screenToWorld(e,t,this._camera.farClip-this._camera.nearClip),r=LB.copy(i).sub(n).normalize(),s=[],a=0;a<this.intersectShapes.length;a++){var o=this.intersectShapes[a];if(!o.disabled&&o.entity.enabled)for(var l=o.entity.getWorldTransform(),u=0;u<o.triData.length;u++){var c=o.triData[u],h=c.tris,f=c.transform,d=c.priority,p=LG.copy(l).mul(f),m=LH.copy(p).invert();m.transformPoint(n,LW.origin),m.transformVector(r,LW.direction),LW.direction.normalize();for(var _=0;_<h.length;_++)h[_].intersectsRay(LW,LB)&&s.push({dist:p.transformPoint(LB).sub(n).length(),meshInstances:o.meshInstances,priority:d});}}return s.length?(s.sort(function(e,t){return 0!==e.priority&&0!==t.priority?t.priority-e.priority:e.dist-t.dist}),s[0].meshInstances):[]},i.attach=function(e){if(void 0===e&&(e=[]),Array.isArray(e)){if(0===e.length)return;this.nodes=e;}else this.nodes=[e];this._updatePosition(),this._updateRotation(),this._updateScale(),this.fire(t.EVENT_NODESATTACH),this.enabled=true;},i.detach=function(){this.enabled=false,this.fire(t.EVENT_NODESDETACH),this.nodes=[];},i.prerender=function(){},i.update=function(){this._updatePosition(),this._updateRotation(),this._updateScale();},i.destroy=function(){this.detach(),this._device.canvas.removeEventListener("pointerdown",this._onPointerDown),this._device.canvas.removeEventListener("pointermove",this._onPointerMove),this._device.canvas.removeEventListener("pointerup",this._onPointerUp),this._handles.forEach(function(e){return e.off()}),this.root.destroy();},t.createLayer=function(e,t,n){ void 0===t&&(t="Gizmo"),void 0===n&&(n=e.scene.layers.layerList.length);var i=new cX({name:t,clearDepthBuffer:true,opaqueSortMode:0,transparentSortMode:0});return e.scene.layers.insert(i,n),i},n=[{key:"enabled",get:function(){return this.root.enabled},set:function(e){var n=this.root.getLocalPosition().distance(this.camera.entity.getPosition()),i=!!e&&this.nodes.length>0&&n>1e-4;i!==this.root.enabled&&(this.root.enabled=i,this.fire(t.EVENT_RENDERUPDATE));}},{key:"layer",get:function(){return this._layer},set:function(e){var t=this;this._layer!==e&&(this._camera.layers=this._camera.layers.filter(function(e){return e!==t._layer.id}),this._layer=e,this._camera.layers=this._camera.layers.concat(this._layer.id),this.enabled=true);}},{key:"camera",get:function(){return this._camera},set:function(e){var t=this;this._camera!==e&&(this._camera.layers=this._camera.layers.filter(function(e){return e!==t._layer.id}),this._camera=e,this._camera.layers=this._camera.layers.concat(this._layer.id),this.enabled=true);}},{key:"coordSpace",get:function(){return this._coordSpace},set:function(e){this._coordSpace=null!=e?e:this._coordSpace,this._updateRotation();}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._updateScale();}},{key:"facingDir",get:function(){if(0===this._camera.projection){var e=this.root.getLocalPosition(),t=this._camera.entity.getPosition();return LV.sub2(t,e).normalize()}return LV.copy(this._camera.entity.forward).mulScalar(-1)}},{key:"cameraDir",get:function(){var e=this._camera.entity.getPosition(),t=this.root.getLocalPosition();return LV.sub2(e,t).normalize()}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);Lj.EVENT_POINTERDOWN="pointer:down",Lj.EVENT_POINTERMOVE="pointer:move",Lj.EVENT_POINTERUP="pointer:up",Lj.EVENT_POSITIONUPDATE="position:update",Lj.EVENT_ROTATIONUPDATE="rotation:update",Lj.EVENT_SCALEUPDATE="scale:update",Lj.EVENT_NODESATTACH="nodes:attach",Lj.EVENT_NODESDETACH="nodes:detach",Lj.EVENT_RENDERUPDATE="render:update";var LX=Object.freeze(new eN(1,.3,.3)),LY=Object.freeze(new eN(.3,1,.3)),Lq=Object.freeze(new eN(.3,.3,1)),LK=Object.freeze(new eN(1,1,.5)),LZ=Object.freeze(new eN(.5,.5,.5,.5)),LQ=function(e,t){return new eN(e.r,e.g,e.b,t)};function LJ(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function L$(){return (L$=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);}return e}).apply(this,arguments)}function L0(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}function L1(e,t){return (L1=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function L2(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function L3(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return LJ(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return LJ(e,void 0)}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var L4=new eW,L5=new eW,L8=new eW,L6=new tn,L9=new te,L7=new eN,De=["x","y","z"],Dt=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(n,i,r){var s;return void 0===r&&(r="gizmo:transform"),(s=e.call(this,n,i,r)||this)._theme={shapeBase:{x:LQ(LX,.6),y:LQ(LY,.6),z:LQ(Lq,.6),xyz:LQ(eN.WHITE,.6),f:LQ(eN.WHITE,.6)},shapeHover:{x:LX.clone(),y:LY.clone(),z:Lq.clone(),xyz:eN.WHITE.clone(),f:LK.clone()},guideBase:{x:LX.clone(),y:LY.clone(),z:Lq.clone(),f:LK.clone()},guideOcclusion:.8,disabled:LZ.clone()},s._rootStartPos=new eW,s._rootStartRot=new e0,s._shapes={},s._shapeMap=new Map,s._hovering=new Set,s._hoverAxis="",s._hoverIsPlane=false,s._selectedAxis="",s._selectedIsPlane=false,s._selectionStartPoint=new eW,s._snap=false,s.snapIncrement=1,s.dragMode="selected",s.on(Lj.EVENT_POINTERDOWN,function(e,n,i){var r=s._shapeMap.get(i);if((null==r||!r.disabled)&&!s._dragging&&i){s._hoverAxis="",s._hoverIsPlane=false,s._selectedAxis=s._getAxis(i),s._selectedIsPlane=s._getIsPlane(i),s._rootStartPos.copy(s.root.getLocalPosition()),s._rootStartRot.copy(s.root.getRotation());var a=s._screenToPoint(e,n);s._selectionStartPoint.copy(a),s.fire(t.EVENT_TRANSFORMSTART,a,e,n);}}),s.on(Lj.EVENT_POINTERMOVE,function(e,n,i){var r=s._shapeMap.get(i);if((null==r||!r.disabled)&&(s._hover(i),s._dragging)){var a=s._screenToPoint(e,n);s.fire(t.EVENT_TRANSFORMMOVE,a,e,n);}}),s.on(Lj.EVENT_POINTERUP,function(e,n,i){s._hover(i),s._dragging&&(i&&(s._hoverAxis=s._selectedAxis,s._hoverIsPlane=s._selectedIsPlane),s._selectedAxis="",s._selectedIsPlane=false,s.fire(t.EVENT_TRANSFORMEND));}),s.on(Lj.EVENT_NODESDETACH,function(){s.snap=false,s._hoverAxis="",s._hoverIsPlane=false,s._hover(),s.fire(Lj.EVENT_POINTERUP);}),s}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&L1(t,e);var n,i=t.prototype;return i._getAxis=function(e){return e?e.node.name.split(":")[1]:""},i._getIsPlane=function(e){return !!e&&-1!==e.node.name.indexOf("plane")},i._hover=function(e){var t=this;if(!this._dragging){var n=new Set(this._hovering),i=false,r=function(e){if(n.has(e))n.delete(e);else {var r;t._hovering.add(e),null==(r=t._shapes[e])||r.hover(true),i=true;}};if(this._hoverAxis=this._getAxis(e),this._hoverIsPlane=this._getIsPlane(e),this._hoverAxis)if("xyz"===this._hoverAxis)r("x"),r("y"),r("z"),r("xyz");else if(this._hoverIsPlane)switch(this._hoverAxis){case "x":r("y"),r("z"),r("yz");break;case "y":r("x"),r("z"),r("xz");break;case "z":r("x"),r("y"),r("xy");}else r(this._hoverAxis);for(var s,a=L3(n);!(s=a()).done;){var o,l=s.value;this._hovering.delete(l),null==(o=this._shapes[l])||o.hover(false),i=true;}i&&this.fire(Lj.EVENT_RENDERUPDATE);}},i._createRay=function(e){if(0===this._camera.projection)return L6.origin.copy(this._camera.entity.getPosition()),L6.direction.sub2(e,L6.origin).normalize(),L6;var t=this._camera.farClip-this._camera.nearClip;return L6.origin.sub2(e,L4.copy(this._camera.entity.forward).mulScalar(t)),L6.direction.copy(this._camera.entity.forward),L6},i._createPlane=function(e,t,n){var i=L4.copy(this.facingDir),r=L9.normal.set(0,0,0);return t?r.copy(this._camera.entity.forward).mulScalar(-1):(r[e]=1,this._rootStartRot.transformVector(r,r),n&&(L5.cross(r,i).normalize(),r.cross(L5,r).normalize())),L9.setFromPointNormal(this._rootStartPos,r)},i._dirFromAxis=function(e,t){return "f"===e?t.copy(this._camera.entity.forward).mulScalar(-1):(t.set(0,0,0),t[e]=1),t},i._projectToAxis=function(e,t){L4.set(0,0,0),L4[t]=1,e.copy(L4.mulScalar(L4.dot(e)));var n=e[t];e.set(0,0,0),e[t]=n;},i._screenToPoint=function(e,t,n,i){ void 0===n&&(n=false),void 0===i&&(i=false);var r=this._camera.screenToWorld(e,t,1),s=this._selectedAxis,a=this._createRay(r);return !this._createPlane(s,n,i).intersectsRay(a,L8),L8},i._drawGuideLines=function(e,t,n,i){for(var r,s=L3(De);!(r=s()).done;){var a=r.value;if("xyz"===n){this._drawSpanLine(e,t,a);continue}i?a!==n&&this._drawSpanLine(e,t,a):a===n&&this._drawSpanLine(e,t,a);}},i._drawSpanLine=function(e,t,n){var i=this._dirFromAxis(n,L4),r=this._theme.guideBase[n],s=L4.copy(i).mulScalar(this._camera.farClip-this._camera.nearClip),a=L5.copy(s).mulScalar(-1);if(t.transformVector(s,s).add(e),t.transformVector(a,a).add(e),this._theme.guideOcclusion<1){var o=L7.copy(r);o.a*=1-this._theme.guideOcclusion,this._app.drawLine(s,a,o,false,this._layer);}0!==r.a&&this._app.drawLine(s,a,r,true);},i._createTransform=function(){for(var e in this._shapes){var t=this._shapes[e];this.root.addChild(t.entity),this.intersectShapes.push(t);for(var n=0;n<t.meshInstances.length;n++)this._shapeMap.set(t.meshInstances[n],t);}},i.enableShape=function(e,t){"face"===e&&(e="f");var n=this._shapes[e];n&&(n.disabled=!t);},i.isShapeEnabled=function(e){"face"===e&&(e="f");var t=this._shapes[e];return !!t&&!t.disabled},i.setTheme=function(e){var t=L$({},this._theme,e);if((void 0===t?"undefined":L2(t))==="object"&&"object"===L2(t.shapeBase)&&"object"===L2(t.shapeHover)&&"object"===L2(t.guideBase)){for(var n in t.shapeBase)L0(t.shapeBase[n],eN)&&this._theme.shapeBase[n].copy(t.shapeBase[n]);for(var i in t.shapeHover)L0(t.shapeHover[i],eN)&&this._theme.shapeHover[i].copy(t.shapeHover[i]);for(var r in t.guideBase)L0(t.guideBase[r],eN)&&this._theme.guideBase[r].copy(t.guideBase[r]);for(var s in "number"==typeof t.guideOcclusion&&(this._theme.guideOcclusion=ek.clamp(t.guideOcclusion,0,1)),L0(t.disabled,eN)&&this._theme.disabled.copy(t.disabled),this._shapes)this._shapes[s].hover(!!this._hoverAxis);}},i.prerender=function(){if(e.prototype.prerender.call(this),this.enabled){var t=this.root.getLocalPosition(),n=this.root.getRotation(),i=this._hoverAxis||this._selectedAxis,r=this._hoverIsPlane||this._selectedIsPlane;this._drawGuideLines(t,n,i,r);}},i.destroy=function(){for(var t in e.prototype.destroy.call(this),this._shapes)this._shapes[t].destroy();},n=[{key:"snap",get:function(){return this._snap},set:function(e){this._snap=this.enabled&&e;}},{key:"theme",get:function(){return this._theme}},{key:"xAxisColor",get:function(){return this._theme.shapeBase.x},set:function(e){this.setTheme({shapeBase:{x:e},shapeHover:{x:LQ(e,this.colorAlpha)},guideBase:{x:e},guideOcclusion:1});}},{key:"yAxisColor",get:function(){return this._theme.shapeBase.y},set:function(e){this.setTheme({shapeBase:{y:e},shapeHover:{y:LQ(e,this.colorAlpha)},guideBase:{y:e},guideOcclusion:1});}},{key:"zAxisColor",get:function(){return this._theme.shapeBase.z},set:function(e){this.setTheme({shapeBase:{z:e},shapeHover:{z:LQ(e,this.colorAlpha)},guideBase:{z:e},guideOcclusion:1});}},{key:"colorAlpha",get:function(){return (this._theme.shapeHover.x.a+this._theme.shapeHover.y.a+this._theme.shapeHover.z.a+this._theme.shapeHover.xyz.a+this._theme.shapeHover.f.a)/5},set:function(e){this.setTheme({shapeHover:{x:LQ(this._theme.shapeHover.x,e),y:LQ(this._theme.shapeHover.y,e),z:LQ(this._theme.shapeHover.z,e),xyz:LQ(this._theme.shapeHover.xyz,e),f:LQ(this._theme.shapeHover.f,e)}});}},{key:"_dragging",get:function(){return !this._hoverAxis&&!!this._selectedAxis}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(Lj);Dt.EVENT_TRANSFORMSTART="transform:start",Dt.EVENT_TRANSFORMMOVE="transform:move",Dt.EVENT_TRANSFORMEND="transform:end";var Dn=new eW,Di=new eW,Dr=new eW,Ds=function(){function e(e,t){ void 0===t&&(t=0),this._priority=0,this._transform=new e$,this.tris=[],this.fromGeometry(e),this._priority=t;}var t,n=e.prototype;return n.setTransform=function(e,t,n){ void 0===e&&(e=new eW),void 0===t&&(t=new e0),void 0===n&&(n=new eW),this.transform.setTRS(e,t,n);},n.fromGeometry=function(e){if(!e||(null!=h7&&"undefined"!=typeof Symbol&&h7[Symbol.hasInstance]?!h7[Symbol.hasInstance](e):!i(e,h7)))throw Error("No geometry provided.");var t,n,r=null!=(t=e.positions)?t:[],s=null!=(n=e.indices)?n:[];this.tris=[];for(var a=0;a<s.length;a+=3){var o=s[a],l=s[a+1],u=s[a+2];Dn.set(r[3*o],r[3*o+1],r[3*o+2]),Di.set(r[3*l],r[3*l+1],r[3*l+2]),Dr.set(r[3*u],r[3*u+1],r[3*u+2]);var c=new td(Dn,Di,Dr);this.tris.push(c);}},t=[{key:"transform",get:function(){return this._transform}},{key:"priority",get:function(){return this._priority}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}(),Da={uniqueName:"gizmo-unlit",attributes:{vertex_position:tT},vertexGLSL:"\n		attribute vec3 vertex_position;\n	\n		uniform mat4 matrix_model;\n		uniform mat4 matrix_viewProjection;\n	\n		void main(void) {\n			gl_Position = matrix_viewProjection * matrix_model * vec4(vertex_position, 1.0);\n			gl_Position.z = clamp(gl_Position.z, -abs(gl_Position.w), abs(gl_Position.w));\n		}\n	",fragmentGLSL:'\n		#include "gammaPS"\n	\n		precision highp float;\n	\n		uniform vec4 uColor;\n		void main(void) {\n			if (uColor.a < 1.0 / 255.0) {\n				discard;\n			}\n			gl_FragColor = vec4(gammaCorrectOutput(decodeGamma(uColor)), uColor.a);\n			#if DEPTH_WRITE == 0\n				gl_FragDepth = 0.0;\n			#endif\n		}\n	',vertexWGSL:"\n		attribute vertex_position: vec3f;\n		uniform matrix_model: mat4x4f;\n		uniform matrix_viewProjection: mat4x4f;\n		@vertex\n		fn vertexMain(input: VertexInput) -> VertexOutput {\n			var output: VertexOutput;\n			let pos = vec4f(input.vertex_position, 1.0);\n			output.position = uniform.matrix_viewProjection * uniform.matrix_model * pos;\n			output.position.z = clamp(output.position.z, -abs(output.position.w), abs(output.position.w));\n			return output;\n		}\n	",fragmentWGSL:'\n		#include "gammaPS"\n		uniform uColor: vec4f;\n		@fragment\n		fn fragmentMain(input: FragmentInput) -> FragmentOutput {\n			var output: FragmentOutput;\n			if (uniform.uColor.a < 1.0 / 255.0) {\n				discard;\n			}\n			output.color = vec4f(gammaCorrectOutput(decodeGamma(uniform.uColor)), uniform.uColor.a);\n			#if DEPTH_WRITE == 0\n				output.fragDepth = 0.0;\n			#endif\n			return output;\n		}\n	'};function Do(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):i(e,t)}var Dl=new h7;Dl.positions=[],Dl.normals=[];var Du=function(){function e(e,t,n){var i,r,s,a;this._position=new eW,this._rotation=new eW,this._scale=new eW(1,1,1),this._layers=[],this._material=new h3(Da),this._disabled=false,this._visible=true,this._defaultColor=eN.WHITE,this._hoverColor=eN.BLACK,this._disabledColor=LZ,this._cull=1,this.triData=[],this.meshInstances=[],this.device=e,this.axis=null!=(i=n.axis)?i:"x",Do(n.position,eW)&&this._position.copy(n.position),Do(n.rotation,eW)&&this._rotation.copy(n.rotation),Do(n.scale,eW)&&this._scale.copy(n.scale),this._disabled=null!=(r=n.disabled)&&r,this._visible=null!=(s=n.hidden)&&s,this._layers=null!=(a=n.layers)?a:this._layers,Do(n.defaultColor,eN)&&(this._defaultColor=n.defaultColor),Do(n.hoverColor,eN)&&(this._hoverColor=n.hoverColor),Do(n.disabledColor,eN)&&(this._disabledColor=n.disabledColor),this.entity=new my(t+":"+this.axis),this.entity.setLocalPosition(this._position),this.entity.setLocalEulerAngles(this._rotation),this.entity.setLocalScale(this._scale);}var t,n=e.prototype;return n._createRenderComponent=function(e,t){var n=this._disabled?this._disabledColor:this._defaultColor;this._material.setParameter("uColor",n.toArray()),this._material.cull=this._cull,this._material.blendType=2,this._material.update();for(var i=[],r=0;r<t.length;r++){var s=new lL(t[r],this._material);s.cull=false,i.push(s),this.meshInstances.push(s);}e.addComponent("render",{meshInstances:i,layers:this._layers,castShadows:false});},n._update=function(){this.entity.setLocalPosition(this._position),this.entity.setLocalEulerAngles(this._rotation),this.entity.setLocalScale(this._scale);},n.hover=function(e){var t=this._disabled?this._disabledColor:e?this._hoverColor:this._defaultColor;this._material.setParameter("uColor",t.toArray());},n.destroy=function(){this.entity.destroy();},t=[{key:"disabled",get:function(){return this._disabled},set:function(e){this._disabled=null!=e&&e,this.hover(false);}},{key:"visible",get:function(){return this._visible},set:function(e){if(e!==this._visible){for(var t=0;t<this.meshInstances.length;t++)this.meshInstances[t].visible=e;this._visible=e;}}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(e.prototype,t),e}();function Dc(e,t){return (Dc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Dh=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(t,n){var i,r,s;return void 0===n&&(n={}),(i=e.call(this,t,"plane",n)||this)._cull=0,i._size=.2,i._gap=.1,i._flipped=new eW,i._size=null!=(r=n.size)?r:i._size,i._gap=null!=(s=n.gap)?s:i._gap,i.triData=[new Ds(new dj)],i._createRenderComponent(i.entity,[l_.fromGeometry(i.device,new dj)]),i._update(),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:true,configurable:true}}),e&&Dc(n,e),n.prototype._update=function(){var e=this._size/2+this._gap;this._position.set(this._flipped.x?-e:e,this._flipped.y?-e:e,this._flipped.z?-e:e),this._position[this.axis]=0,this.entity.setLocalPosition(this._position),this.entity.setLocalEulerAngles(this._rotation),this.entity.setLocalScale(this._size,this._size,this._size);},t=[{key:"size",get:function(){return this._size},set:function(e){this._size=null!=e?e:this._size,this._update();}},{key:"gap",get:function(){return this._gap},set:function(e){this._gap=null!=e?e:this._gap,this._update();}},{key:"flipped",get:function(){return this._flipped},set:function(e){1e-6>this._flipped.distance(e)||(this._flipped.copy(e),this._update());}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(n.prototype,t),n}(Du);function Df(e,t){return (Df=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Dd=new eW,Dp=new eW,Dm=new e0,D_=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(t,n){var i,r,s,a,o,l,u;return void 0===n&&(n={}),(i=e.call(this,t,"arrow",n)||this)._gap=0,i._lineThickness=.02,i._lineLength=.5,i._arrowThickness=.12,i._arrowLength=.18,i._tolerance=.1,i._flipped=false,i._gap=null!=(r=n.gap)?r:i._gap,i._lineThickness=null!=(s=n.lineThickness)?s:i._lineThickness,i._lineLength=null!=(a=n.lineLength)?a:i._lineLength,i._arrowThickness=null!=(o=n.arrowThickness)?o:i._arrowThickness,i._arrowLength=null!=(l=n.arrowLength)?l:i._arrowLength,i._tolerance=null!=(u=n.tolerance)?u:i._tolerance,i.triData=[new Ds(new dV),new Ds(new dH,1)],i._head=new my("head:"+i.axis),i.entity.addChild(i._head),i._createRenderComponent(i._head,[l_.fromGeometry(i.device,new dV)]),i._line=new my("line:"+i.axis),i.entity.addChild(i._line),i._createRenderComponent(i._line,[l_.fromGeometry(i.device,new dH)]),i._update(),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:true,configurable:true}}),e&&Df(n,e),n.prototype._update=function(){Dd.set(0,this._gap+.5*this._arrowLength+this._lineLength,0),Dm.set(0,0,0,1),Dp.set(this._arrowThickness,this._arrowLength,this._arrowThickness),this.triData[0].setTransform(Dd,Dm,Dp),Dd.set(0,this._gap+.5*this._lineLength,0),Dm.set(0,0,0,1),Dp.set(this._lineThickness+this._tolerance,this._lineLength,this._lineThickness+this._tolerance),this.triData[1].setTransform(Dd,Dm,Dp),this._head.setLocalPosition(0,this._gap+.5*this._arrowLength+this._lineLength,0),this._head.setLocalScale(this._arrowThickness,this._arrowLength,this._arrowThickness),this._line.setLocalPosition(0,this._gap+.5*this._lineLength,0),this._line.setLocalScale(this._lineThickness,this._lineLength,this._lineThickness);},t=[{key:"gap",get:function(){return this._gap},set:function(e){this._gap=null!=e?e:this._gap,this._update();}},{key:"lineThickness",get:function(){return this._lineThickness},set:function(e){this._lineThickness=null!=e?e:this._lineThickness,this._update();}},{key:"lineLength",get:function(){return this._lineLength},set:function(e){this._lineLength=null!=e?e:this._lineLength,this._update();}},{key:"arrowThickness",get:function(){return this._arrowThickness},set:function(e){this._arrowThickness=null!=e?e:this._arrowThickness,this._update();}},{key:"arrowLength",get:function(){return this._arrowLength},set:function(e){this._arrowLength=null!=e?e:this._arrowLength,this._update();}},{key:"tolerance",get:function(){return this._tolerance},set:function(e){this._tolerance=e,this._update();}},{key:"flipped",get:function(){return this._flipped},set:function(e){this._flipped!==e&&(this._flipped=e,this._rotation.equals(eW.ZERO)?Dd.set(0,0,180*!!this._flipped):Dd.copy(this._rotation).mulScalar(this._flipped?-1:1),this._line.enabled=!this._flipped,this.entity.setLocalEulerAngles(Dd));}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(n.prototype,t),n}(Du);function Dv(e,t){return (Dv=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Dg=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(t,n){var i,r,s;return void 0===n&&(n={}),(i=e.call(this,t,"sphereCenter",n)||this)._radius=.06,i._tolerance=.05,i._radius=null!=(r=n.radius)?r:i._radius,i._tolerance=null!=(s=n.tolerance)?s:i._tolerance,i.triData=[new Ds(new fi,2)],i._createRenderComponent(i.entity,[l_.fromGeometry(i.device,new fi({latitudeBands:32,longitudeBands:32}))]),i._update(),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:true,configurable:true}}),e&&Dv(n,e),n.prototype._update=function(){var e=2*this._radius;this.entity.setLocalScale(e,e,e);},t=[{key:"radius",get:function(){return this._radius},set:function(e){this._radius=null!=e?e:this._radius,this._update();}},{key:"tolerance",get:function(){return this._tolerance},set:function(e){this._tolerance=null!=e?e:this._tolerance,this._update();}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(n.prototype,t),n}(Du);function Dy(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function DS(e,t){return (DS=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Dx=new eW,Db=new eW,DT=new eW,DE=new eW,Dw=new e0,DA=["x","y","z"],DC=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n,"gizmo:translate")||this)._shapes={xyz:new Dg(i._device,{axis:"xyz",layers:[i._layer.id],defaultColor:i._theme.shapeBase.xyz,hoverColor:i._theme.shapeHover.xyz,disabledColor:i._theme.disabled}),yz:new Dh(i._device,{axis:"x",layers:[i._layer.id],rotation:new eW(0,0,-90),defaultColor:i._theme.shapeBase.x,hoverColor:i._theme.shapeHover.x,disabledColor:i._theme.disabled}),xz:new Dh(i._device,{axis:"y",layers:[i._layer.id],rotation:new eW(0,0,0),defaultColor:i._theme.shapeBase.y,hoverColor:i._theme.shapeHover.y,disabledColor:i._theme.disabled}),xy:new Dh(i._device,{axis:"z",layers:[i._layer.id],rotation:new eW(90,0,0),defaultColor:i._theme.shapeBase.z,hoverColor:i._theme.shapeHover.z,disabledColor:i._theme.disabled}),x:new D_(i._device,{axis:"x",layers:[i._layer.id],rotation:new eW(0,0,-90),defaultColor:i._theme.shapeBase.x,hoverColor:i._theme.shapeHover.x,disabledColor:i._theme.disabled}),y:new D_(i._device,{axis:"y",layers:[i._layer.id],rotation:new eW(0,0,0),defaultColor:i._theme.shapeBase.y,hoverColor:i._theme.shapeHover.y,disabledColor:i._theme.disabled}),z:new D_(i._device,{axis:"z",layers:[i._layer.id],rotation:new eW(90,0,0),defaultColor:i._theme.shapeBase.z,hoverColor:i._theme.shapeHover.z,disabledColor:i._theme.disabled})},i._nodeLocalPositions=new Map,i._nodePositions=new Map,i.snapIncrement=1,i.flipAxes=true,i.flipPlanes=true,i._createTransform(),i.on(Dt.EVENT_TRANSFORMSTART,function(){i._storeNodePositions(),i._drag(true);}),i.on(Dt.EVENT_TRANSFORMMOVE,function(e){var t=DE.copy(e).sub(i._selectionStartPoint);i.snap&&(t.mulScalar(1/i.snapIncrement),t.round(),t.mulScalar(i.snapIncrement)),i._setNodePositions(t);}),i.on(Dt.EVENT_TRANSFORMEND,function(){i._drag(false);}),i.on(Dt.EVENT_NODESDETACH,function(){i._nodeLocalPositions.clear(),i._nodePositions.clear();}),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&DS(t,e);var n,i=t.prototype;return i._setArrowProp=function(e,t){this._shapes.x[e]=t,this._shapes.y[e]=t,this._shapes.z[e]=t;},i._setPlaneProp=function(e,t){this._shapes.yz[e]=t,this._shapes.xz[e]=t,this._shapes.xy[e]=t;},i._shapesLookAtCamera=function(){var e=this.cameraDir,t=e.dot(this.root.right);this._shapes.x.entity.enabled=1-Math.abs(t)>.01,this.flipAxes&&(this._shapes.x.flipped=t<0),t=e.dot(this.root.up),this._shapes.y.entity.enabled=1-Math.abs(t)>.01,this.flipAxes&&(this._shapes.y.flipped=t<0),t=e.dot(this.root.forward),this._shapes.z.entity.enabled=1-Math.abs(t)>.01,this.flipAxes&&(this._shapes.z.flipped=t>0),Dx.cross(e,this.root.right),this._shapes.yz.entity.enabled=1-Dx.length()>.01,this.flipPlanes&&(this._shapes.yz.flipped=Db.set(0,+(0>Dx.dot(this.root.forward)),+(0>Dx.dot(this.root.up)))),Dx.cross(e,this.root.forward),this._shapes.xy.entity.enabled=1-Dx.length()>.01,this.flipPlanes&&(this._shapes.xy.flipped=Db.set(+(0>Dx.dot(this.root.up)),+(Dx.dot(this.root.right)>0),0)),Dx.cross(e,this.root.up),this._shapes.xz.entity.enabled=1-Dx.length()>.01,this.flipPlanes&&(this._shapes.xz.flipped=Db.set(+(Dx.dot(this.root.forward)>0),0,+(Dx.dot(this.root.right)>0)));},i._drag=function(e){for(var t in this._shapes){var n=this._shapes[t];switch(this.dragMode){case "show":continue;case "hide":n.visible=!e;continue;case "selected":if("xyz"===this._selectedAxis){n.visible=!e||1===t.length;continue}if(this._selectedIsPlane){n.visible=!e||1===t.length&&!t.includes(this._selectedAxis);continue}n.visible=!e||t===this._selectedAxis;}}this.fire(Dt.EVENT_RENDERUPDATE);},i._storeNodePositions=function(){for(var e=0;e<this.nodes.length;e++){var t=this.nodes[e];this._nodeLocalPositions.set(t,t.getLocalPosition().clone()),this._nodePositions.set(t,t.getPosition().clone());}},i._setNodePositions=function(e){for(var t=0;t<this.nodes.length;t++){var n=this.nodes[t];if("local"===this._coordSpace){var i,r=this._nodeLocalPositions.get(n);if(!r)continue;Dx.copy(e),null==(i=n.parent)||i.getWorldTransform().getScale(Db),Db.x=1/Db.x,Db.y=1/Db.y,Db.z=1/Db.z,Dw.copy(n.getLocalRotation()).transformVector(Dx,Dx),Dx.mul(Db),n.setLocalPosition(Dx.add(r));}else {var s=this._nodePositions.get(n);if(!s)continue;n.setPosition(Dx.copy(e).add(s));}}this._updatePosition();},i._screenToPoint=function(e,t){var n=this._camera.screenToWorld(e,t,1),i=this._selectedAxis,r=this._selectedIsPlane,s=this._createRay(n);return this._createPlane(i,"xyz"===i,!r).intersectsRay(s,DT)&&(Dw.copy(this._rootStartRot).invert().transformVector(DT,DT),r||"xyz"===i||this._projectToAxis(DT,i)),DT},i._drawGuideLines=function(e,t,n,i){for(var r,s=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return (n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Dy(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Dy(e,void 0)}}(e))){n&&(e=n);var i=0;return function(){return i>=e.length?{done:true}:{done:false,value:e[i++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(DA);!(r=s()).done;){var a=r.value;if(this._dragging||"xyz"===n){this._drawSpanLine(e,t,a);continue}i?a!==n&&this._drawSpanLine(e,t,a):a===n&&this._drawSpanLine(e,t,a);}},i.prerender=function(){e.prototype.prerender.call(this),this.enabled&&this._shapesLookAtCamera();},n=[{key:"axisGap",get:function(){return this._shapes.x.gap},set:function(e){this._setArrowProp("gap",e);}},{key:"axisLineThickness",get:function(){return this._shapes.x.lineThickness},set:function(e){this._setArrowProp("lineThickness",e);}},{key:"axisLineLength",get:function(){return this._shapes.x.lineLength},set:function(e){this._setArrowProp("lineLength",e);}},{key:"axisLineTolerance",get:function(){return this._shapes.x.tolerance},set:function(e){this._setArrowProp("tolerance",e);}},{key:"axisArrowThickness",get:function(){return this._shapes.x.arrowThickness},set:function(e){this._setArrowProp("arrowThickness",e);}},{key:"axisArrowLength",get:function(){return this._shapes.x.arrowLength},set:function(e){this._setArrowProp("arrowLength",e);}},{key:"axisPlaneSize",get:function(){return this._shapes.yz.size},set:function(e){this._setPlaneProp("size",e);}},{key:"axisPlaneGap",get:function(){return this._shapes.yz.gap},set:function(e){this._setPlaneProp("gap",e);}},{key:"axisCenterSize",get:function(){return this._shapes.xyz.radius},set:function(e){this._shapes.xyz.radius=e;}},{key:"axisCenterTolerance",get:function(){return this._shapes.xyz.tolerance},set:function(e){this._shapes.xyz.tolerance=e;}},{key:"flipShapes",get:function(){return this.flipAxes&&this.flipPlanes},set:function(e){this.flipAxes=e,this.flipPlanes=e;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(Dt);function DP(e,t){return (DP=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var DI=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i,r,s,a;return void 0===n&&(n={}),(i=e.call(this,t,"disk",n)||this)._tubeRadius=.01,i._ringRadius=.5,i._sectorAngle=360,i._tolerance=.05,i._tubeRadius=null!=(r=n.tubeRadius)?r:i._tubeRadius,i._ringRadius=null!=(s=n.ringRadius)?s:i._ringRadius,i._sectorAngle=null!=(a=n.sectorAngle)?a:i._sectorAngle,i._triDataCache=[new Ds(i._createTorusGeometry(i._sectorAngle)),new Ds(i._createTorusGeometry(360))],i.triData=[i._triDataCache[0]],i._createRenderComponent(i.entity,[i._createTorusMesh(i._sectorAngle),i._createTorusMesh(360)]),i.show("sector"),i._update(),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&DP(t,e);var n,i=t.prototype;return i._createTorusGeometry=function(e){return new dY({tubeRadius:this._tubeRadius+this._tolerance,ringRadius:this._ringRadius,sectorAngle:e,segments:20})},i._createTorusMesh=function(e){var t=new dY({tubeRadius:this._tubeRadius,ringRadius:this._ringRadius,sectorAngle:e,segments:80});return l_.fromGeometry(this.device,t)},i._update=function(){this._triDataCache[0].fromGeometry(this._createTorusGeometry(this._sectorAngle)),this._triDataCache[1].fromGeometry(this._createTorusGeometry(360)),this.meshInstances[0].mesh=this._createTorusMesh(this._sectorAngle),this.meshInstances[1].mesh=this._createTorusMesh(360);},i.show=function(e){switch(e){case "sector":this.triData[0]=this._triDataCache[0],this.meshInstances[0].visible=true,this.meshInstances[1].visible=false;break;case "ring":this.triData[0]=this._triDataCache[1],this.meshInstances[0].visible=false,this.meshInstances[1].visible=true;break;case "none":this.meshInstances[0].visible=false,this.meshInstances[1].visible=false;}},n=[{key:"tubeRadius",get:function(){return this._tubeRadius},set:function(e){this._tubeRadius=null!=e?e:this._tubeRadius,this._update();}},{key:"ringRadius",get:function(){return this._ringRadius},set:function(e){this._ringRadius=null!=e?e:this._ringRadius,this._update();}},{key:"tolerance",get:function(){return this._tolerance},set:function(e){this._tolerance=null!=e?e:this._tolerance,this._update();}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(Du),DL=new eW,DD=function(){var e;function t(e,t,n){ void 0===n&&(n={}),this._thickness=.02,this._material=new h3(Da),this.entity=new my("mesh-line"),this._thickness=null!=(i=n.thickness)?i:this._thickness,this._material.blendState=nj.ALPHABLEND,this._material.setDefine("DEPTH_WRITE","0"),this._material.update();var i,r=new lL(l_.fromGeometry(e.graphicsDevice,new dH),this._material);this.entity.addComponent("render",{meshInstances:[r],layers:[t.id]});}return t.prototype.draw=function(e,t,n,i){this._material.setParameter("uColor",i.toArray());var r=DL.sub2(t,e).normalize(),s=Math.atan2(-r.y,Math.sqrt(r.x*r.x+r.z*r.z))*ek.RAD_TO_DEG,a=Math.atan2(-r.x,-r.z)*ek.RAD_TO_DEG;this.entity.setLocalEulerAngles(-s+90,a,0);var o=e.distance(t)*n;this.entity.setLocalPosition(r.mulScalar(.5*o).add(e)),this.entity.setLocalScale(this._thickness*n,o,this._thickness*n);},e=[{key:"thickness",get:function(){return this._thickness},set:function(e){this._thickness=null!=e?e:this._thickness;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,e),t}();function DM(e,t){return (DM=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var DR=new eW,DO=new eW,Dk=new eW,DN=new eW,DF=new eW,DB=new e0,DU=new e0,Dz=new eN,DV=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n,"gizmo:rotate")||this)._shapes={z:new DI(i._device,{axis:"z",layers:[i._layer.id],rotation:new eW(90,0,90),defaultColor:i._theme.shapeBase.z,hoverColor:i._theme.shapeHover.z,disabledColor:i._theme.disabled,sectorAngle:180}),x:new DI(i._device,{axis:"x",layers:[i._layer.id],rotation:new eW(0,0,-90),defaultColor:i._theme.shapeBase.x,hoverColor:i._theme.shapeHover.x,disabledColor:i._theme.disabled,sectorAngle:180}),y:new DI(i._device,{axis:"y",layers:[i._layer.id],rotation:new eW(0,0,0),defaultColor:i._theme.shapeBase.y,hoverColor:i._theme.shapeHover.y,disabledColor:i._theme.disabled,sectorAngle:180}),f:new DI(i._device,{axis:"f",layers:[i._layer.id],defaultColor:i._theme.shapeBase.f,hoverColor:i._theme.shapeHover.f,disabledColor:i._theme.disabled,ringRadius:.55})},i._selectionStartAngle=0,i._nodeLocalRotations=new Map,i._nodeRotations=new Map,i._nodeOffsets=new Map,i._guideAngleStart=new eW,i._guideAngleEnd=new eW,i.snapIncrement=5,i.orbitRotation=false,i._createTransform(),i._guideAngleLines=[new DD(i._app,i._layer),new DD(i._app,i._layer)],i._guideAngleLines.forEach(function(e){i._app.root.addChild(e.entity),e.entity.enabled=false;}),i.on(Dt.EVENT_TRANSFORMSTART,function(e,t,n){i._selectionStartAngle=i._calculateArcAngle(e,t,n),i._storeNodeRotations(),i._storeGuidePoints(),i._drag(true),i._angleGuide(true);}),i.on(Dt.EVENT_TRANSFORMMOVE,function(e,t,n){var r=i._selectedAxis;if(r){var s=i._calculateArcAngle(e,t,n)-i._selectionStartAngle;i.snap&&(s=Math.round(s/i.snapIncrement)*i.snapIncrement);var a=i._dirFromAxis(r,DO);i._setNodeRotations(r,a,s),i._updateGuidePoints(s),i._angleGuide(true);}}),i.on(Dt.EVENT_TRANSFORMEND,function(){i._drag(false),i._angleGuide(false);}),i.on(Dt.EVENT_NODESDETACH,function(){i._nodeLocalRotations.clear(),i._nodeRotations.clear(),i._nodeOffsets.clear();}),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&DM(t,e);var n,r=t.prototype;return r._setDiskProp=function(e,t){this._shapes.x[e]=t,this._shapes.y[e]=t,this._shapes.z[e]=t;},r._storeGuidePoints=function(){var e=this.root.getLocalPosition(),t="f"===this._selectedAxis?this.faceRingRadius:this.xyzRingRadius;this._guideAngleStart.copy(this._selectionStartPoint).sub(e).normalize(),this._guideAngleStart.mulScalar(t),this._guideAngleEnd.copy(this._guideAngleStart);},r._updateGuidePoints=function(e){var t=this._selectedAxis;"f"===t?DO.copy(this.facingDir):(DO.set(0,0,0),DO[t]=1,this._rootStartRot.transformVector(DO,DO)),DB.setFromAxisAngle(DO,e),DB.transformVector(this._guideAngleStart,this._guideAngleEnd);},r._angleGuide=function(e){var t=this._selectedAxis;if(e&&"show"!==this.dragMode&&"xyz"!==t){var n=this.root.getLocalPosition(),i=this._theme.guideBase[t],r=Dz.copy(i);r.a*=.3,this._guideAngleLines[0].draw(n,DO.copy(this._guideAngleStart).add(n),this._scale,r),this._guideAngleLines[1].draw(n,DO.copy(this._guideAngleEnd).add(n),this._scale,i),this._guideAngleLines[0].entity.enabled=true,this._guideAngleLines[1].entity.enabled=true;}else this._guideAngleLines[0].entity.enabled=false,this._guideAngleLines[1].entity.enabled=false;},r._shapesLookAtCamera=function(){if(0===this._camera.projection){var e,n,i=this._camera.entity.getPosition().sub(this.root.getPosition()).normalize(),r=Math.atan2(-i.y,Math.sqrt(i.x*i.x+i.z*i.z))*ek.RAD_TO_DEG,s=Math.atan2(-i.x,-i.z)*ek.RAD_TO_DEG;this._shapes.f.entity.setEulerAngles(-r+90,s,0);}else DB.copy(this._camera.entity.getRotation()).getEulerAngles(DO),this._shapes.f.entity.setEulerAngles(DO),this._shapes.f.entity.rotateLocal(-90,0,0);var a=DO.copy(this.facingDir);DB.copy(this.root.getRotation()).invert().transformVector(a,a),e=Math.atan2(a.z,a.y)*ek.RAD_TO_DEG,this._shapes.x.entity.setLocalEulerAngles(0,e-90,-90),e=Math.atan2(a.x,a.z)*ek.RAD_TO_DEG,this._shapes.y.entity.setLocalEulerAngles(0,e,0),e=Math.atan2(a.y,a.x)*ek.RAD_TO_DEG,this._shapes.z.entity.setLocalEulerAngles(90,0,e+90),this._dragging||(n=1-Math.abs(a.dot(this.root.right))>1e-4,this._shapes.x.show(n?"sector":"ring"),n=1-Math.abs(a.dot(this.root.up))>1e-4,this._shapes.y.show(n?"sector":"ring"),n=1-Math.abs(a.dot(this.root.forward))>1e-4,this._shapes.z.show(n?"sector":"ring"),this.fire(Dt.EVENT_RENDERUPDATE));},r._drag=function(e){for(var t in this._shapes){var n=this._shapes[t];if(null!=DI&&"undefined"!=typeof Symbol&&DI[Symbol.hasInstance]?!!DI[Symbol.hasInstance](n):i(n,DI))switch(this.dragMode){case "show":break;case "hide":n.show(e?t===this._selectedAxis?"ring":"none":"sector");continue;case "selected":n.show(e&&t===this._selectedAxis?"ring":"sector");}}this.fire(Dt.EVENT_RENDERUPDATE);},r._storeNodeRotations=function(){for(var e=this.root.getLocalPosition(),t=0;t<this.nodes.length;t++){var n=this.nodes[t];this._nodeLocalRotations.set(n,n.getLocalRotation().clone()),this._nodeRotations.set(n,n.getRotation().clone()),this._nodeOffsets.set(n,n.getPosition().clone().sub(e));}},r._setNodeRotations=function(e,t,n){var i=this.root.getLocalPosition();DB.setFromAxisAngle(t,n);for(var r=0;r<this.nodes.length;r++){var s=this.nodes[r];if(("x"===e||"y"===e||"z"===e)&&"local"===this._coordSpace){var a=this._nodeLocalRotations.get(s);if(!a)continue;DU.copy(a).mul(DB),s.setLocalRotation(DU);}else {var o=this._nodeRotations.get(s);if(!o)continue;var l=this._nodeOffsets.get(s);if(!l)continue;DO.copy(l),DB.transformVector(DO,DO),DU.copy(DB).mul(o),s.setEulerAngles(DU.getEulerAngles()),s.setPosition(DO.add(i));}}"local"===this._coordSpace&&this._updateRotation();},r._screenToPoint=function(e,t){var n=this._camera.screenToWorld(e,t,1),i=this._selectedAxis,r=this._createRay(n);return !this._createPlane(i,"f"===i,false).intersectsRay(r,DR),DR},r._calculateArcAngle=function(e,t,n){var i=this.root.getLocalPosition(),r=this._selectedAxis,s=this._createPlane(r,"f"===r,false),a=0,o=Dk.copy(this.facingDir),l=s.normal.dot(o);if(this.orbitRotation||1-Math.abs(l)<.1)switch(DO.sub2(e,i),r){case "x":DB.copy(this._rootStartRot).invert().transformVector(DO,DO),a=Math.atan2(DO.z,DO.y)*ek.RAD_TO_DEG;break;case "y":DB.copy(this._rootStartRot).invert().transformVector(DO,DO),a=Math.atan2(DO.x,DO.z)*ek.RAD_TO_DEG;break;case "z":DB.copy(this._rootStartRot).invert().transformVector(DO,DO),a=Math.atan2(DO.y,DO.x)*ek.RAD_TO_DEG;break;case "f":DB.copy(this._camera.entity.getRotation()).invert().transformVector(DO,DO),a=Math.sign(l)*Math.atan2(DO.y,DO.x)*ek.RAD_TO_DEG;}else DO.copy(i),Dk.cross(s.normal,o).normalize().add(i),this._camera.worldToScreen(DO,DN),this._camera.worldToScreen(Dk,DF),DO.sub2(DF,DN).normalize(),Dk.set(t,n,0),a=DO.dot(Dk);return a},r.prerender=function(){e.prototype.prerender.call(this),this.enabled&&this._shapesLookAtCamera();},n=[{key:"xyzTubeRadius",get:function(){return this._shapes.x.tubeRadius},set:function(e){this._setDiskProp("tubeRadius",e);}},{key:"xyzRingRadius",get:function(){return this._shapes.x.ringRadius},set:function(e){this._setDiskProp("ringRadius",e);}},{key:"faceTubeRadius",get:function(){return this._shapes.f.tubeRadius},set:function(e){this._shapes.f.tubeRadius=e;}},{key:"faceRingRadius",get:function(){return this._shapes.f.ringRadius},set:function(e){this._shapes.f.ringRadius=e;}},{key:"ringTolerance",get:function(){return this._shapes.x.tolerance},set:function(e){this._setDiskProp("tolerance",e),this._shapes.f.tolerance=e;}},{key:"angleGuideThickness",get:function(){return this._guideAngleLines[0].thickness},set:function(e){this._guideAngleLines[0].thickness=e,this._guideAngleLines[1].thickness=e;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(Dt);function DG(e,t){return (DG=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var DH=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(t,n){var i,r,s;return void 0===n&&(n={}),(i=e.call(this,t,"boxCenter",n)||this)._size=.12,i._tolerance=.05,i._size=null!=(r=n.size)?r:i._size,i._tolerance=null!=(s=n.tolerance)?s:i._tolerance,i.triData=[new Ds(new ft,2)],i._createRenderComponent(i.entity,[l_.fromGeometry(i.device,new ft)]),i._update(),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:true,configurable:true}}),e&&DG(n,e),n.prototype._update=function(){this.entity.setLocalScale(this._size,this._size,this._size);},t=[{key:"size",get:function(){return this._size},set:function(e){this._size=null!=e?e:this._size,this._update();}},{key:"tolerance",get:function(){return this._tolerance},set:function(e){this._tolerance=null!=e?e:this._tolerance,this._update();}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(n.prototype,t),n}(Du);function DW(e,t){return (DW=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Dj=new eW,DX=new eW,DY=new e0,Dq=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(t,n){var i,r,s,a,o,l;return void 0===n&&(n={}),(i=e.call(this,t,"boxLine",n)||this)._gap=0,i._lineThickness=.02,i._lineLength=.5,i._boxSize=.12,i._tolerance=.1,i._flipped=false,i._gap=null!=(r=n.gap)?r:i._gap,i._lineThickness=null!=(s=n.lineThickness)?s:i._lineThickness,i._lineLength=null!=(a=n.lineLength)?a:i._lineLength,i._boxSize=null!=(o=n.boxSize)?o:i._boxSize,i._tolerance=null!=(l=n.tolerance)?l:i._tolerance,i.triData=[new Ds(new ft),new Ds(new dH,1)],i._box=new my("box:"+i.axis),i.entity.addChild(i._box),i._createRenderComponent(i._box,[l_.fromGeometry(i.device,new ft)]),i._line=new my("line:"+i.axis),i.entity.addChild(i._line),i._createRenderComponent(i._line,[l_.fromGeometry(i.device,new dH)]),i._update(),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:true,configurable:true}}),e&&DW(n,e),n.prototype._update=function(){Dj.set(0,this._gap+.5*this._boxSize+this._lineLength,0),DY.set(0,0,0,1),DX.set(this._boxSize,this._boxSize,this._boxSize),this.triData[0].setTransform(Dj,DY,DX),Dj.set(0,this._gap+.5*this._lineLength,0),DY.set(0,0,0,1),DX.set(this._lineThickness+this._tolerance,this._lineLength,this._lineThickness+this._tolerance),this.triData[1].setTransform(Dj,DY,DX),this._box.setLocalPosition(0,this._gap+.5*this._boxSize+this._lineLength,0),this._box.setLocalScale(this._boxSize,this._boxSize,this._boxSize),this._line.setLocalPosition(0,this._gap+.5*this._lineLength,0),this._line.setLocalScale(this._lineThickness,this._lineLength,this._lineThickness);},t=[{key:"gap",get:function(){return this._gap},set:function(e){this._gap=null!=e?e:this._gap,this._update();}},{key:"lineThickness",get:function(){return this._lineThickness},set:function(e){this._lineThickness=null!=e?e:this._lineThickness,this._update();}},{key:"lineLength",get:function(){return this._lineLength},set:function(e){this._lineLength=null!=e?e:this._lineLength,this._update();}},{key:"boxSize",get:function(){return this._boxSize},set:function(e){this._boxSize=null!=e?e:this._boxSize,this._update();}},{key:"tolerance",get:function(){return this._tolerance},set:function(e){this._tolerance=e,this._update();}},{key:"flipped",get:function(){return this._flipped},set:function(e){this._flipped!==e&&(this._flipped=e,this._rotation.equals(eW.ZERO)?Dj.set(0,0,180*!!this._flipped):Dj.copy(this._rotation).mulScalar(this._flipped?-1:1),this._line.enabled=!this._flipped,this.entity.setLocalEulerAngles(Dj));}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(n.prototype,t),n}(Du);function DK(e,t){return (DK=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var DZ=new eW,DQ=new eW,DJ=new eW,D$=new eW,D0=new e0,D1=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(t,n){var i;return (i=e.call(this,t,n,"gizmo:scale")||this)._shapes={xyz:new DH(i._device,{axis:"xyz",layers:[i._layer.id],defaultColor:i._theme.shapeBase.xyz,hoverColor:i._theme.shapeHover.xyz,disabledColor:i._theme.disabled}),yz:new Dh(i._device,{axis:"x",layers:[i._layer.id],rotation:new eW(0,0,-90),defaultColor:i._theme.shapeBase.x,hoverColor:i._theme.shapeHover.x,disabledColor:i._theme.disabled}),xz:new Dh(i._device,{axis:"y",layers:[i._layer.id],rotation:new eW(0,0,0),defaultColor:i._theme.shapeBase.y,hoverColor:i._theme.shapeHover.y,disabledColor:i._theme.disabled}),xy:new Dh(i._device,{axis:"z",layers:[i._layer.id],rotation:new eW(90,0,0),defaultColor:i._theme.shapeBase.z,hoverColor:i._theme.shapeHover.z,disabledColor:i._theme.disabled}),x:new Dq(i._device,{axis:"x",layers:[i._layer.id],rotation:new eW(0,0,-90),defaultColor:i._theme.shapeBase.x,hoverColor:i._theme.shapeHover.x,disabledColor:i._theme.disabled}),y:new Dq(i._device,{axis:"y",layers:[i._layer.id],rotation:new eW(0,0,0),defaultColor:i._theme.shapeBase.y,hoverColor:i._theme.shapeHover.y,disabledColor:i._theme.disabled}),z:new Dq(i._device,{axis:"z",layers:[i._layer.id],rotation:new eW(90,0,0),defaultColor:i._theme.shapeBase.z,hoverColor:i._theme.shapeHover.z,disabledColor:i._theme.disabled})},i._coordSpace="local",i._nodeScales=new Map,i._uniform=false,i.snapIncrement=1,i.flipAxes=true,i.flipPlanes=true,i.lowerBoundScale=new eW(-1/0,-1/0,-1/0),i._createTransform(),i.on(Dt.EVENT_TRANSFORMSTART,function(){i._storeNodeScales(),i._drag(true);}),i.on(Dt.EVENT_TRANSFORMMOVE,function(e){var t=D$.copy(e).sub(i._selectionStartPoint);i.snap&&(t.mulScalar(1/i.snapIncrement),t.round(),t.mulScalar(i.snapIncrement)),t.mulScalar(1/i._scale),i._setNodeScales(t.add(eW.ONE));}),i.on(Dt.EVENT_TRANSFORMEND,function(){i._drag(false);}),i.on(Dt.EVENT_NODESDETACH,function(){i._nodeScales.clear();}),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&DK(t,e);var n,i=t.prototype;return i._setArrowProp=function(e,t){this._shapes.x[e]=t,this._shapes.y[e]=t,this._shapes.z[e]=t;},i._setPlaneProp=function(e,t){this._shapes.yz[e]=t,this._shapes.xz[e]=t,this._shapes.xy[e]=t;},i._shapesLookAtCamera=function(){var e=this.cameraDir,t=e.dot(this.root.right);this._shapes.x.entity.enabled=1-Math.abs(t)>.01,this.flipAxes&&(this._shapes.x.flipped=t<0),t=e.dot(this.root.up),this._shapes.y.entity.enabled=1-Math.abs(t)>.01,this.flipAxes&&(this._shapes.y.flipped=t<0),t=e.dot(this.root.forward),this._shapes.z.entity.enabled=1-Math.abs(t)>.01,this.flipAxes&&(this._shapes.z.flipped=t>0),DZ.cross(e,this.root.right),this._shapes.yz.entity.enabled=1-DZ.length()>.01,this.flipPlanes&&(this._shapes.yz.flipped=DQ.set(0,+(0>DZ.dot(this.root.forward)),+(0>DZ.dot(this.root.up)))),DZ.cross(e,this.root.forward),this._shapes.xy.entity.enabled=1-DZ.length()>.01,this.flipPlanes&&(this._shapes.xy.flipped=DQ.set(+(0>DZ.dot(this.root.up)),+(DZ.dot(this.root.right)>0),0)),DZ.cross(e,this.root.up),this._shapes.xz.entity.enabled=1-DZ.length()>.01,this.flipPlanes&&(this._shapes.xz.flipped=DQ.set(+(DZ.dot(this.root.forward)>0),0,+(DZ.dot(this.root.right)>0)));},i._drag=function(e){for(var t in this._shapes){var n=this._shapes[t];switch(this.dragMode){case "show":continue;case "hide":n.visible=!e;continue;case "selected":if("xyz"===this._selectedAxis){n.visible=!e||1===t.length;continue}if(this._selectedIsPlane){n.visible=!e||1===t.length&&!t.includes(this._selectedAxis);continue}n.visible=!e||t===this._selectedAxis;continue}}this.fire(Dt.EVENT_RENDERUPDATE);},i._storeNodeScales=function(){for(var e=0;e<this.nodes.length;e++){var t=this.nodes[e];this._nodeScales.set(t,t.getLocalScale().clone());}},i._setNodeScales=function(e){for(var t=0;t<this.nodes.length;t++){var n=this.nodes[t],i=this._nodeScales.get(n);i&&n.setLocalScale(DZ.copy(i).mul(e).max(this.lowerBoundScale));}},i._screenToPoint=function(e,t){var n=this.root.getLocalPosition(),i=this._camera.screenToWorld(e,t,1),r=this._selectedAxis,s=this._selectedIsPlane,a=this._createRay(i);if(!this._createPlane(r,"xyz"===r,!s).intersectsRay(a,DJ))return DJ;if("xyz"===r){var o=DQ.add2(this._camera.entity.up,this._camera.entity.right).normalize(),l=DZ.sub2(DJ,n),u=l.length()*l.normalize().dot(o);return DJ.set(u,u,u),DJ}if(D0.copy(this._rootStartRot).invert().transformVector(DJ,DJ),s||this._projectToAxis(DJ,r),this.flipAxes){var c=this.cameraDir,h=D0.copy(this._rootStartRot),f=c.dot(h.transformVector(eW.RIGHT,DZ));DJ.x*=f<0?-1:1,f=c.dot(h.transformVector(eW.UP,DZ)),DJ.y*=f<0?-1:1,f=c.dot(h.transformVector(eW.FORWARD,DZ)),DJ.z*=f>0?-1:1;}return this._uniform&&s&&(DZ.set(1,1,1),DZ[r]=0,DJ.copy(DZ.mulScalar(DZ.dot(DJ))),DJ[r]=0),DJ},i.prerender=function(){e.prototype.prerender.call(this),this.enabled&&this._shapesLookAtCamera();},n=[{key:"coordSpace",get:function(){return this._coordSpace},set:function(e){}},{key:"uniform",get:function(){return this._uniform},set:function(e){this._uniform=null!=e?e:this._uniform;}},{key:"axisGap",get:function(){return this._shapes.x.gap},set:function(e){this._setArrowProp("gap",e);}},{key:"axisLineThickness",get:function(){return this._shapes.x.lineThickness},set:function(e){this._setArrowProp("lineThickness",e);}},{key:"axisLineLength",get:function(){return this._shapes.x.lineLength},set:function(e){this._setArrowProp("lineLength",e);}},{key:"axisLineTolerance",get:function(){return this._shapes.x.tolerance},set:function(e){this._setArrowProp("tolerance",e);}},{key:"axisBoxSize",get:function(){return this._shapes.x.boxSize},set:function(e){this._setArrowProp("boxSize",e);}},{key:"axisPlaneSize",get:function(){return this._shapes.yz.size},set:function(e){this._setPlaneProp("size",e);}},{key:"axisPlaneGap",get:function(){return this._shapes.yz.gap},set:function(e){this._setPlaneProp("gap",e);}},{key:"axisCenterSize",get:function(){return this._shapes.xyz.size},set:function(e){this._shapes.xyz.size=e;}},{key:"axisCenterTolerance",get:function(){return this._shapes.xyz.tolerance},set:function(e){this._shapes.xyz.tolerance=e;}},{key:"flipShapes",get:function(){return this.flipAxes&&this.flipPlanes},set:function(e){this.flipAxes=e,this.flipPlanes=e;}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(Dt);function D2(e,t){return (D2=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var D3=new eW,D4=new eW,D5=new eW,D8=new e$,D6=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function t(n){(i=e.call(this)||this)._size=0,i._anchor=new eY(1,1,1,1),i._colorX=LX.clone(),i._colorY=LY.clone(),i._colorZ=Lq.clone(),i._colorNeg=new eN(.3,.3,.3),i._radius=10,i._textSize=10,i._lineThickness=2,i._lineLength=40,i.dom=document.createElement("div"),i.dom.id="view-cube-container",i.dom.style.cssText="position: absolute;margin: auto;pointer-events: none",document.body.appendChild(i.dom),i.anchor=null!=n?n:i._anchor,i._svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),i._svg.id="view-cube-svg",i._group=document.createElementNS(i._svg.namespaceURI,"g"),i._svg.appendChild(i._group),i._resize();var i,r=i._colorX.toString(false),s=i._colorY.toString(false),a=i._colorZ.toString(false);return i._shapes={nx:i._circle(r),ny:i._circle(s),nz:i._circle(a),px:i._circle(r,true,"X"),py:i._circle(s,true,"Y"),pz:i._circle(a,true,"Z"),xaxis:i._line(r),yaxis:i._line(s),zaxis:i._line(a)},i._shapes.px.children[0].addEventListener("pointerdown",function(){i.fire(t.EVENT_CAMERAALIGN,eW.RIGHT);}),i._shapes.py.children[0].addEventListener("pointerdown",function(){i.fire(t.EVENT_CAMERAALIGN,eW.UP);}),i._shapes.pz.children[0].addEventListener("pointerdown",function(){i.fire(t.EVENT_CAMERAALIGN,eW.BACK);}),i._shapes.nx.children[0].addEventListener("pointerdown",function(){i.fire(t.EVENT_CAMERAALIGN,eW.LEFT);}),i._shapes.ny.children[0].addEventListener("pointerdown",function(){i.fire(t.EVENT_CAMERAALIGN,eW.DOWN);}),i._shapes.nz.children[0].addEventListener("pointerdown",function(){i.fire(t.EVENT_CAMERAALIGN,eW.FORWARD);}),i.dom.appendChild(i._svg),i}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}}),e&&D2(t,e);var n,i=t.prototype;return i._resize=function(){this._size=2*(this.lineLength+this.radius+this.lineThickness),this.dom.style.width=""+this._size+"px",this.dom.style.height=""+this._size+"px",this._svg.setAttribute("width",""+this._size),this._svg.setAttribute("height",""+this._size),this._group.setAttribute("transform","translate("+.5*this._size+", "+.5*this._size+")");},i._transform=function(e,t,n){e.setAttribute("transform","translate("+t*this._lineLength+", "+n*this._lineLength+")");},i._x2y2=function(e,t,n){e.setAttribute("x2",""+t*this._lineLength),e.setAttribute("y2",""+n*this._lineLength);},i._line=function(e){var t=document.createElementNS(this._svg.namespaceURI,"line");return t.setAttribute("stroke",e),t.setAttribute("stroke-width",""+this._lineThickness),this._group.appendChild(t),t},i._circle=function(e,t,n){ void 0===t&&(t=false);var i=document.createElementNS(this._svg.namespaceURI,"g"),r=document.createElementNS(this._svg.namespaceURI,"circle");if(r.setAttribute("fill",t?e:this._colorNeg.toString(false)),r.setAttribute("stroke",e),r.setAttribute("stroke-width",""+this._lineThickness),r.setAttribute("r",""+this._radius),r.setAttribute("cx","0"),r.setAttribute("cy","0"),r.setAttribute("pointer-events","all"),i.appendChild(r),n){var s=document.createElementNS(this._svg.namespaceURI,"text");s.setAttribute("font-size",""+this._textSize),s.setAttribute("font-family","Arial"),s.setAttribute("font-weight","bold"),s.setAttribute("text-anchor","middle"),s.setAttribute("alignment-baseline","central"),s.textContent=n,i.appendChild(s);}return i.setAttribute("cursor","pointer"),this._group.appendChild(i),i},i.update=function(e){var t=this;if(this._size){D8.invert(e),D8.getX(D3),D8.getY(D4),D8.getZ(D5),this._transform(this._shapes.px,D3.x,-D3.y),this._transform(this._shapes.nx,-D3.x,D3.y),this._transform(this._shapes.py,D4.x,-D4.y),this._transform(this._shapes.ny,-D4.x,D4.y),this._transform(this._shapes.pz,D5.x,-D5.y),this._transform(this._shapes.nz,-D5.x,D5.y),this._x2y2(this._shapes.xaxis,D3.x,-D3.y),this._x2y2(this._shapes.yaxis,D4.x,-D4.y),this._x2y2(this._shapes.zaxis,D5.x,-D5.y);var n=[{n:["xaxis","px"],value:D3.z},{n:["yaxis","py"],value:D4.z},{n:["zaxis","pz"],value:D5.z},{n:["nx"],value:-D3.z},{n:["ny"],value:-D4.z},{n:["nz"],value:-D5.z}].sort(function(e,t){return e.value-t.value}),i=document.createDocumentFragment();n.forEach(function(e){e.n.forEach(function(e){i.appendChild(t._shapes[e]);});}),this._group.appendChild(i);}},i.destroy=function(){this.dom.remove(),this.off();},n=[{key:"anchor",get:function(){return this._anchor},set:function(e){this._anchor.copy(e),this.dom.style.top=this._anchor.x?"0px":"auto",this.dom.style.right=this._anchor.y?"0px":"auto",this.dom.style.bottom=this._anchor.z?"0px":"auto",this.dom.style.left=this._anchor.w?"0px":"auto";}},{key:"colorX",get:function(){return this._colorX},set:function(e){this._colorX.copy(e),this._shapes.px.children[0].setAttribute("fill",this._colorX.toString(false)),this._shapes.px.children[0].setAttribute("stroke",this._colorX.toString(false)),this._shapes.nx.children[0].setAttribute("stroke",this._colorX.toString(false)),this._shapes.xaxis.setAttribute("stroke",this._colorX.toString(false));}},{key:"colorY",get:function(){return this._colorY},set:function(e){this._colorY.copy(e),this._shapes.py.children[0].setAttribute("fill",this._colorY.toString(false)),this._shapes.py.children[0].setAttribute("stroke",this._colorY.toString(false)),this._shapes.ny.children[0].setAttribute("stroke",this._colorY.toString(false)),this._shapes.yaxis.setAttribute("stroke",this._colorY.toString(false));}},{key:"colorZ",get:function(){return this._colorZ},set:function(e){this._colorZ.copy(e),this._shapes.pz.children[0].setAttribute("fill",this._colorZ.toString(false)),this._shapes.pz.children[0].setAttribute("stroke",this._colorZ.toString(false)),this._shapes.nz.children[0].setAttribute("stroke",this._colorZ.toString(false)),this._shapes.zaxis.setAttribute("stroke",this._colorZ.toString(false));}},{key:"colorNeg",get:function(){return this._colorNeg},set:function(e){this._colorNeg.copy(e),this._shapes.px.children[0].setAttribute("fill",this._colorNeg.toString(false)),this._shapes.py.children[0].setAttribute("fill",this._colorNeg.toString(false)),this._shapes.pz.children[0].setAttribute("fill",this._colorNeg.toString(false));}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e,this._shapes.px.children[0].setAttribute("r",""+e),this._shapes.py.children[0].setAttribute("r",""+e),this._shapes.pz.children[0].setAttribute("r",""+e),this._shapes.nx.children[0].setAttribute("r",""+e),this._shapes.ny.children[0].setAttribute("r",""+e),this._shapes.nz.children[0].setAttribute("r",""+e),this._resize();}},{key:"textSize",get:function(){return this._textSize},set:function(e){this._textSize=e,this._shapes.px.children[1].setAttribute("font-size",""+e),this._shapes.py.children[1].setAttribute("font-size",""+e),this._shapes.pz.children[1].setAttribute("font-size",""+e);}},{key:"lineThickness",get:function(){return this._lineThickness},set:function(e){this._lineThickness=e,this._shapes.xaxis.setAttribute("stroke-width",""+e),this._shapes.yaxis.setAttribute("stroke-width",""+e),this._shapes.zaxis.setAttribute("stroke-width",""+e),this._shapes.px.children[0].setAttribute("stroke-width",""+e),this._shapes.py.children[0].setAttribute("stroke-width",""+e),this._shapes.pz.children[0].setAttribute("stroke-width",""+e),this._shapes.nx.children[0].setAttribute("stroke-width",""+e),this._shapes.ny.children[0].setAttribute("stroke-width",""+e),this._shapes.nz.children[0].setAttribute("stroke-width",""+e),this._resize();}},{key:"lineLength",get:function(){return this._lineLength},set:function(e){this._lineLength=e,this._resize();}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(e,i.key,i);}}(t.prototype,n),t}(ex);D6.EVENT_CAMERAALIGN="camera:align",e.ABSOLUTE_URL=pW,e.ACTION_GAMEPAD=ac,e.ACTION_KEYBOARD=au,e.ACTION_MOUSE=al,e.ADDRESS_CLAMP_TO_EDGE=1,e.ADDRESS_MIRRORED_REPEAT=2,e.ADDRESS_REPEAT=0,e.AMBIENTSRC_AMBIENTSH=oy,e.AMBIENTSRC_CONSTANT=ox,e.AMBIENTSRC_ENVALATLAS=oS,e.ANIM_BLEND_1D="1D",e.ANIM_BLEND_2D_CARTESIAN=_o,e.ANIM_BLEND_2D_DIRECTIONAL=_a,e.ANIM_BLEND_DIRECT=_l,e.ANIM_CONTROL_STATES=_c,e.ANIM_EQUAL_TO=_e,e.ANIM_GREATER_THAN=m8,e.ANIM_GREATER_THAN_EQUAL_TO=m9,e.ANIM_INTERRUPTION_NEXT=m3,e.ANIM_INTERRUPTION_NEXT_PREV=m5,e.ANIM_INTERRUPTION_NONE=m1,e.ANIM_INTERRUPTION_PREV=m2,e.ANIM_INTERRUPTION_PREV_NEXT=m4,e.ANIM_LAYER_ADDITIVE=_f,e.ANIM_LAYER_OVERWRITE=_h,e.ANIM_LESS_THAN=m6,e.ANIM_LESS_THAN_EQUAL_TO=m7,e.ANIM_NOT_EQUAL_TO=_t,e.ANIM_PARAMETER_BOOLEAN=_r,e.ANIM_PARAMETER_FLOAT=_i,e.ANIM_PARAMETER_INTEGER=_n,e.ANIM_PARAMETER_TRIGGER=_s,e.ANIM_STATE_ANY="ANY",e.ANIM_STATE_END="END",e.ANIM_STATE_START=_u,e.ASPECT_AUTO=0,e.ASPECT_MANUAL=1,e.ASSET_ANIMATION="animation",e.ASSET_AUDIO="audio",e.ASSET_CONTAINER="container",e.ASSET_CSS="css",e.ASSET_CUBEMAP="cubemap",e.ASSET_HTML="html",e.ASSET_IMAGE="image",e.ASSET_JSON="json",e.ASSET_MATERIAL="material",e.ASSET_MODEL="model",e.ASSET_SCRIPT="script",e.ASSET_SHADER="shader",e.ASSET_TEXT="text",e.ASSET_TEXTURE="texture",e.ASSET_TEXTUREATLAS="textureatlas",e.AXIS_KEY="key",e.AXIS_MOUSE_X="mousex",e.AXIS_MOUSE_Y="mousey",e.AXIS_PAD_L_X="padlx",e.AXIS_PAD_L_Y="padly",e.AXIS_PAD_R_X="padrx",e.AXIS_PAD_R_Y="padry",e.AnimBinder=_g,e.AnimClip=m0,e.AnimClipHandler=TU,e.AnimComponent=_3,e.AnimComponentLayer=_J,e.AnimComponentSystem=_6,e.AnimController=_H,e.AnimCurve=bE,e.AnimData=bw,e.AnimEvaluator=_m,e.AnimEvents=__,e.AnimSnapshot=mJ,e.AnimStateGraph=_$,e.AnimStateGraphHandler=TV,e.AnimTarget=_y,e.AnimTrack=_v,e.Animation=fK,e.AnimationComponent=_T,e.AnimationComponentSystem=_P,e.AnimationHandler=TF,e.AnimationKey=fY,e.AnimationNode=fq,e.AppBase=mA,e.AppOptions=mP,e.Application=Cu,e.Asset=pZ,e.AssetListLoader=Ch,e.AssetReference=yw,e.AssetRegistry=p2,e.AudioHandler=Tj,e.AudioListenerComponent=_7,e.AudioListenerComponentSystem=vi,e.BAKE_COLOR=0,e.BAKE_COLORDIR=1,e.BINDGROUP_MESH=1,e.BINDGROUP_MESH_UB=2,e.BINDGROUP_VIEW=0,e.BLENDEQUATION_ADD=0,e.BLENDEQUATION_MAX=4,e.BLENDEQUATION_MIN=3,e.BLENDEQUATION_REVERSE_SUBTRACT=2,e.BLENDEQUATION_SUBTRACT=1,e.BLENDMODE_CONSTANT=11,e.BLENDMODE_CONSTANT_ALPHA=11,e.BLENDMODE_CONSTANT_COLOR=11,e.BLENDMODE_DST_ALPHA=9,e.BLENDMODE_DST_COLOR=4,e.BLENDMODE_ONE=1,e.BLENDMODE_ONE_MINUS_CONSTANT=12,e.BLENDMODE_ONE_MINUS_CONSTANT_ALPHA=12,e.BLENDMODE_ONE_MINUS_CONSTANT_COLOR=12,e.BLENDMODE_ONE_MINUS_DST_ALPHA=10,e.BLENDMODE_ONE_MINUS_DST_COLOR=5,e.BLENDMODE_ONE_MINUS_SRC_ALPHA=8,e.BLENDMODE_ONE_MINUS_SRC_COLOR=3,e.BLENDMODE_SRC_ALPHA=6,e.BLENDMODE_SRC_ALPHA_SATURATE=7,e.BLENDMODE_SRC_COLOR=2,e.BLENDMODE_ZERO=0,e.BLEND_ADDITIVE=1,e.BLEND_ADDITIVEALPHA=6,e.BLEND_MAX=10,e.BLEND_MIN=9,e.BLEND_MULTIPLICATIVE=5,e.BLEND_MULTIPLICATIVE2X=7,e.BLEND_NONE=3,e.BLEND_NORMAL=2,e.BLEND_PREMULTIPLIED=4,e.BLEND_SCREEN=8,e.BLEND_SUBTRACTIVE=0,e.BLUR_BOX=0,e.BLUR_GAUSSIAN=1,e.BODYFLAG_KINEMATIC_OBJECT=2,e.BODYFLAG_NORESPONSE_OBJECT=4,e.BODYFLAG_STATIC_OBJECT=1,e.BODYGROUP_DEFAULT=1,e.BODYGROUP_DYNAMIC=1,e.BODYGROUP_ENGINE_1=8,e.BODYGROUP_ENGINE_2=32,e.BODYGROUP_ENGINE_3=64,e.BODYGROUP_KINEMATIC=4,e.BODYGROUP_NONE=0,e.BODYGROUP_STATIC=2,e.BODYGROUP_TRIGGER=16,e.BODYGROUP_USER_1=128,e.BODYGROUP_USER_2=256,e.BODYGROUP_USER_3=512,e.BODYGROUP_USER_4=1024,e.BODYGROUP_USER_5=2048,e.BODYGROUP_USER_6=4096,e.BODYGROUP_USER_7=8192,e.BODYGROUP_USER_8=16384,e.BODYMASK_ALL=65535,e.BODYMASK_NONE=0,e.BODYMASK_NOT_STATIC=65533,e.BODYMASK_NOT_STATIC_KINEMATIC=65529,e.BODYMASK_STATIC=2,e.BODYSTATE_ACTIVE_TAG=1,e.BODYSTATE_DISABLE_DEACTIVATION=4,e.BODYSTATE_DISABLE_SIMULATION=5,e.BODYSTATE_ISLAND_SLEEPING=2,e.BODYSTATE_WANTS_DEACTIVATION=3,e.BODYTYPE_DYNAMIC=vP,e.BODYTYPE_KINEMATIC=vI,e.BODYTYPE_STATIC=vC,e.BUFFERUSAGE_COPY_DST=8,e.BUFFERUSAGE_COPY_SRC=4,e.BUFFERUSAGE_INDEX=16,e.BUFFERUSAGE_INDIRECT=256,e.BUFFERUSAGE_READ=1,e.BUFFERUSAGE_STORAGE=128,e.BUFFERUSAGE_UNIFORM=64,e.BUFFERUSAGE_VERTEX=32,e.BUFFERUSAGE_WRITE=2,e.BUFFER_DYNAMIC=1,e.BUFFER_GPUDYNAMIC=3,e.BUFFER_STATIC=0,e.BUFFER_STREAM=2,e.BUTTON_TRANSITION_MODE_SPRITE_CHANGE=1,e.BUTTON_TRANSITION_MODE_TINT=0,e.Batch=la,e.BatchGroup=lo,e.BatchManager=lF,e.BinaryHandler=TY,e.BindGroupFormat=nL,e.BindStorageBufferFormat=nC,e.BindStorageTextureFormat=nI,e.BindTextureFormat=nP,e.BindUniformBufferFormat=nA,e.BlendState=nj,e.BoundingBox=e8,e.BoundingSphere=e7,e.BoxGeometry=ft,e.Bundle=p7,e.BundleHandler=mr,e.BundleRegistry=p5,e.ButtonComponent=vm,e.ButtonComponentSystem=vS,e.CHUNKAPI_1_51="1.51",e.CHUNKAPI_1_55="1.55",e.CHUNKAPI_1_56="1.56",e.CHUNKAPI_1_57="1.57",e.CHUNKAPI_1_58="1.58",e.CHUNKAPI_1_60="1.60",e.CHUNKAPI_1_62="1.62",e.CHUNKAPI_1_65="1.65",e.CHUNKAPI_1_70="1.70",e.CHUNKAPI_2_1="2.1",e.CHUNKAPI_2_3="2.3",e.CHUNKAPI_2_5="2.5",e.CHUNKAPI_2_6="2.6",e.CHUNKAPI_2_7="2.7",e.CHUNKAPI_2_8="2.8",e.CLEARFLAG_COLOR=1,e.CLEARFLAG_DEPTH=2,e.CLEARFLAG_STENCIL=4,e.CUBEFACE_NEGX=1,e.CUBEFACE_NEGY=3,e.CUBEFACE_NEGZ=5,e.CUBEFACE_POSX=0,e.CUBEFACE_POSY=2,e.CUBEFACE_POSZ=4,e.CUBEPROJ_BOX=1,e.CUBEPROJ_NONE=0,e.CULLFACE_BACK=1,e.CULLFACE_FRONT=2,e.CULLFACE_FRONTANDBACK=3,e.CULLFACE_NONE=0,e.CURVE_LINEAR=0,e.CURVE_SMOOTHSTEP=1,e.CURVE_SPLINE=4,e.CURVE_STEP=5,e.Camera=lZ,e.CameraComponent=S2,e.CameraComponentSystem=S8,e.CameraFrame=Iq,e.CameraFrameOptions=Ij,e.CanvasFont=Cp,e.CapsuleGeometry=dU,e.ChunkUtils=h8,e.CollisionComponent=vw,e.CollisionComponentSystem=vY,e.Color=eN,e.Component=mX,e.ComponentSystem=mZ,e.ComponentSystemRegistry=p6,e.Compute=sQ,e.ConeGeometry=dV,e.ContactPoint=yX,e.ContactResult=yY,e.ContainerHandler=T0,e.ContainerResource=T$,e.Controller=ab,e.CssHandler=T2,e.CubemapHandler=T4,e.Curve=eB,e.CurveSet=eU,e.CylinderGeometry=dH,e.DETAILMODE_ADD="add",e.DETAILMODE_MAX="max",e.DETAILMODE_MIN="min",e.DETAILMODE_MUL="mul",e.DETAILMODE_OVERLAY="overlay",e.DETAILMODE_SCREEN="screen",e.DEVICETYPE_NULL=nc,e.DEVICETYPE_WEBGL2=nl,e.DEVICETYPE_WEBGPU=nu,e.DISPLAYFORMAT_HDR="hdr",e.DISPLAYFORMAT_LDR="ldr",e.DISPLAYFORMAT_LDR_SRGB=nh,e.DISTANCE_EXPONENTIAL=aQ,e.DISTANCE_INVERSE=aZ,e.DISTANCE_LINEAR=aK,e.DITHER_BAYER8=oC,e.DITHER_BLUENOISE=oP,e.DITHER_IGNNOISE=oI,e.DITHER_NONE=oA,e.DefaultAnimBinder=_S,e.DepthState=nq,e.DomeGeometry=fs,e.DualGestureSource=Li,e.ELEMENTTYPE_GROUP=vr,e.ELEMENTTYPE_IMAGE=vs,e.ELEMENTTYPE_TEXT=va,e.EMITTERSHAPE_BOX=0,e.EMITTERSHAPE_SPHERE=1,e.EVENT_CULL_END=oF,e.EVENT_GAMEPADCONNECTED="gamepadconnected",e.EVENT_GAMEPADDISCONNECTED="gamepaddisconnected",e.EVENT_KEYDOWN="keydown",e.EVENT_KEYUP="keyup",e.EVENT_MOUSEDOWN="mousedown",e.EVENT_MOUSEMOVE="mousemove",e.EVENT_MOUSEUP="mouseup",e.EVENT_MOUSEWHEEL="mousewheel",e.EVENT_POSTCULL=oN,e.EVENT_POSTRENDER=oM,e.EVENT_POSTRENDER_LAYER=oO,e.EVENT_PRECULL=ok,e.EVENT_PRERENDER=oD,e.EVENT_PRERENDER_LAYER=oR,e.EVENT_SELECT="select",e.EVENT_SELECTEND="selectend",e.EVENT_SELECTSTART="selectstart",e.EVENT_TOUCHCANCEL="touchcancel",e.EVENT_TOUCHEND="touchend",e.EVENT_TOUCHMOVE="touchmove",e.EVENT_TOUCHSTART="touchstart",e.ElementComponent=gb,e.ElementComponentSystem=gC,e.ElementDragHelper=Ss,e.ElementInput=C3,e.ElementInputEvent=C$,e.ElementMouseEvent=C0,e.ElementSelectEvent=C2,e.ElementTouchEvent=C1,e.Entity=my,e.EnvLighting=fk,e.EventHandle=eg,e.EventHandler=ex,e.FILLMODE_FILL_WINDOW=pC,e.FILLMODE_KEEP_ASPECT=pP,e.FILLMODE_NONE="NONE",e.FILTER_LINEAR=1,e.FILTER_LINEAR_MIPMAP_LINEAR=5,e.FILTER_LINEAR_MIPMAP_NEAREST=4,e.FILTER_NEAREST=0,e.FILTER_NEAREST_MIPMAP_LINEAR=3,e.FILTER_NEAREST_MIPMAP_NEAREST=2,e.FITMODE_CONTAIN=vl,e.FITMODE_COVER=vu,e.FITMODE_STRETCH=vo,e.FITTING_BOTH=3,e.FITTING_NONE=0,e.FITTING_SHRINK=2,e.FITTING_STRETCH=1,e.FOG_EXP="exp",e.FOG_EXP2="exp2",e.FOG_LINEAR=oi,e.FOG_NONE=on,e.FONT_BITMAP=v3,e.FONT_MSDF=v2,e.FRESNEL_NONE=0,e.FRESNEL_SCHLICK=2,e.FUNC_ALWAYS=7,e.FUNC_EQUAL=2,e.FUNC_GREATER=4,e.FUNC_GREATEREQUAL=6,e.FUNC_LESS=1,e.FUNC_LESSEQUAL=3,e.FUNC_NEVER=0,e.FUNC_NOTEQUAL=5,e.FloatPacking=eG,e.FlyController=Lw,e.FocusController=LN,e.FogParams=fN,e.FolderHandler=T8,e.Font=T6,e.FontHandler=Ee,e.ForwardRenderer=cz,e.Frustum=tt,e.GAMMA_NONE=0,e.GAMMA_SRGB=1,e.GIZMOAXIS_FACE="face",e.GIZMOAXIS_X="x",e.GIZMOAXIS_XY="xy",e.GIZMOAXIS_XYZ="xyz",e.GIZMOAXIS_XZ="xz",e.GIZMOAXIS_Y="y",e.GIZMOAXIS_YZ="yz",e.GIZMOAXIS_Z="z",e.GIZMOSPACE_LOCAL="local",e.GIZMOSPACE_WORLD="world",e.GSplatComponent=bu,e.GSplatComponentSystem=b_,e.GSplatData=d2,e.GSplatHandler=Ek,e.GSplatInstance=pE,e.GSplatResource=pt,e.GSplatResourceBase=d9,e.GSplatSogsData=py,e.GSplatSogsResource=pA,e.GamePads=az,e.GamepadSource=L_,e.Geometry=h7,e.Gizmo=Lj,e.GltfExporter=Im,e.GraphNode=us,e.GraphicsDevice=ia,e.HierarchyHandler=EV,e.HtmlHandler=EH,e.Http=aY,e.I18n=ml,e.INDEXFORMAT_UINT16=1,e.INDEXFORMAT_UINT32=2,e.INDEXFORMAT_UINT8=0,e.INTERPOLATION_CUBIC=2,e.INTERPOLATION_LINEAR=1,e.INTERPOLATION_STEP=0,e.ImageElement=vJ,e.IndexBuffer=s$,e.IndexedList=eb,e.InputConsumer=I4,e.InputController=I5,e.InputDelta=I1,e.InputFrame=I2,e.InputSource=I3,e.JointComponent=gO,e.JointComponentSystem=gU,e.JsonHandler=Ej,e.JsonStandardMaterialParser=EK,e.KEY_0=48,e.KEY_1=49,e.KEY_2=50,e.KEY_3=51,e.KEY_4=52,e.KEY_5=53,e.KEY_6=54,e.KEY_7=55,e.KEY_8=56,e.KEY_9=57,e.KEY_A=65,e.KEY_ADD=107,e.KEY_ALT=18,e.KEY_B=66,e.KEY_BACKSPACE=8,e.KEY_BACK_SLASH=220,e.KEY_C=67,e.KEY_CAPS_LOCK=20,e.KEY_CLOSE_BRACKET=221,e.KEY_COMMA=188,e.KEY_CONTEXT_MENU=93,e.KEY_CONTROL=17,e.KEY_D=68,e.KEY_DECIMAL=110,e.KEY_DELETE=46,e.KEY_DIVIDE=111,e.KEY_DOWN=40,e.KEY_E=69,e.KEY_END=35,e.KEY_ENTER=13,e.KEY_EQUAL=61,e.KEY_ESCAPE=27,e.KEY_F=70,e.KEY_F1=112,e.KEY_F10=121,e.KEY_F11=122,e.KEY_F12=123,e.KEY_F2=113,e.KEY_F3=114,e.KEY_F4=115,e.KEY_F5=116,e.KEY_F6=117,e.KEY_F7=118,e.KEY_F8=119,e.KEY_F9=120,e.KEY_G=71,e.KEY_H=72,e.KEY_HOME=36,e.KEY_I=73,e.KEY_INSERT=45,e.KEY_J=74,e.KEY_K=75,e.KEY_L=76,e.KEY_LEFT=37,e.KEY_M=77,e.KEY_META=224,e.KEY_MULTIPLY=106,e.KEY_N=78,e.KEY_NUMPAD_0=96,e.KEY_NUMPAD_1=97,e.KEY_NUMPAD_2=98,e.KEY_NUMPAD_3=99,e.KEY_NUMPAD_4=100,e.KEY_NUMPAD_5=101,e.KEY_NUMPAD_6=102,e.KEY_NUMPAD_7=103,e.KEY_NUMPAD_8=104,e.KEY_NUMPAD_9=105,e.KEY_O=79,e.KEY_OPEN_BRACKET=219,e.KEY_P=80,e.KEY_PAGE_DOWN=34,e.KEY_PAGE_UP=33,e.KEY_PAUSE=19,e.KEY_PERIOD=190,e.KEY_PRINT_SCREEN=44,e.KEY_Q=81,e.KEY_R=82,e.KEY_RETURN=13,e.KEY_RIGHT=39,e.KEY_S=83,e.KEY_SEMICOLON=59,e.KEY_SEPARATOR=108,e.KEY_SHIFT=16,e.KEY_SLASH=191,e.KEY_SPACE=32,e.KEY_SUBTRACT=109,e.KEY_T=84,e.KEY_TAB=9,e.KEY_U=85,e.KEY_UP=38,e.KEY_V=86,e.KEY_W=87,e.KEY_WINDOWS=91,e.KEY_X=88,e.KEY_Y=89,e.KEY_Z=90,e.Kernel=eH,e.Key=fY,e.Keyboard=av,e.KeyboardEvent=ah,e.KeyboardMouseSource=Lf,e.LAYERID_DEPTH=1,e.LAYERID_IMMEDIATE=3,e.LAYERID_SKYBOX=2,e.LAYERID_UI=4,e.LAYERID_WORLD=0,e.LAYER_GIZMO=1,e.LAYER_HUD=0,e.LAYER_WORLD=15,e.LIGHTFALLOFF_INVERSESQUARED=1,e.LIGHTFALLOFF_LINEAR=0,e.LIGHTSHAPE_DISK=2,e.LIGHTSHAPE_PUNCTUAL=0,e.LIGHTSHAPE_RECT=1,e.LIGHTSHAPE_SPHERE=3,e.LIGHTTYPE_COUNT=3,e.LIGHTTYPE_DIRECTIONAL=0,e.LIGHTTYPE_OMNI=1,e.LIGHTTYPE_POINT=1,e.LIGHTTYPE_SPOT=2,e.LIGHT_COLOR_DIVIDER=100,e.Layer=cX,e.LayerComposition=cZ,e.LayoutCalculator=g$,e.LayoutChildComponent=gV,e.LayoutChildComponentSystem=gj,e.LayoutGroupComponent=g3,e.LayoutGroupComponentSystem=g6,e.Light=c6,e.LightComponent=xt,e.LightComponentSystem=xs,e.LightingParams=c9,e.Lightmapper=mW,e.LitMaterial=di,e.LitOptions=f2,e.LitShaderOptions=f2,e.LocalizedAsset=v1,e.MASK_AFFECT_DYNAMIC=1,e.MASK_AFFECT_LIGHTMAPPED=2,e.MASK_BAKE=4,e.MOTION_FREE=gP,e.MOTION_LIMITED=gI,e.MOTION_LOCKED=gL,e.MOUSEBUTTON_LEFT=0,e.MOUSEBUTTON_MIDDLE=1,e.MOUSEBUTTON_NONE=-1,e.MOUSEBUTTON_RIGHT=2,e.Mat3=ej,e.Mat4=e$,e.Material=uV,e.MaterialHandler=EJ,e.Mesh=l_,e.MeshInstance=lL,e.MiniStats=Pc,e.Model=he,e.ModelComponent=yi,e.ModelComponentSystem=yo,e.ModelHandler=E4,e.Morph=hn,e.MorphInstance=c7,e.MorphTarget=hi,e.Mouse=ax,e.MouseEvent=ay,e.MultiTouchSource=La,e.Node=fq,e.NullGraphicsDevice=sq,e.ORIENTATION_HORIZONTAL=0,e.ORIENTATION_VERTICAL=1,e.OrbitController=LD,e.OrientedBox=to,e.OutlineRenderer=Pp,e.PAD_1=0,e.PAD_2=1,e.PAD_3=2,e.PAD_4=3,e.PAD_DOWN=13,e.PAD_FACE_1=0,e.PAD_FACE_2=1,e.PAD_FACE_3=2,e.PAD_FACE_4=3,e.PAD_LEFT=14,e.PAD_L_SHOULDER_1=4,e.PAD_L_SHOULDER_2=6,e.PAD_L_STICK_BUTTON=10,e.PAD_L_STICK_X=0,e.PAD_L_STICK_Y=1,e.PAD_RIGHT=15,e.PAD_R_SHOULDER_1=5,e.PAD_R_SHOULDER_2=7,e.PAD_R_STICK_BUTTON=11,e.PAD_R_STICK_X=2,e.PAD_R_STICK_Y=3,e.PAD_SELECT=8,e.PAD_START=9,e.PAD_UP=12,e.PAD_VENDOR=16,e.PARTICLEMODE_CPU=1,e.PARTICLEMODE_GPU=0,e.PARTICLEORIENTATION_EMITTER=2,e.PARTICLEORIENTATION_SCREEN=0,e.PARTICLEORIENTATION_WORLD=1,e.PARTICLESORT_DISTANCE=1,e.PARTICLESORT_NEWER_FIRST=2,e.PARTICLESORT_NONE=0,e.PARTICLESORT_OLDER_FIRST=3,e.PIXELFORMAT_111110F=18,e.PIXELFORMAT_A8=0,e.PIXELFORMAT_ASTC_4x4=28,e.PIXELFORMAT_ASTC_4x4_SRGB=63,e.PIXELFORMAT_ATC_RGB=29,e.PIXELFORMAT_ATC_RGBA=30,e.PIXELFORMAT_BC6F=65,e.PIXELFORMAT_BC6UF=66,e.PIXELFORMAT_BC7=67,e.PIXELFORMAT_BC7_SRGBA=68,e.PIXELFORMAT_BGRA8=31,e.PIXELFORMAT_DEPTH=16,e.PIXELFORMAT_DEPTH16=69,e.PIXELFORMAT_DEPTHSTENCIL=17,e.PIXELFORMAT_DXT1=8,e.PIXELFORMAT_DXT1_SRGB=54,e.PIXELFORMAT_DXT3=9,e.PIXELFORMAT_DXT3_SRGBA=55,e.PIXELFORMAT_DXT5=10,e.PIXELFORMAT_DXT5_SRGBA=56,e.PIXELFORMAT_ETC1=21,e.PIXELFORMAT_ETC2_RGB=22,e.PIXELFORMAT_ETC2_RGBA=23,e.PIXELFORMAT_ETC2_SRGB=61,e.PIXELFORMAT_ETC2_SRGBA=62,e.PIXELFORMAT_L8=1,e.PIXELFORMAT_L8_A8=2,e.PIXELFORMAT_LA8=2,e.PIXELFORMAT_PVRTC_2BPP_RGBA_1=25,e.PIXELFORMAT_PVRTC_2BPP_RGB_1=24,e.PIXELFORMAT_PVRTC_4BPP_RGBA_1=27,e.PIXELFORMAT_PVRTC_4BPP_RGB_1=26,e.PIXELFORMAT_R16F=50,e.PIXELFORMAT_R16I=34,e.PIXELFORMAT_R16U=35,e.PIXELFORMAT_R32F=15,e.PIXELFORMAT_R32I=36,e.PIXELFORMAT_R32U=37,e.PIXELFORMAT_R4_G4_B4_A4=5,e.PIXELFORMAT_R5_G5_B5_A1=4,e.PIXELFORMAT_R5_G6_B5=3,e.PIXELFORMAT_R8=52,e.PIXELFORMAT_R8I=32,e.PIXELFORMAT_R8U=33,e.PIXELFORMAT_R8_G8_B8=6,e.PIXELFORMAT_R8_G8_B8_A8=7,e.PIXELFORMAT_RG16F=51,e.PIXELFORMAT_RG16I=40,e.PIXELFORMAT_RG16U=41,e.PIXELFORMAT_RG32I=42,e.PIXELFORMAT_RG32U=43,e.PIXELFORMAT_RG8=53,e.PIXELFORMAT_RG8I=38,e.PIXELFORMAT_RG8U=39,e.PIXELFORMAT_RGB16F=11,e.PIXELFORMAT_RGB32F=13,e.PIXELFORMAT_RGB565=3,e.PIXELFORMAT_RGB8=6,e.PIXELFORMAT_RGBA16F=12,e.PIXELFORMAT_RGBA16I=46,e.PIXELFORMAT_RGBA16U=47,e.PIXELFORMAT_RGBA32F=14,e.PIXELFORMAT_RGBA32I=48,e.PIXELFORMAT_RGBA32U=49,e.PIXELFORMAT_RGBA4=5,e.PIXELFORMAT_RGBA5551=4,e.PIXELFORMAT_RGBA8=7,e.PIXELFORMAT_RGBA8I=44,e.PIXELFORMAT_RGBA8U=45,e.PIXELFORMAT_SBGRA8=64,e.PIXELFORMAT_SRGB=19,e.PIXELFORMAT_SRGB8=19,e.PIXELFORMAT_SRGBA=20,e.PIXELFORMAT_SRGBA8=20,e.PRIMITIVE_LINELOOP=2,e.PRIMITIVE_LINES=1,e.PRIMITIVE_LINESTRIP=3,e.PRIMITIVE_POINTS=0,e.PRIMITIVE_TRIANGLES=4,e.PRIMITIVE_TRIFAN=6,e.PRIMITIVE_TRISTRIP=5,e.PROJECTION_ORTHOGRAPHIC=1,e.PROJECTION_PERSPECTIVE=0,e.ParticleEmitter=hJ,e.ParticleSystemComponent=yp,e.ParticleSystemComponentSystem=yx,e.Picker=Cx,e.Plane=te,e.PlaneGeometry=dj,e.Pose=IQ,e.PostEffect=f$,e.PostEffectQueue=S0,e.ProgramLibrary=dq,e.QuadRender=lt,e.Quat=e0,e.REFLECTIONSRC_CUBEMAP=o_,e.REFLECTIONSRC_ENVATLAS=op,e.REFLECTIONSRC_ENVATLASHQ=om,e.REFLECTIONSRC_NONE=od,e.REFLECTIONSRC_SPHEREMAP=ov,e.RENDERSTYLE_POINTS=2,e.RENDERSTYLE_SOLID=0,e.RENDERSTYLE_WIREFRAME=1,e.RESOLUTION_AUTO=pI,e.RESOLUTION_FIXED=pL,e.RIGIDBODY_ACTIVE_TAG=1,e.RIGIDBODY_CF_KINEMATIC_OBJECT=2,e.RIGIDBODY_CF_NORESPONSE_OBJECT=4,e.RIGIDBODY_CF_STATIC_OBJECT=1,e.RIGIDBODY_DISABLE_DEACTIVATION=4,e.RIGIDBODY_DISABLE_SIMULATION=5,e.RIGIDBODY_ISLAND_SLEEPING=2,e.RIGIDBODY_TYPE_DYNAMIC=vP,e.RIGIDBODY_TYPE_KINEMATIC=vI,e.RIGIDBODY_TYPE_STATIC=vC,e.RIGIDBODY_WANTS_DEACTIVATION=3,e.Ray=tn,e.RaycastResult=yW,e.ReadStream=eA,e.RenderComponent=yP,e.RenderComponentSystem=yR,e.RenderHandler=bT,e.RenderPass=s2,e.RenderPassBloom=IE,e.RenderPassCameraFrame=IY,e.RenderPassColorGrab=lz,e.RenderPassCompose=IP,e.RenderPassDepthAwareBlur=IV,e.RenderPassDof=IN,e.RenderPassDownsample=IS,e.RenderPassForward=cR,e.RenderPassPrepass=IU,e.RenderPassShaderQuad=f1,e.RenderPassSsao=IH,e.RenderPassTAA=IL,e.RenderPassUpsample=Ib,e.RenderTarget=il,e.ResourceHandler=mn,e.ResourceLoader=ms,e.RigidBodyComponent=yz,e.RigidBodyComponentSystem=yK,e.RotateGizmo=DV,e.SAMPLETYPE_DEPTH=2,e.SAMPLETYPE_FLOAT=0,e.SAMPLETYPE_INT=3,e.SAMPLETYPE_UINT=4,e.SAMPLETYPE_UNFILTERABLE_FLOAT=1,e.SCALEMODE_BLEND=yQ,e.SCALEMODE_NONE=yZ,e.SCROLLBAR_VISIBILITY_SHOW_ALWAYS=0,e.SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED=1,e.SCROLL_MODE_BOUNCE=1,e.SCROLL_MODE_CLAMP=0,e.SCROLL_MODE_INFINITE=2,e.SEMANTIC_ATTR0=tB,e.SEMANTIC_ATTR1=tU,e.SEMANTIC_ATTR10=tq,e.SEMANTIC_ATTR11=tK,e.SEMANTIC_ATTR12=tZ,e.SEMANTIC_ATTR13=tQ,e.SEMANTIC_ATTR14=tJ,e.SEMANTIC_ATTR15=t$,e.SEMANTIC_ATTR2=tz,e.SEMANTIC_ATTR3=tV,e.SEMANTIC_ATTR4=tG,e.SEMANTIC_ATTR5=tH,e.SEMANTIC_ATTR6=tW,e.SEMANTIC_ATTR7=tj,e.SEMANTIC_ATTR8=tX,e.SEMANTIC_ATTR9=tY,e.SEMANTIC_BLENDINDICES=tC,e.SEMANTIC_BLENDWEIGHT=tA,e.SEMANTIC_COLOR=tP,e.SEMANTIC_NORMAL=tE,e.SEMANTIC_POSITION=tT,e.SEMANTIC_TANGENT=tw,e.SEMANTIC_TEXCOORD=tI,e.SEMANTIC_TEXCOORD0=tL,e.SEMANTIC_TEXCOORD1=tD,e.SEMANTIC_TEXCOORD2=tM,e.SEMANTIC_TEXCOORD3=tR,e.SEMANTIC_TEXCOORD4=tO,e.SEMANTIC_TEXCOORD5=tk,e.SEMANTIC_TEXCOORD6=tN,e.SEMANTIC_TEXCOORD7=tF,e.SHADERDEF_BATCH=16384,e.SHADERDEF_DIRLM=128,e.SHADERDEF_INSTANCING=32,e.SHADERDEF_LM=64,e.SHADERDEF_LMAMBIENT=4096,e.SHADERDEF_MORPH_NORMAL=2048,e.SHADERDEF_MORPH_POSITION=1024,e.SHADERDEF_MORPH_TEXTURE_BASED_INT=8192,e.SHADERDEF_NOSHADOW=1,e.SHADERDEF_SCREENSPACE=256,e.SHADERDEF_SKIN=2,e.SHADERDEF_TANGENTS=512,e.SHADERDEF_UV0=4,e.SHADERDEF_UV1=8,e.SHADERDEF_VCOLOR=16,e.SHADERLANGUAGE_GLSL=nn,e.SHADERLANGUAGE_WGSL=ni,e.SHADERPASS_ALBEDO="debug_albedo",e.SHADERPASS_AO="debug_ao",e.SHADERPASS_EMISSION="debug_emission",e.SHADERPASS_FORWARD="forward",e.SHADERPASS_GLOSS="debug_gloss",e.SHADERPASS_LIGHTING="debug_lighting",e.SHADERPASS_METALNESS="debug_metalness",e.SHADERPASS_OPACITY="debug_opacity",e.SHADERPASS_SPECULARITY="debug_specularity",e.SHADERPASS_UV0="debug_uv0",e.SHADERPASS_WORLDNORMAL="debug_world_normal",e.SHADERSTAGE_COMPUTE=4,e.SHADERSTAGE_FRAGMENT=2,e.SHADERSTAGE_VERTEX=1,e.SHADERTAG_MATERIAL=1,e.SHADER_FORWARD=0,e.SHADER_PICK=3,e.SHADER_PREPASS=1,e.SHADER_SHADOW=2,e.SHADOWUPDATE_NONE=0,e.SHADOWUPDATE_REALTIME=2,e.SHADOWUPDATE_THISFRAME=1,e.SHADOW_CASCADE_0=1,e.SHADOW_CASCADE_1=2,e.SHADOW_CASCADE_2=4,e.SHADOW_CASCADE_3=8,e.SHADOW_CASCADE_ALL=255,e.SHADOW_PCF1=5,e.SHADOW_PCF1_16F=7,e.SHADOW_PCF1_32F=5,e.SHADOW_PCF3=0,e.SHADOW_PCF3_16F=8,e.SHADOW_PCF3_32F=0,e.SHADOW_PCF5=4,e.SHADOW_PCF5_16F=9,e.SHADOW_PCF5_32F=4,e.SHADOW_PCSS_32F=6,e.SHADOW_VSM16=2,e.SHADOW_VSM32=3,e.SHADOW_VSM_16F=2,e.SHADOW_VSM_32F=3,e.SKYTYPE_BOX="box",e.SKYTYPE_DOME=ow,e.SKYTYPE_INFINITE=oE,e.SORTMODE_BACK2FRONT=3,e.SORTMODE_CUSTOM=5,e.SORTMODE_FRONT2BACK=4,e.SORTMODE_MANUAL=1,e.SORTMODE_MATERIALMESH=2,e.SORTMODE_NONE=0,e.SPECOCC_AO=1,e.SPECOCC_GLOSSDEPENDENT=2,e.SPECOCC_NONE=0,e.SPRITETYPE_ANIMATED=SD,e.SPRITETYPE_SIMPLE=SL,e.SPRITE_RENDERMODE_SIMPLE=0,e.SPRITE_RENDERMODE_SLICED=1,e.SPRITE_RENDERMODE_TILED=2,e.SSAOTYPE_COMBINE=Ig,e.SSAOTYPE_LIGHTING=Iv,e.SSAOTYPE_NONE=I_,e.STENCILOP_DECREMENT=5,e.STENCILOP_DECREMENTWRAP=6,e.STENCILOP_INCREMENT=3,e.STENCILOP_INCREMENTWRAP=4,e.STENCILOP_INVERT=7,e.STENCILOP_KEEP=0,e.STENCILOP_REPLACE=2,e.STENCILOP_ZERO=1,e.ScaleGizmo=D1,e.Scene=fB,e.SceneHandler=E8,e.SceneRegistry=mx,e.SceneRegistryItem=mS,e.SceneSettingsHandler=CT,e.ScopeId=nJ,e.ScopeSpace=n$,e.ScreenComponent=y0,e.ScreenComponentSystem=y5,e.Script=xv,e.ScriptAttributes=xf,e.ScriptComponent=xA,e.ScriptComponentSystem=xL,e.ScriptHandler=wi,e.ScriptRegistry=mh,e.ScriptType=xx,e.ScrollViewComponent=Su,e.ScrollViewComponentSystem=Sd,e.ScrollbarComponent=Sm,e.ScrollbarComponentSystem=Sy,e.Shader=r$,e.ShaderChunks=o0,e.ShaderHandler=ws,e.ShaderMaterial=h3,e.ShaderPass=oW,e.ShaderUtils=o8,e.SingleContactResult=yj,e.SingleGestureSource=I7,e.Skeleton=fQ,e.Skin=fU,e.SkinBatchInstance=lh,e.SkinInstance=lu,e.Sky=fl,e.SortedLoopArray=eC,e.Sound=a3,e.SoundComponent=Sw,e.SoundComponentSystem=SI,e.SoundInstance=a8,e.SoundInstance3d=a9,e.SoundManager=a2,e.SoundSlot=ST,e.SphereGeometry=fi,e.Sprite=fW,e.SpriteAnimationClip=SO,e.SpriteComponent=Sz,e.SpriteComponentSystem=SW,e.SpriteHandler=wu,e.StandardMaterial=dw,e.StandardMaterialOptions=dr,e.StencilParameters=n7,e.StorageBuffer=su,e.TEXHINT_ASSET=2,e.TEXHINT_LIGHTMAP=3,e.TEXHINT_NONE=0,e.TEXHINT_SHADOWMAP=1,e.TEXPROPERTY_ADDRESS_U=4,e.TEXPROPERTY_ADDRESS_V=8,e.TEXPROPERTY_ADDRESS_W=16,e.TEXPROPERTY_ALL=255,e.TEXPROPERTY_ANISOTROPY=128,e.TEXPROPERTY_COMPARE_FUNC=64,e.TEXPROPERTY_COMPARE_ON_READ=32,e.TEXPROPERTY_MAG_FILTER=2,e.TEXPROPERTY_MIN_FILTER=1,e.TEXTUREDIMENSION_1D="1d",e.TEXTUREDIMENSION_2D="2d",e.TEXTUREDIMENSION_2D_ARRAY=t5,e.TEXTUREDIMENSION_3D="3d",e.TEXTUREDIMENSION_CUBE=t8,e.TEXTUREDIMENSION_CUBE_ARRAY=t6,e.TEXTURELOCK_NONE=0,e.TEXTURELOCK_READ=1,e.TEXTURELOCK_WRITE=2,e.TEXTUREPROJECTION_CUBE=t7,e.TEXTUREPROJECTION_EQUIRECT=ne,e.TEXTUREPROJECTION_NONE=t9,e.TEXTUREPROJECTION_OCTAHEDRAL=nt,e.TEXTURETYPE_DEFAULT=t0,e.TEXTURETYPE_RGBE=t2,e.TEXTURETYPE_RGBM=t1,e.TEXTURETYPE_RGBP=t3,e.TEXTURETYPE_SWIZZLEGGGR=t4,e.TONEMAP_ACES=3,e.TONEMAP_ACES2=4,e.TONEMAP_FILMIC=1,e.TONEMAP_HEJL=2,e.TONEMAP_LINEAR=0,e.TONEMAP_NEUTRAL=5,e.TONEMAP_NONE=6,e.TRACEID_BINDGROUPFORMAT_ALLOC="BindGroupFormatAlloc",e.TRACEID_BINDGROUP_ALLOC="BindGroupAlloc",e.TRACEID_COMPUTEPIPELINE_ALLOC="ComputePipelineAlloc",e.TRACEID_ELEMENT="Element",e.TRACEID_GPU_TIMINGS=Q,e.TRACEID_PIPELINELAYOUT_ALLOC="PipelineLayoutAlloc",e.TRACEID_RENDERPIPELINE_ALLOC="RenderPipelineAlloc",e.TRACEID_RENDER_ACTION="RenderAction",e.TRACEID_RENDER_FRAME="RenderFrame",e.TRACEID_RENDER_FRAME_TIME="RenderFrameTime",e.TRACEID_RENDER_PASS="RenderPass",e.TRACEID_RENDER_PASS_DETAIL="RenderPassDetail",e.TRACEID_RENDER_QUEUE="RenderQueue",e.TRACEID_RENDER_TARGET_ALLOC="RenderTargetAlloc",e.TRACEID_SHADER_ALLOC="ShaderAlloc",e.TRACEID_SHADER_COMPILE="ShaderCompile",e.TRACEID_TEXTURES="Textures",e.TRACEID_TEXTURE_ALLOC="TextureAlloc",e.TRACEID_VRAM_IB="VRAM.Ib",e.TRACEID_VRAM_SB="VRAM.Sb",e.TRACEID_VRAM_TEXTURE="VRAM.Texture",e.TRACEID_VRAM_VB="VRAM.Vb",e.TYPE_FLOAT16=7,e.TYPE_FLOAT32=6,e.TYPE_INT16=2,e.TYPE_INT32=4,e.TYPE_INT8=0,e.TYPE_UINT16=3,e.TYPE_UINT32=5,e.TYPE_UINT8=1,e.Tags=eI,e.Template=wc,e.TemplateHandler=wf,e.TextElement=gh,e.TextHandler=wp,e.Texture=nO,e.TextureAtlas=fX,e.TextureAtlasHandler=wy,e.TextureHandler=w6,e.TextureUtils=nM,e.TorusGeometry=dY,e.Touch=aG,e.TouchDevice=aj,e.TouchEvent=aH,e.Tracing=eO,e.TransformFeedback=s3,e.TransformGizmo=Dt,e.TranslateGizmo=DC,e.Tri=td,e.UNIFORMTYPE_BOOL=0,e.UNIFORMTYPE_BOOLARRAY=32,e.UNIFORMTYPE_BVEC2=9,e.UNIFORMTYPE_BVEC2ARRAY=35,e.UNIFORMTYPE_BVEC3=10,e.UNIFORMTYPE_BVEC3ARRAY=38,e.UNIFORMTYPE_BVEC4=11,e.UNIFORMTYPE_BVEC4ARRAY=41,e.UNIFORMTYPE_FLOAT=2,e.UNIFORMTYPE_FLOATARRAY=17,e.UNIFORMTYPE_INT=1,e.UNIFORMTYPE_INTARRAY=30,e.UNIFORMTYPE_ITEXTURE2D=42,e.UNIFORMTYPE_ITEXTURE2D_ARRAY=48,e.UNIFORMTYPE_ITEXTURE3D=46,e.UNIFORMTYPE_ITEXTURECUBE=44,e.UNIFORMTYPE_IVEC2=6,e.UNIFORMTYPE_IVEC2ARRAY=33,e.UNIFORMTYPE_IVEC3=7,e.UNIFORMTYPE_IVEC3ARRAY=36,e.UNIFORMTYPE_IVEC4=8,e.UNIFORMTYPE_IVEC4ARRAY=39,e.UNIFORMTYPE_MAT2=12,e.UNIFORMTYPE_MAT3=13,e.UNIFORMTYPE_MAT4=14,e.UNIFORMTYPE_MAT4ARRAY=24,e.UNIFORMTYPE_TEXTURE2D=15,e.UNIFORMTYPE_TEXTURE2D_ARRAY=25,e.UNIFORMTYPE_TEXTURE2D_SHADOW=18,e.UNIFORMTYPE_TEXTURE3D=20,e.UNIFORMTYPE_TEXTURECUBE=16,e.UNIFORMTYPE_TEXTURECUBE_SHADOW=19,e.UNIFORMTYPE_UINT=26,e.UNIFORMTYPE_UINTARRAY=31,e.UNIFORMTYPE_UTEXTURE2D=43,e.UNIFORMTYPE_UTEXTURE2D_ARRAY=49,e.UNIFORMTYPE_UTEXTURE3D=47,e.UNIFORMTYPE_UTEXTURECUBE=45,e.UNIFORMTYPE_UVEC2=27,e.UNIFORMTYPE_UVEC2ARRAY=34,e.UNIFORMTYPE_UVEC3=28,e.UNIFORMTYPE_UVEC3ARRAY=37,e.UNIFORMTYPE_UVEC4=29,e.UNIFORMTYPE_UVEC4ARRAY=40,e.UNIFORMTYPE_VEC2=3,e.UNIFORMTYPE_VEC2ARRAY=21,e.UNIFORMTYPE_VEC3=4,e.UNIFORMTYPE_VEC3ARRAY=22,e.UNIFORMTYPE_VEC4=5,e.UNIFORMTYPE_VEC4ARRAY=23,e.UNIFORM_BUFFER_DEFAULT_SLOT_NAME=nd,e.UNUSED_UNIFORM_NAME=np,e.URI=eR,e.UniformBufferFormat=iZ,e.UniformFormat=iK,e.UsdzExporter=In,e.VIEW_CENTER=0,e.VIEW_LEFT=1,e.VIEW_RIGHT=2,e.Vec2=eX,e.Vec3=eW,e.Vec4=eY,e.VertexBuffer=n1,e.VertexFormat=n6,e.VertexIterator=ao,e.ViewCube=D6,e.WasmModule=ew,e.WebglGraphicsDevice=sV,e.WebgpuGraphicsDevice=sm,e.WorldClusters=uT,e.XRDEPTHSENSINGFORMAT_F32=Ao,e.XRDEPTHSENSINGFORMAT_L8A8=As,e.XRDEPTHSENSINGFORMAT_R16U=Aa,e.XRDEPTHSENSINGUSAGE_CPU=Ai,e.XRDEPTHSENSINGUSAGE_GPU=Ar,e.XREYE_LEFT="left",e.XREYE_NONE="none",e.XREYE_RIGHT="right",e.XRHAND_LEFT=An,e.XRHAND_NONE="none",e.XRHAND_RIGHT="right",e.XRPAD_A=4,e.XRPAD_B=5,e.XRPAD_SQUEEZE=1,e.XRPAD_STICK_BUTTON=3,e.XRPAD_STICK_X=2,e.XRPAD_STICK_Y=3,e.XRPAD_TOUCHPAD_BUTTON=2,e.XRPAD_TOUCHPAD_X=0,e.XRPAD_TOUCHPAD_Y=1,e.XRPAD_TRIGGER=0,e.XRSPACE_BOUNDEDFLOOR="bounded-floor",e.XRSPACE_LOCAL="local",e.XRSPACE_LOCALFLOOR="local-floor",e.XRSPACE_UNBOUNDED="unbounded",e.XRSPACE_VIEWER=At,e.XRTARGETRAY_GAZE="gaze",e.XRTARGETRAY_POINTER="tracked-pointer",e.XRTARGETRAY_SCREEN="screen",e.XRTRACKABLE_MESH="mesh",e.XRTRACKABLE_PLANE="plane",e.XRTRACKABLE_POINT="point",e.XRTYPE_AR=Ae,e.XRTYPE_INLINE=w9,e.XRTYPE_VR=w7,e.XrAnchor=A$,e.XrAnchors=A3,e.XrDomOverlay=Al,e.XrFinger=Ay,e.XrHand=AI,e.XrHitTest=Ap,e.XrHitTestSource=Af,e.XrImageTracking=Ag,e.XrInput=AN,e.XrInputSource=AO,e.XrJoint=AT,e.XrLightEstimation=AG,e.XrManager=Co,e.XrMeshDetection=A7,e.XrPlane=Aj,e.XrPlaneDetection=AK,e.XrTrackedImage=A_,e.XrView=Ct,e.XrViews=Cs,e.ZoneComponent=SY,e.ZoneComponentSystem=SJ,e.ambientSrcNames=ob,e.basisInitialize=wL,e.bindGroupNames=nf,e.blendNames=ot,e.calculateNormals=h6,e.calculateTangents=h9,e.createBox=function(e,t){return l_.fromGeometry(e,new ft(t))},e.createCapsule=function(e,t){return l_.fromGeometry(e,new dU(t))},e.createCone=function(e,t){return l_.fromGeometry(e,new dV(t))},e.createCylinder=function(e,t){return l_.fromGeometry(e,new dH(t))},e.createGraphicsDevice=function(e,t){ void 0===t&&(t={});var n=null!=(s=t.deviceTypes)?s:[];n.includes(nl)||n.push(nl),n.includes(nc)||n.push(nc),ef.browser&&navigator.xr&&(null!=(a=t).xrCompatible||(a.xrCompatible=true));for(var i=[],r=0;r<n.length;r++){var s,a,o,l,u=n[r];u===nu&&(null==(l=window)||null==(o=l.navigator)?void 0:o.gpu)&&i.push(function(){return new sm(e,t).initWebGpu(t.glslangUrl,t.twgslUrl)}),u===nl&&i.push(function(){return new sV(e,t)}),u===nc&&i.push(function(){return new sq(e,t)});}return new Promise(function(e,t){var n=0,r=function(){n>=i.length?t(Error("Failed to create a graphics device")):Promise.resolve(i[n++]()).then(function(t){t?e(t):r();}).catch(function(e){r();});};r();})},e.createMesh=function(e,t,n){ void 0===n&&(n={});var i=new h7;return i.positions=t,i.normals=n.normals,i.tangents=n.tangents,i.colors=n.colors,i.uvs=n.uvs,i.uvs1=n.uvs1,i.blendIndices=n.blendIndices,i.blendWeights=n.blendWeights,i.indices=n.indices,l_.fromGeometry(e,i,n)},e.createPlane=function(e,t){return l_.fromGeometry(e,new dj(t))},e.createScript=E7,e.createShader=function(e,t,n,i,r){},e.createShaderFromCode=function(e,t,n,i,r,s,a){if(void 0===s&&(s=false),void 0===a&&(a={}),"boolean"==typeof s)a.useTransformFeedback=s;else {var o;(void 0===s?"undefined":(o=s)&&"undefined"!=typeof Symbol&&o.constructor===Symbol?"symbol":typeof o)=="object"&&(a=o3({},a,s));}var l=oz(e),u=l.getCachedShader(i);return u||(u=new r$(e,rQ.createDefinition(e,o3({},a,{name:i,vertexCode:t,fragmentCode:n,attributes:r}))),l.setCachedShader(i,u)),u},e.createSphere=function(e,t){return l_.fromGeometry(e,new fi(t))},e.createTorus=function(e,t){return l_.fromGeometry(e,new dY(t))},e.createURI=function(e){var t="";if((e.authority||e.scheme)&&(e.host||e.hostpath))throw Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(e.host&&e.hostpath)throw Error("Can't have 'host' and 'hostpath' option");if(e.path&&e.hostpath)throw Error("Can't have 'path' and 'hostpath' option");return e.scheme&&(t+=""+e.scheme+":"),e.authority&&(t+="//"+e.authority),e.host&&(t+=e.host),e.path&&(t+=e.path),e.hostpath&&(t+=e.hostpath),e.query&&(t+="?"+e.query),e.fragment&&(t+="#"+e.fragment),t},e.cubemaProjectionNames=ou,e.ditherNames=oL,e.dracoInitialize=function(e){(null==e?void 0:e.lazyInit)?B=e:bI(e);},e.drawFullscreenQuad=function(e,t,n,i,r){var s;if(r){var a=t?t.width:e.width,o=t?t.height:e.height;s=C4.set(r.x*a,r.y*o,r.z*a,r.w*o);}ls(e,t,i,s);},e.drawQuadWithShader=ls,e.extend=ee,e.fresnelNames=or,e.gammaNames=oc,e.getPixelFormatArrayType=tb,e.getReservedScriptNames=function(){return E9},e.getTouchTargetCoords=aV,e.guid=et,e.http=aq,e.isCompressedPixelFormat=t_,e.isIntegerPixelFormat=tg,e.isSrgbPixelFormat=tv,e.lightFalloffNames=oo,e.lightShapeNames=oa,e.lightTypeNames=os,e.math=ek,e.now=eL,e.path=en,e.pixelFormatGammaToLinear=tS,e.pixelFormatInfo=tm,e.pixelFormatLinearToGamma=ty,e.platform=ef,e.primitiveGlslToWgslTypeMap=ny,e.reflectionSrcNames=og,e.registerScript=wt,e.reprojectTexture=fR,e.requiresManualGamma=tx,e.revision=$,e.script=pM,e.semanticToLocation=nS,e.shaderChunks=C6,e.shadowTypeInfo=ol,e.specularOcclusionNames=of,e.spriteRenderModeNames=oT,e.string=ev,e.tonemapNames=oh,e.typedArrayIndexFormats=nv,e.typedArrayIndexFormatsByteSize=ng,e.typedArrayToType={Int8Array:0,Uint8Array:1,Int16Array:2,Uint16Array:3,Int32Array:4,Uint32Array:5,Float32Array:6},e.typedArrayTypes=nm,e.typedArrayTypesByteSize=n_,e.uniformTypeToName=nr,e.uniformTypeToNameMapWGSL=na,e.uniformTypeToNameWGSL=ns,e.uniformTypeToStorage=no,e.version=J,e.vertexTypesNames=["INT8","UINT8","INT16","UINT16","INT32","UINT32","FLOAT32","FLOAT16"];},("undefined"==typeof exports?"undefined":(n=exports)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)=="object"&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).pc={});
